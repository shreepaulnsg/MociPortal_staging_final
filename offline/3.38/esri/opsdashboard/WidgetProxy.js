// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("dojo/_base/declare dojo/_base/lang dojo/Deferred dojo/when dojo/promise/all ../geometry/jsonUtils ./core/messageHandler ./core/errorMessages ./core/ExtensionBase ./FeatureActionFeatures".split(" "),function(n,d,g,h,l,p,k,e,q,r){return n([q],{hasFeatureActions:!1,hasDefaultFeatureAction:!1,featureActionFeatures:null,dataSourceConfigs:null,dataSourceProxies:null,_initializeResponseReceived:function(a){a&&"object"===typeof a||(new g).reject(Error(e.invalidArguments));return this.inherited(arguments).then(d.hitch(this,
function(){this.hasFeatureActions=a.supportFeatureActions;this.hasDefaultFeatureAction=a.supportDefaultFeatureAction;var b=h(this._setupMapWidgetProxy()),c=h(this._setupDataSourceProxies()),f=h(this._setupFeatureActionFeatures());return l([b,c,f])}))},_setupDataSourceProxies:function(){this.dataSourceConfigs||(this.dataSourceConfigs=[]);if(0!==this.dataSourceConfigs.length){var a=[];this.dataSourceConfigs.forEach(d.hitch(this,function(b){a.push(this.getDataSourceProxy(b.dataSourceId))}));return l(a).then(d.hitch(this,
function(b){this.dataSourceProxies=b}))}},_setupMapWidgetProxy:function(){if(this.mapWidgetId)return this.getMapWidgetProxy(this.mapWidgetId).then(d.hitch(this,function(a){this.mapWidgetProxy=a}))},_setupFeatureActionFeatures:function(){if(this.hasFeatureActions&&0!==this.dataSourceConfigs.length){var a=this.dataSourceConfigs[0].dataSourceId;if(this.featureActionFeatures)this.featureActionFeatures.dataSourceProxy.id!==a&&(this.featureActionFeatures=null);else return this.getDataSourceProxy(a).then(d.hitch(this,
function(b){this.featureActionFeatures=new r(b)}))}else this.featureActionFeatures=null},_messageReceived:function(a){switch(a.functionName.toLowerCase()){case "datasourceexpired":case "datasourceupdated":this._dataSourceExpired(a.args.dataSourceId);break;case "drawcomplete":this._drawComplete(a.args)}},_dataSourceExpired:function(a){this.getDataSourceProxy(a).then(d.hitch(this,function(b){var c=this.getDataSourceConfig(b);this.dataSourceExpired(b,c);this.emit("data-source-expired",{dataSourceProxy:b,
dataSourceConfig:c})}))},dataSourceExpired:function(a,b){},getDataSourceConfig:function(a){if(!this._isHostInitialized())throw Error(e.hostNotReady);var b=a;"object"===typeof a&&(b=a.id);for(a=0;a<this.dataSourceConfigs.length;a++)if(this.dataSourceConfigs[a].dataSourceId===b)return this.dataSourceConfigs[a];return null},_dataSourceRemoved:function(a){this.inherited(arguments);if(this.dataSourceConfigs){for(var b=!1,c=0;c<this.dataSourceConfigs.length&&!b;c++)this.dataSourceConfigs[c].dataSourceId===
a&&(this.dataSourceConfigs.splice(c,1),b=!0);b&&this._setupFeatureActionFeatures()}},_mapWidgetRemoved:function(a){this.inherited(arguments);this.mapWidgetProxy&&this.mapWidgetProxy.id===a&&(this.mapWidgetId=this.mapWidgetProxy=null)},activateDrawingToolbar:function(a,b){if(!this._isHostInitialized())return(new g).reject(Error(e.hostNotReady));b||(b=this.mapWidgetProxy);if(!b)return(new g).reject(Error(e.invalidArguments));var c=b;"object"===typeof b&&(c=b.id);return k._sendMessageWithReply({functionName:"activateDrawingToolbar",
args:d.mixin({mapWidgetId:c},a)}).then(function(){return!0},function(){return!1})},deactivateDrawingToolbar:function(a){if(!this._isHostInitialized())throw Error(e.hostNotReady);a||(a=this.mapWidgetProxy);if(!a)throw Error(e.invalidArguments);var b=a;"object"===typeof a&&(b=a.id);k._sendMessage({functionName:"deactivateDrawingToolbar",args:{mapWidgetId:b}})},_drawComplete:function(a){a.cancelled?(this.drawingToolbarDeactivated(),this.emit("drawing-toolbar-deactivated")):(a=p.fromJson(a.geometry),
this.toolbarDrawComplete(a),this.emit("toolbar-draw-complete",{geometry:a}))},toolbarDrawComplete:function(a){},drawingToolbarDeactivated:function(){},executeDefaultFeatureAction:function(a){if(!this._isHostInitialized())throw Error(e.hostNotReady);if(this.hasDefaultFeatureAction&&Array.isArray(a)&&0!==a.length&&Array.isArray(this.dataSourceProxies)&&0!==this.dataSourceProxies.length){var b=this.dataSourceProxies[0],c=[];a.forEach(function(f){var m=f;if("object"===typeof f){if(!f.attributes||!f.attributes[b.objectIdFieldName])return;
m=f.attributes[b.objectIdFieldName]}c.push(m)});0!==c.length&&k._sendMessage({functionName:"executeDefaultFeatureAction",args:{dataSourceId:b.id,objectIds:c}})}}})});