// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/plugins/FeatureLayerStatistics","dojo/_base/lang dojo/_base/array dojo/_base/declare dojo/has dojo/Deferred dojo/on dojo/promise/all dojo/when dojo/string ../kernel ../config ../urlUtils ../Evented ../SpatialReference ../support/expressionUtils ../tasks/query ../tasks/StatisticDefinition ../tasks/GenerateRendererTask ../tasks/UniqueValueDefinition ../tasks/ClassBreaksDefinition ../tasks/GenerateRendererParameters ../tasks/generateRenderer ../tasks/GeometryService ../tasks/ProjectParameters ../layers/TileInfo ../layers/support/attributeUtils ../layers/HeatmapManager ../workers/heatmapCalculator ../geometry/mathUtils ../geometry/webMercatorUtils ../geometry/scaleUtils ../geometry/Point ../geometry/Extent".split(" "),
function(x,r,S,T,v,L,U,z,V,W,E,X,Y,B,C,y,F,Z,aa,ba,G,ca,da,ea,fa,H,ha,M,I,N,ia,ja,ka){E=E.defaults;var la=M.prototype._calculateIntensityMatrix,ma=M.calculateStats,na=ha.prototype._getScreenPoints,oa=/_value$/i,O="min max avg stddev count sum variance".split(" "),D=S([Y],{declaredClass:"esri.plugins.FeatureLayerStatistics",sampleSize:500,worldScale:1E8,generalizeForScale:4E5,generalizeForResolution:105,mapWidth:1280,mapHeight:800,mapPaddingRatioForFE:.25,minDistance:12,minLength:30,minSize:15,minScaleRelaxationRatio:.25,
samplingThreshold:2E4,numBins:10,numClasses:5,classificationMethod:"equal-interval",standardDeviationInterval:1,geometryServiceUrl:X.getProtocolForWebResource()+"//utility.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer",tileInfo:new fa({rows:256,cols:256,dpi:96,format:"JPEG",compressionQuality:90,origin:{x:-2.0037508342787E7,y:2.0037508342787E7},spatialReference:{wkid:102100,latestWkid:3857},lods:[{level:0,resolution:156543.03392800014,scale:5.91657527591555E8},{level:1,resolution:78271.51696399994,
scale:2.95828763795777E8},{level:2,resolution:39135.75848200009,scale:1.47914381897889E8},{level:3,resolution:19567.87924099992,scale:7.3957190948944E7},{level:4,resolution:9783.93962049996,scale:3.6978595474472E7},{level:5,resolution:4891.96981024998,scale:1.8489297737236E7},{level:6,resolution:2445.98490512499,scale:9244648.868618},{level:7,resolution:1222.992452562495,scale:4622324.434309},{level:8,resolution:611.4962262813797,scale:2311162.217155},{level:9,resolution:305.74811314055756,scale:1155581.108577},
{level:10,resolution:152.87405657041106,scale:577790.554289},{level:11,resolution:76.43702828507324,scale:288895.277144},{level:12,resolution:38.21851414253662,scale:144447.638572},{level:13,resolution:19.10925707126831,scale:72223.819286},{level:14,resolution:9.554628535634155,scale:36111.909643},{level:15,resolution:4.77731426794937,scale:18055.954822},{level:16,resolution:2.388657133974685,scale:9027.977411},{level:17,resolution:1.1943285668550503,scale:4513.988705},{level:18,resolution:.5971642835598172,
scale:2256.994353},{level:19,resolution:.29858214164761665,scale:1128.497176}]}),_outlineInfo:[{size:10,width:0},{size:20,width:.5},{size:80,width:1},{size:250,width:2}],_srcQuery:"service-query",_srcGenRend:"service-generate-renderer",_srcMemory:"features-in-memory",_srcFeatures:"features",_log10e:Math.LOG10E,_reNumber:/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,constructor:function(a){x.mixin(this,a);this._sampleCache=this._maxFeaturesForStats=null;this._gsTask=E.geometryService||new da(this.geometryServiceUrl);
if(this.layer.loaded)this._createGRTask();else L.once(this.layer,"load",x.hitch(this,this._createGRTask))},destroy:function(){this.clearFeaturesCache();this.layer=this._grTask=null},clearFeaturesCache:function(){this._sampleCache=this._maxFeaturesForStats=null},getUniqueValues:function(a){var b=new v;a&&(a.field||a.valueExpression)?this._callAfterLoad(this._fetchFeatures,{dfd:b,params:a},this._findUniqueValues):this._rejectDfd(b,"FeatureLayerStatistics.getUniqueValues: 'field' or 'valueExpression' parameter is required.");
return b.promise},getPredominantCategories:function(a){var b=new v;a&&a.fields?2>a.fields.length?this._rejectDfd(b,"FeatureLayerStatistics.getPredominantCategories: invalid fields. Minimum required is 2."):this._callAfterLoad(this._predominantCategories,{dfd:b,params:a}):this._rejectDfd(b,"FeatureLayerStatistics.getPredominantCategories: 'fields' parameter is missing.");return b.promise},getPredominanceExpressions:function(a){var b=new v;a&&a.fields?2>a.fields.length?this._rejectDfd(b,"FeatureLayerStatistics.getPredominanceExpressions: invalid fields. Minimum required is 2."):
this._callAfterLoad(this._predominanceExpressions,{dfd:b,params:a}):this._rejectDfd(b,"FeatureLayerStatistics.getPredominanceExpressions: 'fields' parameter is missing.");return b.promise},getAgeStatistics:function(a){var b=new v;null==a.startTime||null==a.endTime||null==a.units?this._rejectDfd(b,"FeatureLayerStatistics.getAgeStatistics: 'startTime', 'endTime' or 'units' parameter is missing."):this._callAfterLoad(this._ageStatistics,{dfd:b,params:a});return b.promise},getSuggestedAgeUnits:function(a){var b=
new v;null==a.startTime||null==a.endTime?this._rejectDfd(b,"FeatureLayerStatistics.getSuggestedAgeUnits: 'startTime' or 'endTime' parameter is missing."):this._callAfterLoad(this._suggestedAgeUnits,{dfd:b,params:a});return b.promise},getAgeExpressions:function(a){var b=new v;null==a.startTime||null==a.endTime?this._rejectDfd(b,"FeatureLayerStatistics.getAgeExpressions: 'startTime' or 'endTime' parameter is missing."):this._callAfterLoad(this._ageExpressions,{dfd:b,params:a});return b.promise},getFieldStatistics:function(a){var b=
new v;a&&(a.field||a.valueExpression||a.sqlExpression)?this._callAfterLoad(this._getFieldStats,{dfd:b,params:a}):this._rejectDfd(b,"FeatureLayerStatistics.getFieldStatistics: 'field', 'valueExpression' or 'sqlExpression' parameter is required.");return b.promise},getSuggestedDataRange:function(a){var b=a&&a.statistics;if(b){if(null==b.min)if(a.isDate){a=this._getYearOfDate();var c=a[0];var d=a[1]}else c=0,d=100;else b.min===b.max&&(a.isDate?(a=this._getYearOfDate(b.min),c=a[0],d=a[1]):0>b.min?(c=
2*b.min,d=0):0<b.min?(c=0,d=2*b.min):(c=0,d=100));return{min:null!=c?c:b.min,max:null!=d?d:b.max,defaultStatistics:null!=c||null!=d}}console.log("FeatureLayerStatistics.getSuggestedDataRange: 'statistics' parameter is required.")},getSpatialStatistics:function(a){var b=new v;a&&a.features&&a.features.length?this._callAfterLoad(this._spatialStats,{dfd:b,params:a}):this._rejectDfd(b,"FeatureLayerStatistics.getSpatialStatistics: 'features' parameter is missing or it has no features.");return b.promise},
getSuggestedSizeRange:function(a){var b=new v;this._callAfterLoad(this._getSizeRange,{dfd:b,params:a});return b.promise},getSuggestedOutline:function(a){var b=new v;this._callAfterLoad(this._getOutline,{dfd:b,params:a});return b.promise},getHeatmapStatistics:function(a){var b=new v;this._callAfterLoad(this._getHeatmapStats,{dfd:b,params:a});return b.promise},getHistogram:function(a){var b=new v;a&&(a.field||a.valueExpression||a.sqlExpression)?this._callAfterLoad(this._fetchFeatures,{dfd:b,params:a},
this._getHistogram):this._rejectDfd(b,"FeatureLayerStatistics.getHistogram: 'field', 'valueExpression' or 'sqlExpression' parameter is required.");return b.promise},getSampleFeatures:function(a){var b=new v;a=x.mixin({},a);a.caching=null!=a.caching?a.caching:!0;a.sampleSize=a.sampleSize||this.sampleSize;this._callAfterLoad(this._sampleFeatures,{dfd:b,params:a});return b.promise},getSuggestedScaleRange:function(a){var b=new v;this._callAfterLoad(this._scaleRange,{dfd:b,params:a});return b.promise},
getClassBreaks:function(a){var b=new v;a&&(a.field||a.valueExpression)?this._callAfterLoad(this._fetchFeatures,{dfd:b,params:a},this._findClassBreaks):this._rejectDfd(b,"FeatureLayerStatistics.getClassBreaks: 'field' or 'valueExpression' parameter is required.");return b.promise},_isCollection:function(){return!this.layer.url||-1<this.layer.declaredClass.indexOf("CSVLayer")},_getFieldStats:function(a){var b=this,c=a.params,d=x.isFunction(c.field),e=c.valueExpression||c.sqlExpression,f=e&&!c.sqlExpression,
g=this._isCollection()||c.features,h=d||f,k=(d=c.field&&!d?this.layer.getField(c.field):null)?d.type===this._dateType:!1;if(d){if(this._rejectIfInvalidType(a.dfd,d,"getFieldStatistics",[].concat(this._numericTypes).concat(this._dateType)))return;if(k&&c.normalizationType){this._rejectDfd(a.dfd,"FeatureLayerStatistics.getFieldStatistics: normalization is not supported when calculating statistics for date field.");return}}else if(e){if(c.normalizationType){this._rejectDfd(a.dfd,"FeatureLayerStatistics.getFieldStatistics: normalization is not supported when valueExpression or sqlExpression is specified.");
return}if(f&&(f=this._getExpressionInfo(c.valueExpression),this._rejectIfInvalidExpression(a.dfd,f,"getFieldStatistics")))return}g||h?(e=!g&&h?this._fetchMaxFeaturesForStats():null,z(e).always(function(l){var m=l&&l.features;m&&(c=x.mixin({},c),c.features=m);b._statsFromMemory(c,k).then(function(n){b._resolveStats(a.dfd,n,l&&l.hasAllFeatures)}).otherwise(function(n){b._rejectDfd(a.dfd,"FeatureLayerStatistics.getFieldStatistics: unable to calculate field statistics.")})})):this._canUseSQL92Expression()||
!k&&!e?(c.normalizationType?this._statsFromGenRend(c):this._statsFromQuery(c,k)).then(function(l){b._resolveStats(a.dfd,l)}).otherwise(function(l){z(b._fetchMaxFeaturesForStats()).always(function(m){var n=m&&m.features;n&&(c=x.mixin({},c),c.features=n);b._statsFromMemory(c,k).then(function(p){b._resolveStats(a.dfd,p,m&&m.hasAllFeatures)}).otherwise(function(p){b._rejectDfd(a.dfd,"FeatureLayerStatistics.getFieldStatistics: unable to calculate field statistics.")})})}):this._rejectDfd(a.dfd,"FeatureLayerStatistics.getFieldStatistics: unable to calculate statistics. Make sure the layer supports SQL expressions and standardized queries.")},
_resolveStats:function(a,b,c){for(var d in b)-1<r.indexOf(O,d)&&(this._isValidNumber(b[d])||(b[d]=null));b.partialData=null!=c?!c:!this._isCollection()&&b.source===this._srcMemory;a.resolve(b)},_statsFromQuery:function(a,b){if(this._canUseSQL92Expression()&&b){var c=x.mixin({},a);delete c.field;c.sqlExpression=this._msSinceUnixEpochSQL(a.field)}return this._executeStatsQuery(c||a).then(function(d){b&&(r.forEach("min max avg stddev sum variance".split(" "),function(e){null!=d[e]&&(d[e]=Math.ceil(d[e]))}),
d.min===d.max&&null!=d.min&&(d.avg=d.min,d.stddev=d.variance=0));return d})},_msSinceUnixEpochSQL:function(a){return this._getDateDiffSQL(new Date(0),a,"milliseconds").sqlExpression},_executeStatsQuery:function(a){var b=this.layer,c=new v;if(b.url&&b.supportsStatistics){var d=new y,e=this,f=a.sqlExpression||a.field,g=f?this._getRangeExpr(f,a.minValue,a.maxValue):null;d.sqlFormat=a.sqlExpression?"standard":null;d.where=this._mergeWhereClauses(a.sqlWhere,g);d.outStatistics=r.map(O,function(h){var k=
new F;k.statisticType="variance"===h?"var":h;k.onStatisticField=f;k.outStatisticFieldName=h+"_value";return k});b.queryFeatures(d).then(function(h){h=(h=h&&h.features)&&h[0]&&h[0].attributes;var k,l={source:e._srcQuery};for(k in h)l[k.replace(oa,"").toLowerCase()]=h[k];l.min===l.max&&null!=l.min&&null==l.stddev&&(l.stddev=l.variance=0);c.resolve(l)}).otherwise(function(h){e._rejectDfd(c,"FeatureLayerStatistics: Statistics query operation failed.")})}else this._rejectDfd(c,"FeatureLayerStatistics: Statistics query requires a layer that supports statistics.");
return c.promise},_mergeWhereClauses:function(a,b){b&&(a=a?"("+a+") AND ("+b+")":b);return a},_statsFromMemory:function(a,b){var c=new v;if("percent-of-total"===a.normalizationType){var d=this._calcStatsFromMemory({field:a.field}).sum;if(null==d){this._rejectDfd(c,"getFieldStatistics: invalid normalizationTotal.");return}a=x.mixin({normalizationTotal:d},a)}c.resolve(this._calcStatsFromMemory(a,b));return c.promise},_calcStatsFromMemory:function(a,b){var c=!(!a.features||!a.features.length),d=this._getDataValues(c?
a.features:this.layer.graphics,a),e=this._calcStatistics(d,!a.normalizationType);e.source=c?this._srcFeatures:this._srcMemory;b&&r.forEach(["avg","stddev","variance"],function(f){null!=e[f]&&(e[f]=Math.ceil(e[f]))});return e},_isValidNumber:function(a){return"number"===typeof a&&!isNaN(a)&&Infinity!==a&&-Infinity!==a},_getDataValues:function(a,b){var c=H.createAttributeCache({field:b.field,valueExpression:b.valueExpression,normalizationType:b.normalizationType,normalizationField:b.normalizationField,
normalizationTotal:b.normalizationTotal}),d=null==b.minValue?-Infinity:b.minValue,e=null==b.maxValue?Infinity:b.maxValue,f=[];r.forEach(a,function(g){g=g._getDataValue(c.attributeInfo,c,C,this.layer);null!=g&&g>=d&&g<=e&&f.push(g)},this);return f},_calcStatistics:function(a,b){var c=Infinity,d=-Infinity,e=0,f=null,g=null,h=null,k=null;r.forEach(a,function(m){e++;f+=m;m<c&&(c=m);m>d&&(d=m)});if(e){g=f/e;var l=0;r.forEach(a,function(m){l+=Math.pow(m-g,2)});k=b?1<e?l/(e-1):0:0<e?l/e:0;h=Math.sqrt(k)}return{min:e?
c:null,max:e?d:null,count:e,sum:f,avg:g,stddev:h,variance:k}},_statsFromGenRend:function(a){var b=new v,c=this,d=a.normalizationType,e=a.normalizationField;this.getClassBreaks({field:a.field,classificationMethod:"standard-deviation",standardDeviationInterval:.25,normalizationType:d,normalizationField:"field"===d?e:void 0,minValue:a.minValue,maxValue:a.maxValue}).then(function(f){var g;r.some(f.classBreakInfos,function(l,m){l.hasAvg&&(g=l);return!!g});if(g){var h=g.maxValue-g.minValue;var k=g.minValue+
h/2;h*=4}b.resolve({min:f.minValue,max:f.maxValue,avg:k,stddev:h,source:c._srcGenRend})}).otherwise(function(f){c._rejectDfd(b,"FeatureLayerStatistics.getFieldStatistics: unable to calculate class breaks.")});return b.promise},_getYearOfDate:function(a){var b=("number"===typeof a?new Date(a):new Date).getUTCFullYear(),c=Date.UTC(b,0,1,12,0,0,0);b=Date.UTC(b,11,31,12,0,0,0);"number"===typeof a&&(a<c&&(c=a),a>b&&(b=a));return[c,b]},_spatialStats:function(a){var b=a.params.features,c=this.layer.geometryType,
d={};c={point:"esriGeometryPoint"===c,mPoint:"esriGeometryMultipoint"===c,line:"esriGeometryPolyline"===c,polygon:"esriGeometryPolygon"===c||this.layer.hasXYFootprint()};c.point?d=this._getPointStats(b):c.mPoint?d=this._getPointStats(b,!0):c.line?d=this._getLineStats(b):c.polygon&&(d=this._getPolygonStats(b));d.avgXY=this._getAvgXY(b,c);a.dfd.resolve(d)},_getPointStats:function(a,b){var c,d=a.length,e={},f={},g=0,h=0,k=Infinity,l=-Infinity,m=0,n=0,p=[];if(b)for(c=0;c<d;c++)a[c].geometry&&p.push.apply(p,
a[c].geometry.points);else p=a;d=p.length;for(c=0;c<d;c++){if(b){e.x=p[c][0];e.y=p[c][1];var q=e}else q=p[c].geometry;if(q){var u=Infinity;var t=-Infinity;for(a=0;a<d;a++)if(a!==c){if(b){f.x=p[a][0];f.y=p[a][1];var w=f}else w=p[a].geometry;w&&(w=I.getLength(q,w),0<w&&(w<u&&(u=w),w<k&&(k=w),w>t&&(t=w),w>l&&(l=w)))}Infinity!==u&&(++m,g+=u);-Infinity!==t&&(++n,h+=t)}}return{minDistance:Infinity!==k?k:null,maxDistance:-Infinity!==l?l:null,avgMinDistance:m?g/m:null,avgMaxDistance:n?h/n:null}},_getLineStats:function(a){var b,
c=a.length,d,e={},f={},g=Infinity,h=-Infinity,k=0,l=0;for(b=0;b<c;b++)if(d=a[b].geometry)d=this._getLineLength(d,e,f),0<d&&(++l,k+=d,d<g&&(g=d),d>h&&(h=d));return{minLength:Infinity!==g?g:null,maxLength:-Infinity!==h?h:null,avgLength:l?k/l:null}},_getLineLength:function(a,b,c){a=a.paths;var d,e=a.length,f=0;for(d=0;d<e;d++){var g=a[d];g=this._getActualLineLength(g,b,c);0<g&&(f+=g)}return f},_getApproxLineLength:function(a,b,c){var d=a[0],e=a[a.length-1],f=0;d&&e&&d[0]===e[0]&&d[1]===e[1]&&(e=a[a.length-
2]);d&&e&&d!==e&&(b.x=d[0],b.y=d[1],c.x=e[0],c.y=e[1],f=I.getLength(b,c));return f},_getActualLineLength:function(a,b,c){var d,e=a.length,f=0;for(d=0;d<e-1;d++){var g=a[d];var h=a[d+1];g&&h&&(b.x=g[0],b.y=g[1],c.x=h[0],c.y=h[1],f+=I.getLength(b,c))}return f},_getPolygonStats:function(a){var b,c=a.length,d,e=Infinity,f=-Infinity,g=0,h=0;for(b=0;b<c;b++)a[b].geometry&&(d=a[b].geometry.getExtent())&&(d=(d.getWidth()+d.getHeight())/2,0<d&&(++h,g+=d,d<e&&(e=d),d>f&&(f=d)));return{minSize:Infinity!==e?
e:null,maxSize:-Infinity!==f?f:null,avgSize:h?g/h:null}},_getAvgXY:function(a,b){var c,d,e,f=a.length,g=null,h=null,k=0,l;for(c=0;c<f;c++)if(d=a[c].geometry)if(b.point)++k,g+=d.x,h+=d.y;else if(b.mPoint){var m=d.points;var n=m.length;for(d=0;d<n;d++)++k,g+=m[d][0],h+=m[d][1]}else if(b.line){var p=d.paths;var q=p.length;for(d=0;d<q;d++)for(m=p[d],n=m.length,e=0;e<n;e++)++k,g+=m[e][0],h+=m[e][1]}else if(b.polygon)for(p=d.rings,q=p.length,d=0;d<q;d++)for(m=p[d],n=m.length,e=0;e<n;e++)++k,g+=m[e][0],
h+=m[e][1];null!=g&&null!=h&&(l={x:g/k,y:h/k});return l},_getSizeRange:function(a){var b=this,c=a.params,d=this.layer,e=d.getMap();if("esriGeometryPolygon"===d.geometryType||d.hasXYFootprint())if(e)if(c&&"visible-scale-range"===c.optimizeForScale){var f=this._projectExtent(d.fullExtent,this.tileInfo.spatialReference);this.getSuggestedScaleRange({map:!1}).then(function(g){b._processSizeRange(g.spatialStatistics,e,a.dfd,f,g)}).otherwise(function(g){b._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedSizeRange: unable to calculate suggested scale range.")})}else this._getFeatures(e,
c).then(function(g){b.getSpatialStatistics({features:g}).then(function(h){b._processSizeRange(h,e,a.dfd)}).otherwise(function(h){b._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedSizeRange: unable to calculate spatial statistics.")})}).otherwise(function(g){b._rejectDfd(a.dfd,g.message)});else this._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedSizeRange: layer has to be added to the map.");else this._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedSizeRange: not supported for points and lines.")},
_processSizeRange:function(a,b,c,d,e){var f=this;z(d).always(function(g){g=g&&g.hasOwnProperty("xmin")?g:null;f._calcSizeRange(a,b,c,g,e)})},_getFeatures:function(a,b){var c=new v,d=this;b&&b.useMapExtent?(b=new y,b.geometry=a.extent,a=this.layer.queryFeatures(b)):a={features:this.layer.graphics.slice(0)};z(a).then(function(e){(e=e&&e.features)&&e.length?c.resolve(e):d._rejectDfd(c,"FeatureLayerStatistics: layer has 0 features.")}).otherwise(function(e){d._rejectDfd(c,"FeatureLayerStatistics: unable to query features.")});
return c.promise},_calcSizeRange:function(a,b,c,d,e){var f=a&&a.avgSize,g=b.getResolution();b=b.getScale();if(null==f||isNaN(f))this._rejectDfd(c,"FeatureLayerStatistics.getSuggestedSizeRange: invalid average feature size.");else if(g&&b){if(e){var h=g/b;d=this._getScaleValues(d,e);var k=d.feScaleIndex,l=[],m=[];var n=d.scales[k];r.forEach(d.scales,function(p,q){var u=this._calcSizeValues(f,h*p);q=-1<k&&q>k?2:1;l.push({value:p,size:u.min/q});m.push({value:p,size:u.max/q})},this);d={type:"sizeInfo",
expression:"view.scale",valueExpression:"$view.scale",stops:l};g={type:"sizeInfo",expression:"view.scale",valueExpression:"$view.scale",stops:m}}else g=this._calcSizeValues(f,g),d=g.min,g=g.max;c.resolve({minSize:d,maxSize:g,spatialStatistics:a,avgFeatureSize:f,scaleAtFullExtent:n,suggestedScaleRange:e})}else this._rejectDfd(c,"FeatureLayerStatistics.getSuggestedSizeRange: invalid map scale/resolution.")},_getScaleValues:function(a,b){var c=this.tileInfo.lods,d=this.layer.minScale||c[0].scale;c=this.layer.maxScale||
c[c.length-1].scale;var e=b&&b.minScale||0;b=b&&b.maxScale||0;a=(a=a&&this._findLODForFE(this.tileInfo.lods,a,this.mapWidth,this.mapHeight))&&a.scale<d&&a.scale>c?Math.round(a.scale):0;var f=r.map([d,c,e,b,a],Math.round);f.sort(this._numberSorter);f=r.filter(f,function(g,h){return!!g&&r.indexOf(f,g)===h});f=r.filter(f,function(g,h,k){return h?5<Math.abs(g-k[h-1]):!0});return{scales:f,feScaleIndex:r.indexOf(f,a)}},_numberSorter:function(a,b){return a-b},_findLODForFE:function(a,b,c,d){var e=a.length,
f=b.getWidth(),g=b.getHeight();for(b=0;b<e;b++){var h=a[b];if(c*h.resolution<f||d*h.resolution<g){var k=0===b?a[b]:a[b-1];break}else if(b===e-1){k=a[b];break}}return k},_calcSizeValues:function(a,b){a=Math.ceil(a/b);a=Math.ceil(a/4);4>a?a=4:16<a&&(a=16);b=5*a;return{min:a,max:50>b?50:b}},_getOutline:function(a){var b=this;"esriGeometryPolygon"===this.layer.geometryType||this.layer.hasXYFootprint()?this._getFeatures().then(function(c){b.getSpatialStatistics({features:c}).then(function(d){if(d.avgSize){var e;
r.some(c,function(f){f.geometry&&(e=f.geometry.spatialReference);return!!e});b._calcOutline(d,e,a.params,a.dfd)}else b._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedOutline: average feature size is 0 or null.")}).otherwise(function(d){b._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedOutline: unable to calculate spatial statistics.")})}).otherwise(function(c){b._rejectDfd(a.dfd,c.message)}):this._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedOutline: not supported for points and lines.")},
_calcOutline:function(a,b,c,d){var e=a.avgSize,f=c&&null!=c.allowZeroWidth?c.allowZeroWidth:!0,g=39.37*96*ia.getUnitValueForSR(b);b=r.map(r.filter(this._outlineInfo,function(h,k){return f||0<k}),function(h){return{size:h.width,value:Math.round(e/h.size*g)}});b.sort(function(h,k){return h.value-k.value});d.resolve({widthInfo:{type:"sizeInfo",target:"outline",expression:"view.scale",valueExpression:"$view.scale",stops:b},opacity:.25,spatialStatistics:a})},_getHeatmapStats:function(a){var b=this,c=this.layer,
d=a.params,e=a.dfd,f=d.fieldOffset;a=d.field&&this.layer.getField(d.field);d.field&&this._rejectNonNumeric(e,a,"getHeatmapStatistics")||(d.field&&null==f?c.statisticsPlugin.getFieldStatistics({field:d.field}).then(function(g){b._calcHeatmapStats(g,f,d,e)}).otherwise(function(g){b._rejectDfd(e,"FeatureLayerStatistics.getHeatmapStatistics: unable to calculate field statistics.")}):this._calcHeatmapStats(null,f,d,e))},_calcHeatmapStats:function(a,b,c,d){var e=this;if(a){var f=a.min,g=a.max;a.count?f===
g&&0===f?b=1:0>=g?b="abs":0>f&&(b=-1.01*f):b=1}this._heatStatsFromMemory(c,b).then(function(h){h.fieldStatistics=a;h.fieldOffset=b;d.resolve(h)}).otherwise(function(h){e._rejectDfd(d,"FeatureLayerStatistics.getHeatmapStatistics: unable to calculate heatmap statistics.")})},_heatStatsFromMemory:function(a,b){var c=new v,d=this.layer,e=d.graphics,f=e.length,g=d.getMap();if(!f)return c.resolve({count:0,min:null,max:null,avg:null,stddev:null,source:this._srcMemory}),c.promise;(a=(a=g&&la(na(e,g,d),g.width,
g.height,a.blurRadius||10,a.field,b))&&a.matrix&&ma(a.matrix))?c.resolve({count:f,min:a.min,max:a.max,avg:a.mean,stddev:a.stdDev,source:this._srcMemory}):this._rejectDfd(c,"FeatureLayerStatistics.getHeatmapStatistics: unable to calculate heatmap statistics.");return c.promise},_getHistogram:function(a){var b=this,c=a.params,d=c.minValue,e=c.maxValue,f=c.valueExpression||c.sqlExpression,g=f&&!c.sqlExpression,h=this._isCollection()||g,k=this._canUseSQL92Expression(),l=null!=d&&null!=e,m=c.field?this.layer.getField(c.field):
null,n=m?m.type===this._dateType:!1,p=!c.classificationMethod||"equal-interval"===c.classificationMethod;if(m){if(this._rejectIfInvalidType(a.dfd,m,"getHistogram",[].concat(this._numericTypes).concat(this._dateType)))return;if(n){if(c.normalizationType){this._rejectDfd(a.dfd,"FeatureLayerStatistics.getHistogram: normalization is not supported when calculating histogram for date field.");return}if(!p){this._rejectDfd(a.dfd,"FeatureLayerStatistics.getHistogram:  classification methods other than 'equal-interval' are not supported when calculating histogram for date field.");
return}}}else if(f){if(c.normalizationType){this._rejectDfd(a.dfd,"FeatureLayerStatistics.getHistogram: normalization is not supported when valueExpression or sqlExpression is specified.");return}if(!p){this._rejectDfd(a.dfd,"FeatureLayerStatistics.getHistogram: classification methods other than 'equal-interval' are not supported when valueExpression or sqlExpression is specified.");return}if(g){if(g=this._getExpressionInfo(c.valueExpression),this._rejectIfInvalidExpression(a.dfd,g,"getHistogram"))return}else if(!c.valueExpression){this._rejectDfd(a.dfd,
"FeatureLayerStatistics.getHistogram: valueExpression parameter is missing.");return}}f&&!h?this._getBinsFromStatsQueryForExpr(a.dfd,c,d,e):k&&p&&!h?this._getBinsFromStatsQueryForField(a,n):c.normalizationType||!p?this._binParamsFromGenRend(c).then(function(q){if(l)if(d>q.max||e<q.min)b._rejectDfd(a.dfd,"FeatureLayerStatistics.getHistogram: custom value range is beyond field value range.");else{var u=b._getFieldExpr(c,q.normTotal);u=b._getRangeExpr(u,d,e);p?b._getBins(a,q.sqlExpr,d,e,null,"parameters",
null,q.excludeZerosExpr):b._binParamsFromGenRend(c,u).then(function(t){b._getBins(a,t.sqlExpr,t.min,t.max,t.intervals,t.source,t.normTotal,t.excludeZerosExpr)}).otherwise(function(t){b._rejectDfd(a.dfd,"FeatureLayerStatistics.getHistogram: unable to calculate histogram parameters using custom min/max values.")})}else b._getBins(a,q.sqlExpr,q.min,q.max,q.intervals,q.source,q.normTotal,q.excludeZerosExpr)}).otherwise(function(q){b._rejectDfd(a.dfd,"FeatureLayerStatistics.getHistogram: unable to calculate min/max from generate renderer operation.")}):
l?this._getBins(a,null,d,e,null,"parameters"):this.getFieldStatistics(c).then(function(q){q.count?b._getBins(a,null,q.min,q.max,null,q.source):b._rejectDfd(a.dfd,"FeatureLayerStatistics.getHistogram: cannot calculate histogram for 0 features (statistics.count \x3d 0).")}).otherwise(function(q){b._rejectDfd(a.dfd,"FeatureLayerStatistics.getHistogram: unable to calculate min/max.")})},_getBins:function(a,b,c,d,e,f,g,h){var k=this,l=a.params.field,m=l?this.layer.getField(l):null;m=m?m.type===this._dateType:
!1;var n=a.params.numBins||this.numBins;e=e||this._getEqualIntervalBins(c,d,n);b=b||l;this._isCollection()||m||a.params.features?this._countBinsInMemory(a,c,d,e,g,f):this._queryBins(b,e,h).then(function(p){p=r.map(p,function(q,u){return{minValue:e[u][0],maxValue:e[u][1],count:q}});a.dfd.resolve({bins:p,minValue:c,maxValue:d,normalizationTotal:g,source:k._srcQuery,statisticsSource:f,partialData:!1})}).otherwise(function(p){k._countBinsInMemory(a,c,d,e,g,f)})},_getEqualIntervalBins:function(a,b,c){var d=
(b-a)/c,e=a,f=[];for(a=1;a<=c;a++){var g=e+d;g=Number(g.toFixed(16));f.push([e,a===c?b:g]);e=g}return f},_countBinsInMemory:function(a,b,c,d,e,f){var g=this;this._binsFromMemory(a.params,b,c,d,e).then(function(h){var k=a.params.hasAllFeatures;a.dfd.resolve({bins:h,minValue:b,maxValue:c,normalizationTotal:e,source:a.params.features?g._srcFeatures:g._srcMemory,statisticsSource:f,partialData:null!=k?!k:!g._isCollection()})}).otherwise(function(h){g._rejectDfd(a.dfd,"FeatureLayerStatistics: unable to calculate histogram.")})},
_queryBins:function(a,b,c){var d=this.layer,e,f=[],g=b.length;for(e=0;e<g;e++){var h=new y;h.where=(c?c+" AND ":"")+a+" \x3e\x3d "+b[e][0]+(null!==b[e][1]?" AND "+a+(e===g-1?" \x3c\x3d ":" \x3c ")+b[e][1]:"");f.push(h)}return U(r.map(f,function(k){return d.queryCount(k)}))},_binsFromMemory:function(a,b,c,d,e){var f=new v;e=H.createAttributeCache({field:a.field,valueExpression:a.valueExpression,normalizationType:a.normalizationType,normalizationField:a.normalizationField,normalizationTotal:e});a=a.features||
this.layer.graphics;var g,h=[];if(!a.length)return this._rejectDfd(f,"Layer has 0 features in memory."),f.promise;var k=d.length;for(g=0;g<k;g++)h.push({minValue:d[g][0],maxValue:d[g][1],count:0});k=a.length;for(g=0;g<k;g++){var l=a[g];l=l._getDataValue(e.attributeInfo,e,C,this.layer);null!=l&&l>=b&&l<=c&&(l=this._binIndex(d,l),-1<l&&h[l].count++)}f.resolve(h);return f.promise},_binIndex:function(a,b){var c,d=-1;for(c=a.length-1;0<=c;c--){var e=a[c][0];if(b>=e){d=c;break}}return d},_binParamsFromGenRend:function(a,
b){var c=this.layer,d=new v,e=this,f=this._getGRWhereInfo(c,a),g=f.where,h=a.numBins||this.numBins,k=this._createCBDefn(a,h),l=new G;l.classificationDefinition=k;l.where=g?g+(b?" AND "+b:""):b;!this._isCollection()&&10.1<=c.version&&!a.features?this._grTask.execute(l).then(function(m){e._resolveBinParams(m,f,e._srcGenRend,a,d)}).otherwise(function(m){e._binParamsFromMemory(h,f,a,d)}):e._binParamsFromMemory(h,f,a,d);return d.promise},_binParamsFromMemory:function(a,b,c,d){var e=this;this._cbFromMemory(c,
a).then(function(f){e._resolveBinParams(f,b,c.features?e._srcFeatures:e._srcMemory,c,d)}).otherwise(function(f){e._rejectDfd(d,"FeatureLayerStatistics.getHistogram: unable to calculate class breaks.")})},_resolveBinParams:function(a,b,c,d,e){var f=[],g=a.infos;var h=g.length;var k=g[0].minValue;h=g[h-1].maxValue;r.forEach(g,function(l,m){f.push([l.minValue,l.maxValue])});e.resolve({min:k,max:h,intervals:f,sqlExpr:this._getFieldExpr(d,a.normalizationTotal),excludeZerosExpr:b.excludeZerosExpr,normTotal:a.normalizationTotal,
source:c})},_getGRWhereInfo:function(a,b){var c=b.field,d=b.normalizationType;b=b.normalizationField;a=a.getDefinitionExpression();var e;"log"===d?e="(NOT "+c+" \x3d 0)":"field"===d&&(e="(NOT "+b+" \x3d 0)");return{where:e?e+(a?" AND "+a:""):a,excludeZerosExpr:e}},_getFieldExpr:function(a,b){var c=a.field,d=a.normalizationType;a=a.normalizationField;var e=c;"percent-of-total"===d?e="(("+c+" / "+b+") * 100)":"log"===d?e="(log("+c+") * "+this._log10e+")":"field"===d&&(e="("+c+" / "+a+")");return e},
_getRangeExpr:function(a,b,c){b=null!=b?a+" \x3e\x3d "+b:"";a=null!=c?a+" \x3c\x3d "+c:"";c="";return(c=b&&a?b+" AND "+a:b||a)?"("+c+")":""},_getBinsFromStatsQueryForExpr:function(a,b,c,d){var e=this,f=null!=c&&null!=d;c=f?{min:c,max:d}:this.getFieldStatistics(b);z(c).then(function(g){e._getBinsFromStatsQuery(b,g.min,g.max,f?"parameters":g.source).then(function(h){a.resolve(h)}).otherwise(function(h){e._rejectDfd(a,"FeatureLayerStatistics.getHistogram: query to calculate count failed.")})}).otherwise(function(g){e._rejectDfd(a,
"FeatureLayerStatistics.getHistogram: unable to calculate min/max.")})},_getBinsFromStatsQueryForField:function(a,b){var c=this,d=a.params,e=this.layer,f;"percent-of-total"===d.normalizationType&&(f=this.getFieldStatistics({field:d.field}).then(function(g){return g.sum}));z(f).then(function(g){g={numBins:d.numBins,sqlExpression:b?c._msSinceUnixEpochSQL(d.field):c._getFieldExpr(d,g),sqlWhere:b?null:c._getGRWhereInfo(e,d).excludeZerosExpr};c._getBinsFromStatsQueryForExpr(a.dfd,g,d.minValue,d.maxValue)}).otherwise(function(g){c._rejectDfd(a.dfd,
"FeatureLayerStatistics.getHistogram: unable to calculate normalizationTotal.")})},_getBinsFromStatsQuery:function(a,b,c,d){var e=this.layer,f=new v;if(this._canUseSQL92Expression()){var g=this._getEqualIntervalBins(b,c,a.numBins||this.numBins),h=this._calcBinsSQL(a.sqlExpression,g),k=this,l=new F;l.statisticType="count";l.outStatisticFieldName="countOFExpr";l.onStatisticField="*";var m=new y;m.outStatistics=[l];m.groupByFieldsForStatistics=[h];m.orderByFields=[h];m.where=a.sqlWhere;m.sqlFormat="standard";
e.queryFeatures(m).then(function(n){var p={};r.forEach(n.features,function(u){var t=u.attributes;u=this._getCustomExprVal(t,"countOFExpr");t=this._getAttributeVal(t,"countOFExpr");0!==u&&(p[u]=t)},k);var q=[];r.forEach(g,function(u,t){t+=1;q.push({minValue:u[0],maxValue:u[1],count:p.hasOwnProperty(t)?p[t]:0})});f.resolve({bins:q,minValue:b,maxValue:c,source:k._srcQuery,statisticsSource:d,partialData:!1})}).otherwise(function(n){k._rejectDfd(f,"FeatureLayerStatistics.getHistogram: Statistics query operation failed.")})}else this._rejectDfd(f,
"FeatureLayerStatistics.getHistogram: make sure the layer supports advanced SQL expressions and standardized queries.");return f.promise},_fetchMaxFeaturesForStats:function(){var a=this;if(this._maxFeaturesForStats){var b=new v;b.resolve(this._maxFeaturesForStats);return b.promise}return this.getSampleFeatures({sampleSize:-1,caching:!1,returnGeometry:!1}).then(function(c){a._maxFeaturesForStats={features:c.features,hasAllFeatures:c.features.length===c.totalFeatures};return a._maxFeaturesForStats})},
_sampleFeatures:function(a){var b=this,c=a.params,d=a.dfd,e=this.layer,f=e.graphics,g=c.caching;a=this._sampleCache;var h=c.resample,k=c.sampleSize;g&&a&&!h?d.resolve(this._cloneSample(a)):(d._time={start:this._getTime()},f.length&&0<k&&k<=f.length?this._resolveSample(d,this._pickItems(f,k),g,this._srcMemory):(a=new y,a.where="1\x3d1",d._time.countStart=this._getTime(),e.queryCount(a).then(function(l){d._time.countEnd=b._getTime();d._totalFeatures=l;-1===k&&(k=l);k>e.maxRecordCount&&(k=e.maxRecordCount);
if(l)if(l<=f.length||f.length>=e.maxRecordCount)b._resolveSample(d,b._pickItems(f,f.length),g,b._srcMemory);else if(l<=k){var m=new y;m.where="1\x3d1";b._queryFeatures(m,c,e,f,d)}else l<=b.samplingThreshold?(l=new y,l.where="1\x3d1",d._time.idStart=b._getTime(),e.queryIds(l).then(function(n){d._time.idEnd=b._getTime();var p=new y;p.objectIds=b._pickItems(n,k);b._queryFeatures(p,c,e,f,d)}).otherwise(function(n){m=new y;m.where="1\x3d1";b._queryFeatures(m,c,e,f,d)})):(m=new y,m.where="1\x3d1",(l=e.advancedQueryCapabilities)&&
l.supportsPagination&&(m.num=k),b._queryFeatures(m,c,e,f,d));else b._resolveSample(d,[],g,b._srcQuery)}).otherwise(function(l){b._resolveSample(d,b._pickItems(f,f.length),g,b._srcMemory)})))},_queryFeatures:function(a,b,c,d,e){var f=this;a.outSpatialReference=b.spatialReference;a.maxAllowableOffset=b.maxAllowableOffset;a.outFields=b.outFields;null!=b.returnGeometry&&(a.returnGeometry=b.returnGeometry);e._time.featStart=this._getTime();c.queryFeatures(a).then(function(g){e._time.featEnd=f._getTime();
f._resolveSample(e,g&&g.features||[],b.caching,f._srcQuery)}).otherwise(function(g){f._resolveSample(e,f._pickItems(d,d.length),b.caching,f._srcMemory)})},_pickItems:function(a,b){var c=a.length,d=[],e=[];if(b>=c)e=a.slice(0);else for(;e.length<b;){var f=this._getRandomInt(0,c);-1===r.indexOf(d,f)&&(d.push(f),e.push(a[f]))}return e},_getRandomInt:function(a,b){return Math.floor(Math.random()*(b-a))+a},_resolveSample:function(a,b,c,d){b=b||[];var e,f=b.length,g;for(e=0;e<f&&!(g=(g=b[e].geometry)&&
g.spatialReference);e++);a._time.end=(new Date).getTime();e=a._time;a._time=null;b={features:b,spatialReference:g&&new B(g.toJson()),source:d,time:this._getTimeStats(e),totalFeatures:a._totalFeatures};c&&(this._sampleCache=this._cloneSample(b));a.resolve(b)},_cloneSample:function(a){return{features:r.map(a.features,function(b){return new b.constructor(b.toJson())}),spatialReference:a.spatialReference&&new B(a.spatialReference.toJson()),source:a.source,time:x.clone(a.time),totalFeatures:a.totalFeatures}},
_getTimeStats:function(a){var b=this._getTimeDiff;return{total:b(a.start,a.end),features:b(a.featStart,a.featEnd),featureIds:b(a.idStart,a.idEnd),featureCount:b(a.countStart,a.countEnd)}},_getTimeDiff:function(a,b){if(null!=a&&null!=b){a=b-a;b="millisecond";1E3<=a&&(a/=1E3,b="second",60<=a&&(a/=60,b="minute"));var c={value:Number(a.toFixed(2)),unit:b}}return c},_getTime:function(){return(new Date).getTime()},_scaleRange:function(a){var b=this,c=a.params,d=this.layer,e=c&&c.sampleSize||this.sampleSize,
f=c&&c.map||d.getMap(),g=c&&c.mapWidth||this.mapWidth,h=c&&c.mapHeight||this.mapHeight,k=c&&c.generalizeForScale||this.generalizeForScale;c&&!1===c.map&&(f=null);if(f&&f.__tileInfo){var l=f.__tileInfo;var m=f.spatialReference;f=f.extent.getWidth()/f.width/f.getScale()*k}else l=this.tileInfo,m=l.spatialReference,f=this.generalizeForResolution/this.generalizeForScale*k;this.getSampleFeatures({sampleSize:e,spatialReference:m,maxAllowableOffset:f,outFields:[]}).then(function(n){var p=b._projectExtent(d.fullExtent,
m),q=n.features;q&&q.length?b.getSpatialStatistics({features:q}).then(function(u){z(p).always(function(t){t=t&&t.hasOwnProperty("xmin")?t:null;b._processScaleRange(a.dfd,c,l,g,h,t,n,u)})}).otherwise(function(u){b._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedScaleRange: unable to calculate spatial statistics.")}):b._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedScaleRange: sampling returned 0 features.")}).otherwise(function(n){b._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedScaleRange: unable to sample features.")})},
_processScaleRange:function(a,b,c,d,e,f,g,h){var k=this.layer.geometryType,l={point:"esriGeometryPoint"===k,mPoint:"esriGeometryMultipoint"===k,line:"esriGeometryPolyline"===k,polygon:"esriGeometryPolygon"===k||this.layer.hasXYFootprint()};k=b&&b.forPublishingTiles;var m=c.lods,n=this._getLODForMinScale(b,h,l,c),p=k||l.polygon?this._getLODForMaxScale(b,h,l,c):null,q=1-this.mapPaddingRatioForFE,u=(q=f&&this._findLODForFE(m,f,d*q,e*q))?q.scale:null,t=(b=this._getLODForMinScale(b,h,l,c,this.minScaleRelaxationRatio))?
b.scale:null,w=(b=h.avgXY)&&new ja(b.x,b.y,g.spatialReference&&new B(g.spatialReference.toJson())),P=this,J=k||l.polygon?p?Math.floor(p.scale):null:0,Q;n&&f&&w&&(Q=this._findClosestLOD(m,n,f,w,d,e));var K=(n=Q||n)?Math.ceil(n.scale):null;t=t&&u?Math.max(t,2*u):t||2*u;u=u&&Math.ceil(u);t=t&&Math.ceil(t);n||p?n&&w?this._countAtView(w,n,d,e).then(function(A){if(!A){A=g.features[0];var R=l.point?A.geometry:(A=A.geometry&&A.geometry.getExtent())&&A.getCenter()}P._resolveScaleRange(a,K,J,u,t,R||w,g,h)}).otherwise(function(A){P._resolveScaleRange(a,
K,J,u,t,w,g,h)}):this._resolveScaleRange(a,K,J,u,t,w,g,h):this._rejectDfd(a,"FeatureLayerStatistics.getSuggestedScaleRange: unable to find optimal scale range.")},_resolveScaleRange:function(a,b,c,d,e,f,g,h){b<c?this._rejectDfd(a,"FeatureLayerStatistics.getSuggestedScaleRange: invalid scale range - calculated minScale is less than maxScale."):(c>b/2&&(c=Math.floor(c/2)),a.resolve({minScale:b&&(b>this.worldScale?0:b),maxScale:c,scaleAtFullExtent:d,relaxedMinScale:e&&(e>this.worldScale?0:e),center:f,
sampleInfo:g,spatialStatistics:h}))},_countAtView:function(a,b,c,d){a=this._getExtentFromCenter(a,b,c,d);b=new y;b.geometry=a;return this.layer.queryCount(b).promise},_projectExtent:function(a,b){if(a.spatialReference.equals(b))return new a.constructor(a.toJson());if(N.canProject(a.spatialReference,b))return N.project(a,b);var c=new ea;c.geometries=[a];c.outSR=b;return this._gsTask.project(c).then(function(d){return d&&d[0]})},_getLODForMinScale:function(a,b,c,d,e){var f=a&&a.minDistance||this.minDistance,
g=a&&a.minLength||this.minLength;a=a&&a.minSize||this.minSize;var h;if(c.point){var k=b.avgMinDistance;var l=f}else c.mPoint?(k=b.avgMinDistance,l=f):c.line?(k=b.avgLength,l=g):c.polygon&&(k=b.avgSize,l=a);0<k&&(h=this._findLOD(d,k,l*(e||1)));return h},_getLODForMaxScale:function(a,b,c,d){var e=this.mapWidth,f=a&&a.forPublishingTiles,g=a&&a.maxDistance||e/4,h=a&&a.maxLength||e/4;a=a&&a.maxSize||e/2;var k;if(c.point){var l=f?b.avgMinDistance:b.minDistance;var m=g}else c.mPoint?(l=f?b.avgMinDistance:
b.minDistance,m=g):c.line?(l=f?b.avgLength:b.minLength,m=h):c.polygon&&(l=f?b.avgSize:b.minSize,m=a);0<l&&(k=this._findLOD(d,l,null,m));return k},_findLOD:function(a,b,c,d){a=a&&a.lods;var e;if(a&&a.length){var f=null!=d,g=f?0:a.length-1,h=f?-1:1;for(e=f?a.length-1:0;f?e>=g:e<=g;e+=h){var k=a[e];var l=Math.round(b/k.resolution);if(f){if(l<=d){var m=k;break}}else if(l>=c){m=k;break}}}return m},_getExtentFromCenter:function(a,b,c,d){c=c/2*b.resolution;b=d/2*b.resolution;return new ka(a.x-c,a.y-b,a.x+
c,a.y+b,new B(a.spatialReference.toJson()))},_findClosestLOD:function(a,b,c,d,e,f){var g,h=a.length;for(g=0;g<h;g++)if(!(a[g].level<b.level)){var k=this._getExtentFromCenter(d,a[g],e,f);if(!k.contains(c)){var l=a[g-1];break}else if(g===h-1){l=a[g];break}}return l=l&&l.level>b.level?l:null},_findUniqueValues:function(a){var b=this,c=a.params,d=c.field,e=d?this.layer.getField(d):null,f=c.valueExpression||c.sqlExpression,g=c.valueExpression&&(!c.sqlExpression||!this._canUseSQL92Expression()),h=this._isCollection()||
c.features||g;if(d&&!e)this._rejectDfd(a.dfd,"FeatureLayerStatistics.getUniqueValues: unknown 'field'.");else{if(f)if(g){if(d=this._getExpressionInfo(c.valueExpression),this._rejectIfInvalidExpression(a.dfd,d,"getUniqueValues"))return}else if(!c.valueExpression){this._rejectDfd(a.dfd,"FeatureLayerStatistics.getUniqueValues: valueExpression parameter is missing.");return}h?this._uvFromMemory(c).then(function(k){b._resolveUVDfd(k,a,e,c.features?b._srcFeatures:b._srcMemory)}).otherwise(function(k){b._rejectDfd(a.dfd,
"FeatureLayerStatistics: unable to calculate unique values.")}):this._uvFromStatisticsQuery(c).then(function(k){b._resolveUVDfd(k,a,e,b._srcQuery)}).otherwise(function(k){b._uvFromGenRenderer(c,e).then(function(l){b._resolveUVDfd(l,a,e,b._srcGenRend)}).otherwise(function(l){b._uvFromMemory(c).then(function(m){b._resolveUVDfd(m,a,e,b._srcMemory)}).otherwise(function(m){b._rejectDfd(a.dfd,"FeatureLayerStatistics: unable to calculate unique values.")})})})}},_uvFromStatisticsQuery:function(a){var b=
this.layer,c=new v;if(b.supportsStatistics){var d=a.field;a=a.sqlExpression;var e="countOF"+(d||"Expr"),f=this,g=new F;g.statisticType="count";g.onStatisticField=a?"*":d;g.outStatisticFieldName=e;var h=new y;h.outStatistics=[g];h.groupByFieldsForStatistics=[d||a];h.sqlFormat=a?"standard":null;b.queryFeatures(h).then(function(k){var l,m,n={},p,q,u=!!k.exceededTransferLimit;r.forEach(k.features,function(t){l=t.attributes;m=d?this._getAttributeVal(l,d):this._getCustomExprVal(l,e);p=this._getAttributeVal(l,
e);null===m&&0===p&&(q=!0);if(null==m||""===m||"string"===typeof m&&""===x.trim(m))m=null;null==n[m]?n[m]={count:p,data:m}:n[m].count+=p},f);d&&q?(h=new y,h.where=d+" is NULL",b.queryCount(h).then(function(t){n["null"].count+=t||0;c.resolve({count:n,partialData:u})}).otherwise(function(t){c.resolve({count:n,partialData:u})})):c.resolve({count:n,partialData:u})}).otherwise(function(k){f._rejectDfd(c,"FeatureLayerStatistics: Statistics query operation failed.")})}else this._rejectDfd(c,"FeatureLayerStatistics: Statistics query requires a layer that supports statistics.");
return c.promise},_uvFromGenRenderer:function(a,b){var c=this.layer,d=new v,e=this;if(10.1<=c.version){var f=new aa;f.attributeField=a.field;a=new G;a.classificationDefinition=f;a.where=c.getDefinitionExpression();this._grTask.execute(a).then(function(g){var h={},k,l=-1<r.indexOf(e._numericTypes,b.type);r.forEach(g.infos,function(m){k=m.value;if(null==k||""===k||"string"===typeof k&&(""===x.trim(k)||"\x3cnull\x3e"===k.toLowerCase()))k=null;null==h[k]?h[k]={count:m.count,data:l&&k?Number(k):k}:h[k].count+=
m.count});d.resolve({count:h})}).otherwise(function(g){e._rejectDfd(d,"FeatureLayerStatistics: Generate renderer operation failed.")})}else this._rejectDfd(d,"FeatureLayerStatistics: Generate renderer operation requires server version 10.1 or later.");return d.promise},_uvFromMemory:function(a){var b=this.layer,c=new v,d=H.createAttributeCache({field:a.field,valueExpression:a.valueExpression},!0),e={};r.forEach(a.features||b.graphics,function(f){f=f._getDataValue(d.attributeInfo,d,C,b);if(null==f||
""===f||"string"===typeof f&&""===x.trim(f))f=null;null==e[f]?e[f]={count:1,data:f}:e[f].count++},this);c.resolve({count:e});return c.promise},_resolveUVDfd:function(a,b,c,d){var e=a.count,f=c&&this.layer.getDomain(c.name),g;c=[];b.params.includeAllCodedValues&&f&&"codedValue"===f.type&&r.forEach(f.codedValues,function(h){h=h.code;e.hasOwnProperty(h)||(e[h]={data:h,count:0})});for(g in e)f=e[g],c.push({value:f.data,count:f.count});b.dfd.resolve({source:d,partialData:null!=b.params.hasAllFeatures?
!b.params.hasAllFeatures:!this._isCollection()&&(d===this._srcMemory||a.partialData),uniqueValueInfos:c})},_findClassBreaks:function(a){var b=this,c=a.params,d=c.minValue,e=c.maxValue,f=null!=d||null!=e,g=c.classificationMethod,h="percent-of-total"===c.normalizationType,k=c.numClasses||this.numClasses,l=!1!==c.analyzeData,m=c.field,n=m?this.layer.getField(m):null,p=c.valueExpression;m=this._isCollection()||c.features||p;if(!n||!this._rejectNonNumeric(a.dfd,n,"getClassBreaks")){if(p){if(c.normalizationType){this._rejectDfd(a.dfd,
"FeatureLayerStatistics.getClassBreaks: normalization is not supported when valueExpression is specified.");return}d=this._getExpressionInfo(p);if(this._rejectIfInvalidExpression(a.dfd,d,"getClassBreaks"))return}else if(f)if(l){if(h&&null==c.normalizationTotal){this._rejectDfd(a.dfd,"FeatureLayerStatistics.getClassBreaks: normalizationTotal is required when minValue/maxValue are specified.");return}}else{if(null==d||null==e){this._rejectDfd(a.dfd,"FeatureLayerStatistics.getClassBreaks: both minValue AND maxValue are required when data analysis is disabled.");
return}if(g&&"equal-interval"!==g){this._rejectDfd(a.dfd,"FeatureLayerStatistics.getClassBreaks: data analysis can be disabled only for equal-interval classification.");return}if(h&&null==c.normalizationTotal){this._rejectDfd(a.dfd,"FeatureLayerStatistics.getClassBreaks: normalizationTotal is required when data analysis is disabled.");return}}else if(!l){this._rejectDfd(a.dfd,"FeatureLayerStatistics.getClassBreaks: both minValue AND maxValue are required when data analysis is disabled.");return}l?
m?this._cbFromMemory(c,k).then(function(q){b._resolveCBDfd(a.dfd,c,q,c.features?b._srcFeatures:b._srcMemory)}).otherwise(function(q){b._rejectDfd(a.dfd,"FeatureLayerStatistics: unable to calculate class breaks.")}):this._cbFromGenRend(c,k).then(function(q){b._resolveCBDfd(a.dfd,c,q,b._srcGenRend)}).otherwise(function(q){f?b._rejectDfd(a.dfd,"FeatureLayerStatistics.getClassBreaks: cannot calculate class breaks in-memory when minValue/maxValue are specified."):b._cbFromMemory(c,k).then(function(u){b._resolveCBDfd(a.dfd,
c,u,b._srcMemory)}).otherwise(function(u){b._rejectDfd(a.dfd,"FeatureLayerStatistics: unable to calculate class breaks.")})}):this._cbFromInterpolation(c,k).then(function(q){b._resolveCBDfd(a.dfd,c,q,b._srcMemory)}).otherwise(function(q){b._rejectDfd(a.dfd,"FeatureLayerStatistics: unable to calculate class breaks.")})}},_cbFromGenRend:function(a,b){var c=this.layer,d=new v,e=this;if(c.url&&10.1<=c.version){b=this._createCBDefn(a,b);c=this._getGRWhereInfo(c,a).where;var f=this._getFieldExpr(a,a.normalizationTotal);
a=this._getRangeExpr(f,a.minValue,a.maxValue);f=new G;f.classificationDefinition=b;f.where=c?c+(a?" AND "+a:""):a;this._grTask.execute(f).then(function(g){d.resolve(g)}).otherwise(function(g){e._rejectDfd(d,"FeatureLayerStatistics: Generate renderer operation failed.")})}else this._rejectDfd(d,"FeatureLayerStatistics: Generate renderer operation requires server version 10.1 or later.");return d.promise},_cbFromMemory:function(a,b){var c=new v,d=a.features||this.layer.graphics;if(d.length){b=this._createCBDefn(a,
b);if("percent-of-total"===a.normalizationType){var e=this._calcStatsFromMemory({field:a.field}).sum;if(null==e)return this._rejectDfd(c,"FeatureLayerStatistics: Invalid normalizationTotal."),c.promise;a=x.mixin({normalizationTotal:e},a)}c.resolve(ca.createClassBreaksRenderer({features:d,definition:b,values:this._getDataValues(d,a)}))}else this._rejectDfd(c,"Layer has 0 features in memory.");return c.promise},_cbFromInterpolation:function(a,b){var c=new v,d=a.minValue,e=a.maxValue;if(d>=e||!b||1>
b)this._rejectDfd(c,"FeatureLayerStatistics.getClassBreaks: invalid input parameters: minValue, maxValue or numClasses.");else{var f=[],g,h=(e-d)/b;for(g=0;g<b;g++){var k=d+g*h;f.push({minValue:k,maxValue:k+h})}f[b-1].maxValue=e;c.resolve({infos:f,normalizationTotal:a.normalizationTotal})}return c.promise},_createCBDefn:function(a,b){var c=a.field,d=a.classificationMethod||this.classificationMethod,e=a.normalizationType,f=a.normalizationField,g=new ba;g.classificationField=c;g.breakCount=b;g.classificationMethod=
d;g.standardDeviationInterval="standard-deviation"===d?a.standardDeviationInterval||this.standardDeviationInterval:void 0;g.normalizationType=e;g.normalizationField="field"===e?f:void 0;return g},_resolveCBDfd:function(a,b,c,d){var e=c.infos,f=e[0].minValue,g=e[e.length-1].maxValue,h="standard-deviation"===b.classificationMethod,k=this._reNumber,l,m,n;e=r.map(e,function(p){n=p.label;m={minValue:p.minValue,maxValue:p.maxValue,label:n};h&&n&&(l=n.match(k),l=r.map(l,function(q){return+x.trim(q)}),2===
l.length?(m.minStdDev=l[0],m.maxStdDev=l[1],0>l[0]&&0<l[1]&&(m.hasAvg=!0)):1===l.length&&(-1<n.indexOf("\x3c")?(m.minStdDev=null,m.maxStdDev=l[0]):-1<n.indexOf("\x3e")&&(m.minStdDev=l[0],m.maxStdDev=null)));return m});b=!1!==b.analyzeData?null!=b.hasAllFeatures?!b.hasAllFeatures:!this._isCollection()&&d===this._srcMemory:!1;a.resolve({minValue:f,maxValue:g,classBreakInfos:e,normalizationTotal:c.normalizationTotal,source:d,partialData:b})},_reHostedFS:/(https?:)?\/\/services.*\.arcgis\.com/i,_noDominantCategoryField:"no_dominant_category",
_predominantCategories:function(a){var b=a.dfd,c=a.params.fields,d=this;if(this._canUseExpression()){a=this._predominantCategoryArcade(c);var e=this._predominantCategoryNameSQL(c);(this._isCollection()?this._uvFromMemory({valueExpression:a}):this._uvFromStatisticsQuery({sqlExpression:e.expression,valueExpression:a})).then(function(f){var g=d._isCollection()?d._srcMemory:d._srcQuery;d._resolvePredominantCategories(b,c,f,g)}).otherwise(function(f){d._rejectDfd(b,"FeatureLayerStatistics.getPredominantCategories: error when counting features in each predominant category.")})}else this._rejectDfd(b,
"FeatureLayerStatistics.getPredominantCategories: make sure the layer supports advanced SQL expressions and standardized queries.")},_resolvePredominantCategories:function(a,b,c,d){var e=[],f=c.count;for(h in f)c=f[h],e.push({value:c.data,count:c.count});var g=r.map(e,function(k){return k.value});var h=r.filter(b,function(k){return-1===r.indexOf(g,k)});r.forEach(h,function(k){e.push({value:k,count:0})});e.sort(this._predominantFieldSorter(b));r.forEach(e,function(k){k.value===this._noDominantCategoryField&&
(k.value=null)},this);a.resolve({predominantCategoryInfos:e,source:d})},_predominantCategoryNameSQL:function(a){return{expression:this._calcMaxFieldSQL(a,{returnFieldName:!0,defaultValue:"'"+this._noDominantCategoryField+"'"})}},_calcMaxFieldSQL:function(a,b){var c=[];if(b){var d=b.resultValue;var e=b.returnFieldName;var f=b.defaultValue;var g=b.integerFields}e&&f&&(b=r.map(a,function(h){return h+" \x3c\x3d 0"}),c.push("WHEN "+b.join(" AND ")+" THEN "+f));r.forEach(a,function(h){var k=[];r.forEach(a,
function(l){h!==l&&k.push(h+" \x3e "+l)});c.push("WHEN "+k.join(" AND ")+" THEN "+(d||e&&"'"+h+"'"||(-1<r.indexOf(g,h)?"cast("+h+" as float)":h)))});return["CASE",c.join(" "),"ELSE "+(f||"0"),"END"].join(" ")},_predominantFieldSorter:function(a){return function(b,c){b=r.indexOf(a,b.value);c=r.indexOf(a,c.value);return b-c}},_predominanceExpressions:function(a){var b=a.params.fields,c=r.map(r.filter(this.layer.fields,function(e){return-1<r.indexOf(this._integerTypes,e.type)},this),function(e){return e.name}),
d=this._sumOfFieldsSQL(b);c=this._strengthOfPredominanceSQL(b,c);a.dfd.resolve({predominantCategory:{valueExpression:this._predominantCategoryArcade(b)},size:{valueExpression:this._sumOfFieldsArcade(b),statisticsQuery:d,histogramQuery:d},opacity:{valueExpression:this._strengthOfPredominanceArcade(b),statisticsQuery:c,histogramQuery:c}})},_calcMaxFieldInfo:function(a,b){a=r.map(a,function(c){return'"'+c+'"'});a=["var fieldNames \x3d [ "+a.join(", ")+" ];","var numFields \x3d "+a.length+";","var maxValueField \x3d null;",
"var maxValue \x3d -Infinity;","var value, i, totalValue \x3d null;","for(i \x3d 0; i \x3c numFields; i++) {","value \x3d $feature[fieldNames[i]];","if(value \x3e 0) {","if(value \x3e maxValue) {","maxValue \x3d value;","maxValueField \x3d fieldNames[i];","}","else if (value \x3d\x3d maxValue) {","maxValueField \x3d null;","}","}"];b&&a.push("if(value !\x3d null \x26\x26 value \x3e\x3d 0) {","if (totalValue \x3d\x3d null) { totalValue \x3d 0; }","totalValue \x3d totalValue + value;","}");a.push("}");
return a},_declareFieldNames:function(a){var b=[];b=r.map(a,function(c){return'$feature["'+c+'"];'});return b.length?b.join("\n")+"\n":""},_predominantCategoryArcade:function(a){var b=this._calcMaxFieldInfo(a);b.push("return maxValueField;");return this._declareFieldNames(a)+b.join("\n")},_sumOfFieldsArcade:function(a){var b=this._declareFieldNames(a);a=r.map(a,function(c){return'"'+c+'"'});a=["var fieldNames \x3d [ "+a.join(", ")+" ];","var numFields \x3d "+a.length+";","var value, i, totalValue \x3d null;",
"for(i \x3d 0; i \x3c numFields; i++) {","value \x3d $feature[fieldNames[i]];","if(value !\x3d null \x26\x26 value \x3e\x3d 0) {","if (totalValue \x3d\x3d null) { totalValue \x3d 0; }","totalValue \x3d totalValue + value;","}","}","return totalValue;"];return b+a.join("\n")},_strengthOfPredominanceArcade:function(a){var b=this._calcMaxFieldInfo(a,!0);b.push("var strength \x3d null;","if (maxValueField !\x3d null \x26\x26 totalValue \x3e 0) {","strength \x3d (maxValue / totalValue) * 100;","}","return strength;");
return this._declareFieldNames(a)+b.join("\n")},_calcSumOfFieldsSQL:function(a){return a.join(" + ")},_ensurePositiveFields:function(a){return"("+r.map(a,function(b){return b+" \x3e\x3d 0"}).join(" OR ")+")"},_sumOfFieldsSQL:function(a){return{sqlExpression:"("+this._calcSumOfFieldsSQL(a)+")",sqlWhere:this._ensurePositiveFields(a)}},_strengthOfPredominanceSQL:function(a,b){return{sqlExpression:"((("+this._calcMaxFieldSQL(a,{integerFields:b})+") / ("+this._calcSumOfFieldsSQL(a)+")) * 100)",sqlWhere:this._ensurePositiveFields(a)+
" AND (("+this._calcSumOfFieldsSQL(a)+") \x3e 0)"}},_calcBinsSQL:function(a,b){var c=[],d=b.length;r.forEach(b,function(e,f){c.push("WHEN ("+[a+" \x3e\x3d "+e[0],a+(f===d-1?" \x3c\x3d ":" \x3c ")+e[1]].join(" AND ")+") THEN "+(f+1))});return["CASE",c.join(" "),"ELSE 0 END"].join(" ")},_ageStatistics:function(a){var b=a.params.units,c=this;this.getAgeExpressions({startTime:a.params.startTime,endTime:a.params.endTime,units:b}).then(function(d){var e={valueExpression:d.valueExpression};x.mixin(e,d.statisticsQuery);
c.getFieldStatistics(e).then(function(f){a.dfd.resolve({units:b,statistics:f})}).otherwise(function(f){c._rejectDfd(a.dfd,"FeatureLayerStatistics.getAgeStatistics: unable to calculate statistics.")})}).otherwise(function(d){c._rejectDfd(a.dfd,"FeatureLayerStatistics.getAgeStatistics: unable to generate expressions to calculate age.")})},_supportedAgeUnits:"years months days hours minutes seconds".split(" "),_unitValueInDays:{years:365,months:30,days:1,hours:1/24,minutes:1/1440,seconds:1/86400,milliseconds:1/
864E5},_suggestedAgeUnits:function(a){var b=a.params.startTime,c=a.params.endTime,d=this;this._rejectIfInvalidDates(a.dfd,b,c,"getSuggestedAgeUnits")||this.getAgeStatistics({startTime:b,endTime:c,units:"days"}).then(function(e){e=e.statistics;null!=e.avg?a.dfd.resolve({units:d._calcSuggestedAgeUnits(e),statistics:e}):d._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedAgeUnits: 'avg' statistic is not available.")}).otherwise(function(e){d._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedAgeUnits: unable to calculate statistics.")})},
_calcSuggestedAgeUnits:function(a){var b,c=this._unitValueInDays,d=Math.abs(a.avg);r.some(this._supportedAgeUnits,function(e){d>2*c[e]&&(b=e);return!!b});return b},_ageExpressions:function(a){var b=a.params.startTime,c=a.params.endTime,d=a.params.units||"days";if(!this._rejectIfInvalidDates(a.dfd,b,c,"getAgeExpressions"))if(-1===r.indexOf(this._supportedAgeUnits,d))this._rejectDfd(a.dfd,"FeatureLayerStatistics.getAgeExpressions: invalid 'units'. Supported units are: years, months, days, hours, minutes, seconds.");
else{var e=this._getDateDiffSQL(b,c,d);a.dfd.resolve({valueExpression:this._getDateDiffArcade(b,c,d),statisticsQuery:e,histogramQuery:e})}},_getDateDiffArcade:function(a,b,c){var d=this._getDateType(a),e=this._getDateType(b);c=[this._readDateValueArcade(a,d,"startTime"),this._readDateValueArcade(b,e,"endTime"),"var retVal \x3d null;","if (startTime !\x3d null \x26\x26 endTime !\x3d null) {","startTime \x3d Date(startTime);","endTime \x3d Date(endTime);","retVal \x3d DateDiff(endTime, startTime, '"+
c+"');","}","return retVal;"];var f=[];"field"===d&&f.push(a);"field"===e&&f.push(b);return this._declareFieldNames(f)+c.join("\n")},_readDateValueArcade:function(a,b,c){a="number"===b?a:"date"===b?a.getTime():'$feature["'+a+'"]';return"var "+c+" \x3d "+a+";"},_getDateDiffSQL:function(a,b,c){a="("+this._getDateValueSQL(b,this._getDateType(b))+" - "+this._getDateValueSQL(a,this._getDateType(a))+")";c=this._unitValueInDays[c];b="/";1>c&&(c=1/c,b="*");return{sqlExpression:1===c?a:"("+a+" "+b+" "+c+")",
sqlWhere:null}},_getDateValueSQL:function(a,b){if("date"===b||"number"===b)"number"===b&&(a=new Date(a)),a="TIMESTAMP'"+a.getUTCFullYear()+"-"+this._padZeros(a.getUTCMonth()+1)+"-"+this._padZeros(a.getUTCDate())+" "+this._padZeros(a.getUTCHours())+":"+this._padZeros(a.getUTCMinutes())+":"+this._padZeros(a.getUTCSeconds())+"'";return a},_padZeros:function(a){return V.pad(a,2,"0")},_getDateType:function(a){if(a instanceof Date)var b="date";else if("number"===typeof a)b="number";else if("string"===typeof a){var c=
this.layer.getField(a);"\x3cnow\x3e"===a.toLowerCase()?b="":c&&c.type===this._dateType&&(b="field")}return b},_rejectIfInvalidDates:function(a,b,c,d){var e=[],f=!1,g=r.every([b,c],function(l){(l=this._getDateType(l))&&e.push(l);return!!l},this),h="FeatureLayerStatistics."+d+": invalid combination of 'startTime' and 'endTime' parameters.",k=["date","number"];g?e[0]===e[1]?"field"===e[0]?b===c&&(this._rejectDfd(a,"FeatureLayerStatistics."+d+": 'startTime' and 'endTime' parameters cannot be identical."),
f=!0):(this._rejectDfd(a,h),f=!0):-1<r.indexOf(k,e[0])&&-1<r.indexOf(k,e[1])&&(this._rejectDfd(a,h),f=!0):(this._rejectDfd(a,"FeatureLayerStatistics."+d+": 'startTime' and 'endTime' parameters must be one of these values: a date object, unix epoch time, name of a valid date field or \x26lt;now\x26gt;."),f=!0);return f},_fetchFeatures:function(a,b){var c=a.params,d=c.valueExpression&&(!c.sqlExpression||!this._canUseSQL92Expression()),e=this;d=c.features||this._isCollection()||!d?null:this._fetchMaxFeaturesForStats();
z(d).always(function(f){if(f){var g=f.features;var h=f.hasAllFeatures}g&&(a.params=x.mixin({},c),a.params.features=g,a.params.hasAllFeatures=h);b.call(e,a)})},_rejectDfd:function(a,b){a.reject(Error(b))},_rejectNonNumeric:function(a,b,c){if(!b){this._rejectDfd(a,"FeatureLayerStatistics."+c+": unknown 'field'.");var d=!0}else if(b.name===this.layer.objectIdField||-1===r.indexOf(this._numericTypes,b.type))this._rejectDfd(a,"FeatureLayerStatistics."+c+": 'field' should be numeric."),d=!0;return d},_rejectIfInvalidType:function(a,
b,c,d){if(!b){this._rejectDfd(a,"FeatureLayerStatistics."+c+": unknown 'field'.");var e=!0}else if(b.name===this.layer.objectIdField||-1===r.indexOf(d,b.type))this._rejectDfd(a,"FeatureLayerStatistics."+c+": 'field' should be one of these types: "+d.join(",")),e=!0;return e},_canUseExpression:function(){return this._isCollection()||this._canUseSQL92Expression()},_canUseSQL92Expression:function(){return this._reHostedFS.test(this.layer.url)},_getExpressionInfo:function(a){var b=this.layer,c=r.map(b.fields,
function(f){return f.name}),d=C.extractFieldNames(a,c),e=[];r.forEach(d,function(f,g){var h=b.getField(f);h?d[g]=h.name:e.push(f)});return{fields:d,unknownFields:e}},_rejectIfInvalidExpression:function(a,b,c){b=b.unknownFields;if(b&&b.length){this._rejectDfd(a,"FeatureLayerStatistics."+c+": valueExpression has unknown field names: "+b.join(", "));var d=!0}return d},_getAttributeVal:function(a,b){var c;b=b.toLowerCase();if(a)for(c in a)if(c.toLowerCase()===b){var d=a[c];break}return d},_getCustomExprVal:function(a,
b){var c;b=b.toLowerCase();if(a)for(c in a)if(c.toLowerCase()!==b){var d=a[c];break}return d},_callAfterLoad:function(a,b,c){if(this._loaded)a.call(this,b,c);else L.once(this,"_load",x.hitch(this,a,b,c))},_numericTypes:["esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"],_integerTypes:["esriFieldTypeInteger","esriFieldTypeSmallInteger"],_dateType:"esriFieldTypeDate",_createGRTask:function(){this._grTask=new Z(this.layer,{source:this.layer.source,gdbVersion:this.layer.gdbVersion});
this._loaded=!0;this.emit("_load")}});x.mixin(D,{add:function(a,b){a.statisticsPlugin||(b=b||{},b.layer=a,a.statisticsPlugin=new D(b))},remove:function(a){a.statisticsPlugin&&(a.statisticsPlugin.destroy(),delete a.statisticsPlugin)}});T("extend-esri")&&x.setObject("plugins.FeatureLayerStatistics",D,W);return D});