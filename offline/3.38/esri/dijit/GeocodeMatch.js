// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/dijit/GeocodeMatch","require dojo/_base/declare dojo/_base/lang dojo/_base/Deferred dojo/_base/array dojo/dom-construct dojo/dom-style dojo/Evented dojo/on dojo/uacss dijit/_WidgetBase dijit/Menu dijit/MenuItem dgrid/OnDemandGrid dgrid/Selection dgrid/Keyboard dgrid/extensions/DijitRegistry dgrid/extensions/ColumnResizer dgrid/extensions/ColumnHider dojo/store/Memory ../kernel ../graphic ../InfoTemplate ../SpatialReference ../geometry/webMercatorUtils ../geometry/Extent ../geometry/Point ../layers/GraphicsLayer ../symbols/PictureMarkerSymbol ../tasks/locator ../tasks/AddressCandidate dijit/layout/BorderContainer dijit/layout/ContentPane dojo/i18n!../nls/jsapi ./GeocodeMatch/Popup".split(" "),
function(r,u,l,F,m,n,v,t,p,G,H,I,B,J,K,L,M,N,O,w,P,q,Q,V,C,D,R,S,x,y,z,T,E,k,U){t=u([H,t],{loaded:!1,singleLineInput:!0,_mapClickPause:!1,_defaultLocatorURL:"http://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer",_customLocator:!1,_hasCustomPoint:!1,_hasDefaultPoint:!1,constructor:function(a,c){u.safeMixin(this,a);this.map&&(this.geocoder?(this._locator=new y(this.geocoder),this._customLocator=!0):(this._locator=new y(this._defaultLocatorURL),this._customLocator=!1),this._columns=[{label:"",
field:"matched",resizable:!1,formatter:function(b){return b},get:l.hitch(this,function(b){return b.matched?"\x3cimg src\x3d'"+r.toUrl("./GeocodeMatch/images/EsriGreenPinCircle26.png")+"' /\x3e":""})},{label:k.widgets.geocodeMatch.match.columnLabelAddress,field:"address",formatter:function(b){return b},get:l.hitch(this,function(b){var d="";d="object"===typeof b.address?b.Match_Addr?b.Match_Addr:"":b.address;return"DefaultMatch"===b.Addr_type||"Custom"===b.Addr_type?b.matched?k.widgets.geocodeMatch.popup.matchButtonLabel:
d+" ("+k.widgets.geocodeMatch.popup.matchButtonLabel+")":d})},{label:k.widgets.geocodeMatch.match.columnLabelType,field:"Addr_type",formatter:function(b){return b},get:l.hitch(this,function(b){var d=b.Addr_type;return"DefaultMatch"===b.Addr_type||"Custom"===b.Addr_type?"":d=d.replace(/([A-Z])([A-Z])([a-z])|([a-z])([A-Z])/g,"$1$4 $2$3$5")})},{label:k.widgets.geocodeMatch.match.columnLabelScore,field:"score",hidden:!0,formatter:function(b){return b},get:l.hitch(this,function(b){return 0<b.score&&100>=
b.score?b.score:" "})}],this.suggestionGraphic||(this.suggestionGraphic=new x(r.toUrl("./GeocodeMatch/images/EsriBluePinCircle26.png"),26,26),this.suggestionGraphic.setOffset(0,12)),this.matchGraphic||(this.matchGraphic=new x(r.toUrl("./GeocodeMatch/images/EsriGreenPinCircle26.png"),26,26),this.matchGraphic.setOffset(0,12)),this.highlightGraphic||(this.highlightGraphic=new x(r.toUrl("./GeocodeMatch/images/EsriYellowPinCircle26.png"),26,26),this.highlightGraphic.setOffset(0,12)))},postCreate:function(){this.inherited(arguments);
var a=this.map,c,b;var d=this.graphicsLayer=new S;var h=this._infoTemplate=new Q;h.setTitle(null);h.setContent(l.hitch(this,this._getInfoTemplateContent));d.setInfoTemplate(h);a.addLayer(d);this._createContainerNodes();this._createGridMenu();h=u([J,M,K,L,N,O]);this.store=new w({data:"",idProperty:k.widgets.geocodeMatch.idProperty});var e=this.grid=new h({store:this.store,sort:"sort",noDataMessage:k.widgets.geocodeMatch.match.noDataMsg,selectionMode:"extended",allowSelectAll:!0,cellNavigation:!1,columns:this._columns},
this._gridRef);this.resize();this._listenerHandles=[p(window,"resize",l.hitch(this,function(){this.resize()})),p(e,"dgrid-deselect",l.hitch(this,function(){this.currentSelectedRow=this.currentSelectedRowId=null})),p(e,"dgrid-select",l.hitch(this,function(f){m.forEach(d.graphics,l.hitch(this,function(g){g.attributes&&g.attributes.type===k.widgets.geocodeMatch.customLabel&&!1===g.attributes.matched&&(d.remove(g),a.infoWindow.hide())}));c=f.rows[0].data.location;this.currentSelectedRowId=f.rows[0].data.id;
this.currentSelectedRow=f.rows[0].data;a.centerAt(c).then(l.hitch(this,function(){a.infoWindow.setFeatures([d.graphics[this.currentSelectedRowId]]);a.infoWindow.show(c)}))})),p(a,"click",l.hitch(this,function(f){this._mapClickPause||(m.forEach(d.graphics,l.hitch(this,function(g){g.attributes&&g.attributes.type===k.widgets.geocodeMatch.customLabel&&!1===g.attributes.matched&&(d.remove(g),a.infoWindow&&a.infoWindow.hide())})),f.graphic?f.graphic.attributes&&f.graphic.attributes.id&&(e.clearSelection(),
e.select(f.graphic.attributes.id)):this.lastAddress&&(e.clearSelection(),c=new R(f.mapPoint.x,f.mapPoint.y,a.spatialReference),b=new q(c,this.highlightGraphic),b.setAttributes({type:k.widgets.geocodeMatch.customLabel,matched:!1,featureType:this.featureType}),d.add(b),a.infoWindow.setFeatures([b]),a.infoWindow.show(c)))}))];this.resize()},startup:function(){this.inherited(arguments);this.grid.startup();this.resize();this.map.loaded?(this.loaded=!0,this.emit("load",{})):p(this.map,"load",l.hitch(this,
function(){this.loaded=!0;this.emit("load",{})}))},updateLocatorURL:function(a){this._locator=new y(a)},geocodeAddress:function(a){this._resetMapState();this._resetAppState();var c,b=this.grid,d=new F;switch(typeof a){case "string":var h=a;var e={address:{SingleLine:h},outFields:["*"]};this.singleLineInput=!0;break;case "object":if(a.id&&(this.featureID=a.id),a.featureType&&(this.featureType=a.featureType),a.address)switch(typeof a.address){case "string":h=a.address;e={address:{SingleLine:h},outFields:["*"]};
this.singleLineInput=!0;break;case "object":Object.keys||(Object.keys=function(f){var g=[],A;for(A in f)f.hasOwnProperty(A)&&g.push(A);return g}),a.address.CountryCode&&a.address.Address&&2===Object.keys(a.address).length?(h=a.address.Address,e={address:{SingleLine:a.address.Address,CountryCode:a.address.CountryCode},outFields:["*"]},this.singleLineInput=!0):a.address.CountryCode&&2===Object.keys(a.address).length?(h=a.address,e={address:{SingleLine:a.address,CountryCode:a.address.CountryCode},outFields:["*"]},
this.singleLineInput=!0):(h=a.address,e={address:h,outFields:["*"]},this.singleLineInput=!1)}}a.sourceCountry&&(e.address.CountryCode=a.sourceCountry);b.noDataMessage=k.widgets.geocodeMatch.popup.loadingPH;b.refresh();this._locator.outSpatialReference=this.map.spatialReference;this._locator.addressToLocations(e).then(l.hitch(this,function(f){var g;for(g=0;g<f.length;g++)f[g].id=g,f[g].featureID=this.featureID,f[g].matched=!1,f[g].sort=g+2,f[g].Addr_type=f[g].attributes.Addr_type,f[g].Match_addr=f[g].attributes.Match_addr,
f[g].featureType=a.featureType;a.location?(!1===a.reviewed&&(this.currentMatchId=g=f.length,this._hasDefaultPoint=!0,this.defaultGeometry=a.location,this.defaultGeometry.spatialReference.wkid!==this.map.spatialReference.wkid&&(this.defaultGeometry=C.geographicToWebMercator(this.defaultGeometry)),c=new z({id:g,address:h,Addr_type:k.widgets.geocodeMatch.match.defaultMatchType,location:this.defaultGeometry,featureID:this.featureID,featureType:a.featureType,matched:!0,score:-1,sort:0}),f.push(c)),!0===
a.reviewed&&(this.currentMatchId=g=f.length,this._hasCustomPoint=!0,this.defaultGeometry=a.location,this.defaultGeometry.spatialReference.wkid!==this.map.spatialReference.wkid&&(this.defaultGeometry=C.geographicToWebMercator(this.defaultGeometry)),c=new z({id:g,address:h,Addr_type:k.widgets.geocodeMatch.customLabel,location:this.defaultGeometry,featureID:this.featureID,featureType:a.featureType,matched:!0,score:-1,sort:0}),f.push(c))):this.defaultGeometry=null;this.store=new w({data:f});b.set("store",
this.store);this._updateMapGraphics();this.lastGeocodeResults=f;this.lastAddress=h;d.resolve(f);b.noDataMessage=k.widgets.geocodeMatch.match.noDataMsg;b.refresh()}),function(f){});return d.promise},pauseMapEvents:function(){this._mapClickPause=!0},resumeMapEvents:function(){this._mapClickPause=!1},refresh:function(){this.grid.refresh();this.matchWidgetBorderContainer.refresh();this.matchWidgetContentPane1.refresh();this.matchWidgetContentPane2.refresh()},resize:function(){this.matchWidgetBorderContainer.resize();
this.matchWidgetContentPane1.resize();this.matchWidgetContentPane2.resize();this.grid&&this.grid.resize()},destroy:function(){m.forEach(this._listenerHandles,function(a){a.remove()});this._popup&&(this._popup.destroy(),this._popup=null);this.grid&&this.grid.destroy();this.store=this._columns=this.grid=null;this._gridMenuRef&&n.empty(this._gridMenuRef);this.gridMenu=null;this.map&&(this.map.infoWindow.clearFeatures(),this.map.infoWindow.hide(),this.map.removeLayer(this.graphicsLayer));this.map=this.graphicsLayer=
this._infoTemplate=this._locator=null;this.inherited(arguments)},reset:function(){this._resetAppState();this._resetMapState()},_matchCustomFeature:function(a){!0===this._hasCustomPoint&&(m.forEach(this.store.data,l.hitch(this,function(d){d.Addr_type===k.widgets.geocodeMatch.customLabel&&this.store.data.splice(m.indexOf(this.store.data,d),1)})),m.forEach(this.graphicsLayer.graphics,l.hitch(this,function(d){d.attributes&&d.attributes.type===k.widgets.geocodeMatch.customLabel&&(d.attributes.matched=
!1)})),this.graphicsLayer.remove(this.graphicsLayer.graphics[this.currentMatchId]),this.currentMatchId=null);var c=this.store.data.length;var b=new z({id:c,Addr_type:k.widgets.geocodeMatch.customLabel,address:this.lastAddress,matched:!1,location:a.geometry,score:-1,sort:1,graphicSymbol:a.symbol,attributes:a.attributes.reverseGeocodeResults});a.attributes.id=c;a.attributes.matched=!0;this.store.data.push(b);this._hasCustomPoint=!0;this._matchFeature(c)},_matchFeature:function(a){var c=this.store.data,
b=this.graphicsLayer.graphics,d=this.currentMatchId,h=b[d];d=c[d];b=b[a];var e=c[a];d?(e.matched=!0,d.matched=!1,h.attributes.matched=!1,h.setSymbol(this.suggestionGraphic),b.attributes.matched=!0,b.attributes.id=a,b.setSymbol(this.matchGraphic),b.getDojoShape().moveToFront(),h.attributes.type===k.widgets.geocodeMatch.customLabel&&b.attributes.type!==k.widgets.geocodeMatch.customLabel&&(this.graphicsLayer.remove(h),c.splice(m.indexOf(c,d),1),this._hasCustomPoint=!1)):(e.matched=!0,!1!==this.map&&
(b.attributes.matched=!0,b.attributes.id=a,b.setSymbol(this.matchGraphic),b.getDojoShape().moveToFront()));this.currentMatchId=a;this.emit("match",{id:a,featureID:this.featureID,address:this.lastAddress,oldLocation:this.defaultGeometry,featureType:this.featureType,newLocation:e.location,graphicSymbol:this.matchGraphic,locatorAttributes:e.attributes});this.grid.refresh()},_updateMapGraphics:function(){var a=this.store.data,c=this.suggestionGraphic,b,d=[];this.graphicsLayer.clear();if(1===a.length){var h=
!0===a[0].matched?new q(a[0].location,this.matchGraphic):new q(a[0].location,c);h.setAttributes({id:0,matched:a[0].matched,type:a[0].Addr_type});d.push(h)}else 1<a.length&&m.forEach(a,l.hitch(this,function(e){h=!0===e.matched?new q(e.location,this.matchGraphic):new q(e.location,c);h.setAttributes({id:e.id,matched:e.matched,type:e.Addr_type});d.push(h)}));0!==a.length&&(a=this._calcGraphicsExtent(d),this.map.setExtent(a,!0).then(l.hitch(this,function(){for(b=0;b<d.length;b++)this.graphicsLayer.add(d[b])})));
m.forEach(this.graphicsLayer.graphics,l.hitch(this,function(e){e.attributes&&!0===e.attributes.matched&&e.getDojoShape().moveToFront()}))},_getInfoTemplateContent:function(a){var c=this.store.data[a.attributes.id];this._popup=new U({address:c?c.address:null,geocodeMatch:this,graphic:a,layer:this.graphicsLayer,map:this.map},n.create("div"));return this._popup.domNode},_createContainerNodes:function(){v.set(this.domNode,"position","relative");v.set(this.domNode,"height","100%");v.set(this.domNode,"width",
"100%");var a=this.matchWidgetBorderContainer=new T({class:"esriMatchContainer",style:"height: 100%; width: 100%;",gutters:!1});var c=this.matchWidgetContentPane1=new E({region:"top",style:"width: 100%; height: 30px;",class:"esriMatchHeader"});var b=this.matchWidgetContentPane2=new E({region:"center",style:"width: 100%; height: 100%;"});this._gridMenuLeftSpanRef=n.create("span",{class:"esriMatchTitle",innerHTML:k.widgets.geocodeMatch.gridTitle},c.domNode);this._gridMenuRightRef=n.create("div",{class:"esriMatchOptions"},
c.domNode);this._gridMenuRightSpanRef=n.create("span",{innerHTML:k.widgets.geocodeMatch.match.tableOptionsLabel},this._gridMenuRightRef);this._gridMenuRightArrowRef=n.create("div",{class:"esriSpriteArrow"},this._gridMenuRightRef);this._gridRef=n.create("div",{},b.domNode);a.addChild(c);a.addChild(b);a.placeAt(this.domNode);a.startup();this.resize()},_createGridMenu:function(){this.gridMenu=new I({targetNodeIds:[this._gridMenuRightRef],leftClickToOpen:"true"});this.gridMenu.addChild(new B({label:k.widgets.geocodeMatch.match.mapAllCandidatesLabel,
onClick:l.hitch(this,function(){this._resetMapState();this._updateMapGraphics()})}));this.gridMenu.addChild(new B({label:k.widgets.geocodeMatch.match.defaultSortOrderLabel,onClick:l.hitch(this,function(){this.grid.set("sort","sort")})}));this.gridMenu.startup()},_formatGeocodeResults:function(a){var c="",b;if("object"===typeof a){for(b in a)a.hasOwnProperty(b)&&(c+=a[b]+" ");a=c}else a=a.address&&"string"===typeof a.address?a.address:a;return a},_resetMapState:function(){this._popup&&(this._popup.map.infoWindow.hide(),
this._popup.map.infoWindow.clearFeatures());this.grid.clearSelection();this.graphicsLayer.clear()},_resetAppState:function(){this.currentSelectedRow=this.lastGeocodeResults=this.lastAddress=this.currentMatchId=null;this.store.data=null;this.store=new w({data:""});this.defaultGeometry=null;this._hasDefaultPoint=this._hasCustomPoint=!1;this.grid.noDataMessage=k.widgets.geocodeMatch.match.noDataMsg;this.grid.refresh()},_calcGraphicsExtent:function(a){var c=a[0].geometry,b=c.getExtent(),d,h=a.length;
null===b&&(b=new D(c.x,c.y,c.x,c.y,c.spatialReference));for(d=1;d<h;d++){c=a[d].geometry;var e=c.getExtent();null===e&&(e=new D(c.x,c.y,c.x,c.y,c.spatialReference));b=b.union(e)}return b}});G("extend-esri")&&l.setObject("dijit.GeocodeMatch",t,P);return t});