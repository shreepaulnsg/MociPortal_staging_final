// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/dijit/RasterFunctionEditor/utils","dojo/_base/lang dojo/_base/url dojo/has dojo/on dojo/Deferred dojo/_base/array ../../kernel ../../request ../../lang ../../config ../../layers/ArcGISImageServiceLayer ../../layers/ImageServiceParameters ../../layers/MosaicRule ../../layers/RasterFunction ../../tasks/Geoprocessor ../../tasks/JobInfo ../../renderers/colorUtils ../../renderers/colorRampUtils".split(" "),function(k,E,F,r,G,p,w,x,y,z,H,I,J,K,L,M,t,A){function B(a){if(a){var b=p.map([a.FromColor,
a.ToColor],function(c){c=t.toRGB({h:c.Hue,s:c.Saturation,v:c.Value});return[c.r,c.g,c.b]});return{fromColor:b[0],toColor:b[1],type:"algorithmic",algorithm:a.Algorithm}}}function C(a){if(a)return a=t.toHSV(t.getDojoColor(a)),{type:"HsvColor",Hue:a.h,Saturation:a.s,Value:a.v,AlphaValue:255}}function D(a){if(a){var b=a.toJson?a.toJson():void 0;return{Algorithm:b&&b.Algorithm||"esriHSVAlgorithm",type:"AlgorithmicColorRamp",FromColor:C(a.fromColor),ToColor:C(a.toColor)}}}var u={},l,m,n;k.mixin(u,{fetchRFT:function(a,
b,c,e,h){var f=new G;var d=(d=(d=a.name)&&d.slice(-8))&&".rft.xml"===d.toLowerCase();return a&&a.itemDataUrl?d?h?this.convertRFT({url:h+"/ConvertRasterFunctionTemplate",rft:{itemId:a.id},format:"json"},b,e,c):(c("errorUtilitiesServiceNotAvailable"),f.reject(Error("errorUtilitiesServiceNotAvailable")),f.promise):x({url:a.itemDataUrl,callbackParamName:"callback",content:{f:"json"},handleAs:"json",load:b,error:c}).then(e):(c("errorRetrievingRFTItem"),f.reject(Error("errorRetrievingRFTItem")),f.promise)},
convertRFT:function(a,b,c,e){var h=a.url,f=function(){n&&(n.remove(),n=null);m&&(m.remove(),m=null)};l||(l=new L(h),r(l,"error",f));m=r(l,"job-complete",function(d){m&&(m.remove(),m=null);d.jobInfo.jobStatus!==M.STATUS_SUCCEEDED?(f(),e(d)):l.getResultData(d.jobInfo.jobId,"outputRasterFunction")});n=r(l,"get-result-data-complete",function(d){n&&(n.remove(),n=null);var g=d&&d.result&&d.result.value;g&&g.url&&(d={url:g.url,handleAs:"json",load:c,error:e},g=(new E(g.url)).authority,-1===z.defaults.io.corsEnabledServers.indexOf(g)&&
z.defaults.io.corsEnabledServers.push(g),x(d))});a={inputRasterFunction:JSON.stringify(a.rft),format:a.format};return l.submitJob(a,b,null,e)},getRasterJsonFromLayer:function(a){if(!a)return null;var b=a.url;b&&0<b.indexOf("?token\x3d")&&(b=b.slice(0,b.indexOf("?token\x3d")));var c=a.credential||b&&w.id.findCredential(b);y.isDefined(c)&&(b=b+"?token\x3d"+c.token,c.referer&&(b+=c.referer));b={url:b,name:a.name};a.renderingRule&&(b.renderingRule=a.renderingRule.toJson?a.renderingRule.toJson():a.renderingRule);
a.mosaicRule&&(b.mosaicRule=a.mosaicRule.toJson?a.mosaicRule.toJson():a.mosaicRule);return b},getLayerIdfromRasterValue:function(a,b){if(a&&b){var c;p.some(b,function(e){if(e&&e.url===a.url&&e.name===a.name&&a.name)return c=e.id,!0});return c}},getColorRampFromArg:function(a){if(a){var b;if(a.type&&-1<a.type.toLowerCase().indexOf("colorramp"))var c=a;else a.value&&-1<a.value.type.toLowerCase().indexOf("colorramp")&&(c=a.value);if(c)return a=c.type.toLowerCase(),"multipartcolorramp"===a?b=A.fromJson({type:"multipart",
colorRamps:p.map(c.ArrayOfColorRamp,function(e){return B(e)})}):"algorithmiccolorramp"===a&&(b=A.fromJson(B(c))),b.id=b.name=c.Name,b}},getRFxArgColorRampValue:function(a){if(a){if(a.fromColor&&a.toColor)return k.mixin(D(a),{Name:a.name});if(a.colorRamps){var b=p.map(a.colorRamps,D);return{type:"MultiPartColorRamp",NumColorRamps:b.length,ArrayOfColorRamp:b,Name:a.name}}}},RFX_VARIABLE_TYPE:"RasterFunctionVariable",RFX_TEMPLATE_TYPE:"RasterFunctionTemplate",ARGUMENT_ARRAY_TYPE:"ArgumentArray",getArgRFT:function(a){if(a){if("RasterFunctionTemplate"===
a.type)return a;if(a.value&&"RasterFunctionTemplate"===a.value.type)return a.value}},getEnumData:function(a,b,c){if(Array.isArray(a))return a.forEach(function(e){e.key=e.key.toString()}),a},getImageServiceTitle:function(a){a=a.split("/");return a[a.length-2]},isReferencedObject:function(a){if(a&&y.isDefined(a._object_ref_id))return!0},functionTypes:{local:"LocalFunction",gpAdapter:"GPAdapterFunction",pythonAdapter:"PythonAdapterFunction"},defaultRasterNodeProps:{name:"Raster",isDataset:!0,isPublic:!1,
type:"RasterFunctionVariable"},getArcGISImageServiceLayerItem:function(a){if(a){a=k.clone(a);a.name||(a.name=this.getImageServiceTitle(a.url));var b=new I;a.mosaicRule&&(b.mosaicRule=new J(a.mosaicRule));a.renderingRule&&(b.renderingRule=new K(a.renderingRule));b=new H(a.url,{id:a.name+(new Date).toString(),imageServiceParameters:b});b.name=a.name;return b}},filterMDInfoIfMosiacRuleIsSet:function(a){var b=k.clone(a.multidimensionalInfo),c=[],e=a.mosaicRule&&a.mosaicRule.multidimensionalDefinition;
if(e&&0<e.length){var h=b.variables.filter(function(f){return e[0].variableName===f.name}.bind(this));if(!h||0===h.length)return b;h=h[0];c=k.clone(h);c.dimensions=[];e.forEach(function(f){var d=h.dimensions.filter(function(N){return f.dimensionName===N.name}.bind(this));if(d&&0!==d.length){var g=(d=d[0])&&d.values,q=0,v=1,O=f.values&&f.values.length;switch(f.values&&f.values[0].length||O){case 1:q=g.indexOf(f.values[0]);v=q+1;break;case 2:q=g.indexOf(f.values[0][0]),v=g.indexOf(f.values[0][1])+1}g=
g.slice(q,v);d.values=g;c.dimensions.push(d)}else c.dimensions=k.clone(h.dimensions)}.bind(this));b.variables=[c]}return b}});F("extend-esri")&&k.setObject("dijit.RasterFunctionEditor.utils",u,w);return u});