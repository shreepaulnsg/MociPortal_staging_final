// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
require({cache:{"url:esri/dijit/FeatureTable/templates/FeatureTable.html":'\x3cdiv\x3e\r\n  \x3cdiv class\x3d"${css.borderContainer}" data-dojo-attach-point\x3d "_gridBorderContainerNode" data-dojo-type\x3d"dijit/layout/BorderContainer" gutters\x3d"false"\x3e\r\n    \x3cdiv class\x3d"${css.contentPane}" data-dojo-attach-point\x3d "_leadingPaneNode" data-dojo-type\x3d"dijit/layout/ContentPane" data-dojo-props\x3d"region: \'leading\'"\x3e\r\n      \x3cdiv class\x3d"${css.grid}" data-dojo-attach-point\x3d"_gridNode"\x3e\x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"${css.contentPane} ${css.hidden}" data-dojo-attach-point\x3d "_centerPaneNode" data-dojo-type\x3d"dijit/layout/ContentPane" data-dojo-props\x3d"region: \'center\'"\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"${css.contentPane} ${css.hidden}" data-dojo-attach-point\x3d "_trailingPaneNode" data-dojo-type\x3d"dijit/layout/ContentPane" data-dojo-props\x3d"region: \'trailing\'"\x3e\r\n    \x3c/div\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e'}});
define("esri/dijit/FeatureTable","../kernel ../lang ./FeatureTable/Grid ./FeatureTable/storeUtils ./FeatureTable/dataUtils dojo/dom-class dojo/dom-construct dojo/dom-style dojo/aspect dojo/debounce dojo/has dojo/on dojo/string dojo/promise/all dojo/Deferred dojo/Evented dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/fx dojo/text!../dijit/FeatureTable/templates/FeatureTable.html dojo/i18n!../nls/jsapi dijit/_WidgetBase dijit/_OnDijitClickMixin dijit/_TemplatedMixin dijit/_WidgetsInTemplateMixin dijit/a11yclick dijit/Menu dijit/MenuItem dgrid/util/misc dijit/layout/BorderContainer dijit/layout/TabContainer dijit/layout/ContentPane dojo/query!css2 dojo/domReady!".split(" "),
function(I,J,C,A,l,D,x,E,F,B,G,v,K,L,w,y,M,g,n,N,O,P,Q,R,S,T,z,U,V,Y,W,Z,H){y=M([Q,R,S,T,y],{declaredClass:"esri.dijit.FeatureTable.Grid",baseClass:"esri-feature-table",templateString:O,featureLayer:null,map:null,fieldInfos:null,gridOptions:null,dateOptions:null,editable:!1,editOn:null,hiddenFields:null,outFields:null,menuFunctions:null,columnMenuFunctions:null,batchCount:50,syncSelection:!1,zoomToSelection:!1,showDataTypes:!1,showGridHeader:!0,showGridMenu:!0,showFeatureCount:!0,showColumnHeaderTooltips:!1,
showColumnHeaderTooltipsWithDescription:!1,showAttachments:!1,showStatistics:!0,showRelatedRecords:!1,showCyclicalRelationships:!1,filterIds:null,showFieldDetails:!1,showColumnHiderButton:!1,showDefaultSortMenuItem:!0,showExpressionFields:!1,loaded:!1,grid:null,layerInfo:null,dataStore:null,columns:null,featureCount:0,idProperty:"id",gridMenu:null,gridMenuAnchor:null,selectedRows:null,selectedRowIds:null,css:{button:"esri-feature-table-button",hidden:"esri-feature-table-hidden",select:"esri-feature-table-select",
borderContainer:"esri-feature-table-border-container",contentPane:"esri-feature-table-content-pane",grid:"esri-feature-table-grid",title:"esri-feature-table-title",loadingIndicator:"esri-feature-table-loading-indicator",cellLoadingIndicator:"esri-feature-table-cell-loading-indicator",menu:"esri-feature-table-menu",menuItem:"esri-feature-table-menu-item",menuOptions:"esri-feature-table-menu-options",columnHeader:"esri-feature-table-column-header",columnHeaderTitle:"esri-feature-table-column-header-title",
columnHeaderType:"esri-feature-table-column-header-type",columnHeaderClear:"esri-feature-table-column-header-clear",columnMenu:"esri-feature-table-column-menu",sortAscendingIcon:"esri-icon-ascending icon-ui-ascending",sortDescendingIcon:"esri-icon-descending icon-ui-descending",filterIcon:"esri-icon-filter icon-ui-filter",propertiesIcon:"esri-icon-properties icon-ui-properties",statisticsIcon:"esri-icon-statistics icon-ui-statistics",settingsIcon:"esri-icon-settings icon-ui-settings",columnHeaderTooltip:"esri-feature-table-column-header-tooltip",
lockedIcon:"esri-icon-locked icon-ui-locked",lockedIconContainer:"esri-locked-icon-container",downIcon:"esri-icon-down icon-ui-down",menuIcon:"esri-icon-menu icon-ui-menu",closeIcon:"esri-icon-close icon-ui-close",optionsMenu:"esri-feature-table-options-menu-container",relatedRecordsCell:"esri-feature-table-related-records-cell",relatedRecordsTitle:"esri-feature-table-related-records-title",relatedRecordsLink:"esri-related-records-link",attachmentsCell:"esri-feature-table-attachments-cell",attachmentsTitle:"esri-feature-table-attachments-title",
attachmentsLink:"esri-attachments-link",expressionsCell:"esri-feature-table-expressions-cell",expressionsTitle:"esri-feature-table-expressions-title",expressionsLink:"esri-expressions-link",dialog:"esri-feature-table-dialog",closeButton:"esri-dialog-close-button dijitButton",statisticsTableContainer:"esri-feature-table-statistics",statisticsHeader:"esri-statistics-header",statisticsBreak:"esri-break",statisticsHorizontalBreak:"esri-horizontal-break",statisticsAttrTable:"esri-attribute-table",statisticsAttrName:"esri-attribute-name",
statisticsAttrValue:"esri-attribute-value",leftMargin:"esri-feature-table-left-margin",dateValue:"esri-date-value"},_i18nStrings:P.widgets.FeatureTable,_layerInfos:null,_fieldInfos:null,_cachedIds:null,_defaultBatchCount:50,_defaultFeatureCount:2E3,_defaultDateOptions:{timeEnabled:!0,dateEnabled:!0,timePattern:null,datePattern:null},_defaultGridOptions:{allowSelectAll:!1,cellNavigation:!0,selectionMode:"extended",pagination:!1,allowTextSelection:!1,pageSizeOptions:[10,25,50],columnHider:!0,columnResizer:!0,
pagingDelay:300,keepScrollPosition:!0,queryRowsOverlap:0,sort:{field:"id",descending:!1}},_defaultSort:null,_defaultEditOn:"dblclick, keypress",_orderByFields:null,_showRelatedRecords:!1,_showAttachments:!1,_rollbackInfos:null,_statisticsDialog:null,_attachmentsDialog:null,_columnRules:null,_relatedGridInfos:null,_popupDateFormats:{shortDate:{datePattern:"M/d/y"},shortDateLE:{datePattern:"d/M/y"},longMonthDayYear:{datePattern:"MMMM d, y"},dayShortMonthYear:{datePattern:"d MMM y"},longDate:{datePattern:"EEEE, MMMM d, y",
selector:"date"},shortDateShortTime:{datePattern:"M/d/y",timePattern:"h:mm a",timeEnabled:!0},shortDateLEShortTime:{datePattern:"d/M/y",timePattern:"h:mm a",timeEnabled:!0},shortDateShortTime24:{datePattern:"M/d/y",timePattern:"H:mm",timeEnabled:!0},shortDateLEShortTime24:{datePattern:"d/M/y",timePattern:"H:mm",timeEnabled:!0},shortDateLongTime:{datePattern:"M/d/y",timePattern:"h:mm:ss a",timeEnabled:!0},shortDateLELongTime:{datePattern:"d/M/y",timePattern:"h:mm:ss a",timeEnabled:!0},shortDateLongTime24:{datePattern:"M/d/y",
timePattern:"H:mm:ss",timeEnabled:!0},shortDateLELongTime24:{datePattern:"d/M/y",timePattern:"H:mm:ss",timeEnabled:!0},longMonthYear:{datePattern:"MMMM y"},shortMonthYear:{datePattern:"MMM y"},year:{datePattern:"y"}},constructor:function(a,b){b&&(this._rowSelectHandler=B(this._rowSelectHandler,0),this._rowDeselectHandler=B(this._rowDeselectHandler,0),this._refreshHandler=B(this._refreshHandler,0))},postMixInProperties:function(){this.inherited(arguments);this.set({columns:[],layerInfo:{},selectedRows:[],
selectedRowIds:[],hiddenFields:this.hiddenFields||[],outFields:this.outFields||["*"],fieldInfos:this.fieldInfos||[],menuFunctions:this.menuFunctions||[],columnMenuFunctions:this.columnMenuFunctions||[],gridOptions:g.mixin({},this._defaultGridOptions,this.gridOptions),dateOptions:g.mixin({},this._defaultDateOptions,this.dateOptions),_fieldInfos:[],_cachedIds:[],_columnRules:{},_relatedGridInfos:[]});G("touch")&&!this.editOn?this.set("editOn",z):this.editOn||this.set("editOn",this._defaultEditOn);this.filterIds&&
0===this.filterIds.length&&(this.filterIds=null);this._noDataMessage=this.gridOptions.noDataMessage||this._i18nStrings.noData},startup:function(){this.inherited(arguments);var a=this.featureLayer;a&&a.loadError?this._showLoadError():this.domNode&&a.loaded?this._setUpDataForMainGrid():this.own(v(a,"load",g.hitch(this,function(){this._setUpDataForMainGrid()})),v(a,"error",g.hitch(this,function(){a.loaded||this._showLoadError()})))},destroy:function(){this.inherited(arguments);this._statisticsDialog&&
this._statisticsDialog.destroy();this._attachmentsDialog&&this._attachmentsDialog.destroy();this._grid&&this._grid._destroyColumns()},refresh:function(a){var b=a||this._grid,c=this._relatedGridInfos,d=c.length,e;b===this._grid&&0<d&&n.forEach(c,function(f,h){(e=c[d-1-h])&&e.grid&&this._removeGrid(e.grid)},this);return this._refreshStore({grid:b}).then(function(){b.refresh()})},resize:function(a){this._gridBorderContainerNode&&this._gridBorderContainerNode.resize();(a=a&&a.resize?a:this._grid)&&a.resize()},
clearSelection:function(a){(a=a||this._grid)&&a.clearSelection()},getRowDataById:function(a,b){if(b=b||this._grid)return b.getRowDataById(a)},filterSelectedRecords:function(a,b){b=(a=b||this._grid)?a.selectedRowIds:[];a&&b&&b.length&&this.filterRecordsByIds(a.selectedRowIds)},filterRecordsByIds:function(a,b){if(b=b||this._grid)this.filterIds=a,b.filterIds=a,a&&0!==a.length||(this.selectedRows=[],this.selectedRowIds=[],b.selectedFeatureCount=0,b.selectedRowIds=[],b.selectedRows=[]),this._refreshStore({grid:b}),
this.emit("filter",{ids:a||[]})},clearFilter:function(a){(a=a||this._grid)&&this.filterRecordsByIds(null,a)},getFeatureDataById:function(a){return a instanceof Array?l.queryLayerForFeature({layer:this.featureLayer,id:a}):l.queryLayerForFeatures({layer:this.featureLayer,ids:a})},selectRows:function(a,b,c){(c=c||this._grid)&&c.selectRows(a,b)},sort:function(a,b,c){c=c||this._grid;if(c&&a){var d=l.getOrderByString(a,b);var e=l.getColumnFromFieldName({fieldName:a,grid:c});this._sortField(c,{field:a,descending:b,
column:e,orderByFields:[d]})}},centerOnSelection:function(a){return(a||this._grid).centerOnSelection()},_setUpMainGrid:function(a,b){var c=new C({map:this.map,layer:a,layerInfo:b,idProperty:b.idProperty,customFieldInfos:this._getCustomFieldInfos(a)||this.fieldInfos,expressionInfos:this._getExpressionInfos(a),defaultSort:this._defaultSort,outFields:this.outFields,hiddenFields:this.hiddenFields,filterIds:this.filterIds,gridOptions:this.gridOptions,dateOptions:this.dateOptions,batchCount:this.batchCount,
editable:this.editable,editOn:this.editOn,css:this.css,showAttachments:this._showAttachments,showRelatedRecords:this._showRelatedRecords,showCyclicalRelationships:this.showCyclicalRelationships,showStatistics:this.showStatistics,showFieldDetails:this.showFieldDetails,showGridHeader:this.showGridHeader,showGridMenu:this.showGridMenu,showFeatureCount:this.showFeatureCount,showDataTypes:this.showDataTypes,showColumnHeaderTooltips:this.showColumnHeaderTooltips,showColumnHeaderTooltipsWithDescription:this.showColumnHeaderTooltipsWithDescription,
showColumnHider:this.showColumnHiderButton,syncSelection:this.syncSelection,menuFunctions:this.menuFunctions,showDefaultSortMenuItem:this.showDefaultSortMenuItem,columnMenuFunctions:this.columnMenuFunctions,showFilterMenuItems:this.showFilterMenuItems,showExpressionFields:this.showExpressionFields},this._gridNode);c.startup();this.set({_grid:c,grid:c.dGrid,gridMenu:c.optionsMenu,gridMenuAnchor:c.optionsMenuAnchor});this._wireUpGridEvents(c);c.showLoadingIndicator();c.updateNoDataMessage("");c.setHeaderTitle(this._i18nStrings.loadingData);
c.resize();this._setUpColumns({grid:c,layer:a});l.queryLayerForCount({layer:a,layerInfo:b}).then(g.hitch(this,function(d){c.set("featureCount",d);c.updateHeaderText();this._generateStore({grid:c,layer:a,layerInfo:b,count:d,filterIds:this.filterIds}).then(g.hitch(this,function(e){d||c.updateNoDataMessage(this._noDataMessage);this.set("dataStore",e);c.updateStore(e);c.hideLoadingIndicator();setTimeout(g.hitch(this,function(){this.resize()},200))})).otherwise(g.hitch(this,function(){this._showLoadError();
c.updateNoDataMessage(this._noDataMessage)}))})).otherwise(g.hitch(this,function(){this._showLoadError();c.updateNoDataMessage(this._noDataMessage)}))},_setUpDataForMainGrid:function(){var a=this.featureLayer,b=this.gridOptions,c=this.outFields;this._generateLayerInfo(a).then(g.hitch(this,function(d){var e=d.idProperty;d.hasRelatedRecords&&(this._showRelatedRecords=!!this.showRelatedRecords);d.hasAttachments&&(this._showAttachments=!!this.showAttachments);var f=b.sort&&b.sort.field?l.findFirst(a.fields,
"name",b.sort.field):null;f=f&&f.name?f.name:e;var h=!(!b.sort||!b.sort.descending),m=l.getOrderByString(f,h);c=n.filter(c,function(p){return!!l.findFirst(a.fields,"name",p)},this);0===c.length&&c.push("*");this.layerInfo=d;this.idProperty=e;this._orderByFields=[m];this._defaultSort={attribute:f,descending:h};this._setUpMainGrid(a,d)}))},_getCustomFieldInfos:function(a){return(a=this._getPopupInfo(a))&&a.fieldInfos?this._updatePopupInfosDateFormat(a.fieldInfos):null},_getExpressionInfos:function(a){return(a=
this._getPopupInfo(a))&&a.expressionInfos?a.expressionInfos:null},_getPopupInfo:function(a){a=a.id||a.layerId||0;return(a=this._layerInfos?this._layerInfos[a]:null)?a.popupInfo:null},_generateLayerInfo:function(a){var b=new w,c=a.id||a.layerId||0,d=a.objectIdField;if(!d){var e=JSON.parse(a._json);e.uniqueIdField&&e.uniqueIdField.name&&(d=e.uniqueIdField.name)}d={idProperty:d,layerId:c,userIds:{}};a.credential&&(d.userIds[c]=a.credential.userId);d.userId&&(d.userIds[c]=d.userId);d.isFeatureCollection=
a._collection&&!0===a._collection||null===a.url&&null===a._url;d.typeIdField=a.typeIdField;d.types=a.types;d.subtypeField=a.subtypeField;d.subtypes=a.subtypes;d.editable=a.isEditable?a.isEditable():!!a.userIsAdmin||!1;d.editCapabilities=a.getEditCapabilities?a.getEditCapabilities():{};d.hasRelatedRecords=a.relationships&&0<a.relationships.length;d.supportsAdvancedQueryRelated=!(!a.advancedQueryCapabilities||!a.advancedQueryCapabilities.supportsAdvancedQueryRelated);d.hasAttachments=a.hasAttachments;
d.queryAttachmentsSupported=!0;d=g.clone(d);b.resolve(d);return b},_setUpColumns:function(a){var b=a.grid;a=a.layer;var c=a.fields,d;var e=(d=a.getOutFields?a.getOutFields():["*"])&&d[0]&&"*"===d[0]?c:n.filter(c,function(h){return-1!==n.indexOf(d,h.name)});b===this._grid&&"*"!==this.outFields[0]&&(e=n.filter(e,g.hitch(this,function(h){return-1!==n.indexOf(this.outFields,h.name)})));J.isDefined(a.objectIdField)&&!l.findFirst(e,"name",a.objectIdField)&&(c=l.findFirst(c,"name",a.objectIdField))&&e.unshift(c);
if(this.showExpressionFields){var f=this._getPopupInfo(a);f&&f.expressionInfos&&(a=this._getCustomFieldInfos(a),n.forEach(a,function(h){var m=l.getExpressionInfo(f.expressionInfos,h.fieldName);m&&e.push({name:h.fieldName,alias:m.title,editable:!1,nullable:!1,type:m.returnType})}))}a=b._setUpColumns(e);b===this._grid&&this.set({columns:a.columns,_fieldInfos:a.fieldInfos})},_showLoadError:function(a){var b=a&&a.grid?a.grid:this._grid;a=a&&a.error?a.error:this._i18nStrings.dataError;b&&(b.hideLoadingIndicator(),
b.setHeaderTitle(a));this.emit("error",{message:a})},_wireUpGridEvents:function(a){a&&(a.on("load",g.hitch(this,function(b){a===this._grid&&this.set("loaded",b.loaded);this.emit("load",b.loaded)})),a.on("error",g.hitch(this,function(b){this._showLoadError();this.emit("error",b)})),a.on("row-select",g.hitch(this,this._rowSelectHandler,a)),a.on("row-deselect",g.hitch(this,this._rowDeselectHandler,a)),a.on("refresh",g.hitch(this,this._refreshHandler,a)),a.on("sort",g.hitch(this,this._sortField,a)),a.on("filter",
g.hitch(this,function(b){this.emit("filter",b)})),a.on("column-resize",g.hitch(this,function(b){this.emit("column-resize",b)})),a.on("column-state-change",g.hitch(this,function(b){this.emit("column-state-change",b)})),a.on("editor-show",g.hitch(this,function(b){this.emit("editor-show",b)})),a.on("editor-hide",g.hitch(this,function(b){this.emit("editor-hide",b)})),a.on("data-change",g.hitch(this,function(b){this.emit("data-change",b)})),a.on("edits-complete",g.hitch(this,function(b){this.emit("edits-complete",
b)})),a.on("layer-click",g.hitch(this,function(b){this.emit("layer-click",b)})),a.on("layer-selection-complete",g.hitch(this,function(b){a===this._grid&&this.syncSelection&&this._syncSelectionFromLayer({grid:a,features:b.features});this.emit("layer-selection-complete",b)})),a.on("layer-selection-clear",g.hitch(this,function(b){a===this._grid&&this.syncSelection&&this.clearSelection();this.emit("layer-selection-clear",b)})),a.on("layer-update-end",g.hitch(this,function(b){this.emit("layer-update-end",
b)})),a.on("layer-refresh-tick",g.hitch(this,function(b){this.refresh()})),a.on("show-selected-records",g.hitch(this,function(b){this.emit("show-selected-records",{grid:a,ids:b.ids});this.filterRecordsByIds(b.ids,a)})),a.on("clear-selection",g.hitch(this,function(){this.emit("clear-selection")})),a.on("clear-filter",g.hitch(this,this.clearFilter,a)),a.on("show-statistics",g.hitch(this,function(b){this._statisticsDialog=b.dialog;this.emit("show-statistics",{dialog:b.dialog,statistics:b.statistics})})),
a.on("show-attachments",g.hitch(this,function(b){this._attachmentsDialog=b.dialog;this.emit("show-attachments",{featureId:b.featureId,dialog:b.dialog,attachments:b.attachments})})),a.on("show-related-records",g.hitch(this,this._showRelatedRecordsCallback,a)),a.on("show-detailed-field-view",g.hitch(this,this._showDetailedFieldViewCallback,a)),a.on("add-attachment-complete",g.hitch(this,function(b){this.emit("add-attachment-complete",b)})),a.on("delete-attachment-complete",g.hitch(this,function(b){this.emit("delete-attachment-complete",
b)})))},_wireUpRelatedGridEvents:function(a){a.grid.own(v(a.parentGrid,"row-select",this._updateRelatedGridsHandler.bind(this,a)))},_updateRelatedGridsHandler:function(a,b){if(b.rows&&b.rows.length&&b.rows[0].data){var c=a.grid,d=a.parentGrid;a=a.relationship;var e=this._relatedGridInfos;b=b.rows[0];var f=e[e.length-1];if(f=f?f.grid:null){var h=c===f,m=parseInt(b.id,10);f=l.findFirst(c.layer.relationships,"id",a.id);var p=l.findFirst(e,"grid",c),r=n.indexOf(e,p),u=d._getRelatedRecordsCount({featureId:m,
relationshipId:a.id});0<u?(h||n.forEach(e,function(k,q){k.grid&&q>=r&&(k.grid.emptyStore(),k.grid.set("featureCount",0),k.grid.updateHeaderText())}),e=a.keyField,"undefined"===typeof b.data[e]&&(e=d.layer.getField(e).name),l.getRelationshipWhereClause({layer:c.layer,originRelationship:a,destinationRelationship:f,keyValue:b.data[e]}).then(g.hitch(this,function(k){c.set({where:k,featureCount:u});c.updateHeaderText();this._refreshStore({grid:c}).then(function(q){h||setTimeout(function(){if(c.store){var t=
c.store.data;if(t=t?t[Object.keys(t)[0]]:null)t=t.attributes[c.idProperty],c.selectRows(t,!1)}},600)})}))):h?(c.emptyStore(),c.set("featureCount",0),c.updateHeaderText(),c.refresh()):(c.set("featureCount",0),c.updateHeaderText(),n.forEach(e,function(k,q){k=k.grid;q<r||(k.emptyStore(),k.set("featureCount",0),k.updateHeaderText(),k.refresh())}))}}},_generateStore:function(a){var b=a.grid,c=a.layer,d=a.layerInfo,e=a.where||null,f=a.orderByFields||null,h=a.count||null,m=a.filterIds||null;(a.store||b.store)&&
b.emptyStore();return d.isFeatureCollection?this._generateStoreForFeatureCollection({grid:b,layer:c,layerInfo:d}):c.advancedQueryCapabilities&&!c.advancedQueryCapabilities.supportsPagination?this._generateStoreForNonPaginatedLayer({grid:b,layer:c,layerInfo:d,where:e,orderByFields:f,count:h,filterIds:m}):this._generateCacheStore({grid:b,where:e,orderByFields:f,count:h,ids:m})},_generateCacheStore:function(a){var b=new w,c=a.grid;var d=a.orderByFields?a.orderByFields:c===this._grid?this._orderByFields&&
this._orderByFields.length?this._orderByFields:[l.getOrderByString(this._defaultSort.attribute,this._defaultSort.descending)]:null;a=A.generateCacheStore({grid:c,layer:c.layer,ids:a.ids,where:a.where,orderByFields:d,count:a.count,getAttachments:this.showAttachments&&c.layerInfo.hasAttachments,getRelatedRecords:this.showRelatedRecords&&c.layerInfo.hasRelatedRecords});F.before(a,"query",function(e,f){c.showLoadingIndicator()});F.after(a,"query",function(e){e.then(function(f){f.attachmentInfos?c._updateAttachmentInfos(f.attachmentInfos):
c.layerInfo.queryAttachmentsSupported=!1;f.relatedRecordInfos&&(c.layerInfo.supportsAdvancedQueryRelated?c._updateRelatedRecordCounts(f.relatedRecordInfos):c._updateRelatedRecordInfos(f.relatedRecordInfos));c.hideLoadingIndicator()}).otherwise(function(){c.hideLoadingIndicator()});return e});b.resolve(a);return b},_generateMemoryStore:function(a){var b=a.grid,c=a.features;a=new w;c=A.generateMemoryStore({features:c,idProperty:this.idProperty});c.query=g.hitch(this,A.generateSort,b.dGrid,c);a.resolve(c);
return a},_generateStoreForFeatureCollection:function(a){return this._generateMemoryStore({grid:a.grid,features:a.layer.graphics})},_generateStoreForNonPaginatedLayer:function(a){var b=a.grid,c=a.layer,d=a.layerInfo,e=a.where||null,f=a.orderByFields||null;return(a=a.filterIds||null)&&a.length?this._generateCacheStore({grid:b,ids:a,where:e,orderByFields:f}):l.queryLayerForIds({layer:c,idProperty:d.idProperty,where:e}).then(g.hitch(this,function(h){d._cachedIds=h;b.layerInfo.cachedIds=h;return this._generateCacheStore({grid:b,
ids:h,where:e,orderByFields:f})})).otherwise(g.hitch(this,function(){this._showLoadError()}))},_refreshStore:function(a){var b=a.grid,c=b.filterIds,d=a.where||b.where||null,e=a.orderByFields,f=b.layer,h=b.layerInfo;b.showLoadingIndicator();b.updateNoDataMessage("");b.setHeaderTitle(this._i18nStrings.loadingData);return l.queryLayerForCount({layer:f,layerInfo:h,where:d}).then(g.hitch(this,function(m){b.set("featureCount",m);b.updateHeaderText();return this._generateStore({grid:b,layer:f,layerInfo:h,
orderByFields:e,where:d,count:m,filterIds:c}).then(g.hitch(this,function(p){b===this._grid&&this.set("dataStore",p);m||b.updateNoDataMessage(this._noDataMessage);b.updateStore(p);b.hideLoadingIndicator();return p}))})).otherwise(g.hitch(this,function(){this._showLoadError();b.updateNoDataMessage(this._noDataMessage);return null}))},_setEditableAttr:function(a){this._grid&&this._grid.set("editable",!!a);n.forEach(this._relatedGridInfos,function(b){b.grid.set("editable",!!a)})},_sortField:function(a,
b){var c=b.column,d=parseInt(b.id,10),e=b.field,f=b.descending;b=b.orderByFields;a===this._grid&&(this._orderByFields=b);a.emptyStore();c?a.updateSort([{attribute:e,columnId:d,fieldType:c.type,descending:f}]):a.updateSort([{attribute:e,descending:f}]);this._refreshStore({grid:a,orderByFields:b}).then(g.hitch(this,function(){this.emit("sort",{field:e,descending:f})}))},_rowSelectHandler:function(a,b){this.syncSelection&&this._syncSelectionFromGrid({grid:a,ids:a.selectedRowIds});a===this._grid&&(this.set({selectedRows:a.selectedRows,
selectedRowIds:a.selectedRowIds}),this.emit("row-select",b))},_rowDeselectHandler:function(a,b){var c=a.selectedRows;this.syncSelection&&(0<c.length?this._syncSelectionFromGrid({grid:a,ids:a.selectedRowIds}):a.layer.clearSelection(!0));a===this._grid&&(this.set({selectedRows:c,selectedRowIds:a.selectedRowIds}),this.emit("row-deselect",b))},_refreshHandler:function(a,b){a===this._grid&&this.emit("refresh",b)},_syncSelectionFromLayer:function(a){var b=a.features||[],c=(a.grid||this._grid).idProperty;
0===b.length?this.clearSelection():(a=n.map(b,function(d){return d.attributes[c]}),l.compareIntArrays(a,this.selectedRowIds)||(this.map&&this.zoomToSelection&&0<b.length&&(b=l.calculateExtentFromFeatures(b),this.map.setExtent(b)),this.selectRows(a,!0)))},_syncSelectionFromGrid:function(a){var b=a.grid||this._grid,c=b.layer,d=a.ids;a=c.getSelectedFeatures();var e=b.idProperty,f;a=n.map(a,function(h){return h.attributes[e]});l.compareIntArrays(d,a)||l.queryLayerForFeatures({grid:b,layer:c,ids:d}).then(g.hitch(this,
function(h){h&&h.features&&(h=h.features,h.length&&(this.map&&this.zoomToSelection&&(f=l.calculateExtentFromFeatures(h),this.map.setExtent(f)),l.selectFeaturesById({grid:b,ids:d})))}))},_showRelatedRecordsCallback:function(a,b){var c=b.columnId,d=b.relationship,e=b.keyFieldValue,f=b.row,h=b.count;b=[];if(a===this._grid){var m=this._centerPaneNode;var p=this._leadingPaneNode}else b=this._relatedGridInfos.length-1,b=this._relatedGridInfos[b],m=b.layout.centerContentPane,p=b.layout.leadingContentPane,
this._removeButtonNode(b.closeButton),b.closeButton=null;this._addSmallRelatedRecordsColumn({grid:a,relationship:d});a.showFieldDetails=!1;a.showFeatureCount=!1;a.updateSelectionMode("single");a.updateHeaderText();a.hideOptionsMenu();b=[this._shrinkGrid({grid:a,centerPane:m,leadingPane:p,columnId:c}),this._setUpDataForRelatedGrid({parentGrid:a,relationship:d})];L(b).then(g.hitch(this,function(r){var u=r[1].layer;r=m;var k;this._addHiddenColumnRules({grid:a,columnId:c});a.refresh();a.selectRows(f[a.idProperty],
!0,!0);this._showPane(r);var q=this._generateSubLayout(r.domNode);this.resize();this._generateLayerInfo(u).then(g.hitch(this,function(t){this.emit("show-related-records",{grid:a,relationship:d,row:f});k=l.findFirst(u.relationships,"id",d.id);l.getRelationshipWhereClause({layer:u,originRelationship:d,destinationRelationship:k,keyValue:e}).then(g.hitch(this,function(X){this._setUpRelatedGrid({parentGrid:a,layer:u,layerInfo:t,relationship:d,where:X,layout:q,count:h})}))}))}))},_setUpDataForRelatedGrid:function(a){var b=
a.relationship.relatedTableId;return this._setUpRelatedLayer({baseLayer:a.parentGrid.layer,layerId:b}).then(function(c){return{layer:c,layerId:b}})},_generateSubLayout:function(a){var b=this.css,c=b.contentPane+" "+b.hidden;var d=new W({className:b.borderContainer+" "+b.leftMargin,gutters:!1,design:"headline"});b=new H({className:b.contentPane,region:"leading"});c=new H({className:c,region:"center"});var e=x.create("div",null,b.domNode);d.addChild(b);d.addChild(c);d.placeAt(a);d.startup();return{borderContainer:d,
leadingContentPane:b,centerContentPane:c,containerNode:e}},_setUpRelatedGrid:function(a){var b=this,c=a.layer,d=a.layerInfo,e=d.idProperty,f=a.parentGrid,h=a.relationship,m=a.layout,p=a.where||null,r=a.count||null;a=n.map(this._relatedGridInfos,function(q){return q.grid.layer.layerId});a.unshift(this._grid.layer.layerId);var u=[{label:this._i18nStrings.close,callback:function(){b._removeGrid(this)}}],k=new C({map:this.map,layer:c,layerInfo:d,idProperty:e,customFieldInfos:this._getCustomFieldInfos(c),
expressionInfos:this._getExpressionInfos(c),defaultSort:{attribute:e,descending:!1},outFields:["*"],where:p,gridOptions:this.gridOptions,dateOptions:this.dateOptions,batchCount:this.batchCount,editable:this.editable,editOn:this.editOn,css:this.css,showAttachments:!(!this.showAttachments||!d.hasAttachments),showRelatedRecords:!0,showCyclicalRelationships:this.showCyclicalRelationships,showStatistics:this.showStatistics,showFieldDetails:!1,showGridHeader:this.showGridHeader,showGridMenu:this.showGridMenu,
showFeatureCount:this.showFeatureCount,showDataTypes:this.showDataTypes,showColumnHeaderTooltips:this.showColumnHeaderTooltips,showColumnHeaderTooltipsWithDescription:this.showColumnHeaderTooltipsWithDescription,showColumnHider:this.showColumnHiderButton,menuFunctions:u,showFilterMenuItems:!1,showDefaultSortMenuItem:this.showDefaultSortMenuItem,syncSelection:!1,showExpressionFields:this.showExpressionFields,visibleLayerIds:a},m.containerNode);k.startup();this._wireUpGridEvents(k);this._wireUpRelatedGridEvents({grid:k,
parentGrid:f,relationship:h});k.showLoadingIndicator();k.updateNoDataMessage("");k.setHeaderTitle(this._i18nStrings.loadingData);k.resize();e=this._generateColumnSwitcherButton(f);a=this._generateGridCloseButton(k);this._relatedGridInfos.push({grid:k,parentGrid:f,layout:m,relationship:h,pickerButton:e,closeButton:a});this._setUpColumns({grid:k,layer:c});if(l.isValueEmpty(r))return l.queryLayerForCount({layer:c,layerInfo:d}).then(g.hitch(this,function(q){k.set("featureCount",q);k.updateHeaderText();
this._generateStore({grid:k,layer:c,layout:m,layerInfo:d,where:p,count:q,filterIds:null}).then(g.hitch(this,function(t){q||k.updateNoDataMessage(this._noDataMessage);k.updateStore(t);k.hideLoadingIndicator()}))})).otherwise(g.hitch(this,function(){this._showLoadError();k.updateNoDataMessage(this._noDataMessage)}));k.set("featureCount",r);k.updateHeaderText();this._generateStore({grid:k,layer:c,layout:m,layerInfo:d,where:p,count:r,filterIds:null}).then(g.hitch(this,function(q){r||k.updateNoDataMessage(this._noDataMessage);
k.updateStore(q);k.hideLoadingIndicator()})).otherwise(g.hitch(this,function(){this._showLoadError();k.updateNoDataMessage(this._noDataMessage)}))},_setUpRelatedLayer:function(a){var b=new w,c=l.initFeatureLayer(a.baseLayer,a.layerId);c.loaded?b.resolve(c):v(c,"load",function(){b.resolve(c)});return b},_showPane:function(a){a&&a.domNode&&D.remove(a.domNode,this.css.hidden)},_hidePane:function(a){a&&a.domNode&&D.add(a.domNode,this.css.hidden)},_shrinkGrid:function(a){var b=new w,c=a.grid,d=a.leadingPane,
e=a.finalWidth||220;a=N.animateProperty({node:d.id,properties:{width:{start:function(){return d.domNode.getBoundingClientRect().width},end:function(){return e}}}}).play();v(a,"End",function(){b.resolve(c)});return b},_growGrid:function(a){a=a.grid;this._removeSmallRelatedRecordsColumn(a);this._removeHiddenColumnRules(a);a.showColumnHider&&a.showColumnHiderButton();if(a===this._grid){var b=this._centerPaneNode;var c=this._leadingPaneNode;a.showFieldDetails=this.showFieldDetails;this.emit("hide-related-records")}else{var d=
this._relatedGridInfos.length-1;d=this._relatedGridInfos[d];b=d.layout.centerContentPane;c=d.layout.leadingContentPane;d.closeButton=this._generateGridCloseButton(a)}this._hidePane(b);c.domNode&&E.set(c.domNode,"width","100%");a.updateSelectionMode(this.gridOptions.selectionMode);a.showFeatureCount=this.showFeatureCount;a.updateHeaderText();this.showGridMenu&&a.showOptionsMenu();a.resize();this.resize()},_removeGrid:function(a){if(a!==this._grid){var b=l.findFirst(this._relatedGridInfos,"grid",a),
c=b.parentGrid,d=b.layout.borderContainer,e=b.layout.leadingContentPane;this._hidePane(b.layout.centerContentPane);e.domNode&&E.set(e.domNode,"width","100%");this._removeButtonNode(b.pickerButton);this._relatedGridInfos.pop();a.destroy();d.destroy();this._growGrid({grid:c})}},_addHiddenColumnRules:function(a){var b=a.grid,c=a.columnId;a=b.getColumns();a=Object.keys(a);var d=[],e;d=n.map(a,function(f,h){e=h===c?"display: table-cell;":"display: none;";return b.styleColumn(f,e)});this._columnRules[b.id]=
d},_removeHiddenColumnRules:function(a){n.forEach(this._columnRules[a.id],function(b){b.remove()});this._columnRules[a.id]=[]},_addSmallRelatedRecordsColumn:function(a){var b=a.grid,c=a.relationship.id,d=b.idProperty;b.columns.push({unhidable:!0,label:"esriRelatedRecordsSmall",field:"esriRelatedRecordsSmall",get:function(e){e=b._getRelatedRecordsCount({featureId:e[d],relationshipId:c});return K.substitute(b._i18nStrings.parenValue,{value:e})}})},_removeSmallRelatedRecordsColumn:function(a){var b=
a.columns;"esriRelatedRecordsSmall"===(b&&b[b.length-1]?b[b.length-1].field:null)&&(b.pop(),a.refresh())},_generateGridCloseButton:function(a){var b=this.css;b=x.create("div",{className:b.menuItem+" "+b.button+" "+b.closeIcon,tabIndex:0});x.place(b,a._menuNode,"before");v(b,z,g.hitch(this,function(){this._removeGrid(a)}));return b},_generateColumnSwitcherButton:function(a){var b=a._gridHeaderNode.domNode,c=this._generateColumnSwitcherMenu(a);a=this.css;var d=this._i18nStrings;var e=x.create("div",
{title:d.columnSelectionMenu,"aria-label":d.columnSelectionMenu,className:a.menuItem+" "+a.button+" "+a.menuIcon,tabIndex:0},b);v(e,[z,"keydown"],g.hitch(this,function(f){var h=e.getBoundingClientRect(),m=h.top+h.height;h=this.isLeftToRight()?h.right-h.width:h.right;c._openMyself({target:f.target,delegatedTarget:e,iframe:null,coords:{x:h,y:m}})}));return e},_generateColumnSwitcherMenu:function(a){var b=a.fieldInfos,c=this.css,d;var e=new U({className:c.optionsMenu});n.forEach(a.columns,function(f){var h=
parseInt(f.id,10),m=l.findFirst(b,"name",f.field);"esriRelatedRecords"===f.type||"esriRelatedRecordsSmall"===f.field||"esriAttachments"===f.type||"esriFieldTypeGUID"===m.type||"esriFieldTypeGlobalID"===m.type||-1!==n.indexOf(a._unsupportedFieldTypes,m.type)||f.hidden||(d=new V({label:f.label||f.field,baseClass:c.menuItem,tabIndex:1}),v(d,z,g.hitch(this,function(){this._removeHiddenColumnRules(a);this._addHiddenColumnRules({grid:a,columnId:h});this.emit("column-focus-change",{fieldInfo:m,column:f})})),
e.addChild(d))},this);e.startup();return e},_removeButtonNode:function(a){a&&a&&a.parentNode&&a.parentNode.removeChild(a)},_showDetailedFieldViewCallback:function(a,b){var c=b.columnId,d=b.fieldInfo;b=this._centerPaneNode;var e=this._leadingPaneNode,f=e.domNode.getBoundingClientRect().width/6,h;a.showFeatureCount=!1;a.showFieldDetails=!1;a.updateHeaderText();a.hideOptionsMenu();this._shrinkGrid({grid:a,centerPane:b,leadingPane:e,columnId:c,finalWidth:f}).then(g.hitch(this,function(){h=this._generateColumnSwitcherButton(a);
this._addHiddenColumnRules({grid:a,columnId:c});a.updateSelectionMode("single");a.refresh();this.resize();this.emit("show-detailed-field-view",{columnId:c,grid:a,fieldInfo:d,pickerButton:h})}))},_updatePopupInfosDateFormat:function(a){n.forEach(a,function(b){b.format&&b.format.dateFormat&&(b.format.dateFormat=this._popupDateFormats[b.format.dateFormat])},this);return a}});G("extend-esri")&&g.setObject("dijit.FeatureTable",y,I);return y});