// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
require({cache:{"dojo/debounce":function(){define([],function(){return function(M,R){var C;return function(){C&&clearTimeout(C);var r=this,J=arguments;C=setTimeout(function(){M.apply(r,J)},R)}}})},"esri/numberUtils":function(){define(["dojo/has","dojo/number","dojo/i18n!dojo/cldr/nls/number","./kernel"],function(M,R,C,r){var J=function(u,y){return u-y},S={_reNumber:/^-?(\d+)(\.(\d+))?$/i,getDigits:function(u){var y=String(u),w=y.match(S._reNumber);u={integer:0,fractional:0};w&&w[1]?(u.integer=w[1].split("").length,
u.fractional=w[3]?w[3].split("").length:0):-1<y.toLowerCase().indexOf("e")&&(w=y.split("e"),y=w[0],w=w[1],y&&w&&(y=Number(y),w=Number(w),(u=0<w)||(w=Math.abs(w)),y=S.getDigits(y),u?(y.integer+=w,y.fractional=w>y.fractional?0:y.fractional-w):(y.fractional+=w,y.integer=w>y.integer?1:y.integer-w),u=y));return u},getFixedNumbers:function(u,y){var w=Number(u.toFixed(y));w<u?u=w+1/Math.pow(10,y):(u=w,w-=1/Math.pow(10,y));w=Number(w.toFixed(y));u=Number(u.toFixed(y));return[w,u]},getPctChange:function(u,
y,w,W){var N={prev:null,next:null};if(null!=w){var T=u-w;N.prev=Math.floor(Math.abs(100*(y-w-T)/T))}null!=W&&(T=W-u,N.next=Math.floor(Math.abs(100*(W-y-T)/T)));return N},round:function(u,y){u=u.slice(0);var w,W,N=y&&null!=y.tolerance?y.tolerance:2,T=y&&y.indexes,ka=y&&null!=y.strictBounds?y.strictBounds:!1;if(T)T.sort(J);else for(T=[],w=0;w<u.length;w++)T.push(w);for(w=0;w<T.length;w++){var G=T[w];y=u[G];var k=0===G?null:u[G-1];var K=G===u.length-1?null:u[G+1];var q=S.getDigits(y);if(q=q.fractional){var p=
0;for(W=!1;p<=q&&!W;){var z=S.getFixedNumbers(y,p);z=ka&&0===w?z[1]:z[0];W=S.hasMinimalChange(y,z,k,K,N);p++}W&&(u[G]=z)}}return u},hasMinimalChange:function(u,y,w,W,N){u=S.getPctChange(u,y,w,W);y=null==u.prev||u.prev<=N;w=null==u.next||u.next<=N;return y&&w||u.prev+u.next<=2*N},_reAllZeros:new RegExp("\\"+C.decimal+"0+$","g"),_reSomeZeros:/(\d)0*$/g,format:function(u,y){y=y||{places:20,round:-1};(u=R.format(u,y))&&(u=u.replace(S._reSomeZeros,"$1").replace(S._reAllZeros,""));return u}};M("extend-esri")&&
(r.numberUtils=S);return S})},"esri/renderers/utils":function(){define("dojo/_base/lang dojo/_base/array dojo/has dojo/date/locale ../kernel ../numberUtils ../Color dojo/i18n!dojo/cldr/nls/gregorian".split(" "),function(M,R,C,r,J,S,u,y){function w(q){return q&&R.map(q,function(p){return new u(p)})}function W(q,p,z){var D="";0===p?D=T.lt+" ":p===z&&(D=T.gt+" ");return D+q}var N={},T={lte:"\x3c\x3d",gte:"\x3e\x3d",lt:"\x3c",gt:"\x3e",pct:"%"},ka={millisecond:0,second:1,minute:2,hour:3,day:4,month:5,
year:6},G={millisecond:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"medium"}},second:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"medium"}},minute:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},hour:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},day:{selector:"date",dateOptions:{formatLength:"long"}},month:{selector:"date",dateOptions:{formatLength:"long"}},year:{selector:"date",dateOptions:{selector:"year"}}},k={formatLength:"short",
fullYear:!0},K={formatLength:"short"};M.mixin(N,{timelineDateFormatOptions:{selector:"date",dateOptions:{formatLength:"short",fullYear:!0}},formatDate:function(q,p){var z=[];null==q||q instanceof Date||(q=new Date(q));p=p||{};p=M.mixin({},p);var D=p.selector?p.selector.toLowerCase():null,A=!D||-1<D.indexOf("time");D=!D||-1<D.indexOf("date");A&&(p.timeOptions=p.timeOptions||K,p.timeOptions&&(p.timeOptions=M.mixin({},p.timeOptions),p.timeOptions.selector=p.timeOptions.selector||"time",z.push(p.timeOptions)));
D&&(p.dateOptions=p.dateOptions||k,p.dateOptions&&(p.dateOptions=M.mixin({},p.dateOptions),p.dateOptions.selector=p.dateOptions.selector||"date",z.push(p.dateOptions)));z&&z.length?(z=R.map(z,function(H){return r.format(q,H)}),p=1==z.length?z[0]:y["dateTimeFormat-medium"].replace(/'/g,"").replace(/\{(\d+)\}/g,function(H,L){return z[L]})):p=r.format(q);return p},createColorStops:function(q){var p=q.values,z=q.colors,D=q.labelIndexes,A=q.isDate,H=q.dateFormatOptions;q=[];return q=R.map(p,function(L,
U){var O=null;if(!D||-1<R.indexOf(D,U)){var I;(I=A?N.formatDate(L,H):S.format(L))&&(O=W(I,U,p.length-1))}return{value:L,color:z[U],label:O}})},updateColorStops:function(q){var p=q.stops,z=q.changes,D=q.isDate,A=q.dateFormatOptions,H=[],L=R.map(p,function(O){return O.value});R.forEach(z,function(O){H.push(O.index);L[O.index]=O.value});var U=S.round(L,{indexes:H});R.forEach(p,function(O,I){O.value=L[I];if(null!=O.label){var X,ma=null;(X=D?N.formatDate(U[I],A):S.format(U[I]))&&(ma=W(X,I,p.length-1));
O.label=ma}})},createClassBreakLabel:function(q){var p=q.minValue,z=q.maxValue,D=q.isFirstBreak?"":T.gt+" ";q="percent-of-total"===q.normalizationType?T.pct:"";p=null==p?"":S.format(p);z=null==z?"":S.format(z);return D+p+q+" \u2013 "+z+q},setLabelsForClassBreaks:function(q){var p=q.classBreaks,z=q.classificationMethod,D=q.normalizationType,A=[];p&&p.length&&("standard-deviation"===z?console.log("setLabelsForClassBreaks: cannot set labels for class breaks generated using 'standard-deviation' method."):
q.round?(A.push(p[0].minValue),R.forEach(p,function(H){A.push(H.maxValue)}),A=S.round(A),R.forEach(p,function(H,L){H.label=N.createClassBreakLabel({minValue:0===L?A[0]:A[L],maxValue:A[L+1],isFirstBreak:0===L,normalizationType:D})})):R.forEach(p,function(H,L){H.label=N.createClassBreakLabel({minValue:H.minValue,maxValue:H.maxValue,isFirstBreak:0===L,normalizationType:D})}))},updateClassBreak:function(q){var p=q.classBreaks,z=q.normalizationType,D=q.change,A=D.index;D=D.value;var H=-1,L=-1,U=p.length;
"standard-deviation"===q.classificationMethod?console.log("updateClassBreak: cannot update labels for class breaks generated using 'standard-deviation' method."):(0===A?H=A:A===U?L=A-1:(L=A-1,H=A),-1<H&&H<U&&(q=p[H],q.minValue=D,q.label=N.createClassBreakLabel({minValue:q.minValue,maxValue:q.maxValue,isFirstBreak:0===H,normalizationType:z})),-1<L&&L<U&&(q=p[L],q.maxValue=D,q.label=N.createClassBreakLabel({minValue:q.minValue,maxValue:q.maxValue,isFirstBreak:0===L,normalizationType:z})))},calculateDateFormatInterval:function(q){var p,
z,D=q.length,A=Infinity;q=R.map(q,function(va){return new Date(va)});for(p=0;p<D-1;p++){var H=q[p];var L=[];var U=Infinity;var O="";for(z=p+1;z<D;z++){var I=q[z];I=H.getFullYear()!==I.getFullYear()&&"year"||H.getMonth()!==I.getMonth()&&"month"||H.getDate()!==I.getDate()&&"day"||H.getHours()!==I.getHours()&&"hour"||H.getMinutes()!==I.getMinutes()&&"minute"||H.getSeconds()!==I.getSeconds()&&"second"||"millisecond";var X=ka[I];X<U&&(U=X,O=I);L.push(I)}if(U<A){A=U;var ma=O}}return ma},createUniqueValueLabel:function(q){var p=
q.value,z=q.fieldInfo,D=q.domain;q=q.dateFormatInterval;var A=String(p);(D=D&&D.codedValues?D.getName(p):null)?A=D:"number"===typeof p&&(A=z&&"esriFieldTypeDate"===z.type?N.formatDate(p,q&&G[q]):S.format(p));return A},cloneColorInfo:function(q){if(q){var p=M.mixin({},q);p.colors=w(p.colors);p.stops=p.stops&&R.map(p.stops,function(z){z=M.mixin({},z);z.color&&(z.color=new u(z.color));return z});p.legendOptions&&(p.legendOptions=M.mixin({},p.legendOptions))}return p},cloneOpacityInfo:function(q){if(q){var p=
M.mixin({},q);if(q=p.opacityValues)p.opacityValues=q.slice(0);if(q=p.stops)p.stops=R.map(q,function(z){return M.mixin({},z)});if(q=p.legendOptions)p.legendOptions=M.mixin({},q)}return p},cloneSizeInfo:function(q){if(q){var p=M.mixin({},q);p.stops&&(p.stops=R.map(p.stops,function(z){return M.mixin({},z)}));(q=p.minSize)&&"object"===typeof q&&(p.minSize=N.cloneSizeInfo(q));(q=p.maxSize)&&"object"===typeof q&&(p.maxSize=N.cloneSizeInfo(q));if(q=p.legendOptions)if(p.legendOptions=M.mixin({},q),q=q.customValues)p.legendOptions.customValues=
q.slice(0)}return p},getClassCodesForRelationship:function(){return M.clone({2:["L","H"],3:["L","M","H"],4:["L","M1","M2","H"]})},getClassValuesForRelationship:function(){return M.clone({2:[["HL","HH"],["LL","LH"]],3:[["HL","HM","HH"],["ML","MM","MH"],["LL","LM","LH"]],4:[["HL","HM1","HM2","HH"],["M2L","M2M1","M2M2","M2H"],["M1L","M1M1","M1M2","M1H"],["LL","LM1","LM2","LH"]]})}});C("extend-esri")&&M.setObject("renderer.utils",N,J);return N})},"*noref":1}});
define("esri/dijit/Legend","dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/json dojo/_base/Color dojo/debounce dojo/has dojo/sniff dojo/Deferred dojo/DeferredList dojo/json dojo/dom dojo/dom-construct dojo/dom-style dojo/dom-class dijit/_Widget dojox/gfx dojox/gfx/matrix dojox/html/entities ../kernel ../config ../request ../lang ../numberUtils ../renderers/utils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/ClassBreaksRenderer ../renderers/ScaleDependentRenderer ../renderers/DotDensityRenderer ../renderers/TemporalRenderer ../renderers/VectorFieldRenderer ../renderers/HeatmapRenderer ../symbols/PictureFillSymbol ../symbols/SimpleMarkerSymbol ../symbols/SimpleLineSymbol ../symbols/SimpleFillSymbol ../symbols/utils ../symbols/jsonUtils ../renderers/jsonUtils ./_EventedWidget dojo/i18n!../nls/jsapi".split(" "),function(M,
R,C,r,J,S,u,y,w,W,N,T,ka,G,k,K,q,p,z,D,A,H,L,U,O,I,X,ma,va,La,Ma,Na,Oa,wa,Pa,Ca,ta,ua,xa,Da,na,Ea,Fa,ya){var Ga=X.getClassValuesForRelationship(),Ha={defaultShape:{type:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15"},stroke:{width:1,color:"#555555"}},za={HH:315,HL:45,LL:135,LH:225},Ia=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,ha=R([Fa,p],{declaredClass:"esri.dijit.Legend",widgetsInTemplate:!1,layers:null,alignRight:!1,hoverLabelShowing:!1,dotDensitySwatchSize:26,dotCoverage:75,gradientHeight:30,transparencyRampColor:new u([64,
64,64]),defaultText:"Aa",sizeRampLightColor:new u([255,255,255]),sizeRampDarkColor:new u([128,128,128]),gradientWidth:34,colorRampBorder:"1px solid",_specialChars:{lt:"\x3c",gt:"\x3e"},_ieTimer:100,_isRightToLeft:!1,_align:null,_legendAlign:null,_preserveCacheOnDestroy:!1,_layerConnects:null,_mapConnects:null,constructor:function(a,b){C.mixin(this,ya.widgets.legend);this._i18n=ya.widgets.legend;a=a||{};a.map?b?(this.map=a.map,this.layerInfos=a.layerInfos,this._respectCurrentMapScale=!1===a.respectCurrentMapScale?
!1:!0,this._respectVisibility=!1===a.respectVisibility?!1:!0,this._preserveCacheOnDestroy=a.preserveCacheOnDestroy?!0:!1,this.arrangement=a.arrangement===ha.ALIGN_RIGHT?ha.ALIGN_RIGHT:ha.ALIGN_LEFT,this.arrangement===ha.ALIGN_RIGHT&&(this.alignRight=!0),this.autoUpdate=!1===a.autoUpdate?!1:!0,this._surfaceItems=[],this.hideLayersInLegend={},this.refresh=y(this.refresh,0)):console.error("esri.dijit.Legend: must specify a container for the legend"):console.error("esri.dijit.Legend: unable to find the 'map' property in parameters")},
postMixInProperties:function(){this.inherited(arguments);var a=["ar","he"],b;for(b=0;b<a.length;b+=1){var c=a[b];M.locale&&-1!==M.locale.indexOf(c)&&(-1!==M.locale.indexOf("-")?-1!==M.locale.indexOf(c+"-")&&(this._isRightToLeft=!0):this._isRightToLeft=!0)}this._isRightToLeft?(this._align=this.alignRight?"left":"right",this._legendAlign=this.alignRight?"esriLegendLeft":"esriLegendRight"):(this._align=this.alignRight?"right":"left",this._legendAlign=this.alignRight?"esriLegendRight":"esriLegendLeft")},
startup:function(){this.inherited(arguments);this._surfaceItems=[];this._initialize();9>w("ie")&&(this._repaintItems=C.hitch(this,this._repaintItems),setTimeout(this._repaintItems,this._ieTimer))},destroy:function(){this._deactivate();this._removeCachedLegendResponses();this._removeHoverHandlers();this.inherited(arguments)},_removeCachedLegendResponses:function(){this._preserveCacheOnDestroy||r.forEach(this.layers,function(a){delete a.legendResponse})},refresh:function(a){if(this.domNode){a?(this.layerInfos=
a,this.layers=[],r.forEach(this.layerInfos,function(b){this._isSupportedLayerType(b.layer)&&(b.title&&(b.layer._titleForLegend=b.title),b.layer._hideDefaultSymbol=!1===b.defaultSymbol?!0:!1,b.hideLayers?(this.hideLayersInLegend[b.layer.id]=b.hideLayers,this._addSubLayersToHide(b)):this.hideLayersInLegend[b.layer.id]=[],b.hoverLabel&&(b.layer._hoverLabel=b.hoverLabel),b.hoverLabels&&(b.layer._hoverLabels=b.hoverLabels),this.layers.push(b.layer))},this)):this.useAllMapLayers&&(this.layers=this.layerInfos=
null);for(a=this.domNode.children.length-1;0<=a;a--)k.destroy(this.domNode.children[a]);this._removeHoverHandlers();this.startup()}},_legendUrl:"http://utility.arcgis.com/sharing/tools/legend",_initialize:function(){this.layerInfos&&(this.layers=[],r.forEach(this.layerInfos,function(c){this._isSupportedLayerType(c.layer)&&(c.title&&(c.layer._titleForLegend=c.title),c.layer._hideDefaultSymbol=!1===c.defaultSymbol?!0:!1,c.hideLayers?(this.hideLayersInLegend[c.layer.id]=c.hideLayers,this._addSubLayersToHide(c)):
this.hideLayersInLegend[c.layer.id]=[],c.hoverLabel&&(c.layer._hoverLabel=c.hoverLabel),c.hoverLabels&&(c.layer._hoverLabels=c.hoverLabels),this.layers.push(c.layer))},this));this.useAllMapLayers=!1;if(!this.layers){this.useAllMapLayers=!0;this.layers=[];var a=[],b=[];r.forEach(this.map.layerIds,function(c){c=this.map.getLayer(c);this._isSupportedLayerType(c)&&(c.arcgisProps&&c.arcgisProps.title&&(c._titleForLegend=c.arcgisProps.title),this.layers.push(c));if("esri.layers.KMLLayer"===c.declaredClass){var e=
c.getLayers();r.forEach(e,function(d){a.push(d.id)},this)}"esri.layers.GeoRSSLayer"===c.declaredClass&&(e=c.getFeatureLayers(),r.forEach(e,function(d){b.push(d.id)},this))},this);r.forEach(this.map.graphicsLayerIds,function(c){var e=this.map.getLayer(c);-1===r.indexOf(a,c)&&-1===r.indexOf(b,c)&&this._isSupportedLayerType(e)&&this._isLayerDrawingEnabled(e)&&(e.arcgisProps&&e.arcgisProps.title&&(e._titleForLegend=e.arcgisProps.title),this.layers.push(e))},this)}this._createLegend()},_isLayerDrawingEnabled:function(a){return a&&
(a._params&&a._params.drawMode||a.isFeatureReductionActive&&a.isFeatureReductionActive())},_activate:function(){this._deactivate();if(this.autoUpdate){this._mapConnects=[];this._layerConnects={};var a=this._mapConnects;this._respectCurrentMapScale&&a.push(J.connect(this.map,"onZoomEnd",this,"_refreshLayers"));this.useAllMapLayers&&(a.push(J.connect(this.map,"onLayerAdd",this,"_updateAllMapLayers")),a.push(J.connect(this.map,"onLayerRemove",this,"_updateAllMapLayers")),a.push(J.connect(this.map,"onLayersReordered",
this,"_updateAllMapLayers")));r.forEach(this.layers,function(b){var c=[J.connect(b,"onFeatureReductionRendererChange",this,"_refreshLayers"),J.connect(b,"onFeatureReductionChange",this,"_refreshLayers"),J.connect(b,"onVisibilityChange",this,"_refreshLayers"),J.connect(b,"onOpacityChange",this,"_refreshLayers"),J.connect(b,"onScaleRangeChange",this,"_refreshLayers")];"esri.layers.ArcGISDynamicMapServiceLayer"===b.declaredClass&&b.supportsDynamicLayers&&c.push(J.connect(b,"_onDynamicLayersChange",C.hitch(this,
"_updateDynamicLayers",b)));if("esri.layers.ArcGISImageServiceLayer"===b.declaredClass||"esri.layers.RasterXLayer"===b.declaredClass)c.push(J.connect(b,"onRenderingChange",C.partial(this._updateImageServiceLayers,this,b))),c.push(J.connect(b,"onRendererChange",C.partial(this._updateImageServiceLayers,this,b)));("esri.layers.ArcGISImageServiceVectorLayer"===b.declaredClass||b.setWebGLEnabled)&&c.push(J.connect(b,"onRendererChange",C.hitch(this,"_refreshLayers")));this._layerConnects[b.id]=c},this)}},
_deactivate:function(){r.forEach(this._mapConnects,function(a){J.disconnect(a)});r.forEach(this.layers,function(a){var b=this._layerConnects;b&&r.forEach(b[a.id],function(c){J.disconnect(c)})},this);this._mapConnects=this._layerConnects=null},_updateDynamicLayers:function(a){delete a.legendResponse;this._refreshLayers()},_updateImageServiceLayers:function(a,b){delete b.legendResponse;a._refreshLayers()},_refreshLayers:function(){this.refresh()},_updateAllMapLayers:function(){this.layers=[];r.forEach(this.map.layerIds,
function(a){a=this.map.getLayer(a);this._isSupportedLayerType(a)&&this.layers.push(a)},this);r.forEach(this.map.graphicsLayerIds,function(a){a=this.map.getLayer(a);this._isSupportedLayerType(a)&&this._isLayerDrawingEnabled(a)&&this.layers.push(a)},this);this.refresh()},_createLegend:function(){var a=!1,b=!1;K.set(this.domNode,"position","relative");k.create("div",{id:this.id+"_msg",className:"esriLegendMsg",innerHTML:this.NLS_creatingLegend+"..."},this.domNode);var c=[];r.forEach(this.layers,function(d){if("esri.layers.KMLLayer"===
d.declaredClass||"esri.layers.GeoRSSLayer"===d.declaredClass)if(d.loaded){if("esri.layers.KMLLayer"===d.declaredClass)var f=d.getLayers();else"esri.layers.GeoRSSLayer"===d.declaredClass&&(f=d.getFeatureLayers(),this.hideLayersInLegend[d.id]&&(f=r.filter(f,function(h){return-1===r.indexOf(this.hideLayersInLegend[d.id],h.id)},this)));r.forEach(f,function(h){"esri.layers.FeatureLayer"===h.declaredClass&&d._titleForLegend&&(h._titleForLegend=d._titleForLegend+" - ","esriGeometryPoint"===h.geometryType?
h._titleForLegend+=this.NLS_points:"esriGeometryPolyline"===h.geometryType?h._titleForLegend+=this.NLS_lines:"esriGeometryPolygon"===h.geometryType&&(h._titleForLegend+=this.NLS_areas),c.push(h))},this)}else J.connect(d,"onLoad",C.hitch(this,function(){this.refresh(this.layerInfos)}));else if("esri.layers.WMSLayer"===d.declaredClass)if(!d.loaded)J.connect(d,"onLoad",C.hitch(this,function(){this.refresh(this.layerInfos)}));else{if((!this._respectVisibility||this._respectVisibility&&d.visible)&&0<d.layerInfos.length&&
r.some(d.layerInfos,function(h){return h.legendURL})){var g=!1;r.forEach(d.layerInfos,function(h){if(h.legendURL&&-1<r.indexOf(d.visibleLayers,h.name)){g||(k.create("div",{innerHTML:"\x3cspan class\x3d'esriLegendServiceLabel'\x3e"+(d._titleForLegend||d.name||d.id)+"\x3c/span\x3e"},this.domNode),g=!0);var n;h=h.legendURL;if(d.customParameters||d.customLayerParameters){var m=C.clone(d.customParameters||{});C.mixin(m,d.customLayerParameters||{});for(n in m)h+=(-1===h.indexOf("?")?"?":"\x26")+n+"\x3d"+
m[n]}k.create("div",{innerHTML:"\x3cimg src\x3d'"+h+"'/\x3e"},this.domNode);a=!0}},this)}}else"esri.layers.WFSLayer"!==d.declaredClass||d.renderer?c.push(d):(f=k.create("div",{id:this.id+"_"+d.id,"class":"esriLegendService"}),k.create("span",{innerHTML:this._getServiceTitle(d),"class":"esriLegendServiceLabel"},k.create("td",{align:this._align},k.create("tr",{},k.create("tbody",{},k.create("table",{width:"95%"},f))))),k.place(f,this.id,"first"),f=k.create("table",{cellpadding:0,cellspacing:0,width:"95%",
"class":"esriLegendLayer"},f),f=k.create("tbody",{},f),"esriGeometryComplex"===d.geometryType?(this._buildRow_Renderer(d,d._pointSymbol,null,this.NLS_points,null,f),this._buildRow_Renderer(d,d._lineSymbol,null,this.NLS_lines,null,f),this._buildRow_Renderer(d,d._polygonSymbol,null,this.NLS_areas,null,f)):"esriGeometryPoint"===d.geometryType?this._buildRow_Renderer(d,d._pointSymbol,null,"",null,f):"esriGeometryPolyline"===d.geometryType?this._buildRow_Renderer(d,d._lineSymbol,null,"",null,f):"esriGeometryPolygon"===
d.geometryType&&this._buildRow_Renderer(d,d._polygonSymbol,null,"",null,f),b=!0)},this);var e=[];r.forEach(c,function(d){if(!d.loaded)var f=J.connect(d,"onLoad",this,function(h){J.disconnect(f);f=null;this.refresh()});else if((!this._respectVisibility||this._respectVisibility&&d.visible)&&(d.layerInfos||d.renderer||"esri.layers.ArcGISImageServiceLayer"===d.declaredClass||"esri.layers.RasterXLayer"===d.declaredClass)){var g=k.create("div",{id:this.id+"_"+d.id,style:{display:"none"},"class":"esriLegendService"});
k.create("span",{innerHTML:this._getServiceTitle(d),"class":"esriLegendServiceLabel"},k.create("td",{align:this._align},k.create("tr",{},k.create("tbody",{},k.create("table",{width:"95%"},g)))));k.place(g,this.id,"first");d.legendResponse||d.renderer&&"esri.renderer.StretchRenderer"!==d.renderer.declaredClass||d.renderer&&"esri.renderer.StretchRenderer"===d.renderer.declaredClass&&1===d.bandCount?this._createLegendForLayer(d):this.isHostedTileService(d)?this._getLayerInfos(d).then(C.hitch(this,function(h){this._createLegendForLayer(h)}),
C.hitch(this,function(h){e.push(this._legendRequest(h))})):"esri.layers.RasterXLayer"===d.declaredClass&&-1<d.capabilities.toLowerCase().indexOf("tilesonly")?this._createLegendForTileOnlyService(d):e.push(this._legendRequest(d))}},this);0!==e.length||a||b?(new T(e)).addCallback(C.hitch(this,function(d){a||b?G.byId(this.id+"_msg").innerHTML="":G.byId(this.id+"_msg").innerHTML=this.NLS_noLegend;this._activate()})):(G.byId(this.id+"_msg").innerHTML=this.NLS_noLegend,this._activate())},_createLegendForTileOnlyService:function(a){function b(m,
t){var l=["red","green","blue"],B=[[255,0,0],[0,255,0],[0,0,255]];(t&&t.length>=f?c(t):c()).forEach(function(E,x){var v=new ta(ta.STYLE_SQUARE,20,new ua(ua.STYLE_SOLID,new u([0,0,0]),1),new u(B[x]));m._buildRow_Renderer(a,v,null,l[x]+": "+E,null,d)},m)}function c(m){var t=(a.bandIds&&a.bandIds.length?a.bandIds:[0,1,2]).map(function(l){return m&&m[l]&&m[l].BandName||"Band_"+(l+1)});3>t.length?t.push(t[1]):3<t.length&&t.splice(3);return t}var e=k.create("div",{id:this.id+"_"+a.id+"_clientLegend","class":"esriLegendServiceLabel"},
G.byId(this.id+"_"+a.id));k.create("td",{align:this._align},k.create("tr",{},k.create("tbody",{},k.create("table",{width:"95%","class":"esriLegendLayerLabel"},e))));e=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},e);var d=k.create("tbody",{},e),f=a.bandCount;if(1<f&&(!a.bandIds||0===a.bandIds.length||1<a.bandIds.length))a.getKeyProperties().then(C.hitch(this,function(m){b(this,m.BandProperties)}),C.hitch(this,function(m){b(this)}));else{e={colorRamp:{type:"algorithmic",
fromColor:[0,0,0],toColor:[255,255,255]}};var g=a.renderer;if(g&&g.statistics&&g.statistics.length){var h=null!=g.statistics[0].min?g.statistics[0].min:g.statistics[0][0];var n=null!=g.statistics[0].max?g.statistics[0].max:g.statistics[0][1]}else h=a.serviceInfo.minValues.length?a.serviceInfo.minValues[0]:0,n=a.serviceInfo.maxValues.length?a.serviceInfo.maxValues[0]:255;this._createStretchLegend(d,g||e,h,n)}K.set(G.byId(this.id+"_"+a.id),"display","block");K.set(G.byId(this.id+"_msg"),"display","none")},
_createLegendForLayer:function(a){if(a.legendResponse||a.renderer||this.isHostedTileService(a)){var b=!1;if(a.legendResponse||this.isHostedTileService(a)){var c=a.dynamicLayerInfos||a.layerInfos;if(c&&c.length)r.forEach(c,function(e,d){this.hideLayersInLegend[a.id]&&-1!==r.indexOf(this.hideLayersInLegend[a.id],e.id)||(e=this._buildLegendItems(a,e,d),b=b||e)},this);else if("esri.layers.ArcGISImageServiceLayer"===a.declaredClass||"esri.layers.RasterXLayer"===a.declaredClass)b=this._buildLegendItems(a,
{id:0,name:null,title:a.name,subLayerIds:null,parentLayerId:-1},0)}else a.renderer&&(c=a.url?a.url.substring(a.url.lastIndexOf("/")+1,a.url.length):"fc_"+a.id,b=this._buildLegendItems(a,{id:c,name:null,subLayerIds:null,parentLayerId:-1},0));b&&(K.set(G.byId(this.id+"_"+a.id),"display","block"),K.set(G.byId(this.id+"_msg"),"display","none"))}},_legendRequest:function(a){if(a.loaded)return 10.01<=a.version?this._legendRequestServer(a):this._legendRequestTools(a);J.connect(a,"onLoad",C.hitch(this,"_legendRequest"))},
_legendRequestServer:function(a){var b=a.url,c=b.indexOf("?");b=-1<c?b.substring(0,c)+"/legend"+b.substring(c):b+"/legend";(c=a._getToken())&&(b+="?token\x3d"+c);var e=C.hitch(this,"_processLegendResponse"),d={f:"json"};a._params.dynamicLayers&&(d.dynamicLayers=ka.stringify(this._createDynamicLayers(a)),"[{}]"===d.dynamicLayers&&(d.dynamicLayers="[]"));a._params.bandIds&&(d.bandIds=a._params.bandIds);a._params.renderingRule?d.renderingRule=a._params.renderingRule:a.rasterFunctionInfos&&0<a.rasterFunctionInfos.length&&
r.forEach(a.rasterFunctionInfos,function(f){f&&f.name&&"none"===f.name.toLowerCase()&&(d.renderingRule=ka.stringify({rasterFunction:f.name}))});(c=a._params.mosaicRule&&JSON.parse(a._params.mosaicRule))&&c.multidimensionalDefinition&&c.multidimensionalDefinition.length&&(d.variable=c.multidimensionalDefinition[0].variableName);return U({url:b,content:d,callbackParamName:"callback",load:function(f,g){e(a,f,g)},error:L.defaults.io.errorHandler})},_legendRequestTools:function(a){var b=a.url.toLowerCase().indexOf("/rest/");
b=a.url.substring(0,b)+a.url.substring(b+5,a.url.length);b=this._legendUrl+"?soapUrl\x3d"+window.escape(b);if(!w("ie")||8<w("ie"))b+="\x26returnbytes\x3dtrue";var c=C.hitch(this,"_processLegendResponse");return U({url:b,content:{f:"json"},callbackParamName:"callback",load:function(e,d){c(a,e,d)},error:L.defaults.io.errorHandler})},_processLegendResponse:function(a,b){b&&b.layers?(a.legendResponse=b,G.byId(this.id+"_"+a.id)&&k.empty(G.byId(this.id+"_"+a.id)),k.create("span",{innerHTML:this._getServiceTitle(a),
"class":"esriLegendServiceLabel"},k.create("td",{align:this._align},k.create("tr",{},k.create("tbody",{},k.create("table",{width:"95%"},G.byId(this.id+"_"+a.id)))))),this._createLegendForLayer(a)):console.log("Legend could not get generated for "+a.url+": "+S.toJson(b))},_buildLegendItems:function(a,b,c){var e=!1,d=G.byId(this.id+"_"+a.id),f=b.parentLayerId;if(b.subLayerIds)a=k.create("div",{id:this.id+"_"+a.id+"_"+b.id+"_group",style:{display:"none"},"class":-1==f?0<c?"esriLegendGroupLayer":"":this._legendAlign},
-1==f?d:G.byId(this.id+"_"+a.id+"_"+f+"_group")),k.create("td",{innerHTML:A.encode(b.name),align:this._align},k.create("tr",{},k.create("tbody",{},k.create("table",{width:"95%","class":"esriLegendLayerLabel"},a))));else{if(this._respectVisibility&&a.visibleLayers)if(c=a.dynamicLayerInfos||a.layerInfos)if(a._params&&a._params.layers){if(-1===r.indexOf(a.visibleLayers,b.id))return e}else{if(c=this._getReallyVisibleLayers(c,a.visibleLayers),-1===r.indexOf(c,b.id))return e}else if(-1===r.indexOf(a.visibleLayers,
b.id))return e;d=k.create("div",{id:this.id+"_"+a.id+"_"+b.id,style:{display:"none"},"class":-1<f?this._legendAlign:""},-1==f?d:G.byId(this.id+"_"+a.id+"_"+f+"_group"));k.create("td",{innerHTML:A.encode(b.name)||"",align:this._align},k.create("tr",{},k.create("tbody",{},k.create("table",{width:"95%","class":"esriLegendLayerLabel"},d))));c=a.dynamicLayerInfos||a.layerInfos;f=!1;c&&c.length&&(f=r.some(c,function(g){return!!g.drawingInfo}));if(a.legendResponse)e=e||this._buildLegendItems_Tools(a,b,d);
else if(a.renderer||f)e=e||this._buildLegendItems_Renderer(a,b,d)}return e},_getReallyVisibleLayers:function(a,b){if(!a||!b||!b.length)return[];var c=[],e=[],d;for(d=0;d<a.length;d++)if(a[d].subLayerIds){if(-1===r.indexOf(b,a[d].id)||-1<r.indexOf(e,a[d].id))e=e.concat(a[d].subLayerIds)}else-1<r.indexOf(b,a[d].id)&&-1===r.indexOf(e,a[d].id)&&c.push(a[d].id);return c},_buildLegendItems_Tools:function(a,b,c){var e=b.parentLayerId,d=this.map.getScale(),f=!1,g=function(x,v){var Q,V;for(Q=0;Q<x.length;Q++)if(v.dynamicLayerInfos)for(V=
0;V<v.dynamicLayerInfos[V].length;V++){if(v.dynamicLayerInfos[V].mapLayerId==x[Q].layerId)return x[Q]}else if(v.id==x[Q].layerId)return x[Q];return{}};if(!this._respectCurrentMapScale||this._respectCurrentMapScale&&this._isLayerInScale(a,b,d)){var h=!0;if(this._respectCurrentMapScale&&("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISMapServiceLayer"===a.declaredClass)){var n=this._getEffectiveScale(a,b);if(n.minScale&&n.minScale<d||n.maxScale&&n.maxScale>d)h=!1}if(h){g=
g(a.legendResponse.layers,b);var m=g.legendType,t=g.legend;d=g.legendGroups;if(t){"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&"esri.layers.RasterXLayer"===a.declaredClass||this._sanitizeLegendResponse(a,g,b);c=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c);var l=k.create("tbody",{},c),B={};d&&0<d.length&&(c.setAttribute("cellspacing","10"),d.forEach(function(x){if(x.heading){var v=k.create("tr",{},l);v=k.create("td",{},v);k.create("div",{innerHTML:A.encode(x.heading)},
v)}v=k.create("tr",{},l);v=k.create("td",{},v);v=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},v);v=k.create("tbody",{},v);B[x.id]=v}));(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(c,a,b);var E=[];r.forEach(t,function(x){if(!(10.1<=a.version&&!x.values&&1<t.length)||!a._hideDefaultSymbol&&"\x3call other values\x3e"!==x.label){var v=x.label;if(x.url&&0===x.url.indexOf("http")||x.imageData&&0<x.imageData.length)f=!0,v&&-1!==r.indexOf(E,v)||(E.push(v),
this._buildRow_Tools(x,B[x.groupId]||l,a,b.id,m))}},this)}}}f&&(K.set(G.byId(this.id+"_"+a.id+"_"+b.id),"display","block"),-1<e&&(K.set(G.byId(this.id+"_"+a.id+"_"+e+"_group"),"display","block"),this._findParentGroup(a.id,a,e)));return f},_getLayerInfos:function(a){var b=new N,c=a.dynamicLayerInfos||a.layerInfos;if(c&&c.length)if(r.some(c,function(f){return!!f.drawingInfo}))b.resolve(a);else{var e=a.url,d=e.indexOf("?");e=-1===d?e+"/layers":e.substring(0,d)+"/layers"+e.substring(d,e.length);U({url:e,
content:{f:"json"},callbackParamName:"callback",load:function(f,g){f.layers?(r.forEach(c,function(h){var n=r.filter(f.layers,function(m){return h.source?m.id===h.source.mapLayerId:m.id===h.id});n&&n[0]&&n[0].drawingInfo&&(h.drawingInfo=n[0].drawingInfo,h.fields=n[0].fields)}),b.resolve(a)):b.reject(a)},error:function(f){b.reject(a)}})}return b},_sanitizeLegendResponse:function(a,b,c){var e=b.legend;if(10.1<=a.version&&1<e.length&&!b._sanitized){a=C.getObject("layerDefinition.drawingInfo.renderer",
!1,c);var d,f;a||(a=C.getObject("drawingInfo.renderer",!1,c));r.some(e,function(g){if(g.values)return!0})&&r.some(e,function(g,h){g.values||(f=h,d=g);return!!d});a?"uniqueValue"===a.type?d&&(e.splice(f,1),e.push(d)):"classBreaks"===a.type&&(d&&e.splice(f,1),e.reverse(),d&&e.push(d)):d&&(e.splice(f,1),e.push(d));b._sanitized=!0}},_buildRow_Tools:function(a,b,c,e,d){var f=k.create("tr",{},b);if(this.alignRight){b=k.create("td",{align:this._isRightToLeft?"left":"right"},f);var g=k.create("td",{align:this._isRightToLeft?
"left":"right",width:35},f)}else g=k.create("td",{width:35,align:"center"},f),b=k.create("td",{},f);f=a.url;(!w("ie")||9<=w("ie")||9>w("ie")&&("esri.layers.ArcGISImageServiceLayer"===c.declaredClass||"esri.layers.RasterXLayer"===c.declaredClass))&&a.imageData&&0<a.imageData.length?f="data:image/png;base64,"+a.imageData:0!==a.url.indexOf("http")&&(f=c.url+"/"+e+"/images/"+a.url,(e=c._getToken())&&(f+="?token\x3d"+e));e=k.create("img",{src:f,border:0,style:"opacity:"+c.opacity},g);a=k.create("td",{innerHTML:A.encode(a.label),
align:this._align},k.create("tr",{},k.create("tbody",{},k.create("table",{width:"95%",dir:"ltr"},b))));d&&"Stretched"===d&&10.3<=c.version&&("esri.layers.ArcGISImageServiceLayer"===c.declaredClass||"esri.layers.RasterXLayer"===c.declaredClass)&&(a.style.verticalAlign="top",a.style.lineHeight="1",e.style.marginBottom="-1px",e.style.display="block",b.style.verticalAlign="top");9>w("ie")&&(e.style.filter="alpha(opacity\x3d"+100*c.opacity+")")},_getVariable:function(a,b,c){if(a)var e=(a=a.getVisualVariablesForType(b,
c))&&a[0];return e},_getVariables:function(a,b,c){a=[this._getVariable(a,"colorInfo",!1),this._getVariable(a,"opacityInfo",!1),this._getVariable(a,"sizeInfo",!1)];return b?r.filter(a,function(e){return!(!e||e.field!==b||e.normalizationField!=c)}):a},_getFieldAlias:function(a,b,c){var e=b.infoTemplate||(b.infoTemplates&&c&&b.infoTemplates[c.id]?b.infoTemplates[c.id].infoTemplate:null);e=e&&e.getFieldInfo&&e.getFieldInfo(a);a=C.isFunction(a)?null:this.getField(b,a,c);b=e||a;c="";b&&(c=e&&e.label||a&&
a.alias||b.name||b.fieldName);return c},_getDomainName:function(a,b,c,e){if(a&&!C.isFunction(a))var d=(c=(a=this.getField(c,a,e))&&c.getDomain?c.getDomain(a.name):null)&&c.codedValues?c.getName(b):null;return d},_getRampTitle:function(a,b,c){var e=a.field,d=a.normalizationField,f=!1,g=!1,h=!1;e=C.isFunction(e)?null:e;d=C.isFunction(d)?null:d;if(a.legendOptions&&a.legendOptions.title)var n=a.legendOptions.title;else if(a.valueExpressionTitle)n=a.valueExpressionTitle;else{if(b.renderer&&b.renderer.authoringInfo&&
b.renderer.authoringInfo.visualVariables){var m=b.renderer.authoringInfo.visualVariables;for(a=0;a<m.length;a++){var t=m[a];if("colorInfo"===t.type&&"ratio"===t.style){f=!0;break}else if("colorInfo"===t.type&&"percent"===t.style){g=!0;break}else if("colorInfo"===t.type&&"percentTotal"===t.style){h=!0;break}}}(f=h&&"showRatioPercentTotal"||g&&"showRatioPercent"||f&&"showRatio"||d&&"showNormField"||e&&"showField"||null)&&(n=O.substitute({field:e&&this._getFieldAlias(e,b,c),normField:d&&this._getFieldAlias(d,
b,c)},"showField"===f?"${field}":this._i18n[f]))}return n},_getRendererTitle:function(a,b,c){if(a){if("esri.renderer.ClassBreaksRenderer"===a.declaredClass){var e=a.attributeField;var d=a.normalizationField;var f="percent-of-total"===a.normalizationType}e=C.isFunction(e)?null:e;d=C.isFunction(d)?null:d;if(a.legendOptions&&a.legendOptions.title)var g=a.legendOptions.title;else a.valueExpressionTitle?g=a.valueExpressionTitle:(a=d&&"showNormField"||(f?"showNormPct":null)||e&&"showField"||null)&&(g=O.substitute({field:e&&
this._getFieldAlias(e,b,c),normField:d&&this._getFieldAlias(d,b,c)},"showField"===a?"${field}":this._i18n[a]))}return g},_buildLegendItems_Renderer:function(a,b,c){function e(){K.set(G.byId(la.id+"_"+a.id+"_"+b.id),"display","block");-1<d&&(K.set(G.byId(la.id+"_"+a.id+"_"+d+"_group"),"display","block"),this._findParentGroup(a.id,d))}var d=b.parentLayerId,f=this.map,g=f.getScale(),h=!1;if(!this._respectCurrentMapScale||this._isLayerInScale(a,b,g)){var n,m,t;var l="esri.layers.ArcGISImageServiceVectorLayer"===
a.declaredClass?a.renderer.renderer:b&&b.drawingInfo?Ea.fromJson(C.clone(b.drawingInfo.renderer)):a.isFeatureReductionActive&&a.isFeatureReductionActive()?a.getFeatureReductionRenderer():a.renderer;if("esri.renderer.ScaleDependentRenderer"===l.declaredClass&&(l=(f="zoom"===l.rangeType?l.getRendererInfoByZoom(f.getZoom()):l.getRendererInfoByScale(g))&&f.renderer,!l))return!1;f=l&&l.authoringInfo&&"relationship"===l.authoringInfo.type;if("esri.renderer.StretchRenderer"!==l.declaredClass&&"esri.renderer.ShadedReliefRenderer"!==
l.declaredClass){g=this._getVariables(l);var B=r.filter(g,function(F){return!!F}).length,E=g[0],x=g[1],v=g[2],Q,V=!1;if(E){var Z=this._getMedianColor(l,E);E.field&&(n=C.isFunction(E.field)?null:this.getField(a,E.field,b));var da=!(E.legendOptions&&!1===E.legendOptions.showLegend)}if(x){x.field&&(t=C.isFunction(x.field)?null:this.getField(a,x.field,b));var ea=!(x.legendOptions&&!1===x.legendOptions.showLegend)}v&&(v.field&&(m=C.isFunction(v.field)?null:this.getField(a,v.field,b)),V=(Q=!(v.legendOptions&&
!1===v.legendOptions.showLegend))&&Ia.test(v.valueExpression))}if("esri.renderer.HeatmapRenderer"===l.declaredClass){var Y=h=!0;this._showHeatRamp(a,b,l,c)}else if("esri.renderer.DotDensityRenderer"===l.declaredClass)Y=h=!0,this._showDotDensityLegend(a,b,l,c);else if("esri.renderer.TemporalRenderer"===l.declaredClass){Y=h=!0;g=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c);var P=k.create("tbody",{},g);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(g,
a,b);l.latestObservationRenderer&&"esri.renderer.SimpleRenderer"===l.latestObservationRenderer.declaredClass&&this._buildRow_Renderer(a,l.latestObservationRenderer.symbol,Z,A.encode(l.latestObservationRenderer.label)||this.NLS_currentObservations,null,P);l.observationRenderer&&"esri.renderer.SimpleRenderer"===l.observationRenderer.declaredClass&&this._buildRow_Renderer(a,l.observationRenderer.symbol,Z,A.encode(l.observationRenderer.label)||this.NLS_previousObservations,null,P)}else if("esri.renderer.UniqueValueRenderer"===
l.declaredClass){if(l.infos&&0<l.infos.length){Y=h=!0;if(l.legendOptions&&l.legendOptions.title||l.valueExpressionTitle)g=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),P=k.create("tbody",{},g),B=l.legendOptions&&l.legendOptions.title?l.legendOptions.title:l.valueExpressionTitle,this._buildRow_Renderer(a,null,Z,A.encode(B),null,P);g=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c);P=k.create("tbody",{},g);(a._hoverLabel||
a._hoverLabels)&&this._createHoverAction(g,a,b);l.attributeField&&v&&this._addSubHeader(P,this._getFieldAlias(l.attributeField,a,b));if(f){var aa=l.authoringInfo;var ia=aa.focus;B=aa.numClasses;var oa=aa.field1.field;g=aa.field2.field;if(B&&oa&&g){var fa=aa.field1.normalizationField;aa=aa.field2.normalizationField;var Ja=fa&&this._i18n.showNormField||oa&&"${field}",Ka=aa&&this._i18n.showNormField||g&&"${field}";oa=O.substitute({field:this._getFieldAlias(oa,a,b),normField:fa&&this._getFieldAlias(fa,
a,b)},Ja);g=O.substitute({field:this._getFieldAlias(g,a,b),normField:aa&&this._getFieldAlias(aa,a,b)},Ka);fa={shapeDescriptor:Ha,rotation:this._getRotationAngleForFocus(ia)||0};this._buildRow_Renderer(a,null,null,A.encode(oa),null,P,null,fa);fa.rotation+=90;this._buildRow_Renderer(a,null,null,A.encode(g),null,P,null,fa);this._drawRelationshipLegend(c,{numClasses:B,focus:ia,uvInfos:l.infos})}}else{var Aa=[];r.forEach(l.infos,function(F){var ba=null;this._isLayerEditable(a)&&a.types&&(ba=this._getTemplateFromTypes(a.types,
F.value));var ja=F.label;null==ja&&(ja=this._getDomainName(l.attributeField,F.value,a,b)||F.value);-1===r.indexOf(Aa,ja)&&(Aa.push(ja),F=F.symbol,F=this._applyScaleDrivenSymbolSize(F,l,v,V),this._buildRow_Renderer(a,F,Z,A.encode(ja),ba,P))},this)}}ia=!f&&this._displayDefaultSymbol(a,l,c,v,V)}else if("esri.renderer.ClassBreaksRenderer"===l.declaredClass){if(l.infos&&0<l.infos.length||"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass){Y=h=!0;var pa=this._isUnclassedRenderer(l);if(!E&&1===
l.infos.length)var ca=(ca=l.infos[0])&&ca.symbol;pa||(g=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),P=k.create("tbody",{},g),B=this._getRendererTitle(l,a,b),this._buildRow_Renderer(a,null,Z,A.encode(B),null,P));g=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c);P=k.create("tbody",{},g);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(g,a,b);pa&&v&&Q&&!V||(f=l.infos.slice(0).reverse(),r.forEach(f,function(F){var ba=
F.label;null!=ba||pa||(ba=F.minValue+" - "+F.maxValue);F=F.symbol;F=this._applyScaleDrivenSymbolSize(F,l,v,V);this._buildRow_Renderer(a,F,Z,A.encode(ba),null,P)},this));"esri.layers.ArcGISImageServiceVectorLayer"!==a.declaredClass||a.renderer.style!==wa.STYLE_SCALAR&&a.renderer.style!==wa.STYLE_SINGLE_ARROW||(this._buildRow_Renderer(a,l.defaultSymbol,null,"",null,P),a._hideDefaultSymbol=!0)}pa||(ia=this._displayDefaultSymbol(a,l,c,v,V))}else if("esri.renderer.StretchRenderer"===l.declaredClass){Y=
h=!0;g=k.create("table",{cellpadding:0,cellspacing:0,width:"95%",class:"esriLegendLayer"},c);P=k.create("tbody",{},g);var la=this,qa,ra,Ba=function(){l.statistics.length?(qa=l.statistics[0][1],ra=l.statistics[0][0]):(ra=sa?sa.minValues[0]:a.minValues[0],qa=sa?sa.maxValues[0]:a.maxValues[0]);"esri.layers.RasterXLayer"===a.declaredClass&&a.hasStdTime()&&(ra=a.getStdTimeValue(ra),qa=a.getStdTimeValue(qa));la._createStretchLegend(P,l,ra,qa)};if(a.renderingRule)a.getRenderingRuleServiceInfo(a.renderingRule).then(function(F){var ba=
F&&F.minValues&&0<F.minValues.length&&F.maxValues&&0<F.maxValues.length;F&&1<F.bandCount||!ba?la._legendRequest(a).then(function(ja){la._processLegendResponse(a,ja)}):Ba()});else{var sa=a.serviceInfo;if("esri.layers.RasterXLayer"===a.declaredClass&&(sa=a.raster.serviceInfo,a.hasMultidimensions&&(!l.statistics||!l.statistics.length)))return c=a.mosaicRule&&a.mosaicRule.multidimensionalDefinition,a.getStatistics(c&&c.length?c[0].variableName:a._defaultMultidimensionalDefinition[0].variableName).then(C.hitch(this,
function(F){this._createStretchLegend(P,l,F[0][0],F[0][1]);e()})),h;Ba()}}else"esri.renderer.ShadedReliefRenderer"===l.declaredClass?(Y=h=!0,g=k.create("table",{cellpadding:0,cellspacing:0,width:"95%",class:"esriLegendLayer"},c),P=k.create("tbody",{},g),this._createStretchLegend(P,l,0,255)):"esri.renderer.SimpleRenderer"===l.declaredClass?(Y=h=!0,g=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),P=k.create("tbody",{},g),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(g,
a,b),ca=null,this._isLayerEditable(a)&&a.templates&&0<a.templates.length&&(ca=a.templates[0]),f=1<B?null:n&&da||t&&ea||m&&Q,this._buildRow_Renderer(a,l.symbol,Z,A.encode(f?this._getRampTitle(1<B?null:E||x||v,a,b):l.label),ca,P),ca=E?null:l.symbol,f&&(n=t=m=null)):"esri.renderer.ColormapRenderer"===l.declaredClass&&(l.colormapInfos&&l.colormapInfos.length&&(Y=h=!0),g=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),P=k.create("tbody",{},g),l.colormapInfos.forEach(function(F){var ba=
new xa(xa.STYLE_SOLID,null,new u(F.color));this._buildRow_Renderer(a,ba,null,F.label,null,P)},this),a._hideDefaultSymbol=!0);Y&&(E&&da&&(E.field||E.valueExpression)&&this._showGradientRamp(a,b,l,null,c,E,n,null,v&&Q?!0:!1),v&&Q&&(v.field||v.valueExpression&&!V)&&(Y=E&&da||"esri.renderer.UniqueValueRenderer"===l.declaredClass?!1:!0,this._showSizeLegend(a,b,l,v,Z,c,m,null,Y)),x&&ea&&(x.field||x.valueExpression)&&this._showGradientRamp(a,b,l,ca&&!ca.url&&ca.color?ca.color:this.transparencyRampColor,
c,x,t,null,!1));ia||pa&&!da&&!Q&&!ea||(ia=this._displayDefaultSymbol(a,l,c,v,V));h=h||ia}la=this;h&&e();return h},_createStretchLegend:function(a,b,c,e){var d=k.create("tr",{},a);var f=k.create("td",{rowspan:2,"class":"esriStretchLegend"},d);b=k.toDom(this._addColorRamp(b.colorRamp));k.place(b,f);k.create("td",{},d).innerHTML=this._i18n.high+": "+("string"===typeof e?e:Math.round(e*Math.pow(10,3))/Math.pow(10,3));a=k.create("tr",{},a);k.create("td",{},a).innerHTML=this._i18n.low+": "+("string"===
typeof c?c:Math.round(c*Math.pow(10,3))/Math.pow(10,3))},_addColorRamp:function(a){a||(a={algorithm:"hsv",fromColor:[0,0,0,1],toColor:[255,255,255,1]});var b=this._generateColorRampDivs(a);a.label="\x3cdiv class\x3d'esriStretchLegendGradientLabel'\x3e"+b+"\x3c/div\x3e";return a.label},_generateColorRampDivs:function(a){if(a){var b="";if("multipart"===a.type){var c=100/a.colorRamps.length;var e=a.colorRamps;Object.keys(e).reverse().forEach(function(d){b+=this._generateSingleGradientDiv(e[d].fromColor,
e[d].toColor,c)},this)}else b=this._generateSingleGradientDiv(a.fromColor,a.toColor,100);return b}},_generateSingleGradientDiv:function(a,b,c){if(a&&b){var e="";a=a.toRgb?a.toRgb():a;b=b.toRgb?b.toRgb():b;var d="(0deg, rgb("+a.slice(0,3).join()+"), rgb("+b.slice(0,3).join()+"));";r.forEach(["-webkit-linear-gradient","-o-linear-gradient","-moz-linear-gradient","linear-gradient"],function(f){e+="background: "+f+d});return"\x3cdiv class\x3d'esriStretchLegendSingleGradient' style\x3d'height:"+c+"%;"+
e+"'\x3e\x3c/div\x3e"}},_isLayerEditable:function(a){return"function"===typeof a.isEditable&&a.isEditable()},_isUnclassedRenderer:function(a,b){var c=a.infos;c=c?c.length:0;if("esri.renderer.ClassBreaksRenderer"===a.declaredClass&&1===c){c=a.attributeField;var e=a.normalizationField;a=b?c===b:!!this._getVariables(a,c,e).length}else a=a.authoringInfo&&a.authoringInfo.type,a=2===c&&"univariateColorSize"===a;return a},_displayDefaultSymbol:function(a,b,c,e,d){var f=b.defaultSymbol;if(!a._hideDefaultSymbol&&
f){var g=!0;c=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c);c=k.create("tbody",{},c);f=this._applyScaleDrivenSymbolSize(f,b,e,d);this._buildRow_Renderer(a,f,null,A.encode(b.defaultLabel)||"others",null,c)}return g},_applyScaleDrivenSymbolSize:function(a,b,c,e){e&&(a=na.fromJson(a.toJson()),this._applySize(a,b,c,null));return a},_showGradientRamp:function(a,b,c,e,d,f,g,h,n){n=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"+
(n?"":" esriLegendSubFragment")},d);d=k.create("tbody",{},n);(a._hoverLabel||a._hoverLabels||h)&&this._createHoverAction(n,a,b,h);(g||f.valueExpression||f.legendOptions&&f.legendOptions.title)&&this._addSubHeader(d,this._getRampTitle(f,a,b));g=f.field;var m;g&&(m=C.isFunction(g)?null:this.getField(a,g,b));if(f=(b=this._getRampStops(c,f,e,m&&"esriFieldTypeDate"===m.type))?b.length:0)f=10<f,this._drawGradientRamp(d,b,!f,a,this._getRampBorderColor(c),!!e,f)},_getMedianColor:function(a,b){if(b.colors){var c=
b.minDataValue;var e=b.maxDataValue}else b.stops&&(c=b.stops[0].value,e=b.stops[b.stops.length-1].value);return a.getColor(c+(e-c)/2,{colorInfo:b})},_getRampStops:function(a,b,c,e){var d,f,g=!1;if(b.colors||b.opacityValues){var h=b.maxDataValue-b.minDataValue;var n=r.map([0,.25,.5,.75,1],function(B){d=b.minDataValue+B*h;return Number(d.toFixed(6))});this._checkPrecision(0,4,n)}else b.stops&&(n=r.map(b.stops,function(B){return B.value}),e||r.some(n,function(B){return 2<I.getDigits(B).fractional})&&
(n=I.round(n)),(g=r.some(b.stops,function(B){return!!B.label}))&&(f=r.map(b.stops,function(B){return B.label})));var m=n[0],t,l;h=n[n.length-1]-m;return r.map(n,function(B,E){c?(t=new u(c.toRgba()),l=a.getOpacity(B,{opacityInfo:b}),null!=l&&(t.a=l)):t=a.getColor(B,{colorInfo:b});var x="";if(g)x=f[E];else{x=e?X.formatDate(B,X.timelineDateFormatOptions):I.format(B);var v="";0===E?v=this._specialChars.lt+" ":E===n.length-1&&(v=this._specialChars.gt+" ");x=v+x}return{value:B,color:t,offset:1-(B-m)/h,
label:x}},this).reverse()},_checkPrecision:function(a,b,c){var e=a+(b-a)/2,d=c[a],f=c[e],g=c[b],h=Math.floor(d),n=Math.floor(f),m=Math.floor(g);h===d&&m===g&&n!==f&&h!==n&&m!==n&&(c[e]=n);a+1!==e&&this._checkPrecision(a,e,c);e+1!==b&&this._checkPrecision(e,b,c)},_getRampBorderColor:function(a){if("esri.renderer.SimpleRenderer"===a.declaredClass)var b=a.symbol;else if("esri.renderer.UniqueValueRenderer"===a.declaredClass||"esri.renderer.ClassBreaksRenderer"===a.declaredClass)b=a.infos[0].symbol;return(a=
b&&-1===b.type.indexOf("linesymbol")?b.getStroke():null)&&a.color},_drawGradientRamp:function(a,b,c,e,d,f,g){var h=k.create("tr",{},a),n=b.length-1,m;var t=0;if(this.alignRight){a=k.create("td",{align:this._isRightToLeft?"left":"right"},h);var l=k.create("td",{align:this._isRightToLeft?"left":"right",width:this.gradientWidth},h)}else l=k.create("td",{width:this.gradientWidth,align:"center"},h),a=k.create("td",{},h);h=d&&0<d.a&&!(240<=d.r&&240<=d.g&&240<=d.b);var B=k.create("div",{"class":h?"":"esriLegendBorderLessColorRamp",
style:"position: relative; width:"+this.gradientWidth+"px;"},l);l=k.create("div",{"class":"esriLegendColorRamp"+(f?" esriLegendTransparencyRamp":"")},B);f=K.get(l,"width");h&&(d=9>w("ie")?d.toHex():"rgba("+d.toRgba().join(",")+")",K.set(l,"border",this.colorRampBorder+" "+d));c?(d=this.gradientHeight*n,K.set(l,"height",d+"px")):d=K.get(l,"height");K.set(B,"height",d+"px");h=z.createSurface(l,f,d);9>w("ie")&&(t=h.getEventSource(),K.set(t,"position","relative"),K.set(t.parentNode,"position","relative"),
t=1);try{c&&r.forEach(b,function(v,Q){v.offset=Q/n});var E=h.createRect({x:-t,y:-t,width:f+t,height:d+t});E.setFill({type:"linear",x1:0,y1:0,x2:0,y2:d,colors:b}).setStroke(null);h.createRect({width:f,height:d}).setFill(new u([255,255,255,1-e.opacity])).setStroke(null);this._surfaceItems.push(h)}catch(v){h.clear(),h.destroy()}r.forEach(b,function(v,Q){v.label&&(m="top:"+100*v.offset+"%;",v="",0===Q&&(v+=" esriLegendColorRampTickFirst"),Q===b.length-1&&(v+=" esriLegendColorRampTickLast"),k.create("div",
{"class":"esriLegendColorRampTick"+v,innerHTML:"\x26nbsp;",style:m},B))});var x=k.create("div",{"class":"esriLegendColorRampLabels",style:{height:d+this.gradientHeight+"px"}},a);c?r.forEach(b,function(v){k.create("div",{"class":"esriLegendColorRampLabel",innerHTML:A.encode(v.label)||"\x26nbsp;"},x)}):(k.create("div",{"class":"esriLegendColorRampLabel",innerHTML:g?A.encode(b[0].label)||"\x26nbsp;":this._i18n.high},x),k.create("div",{"class":"esriLegendColorRampLabel",innerHTML:g?A.encode(b[b.length-
1].label)||"\x26nbsp;":this._i18n.low,style:"top: "+(d+this.gradientHeight-2*this.gradientHeight)+"px;"},x))},_showHeatRamp:function(a,b,c,e,d){var f=c.field;var g=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},e);e=k.create("tbody",{},g);(a._hoverLabel||a._hoverLabels||d)&&this._createHoverAction(g,a,b,d);(f=f&&this.getField(a,f,b))&&this._addSubHeader(e,this._getFieldAlias(f.name,a,b));b=this._getHeatmapStops(c);b.length&&this._drawGradientRamp(e,b,!1,a)},_getHeatmapStops:function(a){var b=
a.colorStops;a=a.colors;if(b&&b[0]){var c=b.length-1;if(a=b[0]&&null!=b[0].ratio)(a=b[c])&&1!==a.ratio&&(b=b.slice(0),b.push({ratio:1,color:a.color}),c++);else{var e=b[0].value;var d=b[c].value-e;b=r.map(b,function(g){return{color:g.color,ratio:(g.value-e)/d}})}}else if(a&&a[0]){c=a.length-1;var f=1/(a.length-1);b=r.map(a,function(g,h){return{color:g,ratio:h*f}})}b=r.map(b,function(g,h){var n="";0===h?n="Low":h===c&&(n="High");return{color:g.color,label:n,offset:1-g.ratio}});return b.reverse()},_showDotDensityLegend:function(a,
b,c,e){var d=c.legendOptions,f,g=this.dotDensitySwatchSize,h=Math.round(g/2);if(d){var n=d.backgroundColor;var m=d.outline;var t=d.valueUnit;var l=d.dotCoverage}l=(l||this.dotCoverage)/100;var B=Math.round(g*g/Math.pow(c.dotSize,2)*l);e=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},e);var E=k.create("tbody",{},e);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(e,a,b);this._addSubHeader(E,O.substitute({value:c.dotValue,unit:t||""},this.NLS_dotValue));
r.forEach(c.fields,function(x){x=C.mixin({},x);x.numPoints=B;f=new Ca(c._generateImageSrc(g,g,[x],{x:0,y:0},{x:g,y:g},n),m||c.outline,g,g);x=this.getField(a,x.name,b)||x;this._buildRow_Renderer(a,f,null,A.encode(this._getFieldAlias(x.name,a,b)),null,E,{type:"path",path:"M "+-h+","+-h+" L "+h+","+-h+" L "+h+","+h+" L "+-h+","+h+" L "+-h+","+-h+" E"})},this)},_showSizeLegend:function(a,b,c,e,d,f,g,h,n){var m=e.legendOptions;m=m&&m.customValues;d=this._getSizeSymbol(c,d);if((!e.valueUnit||"unknown"===
e.valueUnit)&&d&&(m||null!=e.minSize&&null!=e.maxSize&&null!=e.minDataValue&&null!=e.maxDataValue||e.stops&&!(1>=e.stops.length))){n=k.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"+(n?"":" esriLegendSubFragment")},f);f=k.create("tbody",{},n);(a._hoverLabel||a._hoverLabels||h)&&this._createHoverAction(n,a,b,h);(g||e.valueExpression||e.legendOptions&&e.legendOptions.title)&&this._addSubHeader(f,this._getRampTitle(e,a,b));g=(n=(h=e.field)&&!C.isFunction(h))&&"cluster_count"===
h.toLowerCase();b=(b=n?a.isFeatureReductionActive&&a.isFeatureReductionActive()?a.getFeatureReductionField(h):this.getField(a,h,b):null)&&"esriFieldTypeDate"===b.type;m=m||this._getDataValues(c,d,e,b,g);var t=m.length-1;for(h=t;0<=h;h--){n=m[h];d=na.fromJson(d.toJson());this._applySize(d,c,e,n);n=b?X.formatDate(n,X.timelineDateFormatOptions):I.format(n);var l="";h===t?l=this._specialChars.gt+" ":0===h&&(l=g&&1===m[h]?"":this._specialChars.lt+" ");l="\x3cspan class\x3d'esriLegendSizeRampLabel'\x3e"+
A.encode(l+n)+"\x3c/span\x3e";this._buildRow_Renderer(a,d,null,l,null,f)}}},_getSizeSymbol:function(a,b){if("esri.renderer.SimpleRenderer"===a.declaredClass)var c=a.symbol;else if("esri.renderer.VectorFieldRenderer"===a.declaredClass)c=a.defaultSymbol;else if("esri.renderer.UniqueValueRenderer"===a.declaredClass||"esri.renderer.ClassBreaksRenderer"===a.declaredClass){c=a.infos[0].symbol;var e=1<a.infos.length}if(c=c&&-1!==c.type.indexOf("fillsymbol")?null:c)if(c=na.fromJson(c.toJson()),b||e)-1!==
c.type.indexOf("linesymbol")?c.setColor(new u(this.sizeRampDarkColor)):(c.setColor(new u(this.sizeRampLightColor)),c.setOutline&&(a=new ua,a.setColor(new u(this.sizeRampDarkColor)),a.setWidth(1.5),c.setOutline(a)));return c},_getDataValues:function(a,b,c,e,d){if(d){var f;r.some([5,3,2],function(g){g=this._getDataValuesByCount(a,b,c,e,g);this._hasFractionalValues(g)||(f=g);return!!f},this);return f}return(d=a.authoringInfo)&&"univariateColorSize"===d.type&&"above-and-below"===d.univariateTheme&&c.stops?
this._getDataValuesFromStops(c,e):this._getDataValuesByCount(a,b,c,e,5)},_getDataValuesFromStops:function(a,b){a=r.map(a.stops,function(c){return c.value});return b?a:I.round(a)},_getDataValuesByCount:function(a,b,c,e,d,f){d=null==d?5:d;f=null==f?20:f;var g=a.getSizeRangeAtScale(c,this.map.getScale());d=this._interpolateSizeRange(g,d);var h=this._getDataRange(c),n=r.map(d,function(t){return this._getDataValueFromSize(t,h,g)},this);if(!e){var m;n=I.round(n);for(e=1;e<n.length-1;e++)if(m=this._roundDataValue(a,
b,c,n[e],n[e-1],f))n[e]=m[0],d[e]=m[1]}return n},_hasFractionalValues:function(a){return r.some(a,function(b){return b!==Math.floor(b)})},_getDataRange:function(a){var b=a.stops;return b?{min:b[0].value,max:b[b.length-1].value}:{min:a.minDataValue,max:a.maxDataValue}},_interpolateSizeRange:function(a,b){var c=a.minSize;a=(a.maxSize-c)/(b-1);var e,d=[];for(e=0;e<b;e++)d.push(c+a*e);return d},_getDataValueFromSize:function(a,b,c){var e=c.minSize;c=c.maxSize;var d=b.min;b=b.max;return a<=e?d:a>=c?b:
(a-e)/(c-e)*(b-d)+d},_roundDataValue:function(a,b,c,e,d,f){var g=this._getSize(b,a,c,e);d=this._getSize(b,a,c,d);var h=I.getDigits(e),n=h.integer;h=h.fractional;var m;if(0<e&&1>e){var t=Math.pow(10,h);e*=t;n=I.getDigits(e).integer}for(--n;0<=n;n--){var l=Math.pow(10,n);h=Math.floor(e/l)*l;l*=Math.ceil(e/l);null!=t&&(h/=t,l/=t);var B=(h+l)/2;B=I.round([h,B,l],{indexes:[1]})[1];var E=this._getSize(b,a,c,h);var x=this._getSize(b,a,c,l);var v=this._getSize(b,a,c,B);var Q=I.getPctChange(g,E,d,null);var V=
I.getPctChange(g,x,d,null);var Z=I.getPctChange(g,v,d,null);var da=Q.prev<=f;var ea=V.prev<=f;da&&ea&&(Q.prev<=V.prev?(da=!0,ea=!1):(ea=!0,da=!1));da?m=[h,E]:ea?m=[l,x]:Z.prev<=f&&(m=[B,v]);if(m)break}return m},_applySize:function(a,b,c,e){var d=a.type;b=this._getSize(a,b,c,e);switch(d){case "simplemarkersymbol":a.setSize(b);break;case "picturemarkersymbol":d=a.width;c=a.height;a.setHeight(b);a.setWidth(d/c*b);break;case "simplelinesymbol":case "cartographiclinesymbol":a.setWidth(b);break;case "textsymbol":a.font&&
a.font.setSize(b)}},_getSize:function(a,b,c,e){return b.getSize(e,{sizeInfo:c,scale:this.map.getScale(),shape:-1!==a.type.indexOf("markersymbol")?a.style:null})},_buildRow_Renderer:function(a,b,c,e,d,f,g,h){var n=!!h,m=k.create("tr",{},f);if(this.alignRight){if(f=k.create("td",{align:this._isRightToLeft?"left":"right"},m),b||n)var t=k.create("td",{align:this._isRightToLeft?"left":"right",width:35},m)}else{if(b||n)t=k.create("td",{width:35,align:"center"},m);f=k.create("td",{},m)}var l=m=30;if(b)if("simplemarkersymbol"===
b.type)m=Math.min(Math.max(m,b.size+12),125),l=Math.min(Math.max(l,b.size+12),125);else if("picturemarkersymbol"===b.type)m=Math.min(Math.max(m,b.width),125),l=Math.min(b.height||l,125);else if("textsymbol"===b.type){if(!b.text){var B=b.text;var E=!0;b.setText(this.defaultText)}m=Math.min(Math.max(m,b.getWidth()+12),125);l=Math.min(Math.max(l,b.getHeight()+12),125);E&&b.setText(B)}if(b||n)var x=k.create("div",{style:"width:"+m+"px;height:"+l+"px;"},t);O.isDefined(e)&&"number"===typeof e&&(e=""+e);
k.create("td",{innerHTML:e||"",align:this._align},k.create("tr",{},k.create("tbody",{},k.create("table",{width:"95%"},f))));if(b||n)a=this._drawSymbol(x,b,c,m,l,d,a,g,h),this._surfaceItems.push(a)},_addSubHeader:function(a,b){a=k.create("tr",{},a);a=k.create("td",{align:this._align,colspan:2},a);k.create("td",{innerHTML:A.encode(b)||"",align:this._align},k.create("tr",{},k.create("tbody",{},k.create("table",{width:"95%"},a))))},_drawSymbol:function(a,b,c,e,d,f,g,h,n){var m=b&&na.fromJson(b.toJson()),
t=g.opacity;b=!!n;if(m)if(c&&m.setColor(new u(c.toRgba())),"simplelinesymbol"===m.type||"cartographiclinesymbol"===m.type||"textsymbol"===m.type){if(!m.color)return;c=m.color.toRgba();c[3]*=t;m.color.setColor(c)}else"simplemarkersymbol"===m.type||"simplefillsymbol"===m.type?(m.color&&(c=m.color.toRgba(),c[3]*=t,m.color.setColor(c)),m.outline&&m.outline.color&&(c=m.outline.color.toRgba(),c[3]*=t,m.outline.color.setColor(c))):"picturemarkersymbol"===m.type&&(a.style.opacity=t,a.style.filter="alpha(opacity\x3d("+
100*t+"))");a=z.createSurface(a,e,d);9>w("ie")&&(c=a.getEventSource(),K.set(c,"position","relative"),K.set(c.parentNode,"position","relative"));f=b?n.shapeDescriptor:this._getDrawingToolShape(m,f)||na.getShapeDescriptors(m);t=(c=f.defaultShape)&&"text"===c.type;try{t&&!c.text&&(c.text=this.defaultText);var l=a.createShape(h||c).setFill(f.fill).setStroke(f.stroke);t&&l.setFont(f.font)}catch(x){a.clear();a.destroy();return}var B=l.getBoundingBox();h=B.width;f=B.height;t=-(B.x+h/2);var E=-(B.y+f/2);
c=a.getDimensions();t={dx:t+c.width/2,dy:E+c.height/2};if(m&&"simplemarkersymbol"===m.type&&"path"===m.style)e=g._getScaleMatrix(B,m.size),l.applyTransform(D.scaleAt(e.xx,e.yy,{x:c.width/2,y:c.height/2}));else if(h>e||f>d)g=h/e>f/d,e=((g?e:d)-5)/(g?h:f),C.mixin(t,{xx:e,yy:e});l.applyTransform(t);b&&l.applyTransform(D.rotategAt(n.rotation,h/2,f/2));return a},_getDrawingToolShape:function(a,b){switch(b?b.drawingTool||null:null){case "esriFeatureEditToolArrow":b={type:"path",path:"M 10,1 L 3,8 L 3,5 L -15,5 L -15,-2 L 3,-2 L 3,-5 L 10,1 Z"};
break;case "esriFeatureEditToolTriangle":b={type:"path",path:"M -10,14 L 2,-10 L 14,14 L -10,14 Z"};break;case "esriFeatureEditToolRectangle":b={type:"path",path:"M -10,-10 L 10,-10 L 10,10 L -10,10 L -10,-10 Z"};break;case "esriFeatureEditToolCircle":b={type:"circle",cx:0,cy:0,r:10};break;case "esriFeatureEditToolEllipse":b={type:"ellipse",cx:0,cy:0,rx:10,ry:5};break;default:return null}return{defaultShape:b,fill:a.getFill(),stroke:a.getStroke()}},_drawRelationshipLegend:function(a,b){var c=b.focus,
e=b.numClasses,d=Ga[e],f=!!c,g=Math.sqrt(Math.pow(75,2)+Math.pow(75,2)),h={};b.uvInfos.forEach(function(l){h[l.value]={label:l.label,fill:this._getSymbolColor(l.symbol)}},this);b=[];for(var n=0;n<e;n++){for(var m=[],t=0;t<e;t++)m.push(h[d[n][t]].fill);b.push(m)}d=this._getRelationshipCornerLabels(c,h);a=this._drawRampLayout(a,d,g,f);a=z.createSurface(a,g,g);f||(a.rawNode.style.margin="-15px -15px -18px -15px");b=Da.create2DColorRamp({surface:a,colors:b,numClasses:e,size:75});e=(g-75)/2;g=(g-75)/2;
b.applyTransform(D.translate(e,g));f&&b.applyTransform(D.rotategAt(this._getRotationAngleForFocus(c),37.5,37.5));b=a.createGroup();d={width:1,color:"#555555"};n=a.defNode;this._createArrowMarker(n,"start");this._createArrowMarker(n,"end");n=b.createLine({x1:-10,y1:60,x2:-10,y2:15}).setStroke(d);d=b.createLine({x1:15,y1:85,x2:60,y2:85}).setStroke(d);this._setLineArrow(n.rawNode,"left",c);this._setLineArrow(d.rawNode,"right",c);b.applyTransform(D.translate(e,g));f&&b.applyTransform(D.rotategAt(-45,
37.5,37.5));this._surfaceItems.push(a)},_drawRampLayout:function(a,b,c,e){var d=k.create("div",{style:{padding:"10px"}},a);a=c+"px";c+="px";e?(e=k.create("div",{style:{display:"flex"}},d),k.create("div",{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:a,textAlign:"right"},innerHTML:b.left},e),d=k.create("div",{style:{display:"flex",flexDirection:"column",textAlign:"center"}},e),k.create("div",{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:a},innerHTML:b.right},
e),e=k.create("div",{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:a},innerHTML:b.top},d),e=k.create("div",{style:{height:c,width:c}},d),d=k.create("div",{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:a},innerHTML:b.bottom},d)):(d=k.create("div",{style:{display:"table",color:"#555555"}},d),e=k.create("div",{style:{display:"table-row"}},d),c=k.create("div",{style:{display:"table-row"}},d),d=k.create("div",{style:{display:"table-row"}},d),k.create("div",
{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:a,textAlign:"right",verticalAlign:"bottom"},innerHTML:b.left},e),k.create("div",{style:{display:"table-cell"}},e),k.create("div",{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:a,textAlign:"left",verticalAlign:"bottom"},innerHTML:b.top},e),k.create("div",{style:{display:"table-cell"}},c),e=k.create("div",{style:{display:"table-cell"}},c),k.create("div",{style:{display:"table-cell"}},c),k.create("div",
{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:a,textAlign:"right",verticalAlign:"top"},innerHTML:b.bottom},d),k.create("div",{style:{display:"table-cell"}},d),k.create("div",{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:a,textAlign:"left",verticalAlign:"top"},innerHTML:b.right},d));return e},_getSymbolColor:function(a){if(a)return"simplelinesymbol"===a.type||"simplemarkersymbol"===a.type&&(a.style===ta.STYLE_X||a.style===ta.STYLE_CROSS)?(a=a.getStroke())&&
a.color:a.getFill()},_getRotationAngleForFocus:function(a){var b=za[a];a&&null==b&&(b=za.HH);return b},_setLineArrow:function(a,b,c){var e=this.id+"_arrowStart",d=this.id+"_arrowEnd";b="left"===b;switch(c){case "HL":a.setAttribute(b?"marker-start":"marker-end","url(#"+(b?d:e)+")");break;case "LL":a.setAttribute("marker-start","url(#"+d+")");break;case "LH":a.setAttribute(b?"marker-end":"marker-start","url(#"+(b?e:d)+")");break;default:a.setAttribute("marker-end","url(#"+e+")")}},_createArrowMarker:function(a,
b){var c="start"===b,e=this.id+(c?"_arrowStart":"_arrowEnd");b=c?"0,0 5,5 0,10":"5,0 0,5 5,10";var d=c?5:0;c=document.createElementNS("http://www.w3.org/2000/svg","marker");c.setAttribute("id",e);c.setAttribute("markerWidth","10");c.setAttribute("markerHeight","10");c.setAttribute("refX",d);c.setAttribute("refY","5");c.setAttribute("markerUnits","strokeWidth");c.setAttribute("orient","auto");e=document.createElementNS("http://www.w3.org/2000/svg","polyline");e.setAttribute("points",b);e.setAttribute("fill",
"none");e.setAttribute("stroke","#555555");e.setAttribute("stroke-width","1");c.appendChild(e);a.appendChild(c)},_getRelationshipCornerLabels:function(a,b){var c=b.HH.label,e=b.LL.label,d=b.HL.label;b=b.LH.label;switch(a){case "HH":return{top:c,bottom:e,left:d,right:b};case "HL":return{top:d,bottom:b,left:e,right:c};case "LL":return{top:e,bottom:c,left:b,right:d};case "LH":return{top:b,bottom:d,left:c,right:e};default:return{top:c,bottom:e,left:d,right:b}}},_repaintItems:function(){r.forEach(this._surfaceItems,
function(a){this._repaint(a)},this)},_repaint:function(a){if(a){a.getStroke&&a.setStroke&&a.setStroke(a.getStroke());try{a.getFill&&a.setFill&&a.setFill(a.getFill())}catch(b){}a.children&&C.isArray(a.children)&&r.forEach(a.children,this._repaint,this)}},_createHoverAction:function(a,b,c,e){if(e=b._hoverLabel||b._hoverLabels&&b._hoverLabels[c.id]||e)e=A.encode(e),b.mouseMoveHandler=b.mouseMoveHandler||{},b.mouseMoveHandler[c.id]=J.connect(a,"onmousemove",C.hitch(this,function(d,f){this.mouseX=f.clientX;
this.mouseY=f.clientY;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,K.set(G.byId(this.id+"_hoverLabel"),"display","none"));setTimeout(C.hitch(this,function(g,h,n){if(g==this.mouseX&&h==this.mouseY&&!this.hoverLabelShowing)if(this.hoverLabelShowing=!0,G.byId(this.id+"_hoverLabel")){var m=G.byId(this.id+"_hoverLabel");m.innerHTML="\x3cspan\x3e"+n+"\x3c/span\x3e";K.set(m,"top",h+"px");K.set(m,"left",g+15+"px");K.set(m,"display","")}else k.create("div",{innerHTML:"\x3cspan\x3e"+n+"\x3c/span\x3e",
id:this.id+"_hoverLabel","class":"esriLegendHoverLabel",style:{top:h+"px",left:g+15+"px"}},document.body)},f.clientX,f.clientY,d),500)},e)),b.mouseOutHandler=b.mouseOutHandler||{},b.mouseOutHandler[c.id]=J.connect(a,"onmouseout",C.hitch(this,function(d){this.mouseY=this.mouseX=-1;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,K.set(G.byId(this.id+"_hoverLabel"),"display","none"))}))},_removeHoverHandlers:function(){var a;r.forEach(this.layers,function(b){if(b.mouseMoveHandler)for(a in b.mouseMoveHandler)J.disconnect(b.mouseMoveHandler[a]);
if(b.mouseOutHandler)for(a in b.mouseOutHandler)J.disconnect(b.mouseOutHandler[a])})},_createDynamicLayers:function(a){var b=[],c;r.forEach(a.dynamicLayerInfos||a.layerInfos,function(e){c={id:e.id};c.source=e.source&&e.source.toJson();var d;a.layerDefinitions&&a.layerDefinitions[e.id]&&(d=a.layerDefinitions[e.id]);d&&(c.definitionExpression=d);var f;a.layerDrawingOptions&&a.layerDrawingOptions[e.id]&&(f=a.layerDrawingOptions[e.id]);f&&(c.drawingInfo=f.toJson());c.minScale=e.minScale||0;c.maxScale=
e.maxScale||0;b.push(c)});return b},_getTemplateFromTypes:function(a,b){var c;for(c=0;c<a.length;c++)if(a[c].id==b&&a[c].templates&&0<a[c].templates.length)return a[c].templates[0];return null},_findParentGroup:function(a,b,c){var e,d=b.dynamicLayerInfos||b.layerInfos;for(e=0;e<d.length;e++)if(c==d[e].id){-1<d[e].parentLayerId&&(K.set(G.byId(this.id+"_"+a+"_"+d[e].parentLayerId+"_group"),"display","block"),this._findParentGroup(a,b,d[e].parentLayerId));break}},_addSubLayersToHide:function(a){function b(c,
e){var d=a.layer.dynamicLayerInfos||a.layer.layerInfos,f,g;for(f=0;f<d.length;f++)if(d[f].id===c&&d[f].subLayerIds)for(g=0;g<d[f].subLayerIds.length;g++){var h=d[f].subLayerIds[g];-1===r.indexOf(e,h)&&(e.push(h),b(h,e))}}a.layer.layerInfos&&r.forEach(this.hideLayersInLegend[a.layer.id],function(c){b(c,this.hideLayersInLegend[a.layer.id])},this)},_isLayerInScale:function(a,b,c){var e,d=!0;if(a.legendResponse&&a.legendResponse.layers)for(e=0;e<a.legendResponse.layers.length;e++){var f=a.legendResponse.layers[e];
if(b.id==f.layerId){if(!a.minScale&&0!==a.minScale||!a.maxScale&&0!==a.maxScale){if(0==f.minScale&&a.tileInfo)var g=a.tileInfo.lods[0].scale;if(0==f.maxScale&&a.tileInfo)var h=a.tileInfo.lods[a.tileInfo.lods.length-1].scale}else g=Math.min(a.minScale,f.minScale)||a.minScale||f.minScale,h=Math.max(a.maxScale,f.maxScale);if(0<g&&g<c||h>c)d=!1;break}}else if(a.minScale||a.maxScale)if(a.minScale&&a.minScale<c||a.maxScale&&a.maxScale>c)d=!1;return d},_getServiceTitle:function(a){var b=a._titleForLegend;
b||(b=a.url,a.url?-1<a.url.indexOf("/MapServer")?(b=a.url.substring(0,a.url.indexOf("/MapServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):-1<a.url.indexOf("/ImageServer")?(b=a.url.substring(0,a.url.indexOf("/ImageServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):-1<a.url.indexOf("/FeatureServer")&&(b=a.url.substring(0,a.url.indexOf("/FeatureServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):b="",a.name&&(b=0<b.length?b+(" - "+a.name):a.name));"esri.layers.ArcGISImageServiceVectorLayer"===
a.declaredClass&&a.vectorFieldPixelFilter&&(a=a.vectorFieldPixelFilter.outputUnit?this["NLS_"+a.vectorFieldPixelFilter.outputUnit]:this["NLS_"+a.vectorFieldPixelFilter.inputUnit],O.isDefined(a)&&(b+=" ("+a+")"));return A.encode(b)},_getEffectiveScale:function(a,b){var c=b.minScale,e=b.maxScale;if(O.isDefined(b.parentLayerId)){a=a.layerInfos;b=b.parentLayerId;var d;for(d=a.length-1;0<=d;d--)if(a[d].id==b)if(0==c&&0<a[d].minScale?c=a[d].minScale:0<c&&0==a[d].minScale||0<c&&0<a[d].minScale&&(c=Math.min(c,
a[d].minScale)),e=Math.max(e||0,a[d].maxScale||0),-1<a[d].parentLayerId)b=a[d].parentLayerId;else break}return{minScale:c,maxScale:e}},_isSupportedLayerType:function(a){return!(!a||!("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&10.2<=a.version||"esri.layers.RasterXLayer"===a.declaredClass||"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass||"esri.layers.ArcGISTiledMapServiceLayer"===a.declaredClass||"esri.layers.FeatureLayer"===
a.declaredClass||"esri.layers.StreamLayer"===a.declaredClass||"esri.layers.KMLLayer"===a.declaredClass||"esri.layers.GeoRSSLayer"===a.declaredClass||"esri.layers.WMSLayer"===a.declaredClass||"esri.layers.WFSLayer"===a.declaredClass||"esri.layers.CSVLayer"===a.declaredClass))},isHostedTileService:function(a){var b=/(https?:)?\/\/services.*\.arcgis\.com/i;return!("esri.layers.ArcGISTiledMapServiceLayer"!==a.declaredClass||!b.test(a.url))},getField:function(a,b,c){if(a.getField)return a.getField(b);
if(c&&c.fields){var e;r.forEach(c.fields,function(d){d.name===b&&(e=d)});return e}return null}});C.mixin(ha,{ALIGN_LEFT:0,ALIGN_RIGHT:1});w("extend-esri")&&C.setObject("dijit.Legend",ha,H);return ha});