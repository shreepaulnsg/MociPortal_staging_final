// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
require({cache:{"url:esri/dijit/editing/templates/TemplatePicker.html":'\x3cdiv class\x3d"templatePicker"\x3e\r\n\r\n  \x3ctable dojoType\x3d"dojox.grid.DataGrid" noDataMessage\x3d"${emptyMessage}" selectionMode\x3d"none" autoHeight\x3d"${_rows}" autoWidth\x3d"${_autoWidth}"\r\n         query\x3d"{ query: \'*\' }" dojoAttachPoint\x3d"grid" class\x3d"grid"\x3e\r\n  \x3c/table\x3e\r\n  \r\n\x3c/div\x3e'}});
define("esri/dijit/editing/TemplatePicker","dojo/_base/declare dojo/_base/lang dojo/_base/connect dojo/_base/html dojo/_base/array dojo/_base/json dojo/_base/kernel dojo/has dojo/query dojo/sniff dojo/dom-class dojo/dom-construct dojo/dom-geometry dojo/dom-style dijit/_Widget dijit/_Templated dojo/data/ItemFileReadStore dojox/grid/DataGrid dojox/gfx ../../layers/FeatureLayer ../../symbols/SimpleMarkerSymbol ../../symbols/PictureMarkerSymbol ../../symbols/SimpleFillSymbol ../../symbols/SimpleLineSymbol ./TemplatePickerItem ../../kernel ../../lang ../../request ../_EventedWidget dojo/i18n!../../nls/jsapi dojo/text!./templates/TemplatePicker.html".split(" "),function(I,
t,r,B,l,C,D,v,W,J,E,F,w,x,K,L,M,N,X,O,G,y,H,P,Q,R,z,S,T,U,V){var A=I([T,K,L],{declaredClass:"esri.dijit.editing.TemplatePicker",widgetsInTemplate:!0,templateString:V,featureLayers:null,items:null,grouping:!0,showTooltip:!1,maxLabelLength:0,rows:4,_rows:0,columns:3,surfaceWidth:30,surfaceHeight:30,emptyMessage:"",useLegend:!0,legendCache:{},_uniqueId:{id:0},_assumedCellWidth:90,_initialAutoWidth:300,_initialAutoHeight:200,_ieTimer:150,constructor:function(a,b){a=a||{};a.items||a.featureLayers||console.error("TemplatePicker: please provide 'featureLayers' or 'items' parameter in the constructor");
this._dojo14x=4<=D.version.minor;this._itemWidgets={};a.featureLayers&&a.featureLayers.length&&(this._flChanged=1);this._nls=U.widgets.templatePicker;this.emptyMessage=a.emptyMessage||this._nls&&this._nls.creationDisabled||""},postMixInProperties:function(){this.inherited(arguments);this._preprocess()},startup:function(){this.inherited(arguments);if("auto"===this.rows&&"auto"===this.columns){var a=w.getContentBox(this.domNode);a.w||(this.domNode.style.width=this._initialAutoWidth+"px");if(!a.h||1>=
a.h)this.domNode.style.height=this._initialAutoHeight+"px";a=w.getContentBox(this.domNode);this._columns=Math.floor(a.w/this._assumedCellWidth)||1}this._applyGridPatches();this._setGridLayout();r.connect(this.grid,"onRowClick",this,this._rowClicked);this._setGridData();this._toggleTooltip();9>v("ie")&&(this._repaintItems=t.hitch(this,this._repaintItems),setTimeout(this._repaintItems,this._ieTimer))},destroy:function(){this.showTooltip=!1;this._toggleTooltip();this._clearLegendInfo();this.featureLayers=
this.items=this.grid=this._flItems=this._itItems=this._groupRowIndices=this._selectedCell=this._selectedInfo=this._selectedItem=null;this.inherited(arguments)},getSelected:function(){return this._selectedCell?this._selectedItem:null},clearSelection:function(){var a=this._selectedCell,b=this._selectedInfo;a&&this._rowClicked({cellNode:a,rowIndex:b.selRow,cellIndex:b.selCol})},update:function(a){a="auto"===this.rows&&"auto"===this.columns&&a?!0:!1;var b=this.grid;if(a){var c=this.domNode;var d=D.query("#"+
c.id+".templatePicker div.item")[0];c=w.getContentBox(c);d=(d=d&&d.parentNode)?B.coords(d).w:this._assumedCellWidth;this._columns=(this._columns=Math.floor((c.w-b.views.views[0].getScrollbarWidth())/d))||1}d=this._rows;this._preprocess();var e=this._rows;this._setGridLayout();this._setGridData();e!==d&&b.set("autoHeight",this._rows,!1);a?(b._resize({w:c.w,h:c.h}),b.viewsHeaderNode.style.display="none"):b.update();this._toggleTooltip();var h=this,k=this.getSelected();k&&b.store.fetch({onComplete:function(g){var f=
(g=h._locate(k,h._selectedInfo,g))&&b.views.views[0].getCellNode(g[0],g[1]);f&&h._rowClicked({cellNode:f,rowIndex:g[0],cellIndex:g[1]},!0)}});9>v("ie")&&setTimeout(this._repaintItems,this._ieTimer);a=this.featureLayers;c=this.items;a&&a.length||c&&c.length||!b||!this.emptyMessage||b.showMessage(this.emptyMessage)},_eventMap:{"selection-change":!0},onSelectionChange:function(){},_setUseLegendAttr:function(a){var b=this.useLegend;this._started&&b===a||(a?this._flChanged=1:this._clearLegendInfo());this.useLegend=
a},_setFeatureLayersAttr:function(a){var b=this.featureLayers;this._started&&b===a||(this._flChanged=1);this.featureLayers=a},_adjustRowsCols:function(a){if("auto"===this.rows&&"auto"===this.columns)this._started||(this._rows=!1,this._columns=null,this._autoWidth=!1);else{var b=0;this._rows=this.rows;this._columns=this.columns;"auto"===this.rows?(this.featureLayers?this.grouping?(b=a.length,l.forEach(a,function(c){b+=Math.ceil(c.length/this.columns)},this)):(l.forEach(a,function(c){b+=c.length},this),
b=Math.ceil(b/this.columns)):b=Math.ceil(a.length/this.columns),this._rows=b):"auto"===this.columns&&(this.featureLayers?this.grouping?b=3:(l.forEach(a,function(c){b+=c.length},this),b=Math.ceil(b/this.rows)):b=Math.ceil(a.length/this.rows),this._columns=b)}},_preprocess:function(){this.items&&(this.grouping=!1);this._autoWidth=!1;if("auto"===this.rows||"auto"===this.columns)this._autoWidth=!0;if(this.featureLayers)if(this.useLegend&&this._flChanged&&(this._legendIndices=[],this._loadingIndices=[],
this._legendSymbols={},this._ignoreLegends(),this._loadingLegends=[],clearTimeout(this._legendTimer),this._legendTimer=null,this._processSelectionLayers(),this._flChanged=0),l.every(this.featureLayers,function(c){return c.loaded})){this.featureLayers=l.filter(this.featureLayers,function(c){return!(c.hasZ&&!c.enableZDefaults)});var a=this._flItems=this._getItemsFromLayers(this.featureLayers);this._adjustRowsCols(a)}else{var b=this.featureLayers.length;l.forEach(this.featureLayers,function(c){if(c.loaded)b--;
else var d=r.connect(c,"onLoad",this,function(){r.disconnect(d);d=null;b--;b||this.update()})},this)}else a=this._itItems=this._getItemsFromItems(this.items),this._adjustRowsCols(a)},_processSelectionLayers:function(){var a,b,c,d,e,h,k,g={};l.forEach(this.featureLayers,function(f,n){f.mode===O.MODE_SELECTION&&f._map&&f.url&&f._params.drawMode&&!f.source&&(b=t.trim(f._url.path).replace(/\/(MapServer|FeatureServer).*/ig,"/MapServer").replace(/^https?:\/\//ig,"").toLowerCase(),c=g[b]=g[b]||{},d=c.featureLayers=
c.featureLayers||{},h=c.indices=c.indices||[],d[n]=f,h.push(n),a=f._map)});a&&l.forEach(a.layerIds,function(f){(f=a.getLayer(f))&&f.url&&(f.getImageUrl||f.getTileUrl)&&f.loaded&&10.1<=f.version&&(b=t.trim(f._url.path).replace(/(\/MapServer).*/ig,"$1"),e=b.replace(/^https?:\/\//ig,"").toLowerCase(),g[e]&&!g[e].mapServiceUrl&&(c=g[e],c.mapServiceUrl=b,c.mapServiceLayer=f,this._legendIndices=this._legendIndices.concat(c.indices),k=this._fetchLegend({pickerInstance:this,info:c},e),k.then?(this._loadingIndices=
this._loadingIndices.concat(c.indices),this._loadingLegends.push(k)):this._processLegendResponse(k,c)))},this)},_fetchLegend:function(a,b){var c=A.prototype,d=c.legendCache[b];d?d.then&&d._contexts.push(a):(d=c.legendCache[b]=S({url:a.info.mapServiceUrl+"/legend",content:{f:"json"},callbackParamName:"callback"}),d._contexts=[a],d.addBoth(function(e){if(!d.canceled){c.legendCache[b]=e;var h=d._contexts;d._contexts=null;l.forEach(h,function(k){var g=k.pickerInstance;k=k.info;if(!g._destroyed){l.forEach(k.indices,
function(n){f=l.indexOf(g._loadingIndices,n);-1<f&&g._loadingIndices.splice(f,1)});var f=l.indexOf(g._loadingLegends,d);-1<f&&g._loadingLegends.splice(f,1);g._processLegendResponse(e,k)}})}}));return d},_clearLegendInfo:function(){clearTimeout(this._legendTimer);this._ignoreLegends();this._legendIndices=this._loadingIndices=this._legendSymbols=this._loadingLegends=this._legendTimer=null},_ignoreLegends:function(){this._loadingLegends&&l.forEach(this._loadingLegends,function(a){var b=-1;l.some(a._contexts,
function(c,d){c.pickerInstance===this&&(b=d);return-1<b},this);-1<b&&a._contexts.splice(b,1)},this)},_processLegendResponse:function(a,b){if(!a||a instanceof Error){var c;l.forEach(b.indices,function(e){c=l.indexOf(this._legendIndices,e);-1<c&&this._legendIndices.splice(c,1)},this)}else l.forEach(b.indices,function(e){var h=b.featureLayers[e].layerId,k,g=b.mapServiceUrl+"/"+h+"/images/",f=b.mapServiceLayer._getToken(),n,m;if(!this._legendSymbols[e]){var u=null;l.some(a.layers,function(p){p.layerId==
h&&(u=p);return!!u});if(u){var q=this._legendSymbols[e]={};l.forEach(u.legend,function(p){if((n=p.values)&&n.length)for(k=0;k<n.length;k++)q[n[k]]=p;else q.defaultSymbol=p;(m=p.url)&&!p._fixed&&(p._fixed=1,-1===m.search(/https?:/)&&(p.url=g+m),f&&-1!==p.url.search(/https?:/)&&(p.url+=(-1<p.url.indexOf("?")?"\x26":"?")+"token\x3d"+f))})}}},this);var d=this;d._started&&!d._legendTimer&&(d._legendTimer=setTimeout(function(){clearTimeout(d._legendTimer);d._legendTimer=null;d._destroyed||d.update()},0))},
_applyGridPatches:function(){var a=this.grid,b=a.adaptWidth,c,d,e;a.adaptWidth=function(){c=this.views.views;for(d=0;e=c[d];d++)x.set(e.headerNode,"display","block");b.apply(this,arguments);for(d=0;e=c[d];d++)x.set(e.headerNode,"display","none")};if(this._dojo14x){if("auto"!==this.rows&&"auto"!==this.columns)var h=r.connect(a,"_onFetchComplete",this,function(){r.disconnect(h);this.grid.set("autoHeight",this._rows)});r.connect(a,"_onDelete",this,this._destroyItems);r.connect(a,"_clearData",this,this._destroyItems);
r.connect(a,"destroy",this,this._destroyItems);(a=a.focus)&&a.findAndFocusGridCell&&(a.findAndFocusGridCell=function(){return!1})}},_setGridLayout:function(){var a=function(h){return function(k,g){return this._cellGet(h,k,g)}},b=t.hitch(this,this._cellFormatter),c=[],d=this._columns,e;for(e=0;e<d;e++)c.push({field:"cell"+e,get:t.hitch(this,a(e)),formatter:b});a={cells:[c]};this.grouping&&(d={field:"groupName",colSpan:d,get:t.hitch(this,this._cellGetGroup),formatter:t.hitch(this,this._cellGroupFormatter)},
a.cells.push([d]));d=this.grid;b=N.prototype.rowsPerPage;d.set("rowsPerPage",this._rows>b?this._rows:b);d.set("structure",a)},_setGridData:function(){var a=[];if(this.grouping){this._groupRowIndices=[];var b,c,d=this._columns;l.forEach(this._flItems,function(h,k){a.push({});k=0===k?0:b+c+1;this._groupRowIndices.push(k);b=k;c=Math.ceil(h.length/d);a=a.concat(this._getStoreItems(h))},this)}else this.featureLayers?(l.forEach(this._flItems,function(h){a=a.concat(h)}),a=this._getStoreItems(a)):a=this._getStoreItems(this._itItems);
var e=new M({data:{items:a}});this.grid.setStore(e)},_toggleTooltip:function(){if(this.showTooltip){if(!this.tooltip){this.tooltip=F.create("div",{"class":"esriMapTooltip"},this.domNode);this.tooltip.style.display="none";this.tooltip.style.position="fixed";var a=this.grid;this._mouseOverConnect=r.connect(a,"onCellMouseOver",this,this._cellMouseOver);this._mouseOutConnect=r.connect(a,"onCellMouseOut",this,this._cellMouseOut)}}else this.tooltip&&(r.disconnect(this._mouseOverConnect),r.disconnect(this._mouseOutConnect),
F.destroy(this.tooltip),this.tooltip=null)},_rowClicked:function(a,b){var c=a.cellNode,d=a.rowIndex;a=a.cellIndex;var e=this._getCellInfo(c,d,a);if(e){var h=this.grid.store;if(!h.getValue(e,"loadingCell")&&(this._selectedCell&&E.remove(this._selectedCell,"selectedItem"),c!==this._selectedCell?(E.add(c,"selectedItem"),this._selectedCell=c,this._selectedItem={featureLayer:h.getValue(e,"layer"),type:h.getValue(e,"type"),template:h.getValue(e,"template"),symbolInfo:h.getValue(e,"symbolInfo"),item:this._getItem(e)},
this._selectedInfo={selRow:d,selCol:a,index1:h.getValue(e,"index1"),index2:h.getValue(e,"index2"),index:h.getValue(e,"index")}):this._selectedCell=this._selectedInfo=this._selectedItem=null,!b))this.onSelectionChange()}},_locate:function(a,b,c){var d=this.grid.store,e=Array(this._columns),h,k=b.index1,g=b.index2,f=b.index,n=a.item;l.some(c,function(m,u){return l.some(e,function(q,p){return(q=d.getValue(m,"cell"+p))&&(n?f===d.getValue(q,"index"):k===d.getValue(q,"index1")&&g===d.getValue(q,"index2"))?
(h=[u,p],!0):!1})});return h},_getCellInfo:function(a,b,c){if(a)return a=this.grid,b=a.getItem(b),a.store.getValue(b,"cell"+c)},_getItem:function(a){var b=this.items;if(b)return b[this.grid.store.getValue(a,"index")]},_cellMouseOver:function(a){var b=this.tooltip,c=a.cellNode,d=this._getCellInfo(c,a.rowIndex,a.cellIndex);if(b&&d){var e=this.grid.store;a=e.getValue(d,"template");var h=e.getValue(d,"type"),k=e.getValue(d,"symbolInfo");e=e.getValue(d,"layer");a=(d=this._getItem(d))&&d.label+(d.description?
": "+d.description:"")||a&&a.name+(a.description?": "+a.description:"")||h&&h.name||k&&k.label+(k.description?": "+k.description:"")||(e&&e.name+": ")+"Default";b.style.display="none";b.innerHTML=a;c=B.coords(c.firstChild);x.set(b,{left:c.x+"px",top:c.y+c.h+5+"px"});b.style.display=""}},_cellMouseOut:function(){var a=this.tooltip;a&&(a.style.display="none")},_destroyItems:function(){var a=this._itemWidgets,b;for(b in a)a[b]&&(a[b].destroy(),delete a[b])},_repaintItems:function(){var a=this._itemWidgets,
b;for(b in a){var c=a[b];c&&c._repaint(c._surface)}},_getStoreItems:function(a){var b=this._uniqueId;a=l.map(a,function(m){return t.mixin({surfaceId:"tpick-surface-"+b.id++},m)});for(var c=a.length,d=0,e={},h=0,k,g=[],f=!0,n=this._columns;d<c;)f=!0,k="cell"+h,e[k]=a[d],d++,h++,0===h%n&&(f=!1,g.push(e),e={},h=0);f&&c&&g.push(e);return g},_getItemsFromLayers:function(a){var b=[];l.forEach(a,function(c,d){b.push(this._getItemsFromLayer(c,d))},this);return b},_getItemsFromLayer:function(a,b){var c=[];
if(this.useLegend&&-1<l.indexOf(this._loadingIndices,b))return[{label:this._nls&&this._nls.loading||"",symbol:null,layer:a,type:null,template:null,index1:b,index2:0,loadingCell:1}];var d=[];d=d.concat(a.templates);l.forEach(a.types,function(g){var f=g.templates;l.forEach(f,function(n){n._type_=g});d=d.concat(f)});d=l.filter(d,z.isDefined);var e=a.renderer;if(e){var h=e.declaredClass.replace("esri.renderer.","");if(0<d.length)l.forEach(d,function(g){var f=g.prototype;if(f){var n;if(n=this._isUnclassedRenderer(e)?
e.infos[0].symbol:e.valueExpression?this._createSimpleSymbol(a):e.getSymbol(f)||this._createSimpleSymbol(a)){var m=null,u;if(!(9>J("ie"))&&g.thumbnail&&g.thumbnail.imageData)m=new y(g.thumbnail);else if(this.useLegend&&-1<l.indexOf(this._legendIndices,b)){if(u=this._legendSymbols&&this._legendSymbols[b])switch(h){case "SimpleRenderer":m=u.defaultSymbol;break;case "UniqueValueRenderer":l.some(e.infos,function(q){q.symbol===n&&(m=u[q.value]);return!!m});break;case "ClassBreaksRenderer":l.some(e.infos,
function(q){q.symbol===n&&(m=u[q.maxValue]);return!!m})}m&&(f=C.fromJson(C.toJson(y.defaultProps)),f.url=m.url,f.imageData=m.imageData,f.contentType=m.contentType,f.width=m.width,f.height=m.height,z.isDefined(f.width)&&z.isDefined(f.height)||(f.width=15,f.height=15),m=new y(f))}c.push({label:this._trimLabel(g.name),symbol:m||n,legendOverride:!!m,layer:a,type:g._type_,template:g,index1:b,index2:c.length})}else switch(h){case "HeatmapRenderer":c.push({label:this._trimLabel(g.name),symbol:new G,legendOverride:!!m,
layer:a,type:g._type_,template:g,index1:b,index2:c.length})}}delete g._type_},this);else{var k=[];"TemporalRenderer"===h&&(e=e.observationRenderer)&&(h=e.declaredClass.replace("esri.renderer.",""));switch(h){case "SimpleRenderer":k=[{symbol:e.symbol,label:e.label,description:e.description}];break;case "UniqueValueRenderer":case "ClassBreaksRenderer":k=e.infos}c=l.map(k,function(g,f){return{label:this._trimLabel(g.label),description:g.description,symbolInfo:t.mixin({constructor:function(){}},g),symbol:g.symbol,
layer:a,index1:b,index2:f}},this)}}return c},_isUnclassedRenderer:function(a){return!!((a.hasVisualVariables("sizeInfo",!1)||a.hasVisualVariables("colorInfo",!1)||a.hasVisualVariables("opacityInfo",!1))&&a.addBreak&&a.infos&&1===a.infos.length)},_createSimpleSymbol:function(a){switch(a.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":var b=new G;break;case "esriGeometryPolyline":b=new P;break;case "esriGeometryPolygon":b=new H;break;default:a.hasXYFootprint&&a.hasXYFootprint()&&
(b=new H)}return b},_getItemsFromItems:function(a){return l.map(a,function(b,c){b=t.mixin({index:c},b);b.label=this._trimLabel(b.label);return b},this)},_trimLabel:function(a){var b=this.maxLabelLength;b&&a&&a.length>b&&(a=a.substr(0,b)+"...");return a||""},_cellGet:function(a,b,c){return c?this.grid.store.getValue(c,"cell"+a):""},_cellFormatter:function(a){if(a){var b=this._itemWidgets,c=this.grid.store,d=c.getValue(a,"surfaceId"),e=b[d];e||(e=b[d]=new Q({id:d,label:c.getValue(a,"label"),symbol:c.getValue(a,
"symbol"),legendOverride:c.getValue(a,"legendOverride"),surfaceWidth:this.surfaceWidth,surfaceHeight:this.surfaceHeight,template:c.getValue(a,"template")}));return e||""}return""},_cellGetGroup:function(a,b){if(!this._groupRowIndices)return"";a=l.indexOf(this._groupRowIndices,a);return b&&-1!==a?(b=this.featureLayers[a])&&(this.groupLabelFunction?this.groupLabelFunction(b):b.name)||"":""},_cellGroupFormatter:function(a){return a?"\x3cdiv class\x3d'groupLabel'\x3e"+a+"\x3c/div\x3e":""}});v("extend-esri")&&
t.setObject("dijit.editing.TemplatePicker",A,R);return A});