// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/Geoenrichment","esri/declare dojo/_base/lang dojo/on dojo/string esri/dijit/geoenrichment/promise/all esri/dijit/geoenrichment/when esri/graphic esri/geometry/jsonUtils esri/tasks/locator esri/tasks/FeatureSet esri/tasks/geoenrichment/GeoenrichmentTask esri/tasks/geoenrichment/EnrichParameters esri/tasks/geoenrichment/RingBuffer esri/tasks/geoenrichment/DriveBuffer esri/tasks/geoenrichment/GeographyLevel esri/tasks/geoenrichment/GeometryStudyArea esri/tasks/geoenrichment/AddressStudyArea esri/tasks/geoenrichment/studyAreaFromJson ./_Invoke ./config ./utils/ArrayUtil ./utils/StudyAreaKeyBuilder ./infographicUtils/bufferTitle ./infographicUtils/DataProvider".split(" "),
function(h,m,n,E,F,G,H,I,J,w,K,L,x,M,y,N,O,z,P,p,A,B,Q,R){function S(a){a=B.studyAreaToJson(a);delete a.returnGeometry;delete a.comparisonLevels;delete a.attributes;return a=JSON.stringify(a)}var t=h(null,{_keys:null,_values:null,_capacity:5,constructor:function(a){this._keys=[];this._values={};a&&(this._capacity=a)},getValue:function(a){return this._values[a]},setValue:function(a,b){this._keys.push(a);this._values[a]=b;this._removeOverflow()},hasValue:function(a){return this._values.hasOwnProperty(a)},
_removeOverflow:function(){if(this._keys.length>this._capacity)for(var a=this._keys.splice(0,this._keys.length-this._capacity),b=0;b<a.length;b++)delete this._values[a[b]]},setCapacity:function(a){this._capacity=a;this._removeOverflow()},toJson:function(){var a={},b;for(b in this._values){var c=this._values[b];void 0===c||null===c||"number"==typeof c&&isNaN(c)||("string"==typeof c||"boolean"==typeof c||"number"==typeof c?a[b]=c:"object"==typeof c&&c.toJson&&(a[b]=c.toJson()))}return{keys:this._keys.slice(),
values:a,capacity:this._capacity}},fromJson:function(a,b){if(a){this._keys=a.keys;this._capacity=a.capacity;this._values={};for(var c in a.values)this._values[c]=b?b(a.values[c]):a.values[c]}}}),u=h(null,{_values:null,constructor:function(a){this._values=new t(a)},getValue:function(a){var b=this.keyToString(a);if(this._values.hasValue(b))return this._values.getValue(b);var c=this;return this.keyToValue(a).then(function(e){c._values.setValue(b,e);return e})},keyToString:function(a){return JSON.stringify(a)},
keyToValue:function(a){throw"Not implemented";},setCapacity:function(a){this._values.setCapacity(a)},toJson:function(){return this._values.toJson()},fromJson:function(a,b){a&&this._values.fromJson(a,b)}}),T=h([u],{keyToString:function(a){return JSON.stringify(a.toJson())},keyToValue:function(a){return(new J(p.locatorUrl)).locationToAddress(a).then(function(b){return E.substitute(p.addressFormat,b.address,function(c){return c||""})},function(b){return""})}}),U=h([u],{_countryValues:null,_geometries:null,
constructor:function(){this._countryValues=new t;this._geometries=new t(3)},keyToValue:function(a){var b=this,c=z(a.studyArea),e=c.returnGeometry;if(e){var f=S(c);var k=this._geometries.hasValue(f)}var q=e&&!k,g=new K(p.server);g.token=p.token;for(var r=null,d=c.comparisonGeographyLevels.length-1;0<=d;d--)"Admin1"==c.comparisonGeographyLevels[d].layerID&&(r=c.comparisonGeographyLevels.splice(d,1)[0]);var C;if(r){var v=JSON.stringify({variables:a.variables,country:a.country});(C=this._countryValues.hasValue(v))||
c.comparisonGeographyLevels.push(r)}d=new L;d.forStorage=!1;d.countryID=a.country;d.variables=a.variables;if(c.returnGeometry=q)d.outSR=c.geometry?c.geometry.spatialReference:a.outSR;d.studyAreas.push(c);return g.enrich(d).then(function(D){var l=D.featureSets[0].features;r&&(C?l.push(b._countryValues.getValue(v)):b._countryValues.setValue(v,l[l.length-1]));e&&(k?l[0].geometry=b._geometries.getValue(f):b._geometries.setValue(f,l[0].geometry));return D.featureSets[0]})},setCapacity:function(a){this.inherited(arguments);
this._countryValues.setCapacity(a)},toJson:function(){var a=this.inherited(arguments);a.countryValues=this._countryValues.toJson();a.geometries=this._geometries.toJson();return a},fromJson:function(a){a&&(this._countryValues.fromJson(a.countryValues,function(b){return new H(b)}),this._geometries.fromJson(a.geometries,function(b){return I.fromJson(b)}),this.inherited(arguments,[a,function(b){return new w(b)}]))}}),V=h([u],{metadata:null,_enrichCache:null,_addressCache:null,constructor:function(a){this._enrichCache=
new U(a);this._addressCache=new T(3)},keyToValue:function(a){var b=this,c=[],e=a.returnAddress;delete a.returnAddress;c.push(this._enrichCache.getValue(a));var f=z(a.studyArea);e&&c.push(this._addressCache.getValue(f.geometry));return F(c).then(function(k){var q=k[0],g=q.features[0];g.attributes[b.metadata.name]||(g.attributes[b.metadata.name]=Q(f.getGeomType(),f.options),e?g.attributes[b.metadata.address]=k[1]:f instanceof O&&(g.attributes[b.metadata.address]=f.address.text));return q})},setCapacity:function(a){this.inherited(arguments);
this._enrichCache.setCapacity(a)},toJson:function(){var a=this.inherited(arguments);a.metadata=m.clone(this.metadata);a.enrichCache=this._enrichCache.toJson();a.addressCache=this._addressCache.toJson();return a},fromJson:function(a){a&&(this.metadata=a.metadata,this._enrichCache.fromJson(a.enrichCache),this._addressCache.fromJson(a.addressCache),this.inherited(arguments,[a,function(b){return new w(b)}]))}});return h("esri.dijit.geoenrichment.Geoenrichment",[R,P],{country:null,returnGeometry:!1,returnAddress:!1,
returnData:!0,studyArea:null,outSR:null,buffer:null,variables:null,levels:null,highestLevel:null,data:null,restartOnDone:!1,requests:null,started:!1,cache:null,constructor:function(){this.buffer=new x;this.cache=new V;this.cache.metadata=this.metadata},getData:function(){return this.data},getGeometry:function(){return this.data.features[0].geometry},isBusy:function(){return this.pendingInvoke("requestData")||this.requests||this.restartOnDone},setBuffer:function(a){this.buffer=a;this.invalidate()},
getBuffer:function(){return this.buffer},setStudyArea:function(a){this.studyArea=a;this.invalidate()},setVariables:function(a){A.arraysEqual(this.variables,a)||(this.variables=a,this.invalidateData())},setGeoLevels:function(a,b){A.arraysEqual(this.levels,a)&&this.highestLevel==b||(this.levels=a,this.highestLevel=b,this.invalidateData())},setReturnAddress:function(a){this.returnAddress!=a&&(this.returnAddress=a)&&this.invalidateData()},setCacheLimit:function(a){this.cache.setCapacity(a)},invalidateData:function(){this.data=
null;this.invalidate()},invalidate:function(){this.pendingInvoke("requestData")||(this.requests?this.restartOnDone=!0:(this.geometry=null,this.invoke("requestData")))},requestData:function(){if(this.studyArea&&this.variables&&this.buffer){this.requests=[];this.started||(n.emit(this,"start"),this.started=!0);var a=this.buffer;var b=!1;if(this.studyArea instanceof N)switch(this.studyArea.geometry.type){case "point":b=this.returnAddress;break;case "polyline":this.buffer instanceof M&&(a=new x);break;
case "polygon":a=null}var c=m.clone(this.studyArea);!c.options&&a&&(c.options=a);if(this.levels)for(a=0;a<this.levels.length;a++)c.comparisonGeographyLevels.push(new y({layerID:this.levels[a]}));this.highestLevel&&c.comparisonGeographyLevels.push(new y({layerID:this.highestLevel}));c.returnGeometry=this.returnGeometry;b=G(this.cache.getValue({country:this.country,variables:this.variables,returnData:this.returnData,studyArea:B.studyAreaToJson(c),outSR:this.outSR,returnAddress:b}));this.requests.push(b);
b.then(m.hitch(this,this.handleResponse),m.hitch(this,this.handleError))}},stop:function(){this.restartOnDone=!1;this.cancelInvoke("requestData");if(this.requests)for(var a=this.requests.slice(0),b=0;b<a.length;b++)a[b].cancel()},handleResponse:function(a){try{this.data=a,this.data.features[0].attributes.isThisArea=!0,this.onDone(null)}catch(b){this.onDone(b)}},handleError:function(a){this.onDone(a)},onDone:function(a){this.requests=null;a?"CancelError"!==a.name&&(console.log(a),n.emit(this,"error",
a)):n.emit(this,"data");this.restartOnDone?(this.invalidate(),this.restartOnDone=!1):(n.emit(this,"end"),this.started=!1)}})});