// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/utils/requests/UniversalClient","dojo/_base/lang esri/dijit/geoenrichment/Deferred dojo/request/xhr dojo/io-query dojo/sniff esri/dijit/geoenrichment/when esri/kernel esri/config esri/lang esri/urlUtils ../UrlUtil ./BinaryData ./FileContent ./MultipartDataBuilder ./ErrorUtil".split(" "),function(n,r,B,C,D,E,t,A,F,u,v,G,H,I,y){function J(a,b){if(b)this.reject(b);else{b=a.xhr;var c=b.getResponseHeader&&b.getResponseHeader("Content-Type");a.status=b.status;a.data=new G(b.response||
b.responseBody||b.responseText,c);this.resolve(a)}}var K=0,L=D("safari"),l=function(a){"string"===typeof a?this.url=a:"object"===typeof a&&n.mixin(this,a)};l.prototype={url:null,preventCache:null,usePost:!1,timeout:0,multipartThreshold:0,useCommonAuth:!1,useProxy:!1,allowSSL:null,send:function(a,b){return this.sendUrlRequest(this.prepareUrlRequest(a,b),"UniversalClient.send")},prepareUrlRequest:function(a,b){"string"===typeof a?a={urlSuffix:a}:a||(a={});b||(b={});var c=a.url||this.url;a=a.urlSuffix;
c||(c=a,a=null);if(!c)throw Error("URL is missing.");var d=u.urlToObject(c);c=v.combine(d.path,a);a=d.query||{};"object"===typeof b.content&&(a=n.mixin(a,b.content));d=b.requireSSL;!0!==d&&!1===this.allowSSL&&(d=!1);!1!==d&&!0===this.allowSSL&&/^https/i.test(window.location.protocol)&&(d=!0);var e=this.getCredential(c,!0);e&&(a.token||!1===a.token||(a.token=e.token),e.ssl&&!1!==d&&(d=!0));!0===d&&(c=v.toHttpsUrl(c));!1===a.token&&delete a.token;var h=b.handleAs||"json";"json"===h&&(a.f="json");e=
(b.sendAs||(b.usePost||this.usePost||a.token?"post":"get")).toLowerCase();d="multipart"==e?!0:b.sendAs||b.sizeLimit?!1:null;var f=0,p=b.multipartThreshold||this.multipartThreshold;for(g in a){var m=a[g];if(m instanceof H)d=!0;else{var w=0,z=g.length;"object"===typeof m?b.allowMultipleValues&&Array.isArray(m)?a[g]=m.map(function(q){q="object"===typeof q?JSON.stringify(q):q;w+=z+q+2;return q}):(a[g]=JSON.stringify(m),w+=z+a[g].length+2):w=z+(m?m.length:0)+2;!d&&0<p&&(f+=w)}}!1!==d&&0<p&&f>p&&(d=!0);
if(b.useProxy||!u.hasSameOrigin(c,window.location.href)&&this.useProxy&&!b.hasOwnProperty("useProxy")){var k=v.getProxyUrl();k&&(c=k+"?"+c)}else u.getProxyRule(c)&&(c=u.getProxyRule(c).proxyUrl+"?"+c);var g=(g=b.hasOwnProperty("preventCache")?b.preventCache:this.preventCache)||null===g&&k||L?"_ts\x3d"+(new Date).getTime()+K++:"";k={handleAs:h};if(h=Number(F.isDefined(b.timeout)?b.timeout:this.timeout))k.timeout=h;h="get"!==e||d;e=d?null:C.objectToQuery(a);h||(h=e.length+c.length+g.length+1>=A.defaults.io.postLength);
k.method=h?"POST":"GET";k.headers={"X-Requested-With":null};k.headers["Content-Type"]="undefined"!==typeof b.contentType?b.contentType:"application/x-www-form-urlencoded; charset\x3dutf-8";d?(d=new I,d.addVariables(a),d.build(k)):h?k.data=e:e&&(c+="?"+e,g&&(c+="\x26"+g),g=null);!e&&g&&(c+="?"+g);return{url:c,options:k,sizeLimit:b.sizeLimit}},getCredential:function(a,b){if(t.id){var c=t.id.findCredential(a);!c&&this.useCommonAuth&&(c="string"==typeof this.useCommonAuth?t.id.findCredential(this.useCommonAuth):
t.id.credentials[0]);if(c){var d={token:c.token};b?d.ssl=c.ssl:d.url=c.ssl?v.toHttpsUrl(a):a;return d}}},sendUrlRequest:function(a,b){var c="string"===typeof a.options.data?a.options.data.length:null;if(a.sizeLimit&&c&&("function"===typeof a.sizeLimit?a.sizeLimit(c):c>a.sizeLimit))return(new r).reject(Error("SIZE_LIMIT_EXCEEDED"));b=b||"UniversalClient.sendUrlRequest";var d=a.deferred||new r;if(c="bin"===a.options.handleAs)a.options.handleAs="blob";var e=B(a.url,a.options,!0);c&&(e.handleResponse=
J);var h=this;e.then(function(f){f="json"===a.options.handleAs&&f&&y.parseError(f)||f;if(f instanceof Error){var p;!0===h.useCommonAuth&&498===f.code&&(p=l.handleInvalidTokenError(f));E(p)["finally"](function(){d.reject(f)})}else d.resolve(h._makeResponse(b,f))},function(f){d.reject(y.makeError(f))});return d.promise},requestToUrl:function(a){if(a.options.headers&&a.options.headers["Content-Type"]&&0==a.options.headers["Content-Type"].indexOf("multipart/form-data"))return null;var b=a.url;if(a=a.options.data){if(b.length+
a.length>=A.defaults.io.postLength)return null;b+="?"+a}return b},_makeResponse:function(a,b){return b}};l.makeError=y.makeError;l.handleInvalidTokenError=function(a){};var x=new l({useCommonAuth:!0,allowSSL:!0});l.request=function(a,b){return x.send(a,b).otherwise(function(c){var d=b&&b.content&&b.content.token;if(498!==c.code||null!=d)return(new r).reject(c);b=n.mixin({},b);b.content=n.mixin({},b.content);b.content.token=!1;return x.send(a,b)})};l.requestPublicFirst=function(a,b,c){var d=n.mixin({},
b);d.content=n.mixin({},b.content);d.content.token=!1;return x.send(a,d).otherwise(function(e){return c&&c.retryOnAnyError||499===e.code||403===e.code?x.send(a,b):(new r).reject(e)})};return l});