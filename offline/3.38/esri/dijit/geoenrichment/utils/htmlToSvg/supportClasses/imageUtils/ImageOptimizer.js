// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/utils/htmlToSvg/supportClasses/imageUtils/ImageOptimizer",["esri/dijit/geoenrichment/when","esri/dijit/geoenrichment/promise/all","esri/dijit/geoenrichment/utils/ImageUtil","esri/dijit/geoenrichment/utils/async/AsyncQueue"],function(m,q,t,u){var r={},v=/["']data:image.*?["']/ig,w={analyze:function(g,d){function c(a){var b={text:a,images:(a.match(v)||[]).map(function(n){return n.replace(/["']/g,"")}),size:a.length,totalImagesSize:0,noImageSize:0,newText:"",newSize:0},
e=0,p=a;b.images.forEach(function(n){e+=n.length;p=p.replace(n,"")});b.totalImagesSize=e;b.noImageSize=p.length;f+=b.size;h+=b.noImageSize;k+=b.totalImagesSize;return b}var f=0,h=0,k=0,l=[];return m(u.executeFunctions(g.map(function(a){return function(){var b=c(a);l.push(b)}}),0),function(){var a=1;f>d&&(a=Math.sqrt((d-h)/k));return{infos:l,factor:a,sumSize:f}})}};r.optimizeSize=function(g,d){return d?m(w.analyze(g,d),function(c){function f(k){h++;c.infos.forEach(function(a){a.newText=a.text;a.newSize=
a.size});var l;return q(c.infos.map(function(a){return q(a.images.map(function(b){l=!0;return t.scaleImage(b,{factor:c.factor*k}).then(function(e){a.newText=a.newText.replace(b,e);a.newSize=a.newText.length})})).then(function(){return a.newText})})).then(function(a){var b=0;c.infos.forEach(function(e){b+=e.newSize});if(l)return b<=d?(console.log("SVG string has been optimized "+c.sumSize/1E6+" \x3d\x3e "+b/1E6+" Mb with "+h+" iteration(s)."),a):f(k-.1);console.log("SVG can't be optimized.");return a})}
if(1<=c.factor)return m(g);var h=0;return f(.9)}):m(g)};return r});