// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/DataBrowser/VariableStore","dojo/_base/declare dojo/_base/lang dojo/_base/array esri/dijit/geoenrichment/Deferred dojo/store/util/SimpleQueryEngine dojo/store/util/QueryResults ./DeferredStore ./KeywordFilter".split(" "),function(v,l,k,w,x,y,u,z){return v(null,{categories:null,dataCollections:null,favorites:null,idProperty:"fullName",_data:null,_variables:null,queryEngine:x,constructor:function(){this.categories=new u({syncQuery:l.hitch(this,this._queryCategories)});
this.dataCollections=new u({syncQuery:l.hitch(this,this._queryDataCollections)})},_queryCategories:function(a,c){a=this._cleanUpCountryID(a);if("object"==typeof a&&a.dataCollectionID){var b=this.dataCollections.get(a.dataCollectionID);delete a.dataCollectionID;b=b?b.categories:[]}else b=this.categories.data;return this.categories.queryEngine(a,c)(b)},_queryDataCollections:function(a,c){a=this._cleanUpCountryID(a);if("object"==typeof a&&a.categoryID){var b=this.categories.get(a.categoryID);delete a.categoryID;
b=b?b.dataCollections:[]}else b=this.dataCollections.data;return this.dataCollections.queryEngine(a,c)(b)},_cleanUpCountryID:function(a){"object"==typeof a&&(a=l.mixin({},a),"countryID"in a&&delete a.countryID);return a},_clearAllStores:function(){this._data=[];this._variables={};this.categories.setData();this.dataCollections.setData()},synchronize:function(a){return(new w).resolve()},get:function(a){return this._variables[a]||null},getIdentity:function(a){return a&&a[this.idProperty]||null},query:function(a,
c){return this._asyncQuery(a,c)},_asyncQuery:function(a,c,b){return y(u.resolveCallback(b&&b._resolver||this.categories.resolver,a,l.hitch(this,this._syncQuery,a,c,b)))},_syncQuery:function(a,c,b){var d={},e=[b&&b.queryFilter||l.hitch(this,this.queryFilter)];if("function"==typeof a)e.push(a);else{a=a||{};var f;for(f in a)switch(f){case "countryID":break;case "categoryID":case "dataCollectionID":d[f]=a[f];break;case "searchString":var q=new z(a[f]);e.push(function(h){return q.match(h)});break;case "favorites":var g=
a[f];g&&(g=b&&"undefined"!==typeof b.favorites?b.favorites:this.favorites,e.push(l.hitch(this,function(h){return g&&g.contains&&g.contains(this.getIdentity(h))})));break;case "filters":var p=this._prepareFilterHash(a[f]);p&&e.push(function(h){for(var r in h.filteringTags)if(p[r]||p["*"])return!0;return!1});break;case "additionalData":var n=a[f];break;default:var m=m||{};m[f]=a[f]}m&&e.push(function(h){for(var r in m){var t=m[r];if(t&&t.test){if(!t.test(h[r],h))return!1}else if(t!=h[r])return!1}return!0})}a=
this._composeQuery(e);return d.dataCollectionID?this._queryDCVariables(d.dataCollectionID,a,c,n):d.categoryID?this._queryCategoryVariables(d.categoryID,a,c,n):this._queryAllVariables(a,c,n)},_queryDCVariables:function(a,c,b,d){var e=this.dataCollections.get(a);!e&&d&&(e=d.getDataCollection(a));return e&&this._query(e.getVisibleVariables(),c,b)||[]},_queryCategoryVariables:function(a,c,b,d){var e=this.categories.get(a);!e&&d&&(e=d.getCategory(a));return e&&this._query(e.data,c,b)||[]},_queryAllVariables:function(a,
c,b){return this._query(this._data,a,c,b&&b.getVariables())},_composeQuery:function(a){return 1==a.length?a[0]:function(c){return k.every(a,function(b){return b(c)})}},queryFilter:function(a){return!a.missedInCategories},_query:function(a,c,b,d){var e=a.length;this._addAdditionalData(a,d);c=this.queryEngine(c,b)(a);a.length=e;return c},_addAdditionalData:function(a,c){k.forEach(c,function(b){b instanceof Array?this._addAdditionalData(a,b):b&&a.push(b)},this)},getPopularVariables:function(a,c,b){return a&&
a.getPopularVariables?a.getPopularVariables(c,b):[]},getRefineFilters:function(a){var c={};if(a.dataCollectionID){var b=this.dataCollections.get(a.dataCollectionID);!b&&a.additionalData&&(b=a.additionalData.getDataCollection(a.dataCollectionID));b&&b.filters&&this._combineFilters(b.filters,c)}else a.categoryID?(b=this.categories.get(a.categoryID),!b&&a.additionalData&&(b=a.additionalData.getCategory(a.categoryID)),b&&this._collectCategoryFilters(b,c)):this._collectAllFilters(c,a.additionalData);if((a=
this._prepareFilterHash(a.filters))&&!a["*"]){b=c;c={};for(var d in b)a[d]&&(c[d]=b[d])}return c},_prepareFilterHash:function(a){"string"==typeof a&&(a=a.split(","));if(!a||!a.length)return null;var c={};k.forEach(a,function(b){c[l.trim(b)]=!0});return c},_collectAllFilters:function(a,c){k.forEach(this.categories.data,function(b){this._collectCategoryFilters(b,a)},this);k.forEach(c&&c.getCategories(),function(b){this._collectCategoryFilters(b,a)},this)},_collectCategoryFilters:function(a,c){k.forEach(a.dataCollections,
function(b){this._combineFilters(b.filters,c)},this)},_combineFilters:function(a,c){for(var b in a){var d=a[b],e=c[d.id];e?this._mergeFilter(e,d):(e=l.mixin({},d),c[d.id]=e)}},_mergeFilter:function(a,c){if(a.type==c.type)if("Range"==a.type){var b=a.rangeMin,d=c.rangeMin;!isNaN(b)&&!isNaN(d)&&b>d&&(a.rangeMin=d);b=a.rangeMax;d=c.rangeMax;!isNaN(b)&&!isNaN(d)&&b<d&&(a.rangeMax=d)}else b=this._arrayToObject(a.enumValues.split(",")),d=c.enumValues.split(","),k.forEach(d,function(e){b[e]||(a.enumValues+=
","+e)})},getStates:function(a){return null},_processDataCollections:function(a,c){c=c||{variables:{},categories:{},dataCollections:[]};k.forEach(a,function(b){if(!this._isDataCollectionDisallowed(b)){var d=b.variables||b.data;b=l.mixin({id:b.id||b.dataCollectionID},b.metadata);k.forEach(b.filters,function(f){this._prepareFilter(f)},this);b.filters=this._arrayToObject(b.filters,"id");b.hash={};b.data=b.variables=[];b.hasVariable=function(f){f=f&&f.id;return!(!f||void 0===this.hash[f.toUpperCase()])};
b.getVisibleVariables=function(){return k.filter(this.data,function(f){return this.hash[f.id.toUpperCase()]},this)};var e=[];k.forEach(b.categories,function(f){(f=this._prepareCategory(f,b,c))&&e.push(f)},this);b.categories=e;k.forEach(d,function(f){this._processVariable(f,b,c)},this);c.dataCollections.push(b)}},this);a=this.categories.queryEngine({},{sort:[{attribute:"displayOrder",descending:!0}]})(this._objectToArray(c.categories));this.categories.setData(a);this.dataCollections.setData(c.dataCollections);
return c},_prepareFilter:function(a){"Range"==a.type?(a.rangeMin=Number(a.rangeMin),a.rangeMin||(a.rangeMin=0),a.rangeMax=Number(a.rangeMax)):a.enumValues=this._trimArray(a.enumValues.split(",")).join(",")},_prepareCategory:function(a,c,b){var d=Number(a.displayOrder)||0,e=b.categories[a.id];if(e)e.displayOrder=Math.max(d,e.displayOrder);else{e=a;e.hash={};e.data=[];e.dataCollections=[];e.displayOrder=d;e.popularityHash={};var f=this;e.getPopularVariables=function(q,g){this.popularityArray||(this.popularityArray=
f._objectToArray(this.popularityHash));return f._queryPopularVariables(this.popularityArray,q,g)};b.categories[a.id]=e}e.dataCollections.push(c);return e},_queryPopularVariables:function(a,c,b){var d=this,e=b&&b.queryFilter||this.queryFilter;a=this.queryEngine(function(f){return(f=d.get(f.id))?e(f):!1},c)(a);for(c=0;c<a.length;c++)a[c]=this.get(a[c].id);return a},_processVariable:function(a,c,b){var d=a.popularity;void 0!==d&&(delete a.popularity,d=Number(d));c.categories&&c.categories.length||(a.missedInCategories=
!0);if(!this._isVariableDisallowed(a)){this._prepareVariable(a);var e=this._createUniqueVariableId(a).toUpperCase(),f=c.id+"."+a.id,q=this._isVariableAllowedInCategories(a,c),g=b.variables[e];if(g){b=!a.missedInCategories;e=g.hideInDataBrowser&&a.hideInDataBrowser;var p=g.missedInCategories?a.__sourceDesc||g.__sourceDesc:g.__sourceDesc||a.__sourceDesc;g.missedInCategories&&b&&delete g.missedInCategories;b&&Object.keys(a.filteringTags).length&&(Object.keys(g.filteringTags).length?(l.mixin(a.filteringTags,
g.filteringTags),a.indexBase=g.indexBase||a.indexBase,a[this.idProperty]=g[this.idProperty]):(a[this.idProperty]=f,p=a.__sourceDesc||g.__sourceDesc),l.mixin(g,a));if(g.__sourceDesc=p)g.description=p;g.hideInDataBrowser=!!e}else g=a,g[this.idProperty]=f,b.variables[e]=g,this._data.push(g);this._registerVariable(g,f);f=g[this.idProperty];var n=f.toUpperCase();c.hasVariable(g)||(c.hash[g.id]=!!q,c.data.push(g));q&&k.forEach(c.categories,function(m){m.hash[n]||(m.hash[n]=g,m.data.push(g));if(d){var h=
m.popularityHash[n];h?h.popularity<d&&(h.popularity=d):(h={id:f,popularity:d},m.popularityHash[n]=h)}},this)}},_isDataCollectionDisallowed:function(a){return!a.metadata||!a.metadata.categories},_isVariableDisallowed:function(a){return!a.fieldCategory},_createUniqueVariableId:function(a){return a.id+"."+a.alias},_registerVariable:function(a,c){this._variables[c]=a},_isVariableAllowedInCategories:function(a,c){return!0},_prepareVariable:function(a){a.id=a.id.toUpperCase();a.units=a.units&&a.units.toUpperCase();
a.filteringTags=this._arrayToObject(a.filteringTags,"id");a.percentBase=a.percentBase||null;a.percentBaseAlias=a.percentBaseAlias||null;a.averageBase=a.averageBase||null;a.averageBaseAlias=a.averageBaseAlias||null;a.indexBase=a.indexBase||null;a.__sourceDesc=a.description;a.description||(a.description=a.alias)},_trimArray:function(a){for(var c=0;c<a.length;c++)a[c]=l.trim(a[c]);return a},_objectToArray:function(a){var c=[],b;for(b in a)c.push(a[b]);return c},_arrayToObject:function(a,c){var b={};
k.forEach(a,function(d){b[c?d[c]:d]=d});return b}})});