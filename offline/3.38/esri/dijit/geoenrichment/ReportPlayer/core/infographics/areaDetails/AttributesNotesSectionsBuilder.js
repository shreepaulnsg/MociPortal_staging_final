// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/infographics/areaDetails/AttributesNotesSectionsBuilder","dojo/_base/lang esri/dijit/geoenrichment/promise/all esri/dijit/geoenrichment/when ../../supportClasses/tableJson/TableJsonUtil ../../supportClasses/tableJson/TableJsonResizeUtil ./AreaDetailsLayouts ../../../dataProvider/supportClasses/attachments/AttributesUtil ../../sections/SectionTypes esri/dijit/geoenrichment/utils/FieldUtil dojo/i18n!esri/nls/jsapi".split(" "),function(H,R,I,w,K,L,M,
N,S,F){F=F.geoenrichment.dijit.ReportPlayer.AreaDetailsInfographic;var n={buildDataInfo:function(b){return I(n._calcBuildInfo(b),function(a){if(!a)return null;var e=n._createAttributesSectionJsons(a.attributes,b.infographicJson,b.defaultCellStyle),c=n._createNotesSectionJsons(a.notes,b.infographicJson,b.defaultCellStyle);if(a.canFitOnSinglePage)if(e.length)if(c.length){var d=e[0];c=c[0].stack[0];c.style.top=a.attributes.totalHeight;d.stack.push(c);d=[d]}else d=e;else d=c;else d=[],d=d.concat(e),d=
d.concat(c),d.forEach(function(f){K.resizeTableJsonToFitWidth(f.stack[0],b.width);b.scaleToFitHeight&&K.resizeTableJsonToFitHeight(f.stack[0],a.contentHeight-b.footerHeight)});return d.length?{sectionJsons:d,stats:{numAttributesTotal:a.attributes.numTotal,numAttributesShown:a.attributes.numShown,numNotesTotal:a.notes.numTotal,numNotesShown:a.notes.numShown}}:null})},_calcBuildInfo:function(b){var a=b.infographicJson,e=b.titleHeight,c=b.minRowHeight,d=b.scaleToFitHeight,f=b.footerHeight,g=b.searchTextRe,
l=b.forceSinglePage,m=b.width,u=b.height;return I(n._getData(b),function(q){var h=q.attrs||[],v=q.benchmarkAttrs,k=q.notes||[];a.attributesSectionJson||(h=[]);a.notesSectionJson||(k=[]);if(!h.length&&!k.length)return null;q=h.length;var y=0,G=k.length,x=0;g&&(h=h.filter(function(r){return g.test(r.alias)}),k=k.filter(function(r){return g.test(r.text)}));y=h.length;x=k.length;var p=h.length,z=k.length,A=a.attributesLayout===L.ATTRS_2COLUMNS,O=A?Math.round(h.length/2):h.length,P=(A?Math.round(h.length/
2):h.length)+(a.showAttributesTitle?1:0),J=k.length,Q=J+(a.showNotesTitle?1:0),B=u-e,t=Math.max(c||w.DEFAULT_ROW_HEIGHT,B/(P+Q)),C=p?a.showAttributesTitle?t:0:0,D=p?t:0,E=z?a.showNotesTitle?t:0:0;t=z?t:0;d||(p&&(a.showAttributesTitle&&(p=a.attributesSectionJson.stack[0].rows[0])&&(C=p.style.height),p=a.attributesSectionJson.stack[0].rows[a.showAttributesTitle?1:0])&&(D=p.style.height),z&&(a.showNotesTitle&&(p=a.notesSectionJson.stack[0].rows[0])&&(E=p.style.height),p=a.notesSectionJson.stack[0].rows[a.showNotesTitle?
1:0])&&(t=p.style.height));(z=l||C+D*O+E+t*J<=B+1)?(h=[{attrs:h,numRows:P}],k=[{notes:k,numRows:Q}]):(h=n._splitByPages(h,C,D*(A?.5:1),B,f).map(function(r){return{attrs:r,numRows:(A?Math.round(r.length/2):r.length)+(a.showAttributesTitle?1:0)}}),k=n._splitByPages(k,E,t,B,f).map(function(r){return{notes:r,numRows:r.length+(a.showNotesTitle?1:0)}}));return{canFitOnSinglePage:z,contentHeight:B,attributes:{attrGroups:h,numColumns:A?4:2,titleRowH:C,dataRowH:D,width:m,numTotal:q,numShown:y,totalHeight:C+
D*O,benchmarkAttrs:v},notes:{noteGroups:k,numColumns:1,titleRowH:E,dataRowH:t,width:m,numTotal:G,numShown:x,totalHeight:E+t*J}}})},_getData:function(b){var a=b.attachmentsStore;if(!a)return{};a.supportsMultipleAreas&&a.setCurrentAnalysisAreaIndex(b.currentFeatureIndex);return R([a.getAttributes(),a.getNotes()]).then(function(e){var c={attrs:e[0]||[],notes:e[1]||[]};return b.benchmarkController&&0<=b.benchmarkController.getAreaIndex()&&b.benchmarkController.getAreaIndex()!==b.currentFeatureIndex&&
a.supportsMultipleAreas?(a.setCurrentAnalysisAreaIndex(b.benchmarkController.getAreaIndex()),I(a.getAttributes(),function(d){d&&(c.benchmarkAttrs={},d.forEach(function(f){c.benchmarkAttrs[f.name]=f}));return c})):c})},_splitByPages:function(b,a,e,c,d){var f=c-d,g=[],l,m=0;b.forEach(function(u){l||(l=[],g.push(l),m+=a);l.push(u);m+=e;m+e>f&&(l=null,m=0)});return g},_createAttributesSectionJsons:function(b,a,e){var c=n._getSourceSectionStyle(a.attributesSectionJson,a.showAttributesTitle);return b.attrGroups.map(function(d){function f(v,
k,y){k=k||0;w.modifyTableJson(l,m,0+k,{text:v?v.alias:"",cellStyle:n._getCellStyle(!1,0+k,y,c,e),height:b.dataRowH});var G=M.formatAttributeValue(v),x=b.benchmarkAttrs&&b.benchmarkAttrs[v.name];x&&S.isNumericField(v)&&(x=v.value-x.value,G+=" ("+(0<x?"+":"")+M.formatAttributeValue(H.mixin({},v,{value:x,domain:null}))+")");w.modifyTableJson(l,m,1+k,{text:G,cellStyle:n._getCellStyle(!1,1+k,y,c,e)})}var g=d.attrs;if(!g.length)return null;var l=w.createTable({numColumns:b.numColumns,numRows:d.numRows,
style:{width:b.width},useDefaultHeaderTheme:!1}),m=0;d=a.attributesLayout===L.ATTRS_2COLUMNS;a.showAttributesTitle&&(w.modifyTableJson(l,m,0,{text:c.title||F.attributes,columnSpan:b.numColumns,cellStyle:n._getCellStyle(!0,0,-1,c,e),height:b.titleRowH}),m++);for(var u=0,q=0;q<g.length;q++){var h=g[q];f(h,0,u);d&&(h=g[++q],f(h,b.numColumns/2,u));m++;u++}return{type:N.INFOGRAPHIC_ATTRIBUTES,stack:[l]}}).filter(function(d){return!!d})},_createNotesSectionJsons:function(b,a,e){var c=n._getSourceSectionStyle(a.notesSectionJson,
a.showNotesTitle);return b.noteGroups.map(function(d){var f=d.notes;if(!f.length)return null;var g=w.createTable({numColumns:b.numColumns,numRows:d.numRows,style:{width:b.width},useDefaultHeaderTheme:!1}),l=0;a.showNotesTitle&&(w.modifyTableJson(g,l,0,{text:c.title||F.notes,cellStyle:n._getCellStyle(!0,0,-1,c,e),height:b.titleRowH}),l++);var m=0;f.forEach(function(u){w.modifyTableJson(g,l,0,{text:u.text,cellStyle:n._getCellStyle(!1,0,m,c,e),height:b.dataRowH});l++;m++});return{type:N.INFOGRAPHIC_NOTES,
stack:[g]}}).filter(function(d){return!!d})},_getSourceSectionStyle:function(b,a){var e={titleStyle:null,title:null};if(b){b=b.stack[0];var c=b.columns[0].field,d=0;a&&(a=b.rows[d++])&&(e.titleStyle=a.style.fields[c],e.title=a[c]);for(var f=0;b.rows[d];){var g=b.rows[d++];b.columns.forEach(function(l,m){e["row"+f+"_column"+m]=g.style.fields[l.field]});f++}}return e},_getCellStyle:function(b,a,e,c,d){var f=0!==e%2,g=0!==a%2;b?e=c.titleStyle:(e=c["row"+e+"_column"+a])||(e=f?c["row1_column"+a]||(g?c.row1_column1:
c.row1_column0)||c.row1_column0:c["row0_column"+a]||(g?c.row0_column1:c.row0_column0)||c.row0_column0);a=H.mixin({verticalAlign:"middle",horizontalAlign:g?"right":void 0,horizontalPadding:b||0<a?5:20},d);b&&(a.fontSize*=1.2);H.mixin(a,e);return a}};return n});