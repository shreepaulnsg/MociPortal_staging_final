// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/infographics/locator/LocatorTableInfographic","dojo/_base/declare dojo/_base/lang esri/dijit/geoenrichment/when dojo/string dojo/dom-construct ../paginatableTable/PaginatableTableInfographic ../paginatableTable/SectionJsonsBuilder ../../supportClasses/ViewModes ../../sections/sectionUtils/SectionJsonUtil ../utils/InfographicJsonUtil ./ExportToExcelUtil ./SummaryFooterSectionJsonBuilder ./SummaryCalculator ../../dataDrilling/DataDrillingVisualizer esri/dijit/geoenrichment/utils/ColorUtil esri/dijit/geoenrichment/utils/DomUtil esri/dijit/geoenrichment/utils/FieldUtil esri/dijit/geoenrichment/utils/RegExpUtil dojo/i18n!esri/nls/jsapi".split(" "),
function(l,m,g,u,n,p,h,q,t,v,w,x,y,z,A,r,B,C,f){f=f.geoenrichment.dijit.ReportPlayer.LocatorTableInfographic;l=l(p,{noDataText:f.noLocatorData,hideElementsIfEmpty:!1,_locatorPointsController:null,_areaName:null,_areaShortName:null,_stats:null,_unitedSectionJson:null,_summarySection:null,_summaryFooterSection:null,updateInfographic:function(a){if(this.domNode)return this.canShowEmptyView=!a.showAsSummary,a.locatorCalculatorInfo&&this.viewModel.dynamicReportInfo&&(this.viewModel.dynamicReportInfo.isMultiFeature?
(this._areaName=this.viewModel.dynamicReportInfo.combinedAreasInfo.name,this._areaShortName=this.viewModel.dynamicReportInfo.combinedAreasInfo.shortName):(this._areaName=this.viewModel.dynamicReportInfo.analysisAreas[this.currentFeatureIndex].name,this._areaShortName=this.viewModel.dynamicReportInfo.analysisAreas[this.currentFeatureIndex].shortName),this._locatorPointsController=this.viewModel.getLocatorPointsController(a.locatorCalculatorInfo,this.currentFeatureIndex),this.own(this._locatorPointsController)),
this._summaryFields=a.summaryFooterFields,this.inherited(arguments)},_doUpdateContent:function(){this.domNode&&this.width&&(this.inherited(arguments),this._registerLocatorPointsController())},_buildSectionJsonsAndStat:function(){var a=this,b=h.buildSectionJsonsAndStat({headerSectionJson:this._currentInfographicJson.headerSectionJson,dataSectionJson:this._currentInfographicJson.dataSectionJson,calculatorDataArray:this._getCalculatorDataArray(),filterRanges:this._filterRanges,searchTextRe:this._searchTextRe,
sorting:this._sorting,minRowHeight:this.minRowHeight,scaleToFitHeight:this._currentInfographicJson.scaleToFitHeight,height:this.height,width:this.width,hasTitle:!!this._currentInfographicJson.titleSectionJson,titleHeight:this._getTitleHeight(),hasFooter:this._currentInfographicJson.showNumberOfLocations,footerHeight:p.BOTTOM_AREA_HEIGHT+this._getSummaryFooterHeight(),setAttributeVisibleAt:function(c,d){a._isDataDrillingView()||a._locatorPointsController&&a._locatorPointsController.setPointVisibleAt(c,
d)},allowNoResults:!this.hideElementsIfEmpty});this._stats=b&&b.stats;this._unitedSectionJson=b&&b.unitedSectionJson;return b},_buildStatsOfOtherFeaturesForComparison:function(a){a=this.viewModel.getLocatorPointsController(this._currentInfographicJson.locatorCalculatorInfo,a);return h.buildStats({dataSectionJson:this._currentInfographicJson.dataSectionJson,calculatorDataArray:a.getCalculatorDataArray(),filterRanges:this._filterRanges,allowNoResults:!this.hideElementsIfEmpty})},_resizeSection:function(a){this.isEditMode&&
this.inherited(arguments);var b=a.getTrueTables()[0];this._isDataDrillingView()||this._locatorPointsController&&this._locatorPointsController.registerLocatorTable(b)},_getCalculatorDataArray:function(){return this._locatorPointsController.getCalculatorDataArray()},_renderParts:function(a){var b=this._currentInfographicJson.showAsSummary;r[b?"hide":"show"]([this.paginationDiv,this.summaryFooterDiv,this.pageNavigatorDiv,this.footnoteDiv]);r[b?"show":"hide"]([this.summaryDiv]);this.footnoteDiv.innerHTML=
"";b?(this._renderTitleSection(),this._renderSummarySection()):(this.inherited(arguments),this._renderSummaryFooterSection())},_renderFootNote:function(){var a=this.getNumPointsShown();this.footnoteDiv.innerHTML=this._currentInfographicJson.showNumberOfLocations&&a?1===a?f.oneClosestLocations:u.substitute(f.numClosestLocations,{numPoints:a}):"";this.footnoteDiv.style.color=this.viewModel.getDocumentDefaultStyles(this.theme).color},_getFooterHeight:function(){return(!this._isSinglePage||this._currentInfographicJson.showNumberOfLocations?
p.BOTTOM_AREA_HEIGHT:0)+this._getSummaryFooterHeight()},_getSummaryFooterHeight:function(){return this._summaryFields?2*this.minRowHeight:0},_renderSummaryFooterSection:function(){var a=this;if(this._summaryFields){r.show(this.summaryFooterDiv);var b={};b.initialWidth=this._getPageWidth();b.initialHeight=this._getSummaryFooterHeight()/2;b.json=this._currentInfographicJson.summaryFooterSectionJson||x.buildSummaryFooterSectionJson(this._currentInfographicJson);b.viewModel=this.viewModel;b.theme=this.theme;
b.parentWidget=this;b.noContentOffset=!0;b.tableParams={trimTextIfOverflows:!1,hasResizableColumns:!1,disableResizableColumnsAutoDetection:!0};b.initialViewMode=this.isEditMode?q.EDIT:q.PREVIEW_VALUES;b.getPreviewValueFunction=function(){var d={};a._summaryFields.forEach(function(e){a._stats.ranges.some(function(k){if(k.fieldName===e)return d[e]={value:k&&k.sumShown||0},!0})});return{formattedValue:"",fields:d}};this._columnWidths&&this._columnWidths.forEach(function(d,e){b.json.stack[0].columns[e].style.width=
d});m.mixin(b,this._prepareSummaryFooterSectionCreationParams());this.summaryFooterDiv||(this.summaryFooterDiv=n.create("div",{"class":"esriGEAbsoluteStretched locatorTableInfographic_summaryFooterDiv"},this.dataDiv),this.summaryFooterDiv.style.borderTop="1px solid "+A.getCSSColorWithAlpha(this.viewModel.getDocumentDefaultStyles(this.theme).color,.5),this.summaryFooterLabelDiv=n.create("div",{"class":"esriGEAbsoluteStretched",innerHTML:f.summaryInTable},this.summaryFooterDiv),this.summaryFooterLabelDiv.style.color=
this.viewModel.getDocumentDefaultStyles(this.theme).color,this.summaryFooterSectionDiv=n.create("div",{"class":"esriGEAbsoluteStretched"},this.summaryFooterDiv));this.summaryFooterDiv.style.top="auto";this.summaryFooterDiv.style.bottom=this._getFooterHeight()-this._getSummaryFooterHeight()+"px";this.summaryFooterDiv.style.height=this._getSummaryFooterHeight()+"px";this.summaryFooterLabelDiv.style.bottom="auto";this.summaryFooterLabelDiv.style.height=this.summaryFooterLabelDiv.style.lineHeight=this._getSummaryFooterHeight()/
2+"px";this.summaryFooterSectionDiv.style.top="auto";this.summaryFooterSectionDiv.style.height=this._getSummaryFooterHeight()/2+"px";var c=this.viewModel.layoutBuilder.createElement("section",b,this.summaryFooterSectionDiv);c.fitContentNicely();this._summaryFooterSection=c}else r.hide(this.summaryFooterDiv)},_prepareSummaryFooterSectionCreationParams:function(){return null},_onColumnWidthsChanged:function(){this._columnWidths&&this._summaryFooterSection&&(table=this._summaryFooterSection.getTrueTables()[0],
this._columnWidths.forEach(function(a,b){table.columns[b].style.width=a}),table.refresh())},_renderSummarySection:function(){var a=this;if(this._currentInfographicJson.summarySectionJson){var b={};b.initialWidth=this._getPageWidth();b.initialHeight=this.height-this._getTitleHeight();b.json=this._provideDataDrillingForSummarySectionJson();b.viewModel=this.viewModel;b.theme=this.theme;b.parentWidget=this;b.currentFeatureIndex=this.currentFeatureIndex;b.noContentOffset=!0;b.tableParams={trimTextIfOverflows:!1};
b.initialViewMode=this.isEditMode?q.EDIT:q.PREVIEW_VALUES;b.getPreviewValueFunction=function(c){var d=c&&"number"===typeof c.currentFeatureIndex&&c.currentFeatureIndex!==a.currentFeatureIndex,e=d?a._buildStatsOfOtherFeaturesForComparison(c.currentFeatureIndex):a._stats;return{value:y.calculateSummaryValue({count:d?e.numAttributesTotal:e.numAttributesShown,stats:e,json:a._currentInfographicJson,areaIndex:d?c.currentFeatureIndex:a.currentFeatureIndex||0,viewModel:a.viewModel})}};m.mixin(b,this._prepareSummarySectionCreationParams());
this.summaryDiv=this.summaryDiv||n.create("div",{"class":"esriGEAbsoluteStretched"},this.dataDiv);this.summaryDiv.style.top=this._getTitleHeight()+"px";b=this.viewModel.layoutBuilder.createElement("section",b,this.summaryDiv);b.fitContentNicely();this._summarySection=b}},_prepareSummarySectionCreationParams:function(){return null},_provideDataDrillingForSummarySectionJson:function(){var a=t.getSectionJsonInfographic(this._currentInfographicJson.summarySectionJson);delete a.dataDrilling;var b=m.clone(this._currentInfographicJson);
b.showAsSummary=!1;var c=z.DATA_DRILLING_BOX_ZOOM;b=t.createSectionJsonFromInfographicJson(b,c.w,c.h);v.setDataDrilling(a,a.variableTables[0].variable.fieldInfo.templateName,{sectionJson:b});return this._currentInfographicJson.summarySectionJson},_registerLocatorPointsController:function(){this._locatorPointsController&&this._locatorPointsController.setLocatorTableCallbacks({getCellForPointAtFunc:this._getCellForPointAt.bind(this),getPointIndexForCellFunc:this._getPointIndexForCellFunc.bind(this)})},
_getPointIndexForCellFunc:function(a){return a&&h.getAttributeIndexForGridData(a.row)},_getCellForPointAt:function(a){if(!this._currentInfographicJson.showAsSummary){var b=-1,c;this._sectionJsons.some(function(e,k){return e.stack[0].rows.some(function(D){if(h.getAttributeIndexForGridData(D)===a)return b=k,c=e,!0})});if(-1!==b){this.pagination.set("currentPage",b,!0);var d;this._getSectionByJson(c).getTrueTables()[0].getCells().some(function(e){if(h.getAttributeIndexForGridData(e.row)===a)return d=
e,!0});return d}}},_filterRanges:null,_searchText:null,_searchTextRe:null,getFilterRanges:function(){return g(this._updatePromise,function(){return this._stats&&this._stats.ranges}.bind(this))},setFilterRanges:function(a){this._filterRanges=a;return this._updateContent()},setSearchText:function(a){this._searchTextRe=(this._searchText=a)&&C.createRegExp(a,"i",!0);return this._updateContent()},_summaryFields:null,getSummaryInfos:function(){var a=this;return g(this._updatePromise,function(){var b=!a._currentInfographicJson.showAsSummary&&
a._stats&&a._stats.ranges;if(!b)return null;var c=[];b.forEach(function(d){B.isDistanceField(d.fieldName)||c.push({fieldName:d.fieldName,label:d.alias,visible:a._summaryFields&&-1!==a._summaryFields.indexOf(d.fieldName)})});return c})},setVisibleSummaryFields:function(a){this._summaryFields=a&&a.length?a:null;return this._updateContent()},getNumPointsTotal:function(){return this._stats&&this._stats.numAttributesTotal||0},getNumPointsShown:function(){return this._stats&&this._stats.numAttributesShown||
0},getVisualState:function(){return{type:this._currentInfographicJson.type,filterRanges:this._filterRanges,summaryFields:this._summaryFields,searchText:this._searchText,sorting:this._sorting,columnWidths:this._columnWidths}},setVisualState:function(a){if(a)return a.filterRanges&&this.setFilterRanges(a.filterRanges),a.summaryFields&&this.setVisibleSummaryFields(a.summaryFields),a.searchText&&this.setSearchText(a.searchText),a.sorting&&this._setSorting(a.sorting),a.columnWidths&&(this._columnWidths=
a.columnWidths,this._updateContent()),this._updatePromise},canExportToExcel:function(){return!this._isDataDrillingView()&&this.viewModel.canExportToExcel()},exportToExcel:function(){var a=this;return g(this._updatePromise,function(){return g(a.viewModel.prepareExportToExcelParameters({layerID:a._locatorPointsController.getLayerID(),hasMaps:a._locatorPointsController.getMapInfos()&&a._locatorPointsController.getMapInfos().length}),function(b){return a.onShowWaiting(g(a.prepareExportToExcelParameters(b),
function(c){return a.viewModel.exportToExcel(c)}))})})},prepareExportToExcelParameters:function(a){a=a||{};return w.prepareExportParameters({areaName:this._areaName,areaShortName:this._areaShortName,layerName:this._locatorPointsController.getLayerName(),layerID:this._locatorPointsController.getLayerID(),sectionJson:this._unitedSectionJson,mapInfos:this._locatorPointsController.getMapInfos(),exportMaps:a.exportMaps})},toJson:function(){var a=m.clone(this._currentInfographicJson);a.summarySectionJson&&
delete t.getSectionJsonInfographic(a.summarySectionJson).dataDrilling;return a},_isDataDrillingView:function(){return this.parentWidget.parentWidget.parentWidget.parentWidget.isDataDrillingView},_destroySections:function(){this.inherited(arguments);this._stats=null;this._summaryFooterSection&&this._summaryFooterSection.destroy();this._summaryFooterSection=null;this._summarySection&&this._summarySection.destroy();this._summarySection=null}});l.MIN_ROW_HEIGHT=p.MIN_ROW_HEIGHT;return l});