// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/map/ServerMapBuilder","dojo/_base/declare dojo/_base/lang esri/dijit/geoenrichment/promise/all esri/dijit/geoenrichment/Deferred esri/dijit/geoenrichment/when dojo/dom-geometry ./StaticMap ../../../dataProvider/supportClasses/data/AreaDataUtil esri/dijit/geoenrichment/utils/DataUtil esri/dijit/geoenrichment/utils/ImageUtil".split(" "),function(n,x,q,y,z,A,B,C,D,E){n=n(null,{_mapInfos:null,_mapDivId:0,_mapImageInfos:null,constructor:function(b){x.mixin(this,
b);this.reset()},reset:function(){this._mapInfos={};this._mapImageInfos=null},collectAreaMaps:function(b){var a=[];b=b||0;var c=this._mapInfos[b],g;for(g in c){var h=c[g],m=h.node;if(m.parentNode){var k=A.position(m);a.push({areaIndex:b,node:m,x:k.x,y:k.y,position:-1,map:h.map,legend:h.legend,itemId:h.itemId})}}a.sort(function(d,l){return d.x-l.x});a.sort(function(d,l){return d.y-l.y});a.forEach(function(d,l){d.position=l});return a},collectAllAreasMaps:function(){var b=[],a;for(a in this._mapInfos)b=
b.concat(this.collectAreaMaps(a));return b},setFallbackMapImageInfos:function(b){b?(this._mapImageInfos={},b.forEach(function(a){var c=a.areaIndex||0;(this._mapImageInfos[c]=this._mapImageInfos[c]||{})[a.itemId]=a},this)):this._mapImageInfos=null},createMap:function(b,a){a.areaIndex=a.areaIndex||0;return z(this._doCreateMap(b,a))},_doCreateMap:function(b,a){if(a.calculatorFieldName){var c=C.getAreaDataValue({fieldName:a.calculatorFieldName,fieldData:a.fieldData,featureIndex:a.areaIndex});if(c)return"string"===
typeof c?this._createStaticMap({url:E.base64DataToDataURL(c)},b,a):this._createStaticMapFromBase64Json(c,b,a)}},_createStaticMapFromBase64Json:function(b,a,c){var g=this,h=!1,m=[];b.webMapJson.operationalLayers.forEach(function(k){if(k.isComparisonLayer){var d=c.stdPolygonsControllers&&c.stdPolygonsControllers.filter(function(e){return e.getCalculatorName()===k.calculatorName&&(e.currentFeatureIndex||0)===c.areaIndex});if(d&&d.length){var l={},r=[];d.forEach(function(e){function p(){f.forEach(function(t){l[t.StdGeographyLevel+
";"+t.StdGeographyID]=1})}var f=e.getShownFeatureAttributes();if(f&&f.length)p();else{var u=new y,w=function(){v&&v.remove();clearTimeout(F);u.resolve()};var v=e.setShownFeaturesChangedListener(function(){(f=e.getShownFeatureAttributes())&&f.length&&(p(),w())});var F=setTimeout(w,500);r.push(u.promise)}});m.push(q(r).then(function(){var e=k.featureCollection.layers[0].featureSet,p=e.features.length;e.features=e.features.filter(function(f){f=f.attributes;return l[f.StdGeographyLevel+";"+f.StdGeographyID]});
p!==e.features.length&&(h=!0)}))}}});return q(m).then(function(){var k="data:application/json;base64,"+D.base64FromJson(h?b.webMapJson:b.originalString),d=b.fileName+(h?"-modified":"");return g._createStaticMap({url:k,id:d,isWebMapJson:!!d},a,c)})},_createStaticMap:function(b,a,c){var g=b&&new B(b,a);return g&&g.load().then(function(){return g.loaded?{node:a,map:g,itemId:c.webMapId,mapName:c.webMapName,legend:null}:null})},getPlayerZoomScale:function(b){}});n.EXPAND_FACTOR=1.5;return n});