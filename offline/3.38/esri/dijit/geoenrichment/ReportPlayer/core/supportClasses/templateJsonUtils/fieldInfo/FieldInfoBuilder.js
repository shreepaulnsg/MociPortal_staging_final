// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/templateJsonUtils/fieldInfo/FieldInfoBuilder",["./utils","dojo/i18n!esri/nls/jsapi"],function(d,g){function h(a){Object.keys(a).forEach(function(c){var b=a[c];void 0!==b&&null!==b||delete a[c]})}g=g.geoenrichment.dijit.ReportPlayer.ReportPlayer;var f={NUMBER:"n/",createFieldInfoFromCalculator:function(a,c,b){if(!a)return null;a=(c="function"===typeof a.getDescriptionWithType?a:null)?c.variable:a;var e=b&&b.format,l=b&&b.autoformatCurrency,
m=b&&b.calculatorName,n=b&&b.defaultDistanceUnits;b=b&&b.summaryType;var k=c&&c.getToggleGroup&&c.getToggleGroup();b={alias:c?c.getDescriptionWithType()||c.getAliasWithType():a.description||a.alias,hasVariable:!0,variableID:a.id,fullName:a.fullName,fieldCategory:a.fieldCategory,vintage:a.vintage,type:a.type,statefulName:k?k.value:"n/"+a.fullName,summaryType:b};c=c?c.getCalcType().charAt(0):"n";b.name=d.name.createFieldNameFromSource(a,c);e?d.format.setFieldInfoFormat(b,e):(b.decimals=a.precision,
b.showCurrency=!(!l||"n"!==c||!a.units||"CURRENCY"!==a.units.toUpperCase()),b.showPercent=!b.showCurrency&&("p"===c||"n"===c&&a.units&&"PCT"===a.units.toUpperCase()),b.useThousandsSeparator=!0);a.isWebMap&&(b.isWebMap=!0,b.webMapFieldName=a.fieldName,b.webMapField=a.fieldInfo,b.webMapId=a.webMapId,b.layerUrl=a.layerUrl,!e&&a.fieldInfo&&a.fieldInfo.format&&(b.decimals=a.fieldInfo.format.places,b.useThousandsSeparator=!1!==a.fieldInfo.format.digitSeparator));a.customDataCollection&&(b.isCustomDataCollection=
!0,b.customDataCollectionId=a.customDataCollection.id,b.customDataCollectionUrl=a.customDataCollection.url,b.customDataCollectionPortalUrl=a.customDataCollection.portalUrl);a.isSiteAttribute&&(b.isSiteAttribute=!0,b.attribute=a.attribute,b.type=a.attribute.type,!e&&0<a.attribute.places&&(b.decimals=a.attribute.places));a.isDataLayerAttribute&&(b.isDataLayerAttribute=!0,b.layerID=a.layerID,b.layerUrl=a.layerUrl,b.layerName=a.layerName,b.attribute=a.attribute,b.type=a.attribute.type,!e&&0<a.attribute.decimals&&
(b.decimals=a.attribute.decimals),"DISTANCE"===a.attribute.name&&(b.units=a.attribute.units||n||"esriMiles"));b.usedFields=a.usedFields;b.expressionText=a.expressionText;d.name.provideQualifiedFieldInfoTemplateName(b,m);h(b);return b},fieldInfoToVariable:function(a){if(!a.hasVariable)return null;var c={id:a.variableID,fullName:a.fullName,fieldCategory:a.fieldCategory,vintage:a.vintage,type:a.type,precision:a.decimals,usedFields:a.usedFields,expressionText:a.expressionText};a.isWebMap&&(c.isWebMap=
!0,c.fieldName=a.webMapFieldName,c.fieldInfo=a.webMapField,c.webMapId=a.webMapId,c.layerUrl=a.layerUrl);a.isSiteAttribute&&(c.isSiteAttribute=!0,c.attribute=a.attribute);return c},createFieldInfoFromScript:function(a,c){var b=c&&c.format;c=c&&c.calculatorName;a=a||{};a.name=a.name||d.name.DEFAULT_SCRIPT_NAME;a.alias=a.alias||g.scriptNameDefault;a.decimals=Number(a.decimals)||0;var e={};e.name=d.name.createFieldNameFromScript(a);d.name.provideQualifiedFieldInfoTemplateName(e,c);e.script=a;b?d.format.setFieldInfoFormat(e,
b):(e.decimals=Number(a.decimals),e.showCurrency=!1,e.showPercent=!1,e.useThousandsSeparator=!0);h(e);return e},createFieldInfoFromImage:function(a,c){return{isImage:!0,imageJson:a,triggerJson:c}},createFieldInfoFromMap:function(a){return{isMap:!0,mapJson:a}},createFieldInfoFromShape:function(a){return{isShape:!0,shapeJson:a}},createFieldInfoFromChart:function(a){return{isChart:!0,chartJson:a}},createFieldInfoFromInfographic:function(a){return{isInfographic:!0,infographicJson:a}},createFieldInfoFromSection:function(a){return{isReportSection:!0,
sectionJson:a}},createFieldInfoFromMissingVariable:function(a,c){return{name:a&&a.substr(a.indexOf(".")+1),templateName:a,isMissing:!0,alias:c}},createFieldInfoForUnsupportedContent:function(){return{isUnsupportedContent:!0}}},p=/^\[\w+\]$/,q=/\[\w+\]/;f.createFieldInfoFromLabel=function(a,c){if("string"!==typeof a)return null;a=a.trim();var b=p.test(a);if(!c||b){if(!b)return null;a=a.replace(/\[|\]/g,"").toUpperCase();return f.createFieldInfoFromSpecialFieldName(d.fields.uiToTemplate(a))}return q.test(a)?
d.richText.createFieldInfoFromRenderedXMLString(a):null};f.createFieldInfoFromSpecialFieldName=function(a,c){if("string"!==typeof a)return null;a=d.fields.trimTemplateHeaderName(a);a=a.toUpperCase();if("GROUPCOUNT"===a)var b={name:d.fields.GROUPCOUNT_FIELD_NAME,alias:d.fields.GROUPCOUNT_FIELD_ALIAS,type:"esriFieldTypeInteger"};else"LOCATORSUMMARY"===a?(b={name:d.fields.LOCATORSUMMARY_FIELD_NAME,alias:d.fields.LOCATORSUMMARY_FIELD_ALIAS,type:"esriFieldTypeDouble",templateName:d.fields.LOCATORSUMMARY_FIELD_NAME},
c&&Object.assign(b,d.format.processFieldInfoTagAttributes({m:"string"===typeof c?c:d.format.buildFormatStringFromObject(c)}))):"CURRDATE"===a?b={name:d.fields.DATE_FIELD_NAME,alias:d.fields.DATE_FIELD_ALIAS,format:c||d.fields.DATE_FIELD_DEFAULT_FORMAT}:"SITENOTES"===a?b={name:d.fields.qualifyTemplateHeaderName(d.fields.SITENOTES_FIELD_NAME),alias:d.fields.SITENOTES_FIELD_ALIAS,type:"esriFieldTypeString"}:0===a.indexOf("SITENOTE")&&(b=d.fields.getSiteNoteFieldNameAt(a.replace("SITENOTE","")),b={name:d.fields.qualifyTemplateHeaderName(b),
alias:b,type:"esriFieldTypeString"});if(b)return b;var e=d.fields.templateToUIHeader(a);e?(b={name:d.fields.qualifyTemplateHeaderName(a),alias:e,type:"esriFieldTypeString"},d.fields.isChartAttribute(a)&&(b.isChartAttribute=!0),"CHART_POINT_VALUE"===a&&(b.type="esriFieldTypeDouble",b.decimals=0,b.useThousandsSeparator=!0,c&&d.format.setFieldInfoFormat(b,c))):(c=d.fields.templateToUIReportVar(a))&&(b={name:c,alias:c,type:"esriFieldTypeString"});b&&(b.templateName=b.name);return b};var r=/(\(%\)|: Percent)$/;
f.isFieldInfoInPercentState=function(a){return a?a.statefulName&&0===a.statefulName.indexOf("p/")||a.alias&&r.test(a.alias):!1};return f});