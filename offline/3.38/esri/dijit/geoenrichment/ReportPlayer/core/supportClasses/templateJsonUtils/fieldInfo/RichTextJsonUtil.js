// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/templateJsonUtils/fieldInfo/RichTextJsonUtil",["./utils","esri/dijit/geoenrichment/ReportPlayer/countryConfig"],function(l,r){var f={_wrapFieldInfoInRichText:function(a){return"["+a.name+"]"},_updateXMLString:function(a,b,c){return a.replace(new RegExp("\\["+b+"\\]","g"),c)},isDTagFieldInfo:function(a){return a&&(a.hasVariable||a.script||0===a.name.indexOf("headers."))}},t=/<d .*?\/>|<d\/>/,u=/<text.*?\/>/,n=/<reporttitle.*?\/>/i,p=
/<reportname.*?\/>/i,q=/<reporttitle2.*?\/>/i;f.createFieldInfoFromRichText=function(a,b,c){a=a||"";b=b||[];for(var g={},d=0;d<b.length;d++){var e=b[d];var h="Title"===e.name&&n.test(a)?n:"Name"===e.name&&p.test(a)?p:"Subtitle"===e.name&&q.test(a)?q:f.isDTagFieldInfo(e)?t:u;a=a.replace(h,f._wrapFieldInfoInRichText(e));g[e.name]=e}if(c&&c.length){var k={};c.forEach(function(m){a=a.replace(new RegExp('hreff\x3d"'+m.templateName+'"'),'hreff\x3d"'+m.name+'"');k[m.name]=m})}return{isRichText:!0,richTextJson:{fieldInfos:g,
linkFieldInfos:k,xmlString:a}}};f.createRichTextFromFieldInfo=function(a,b){a=a.richTextJson;var c=a.xmlString,g;for(g in a.fieldInfos){var d=a.fieldInfos[g],e=b.getFieldInfoTagString(d);c=f._updateXMLString(c,d.name,e||"")}for(g in a.linkFieldInfos)d=a.linkFieldInfos[g],e=(e=b.getLinkFieldInfoTagString(d))||"",c=c.replace(new RegExp('hreff\x3d"'+d.name+'"',"g"),b.actualLink?'href\x3d"'+e+'" target\x3d"_blank"':'hreff\x3d"'+e+'"');return c};f.updateXMLString=function(a,b){b.forEach(function(c){a.richTextJson.xmlString=
f._updateXMLString(a.richTextJson.xmlString,c.nameBefore,"["+c.name+"]")})};f.addFieldInfosToRichTextFieldInfo=function(a,b,c){c=c||{};var g=a.richTextJson;a=b.map(function(h){g.fieldInfos[h.name]=h;return c.insertRendered?l.renderer.renderFieldInfoInTableCell(h).formattedValue:f._wrapFieldInfoInRichText(h)}).join(", ");var d=g.xmlString,e="number"===typeof c.insertIndex?Math.min(d.length,c.insertIndex):d.length;b=d.substr(0,e);d=d.substr(e);c.addSpaces&&b.length&&" "!==b.charAt(b.length-1)&&(b+=
" ");c.addSpaces&&d.length&&!/^(\s|\.|,|:|\))/.test(d)&&(d=" "+d);g.xmlString=b+a+d};f.replaceFieldInfoInRichTextFieldInfo=function(a,b,c){var g=a.richTextJson;g.fieldInfos[b.name]&&-1!==g.xmlString.indexOf(f._wrapFieldInfoInRichText(b))&&(delete g.fieldInfos[b.name],f.updateXMLString(a,[{nameBefore:b.name,name:c.name}]),g.fieldInfos[c.name]=c)};var v={_reCache:{},getRegExp:function(){var a=r.getCurrencySymbol();this._reCache[a]||(this._reCache[a]=new RegExp("[\\"+a+"%]*\\[.+?\\]%*","g"));return this._reCache[a]}};
f.createFieldInfoFromRenderedXMLString=function(a,b){a=f.collectFieldInfosFromRenderedXMLString(a,b);return f.createFieldInfoFromRichText(a._xmlString,a.fieldInfos)};f.collectFieldInfosFromRenderedXMLString=function(a,b){var c={};if(b)for(var g in b.fieldInfos){var d=b.fieldInfos[g];c[l.renderer.renderFieldInfoInTableCell(d).formattedValue]=d}var e=[];(b=a.match(v.getRegExp()))&&b.forEach(function(h){var k=c[h]||l.builder.createFieldInfoFromSpecialFieldName(h.replace(/\[|\]/g,""))||l.builder.createFieldInfoFromLabel(h);
k&&(e.push(k),a=a.replace(h,f.isDTagFieldInfo(k)?"\x3cd/\x3e":"\x3ctext/\x3e"))});return{fieldInfos:e,_xmlString:a}};return f});