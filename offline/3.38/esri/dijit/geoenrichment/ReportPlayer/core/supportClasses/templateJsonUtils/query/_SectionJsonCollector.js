// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/templateJsonUtils/query/_SectionJsonCollector",["dojo/_base/lang","esri/dijit/geoenrichment/utils/MathUtil","esri/dijit/geoenrichment/ReportPlayer/core/grid/coreUtils/GridDataUtil","../../tableJson/TableJsonUtil"],function(y,z,x,A){var u={},B={provideParentInfo:function(b,a,c,d,g,f){t.collectStatistics(a);a:{switch(g){case "floating":var h=a.style.left+f.left;break a;case "page":h=t.calcX(a,c,d)+f.left;break a}h=void 0}a:{switch(g){case "floating":g=
a.style.top+f.top;break a;case "page":g=t.calcY(a,c,d)+f.top;break a}g=void 0}b._parentBox={x:h,y:g,w:t.calcFullWidth(a,c,d),h:t.calcFullHeight(a,c,d)};a=d.field;c.style.fields=c.style.fields||{};c=(c.style.fields[a]=c.style.fields[a]||{}).backgroundColor;b._parentStyle={backgroundColor:c}},sanitize:function(b){t.sanitize(b)}},t={collectStatistics:function(b){if(!b._measureInfo){var a={},c={},d;b.columns.forEach(function(l){d&&(c[d.field]=l);d=l;a[l.field]=l});var g={},f={},h={},m={},k={},e={};b.rows.forEach(function(l,
v){b.columns.forEach(function(q,p){var r=k[p]||0,n=e[v]||0,w=t._getDataHeight(l,q.field);q=t._getFieldWidth(l,q);r+=w;n+=q;k[p]=r;e[v]=n;w=p+"_"+v;f[w]=r;g[w]=n;h[w]=g[p-1+"_"+v]||0;m[w]=f[p+"_"+(v-1)]||0})});b._measureInfo={xPositions:h,yPositions:m,columnsHash:a,nextColumnHash:c}}},calcX:function(b,a,c){c=b.columns.indexOf(c);a=b.rows.indexOf(a);return b._measureInfo.xPositions[c+"_"+a]||0},calcY:function(b,a,c){c=b.columns.indexOf(c);a=b.rows.indexOf(a);return b._measureInfo.yPositions[c+"_"+a]||
0},calcFullWidth:function(b,a,c){c=c.field;var d=t._getFieldWidth(a,b._measureInfo.columnsHash[c]),g=a.columnSpans&&a.columnSpans[c]||1;if(1<g)for(var f,h=0;h<g-1;h++)f=b._measureInfo.nextColumnHash[f?f.field:c],d+=t._getFieldWidth(a,f);return d},_getFieldWidth:function(b,a){b.style.fields=b.style.fields||{};return(b.style.fields[a.field]=b.style.fields[a.field]||{}).width||a.style.width},calcFullHeight:function(b,a,c){c=c.field;var d=b.rows.indexOf(a),g=t._getDataHeight(a,c);a=a.rowSpans&&a.rowSpans[c]||
1;if(1<a)for(var f=d+1,h=0;h<a-1;h++)d=b.rows[f++],g+=t._getDataHeight(d,c);return g},_getDataHeight:function(b,a){b.style.fields=b.style.fields||{};return(b.style.fields[a]=b.style.fields[a]||{}).height||b.style.height},sanitize:function(b){delete b._measureInfo}},C={getIntersectingTableJsonsBehind:function(b,a,c,d,g){function f(e){var l=e.rows[0].fieldInfos[e.columns[0].field];return x.isTextLikeCell(l)||x.isShapeCell(l)||x.isImageCell(l)?z.checkRectsIntersect([c,{x:e.style.left+a.left,y:e.style.top+
a.top,w:A.getTableWidth(e),h:A.getTableHeight(e)}]):!1}function h(e){return z.checkRectsIntersect([c,{x:e.style.left+a.left,y:e.style.top+a.top,w:e.style.width,h:e.style.height}])}var m=[],k=[];b.backgroundFloatingTablesSectionJson&&b.backgroundFloatingTablesSectionJson.stack.forEach(function(e,l){if(-1===d||g||d!==l)if("table"===e.id&&f(e)||"img"===e.id&&h(e))-1===d||g||d>l?m.push(e):k.push(e)});b.foregroundFloatingTablesSectionJson&&b.foregroundFloatingTablesSectionJson.stack.forEach(function(e,
l){if(g&&d===l)return!0;if("table"===e.id&&f(e)||"img"===e.id&&h(e))g&&d>l?m.push(e):k.push(e)});return{elementJsonsBehind:m,elementJsonsAbove:k}}};u.collectSectionJsons=function(b,a){a=a||{};var c=[];if(!b)return[];if(b.sections)return b.sections;if(!b.sectionsTables)return[];a.processSectionJson=a.processSectionJson||function(){};b.sectionsTables.forEach(function(d,g){var f={addBackground:function(){!1!==a.backgroundForeground&&d.backgroundSectionJson&&d.backgroundSectionJson.stack&&c.push(d.backgroundSectionJson)},
addBackgroundTables:function(h){var m=[];!1!==a.floatingTables&&d.backgroundFloatingTablesSectionJson&&d.backgroundFloatingTablesSectionJson.stack.forEach(function(k,e){"table"===k.id&&u._processTableJson(k,m,"floating",b.documentOptions,a,d,e,!1)});h&&m.reverse();m.forEach(function(k){a.processSectionJson(k,{pageIndex:g,source:"foreground",floatingIndex:k.__floatingIndex});delete k.__floatingIndex});c=c.concat(m)},addInGridSections:function(){var h=[];u._processTableJson(d,h,"page",b.documentOptions,
a,d);h.forEach(function(m){a.processSectionJson(m,{pageIndex:g,source:"grid",index:m.__inGridIndex});delete m.__inGridIndex});c=c.concat(h)},addForegroundTables:function(h){var m=[];!1!==a.floatingTables&&d.foregroundFloatingTablesSectionJson&&d.foregroundFloatingTablesSectionJson.stack.forEach(function(k,e){"table"===k.id&&u._processTableJson(k,m,"floating",b.documentOptions,a,d,e,!0)});h&&m.reverse();m.forEach(function(k){a.processSectionJson(k,{pageIndex:g,source:"foreground",floatingIndex:k.__floatingIndex});
delete k.__floatingIndex});c=c.concat(m)},addForeground:function(){!1!==a.backgroundForeground&&d.foregroundSectionJson&&d.foregroundSectionJson.stack&&c.push(d.foregroundSectionJson)}};a.topFirst?(f.addForeground(),f.addForegroundTables(!0),f.addInGridSections(),f.addBackgroundTables(!0),f.addBackground()):(f.addBackground(),f.addBackgroundTables(),f.addInGridSections(),f.addForegroundTables(),f.addForeground())});return c};u._processTableJson=function(b,a,c,d,g,f,h,m){b.rows.forEach(function(k,
e){k.fieldInfos&&b.columns.forEach(function(l,v){var q=k.fieldInfos[l.field];if(q&&q.sectionJson&&q.sectionJson.stack){g.processFieldInfoFunc&&g.processFieldInfoFunc(q);(!1!==g.saveParentInfo||g.populateWithFloatingElementsBehind)&&B.provideParentInfo(q.sectionJson,b,k,l,c,d);if(g.populateWithFloatingElementsBehind){var p=y.clone(q.sectionJson),r;"page"===c?r=C.getIntersectingTableJsonsBehind(f,d,p._parentBox,-1,void 0):"floating"===c&&(r=C.getIntersectingTableJsonsBehind(f,d,p._parentBox,h,m));q=
function(n){n=y.clone(n);n.isContextFloatingElement=!0;n.style.left=n.style.left+d.left-p._parentBox.x;if("table"===n.id)n.style.top=n.style.top+d.top-p._parentBox.y;else if("img"===n.id||"map"===n.id)n.style.top=n.style.top+d.top-p._parentBox.y;return n};l=r.elementJsonsBehind.map(q);r=r.elementJsonsAbove.map(q);p.stack=l.concat(p.stack);p.stack=p.stack.concat(r);a.push(p)}else a.push(q.sectionJson);r=a[a.length-1];"page"===c?r.__inGridIndex=e*b.columns.length+v:r.__floatingIndex=h}})});B.sanitize(b)};
u.getParentBox=function(b){return b&&b._parentBox};u.setParentBox=function(b,a){b._parentBox=a};u.getParentStyle=function(b){return b&&b._parentStyle};return u});