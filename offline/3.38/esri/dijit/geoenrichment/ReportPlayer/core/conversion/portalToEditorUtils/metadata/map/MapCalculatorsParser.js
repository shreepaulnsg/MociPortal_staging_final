// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/conversion/portalToEditorUtils/metadata/map/MapCalculatorsParser",["esri/dijit/geoenrichment/utils/JsonXmlConverter","./MetadataToRendererParser","./MapTagsUtil","esri/dijit/geoenrichment/utils/ImageUtil"],function(e,m,l,n){var k={parseMapCalculators:function(a,b,c){e.queryJson(a,"Maps").forEach(function(d){e.queryJson(d,"Map").forEach(function(f){var g=k._parsePortalLayers(f),h=k._parseStudyAreas(f);g={fieldName:f.attributes.Name,width:Number(f.attributes.Width),
height:Number(f.attributes.Height),defaultBasemapId:g.defaultBasemapId,defaultBasemapName:g.defaultBasemapName,webMapId:g.webMapId,webMapName:g.webMapName,additionalLayerInfos:k._parseAdditionalLayers(f,b),pinSymbolJson:k._parseSiteLayerPinSymbol(f,c),areaSymbolJsons:h.symbolJsons,areaSymbolRamp:h.ramp,mapScale:Number(f.attributes.Scale)||null};b&&(b.metadata.mapImageInfosHash[d.attributes.Name+"."+f.attributes.Name]=g)})})},_parsePortalLayers:function(a){var b;a=e.queryJson(a,"Layer").filter(function(c){return!(!c.attributes.PortalItemId&&
!c.attributes.MapName)});1<a.length&&(b=a.shift());a=a.shift();return{defaultBasemapId:b&&b.attributes.PortalItemId,defaultBasemapName:b&&b.attributes.MapName,webMapId:a&&a.attributes.PortalItemId,webMapName:a&&a.attributes.MapName}},_parseAdditionalLayers:function(a,b){var c=[];e.queryJson(a,/^(Layer|LocatorResultsLayer|ComparisonResultsLayer)$/).filter(function(d){return!!d.attributes.ServiceUrl||"LocatorResultsLayer"===d.name||"ComparisonResultsLayer"===d.name}).forEach(function(d){if(d.attributes.ServiceUrl)c.push({url:d.attributes.ServiceUrl});
else if("LocatorResultsLayer"===d.name){var f=d.tags&&d.tags.filter(function(h){return"Renderer"===h.name})[0],g=b.metadata.locatorCalculatorsHash[d.attributes.CalculatorName];g&&g.isValid&&c.push({isLocatorLayer:!0,layerName:d.attributes.LayerName,calculatorName:d.attributes.CalculatorName,calculatorInfo:g,rendererJson:f&&m.parseRendererJson(f)})}else"ComparisonResultsLayer"===d.name&&((f=(f=d.tags&&d.tags.filter(function(h){return"Renderer"===h.name})[0])&&m.parseRendererJson(f))&&"esriTS"===f.uniqueValueInfos[0].symbol.type?
c[c.length-1].labelRendererJson=f:(g=(g=d.tags&&d.tags.filter(function(h){return"LabelingInfo"===h.name})[0])&&m.parseLabelRendererJson(g),c.push({isComparisonLayer:!0,calculatorName:d.attributes.CalculatorName,rendererJson:f,labelRendererJson:g})))});return c.length&&c},_parseSiteLayerPinSymbol:function(a,b){var c;if(a=e.queryJson(a,"SiteLayer")[0])if((a=e.queryJson(a,"Symbol")[0])&&"Image"===a.attributes.Type)(b=b.getImageData(a.attributes.Name))&&(c={type:"esriPMS",contentType:n.getContentType(b),
imageData:n.base64DataFromDataURL(b),url:a.attributes.Url,width:Number(a.attributes.Width),height:Number(a.attributes.Height),angle:Number(a.attributes.Angle)||0,xoffset:Number(a.attributes.XOffset)||0,yoffset:Number(a.attributes.YOffset)||0});else if(a&&"Marker"===a.attributes.Type){c=(c=e.queryJson(a,"Fill")[0])&&e.queryJson(c,"Color")[0];var d=(b=e.queryJson(a,"Outline")[0])&&e.queryJson(b,"Color")[0];c={type:"esriSMS",style:"esriSMS"+(a.attributes.Style||"Circle"),size:Number(a.attributes.Size),
angle:Number(a.attributes.Angle)||0,xoffset:Number(a.attributes.XOffset)||0,yoffset:Number(a.attributes.YOffset)||0,color:l.parseColorTag(c),outline:b&&{type:"esriSLS",color:l.parseColorTag(d),style:"esriSLS"+(b.attributes.Style||"Solid"),width:void 0===b.attributes.Width?0:Number(b.attributes.Width)}}}return c},_parseStudyAreas:function(a){var b=(a=e.queryJson(a,"StudyAreasLayer")[0])&&e.queryTopJson(a,"SymbolsPalette")[0];a=(b&&e.queryTopJson(b,"Symbol")||[]).map(k._parseAreaSymbol);var c=b&&e.queryTopJson(b,
"SymbolRamp")[0],d;c&&(b=e.queryTopJson(c,"First")[0],c=e.queryTopJson(c,"Last")[0],b=b&&e.queryTopJson(b,"Symbol")[0],c=c&&e.queryTopJson(c,"Symbol")[0],b&&c&&(d=[b,c].map(k._parseAreaSymbol)));return{ramp:d,symbolJsons:a}},_parseAreaSymbol:function(a){var b=e.queryJson(a,"Fill")[0];b=b&&e.queryJson(b,"Color")[0];var c=(a=e.queryJson(a,"Outline")[0])&&e.queryJson(a,"Color")[0];return{type:"esriSFS",style:"esriSFSSolid",color:l.parseColorTag(b)||[0,0,0,1],outline:a&&{type:"esriSLS",color:l.parseColorTag(c),
style:"esriSLS"+(a.attributes.Style||"Solid"),width:void 0===a.attributes.Width?0:Number(a.attributes.Width)}}}};return k});