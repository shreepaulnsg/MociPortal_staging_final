// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/conversion/portalToEditorUtils/metadata/VariableScriptCollector",["esri/dijit/geoenrichment/utils/JsonXmlConverter","../variables/VariableUtil"],function(h,l){var k={getObjects:function(b,d){d=k._getVariableInfo(b,d);b=k._getScriptObjects(b,d.fieldNameToVariableCache);return{variables:d.variables,variableObjects:d.variableObjects,scriptObjects:b}},_getVariableInfo:function(b,d){var e=[];h.queryJson(b,d?/^(RawFields|Fields)$/:"Fields").forEach(function(a){e=
e.concat(h.queryJson(a,/^(Field|PortalField)$/))});var f=[],c=[],g={};e.forEach(function(a){f.push(a.attributes.MapTo);if(a=l.fieldTagToVariable(a,b.attributes.Name))g[a.fieldName]=a,c.push(a)});return{variables:f,variableObjects:c,fieldNameToVariableCache:g}},_getScriptObjects:function(b,d){var e=h.queryJson(b,"Scripts"===b.name?"Fields":"CalculatedFields")[0];e=e&&h.queryJson(e,"Script")||[];"Scripts"===b.name&&(e=e.filter(function(f){return!("STORE_ID"===f.attributes.Name||"AREA_ID"===f.attributes.Name)}));
return e.map(function(f){var c=l.scriptTagToVariable(f,b.attributes.Name);c.usedFields&&(c.usedMapTos=[],c.usedFields.forEach(function(g){var a=d[g];a?a.usedMapTos?c.usedMapTos=c.usedMapTos.concat(a.usedMapTos):c.usedMapTos.push(a.fullName):console.log("Error parsing used fields for "+g)}),d[c.fieldName]=c);return c})}};return k});