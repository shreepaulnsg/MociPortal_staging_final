// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/map/_LiveMapSupport","dojo/_base/declare dojo/aspect dojo/string esri/dijit/geoenrichment/when dojo/dom-construct dojo/query esri/geometry/Extent ../supportClasses/map/legend/LegendController ../supportClasses/templateJsonUtils/query/TemplateJsonQueryUtil ../reportContainerGrid/utils/PageQueryUtil esri/dijit/geoenrichment/utils/DomUtil esri/dijit/geoenrichment/utils/InvokeUtil esri/dijit/geoenrichment/utils/WaitingUtil esri/dijit/geoenrichment/ReportPlayer/PlayerViewModes esri/dijit/geoenrichment/ReportPlayer/config dojo/i18n!esri/nls/jsapi".split(" "),
function(r,t,u,l,p,m,v,w,x,y,z,A,n,q,h,k){k=k.geoenrichment.dijit.ReportPlayer.ReportPlayer;return r(null,{_isPlacingMapFlag:!1,_placeMapPromise:null,_currentMap:null,_locatorPointsControllers:null,_stdPolygonsControllers:null,_legendController:null,_limitedPlacingInfo:null,postCreate:function(){var c=this;if(this.viewModel.dynamicReportInfo){var a=y.getParentReportPlayer(this),b=-1,d=0,f=x.calcNumberOfMaps(this.viewModel.dynamicReportInfo.templateJson,function(e){c.json.calculatorFieldName===e.calculatorFieldName&&
(b=d);d++}),g=this.viewModel.dynamicReportInfo.analysisAreas.filter(function(e){return!e.hidden}).length;(a.viewMode===q.FULL_PAGES||a.viewMode===q.PANELS_IN_STACK)&&g*f>h.maps.maxNumberOfMapsShownAtTheSameTime&&(this._limitedPlacingInfo={numMapsPerArea:f,numVisibleAreas:g,currentIndex:b})}this.inherited(arguments)},getCurrentMap:function(){return this._currentMap},getRenderPromise:function(){return this._placeMapPromise},_placeMap:function(){if(this._limitedPlacingInfo){var c=0;this.viewModel.dynamicReportInfo.analysisAreas.some(function(a,
b){if(this.currentFeatureIndex===b)return!0;!a.hidden&&c++},this);if(1===this._limitedPlacingInfo.numVisibleAreas){if(this._limitedPlacingInfo.currentIndex>=h.maps.maxNumberOfMapsShownAtTheSameTime)return this._showLimitMessage(),null}else if((c+1)*this._limitedPlacingInfo.numMapsPerArea>h.maps.maxNumberOfMapsShownAtTheSameTime)return this._showLimitMessage(),null}return this._placeMapPromise=A.invoke(this,"_doPlaceMap")},_doPlaceMap:function(){function c(){n.removeProgress(a.content);a._finalizePlaceMap();
a._showErrorMessage(!0);a.onMapLoadError()}var a=this;this._showErrorMessage(!1);this._isPlacingMapFlag&&this._finalizePlaceMap();this.content.innerHTML="";this._destroyMap();n.showProgress(this.content);this._isPlacingMapFlag=!0;this._legendController=new w;this._legendController.addCallback(function(b){a.showMapLegend=b;a.onLegendVisibilityChanged()},"mapContainer");this.viewModel.dynamicReportInfo&&this.own(this.viewModel.registerLegendController(this._legendController,this._calculatorFieldName,
this.currentFeatureIndex));this._additionalLayerInfos&&this.viewModel.dynamicReportInfo&&!this._locatorPointsControllers&&(this._locatorPointsControllers=[],this._additionalLayerInfos.forEach(function(b,d){b.index=d;if(b.isLocatorLayer){var f=this.viewModel.getLocatorPointsController(b.calculatorInfo,this.currentFeatureIndex);b.layerName&&f.setLayerName(this._calculatorFieldName,b.layerName);f.setRendererJson(this._calculatorFieldName,b.rendererJson);f.setLayerIndex(this._calculatorFieldName,d);this.own(f);
this._locatorPointsControllers.push(f)}},this),this._stdPolygonsControllers=[],this._additionalLayerInfos.forEach(function(b,d){b.index=d;if(b.isComparisonLayer){var f=function(g){g=a.viewModel.getStdPolygonsController(b.calculatorName,g);g.setRendererJson(a._calculatorFieldName,b.rendererJson);b.labelRendererJson&&g.setLabelRendererJson(a._calculatorFieldName,b.labelRendererJson);g.setLayerIndex(a._calculatorFieldName,d);a.own(g);a._stdPolygonsControllers.push(g)};this.viewModel.dynamicReportInfo.isMultiFeature?
this.viewModel.dynamicReportInfo.analysisAreas.forEach(function(g,e){f(e)}):f(this.currentFeatureIndex)}},this));return l(this._createMapFunc(this.content,{areaIndex:this.currentFeatureIndex,defaultBasemapId:this._defaultBasemapId,defaultBasemapName:this._defaultBasemapName,webMapId:this._webMapId,webMapName:this._webMapName,additionalLayerInfos:this._additionalLayerInfos&&this._additionalLayerInfos.filter(function(b){return!!b.url}),locatorPointsControllers:this._locatorPointsControllers,stdPolygonsControllers:this._stdPolygonsControllers,
thisAreasHighlightController:this.viewModel.getThisAreasHighlightController(),legendController:this._legendController,waitForLoad:!0,extent:this._mapExtentPending,pinSymbolJson:this._pinSymbolJson,areaSymbolJsons:this._areaSymbolJsons,areaSymbolRamp:this._areaSymbolRamp,calculatorFieldName:this._calculatorFieldName}),function(b){a.showMapLegend&&a._legendController.setLegendVisible(!0);a._locatorPointsControllers&&a._locatorPointsControllers.forEach(function(e){e.setMapInfo(a._calculatorFieldName,
b)});a._stdPolygonsControllers&&a._stdPolygonsControllers.forEach(function(e){e.setMapInfo(a._calculatorFieldName,b)});var d=b&&b.map;a._destroyMap();if(!a.domNode&&d)d.destroy();else{a._currentMap=d;a._syncWithPanelScale();for(var f=m("svg",a.domNode),g=0;g<f.length;g++)f[g].style.willChange="auto";d?(a.own(d),n.removeProgress(a.content),a._finalizePlaceMap()):c()}},c)},_finalizePlaceMap:function(){this._isPlacingMapFlag&&(this._isPlacingMapFlag=!1)},_showLimitMessage:function(){if(this.domNode){var c=
p.create("div",{"class":"esriGEReportPlayerPanelErrorMessage",innerHTML:1===this._limitedPlacingInfo.numVisibleAreas?u.substitute(k.mapLimitErrorSingle,[h.maps.maxNumberOfMapsShownAtTheSameTime]):k.mapLimitErrorMulti},this.domNode);c.style.color=this.viewModel.getDocumentDefaultStyles().color;c.style.paddingTop=this.getHeight()/2-20+"px";z.hide(this.contentBlock)}},isLegendVisible:function(){return this.showMapLegend},setLegendVisible:function(c,a){this.showMapLegend=c;return this._legendController&&
this._legendController.setLegendVisible(c,a)},_mapExtentPending:null,getVisualState:function(){return{type:"map",mapExtent:this._currentMap&&this._currentMap.extent&&this._currentMap.extent.toJson(),showLegend:this.isLegendVisible()}},setVisualState:function(c){var a=this;this._mapExtentPending=null;if(c)return l(this.getRenderPromise(),function(){c.mapExtent&&(a._currentMap&&a._currentMap.setExtent?a._currentMap.setExtent(new v(c.mapExtent)):a._mapExtentPending=c.mapExtent);a._syncWithPanelScale();
return l(a._currentMap&&a._currentMap._extentDfd&&a._currentMap._extentDfd.promise,function(){if(void 0!==c.showLegend)return a.setLegendVisible(c.showLegend)})})},notifyShown:function(){},_panelScale:null,_toolbarCreateH:null,notifyPanelScaleChanged:function(c){this._panelScale=c;this._syncWithPanelScale()},_syncWithPanelScale:function(){if(this._currentMap){for(var c,a=this.parentWidget;a&&!a.isSection;)(a=a.parentWidget)&&a.isSection&&(c=a);var b=c&&m(".sectionDynamicSettings_toolbar",c.domNode)[0],
d=b?1:1/this._panelScale,f=32*d+8;this._toolbarCreateH&&this._toolbarCreateH.remove();c&&!b&&(this._toolbarCreateH=t.after(c,"onDynamicSettingsButtonsCreated",this._syncWithPanelScale.bind(this)));[".esriSimpleSliderTR",".HomeButton",".mapNavigationLockButton"].forEach(function(g){var e=m(g,c&&c.domNode||this.domNode)[0];e&&(b&&e.parentNode!==b&&p.place(e,b),".mapNavigationLockButton"===g&&50<this._currentMap.root.clientHeight-(f+e.clientHeight*d)&&(f+=20),b&&(e.style.right="0px"),e.style.top=f+"px",
e.style.transformOrigin="100% 0%",e.style.transform="scale("+d+")",e.style["webkit-transform"]="scale("+d+")",f+=(e.clientHeight+(".esriSimpleSliderTR"===g?2:0))*d+5)},this)}},onLegendVisibilityChanged:function(){},destroy:function(){this._finalizePlaceMap();this._destroyMap();this.inherited(arguments)},_destroyMap:function(){this._currentMap&&(this._currentMap.destroy(),this._currentMap=null)}})});