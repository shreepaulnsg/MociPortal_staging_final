// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/dataProvider/supportClasses/GEUtil","dojo/_base/declare dojo/_base/lang esri/dijit/geoenrichment/Deferred esri/dijit/geoenrichment/when esri/dijit/geoenrichment/promise/all dojox/uuid/generateRandomUuid esri/kernel esri/request esri/urlUtils esri/dijit/geoenrichment/utils/CacheUtil esri/dijit/geoenrichment/utils/requests/FileContent esri/dijit/geoenrichment/utils/requests/UniversalClient esri/dijit/geoenrichment/utils/UrlUtil ./stdGeographies/StdGeographiesModel".split(" "),
function(B,w,t,n,C,D,x,h,E,l,F,u,G,H){function I(a){return p?p:(a=a&&x.id.findCredential(a)||x.id.credentials[0])&&a.token}function g(a,b){var c=E.urlToObject(a);b=w.mixin({f:"json",token:I(a),langCode:dojo.locale},c.query||{},b);for(var d in b)a=b[d],a instanceof F||a&&"object"===typeof a&&(b[d]=JSON.stringify("function"===typeof a.toJson?a.toJson():a));return{url:c.path,taskParams:b}}function f(a){k||(k=new y(m));return!a||k.initialized?k:k.initialize()}var y=B(null,{url:null,_geInfo:null,_capabilities:null,
_supportedOperations:null,constructor:function(a){this._capabilities={};this._supportedOperations={};this.url=a},_initDfd:null,initialized:!1,initialize:function(){var a=this;if(this._initDfd)return this._initDfd.promise;this._initDfd=new t;u.requestPublicFirst(g(this.url).url+"/Geoenrichment",{content:{f:"json"},handleAs:"json"},{retryOnAnyError:!0}).then(function(b){a.initWithJson(b)});return this._initDfd.promise},initWithJson:function(a){this._geInfo=a;this._capabilities={};this._supportedOperations=
{};a.capabilities&&a.capabilities.forEach(function(b){this._capabilities[b.toLowerCase()]=!0},this);a.supportedOperations&&a.supportedOperations.forEach(function(b){this._supportedOperations[b.toLowerCase()]=!0},this);this._initDfd=this._initDfd||new t;this._initDfd.resolve();this.initialized=!0},hasCapability:function(a){return!!this._capabilities[a.toLowerCase()]},addCapability:function(a){this._capabilities[a.toLowerCase()]=!0},supportsOperation:function(a){return!!this._supportedOperations[a.toLowerCase()]},
enrich:function(a){a=g(this.url,a);a.taskParams.AddDerivativeVariables="all";return h({url:a.url+"/Geoenrichment/Enrich",content:a.taskParams,handleAs:"json"}).then(function(b){return b.results[0].value.FeatureSet||[]})},stdGeographyQuery:function(a){a=g(this.url,a);return h({url:a.url+"/StandardGeographyQuery/execute",content:a.taskParams,handleAs:"json"}).then(function(b){return b.results[0].value.features||[]})},getDataCollections:function(a,b,c){c=g(this.url,c);return h({url:c.url+"/Geoenrichment/DataCollections/"+
a+(b?"/"+b:""),content:c.taskParams,handleAs:"json"}).then(function(d){return d.DataCollections})},getCountries:function(){var a=g(this.url);return h({url:a.url+"/Geoenrichment/Countries",content:a.taskParams,handleAs:"json"}).then(function(b){return b.countries})},getCountryInfo:function(a){var b=this,c=l.get("GEUtil.countries");if(!c[a]){var d=g(this.url);c[a]=h({url:d.url+"/Geoenrichment/Countries/"+a,content:d.taskParams,handleAs:"json"}).then(function(q){var r=q.countries[0],z={};return C(r.hierarchies.map(function(A){return n(b._getStdGeographyModel(a,
A.ID),function(J){z[A.ID]=J})})).then(function(){return{country:r,geographiesModels:z}})})}return c[a]},_getStdGeographyModel:function(a,b){var c=l.get("GEUtil.stdModels"),d=a+b;if(!c[d]){var q=g(this.url);c[d]=h({url:q.url+"/Geoenrichment/StandardGeographyLevels/"+a+"/"+b,content:q.taskParams,handleAs:"json"}).then(function(r){return new H({countryID:a,hierarchyID:b,levels:r.geographyLevels[0].hierarchies[0].levels})})}return c[d]},formatReport:function(a){a=g(this.url,a);return u.request({url:a.url,
urlSuffix:"Geoenrichment/FormatReport"},{handleAs:"bin",content:a.taskParams}).then(function(b){return b&&b.data&&"text/plain"===b.data.type?null:b})},getReports:function(a){var b=g(this.url);return h({url:b.url+"/Geoenrichment/reports/"+a,content:b.taskParams,handleAs:"json"}).then(function(c){return c.reports})},createReport:function(a){var b=g(this.url,a),c=D();!1===a.forStorage&&(l.get("GEUtil.tasks")[c]={taskName:"createReport",taskParams:w.clone(a)});return u.request({url:b.url,urlSuffix:"Geoenrichment/createReport"},
{handleAs:"xml"===a.format?"text":"bin",content:b.taskParams}).then(function(d){return{taskID:c,result:d}})},consumeCredits:function(a){var b=l.get("GEUtil.tasks")[a];if(b)return delete b.taskParams.forStorage,delete l.get("GEUtil.tasks")[a],this[b.taskName](b.taskParams)},getLayerInfos:function(a){var b=l.get("GEUtil.dataLayers");b[a]||(b[a]=this._getLayerInfos(a));return b[a]},_getLayerInfos:function(a){var b=g(this.url);return h({url:b.url+"/Geoenrichment/DataLayers/"+a,content:b.taskParams,handleAs:"json"}).then(function(c){return c&&
c.layers||[]}).otherwise(function(c){console.log(c);return[]})},getLayerInfo:function(a,b){var c=l.get("GEUtil.dataLayers"),d=a+"_"+b;c[d]||(c[d]=this._getLayerInfo(a,b));return c[d]},_getLayerInfo:function(a,b){var c=g(this.url);return h({url:c.url+"/Geoenrichment/DataLayers/"+a+"/"+b,content:c.taskParams,handleAs:"json"}).then(function(d){return d&&d.layer}).otherwise(function(d){console.log(d);return null})}}),e={},m,p,v=new t;e.setGeoenrichmentUrl=function(a,b){(m=a||m)&&G.registerCORS(m);p=b||
p;!v.promise.isFulfilled()&&v.resolve()};e.canMakeRequests=function(){return!!m};e.getInitPromise=function(){return v.promise};e.GEClient=y;var k;e.getClient=function(){return f()};e.initialize=function(){return n(f(!0))};e.initWithJson=function(a,b){e.setGeoenrichmentUrl(a);f().initWithJson(b)};e.enrich=function(a){return f().enrich(a)};e.stdGeographyQuery=function(a){return f().stdGeographyQuery(a)};e.getDataCollections=function(a,b,c){return f().getDataCollections(a,b,c)};e.formatReport=function(a){return f().formatReport(a)};
e.createReport=function(a){return f().createReport(a)};e.consumeCredits=function(a){return f().consumeCredits(a)};e.getLayerInfos=function(a){return f().getLayerInfos(a)};e.hasCapability=function(a){return n(f(!0),function(){return k&&k.hasCapability(a)})};e.addCapability=function(a){return f().addCapability(a)};e.supportsOperation=function(a){return n(f(!0),function(){return k&&k.supportsOperation(a)})};e.getCountryInfo=function(a){return f().getCountryInfo(a)};return e});