// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/dataProvider/supportClasses/ReportDataProcessor","esri/dijit/geoenrichment/when esri/dijit/geoenrichment/promise/all esri/dijit/geoenrichment/Deferred ./tasks/EnrichAreasTask ./tasks/RunReportTask ./data/AreaCalculatorsUtil ./data/VariablesUtil ./CustomReportsManager ./stdGeographies/StdGeographiesModel esri/dijit/geoenrichment/utils/DateUtil ../../core/supportClasses/templateJsonUtils/fieldInfo/FieldLibrary ../../core/supportClasses/templateJsonUtils/fieldInfo/FieldInfoNameUtil ../../core/supportClasses/templateJsonUtils/query/TemplateJsonQueryUtil ../../core/supportClasses/templateJsonUtils/TemplateJsonAnalyzer ../../core/infographics/utils/InfographicJsonUtil ../../config ../../countryConfig".split(" "),
function(n,p,q,v,w,k,x,y,z,r,t,u,A,B,C,m,l){return{runReportAndGetData:function(a,c){return p([y.getCustomReportByID(a),c]).then(function(d){var b=d[0];d=d[1];return(new w).execute({portalUrl:a.portalUrl,analysisAreas:a.analysisAreas,countryID:a.countryID,hierarchy:a.hierarchy,report:{reportID:b.reportID,portalUrl:b.templateData.getPortalUrl(!0),modified:b.modified,isMultiFeature:b.isMultiFeature},attachmentsStore:d,cacheResult:m.runReportTask.cacheResult}).then(function(f){return{taskIDs:f.taskIDs,
areaData:f.areaData,reportInfo:f.reportInfo}},function(f){a.fieldData.errors.push(f);return(new q).reject(f)})})},runReportFromVariables:function(a){var c={};a.variables.fullNames.forEach(function(d){var b=u.createFieldNameFromSource(d);c[d.substr(d.indexOf(".")+1)]=b});return(new v).enrichAreas({portalUrl:a.portalUrl,analysisAreas:a.analysisAreas,countryID:a.countryID,hierarchy:a.hierarchy,fields:x.convertForEnrich(a.variables),comparisonLevels:a.comparisonLevels||C.getDefaultLevels()}).then(function(d){var b=
a.analysisAreas.map(function(){return{}});k.addEnrichFeatures(d,c,u.DATA_COLLECTIONS_CALCULATOR_NAME,b);return{areaData:b}},function(d){a.fieldData.errors.push(d);return(new q).reject(d)})},applyRunReportAndGetDataResults:function(a,c){if(a&&a.areaData){var d=c.templateJson;c.fieldData.specialTradeAreaCalculatorName=d.metadata&&d.metadata.specialTradeAreaCalculatorName;delete d.metadata;c.fieldData.runReportTaskIDs=a.taskIDs;c.fieldData.areaData=a.areaData;(c.fieldData.reportInfo=a.reportInfo)&&this._populateReportDataFromReportInfo(a.reportInfo,
c);this._reportDataFromAreas(c.analysisAreas,c.fieldData.areaData);this._reportDataFromReport(c.reportObject,c.fieldData,c.combinedAreasInfo);return this._populateReportDataFromAttachmentsStore(c)}},_populateReportDataFromReportInfo:function(a,c){c.reportTitle=c.reportObject.title=c.reportTitle||a.Title||a.Name||"";c.fieldData.metadata.Name=a.Name||c.reportTitle;a.country&&!l.getCurrentCountry()&&(l.setCountry(a.country),l.setHierarchyID(null));a.stdLevels&&!l.getGeographiesModel()&&l.setGeographiesModel(new z({levels:a.stdLevels}));
if(m.updateVariableInfoFromDataXml||m.isPlayerOnServer){var d=a.variables;A.processTemplateFieldInfos(c.templateJson,function(b){if(b.hasVariable&&b.variableID&&b.templateName){var f=b.templateName.indexOf("."),e=b.templateName.substr(0,f);f=b.templateName.substr(f+1);(e=d[e]&&d[e][f])&&e.alias&&(b.alias=e.alias,b=c.templateVariableProvider.get(b.templateName))&&(b.alias=e.alias,e.vintage&&(b.vintage=e.vintage),e.source&&(b.source=e.source))}})}a=B.collectVariablesStats(c.templateJson);a=c.templateVariableProvider.getVariablesDataVintageAndSources({usedVariablesCache:a});
c.reportObject.dataVintageDescription=a.dataVintageDescription||c.reportObject.dataVintageDescription;c.reportObject.dataSources=a.dataSources||c.reportObject.dataSources;c.reportObject.dataVintage=a.dataVintage||c.reportObject.dataVintage},_populateReportDataFromAttachmentsStore:function(a){var c=a.attachmentsStore,d=[];a.analysisAreas.forEach(function(b,f){c.supportsMultipleAreas&&c.setCurrentAnalysisAreaIndex(f);d.push(n(c.getNotes(),function(e){if(e&&e.length){var g={attributes:{}};g.attributes[t.SITENOTES_FIELD_NAME]=
e.map(function(h){return h.text}).join("\x3cbr/\x3e\x3cbr/\x3e");e.forEach(function(h,D){g.attributes[t.getSiteNoteFieldNameAt(D+1)]=h.text});(e=a.fieldData.areaData[f])&&k.addFeatureAttributesCalculator(g,e)}}));d.push(n(c.getAttributes(),function(e){if(!e||!e.length)return null;var g={attributes:{}};e.forEach(function(h){g.attributes[h.name]=h});(e=a.fieldData.areaData[f])&&k.addFeatureAttributesCalculator(g,e)}))});return p(d)},_reportDataFromAreas:function(a,c){a.forEach(function(d,b){if(b=c[b])k.addFeatureAttributesCalculator(d.feature,
b),k.addAreaInfoCalculator(d,b)})},_reportDataFromReport:function(a,c,d){var b=c.metadata;a&&!b.Title&&(b.Title=a.title);b.Subtitle=c.reportInfo&&c.reportInfo.Subtitle||"";b.Source=b.Source||a.dataVintageDescription||"Esri";b.DataSources=b.DataSources||a.dataSources||"Esri";b.DataVintage=b.DataVintage||a.dataVintage||"";b.Date=r.getReportFooterDate();b.Copyright="\u00a9 "+r.getFullYear()+" Esri";b.ProductLabel="";b.ProductUrl="";b.PhoneNumber="";b.TrialUrlText="";a.isMultiFeature&&(b.SITE_NAME=d.locationName||
d.name,b.STORE_NAME=d.locationName||d.name,b.AREA_DESC2=d.description||d.name,b.STORE_ADDR=d.address)}}});