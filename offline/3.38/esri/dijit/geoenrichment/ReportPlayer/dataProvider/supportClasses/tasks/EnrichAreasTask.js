// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/dataProvider/supportClasses/tasks/EnrichAreasTask","dojo/_base/declare dojo/_base/lang esri/dijit/geoenrichment/when esri/dijit/geoenrichment/promise/all esri/kernel esri/SpatialReference esri/tasks/FeatureSet esri/geometry/Point ../GEUtil ../areas/AnalysisAreaUtil ../attachments/AttributesUtil ../../../core/supportClasses/map/Projector ../../../countryConfig esri/dijit/geoenrichment/utils/CoordinateUtil".split(" "),function(y,m,p,q,u,r,z,v,A,w,B,C,D,
t){function x(a){return(a=a&&u.id.findCredential(a)||u.id.credentials[0])&&a.token}return y(null,{enrichAreas:function(a){var b={};return p(this._analysisAreasToStudyAreas(a.analysisAreas,a.countryID,a.comparisonLevels),function(e){b.studyAreas=e;a.report?b.analysisVariables=[{itemid:a.report.reportID,url:a.report.portalUrl,token:x(a.portalUrl),outFields:["*"]}]:a.fields&&(b.analysisVariables=a.fields);return this._doRunTask(b,a,"enrich")}.bind(this)).then(this._handleFeatureSetsRequest.bind(this))},
createReport:function(a){var b={f:"bin",format:"xml",reportfields:{}};b.report={itemid:a.report.reportID,url:a.report.portalUrl,token:x(a.portalUrl)};return p(this._analysisAreasToStudyAreas(a.analysisAreas,a.countryID,null,a.getAttributes),function(e){b.studyAreas=e;return this._doRunTask(b,a,"createReport")}.bind(this))},_analysisAreasToStudyAreas:function(a,b,e,k){var h=this;e=e&&e.map(function(c){return{layer:c}});return q(a.map(function(c,g){if(c.geographies&&c.geographies.length){var d=h._studyAreaFromGeographies(c.geographies,
b,!0);c.feature&&c.feature.attributes&&(d.attributes=m.mixin({},d.attributes,c.feature.attributes))}else d={attributes:m.mixin({},c.feature.attributes),geometry:c.feature.geometry.toJson()};e&&(d.comparisonLevels=e);return q([h._getStorePointForArea(c),k&&k(c)]).then(function(f){var l=f[0];f=f[1];d.attributes=d.attributes||{};l&&(d.attributes.STORE_LAT=d.attributes.STORE_LAT||l.STORE_LAT,d.attributes.STORE_LONG=d.attributes.STORE_LONG||l.STORE_LONG);d.attributes.STORE_ID=g+"";f&&f.forEach(function(n){d.attributes[n.name]=
B.formatAttributeValueForStudyArea(n)});return d})}))},_getStorePointForArea:function(a){if(a=a.location&&a.location.geometry||a.buffer&&a.buffer.point){a=a instanceof v?a:new v(a);var b=w.geometryToLatLong(a);return b?b:p(C.projectGeometries(a,new r(t.WGS_84_WKID)),function(e){return w.geometryToLatLong(e)})}},createFeatureForGeographies:function(a,b){return this._createFeaturesForGeographies(a,b,!0).then(function(e){return e[0]})},createFeaturesForGeographies:function(a,b){return this._createFeaturesForGeographies(a,
b,!1)},_createFeaturesForGeographies:function(a,b,e){a={returnGeometry:!0,outSR:b.outSR||new r(t.WEB_MERCATOR_WKID),studyAreas:e?[this._studyAreaFromGeographies(a,b.countryID,!0,b.generalizationLevel)]:a.map(function(k){return this._studyAreaFromGeographies([k],b.countryID,!1,b.generalizationLevel)},this),dataCollections:["GlobalIntersect"]};return this._doRunTask(a,b,"enrich").then(this._handleFeatureSetsRequest.bind(this))},_studyAreaFromGeographies:function(a,b,e,k){var h={sourceCountry:b,layer:null,
ids:null},c=null,g=[],d;a.forEach(function(f){if(!f||!f.id)throw Error("Wrong geography.");var l=f.levelId;if(l)if(!c)c=l;else if(e&&c!==l)throw Error("Geographies have different level IDs.");g.push(f.id);f.sourceCountry&&(h.sourceCountry=f.sourceCountry);f.hierarchy&&(h.hierarchy=f.hierarchy);f.attributes&&(d=m.mixin(d||{},f.attributes))});h.layer=c;h.ids=e?[g.join(",")]:g;h.attributes=d;h.generalizationlevel=k;return h},createFeaturesForBuffer:function(a,b){b=b||{};var e={bufferUnits:a.units,bufferRadii:a.radii||
[a.radius],areaType:a.areaType||"RingBuffer"};"NetworkServiceArea"===e.areaType&&(e.travelMode=a.travelMode,e.networkOptions=a.networkOptions);a=a.point||a.polyline;e={returnGeometry:!0,outSR:b.outSR||a.spatialReference||new r(t.WEB_MERCATOR_WKID),dataCollections:["GlobalIntersect"],studyAreasOptions:e,studyAreas:[{geometry:a.toJson?a.toJson():a}]};return this._doRunTask(e,b,"enrich").then(this._handleFeatureSetsRequest.bind(this))},createFeaturesForBuffers:function(a,b){function e(c){var g=c.point||
c.polyline;return JSON.stringify(g.toJson?g.toJson():g)+";"+c.units+";"+c.areaType+";"+c.travelMode+";"+JSON.stringify(c.networkOptions)}var k={},h=[];a.forEach(function(c){var g=e(c),d=k[g],f=!1;if(d){var l=c.radii||[c.radius];d.radii.some(function(n){return-1!==l.indexOf(n)})&&(d=null,f=!0)}d||(d=m.clone(c),f||(k[g]=d),delete d.radius,d.radii=[],h.push(d));c.radii?d.radii=d.radii.concat(c.radii):d.radii.push(c.radius)});return q(h.map(function(c){return this.createFeaturesForBuffer(c,b)},this)).then(function(c){var g=
[];c.forEach(function(d){g=g.concat(d)});return g})},_doRunTask:function(a,b,e){a=m.mixin({useData:{sourceCountry:b.countryID,hierarchy:b.hierarchy||D.getHierarchyID()},forStorage:!1},a);return A[e](a)},_handleFeatureSetsRequest:function(a){return(new z(a[0])).features}})});