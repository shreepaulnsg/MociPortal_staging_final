// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/dataProvider/supportClasses/TemplateJsonLoader","dojo/_base/lang esri/dijit/geoenrichment/Deferred esri/dijit/geoenrichment/when esri/dijit/geoenrichment/utils/CacheUtil ./CustomReportsManager ./GenericTemplateGenerator ./dataCollections/DataCollectionsLoader ../../core/conversion/PortalToEditorConverter ../../core/conversion/portalToEditorUtils/variables/PlayerVariableProvider ../../core/supportClasses/templateJsonUtils/fieldInfo/FieldInfoNameUtil ../../core/conversion/portalToEditorUtils/parsers/_FieldInfoBuilder".split(" "),
function(n,p,l,q,r,t,u,v,m,h,w){var k={_getCache:function(){return q.get("TemplateJsonLoader")},getCachedTemplateJsonPromise:function(a,c){a=a+";"+c.reportID;return(a=this._getCache()[a])&&a.modified===c.modified?a.promise.then(function(d){return{templateJson:n.clone(d.templateJson),templateVariableProvider:d.templateVariableProvider}}):null},putCachedTemplateJsonPromise:function(a,c,d){c=c+";"+d.reportID;this._getCache()[c]={modified:d.modified,promise:a}}};return{getTemplateJsonByID:function(a,
c){var d=this,e=new p;l(r.getCustomReportByID(a),function(b){if(b){var g=c&&k.getCachedTemplateJsonPromise(a.countryID,b);g?g.then(e.resolve,e.reject):(g=d._loadCustomReportData(b).then(function(){var f=new m;return l(v.provideEditorJson(b,{variableProvider:f}),function(){var x=b.templateJson;b.portalJson=null;b.templateJson=null;return{templateJson:x,templateVariableProvider:f}})}),c?(k.putCachedTemplateJsonPromise(g,a.countryID,b),k.getCachedTemplateJsonPromise(a.countryID,b).then(e.resolve,e.reject)):
g.then(e.resolve,e.reject))}else e.reject("Can't find a report")},e.reject);return e.promise},_loadCustomReportData:function(a){a.portalJson=null;return a.templateData.getFiles().then(function(c){a.portalJson={files:c}})},createTemplateJsonFromVariables:function(a){return u.loadVariables({countryID:a.countryID,outFields:["description","precision","type","vintage"],forceLowerCase:!0}).then(function(c){var d=new m,e=c.fullNameToVariableCache;c=a.variables.fullNames.map(function(b){var g=h.createFieldNameFromSource(b),
f=a.variables.customDataMapping[b];f=f?f.variable:e[b];b={id:f.id.toLowerCase(),fullName:b,alias:f.description,fieldName:g,precision:f.precision,calculatorName:h.DATA_COLLECTIONS_CALCULATOR_NAME,templateName:h.DATA_COLLECTIONS_CALCULATOR_NAME+"."+g,type:f.type,vintage:f.vintage};d.addVariable(b);return w.getCalculatorOrScriptFieldInfo(b.templateName,{variableProvider:d})});return{templateJson:t.generateTemplatesFromFieldInfos(c,{comparisonLevels:a.comparisonLevels}),templateVariableProvider:d}})}}});