// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/dataProvider/_ServerSerializationSupport","dojo/_base/declare esri/dijit/geoenrichment/when esri/dijit/geoenrichment/utils/ImageUtil ./supportClasses/ReportDataProcessor ./supportClasses/tasks/parsers/DataXMLParser ./supportClasses/areas/AnalysisAreaUtil ./supportClasses/areas/AnalysisAreaJsonUtil ./supportClasses/areas/AreasPreprocessor ./supportClasses/GEUtil ../core/supportClasses/ReportTemplateTypes ../core/conversion/PortalToEditorConverter ../core/supportClasses/map/WebMapJsonUtil ../core/supportClasses/templateJsonUtils/query/TemplateJsonQueryUtil ./supportClasses/attachments/AttachmentsStoreSerializer ../core/supportClasses/templateJsonUtils/TemplateJsonSerializer ../core/conversion/portalToEditorUtils/variables/PlayerVariableProvider ../core/conversion/portalToEditorUtils/metadata/MetadataFromDataBuilder ../countryConfig".split(" "),
function(B,n,t,C,D,u,v,E,p,F,G,H,I,J,K,L,M,N){return B(null,{reportDataToServerData:function(g){return null},reportDataFromServerData:function(g,w){function O(e){k.some(function(h){return"metadata.xml"===h.name})||k.push({name:"metadata.xml",data:M.recoverMetadataFromAreaData(m.areaData,e)})}function P(e){g.sites=[];var h={},f=1;m.areaData.forEach(function(a){a=a.headers&&a.headers.data||{};var c=a.SITE_NAME||a.STORE_NAME,d=a.STORE_ID||"unclassified."+f++;"number"!==typeof h[d]&&(h[d]=g.sites.length,
g.sites.push({locationName:c,name:null,shortName:null,description:null,address:a.STORE_ADDR,latitude:a.STORE_LAT,longitude:a.STORE_LONG,areas:[]}));g.sites[h[d]].areas.push({locationName:c,name:a.AREA_DESC?c+" ("+a.AREA_DESC+")":c,shortName:a.AREA_DESC,description:a.AREA_DESC2,address:a.STORE_ADDR,latitude:a.STORE_LAT,longitude:a.STORE_LONG,feature:{attributes:{STORE_ID:a.STORE_ID,AREA_ID:a.AREA_ID}}})});g.sites.forEach(function(a){var c=!1;a.shortName=a.areas.map(function(l){return c=!!l.shortName,
l.shortName}).join(", ");c&&(a.name=a.locationName+" ("+a.shortName+")");var d=a.areas.map(function(l){return l.description});a.description=1<d.length?d[0]===d[1]?d[0]:d.join(", "):d[0]||""});m.reportInfo.areaIdToAttachmentsInfo&&g.sites.forEach(function(a){a.areas.forEach(function(c){if(c=m.reportInfo.areaIdToAttachmentsInfo[c.feature.attributes.AREA_ID])a.attributes=a.attributes&&a.attributes.length?a.attributes:c.attributes,a.notes=a.notes&&a.notes.length?a.notes:c.notes,a.images&&a.images.length||
!c.images||(a.images=c.images,a.images.forEach(function(d){function l(b){return(b=e[b])&&t.base64DataToDataURL(b,"image/png")}d.url=l(d.url);d.thumbnail=l(d.thumbnail)}))})})}N.reset();var k=g.reportItem.resources,x;if(!Array.isArray(k)){var y=k;k=[];for(var z in y)k.push({name:z,data:y[z]})}k.forEach(function(e){"theme.css"===e.name&&(e.name="theme.css.txt")});var q=k.filter(function(e){return"report.xml"===e.name})[0],Q=k.filter(function(e){return"data.xml"===e.name})[0],m;(function(){var e=/.*\.(png|jpg|jpeg)$/i,
h=/(.*\.(json)$)|(^maps\/.*\.(png)$)/i,f={},a={};k.forEach(function(b){e.test(b.name)&&(f[b.name]=b.data,"logo.png"===b.name&&(x=t.base64DataToDataURL(b.data,"image/png")));h.test(b.name)&&(-1!==b.data.indexOf("operationalLayers")?a[b.name]=H.processWebMapJson(b.name,b.data):a[b.name]=b.data)});var c={},d=q.data.match(/<section[^<>]*query=("|').+?("|').*?>/g);d&&d.forEach(function(b){b=b.replace(/.*?query=("|')/,"");b=b.replace(/("|').*/,"");c[b]=1});var l={};m=D.parse(Q.data,function(b,r,R){return(b=
a[r])?l[R]=b:f[r]||r});O({map:l,locator:c});P(f)})();var A=new L;return n(function(e){var h=q.data.indexOf("\x3csection"),f={isGraphicReport:q.data.indexOf("\x3ctable")<h,isMultiFeature:!1,type:F.STANDARD,portalJson:{files:k}};return n(G.provideEditorJson(f,{variableProvider:e}),function(){f.templateJson=K.deserialize(f.templateJson);f.isMultiFeature=I.hasMultiFeatureSections(f.templateJson);delete f.portalJson;return f})}(A),function(e){u.parseSites(g);var h=v.areasFromJson(g.analysisAreas),f=g.combinedAreasInfo&&
v.combinedAreasInfoFromJson(g.combinedAreasInfo)||{},a=g.attachmentsProvider&&J.getAttachmentsStoreFromJson(g.attachmentsProvider),c={isMultiFeature:e.isMultiFeature&&1<h.length,reportTitle:null,templateJson:e.templateJson,reportObject:e,fieldData:{specialTradeAreaCalculatorName:null,runReportTaskIDs:null,metadata:{},areaData:[],errors:[],reportInfo:null},analysisAreas:h,combinedAreasInfo:f,reverseAnalysisAreasOnMap:!0,attachmentsStore:a,templateVariableProvider:A,customLogo:x,config:{}};u.populateCombinedAreasInfo(c.combinedAreasInfo,
c.analysisAreas);E.provideAreasIndexes(c);p.setGeoenrichmentUrl(null);w&&w.forEach(function(d){switch(d){case "Maps":p.addCapability("FormatInfographicsMaps");break;case "ImageUrls":p.addCapability("FormatInfographicsImageUrls")}});return n(C.applyRunReportAndGetDataResults(m,c)).then(function(){return c})})}})});