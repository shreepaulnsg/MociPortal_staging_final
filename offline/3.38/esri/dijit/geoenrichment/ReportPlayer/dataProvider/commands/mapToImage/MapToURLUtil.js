// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/dataProvider/commands/mapToImage/MapToURLUtil","require dojo/_base/declare esri/dijit/geoenrichment/Deferred esri/dijit/geoenrichment/when esri/dijit/geoenrichment/promise/all dojo/dom-style esri/dijit/geoenrichment/utils/DataUtil esri/dijit/geoenrichment/utils/ImageInfoUtil esri/dijit/geoenrichment/utils/RegExpUtil esri/dijit/geoenrichment/utils/UrlUtil".split(" "),function(M,N,y,w,O,E,P,Q,z,R){function S(){var a=new y;M("esri/tasks/PrintTask esri/tasks/PrintParameters esri/tasks/PrintTemplate esri/layers/GraphicsLayer ./DotDensityToImageUtil ./LegendToLayerUtil".split(" "),
function(c,d,g,e,h,f){F=d;G=g;H=e;A=h;I=f;J=N(c,{returnJson:!1,mapName:null,_execute:function(){this.returnJson&&(this.printGp.submitJob=this.printGp.execute=function(b,n){b="data:application/json;base64,"+P.base64FromJson(b.Web_Map_as_JSON);n([{value:{url:b}}]);return(new y).resolve()});return this.inherited(arguments)},_getPrintDefinition:function(b,n){var m=this.inherited(arguments);this.returnJson&&this.mapName&&(m.title=this.mapName);console.log(m);return m},_createOperationalLayers:function(b,
n){var m=this.inherited(arguments);if(n.__legendLayerId){var B=m.filter(function(u){return u.id===n.__legendLayerId})[0];m.splice(m.indexOf(B),1);m.push(B)}return m},_createFeatureCollection:function(b,n,m,B){var u=this.inherited(arguments);this.returnJson&&u&&("esri.layers.FeatureLayer"===b.declaredClass||"esri.layers.StreamLayer"===b.declaredClass||"esri.layers.GraphicsLayer"===b.declaredClass)&&u.featureCollection.layers.forEach(function(p){p.layerDefinition.name=b.arcgisProps&&b.arcgisProps.title||
b._titleForLegend||b.name||b.id;p.layerDefinition.name=z.decodeXML(p.layerDefinition.name);p.layerDefinition.objectIdField="OBJECTID";p.layerDefinition.fields=[{name:"OBJECTID",type:"esriFieldTypeOID"}];var K={OBJECTID:1},T=/[^\w]/g,C;p.featureSet.features.forEach(function(k,x){k.attributes=k.attributes||{};k.attributes.OBJECTID=x+1+"";k.attributes.__nameField||(k.attributes.Name=z.decodeXML(k.attributes.Name||p.layerDefinition.name),C="Name");x=k.attributes.__fieldAliases;for(var q in k.attributes)if(0!==
q.indexOf("__")){var D=q,v=k.attributes[q];"string"===typeof v&&(v=z.decodeXML(v));var r=x&&x[q];(r=r&&r.replace(T,"_"))&&void 0===k.attributes[r]&&(k.attributes[r]=v,D=r);k.attributes.__nameField===q&&(C=D);K[q]||(K[q]=1,p.layerDefinition.fields.push({name:D,type:"string"===typeof v?"esriFieldTypeString":"esriFieldTypeDouble"}))}});p.layerDefinition.displayField=C});return u},_convertSvgSymbol:function(b){return b}});a.resolve()});return a.promise}var J,F,G,H,A,I,L,l={setPrintMapTaskUrl:function(a){L=
a;R.registerCORS(a)},mapToURL:function(a,c,d,g){var e=l._getUrlForMap(a);if(e)return e;e=S().then(function(){return l._replaceDotDensityLayersWithPictureMarkers(a).then(function(h){return w(c&&I.legendToGraphicsLayer(c,a,d),function(f){f&&a.addLayer(f);return w(l._runPrintTask(a,d,f,g),function(b){f&&a.removeLayer(f);l._rollbackReplacing(a,h);var n=new y;setTimeout(function(){n.resolve(b.url)},100);return n.promise})})})});l._putUrlToCache(a,e);return e},_replaceDotDensityLayersWithPictureMarkers:function(a){var c=
[];for(i=0;i<a.graphicsLayerIds.length;i++)layer=a.getLayer(a.graphicsLayerIds[i]),layer.loaded&&layer.visible&&A.isDotDensity(layer)&&c.push(l._createGraphicsLayerFromDotDensityLayer(i,layer,a));return O(c)},_createGraphicsLayerFromDotDensityLayer:function(a,c,d){return A.createPictureMarkersFromDotDensityLayer(c,d.extent,d).then(function(g){if(!g)return null;var e=new H;g.map(function(h){e.add(h)});d.addLayer(e,a);c.visible=!1;return{addedLayer:e,hiddenLayer:c}}).otherwise(function(g){console.log(g);
return null})},_runPrintTask:function(a,c,d,g){function e(){var h=new J(L);h.returnJson=g&&g.replaceWithJson;h.mapName=g&&g.mapName;var f=new F;f.map=a;var b=new G;b.exportOptions={width:3.125*E.get(c,"width"),height:3.125*E.get(c,"height"),dpi:300};b.format="png32";b.showAttribution=!1;b.forceFeatureAttributes=!0;b.__legendLayerId=d&&d.id;f.template=b;return h.execute(f)}return w(e(),function(h){return h},function(h){console.log(h);return w(e(),function(f){return f},function(f){console.log(f);return e()})})},
_rollbackReplacing:function(a,c){c.forEach(function(d){d&&d.addedLayer&&a.removeLayer(d.addedLayer);d&&d.hiddenLayer&&(d.hiddenLayer.visible=!0)})},urlToSrc:function(a,c){return c&&c.saveImagesAsDataUrl?Q.getRemoteImageDataUrl(a,{sizeLimit:1500}):a}},t,U=0;l.enableCaching=function(){t={}};l.clearCaching=function(){t=null};l._putUrlToCache=function(a,c){t&&c&&(a.__mapToImageUtilKey=U++,t[a.__mapToImageUtilKey]=c)};l._getUrlForMap=function(a){return t&&t[a.__mapToImageUtilKey]};return l});