// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/dataProvider/commands/mapToImage/MapToImageUtil","dojo/_base/lang esri/dijit/geoenrichment/Deferred esri/dijit/geoenrichment/when dojo/dom-construct esri/dijit/geoenrichment/promise/all ./MapToURLUtil ./_MapReplacer".split(" "),function(v,w,l,x,r,f,t){var g={};g.enableCaching=f.enableCaching;g.clearCaching=f.clearCaching;g.replaceMapWithImage=function(d,b){b=b||{};var c=[],h={errors:[],undo:function(){c.map(function(a){a()})}},m=d.collectMaps({allAreas:!0}),
n=[],k={};return r(m.map(function(a){k[a.areaIndex]=k[a.areaIndex]||1;var y=d.getReportData().isMultiFeature?d.getReportData().combinedAreasInfo.name:d.getReportData().analysisAreas[a.areaIndex].name;b=v.mixin({},b);b.mapName=y+" (Map"+(1<k[a.areaIndex]?" "+k[a.areaIndex]:"")+")";k[a.areaIndex]++;return l(f.mapToURL(a.map,a.legend,a.node,b),function(u){var e=t.replaceMapWithImage(a.node);c.push(e.undo);n.push(a);if(b.replaceWithJson)e.mapImage.src=u;else{var p=new w;e.mapImage.onload=function(){e.mapImage.onload=
e.mapImage.onerror=null;p.resolve()};e.mapImage.onerror=function(q){e.mapImage.onload=e.mapImage.onerror=null;console.log(q);x.destroy(e.mapImage);p.resolve()};l(f.urlToSrc(u,b),function(q){e.mapImage.src=q});return p.promise}})})).always(function(){n.length!==m.length&&(m.forEach(function(a){-1===n.indexOf(a)&&(a=t.replaceMapWithImage(a.node),c.push(a.undo))}),h.errors.push(Error("Some maps can't be exported")));return h})};g.mapInfoToDataUrl=function(d,b){return l(f.mapToURL(d.map,d.legend,d.node,
b),function(c){return f.urlToSrc(c,b)})};g.collectMapsAsImages=function(d,b){d=d.collectMaps({allAreas:!0});return r(d.map(function(c){return l(f.mapToURL(c.map,c.legend,c.node,b),function(h){return f.urlToSrc(h,b)}).otherwise(function(){return null}).then(function(h){return{url:h,itemId:c.itemId,mapName:c.mapName,areaIndex:c.areaIndex,position:c.position}})}))};return g});