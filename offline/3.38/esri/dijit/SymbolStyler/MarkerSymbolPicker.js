// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
require({cache:{"url:esri/dijit/SymbolStyler/templates/MarkerSymbolPicker.html":'\x3cdiv\x3e\r\n  \x3cdiv id\x3d"${id}_typeInput" data-dojo-type\x3d"dijit/form/Select" data-dojo-attach-point\x3d"dap_markerCategoryInput" class\x3d"${css.typeInput}"\x3e\x3c/div\x3e\r\n  \x3cdiv class\x3d"${css.container}" data-dojo-attach-point\x3d"dap_symbolViewport"\x3e\r\n    \x3cdiv data-dojo-attach-point\x3d"dap_templatePicker"\x3e\x3c/div\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e\r\n'}});
define("esri/dijit/SymbolStyler/MarkerSymbolPicker","../../arcgis/Portal ../../domUtils ../../kernel ../../promiseList ../../request ../../symbols/jsonUtils ../_EventedWidget ../_Tooltip ../editing/TemplatePicker ../util/busyIndicator ./symbolUtil dijit/_TemplatedMixin dijit/_WidgetsInTemplateMixin dojo/_base/array dojo/_base/declare dojo/_base/kernel dojo/_base/lang dojo/Deferred dojo/dom-class dojo/dom-construct dojo/dom-style dojo/promise/all dojo/sniff dojo/store/Memory dojo/store/Observable dojox/gfx dojo/i18n!../../nls/jsapi dojo/text!./templates/MarkerSymbolPicker.html dijit/form/Select".split(" "),
function(x,y,z,D,E,u,q,F,G,H,A,I,J,g,K,L,f,r,l,m,M,B,v,C,N,O,w,P){var n={dataUrl:null,id:"customTypes",keywords:"custom symbols",name:w.widgets.symbolEditor.customImages,title:w.widgets.symbolEditor.customImages};q=K("esri.dijit.SymbolStyler.MarkerSymbolPicker",[q,I,J,F],{baseClass:"esriMarkerSymbolPicker",templateString:P,labels:w.widgets.symbolEditor,css:{noSymbols:"esriNoSymbols",defaultSymbols:"esriDefaultSymbols",loadingIndicator:"esriLoadingIndicator",loading:"esriLoading",typeInput:"esriTypeInput",
container:"esriContainer",overlay:"esriOverlay",content:"esriContent",centerContainer:"esriCenterContainer",table:"esriTable",tableCell:"esriTableCell",centerBlock:"esriCenterBlock",customSelected:"esriMarkerSymbolPicker--custom-selected"},portal:"http://arcgis.com/",displayMode:"portal",_symbolTypesStore:null,_symbolItemStore:null,_noSymbolsOverlay:null,_templatePicker:null,_portal:null,_portalLoadTimeoutInMs:3E3,_loadingIndicator:null,_storageItemKeyBase:"markerSymbolPicker/symbol",_defaultSimpleMarkerSymbols:[{name:"Circle",
type:"esriSMS",style:"esriSMSCircle",color:[0,0,128,128],size:18,outline:{color:[0,0,128,255],width:1}},{name:"Square",type:"esriSMS",style:"esriSMSSquare",color:[0,0,128,128],size:18,outline:{color:[0,0,128,255],width:1}},{name:"Diamond",type:"esriSMS",style:"esriSMSDiamond",color:[0,0,128,128],size:18,outline:{color:[0,0,128,255],width:1}},{name:"Cross",type:"esriSMS",style:"esriSMSCross",color:[0,0,128,128],size:18,outline:{color:[0,0,128,255],width:1}},{name:"X",type:"esriSMS",style:"esriSMSX",
color:[0,0,128,128],size:18,outline:{color:[0,0,128,255],width:1}}],postCreate:function(){this.inherited(arguments);this._symbolTypesStore=new N(new C);this._symbolItemStore=new C;this.dap_markerCategoryInput.set({labelAttr:"name",sortByLabel:!1});this.createTooltip(this.dap_markerCategoryInput,this.labels.selectCategoryTooltip)},_toggleCustomItemCss:function(){l.toggle(this.domNode,this.css.customSelected,this.dap_markerCategoryInput.get("value")===n.id)},addCustomImageSymbol:function(a){var b=u.fromJson(a.toJson());
a=JSON.parse(localStorage.getItem(this._getCustomItemKey()))||[];var c=b.url.split("/").pop();g.some(a,function(e){return e.url===b.url})||(b.type="esriPMS",b.name=c,a.push(b),localStorage.setItem(this._getCustomItemKey(),JSON.stringify(a)),this.dap_markerCategoryInput.set("value",n.id),this.clearSelection(),this._fetchSymbols(n.id))},_updateTemplatePickerIfHeightless:function(){0===M.get(this._templatePicker.domNode,"height")&&this._templatePicker.update()},startup:function(){this.inherited(arguments);
var a=new G({rows:"auto",columns:6,items:[],emptyMessage:""},this.dap_templatePicker);a.startup();this._templatePicker=a;a.on("selection-change",f.hitch(this,function(){var b=a.getSelected();b&&(b=A.cloneSymbol(b.item.symbol),this.emit("symbol-select",{selection:b}))}));this._loadingIndicator=H.create(this.dap_symbolViewport);this.own(this._loadingIndicator);this.dap_markerCategoryInput.on("change",f.hitch(this,function(b){this.clearSelection();this._toggleCustomItemCss();this._fetchSymbols(b)}));
this._normalizeSymbolStorage();this._loadStoredSymbolItems();this._setUpSymbolCategories().then(f.hitch(this,this.updateDisplay))},_fetchSymbols:function(a){var b;this._templatePicker.items=[];if(b=this._symbolItemStore.query({id:a})[0])if(this._saveRecentItem(b),this._updateSymbolOptions(b.items),b.id!==n.id)return;b=this._symbolTypesStore.query({id:a});this._showLoadingIndicator();this._getSymbolListData(b).then(f.hitch(this,this._symbolItemsFromJson)).then(f.hitch(this,function(c){var e={id:a,
items:c},d;this._symbolItemStore.put(e);this._saveRecentItem(e);(d=this._symbolTypesStore.query({defaultType:!0})[0])&&d.id===a&&this._saveDefaultItem(e);return c})).then(f.hitch(this,this._updateSymbolOptions))},_saveRecentItem:function(a){a={id:a.id,items:this._symbolItemsToJson(a.items)};sessionStorage.setItem(this._getRecentItemKey(),JSON.stringify(a))},_getRecentItemKey:function(){return this._toItemKey("/recent")},_toItemKey:function(a){return this._storageItemKeyBase+a},_getCustomItemKey:function(){return this._toItemKey("/custom")},
_getDefaultItemKey:function(){return this._toItemKey("/default")},_getTypesItemKey:function(){return this._toItemKey("/types")},_getVersionItemKey:function(){return this._toItemKey("/version")},_saveDefaultItem:function(a){a={id:a.id,items:this._symbolItemsToJson(a.items)};localStorage.setItem(this._getDefaultItemKey(),JSON.stringify(a))},_showNoSymbolsMessage:function(){this._hideLoadingIndicator();l.add(this.domNode,this.css.noSymbols);this._placeNoSymbolsOverlay()},_placeNoSymbolsOverlay:function(){if(!this._noSymbolsOverlay){var a=
this.css;var b=m.create("div",{"class":a.overlay});var c=m.create("div",{"class":a.centerContainer+" "+a.table},b);c=m.create("div",{"class":a.tableCell},c);c=m.create("div",{"class":a.centerBlock},c);m.create("div",{"class":a.content,innerHTML:this.labels.symbolLoadError},c);m.place(b,this.domNode);this._noSymbolsOverlay=b}},_getStorageVersionKey:function(){return z.version+"|"+L.locale},_normalizeSymbolStorage:function(){var a=localStorage.getItem(this._getVersionItemKey()),b=this._getStorageVersionKey();
a!==b&&(localStorage.setItem(this._getVersionItemKey(),b),localStorage.removeItem(this._getTypesItemKey()),localStorage.removeItem(this._getDefaultItemKey()),sessionStorage.removeItem(this._getRecentItemKey()))},_loadStoredSymbolItems:function(){var a=this._loadDefaultSymbolItem(),b=this._loadRecentSymbolItem();a&&this._symbolItemStore.put(this._symbolItemsFromSymbolItemJson(a));b&&this._symbolItemStore.put(this._symbolItemsFromSymbolItemJson(b))},_loadDefaultSymbolItem:function(){var a=localStorage.getItem(this._getDefaultItemKey());
if(a)return JSON.parse(a)},_loadRecentSymbolItem:function(){var a=sessionStorage.getItem(this._getRecentItemKey());if(a)return JSON.parse(a)},_loadSymbolTypes:function(){var a=localStorage.getItem(this._getTypesItemKey());if(a)return JSON.parse(a)},_saveSymbolTypes:function(a){localStorage.setItem(this._getTypesItemKey(),JSON.stringify(a))},_symbolItemsFromSymbolItemJson:function(a){a.items=g.map(a.items,function(b){return{symbol:u.fromJson(b.symbol)}});return a},_fetchSymbolTypes:function(){var a=
new r,b=this._loadSymbolTypes();return b?(a.resolve(b),a.promise):this._getSymbolListGroupId().then(f.hitch(this,this._getSymbolListItems)).then(f.hitch(this,function(c){this._saveSymbolTypes(c);return c}))},_setUpSymbolCategories:function(){this._showLoadingIndicator();return this._initPortal().then(f.hitch(this,this._fetchSymbolTypes)).then(f.hitch(this,this._injectCustomSymbolType)).then(f.hitch(this,this._setUpSymbolSelect),f.hitch(this,function(){this._showNoSymbolsMessage()}))},_setUpSymbolSelect:function(a){var b=
this._symbolTypesStore,c;b.setData(a);g.forEach(a,function(d){d.defaultType&&(e=d.id)});if(a=this._loadRecentSymbolItem())if(c=b.query({id:a.id})[0])var e=a.id;this.dap_markerCategoryInput.set("store",b);this.dap_markerCategoryInput.set("value",e,!1);this._toggleCustomItemCss()},_injectCustomSymbolType:function(a){a.push(n);return a},_showLoadingIndicator:function(){8>=v("ie")?l.add(this.domNode,this.css.loading):this._loadingIndicator.show()},_hideLoadingIndicator:function(){8>=v("ie")?l.remove(this.domNode,
this.css.loading):this._loadingIndicator.hide()},_initPortal:function(){var a=new r,b=this.portal||"http://arcgis.com/";var c="string"===typeof b?new x.Portal(b):b.declaredClass?b:new x.Portal({self:b});if(c.loaded)return this._portal=c,a.resolve(),a.promise;this.own(c.on("load",f.hitch(this,function(){this._portal=c;a.resolve()})));setTimeout(function(){a.reject()},this._portalLoadTimeoutInMs);return a.promise},_getSymbolListGroupId:function(){var a=new r;this._portal.queryGroups({q:this._portal.symbolSetsGroupQuery}).then(function(b){a.resolve(b.results[0].id)},
function(){a.reject()});return a.promise},_getSymbolListItems:function(a){var b=new r,c=this._portal;a="group:"+a+' AND type:"Symbol Set"';var e=[];a="vml"===O.renderer?a+' AND -typekeywords:"by value"':a+' AND (typekeywords:"by value" AND typekeywords:"marker")';c.queryItems({q:a,num:50,sortField:"title"}).then(f.hitch(this,function(d){var h,t,k,Q;g.forEach(d.results,function(p){h=p.typeKeywords.join(" ");-1<h.indexOf("marker")&&(t=p.title,k={name:t,id:p.id,title:p.title,keywords:h,dataUrl:p.itemDataUrl},
(Q=-1<h.indexOf("default"))?(k.defaultType=!0,e.unshift(k)):e.push(k))},this);0<e.length?b.resolve(e):b.reject()}),function(){b.reject()});return b.promise},_getSymbolListData:function(a){var b=g.filter(a,function(d){return d.dataUrl});a=g.filter(a,function(d){return d.id===n.id})[0];b=B(g.map(b,function(d){return E({url:d.dataUrl}).promise})).then(function(d){return d[0]||[]});var c=this._getCustomItemKey(),e=a&&JSON.parse(localStorage.getItem(c))||[];a=D(e.map(function(d){return A.testImageUrl(d.url)})).then(function(d){var h=
e.filter(function(t,k){(k=!(d[k]instanceof Error))||console.log("removing custom image due to URL load failure:",t.url);return k});h.length!==e.length&&localStorage.setItem(c,JSON.stringify(h));return h});return B([b,a]).then(function(d){return[].concat(d[0],d[1])})},_symbolItemsFromJson:function(a){return g.map(a,function(b){return{symbol:u.fromJson(b)}})},_symbolItemsToJson:function(a){return g.map(a,function(b){return{symbol:b.symbol.toJson()}})},_updateSymbolOptions:function(a){var b=this._templatePicker;
b.items=a;b.update();b.domNode.parentNode.scrollTop=0;this._hideLoadingIndicator()},_setDisplayModeAttr:function(a){this.displayMode!==a&&(this._set("displayMode",a),this.updateDisplay(a))},updateDisplay:function(){var a=this.dap_markerCategoryInput;this.clearSelection();"portal"===this.displayMode?(this._fetchSymbols(a.value),y.show(a.domNode),l.remove(this.domNode,this.css.defaultSymbols)):"default"===this.displayMode&&(this._updateSymbolOptions(this._symbolItemsFromJson(this._defaultSimpleMarkerSymbols)),
y.hide(a.domNode),l.add(this.domNode,this.css.defaultSymbols))},clearSelection:function(){this._templatePicker.clearSelection()},resetSelection:function(){var a=this.dap_markerCategoryInput,b=a.get("options");a.set("value",b[0]);this.clearSelection()}});v("extend-esri")&&f.setObject("dijit.SymbolStyler.MarkerSymbolPicker",q,z);return q});