// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/OAuthSignInHandler","./Credential ./domUtils ./lang ./urlUtils dijit/Dialog dijit/registry dojo/_base/config dojo/_base/Deferred dojo/_base/kernel dojo/dom-attr dojo/i18n!./nls/jsapi dojo/io-query dojo/sniff dojo/json dijit/form/Button dojo/query".split(" "),function(y,l,p,z,q,r,g,A,h,t,B,u,C,D){var v=null,w=null;try{v=window.localStorage,w=window.sessionStorage}catch(b){}return{_oAuthDfd:null,_oAuthIntervalId:0,_oAuthDialogContent:"\x3cdiv class\x3d'dijitDialogPaneContentArea'\x3e\x3cdiv style\x3d'padding-bottom: 5px; word-wrap: break-word;'\x3e${oAuthInfo}\x3c/div\x3e\x3cdiv style\x3d'margin: 0px; padding: 0px; height: 10px;'\x3e\x3c/div\x3e\x3cdiv class\x3d'esriErrorMsg' style\x3d'display: none; color: white; background-color: #D46464; text-align: center; padding-top: 3px; padding-bottom: 3px;'\x3e${invalidUser}\x3c/div\x3e\x3cdiv style\x3d'margin: 0px; padding: 0px; height: 10px;'\x3e\x3c/div\x3e\x3cdiv class\x3d'dijitDialogPaneActionBar'\x3e\x3cbutton data-dojo-type\x3d'dijit.form.Button' data-dojo-props\x3d'type:\"button\", \"class\":\"esriIdSubmit\"'\x3e${lblOk}\x3c/button\x3e\x3cbutton data-dojo-type\x3d'dijit.form.Button' data-dojo-props\x3d'type:\"button\", \"class\":\"esriIdCancel\"'\x3e${lblCancel}\x3c/button\x3e\x3c/div\x3e",
setOAuthRedirectionHandler:function(b){this._oAuthRedirectFunc=b},oAuthSignIn:function(b,d,a,c){var e=this._oAuthDfd=new A;e.resUrl_=b;e.sinfo_=d;e.oinfo_=a;var k=!c||!1!==c.oAuthPopupConfirmation;if(!a.popup||!k)return this._doOAuthSignIn(b,d,a),e;this._nls||(this._nls=B.identity);this.oAuthDialog||(this.oAuthDialog=this._createOAuthDialog());b=this.oAuthDialog;a=c&&c.error;c=c&&c.token;l.hide(b.errMsg_);a&&403==a.code&&c&&(t.set(b.errMsg_,"innerHTML",this._nls.forbidden),l.show(b.errMsg_));t.set(b.serverLink_,
{title:d.server,innerHTML:-1!==d.server.toLowerCase().indexOf("arcgis.com")?"ArcGIS Online":d.server});b.show();return e},setOAuthResponseHash:function(b){var d=this._oAuthDfd;this._oAuthDfd=null;if(d&&b)if(clearInterval(this._oAuthIntervalId),"#"===b.charAt(0)&&(b=b.substring(1)),b=u.queryToObject(b),b.error){var a="access_denied"===b.error;b=Error(a?"ABORTED":"OAuth: "+b.error+" - "+b.error_description);b.name=a?"identity-manager:user-aborted":"identity-manager:authentication-failed";b.code="IdentityManagerBase."+
(a?2:3);b.log=!!g.isDebug;d.errback(b)}else{a=d.oinfo_._oAuthCred;var c=new y({userId:b.username,server:d.sinfo_.server,token:b.access_token,expires:(new Date).getTime()+1E3*Number(b.expires_in),ssl:"true"===b.ssl,_oAuthCred:a});a.storage=b.persist?v:w;a.token=c.token;a.expires=c.expires;a.userId=c.userId;a.ssl=c.ssl;a.save();d.callback(c)}},_createOAuthDialog:function(){var b=this._nls,d=p.substitute(b,this._oAuthDialogContent);d=p.substitute({server:"\x3cspan class\x3d'serverLink' style\x3d'word-wrap: break-word;'\x3e\x3c/span\x3e"},
d);var a=new q({title:b.title,content:d,"class":"esriOAuthSignInDialog",style:"min-width: 18em;",esriIdMgr_:this,execute_:function(){var c=a.esriIdMgr_._oAuthDfd;a.hide_();a.esriIdMgr_._doOAuthSignIn(c.resUrl_,c.sinfo_,c.oinfo_)},cancel_:function(){var c=a.esriIdMgr_._oAuthDfd;a.esriIdMgr_._oAuthDfd=null;a.hide_();var e=Error("ABORTED");e.code="IdentityManager.2";e.log=!!g.isDebug;c.errback(e)},hide_:function(){l.hide(a.errMsg_);a.hide();q._DialogLevelManager.hide(a)}});b=a.domNode;a.btnSubmit_=r.byNode(h.query(".esriIdSubmit",
b)[0]);a.btnCancel_=r.byNode(h.query(".esriIdCancel",b)[0]);a.serverLink_=h.query(".serverLink",b)[0];a.errMsg_=h.query(".esriErrorMsg",b)[0];a.connect(a.btnSubmit_,"onClick",a.execute_);a.connect(a.btnCancel_,"onClick",a.onCancel);a.connect(a,"onCancel",a.cancel_);return a},_doOAuthSignIn:function(b,d,a){var c=this,e={portalUrl:a.portalUrl};!a.popup&&a.preserveUrlHash&&window.location.hash&&(e.hash=window.location.hash);e={client_id:a.appId,response_type:"token",state:D.stringify(e),expiration:a.expiration,
locale:a.locale,redirect_uri:a.popup?z.getAbsoluteUrl(a.popupCallbackUrl):window.location.href.replace(/#.*$/,"")};a.forceLogin&&(e.force_login=!0);!a.popup&&this._doPortalSignIn(b)&&(e.redirectToUserOrgUrl=!0);var k=a.portalUrl.replace(/^http:/i,"https:")+"/sharing/oauth2/authorize",m=k+"?"+u.objectToQuery(e);if(a.popup){if(7===C("ie")){var f=window.open(a.popupCallbackUrl,"esriJSAPIOAuth",a.popupWindowFeatures);f.location=m}else f=window.open(m,"esriJSAPIOAuth",a.popupWindowFeatures);f?(f.focus(),
this._oAuthDfd.oAuthWin_=f,this._oAuthIntervalId=setInterval(function(){if(f.closed){clearInterval(c._oAuthIntervalId);var x=c._oAuthDfd;if(x){var n=Error("ABORTED");n.code="IdentityManager.2";n.log=!!g.isDebug;x.errback(n)}}},500)):(b=Error("ABORTED"),b.name="identity-manager:user-aborted",b.code="IdentityManager.2",b.log=!!g.isDebug,this._oAuthDfd.errback(b))}else this._rejectOnPersistedPageShow=!0,this._oAuthRedirectFunc?this._oAuthRedirectFunc({authorizeParams:e,authorizeUrl:k,resourceUrl:b,serverInfo:d,
oAuthInfo:a}):window.location=m}}});