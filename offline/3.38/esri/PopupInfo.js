// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/PopupInfo","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/json dojo/i18n dojo/has dojo/Deferred dojo/sniff dojo/promise/all dojox/html/entities ./lang ./kernel ./request ./promiseList ./ArcadeExpression ./tasks/query ./tasks/QueryTask ./tasks/RelationshipQuery ./tasks/StatisticDefinition ./arcadeProfiles/popupProfile ./layers/support/attributeUtils dojo/i18n!dojo/cldr/nls/number".split(" "),function(E,t,l,M,aa,S,T,U,J,V,u,N,W,K,X,F,O,Y,Z,L,ba,P){E=E(null,{declaredClass:"esri.PopupInfo",
_reNewline:/(\n)/ig,_reExprField:/^\s*expression\//i,_reExprFieldPattern:/\{expression\/([^\}]+)\}/ig,_exprPrefix:"expression/",_relatedFieldPrefix:"relationships/",_aggregatedFeaturesVariable:"$aggregatedfeatures",initialize:function(a,b){if(a){t.mixin(this,b);this.info=a;this.title=this.getTitle;this.content=this.getContent;this._exprCache=this._compileExpressions(this.info.expressionInfos);var c=this._fieldLabels={},d=this._fieldsMap={};this.info.fieldInfos&&l.forEach(this.info.fieldInfos,function(e){var f=
e.fieldName.toLowerCase(),h=this._isExpressionField(f)?this.getExpressionInfo(f):null;c[f]=h?h.title:e.label;d[f]=e},this);this.titleHasRelatedFields=!(!this.info.title||-1===this.info.title.indexOf("{"+this._relatedFieldPrefix));this.titleHasAsyncExpressions=this._titleHasAsyncExpressions();this.contentHasAsyncExpressions=this._contentHasAyncExpressions()}},toJson:function(){return M.fromJson(M.toJson(this.info))},getTitle:function(){},getContent:function(){},getFieldInfo:function(a){var b;l.some(this.info&&
this.info.fieldInfos,function(c){c.fieldName===a&&(b=c);return!!b});return b},getExpressionInfo:function(a){if(a=this._getExprField(a)){a=a.toLowerCase();var b;l.some(this.info.expressionInfos,function(c){c.name.toLowerCase()===a&&(b=c);return!!b});return b}},getExpressionFieldsInTitle:function(){return this._getExprFieldsFromTemplatedString(this.info.title)},getExpressionFieldsInContent:function(){var a=this._collectExprFieldsFromTemplatedString(this.info.description,[]);this.info.description||l.forEach(this.info.fieldInfos,
function(b){b.visible&&this._collectExprField(b.fieldName,a)},this);l.forEach(this.info.mediaInfos,function(b){this._collectExprFieldsFromTemplatedString(b.title,a);this._collectExprFieldsFromTemplatedString(b.caption,a);if(b=b.value)this._collectExprFieldsFromTemplatedString(b.linkURL,a),this._collectExprFieldsFromTemplatedString(b.sourceURL,a),l.forEach(b.fields,function(c){this._collectExprField(c,a)},this),this._collectExprField(b.normalizeField,a),this._collectExprField(b.tooltipField,a)},this);
return a},getRequiredExpressionFields:function(){return this.getExpressionFieldsInTitle().concat(this.getExpressionFieldsInContent())},hasGeometryOperations:function(){return l.some(this._getArcadeExpressions(),function(a){return a.hasGeometryOperations()})},hasAsyncExpressions:function(){return l.some(this._getArcadeExpressions(),function(a){return a.async})},initializeArcadeEngine:function(){return L.initialize(this._getArcadeExpressions())},getComponents:function(a,b){var c=this.info,d={initArcadeEngine:this.initializeArcadeEngine()};
c.fieldInfos&&(c=l.filter(c.fieldInfos,function(e){return-1!==e.fieldName.indexOf(this._relatedFieldPrefix)},this))&&0<c.length&&(d.relatedInfo=this._getRelatedRecords({graphic:a,fieldsInfo:c}));this._needFullResolutionFeature(a)&&(d.fullResolutionFeature=this._getFullResolutionFeature(a));this._needAggregatedFeaturesLayer(a)&&(d.aggregatedFeaturesLayer=this._getAggregatedFeaturesLayer(a));return K(d).then(t.hitch(this,function(e){var f=e.fullResolutionFeature,h=b&&b.evaluateAllExpressions,m=h?null:
this.getRequiredExpressionFields();e=(h?this.hasAsyncExpressions():this._hasAsyncExpressions(m))?this._fetchAttributesAsync(a,f,m,e.aggregatedFeaturesLayer):this._fetchAttributes(a,f,m);return K([e]).then(t.hitch(this,function(g){return this._getPopupValues(a,g[0])}))}))},getAttachments:function(a){var b=a.getSourceLayer();a=a.attributes;if(this.info.showAttachments&&b&&b.hasAttachments&&b.objectIdField&&(a=a&&a[b.objectIdField]))return b.queryAttachmentInfos(a)},_needAggregatedFeaturesLayer:function(a){return a.isAggregate()?
l.some(this._getArcadeExpressions(),function(b){return b.hasVariable(this._aggregatedFeaturesVariable)},this):!1},_getAggregatedFeaturesLayer:function(a){return a.getAggregationSourceLayer().getFeatureCollectionLayer(a.getChildGraphics()).always(function(b){return b instanceof Error?null:b})},_needFullResolutionFeature:function(a){return(a=a.getSourceLayer())?"function"===typeof a.getMaxAllowableOffset&&0<a.getMaxAllowableOffset()&&this.hasGeometryOperations():!1},_getFullResolutionFeature:function(a){var b=
a.getSourceLayer(),c=b.objectIdField;a=(a=a.attributes)&&c&&a[c];if(null==a)return null;var d=new F;d.where=c+"\x3d"+a;d.maxAllowableOffset=0;d.outFields=[c];b._enableCacheHint(d);return b.queryFeatures(d).then(function(e){return e.features&&e.features[0]})},_isExpressionField:function(a){return this._reExprField.test(a)},_getExprField:function(a){return this._isExpressionField(a)?a.replace(this._reExprField,""):null},_collectExprField:function(a,b){(a=this._getExprField(a))&&b.push(a);return b},
_collectExprFieldsFromTemplatedString:function(a,b){a=this._getExprFieldsFromTemplatedString(a);a.length&&Array.prototype.push.apply(b,a);return b},_getExprFieldsFromTemplatedString:function(a){a=a?a.match(this._reExprFieldPattern):null;return l.map(a,function(b){return b.replace(this._reExprFieldPattern,"$1")},this)},_titleHasAsyncExpressions:function(){return this._hasAsyncExpressions(this.getExpressionFieldsInTitle())},_contentHasAyncExpressions:function(){return this._hasAsyncExpressions(this.getExpressionFieldsInContent())},
_hasAsyncExpressions:function(a){return l.some(a,function(b){b=this._exprCache[b];return!(!b||!b.async)},this)},_compileExpressions:function(a){var b={};l.forEach(a,function(c){var d=c.returnType&&c.returnType.toLowerCase();b[c.name]=new X({expression:c.expression,returnType:"number"===d?"number":"string",profile:L})});return b},_getArcadeExpressions:function(){var a=[],b;for(b in this._exprCache)a.push(this._exprCache[b]);return a},_fetchAttributesAsync:function(a,b,c,d){var e=this._fetchAttributes(a,
b,c,d);a={};for(var f in e)(b=e[f])&&b.then&&(a[f]=b);return K(a).then(t.hitch(this,function(h){for(var m in h){var g=h[m];e[m]=g instanceof Error?null:this._processArcadeResult(g)}return e}))},_processArcadeResult:function(a){"string"===typeof a&&(a=V.encode(a));return a},_fetchAttributes:function(a,b,c,d){var e=t.clone(a.attributes)||{},f=b&&b.geometry,h=this._exprPrefix,m=this._exprCache;c=c||l.map(this.info.expressionInfos,function(g){return g.name});l.forEach(c,function(g){var n=h+g;g=(g=m[g])?
a.evaluateExpression(g,this._getEvalOptions(g,a,f,d)):null;e[n]=this._processArcadeResult(g)},this);return e},_getEvalOptions:function(a,b,c,d){var e=a.hasGeometryOperations(),f=b.getSourceLayer(),h=f&&(f.getMap()||f.parentLayer&&f.parentLayer.getMap());d&&(d._map=h);a=L.getEvalOptions({expression:a,feature:b,layer:f,aggregatedFeaturesLayer:d,map:h,spatialReference:h&&h.spatialReference});b=a.context.vars.$feature;e=!(!e||!c);b&&e&&(b._geometry=c);a.skipCache=e;return a},_getPopupValues:function(a,
b,c){b=b||this._fetchAttributes(a);var d=this.info,e=a.getSourceLayer(),f=t.clone(b),h="",m="",g,n,p=e&&e._getDateOpts&&e._getDateOpts().properties;p=p&&p.slice(0);var v={dateFormat:{properties:p,formatter:"DateFormat"+this._insertOffset(this._dateFormats.shortDateShortTime)},format:null};if(this._relatedInfo)for(q in this._relatedInfo)if(this._relatedInfo.hasOwnProperty(q)){var x=this._relatedInfo[q],w=this._relatedLayersInfo[q];x&&(l.forEach(x.relatedFeatures,function(r){for(n in r.attributes)if(r.attributes.hasOwnProperty(n)&&
"esriRelCardinalityOneToOne"===w.relation.cardinality){var y=this._toRelatedFieldName([w.relation.id,n]);b[y]=f[y]=r.attributes[n]}},this),l.forEach(x.relatedStatsFeatures,function(r){for(n in r.attributes)if(r.attributes.hasOwnProperty(n)){var y=this._toRelatedFieldName([w.relation.id,n]);b[y]=f[y]=r.attributes[n]}},this))}for(g in f){var q=this._fieldsMap[g.toLowerCase()];x=this._getLayerFieldInfo(e,g);q&&x&&(q.fieldName=x.name);f[g]=this._formatValue(f[g],g,v);p&&q&&q.format&&q.format.dateFormat&&
(q=l.indexOf(p,g),-1<q&&p.splice(q,1))}if(e)for(g in p=e.typeIdField,b)if(b.hasOwnProperty(g)&&-1===g.indexOf(this._relatedFieldPrefix)){var k=b[g];u.isDefined(k)&&(q=this._getDomainName(e,a,g,k),u.isDefined(q)?f[g]=q:g===p&&(q=this._getTypeName(e,a,k),u.isDefined(q)&&(f[g]=q)))}d.title&&(h=this._processFieldsInLinks(this._fixTokens(d.title,e),b),h=t.trim(this._removeEmptyHref(u.substitute(f,h,v)||"")));if(c)return{title:h};d.description&&(m=this._processFieldsInLinks(this._fixTokens(d.description,
e),b),m=t.trim(this._removeEmptyHref(u.substitute(f,m,v)||"")));if(d.fieldInfos){var A=[];l.forEach(d.fieldInfos,function(r){(g=r.fieldName)&&r.visible&&A.push([this._fieldLabels[g.toLowerCase()]||g,u.substitute(f,"${"+g+"}",v)||""])},this)}var B;if(d.mediaInfos){var C=[];l.forEach(d.mediaInfos,function(r){B=0;k=r.value;switch(r.type){case "image":var y=k.sourceURL;y=y&&t.trim(this._removeEmptyHref(u.substitute(b,this._fixTokens(y,e))));B=!!y;break;case "piechart":case "linechart":case "columnchart":case "barchart":y=
k.normalizeField;k.fields=l.map(k.fields,function(z){return(G=this._getLayerFieldInfo(e,z))?G.name:z},this);if(y){var G=this._getLayerFieldInfo(e,y);k.normalizeField=G?G.name:y}B=l.some(k.fields,function(z){return u.isDefined(b[z])||-1!==z.indexOf(this._relatedFieldPrefix)&&this._relatedInfo},this);break;default:return}if(B){r=t.clone(r);k=r.value;y=r.title?this._processFieldsInLinks(this._fixTokens(r.title,e),b):"";var Q=r.caption?this._processFieldsInLinks(this._fixTokens(r.caption,e),b):"";r.title=
y?t.trim(this._removeEmptyHref(u.substitute(f,y,v)||"")):"";r.caption=Q?t.trim(this._removeEmptyHref(u.substitute(f,Q,v)||"")):"";if("image"===r.type)k.sourceURL=u.substitute(b,this._fixTokens(k.sourceURL,e)),k.linkURL&&(k.linkURL=t.trim(u.substitute(b,this._fixTokens(k.linkURL,e))||""));else{var H,I;l.forEach(k.fields,function(z,R){if(-1!==z.indexOf(this._relatedFieldPrefix))I=this._getRelatedChartInfos(z,k,b,v),I instanceof Array?k.fields=I:k.fields[R]=I;else{var D=b[z];D=void 0===D?null:D;H=b[k.normalizeField]||
0;D&&H&&(D/=H);k.fields[R]={y:D,tooltip:(this._fieldLabels[z.toLowerCase()]||z)+":\x3cbr/\x3e"+this._formatValue(D,z,v,!!H)}}},this)}C.push(r)}},this)}return{title:h,description:m,hasDescription:!!d.description,fields:A&&A.length?A:null,mediaInfos:C&&C.length?C:null,formatted:f,editSummary:!1!==d.showLastEditInfo&&e&&e.getEditSummary?e.getEditSummary(a):""}},_getRelatedChartInfos:function(a,b,c,d){var e,f;var h=[];var m=this._fromRelatedFieldName(a);var g=m[0];var n=this._relatedInfo[g];g=this._relatedLayersInfo[g];
n&&l.forEach(n.relatedFeatures,function(p){p=p.attributes;var v;for(v in p)if(p.hasOwnProperty(v)&&v===m[1]){var x={};f=p[v];b.normalizeField&&(e=-1!==b.normalizeField.indexOf(this._relatedFieldPrefix)?p[this._fromRelatedFieldName(b.normalizeField)[1]]:c[b.normalizeField]);f&&e&&(f/=e);if(b.tooltipField)if(-1!==b.tooltipField.indexOf(this._relatedFieldPrefix)){var w=this._fromRelatedFieldName(b.tooltipField)[1],q=u.isDefined(p[w])?this._formatValue(p[w],b.tooltipField,d,!!e):w;x.tooltip=q+":\x3cbr/\x3e"+
this._formatValue(f,w,d,!!e)}else x.tooltip=(this._fieldLabels[a.toLowerCase()]||a)+":\x3cbr/\x3e"+this._formatValue(f,b.tooltipField,d,!!e);else x.tooltip=f;x.y=f;h.push(x)}},this);return"esriRelCardinalityOneToMany"===g.relation.cardinality||"esriRelCardinalityManyToMany"===g.relation.cardinality?h:h[0]},_dateFormats:{shortDate:"(datePattern: 'M/d/y', selector: 'date')",shortDateShortTime:"(datePattern: 'M/d/y', timePattern: 'h:mm a', selector: 'date and time')",shortDateShortTime24:"(datePattern: 'M/d/y', timePattern: 'H:mm', selector: 'date and time')",
shortDateLongTime:"(datePattern: 'M/d/y', timePattern: 'h:mm:ss a', selector: 'date and time')",shortDateLongTime24:"(datePattern: 'M/d/y', timePattern: 'H:mm:ss', selector: 'date and time')",shortDateLE:"(datePattern: 'd/M/y', selector: 'date')",shortDateLEShortTime:"(datePattern: 'd/M/y', timePattern: 'h:mm a', selector: 'date and time')",shortDateLEShortTime24:"(datePattern: 'd/M/y', timePattern: 'H:mm', selector: 'date and time')",shortDateLELongTime:"(datePattern: 'd/M/y', timePattern: 'h:mm:ss a', selector: 'date and time')",
shortDateLELongTime24:"(datePattern: 'd/M/y', timePattern: 'H:mm:ss', selector: 'date and time')",longMonthDayYear:"(datePattern: 'MMMM d, y', selector: 'date')",longMonthDayYearShortTime:"(datePattern: 'MMMM d, y', timePattern: 'h:mm a', selector: 'date and time')",longMonthDayYearShortTime24:"(datePattern: 'MMMM d, y', timePattern: 'H:mm', selector: 'date and time')",longMonthDayYearLongTime:"(datePattern: 'MMMM d, y', timePattern: 'h:mm:ss a', selector: 'date and time')",longMonthDayYearLongTime24:"(datePattern: 'MMMM d, y', timePattern: 'H:mm:ss', selector: 'date and time')",
dayShortMonthYear:"(datePattern: 'd MMM y', selector: 'date')",dayShortMonthYearShortTime:"(datePattern: 'd MMM y', timePattern: 'h:mm a', selector: 'date and time')",dayShortMonthYearShortTime24:"(datePattern: 'd MMM y', timePattern: 'H:mm', selector: 'date and time')",dayShortMonthYearLongTime:"(datePattern: 'd MMM y', timePattern: 'h:mm:ss a', selector: 'date and time')",dayShortMonthYearLongTime24:"(datePattern: 'd MMM y', timePattern: 'H:mm:ss', selector: 'date and time')",longDate:"(datePattern: 'EEEE, MMMM d, y', selector: 'date')",
longDateShortTime:"(datePattern: 'EEEE, MMMM d, y', timePattern: 'h:mm a', selector: 'date and time')",longDateShortTime24:"(datePattern: 'EEEE, MMMM d, y', timePattern: 'H:mm', selector: 'date and time')",longDateLongTime:"(datePattern: 'EEEE, MMMM d, y', timePattern: 'h:mm:ss a', selector: 'date and time')",longDateLongTime24:"(datePattern: 'EEEE, MMMM d, y', timePattern: 'H:mm:ss', selector: 'date and time')",longMonthYear:"(datePattern: 'MMMM y', selector: 'date')",shortMonthYear:"(datePattern: 'MMM y', selector: 'date')",
year:"(datePattern: 'y', selector: 'date')"},_dateFormatsJson:{shortDate:{datePattern:"M/d/y",selector:"date"},shortDateShortTime:{datePattern:"M/d/y",timePattern:"h:mm a",selector:"date and time"},shortDateShortTime24:{datePattern:"M/d/y",timePattern:"H:mm",selector:"date and time"},shortDateLongTime:{datePattern:"M/d/y",timePattern:"h:mm:ss a",selector:"date and time"},shortDateLongTime24:{datePattern:"M/d/y",timePattern:"H:mm:ss",selector:"date and time"},shortDateLE:{datePattern:"d/M/y",selector:"date"},
shortDateLEShortTime:{datePattern:"d/M/y",timePattern:"h:mm a",selector:"date and time"},shortDateLEShortTime24:{datePattern:"d/M/y",timePattern:"H:mm",selector:"date and time"},shortDateLELongTime:{datePattern:"d/M/y",timePattern:"h:mm:ss a",selector:"date and time"},shortDateLELongTime24:{datePattern:"d/M/y",timePattern:"H:mm:ss",selector:"date and time"},longMonthDayYear:{datePattern:"MMMM d, y",selector:"date"},longMonthDayYearShortTime:{datePattern:"MMMM d, y",timePattern:"h:mm a",selector:"date and time"},
longMonthDayYearShortTime24:{datePattern:"MMMM d, y",timePattern:"H:mm",selector:"date and time"},longMonthDayYearLongTime:{datePattern:"MMMM d, y",timePattern:"h:mm:ss a",selector:"date and time"},longMonthDayYearLongTime24:{datePattern:"MMMM d, y",timePattern:"H:mm:ss",selector:"date and time"},dayShortMonthYear:{datePattern:"d MMM y",selector:"date"},dayShortMonthYearShortTime:{datePattern:"d MMM y",timePattern:"h:mm a",selector:"date and time"},dayShortMonthYearShortTime24:{datePattern:"d MMM y",
timePattern:"H:mm",selector:"date and time"},dayShortMonthYearLongTime:{datePattern:"d MMM y",timePattern:"h:mm:ss a",selector:"date and time"},dayShortMonthYearLongTime24:{datePattern:"d MMM y",timePattern:"H:mm:ss",selector:"date and time"},longDate:{datePattern:"EEEE, MMMM d, y",selector:"date"},longDateShortTime:{datePattern:"EEEE, MMMM d, y",timePattern:"h:mm a",selector:"date and time"},longDateShortTime24:{datePattern:"EEEE, MMMM d, y",timePattern:"H:mm",selector:"date and time"},longDateLongTime:{datePattern:"EEEE, MMMM d, y",
timePattern:"h:mm:ss a",selector:"date and time"},longDateLongTime24:{datePattern:"EEEE, MMMM d, y",timePattern:"H:mm:ss",selector:"date and time"},longMonthYear:{datePattern:"MMMM y",selector:"date"},shortMonthYear:{datePattern:"MMM y",selector:"date"},year:{datePattern:"y",selector:"date"}},_reHref:/href\s*=\s*(")([^"]+)"/ig,_reHrefApos:/href\s*=\s*(')([^']+)'/ig,_fixTokens:function(a,b){var c=this;return a.replace(/(\{([^\{\r\n]+)\})/g,function(d,e,f){d=c._getLayerFieldInfo(b,f);return"$"+(d?"{"+
d.name+"}":e)})},_encodeAttributes:function(a,b){a=t.clone(a)||{};var c,d;for(c in a)(d=a[c])&&"string"===typeof d&&(d=b?d:encodeURIComponent(d),d=d.replace(/'/g,"\x26apos;"),a[c]=d);return a},_processFieldsInLinks:function(a,b){var c=this._encodeAttributes(b),d=this._encodeAttributes(b,!0);b=t.hitch(this,this._addValuesToHref,b,c,d);a&&(a=a.replace(this._reHref,b).replace(this._reHrefApos,b));return a},_addValuesToHref:function(a,b,c,d,e,f){f=f&&t.trim(f);return d=u.substitute(f&&0===f.indexOf("${")?
"'"===e?c:a:b,d)},_getLayerFieldInfo:function(a,b){return a&&a.getField?a.getField(b):null},_formatValue:function(a,b,c,d){var e=this._fieldsMap[b.toLowerCase()],f=e&&e.format;b=-1!==l.indexOf(c.dateFormat.properties,b);var h="number"===typeof a&&!b&&(!f||!f.dateFormat);if(!u.isDefined(a)||!e||!u.isDefined(f))return this._applyFormatting(a,h);e=f.hasOwnProperty("places")||f.hasOwnProperty("digitSeparator");var m=f.hasOwnProperty("digitSeparator")?f.digitSeparator:!0;if(e&&!b)var g={formatType:"NumberFormat",
places:u.isDefined(f.places)&&(!d||0<f.places)?Number(f.places):Infinity};else if(f.dateFormat)g=t.mixin({formatType:"DateFormat",utcOffset:this.utcOffset},this._dateFormatsJson[f.dateFormat]||this._dateFormatsJson.shortDateShortTime);else return this._applyFormatting(a,h);var n=this._applyFormatFunctions(a,g,c);e&&-1<a.constructor.toString().indexOf("Array")&&(n="",l.forEach(a,t.hitch(this,function(p,v){v&&(n+=" ");n+=this._applyFormatFunctions(p,g,c)})));e&&!m&&P.group&&(n=n.replace(new RegExp("\\"+
P.group,"g"),""));b&&(n='\x3cspan class\x3d"esriDateValue"\x3e'+n+"\x3c/span\x3e");return this._applyFormatting(n,h)},_applyFormatFunctions:function(a,b,c){b&&c&&(c.format={myKey:b});a=u.substitute({myKey:a},"${myKey}",c)||"";b&&c&&(c.format=null);return a},_applyFormatting:function(a,b){return b?this._forceLTR(a):this._applyPreWrap(a)},_forceLTR:function(a){var b=U("ie");return b&&10>=b?a:"\x3cspan class\x3d'esriNumericValue'\x3e"+a+"\x3c/span\x3e"},_applyPreWrap:function(a){return"string"===typeof a?
a.replace(this._reNewline,"\x3cspan class\x3d'charNewLine'\x3e$1\x3c/span\x3e"):a},_insertOffset:function(a){a&&(a=u.isDefined(this.utcOffset)?a.replace(/\)\s*$/,", utcOffset:"+this.utcOffset+")"):a);return a},_getDomainName:function(a,b,c,d){return(a=a.getDomain&&a.getDomain(c,{feature:b}))&&a.codedValues?a.getName(d):null},_getTypeName:function(a,b,c){return(a=a.getType&&a.getType(b))&&a.name},_getRelatedRecords:function(a){var b=a.graphic,c;this._relatedLayersInfoPromise||(this._relatedLayersInfoPromise=
this._getRelatedLayersInfo(a).then(t.hitch(this,function(d){for(c in d)d.hasOwnProperty(c)&&d[c]&&(this._relatedLayersInfo[c].relatedLayerInfo=d[c])})));return this._relatedLayersInfoPromise.then(t.hitch(this,function(){return this._queryRelatedLayers(b)})).then(t.hitch(this,function(d){this._setRelatedRecords(b,d);return d}))},_getRelatedLayersInfo:function(a){var b=a.fieldsInfo,c,d={};var e=a.graphic.getSourceLayer();this._relatedLayersInfo||(this._relatedLayersInfo={});l.forEach(b,function(f){var h;
var m=this._fromRelatedFieldName(f.fieldName);var g=m[0];m=m[1];if(g&&(!this._relatedLayersInfo[g]&&e&&e.relationships&&(l.some(e.relationships,function(p){if(p.id==g)return h=p,!0}),h&&(this._relatedLayersInfo[g]={relation:h,relatedFields:[],outStatistics:[]})),this._relatedLayersInfo[g]&&(this._relatedLayersInfo[g].relatedFields.push(m),f.statisticType))){var n=new Z;n.statisticType=f.statisticType;n.onStatisticField=m;n.outStatisticFieldName=m;this._relatedLayersInfo[g].outStatistics.push(n)}},
this);for(c in this._relatedLayersInfo)this._relatedLayersInfo.hasOwnProperty(c)&&this._relatedLayersInfo[c]&&(a=this._relatedLayersInfo[c].relation,a=e.url.replace(/[0-9]+$/,a.relatedTableId),this._relatedLayersInfo[c].relatedLayerUrl=a,d[c]=W({url:a,content:{f:"json"},callbackParamName:"callback"}));return J(d)},_queryRelatedLayers:function(a){var b={},c;for(c in this._relatedLayersInfo)this._relatedLayersInfo.hasOwnProperty(c)&&(b[c]=this._queryRelatedLayer({graphic:a,relatedInfo:this._relatedLayersInfo[c]}));
return J(b)},_queryRelatedLayer:function(a){var b,c;var d=a.graphic;var e=d.getSourceLayer();var f=e.url.match(/[0-9]+$/g)[0];var h=a.relatedInfo;var m=h.relatedLayerInfo;var g=h.relatedLayerUrl;var n=h.relation;a=l.filter(m.relationships,function(k){return k.relatedTableId===parseInt(f,10)});1===a.length?b=a[0]:1<a.length&&l.some(a,function(k){k.id===n.id&&(b=k);return!!b});if(b){var p=new F;l.some(m.fields,function(k){if(k.name===b.keyField)return c=-1!==l.indexOf(["esriFieldTypeSmallInteger","esriFieldTypeInteger",
"esriFieldTypeSingle","esriFieldTypeDouble"],k.type)?"number":"string",!0});if(b.relationshipTableId&&b.keyFieldInRelationshipTable){var v=new T;this._queryRelatedRecords(d,b).then(t.hitch(this,function(k){var A;(A=k[d.attributes[e.objectIdField]])?(k=l.map(A.features,function(B){return B.attributes[m.objectIdField]},this),h.outStatistics&&0<h.outStatistics.length&&m.supportsStatistics&&(w=new F,w.where=this._chunkWhereInClause(m.objectIdField,k,1E3),w.outFields=p.outFields,w.outStatistics=h.outStatistics),
w&&(q=new O(g),q.execute(w).then(t.hitch(this,function(B){var C=[];C.push(A);C.push(B);v.resolve(C)})))):v.resolve()}))}else{var x="string"===c?b.keyField+"\x3d'"+d.attributes[n.keyField]+"'":b.keyField+"\x3d"+d.attributes[n.keyField];p.where=x;p.outFields=h.relatedFields;if(h.outStatistics&&0<h.outStatistics.length&&m.supportsStatistics){var w=new F;w.where=p.where;w.outFields=p.outFields;w.outStatistics=h.outStatistics}var q=new O(g);x=[];x.push(q.execute(p));w&&x.push(q.execute(w))}}return x?J(x):
v?v.promise:void 0},_setRelatedRecords:function(a,b){this._relatedInfo=[];for(var c in b)b.hasOwnProperty(c)&&b[c]&&(a=b[c],this._relatedInfo[c]={},this._relatedInfo[c].relatedFeatures=a[0].features,u.isDefined(a[1])&&(this._relatedInfo[c].relatedStatsFeatures=a[1].features))},_handlerErrorResponse:function(a,b){a.reject(b)},_fromRelatedFieldName:function(a){var b=[];-1!==a.indexOf(this._relatedFieldPrefix)&&(a=a.split("/"),b=a.slice(1));return b},_toRelatedFieldName:function(a){var b="";a&&0<a.length&&
(b=this._relatedFieldPrefix+a[0]+"/"+a[1]);return b},_queryRelatedRecords:function(a,b){var c=a.getSourceLayer(),d=new Y;d.outFields=["*"];d.relationshipId=b.id;d.objectIds=[a.attributes[c.objectIdField]];return c.queryRelatedFeatures(d)},_removeEmptyHref:function(a){return a.replace(/href=(""|'')/gi,"")},_chunkWhereInClause:function(a,b,c){for(var d=0,e=[];d<b.length;)e.push(a+" IN ("+b.slice(d,c+d)+")"),d+=c;return e.join(" OR ")}});S("extend-esri")&&(N.PopupInfo=N.PopupInfoTemplate=E);return E});