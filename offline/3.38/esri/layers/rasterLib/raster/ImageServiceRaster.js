// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/rasterLib/raster/ImageServiceRaster","require dojo/_base/declare dojo/_base/lang dojo/_base/Deferred dojo/_base/array dojo/_base/config dojo/_base/json dojo/sniff dojo/DeferredList dojo/when ../../../kernel ../../../Evented ../../../request ../../../geometry/Extent ../../../geometry/Point ../../../SpatialReference ../../../WKIDUnitConversion ../../../deferredUtils ../../../urlUtils ../../MosaicRule ../../ImageServiceParameters ../../PixelBlock ./RasterInfo ./BasicRaster ../../rasterFormats/rasterCodec ../tile/RasterTileInfo".split(" "),
function(u,y,n,m,I,J,p,z,A,B,C,K,q,w,D,L,E,r,M,x,N,O,F,G,P,H){u=y([G],{declaredClass:"esri.layers.rasterLib.raster.ImageServiceRaster",sourceType:"ImageService",constructor:function(a){a&&(this._imageServiceParams=a.imageServiceParameters,this._commonReqParams=a._commonReqParams,this._imageServiceParams||(this._imageServiceParams={interpolation:a.interpolation,pixelType:a.pixelType,format:a.format||"lerc",compressionQuality:a.compressionQuality,bandIds:a.bandIds,noDataInterpretation:a.noDataInterpretation,
adjustAspectRatio:a.adjustAspectRatio,mosaicRule:a.mosaicRule,renderingRule:a.interpolation}))},open:function(){var a=new m;if(this.serviceInfo&&this.rasterInfo)return this.loaded=!0,this._findCredential(),this.setFetchParameters(this._imageServiceParams),a.resolve(this),a.promise;var b=this.serviceInfo||this._generateServiceInfo(this._imageServiceParams&&this._imageServiceParams.renderingRule),c=n.hitch(this,function(d){this._fixServiceInfo(d);this.serviceInfo=d;this._findCredential();var g=this._parseRasterInfo(d),
h={};d.defaultMosaicMethod?(h.method=d.defaultMosaicMethod,h.operation=d.mosaicOperator,h.sortField=d.sortField,h.sortValue=d.sortValue):h.method=x.METHOD_NONE;this.serviceInfo.defaultMosaicRule=new x(h);this.serviceInfo.defaultMosaicRule.ascending=!0;d=this._getColormap(this);h=this._getHistograms(this);var t=this._getRasterAttributeTable(this),f=this._getKeyProperties(this),l=this._getMultidimensionalInfo(),v=this._getSlices();(new A([d,h,t,f,l,v])).then(n.hitch(this,function(k){k[0][0]&&(g.colormap=
k[0][1]);k[1][0]&&(g.histograms=k[1][1]);k[2][0]&&(g.vat=k[2][1]);k[3][0]&&(g.keyProperties=k[3][1]);k[4][0]&&(g.multidimensionalInfo=k[4][1]);this._slices=k[5][0]?k[5][1]:null;g.keyProperties&&g.keyProperties.DataType&&(this.dataType=g.keyProperties.DataType);this.loaded=!0;this.rasterInfo=g;this.setFetchParameters(this._imageServiceParams);a.resolve(this)}))}),e=n.hitch(this,function(d){this.loaded=!0;a.reject(d)});B(b,c,e);return a.promise},setFetchParameters:function(a,b){if(b)this.imageServiceParams=
a;else{var c=this.imageServiceParams;c&&a?Object.keys(a).forEach(function(e){c[e]=a[e]}):this.imageServiceParams=a}this._constructGetImageParams();this._getRasterIdentifier(!0)},read:function(a){if(a.pixelBlock||a.texture){var b=new m;b.resolve(a);return b.promise}if(!1===a.virtual&&this.tileInfo&&!this.tileInfo.virtual)return this.readTile(a);if(this._slices){var c=this._getSliceId();if(null==c)return b=new m,b.resolve(a),b.promise}var e=a.extent,d=e.spatialReference.wkid||p.toJson(e.spatialReference.toJson(!1)),
g=a.timeExtent?a.timeExtent.toJson().join(","):null;b=this.url+"/exportImage";var h={};this._slices&&(h.sliceid=c);this.disableClientCaching&&(h._ts=(new Date).getTime());c=n.mixin({},this._commonReqParams,{bbox:e.xmin+","+e.ymin+","+e.xmax+","+e.ymax,imageSR:d,bboxSR:d,size:a.width+","+a.height,time:g},h);return this._requestPixels({url:b,payload:c,decodeParams:{width:a.width,height:a.height,planes:null,pixelType:null,format:null,decodeFunc:null,isPoint:!1},tileOptions:a})},readTile:function(a){var b=
this.tileBoundary&&this.tileBoundary[a.level];if(b&&(b.minRow>a.row||b.maxRow<a.row||b.minCol>a.col||b.maxCol<a.col)){var c=new m;c.resolve(a);return c.promise}if(this._slices&&(c=this._getSliceId(),null==c))return c=new m,c.resolve(a),c.promise;b=this.url+"/tile/"+a.level+"/"+a.row+"/"+a.col;var e={width:this.tileInfo.cols,height:this.tileInfo.rows,planes:null,pixelType:null,format:null,decodeFunc:null,isPoint:"elevation"===a.tileType.toLowerCase()?!0:!1};c=this._slices?"sliceid\x3d"+c+"\x26":"";
c=this.disableClientCaching?"_ts\x3d "+(new Date).getTime():c.replace(/&$/,"");return this._requestPixels({url:b+(0<c.length?"?"+c:""),payload:{},decodeParams:e,tileOptions:a})},toJson:function(){return{url:this.url,tileInfo:this.tileInfo,rasterInfo:this.rasterInfo,serviceInfo:this.serviceInfo,sourceType:this.sourceType,_commonReqParams:this._commonReqParams,_rasterId:this._rasterId}},_getSliceId:function(){var a=n.clone(this._imageServiceParams.multidimensionalDefinition),b=n.clone(this._imageServiceParams.time);
if(null==this._slices||null==b&&(null==a||0===a.length))return 0;var c=a||this.defaultMultidimensionalDefinition,e=c[0].variableName;c=this._getAllDimensionDefinition(c,e).definition;a=null;if(null==c||0===c.length)return null;if(b&&this.serviceInfo.timeInfo){if(null==b[1]||b[1]===b[0])var d=b[0];else{var g=this.serviceInfo.timeInfo.startTimeField;d=this.rasterInfo.multidimensionalInfo.variables.find(function(f){return f.name===e}).dimensions.find(function(f){return f.name===g}).values.filter(function(f){return Array.isArray(f)?
Math.max(f[0],b[0])<Math.min(f[1],b[1]):f>=b[0]&&f<=b[1]}).sort(function(f,l){f=Array.isArray(f)?f[1]:f;l=Array.isArray(l)?f[1]:l;return Math.abs(b[1]-f)-Math.abs(b[1]-l)})[0]||[b[1]]}c.some(function(f){if(f.dimensionName===g)return f.values[0]=d,!0;if(!f.dimensionName)return f.dimensionName=g,f.isSlice=!0,f.values=[d],!0})||c.push({variableName:e,dimensionName:g,isSlice:!0,values:[d]})}for(var h=0;h<this._slices.length;h++){var t=this._slices[h].multidimensionalDefinition;if(t.length===c.length&&
!t.some(function(f){var l=c.filter(function(k){return f.variableName===k.variableName&&k.dimensionName===f.dimensionName})[0];if(!l)return!0;var v=Array.isArray(f.values[0])?f.values[0][0]:f.values[0];l=Array.isArray(l.values[0])?l.values[0][0]:l.values[0];return v!==l})){a=h;break}}return a},_getAllDimensionDefinition:function(a,b){var c=a.map(function(d){return d.dimensionName}),e=!1;this.rasterInfo.multidimensionalInfo.variables.forEach(function(d){d.name!==b||d.dimensions.length===a.length&&c[0]||
(d.dimensions.forEach(function(g){0>c.indexOf(g.name)&&(c[0]?a.push({variableName:b,dimensionName:g.name,values:[g.values[0]]}):(a[0].dimensionName=g.name,a[0].values=[g.values[0]],g[0]=g.name))}),e=!0)},this);return{defChanged:e,definition:a}},_generateServiceInfo:function(a){var b=this.url,c=new m(r._dfdCanceller);c._pendingDfd=q({url:b,content:{f:"json",renderingRule:a?p.toJson(a.toJson()):null},handleAs:"json",callbackParamName:"callback"});c._pendingDfd.then(function(e){c.callback(e)},function(e){c.errback(e)});
return c},_fixServiceInfo:function(a){var b=a.spatialReference.wkid;a.tileInfo&&0===a.extent.xmin&&360===a.extent.xmax&&b&&null==E[b]&&(a.tileInfo.applyGCS360Transform=!0)},_parseRasterInfo:function(a){var b=new F;b.bandCount=a.bandCount;b.extent=new w(a.fullExtent);b.spatialReference=a.spatialReference;b.pixelType=a.pixelType;b.width=Math.floor((a.fullExtent.xmax-a.fullExtent.xmin)/a.pixelSizeX+.5);b.height=Math.floor((a.fullExtent.ymax-a.fullExtent.ymin)/a.pixelSizeY+.5);b.cellSize=new D({x:a.pixelSizeX,
y:a.pixelSizeY,spatialReference:a.spatialReference});var c;if(a.minValues&&0<a.minValues.length&&a.maxValues&&a.stdvValues&&a.meanValues){var e=[];for(c=0;c<a.minValues.length;c++)e.push({min:a.minValues[c],max:a.maxValues[c],mean:a.meanValues[c],stddev:a.stdvValues[c]});a.bandCount!==e.length&&(e=null)}this.dataType=a.serviceDataType?a.serviceDataType.replace("esriImageServiceDataType",""):"Generic";b.statistics=e;a.objectIdField&&a.fields&&(b.catalogInfo={objectIdField:a.objectIdField,fields:a.fields});
b.timeInfo=a.timeInfo;if(a.tileInfo){this.tileInfo=new H(a.tileInfo);this.tileInfo.tileType=a.cacheType||"Map";b.tileInfo=this.tileInfo;var d=b.extent,g=this.tileInfo.origin,h=this.tileInfo.cols,t=this.tileInfo.rows;this.tileBoundary=this.tileInfo.lods.map(function(f){return{minCol:Math.floor((d.xmin-g.x+.1*f.resolution)/h/f.resolution),maxCol:Math.floor((d.xmax-g.x-.1*f.resolution)/h/f.resolution),minRow:Math.floor((g.y-d.ymax+.1*f.resolution)/t/f.resolution),maxRow:Math.floor((g.y-d.ymin-.1*f.resolution)/
t/f.resolution)}})}return b},_getColormap:function(a){a=this.url+"/colormap";var b=new m(r._dfdCanceller),c={f:"json"},e=this.serviceInfo.hasColormap||this.rasterInfo&&this.rasterInfo.hasColormap;10<this.serviceInfo.currentVersion&&e?(b._pendingDfd=q({url:a,content:c,handleAs:"json",callbackParamName:"callback"}),b._pendingDfd.then(function(d){b.callback(d.colormap)},function(d){b.errback(d)})):b.callback(null);return b},_getHistograms:function(a){var b=this.url+"/histograms",c=new m(r._dfdCanceller),
e={f:"json"},d=this.serviceInfo.hasHistograms||this.rasterInfo&&this.rasterInfo.hasHistograms;a&&a.renderingRule&&(e.renderingRule=p.toJson(a.renderingRule.toJson()),d=!0);10<this.serviceInfo.currentVersion&&d?(c._pendingDfd=q({url:b,content:e,handleAs:"json",callbackParamName:"callback"}),c._pendingDfd.then(function(g){c.callback(g.histograms)},function(g){c.errback(g)})):c.callback(null);return c},_getRasterAttributeTable:function(a){var b=this.url+"/rasterAttributeTable",c=new m(r._dfdCanceller),
e={f:"json"},d=this.serviceInfo.hasRasterAttributeTable;a&&a.renderingRule&&(e.renderingRule=p.toJson(a.renderingRule.toJson()),d=!0);10<this.serviceInfo.currentVersion&&d?(c._pendingDfd=q({url:b,content:e,handleAs:"json",callbackParamName:"callback"}),c._pendingDfd.then(function(g){c.callback(g)},function(g){c.errback(g)})):c.callback(null);return c},_getKeyProperties:function(a){var b=this.url+"/keyProperties",c=new m(r._dfdCanceller),e={f:"json"};a&&a.renderingRule&&(e.renderingRule=p.toJson(a.renderingRule.toJson()));
10<this.serviceInfo.currentVersion?(c._pendingDfd=q({url:b,content:e,handleAs:"json",callbackParamName:"callback"}),c._pendingDfd.then(function(d){c.callback(d)},function(d){c.errback(d)})):c.callback(null);return c},_getMultidimensionalInfo:function(){var a=this.url+"/multidimensionalInfo",b=new m(r._dfdCanceller);10.3<=this.serviceInfo.currentVersion&&this.serviceInfo.hasMultidimensions?(b._pendingDfd=q({url:a,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}),b._pendingDfd.then(n.hitch(this,
function(c){b.callback(c.multidimensionalInfo)}),function(c){b.errback(c)})):b.callback(null);return b},_getSlices:function(){var a=this.url+"/slices",b=new m(r._dfdCanceller);this.serviceInfo.hasMultidimensions?(b._pendingDfd=q({url:a,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}),b._pendingDfd.then(n.hitch(this,function(c){b.callback(c.slices)}),function(c){b.errback(c)})):b.callback(null);return b},_initializationFailed:function(){},_constructGetImageParams:function(){var a=
this.imageServiceParams||{},b=n.mixin({},this._query,{f:"image",interpolation:a.interpolation,pixelType:a.pixelType,format:a.format||"lerc",compressionQuality:a.compressionQuality,bandIds:a.bandIds?a.bandIds.join(","):null,noData:null!=a.noData?a.noData.join(","):null,noDataInterpretation:a.noDataInterpretation,adjustAspectRatio:null==a.adjustAspectRatio?null:a.adjustAspectRatio,mosaicRule:a.mosaicRule?p.toJson(a.mosaicRule.toJson()):null,renderingRule:a.renderingRule?p.toJson(a.renderingRule.toJson()):
null,token:this.credential&&this.credential.token||null});"lerc"===b.format.toLowerCase()?(b.compressionTolerance=a.compressionTolerance,10.5<=this.serviceInfo.currentVersion&&(b.lercVersion=a.lercVersion||2)):"tiff"===b.format.toLowerCase()?b.compression=a.compression:-1<["jpg","jpeg","jpg","jpgpng"].indexOf(b.format.toLowerCase())&&(b.compression=a.compression);this._commonReqParams=b},_getRasterIdentifier:function(a){if(this._rasterId)return this._rasterId;a=this.url.replace("http:","").replace("https:",
"");var b=[],c=this.imageServiceParams||{};b.push(a);b.push(c.interpolation);b.push(c.pixelType);b.push(c.compressionQuality);b.push(c.bandIds?c.bandIds.join(","):"");b.push(c.mosaicRule?p.toJson(c.mosaicRule.toJson()):"");b.push(c.renderingRule?p.toJson(c.renderingRule.toJson()):"");a=b.join("|");return this._rasterId=this._computeSignature(a)},_wrapExtent:function(a){var b=a.spatialReference._getInfo();if(b){var c=b.valid[0];b=b.valid[1];if(a.xmin<c-this.resolution.x||a.xmax>b+this.resolution.y){var e=
new w((a.xmin-c)%(b-c),a.ymin,(a.xmax-b)%(b-c),a.ymax,a.spatialReference);e.xmax<e.xmin&&(e=null)}}return e||a}});z("extend-esri")&&n.setObject("layers.rasterLib.raster.ImageServiceRaster",u,C);return u});