// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/rasterLib/raster/TileServiceRaster","require dojo/_base/declare dojo/_base/lang dojo/_base/Deferred dojo/_base/array dojo/_base/config dojo/_base/json dojo/sniff dojo/DeferredList dojo/when ../../../kernel ../../../Evented ../../../request ../../../geometry/Extent ../../../geometry/Point ../../../SpatialReference ../../../deferredUtils ../../../urlUtils ../../PixelBlock ../../rasterFormats/rasterCodec ../tile/RasterTileInfo ./RasterInfo ./BasicRaster".split(" "),function(h,r,k,
l,E,F,G,t,H,u,v,I,w,x,y,z,A,J,K,L,B,C,D){h=r([D],{declaredClass:"esri.layers.rasterLib.raster.TileServiceRaster",constructor:function(a){},open:function(){var a=new l,b=this.serviceInfo||this._getServiceInfo(null),c=k.hitch(this,function(e){this.serviceInfo=e;this.version=e.currentVersion;this.rasterInfo=this._parseRasterInfo(e);this.loaded=!0;this._getRasterIdentifier();a.resolve(this)}),f=k.hitch(this,function(e){this.loaded=!0;this._getRasterIdentifier();a.reject(e)});u(b,c,f);return a.promise},
read:function(a){var b=this.url+"/tile/"+a.level+"/"+a.row+"/"+a.col,c={width:this.tileInfo.cols,height:this.tileInfo.rows,planes:null,pixelType:null,format:null,decodeFunc:null,isPoint:"elevation"===this.tileType.toLowerCase()?!0:!1};return this._requestPixels({url:b+(this.disableClientCaching?"?_ts\x3d "+(new Date).getTime():""),payload:{},decodeParams:c,tileOptions:a})},identify:function(a,b){null==b&&(b=this.tileInfo.lods[this.tileInfo.lods.length-1].level);var c=(a.x-this.tileInfo.origin.x)/
this.tileInfo.lods[b].resolution/this.tileInfo.cols;a=(this.tileInfo.origin.y-a.y)/this.tileInfo.lods[b].resolution/this.tileInfo.rows;var f=Math.floor(c),e=Math.floor(a),m=Math.floor((c-f)*this.tileInfo.cols);m=Math.min(m,this.tileInfo.cols-1);var n=Math.floor((a-e)*this.tileInfo.rows);n=Math.min(n,this.tileInfo.rows-1);var g=new l;this.read({level:b,row:e,col:f}).then(function(d){var p=n*d.width+m;d&&d.pixels&&0<d.pixels.length?(d=d.mask?d.mask[p]?d.pixels.map(function(q){return q[p]}):null:d.pixels.map(function(q){return q[p]}),
g.resolve(d)):g.reject("no valid data")},function(d){g.reject(d)});return g.promise},setFetchParameters:function(a,b){},_getRasterIdentifier:function(){this._rasterId||(this._rasterId=this.url.replace("http:","").replace("https:",""));return this._rasterId},_getServiceInfo:function(){var a=this.url,b=new l(A._dfdCanceller);b._pendingDfd=w({url:a,content:{f:"json"},handleAs:"json",callbackParamName:"callback"});b._pendingDfd.then(function(c){b.callback(c)},function(c){b.errback(c)});return b},_parseRasterInfo:function(a){var b=
new C;b.extent=new x(a.fullExtent);b.spatialReference=new z(a.spatialReference);this.tileType=a.cacheType||"Map";switch(this.tileType){case "Map":b.bandCount=3;b.pixelType="U8";this.dataType="Processed";break;case "Elevation":b.bandCount=1;b.pixelType=a.pixelType||"F32";this.dataType="Elevation";break;case "Raster":b.bandCount=null,b.pixelType=null,this.dataType=a.serviceDataType&&a.serviceDataType.replace("esriImageServiceDataType","")||"Generic"}var c=a.tileInfo;b.width=Math.floor((a.fullExtent.xmax-
a.fullExtent.xmin)/c.lods[c.lods.length-1].resolution+.5);b.height=Math.floor((a.fullExtent.ymax-a.fullExtent.ymin)/c.lods[c.lods.length-1].resolution+.5);b.cellSize=new y({x:c.lods[c.lods.length-1].resolution,y:c.lods[c.lods.length-1].resolution,spatialReference:a.spatialReference});this.tileInfo=new B(c);this.tileInfo.tileType=this.tileType;return b}});t("extend-esri")&&k.setObject("layers.rasterLib.raster.TileServiceRaster",h,v);return h});