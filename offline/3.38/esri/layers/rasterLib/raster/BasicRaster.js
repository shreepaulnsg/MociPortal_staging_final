// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/rasterLib/raster/BasicRaster","require dojo/_base/declare dojo/_base/lang dojo/_base/Deferred dojo/_base/array dojo/_base/config dojo/_base/json dojo/sniff dojo/DeferredList dojo/when ../../../kernel ../../../Evented ../../../request ../../../geometry/Extent ../../../geometry/Point ../../../SpatialReference ../../../deferredUtils ../../../urlUtils ../../MosaicRule ../../ImageServiceParameters ../../PixelBlock ../../rasterFormats/rasterCodec ../tile/RasterHandler ./rasterProjectionHelper ./RasterInfo".split(" "),
function(E,w,p,r,F,G,H,I,J,K,v,x,y,t,L,M,q,z,N,O,A,B,C,l,P){return w([x],{url:null,dataType:null,rasterInfo:null,tileInfo:null,serviceInfo:null,loaded:null,constructor:function(a){if(a){var b=a.url;b&&(b=z.urlToObject(b),this.url=b.path,this._query=b.query);this.dataType=a.dataType;this.serviceInfo=a.serviceInfo;this.rasterInfo=a.rasterInfo;this.tileInfo=a.tileInfo;this.serviceInfo=a.serviceInfo}},open:function(){},read:function(a){},identify:function(a){var b=new r,d=this.rasterInfo.extent;if(l.requirePE(d.spatialReference,
a.spatialReference))l.load().then(p.hitch(this,function(){h=l.project(a,d.spatialReference);b.resolve(h)}),function(){b.reject(Error("cannot project into this spatial reference"))});else{var h=l.project(a,d.spatialReference);b.resolve(h)}return b.then(p.hitch(this,function(c){var e=this.tileInfo,g=e.origin,f=e.lods[e.lods.length-1],k=(c.x-g.x)/e.cols/f.resolution;c=(g.y-c.y)/e.rows/f.resolution;var n=Math.round((c-Math.floor(c))*e.rows)*e.cols+Math.round((k-Math.floor(k))*e.cols);g=new t(g.x+f.resolution*
e.cols*k,g.y-f.resolution*e.rows*(c+1),g.x+f.resolution*e.cols*(k+1),g.y-f.resolution*e.rows*c,d.spatialReference);var u=this.getMemberRasters?this.getMemberRasters()[0]:this;return u.read({level:f.level,row:Math.floor(c),col:Math.floor(k),extent:g,width:e.cols,height:e.rows,virtual:u.tileInfo.virtual,tileType:u.tileInfo.tileType}).then(function(m){return(m=m&&m.pixelBlock)&&m.pixels&&0<m.pixels.length&&(!m.mask||m.mask[n])?{pixelValue:m.pixels.map(function(D){return D[n]})}:{pixelValue:null}})}))},
getProjectedFullExtent:function(a,b){var d=new r;if(this.projectedFullExtent&&!b)return d.resolve(this.projectedFullExtent),d.promise;var h=this.rasterInfo.extent;if(l.requirePE(this.rasterInfo.extent.spatialReference,a))l.load().then(p.hitch(this,function(){c=l.project(h,a);this.projectedFullExtent=c=new t(c.toJson());d.resolve(c)}),function(){d.reject(Error("cannot project into this spatial reference"))});else{var c=l.project(h,a);this.projectedFullExtent=c=new t(c.toJson());d.resolve(c)}return d.promise},
setFetchParameters:function(a,b){},_setRasterHandler:function(a){this._rasterHandler=a;this.getMemberRasters&&this.getMemberRasters().forEach(p.hitch(this,function(b){b._rasterHandler=a}))},_findCredential:function(){this.url&&((this._credential=v.id&&v.id.findCredential(this.url))&&this._credential.ssl||this.serviceInfo&&this.serviceInfo._ssl)&&(this.url=this.url.replace(/^http:/i,"https:"))},_initWorker:function(){this._rasterHandler=new C;this._rasterHandler.start().then(function(){this._rasterHandlerInitialized=
!0}.bind(this))},_requestPixels:function(a){var b=a.url,d=a.payload,h=a.decodeParams,c=a.tileOptions,e=new r(q._dfdCanceller);this._rasterHandler||this._initWorker();var g=this._rasterHandler,f={};b={url:b,handleAs:"arraybuffer",content:d};a.headers&&(b.headers=a.headers);e._pendingDfd=y(b).then(p.hitch(this,function(k){(g&&this._rasterHandlerInitialized?g.decode({encodedData:k,decodeParams:h}):B.decode(k,h)).then(function(n){f.pixelBlock=new A(n);f.extent=c.extent;f.level=c.level;f.row=c.row;f.col=
c.col;f.width=c.width;f.height=c.height;q._resDfd(e,[f])},function(n){q._resDfd(e,[n],!0)})}),function(k){q._resDfd(e,[k],!0)});return e},_computeSignature:function(a){if("string"===typeof a){for(var b=new Uint8Array(a.length),d=0;d<a.length;d++)b[d]=a.charCodeAt(d);a=b}d=b=65535;for(var h=a.length,c=Math.floor(h/2),e=0;c;){var g=359<=c?359:c;c-=g;do b+=a[e++]<<8,d+=b+=a[e++];while(--g);b=(b&65535)+(b>>>16);d=(d&65535)+(d>>>16)}h&1&&(d+=b+=a[e]<<8);return((d&65535)+(d>>>16)<<16|(b&65535)+(b>>>16))>>>
0}})});