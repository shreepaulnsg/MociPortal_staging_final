// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/rasterLib/raster/TileRaster","require dojo/_base/declare dojo/_base/lang dojo/_base/Deferred dojo/_base/array dojo/_base/config dojo/_base/json dojo/sniff dojo/DeferredList dojo/when ../../../kernel ../../../Evented ../../../request ../../../geometry/Extent ../../../geometry/Point ../../../SpatialReference ../../../deferredUtils ../../../urlUtils ../../PixelBlock ../../rasterFormats/rasterCodec ../tile/RasterTileInfo ./RasterInfo ./BasicRaster".split(" "),function(l,r,k,n,D,E,
F,t,G,u,v,H,p,w,x,y,I,J,K,L,z,A,B){l=r([B],{declaredClass:"esri.layers.rasterLib.raster.TileRaster",sourceType:"TileCache",_RECORD_SIZE:8,constructor:function(a){this._cloudBlobStorage=a&&a._cloudBlobStorage},open:function(){var a=new n,b=this.datasetInfo||this._getDatasetInfo(null),c=k.hitch(this,function(d){this.datasetInfo=d;this.rasterInfo=d=this._parseRasterInfo(d);this.tileType="Cache/LERC"===d.format?"Elevation":"Cache/MIXED"===d.format||"Cache/JPEG"===d.format||"Cache/PNG"===d.format?"Map":
"Raster";this.tileInfo=d.tileInfo;this.dataType=["Generic","Elevation","Processed"][["Raster","Elevation","Map"].indexOf(this.tileType)];this._HEADER_SIZE=d.packetSize*d.packetSize*this._RECORD_SIZE+64;this.loaded=!0;this._cloudBlobStorage=this._cloudBlobStorage||-1<this.url.toLowerCase().indexOf("s3.amazonaws.com")||-1<this.url.toLowerCase().indexOf("windows.net")||-1<this.url.toLowerCase().indexOf("googleapis.com");this._getRasterIdentifier();a.resolve(this)}),e=k.hitch(this,function(d){this.loaded=
!0;this._getRasterIdentifier();a.reject(d)});u(b,c,e);return a.promise},read:function(a){var b=new n,c=a.level,e=a.row,d=a.col,g=this._buildCacheFilePath(this.url,c,e,d),h=this._getIndexRecordFromBundle(c,e,d);p({url:g,content:{},headers:{Range:"bytes\x3d0-"+(this._HEADER_SIZE-1).toString()},handleAs:"arraybuffer"}).then(k.hitch(this,function(f,q){if(!b.isCanceled()){console.log("time in ms request "+(new Date-C));var C=new Date;f=new Uint8Array(f);f=this._getTileEndAndContentType(f,h);q={width:this.tileInfo.cols,
height:this.tileInfo.rows,planes:null,pixelType:null,format:null,decodeFunc:null,isPoint:"elevation"===this.tileType.toLowerCase()?!0:!1};this._requestPixels({url:g+(this.disableClientCaching?"?_ts\x3d "+(new Date).getTime():""),payload:{},headers:{Range:"bytes\x3d"+f.position.toString()+"-"+(f.position+f.recordSize).toString()},decodeParams:q,tileOptions:a}).then(function(m){b.isCanceled()||b.resolve(m)},function(m){b.isCanceled()||b.reject(m)})}}));return b.promise},identify:function(){return null},
setFetchParameters:function(a,b){},toJson:function(){return{url:this.url,tileInfo:this.tileInfo.toJson(),rasterInfo:this.rasterInfo.toJson(),datasetInfo:this.datasetInfo,sourceType:this.sourceType,tileType:this.tileType,_rasterId:this._rasterId}},_getDatasetInfo:function(){return p({url:this.url+"/conf.json",handleAs:"json",content:{}})},_parseRasterInfo:function(a){var b=new A;switch(a.pixelType){case 1:var c="U1";break;case 1:c="U2";break;case 2:c="U4";break;case 3:c="U8";break;case 4:c="S8";break;
case 5:c="U16";break;case 6:c="S16";break;case 7:c="U32";break;case 8:c="S32";break;case 9:c="F32";break;default:c="F32"}var e,d=[],g=a.LODInfos;for(e=0;e<g.levels.length;e++)d.push({level:g.levels[e],resolution:g.resolutions[e],scale:96/.0254*g.resolutions[e]});e=new y(a.extent.spatialReference||a.geodataXform.spatialReference);d=new z({rows:a.blockHeight,cols:a.blockWidth,dpi:96,format:a.format,compressionQuality:0,origin:a.origin,spatialReference:e,lods:d});b.pixelType=c;b.bandCount=a.bandCount;
b.spatialReference=e;b.extent=new w({xmin:a.extent.xmin,ymin:a.extent.ymin,xmax:a.extent.xmax,ymax:a.extent.ymax,spatialReference:e});b.cellSize=new x({x:a.pixelSizeX,y:a.pixelSizeY,spatialReference:e});b.width=Math.floor((b.extent.xmax-b.extent.xmin)/b.cellSize.x+.5);b.height=Math.floor((b.extent.ymax-b.extent.ymin)/b.cellSize.y+.5);b.statistics=a.statistics.map(function(h){Object.keys(h).forEach(function(f){isNaN(h[f])&&(h[f]=null)});return h});b.histograms=a.histograms;b.geodataXform=a.geodataXform;
b.packetSize=a.packetSize;b.format=a.format;b.compressionQuality=a.compressionQuality;b.tileInfo=d;return b},_getRasterIdentifier:function(){this._rasterId||(this._rasterId=this.url.replace("http:","").replace("https:",""));return this._rasterId},_buildCacheFilePath:function(a,b,c,e){var d=this.rasterInfo.packetSize;e=Math.floor(e/d)*d;c="R"+this._toHexString4(Math.floor(c/d)*d)+"C"+this._toHexString4(e);d="L";d=10<=b?d+b.toString():d+("0"+b.toString());return this._cloudBlobStorage?a+"/_alllayers/"+
d+"/"+c+".bundle":a+"/"+d+"_"+c+"/bundle"},_getIndexRecordFromBundle:function(a,b,c){a=this.rasterInfo.packetSize;b=b%a*a+c%a;if(0>b)throw"Invalid level / row / col";return b*this._RECORD_SIZE+64},_getTileEndAndContentType:function(a,b){a=a.subarray(b,b+8);b=0;var c;for(c=0;5>c;c++)b|=(a[c]&255)<<8*c;var e=b&0xffffffffff;b=0;for(c=5;8>c;c++)b|=(a[c]&255)<<8*(c-5);return{position:e,recordSize:b&0xffffffffff}},_toHexString4:function(a){a=a.toString(16);if(4!=a.length)for(var b=4-a.length;0<b--;)a="0"+
a;return a}});t("extend-esri")&&k.setObject("layers.rasterLib.raster.TileRaster",l,v);return l});