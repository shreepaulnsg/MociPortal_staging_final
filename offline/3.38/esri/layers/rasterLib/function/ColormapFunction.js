// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/rasterLib/function/ColormapFunction","dojo/_base/declare dojo/_base/lang ../../../renderers/colorRampGenerator ./RasterFunctionX ./pixelShaders ./RasterFunctionWebGLMixin ./rasterUtils".split(" "),function(n,p,k,q,r,t,m){return n([q,t],{declaredClass:"esri.layers.rasterLib.function.ColormapFunction",functionName:"Colormap",pixelType:"U8",renderTexture:!1,supportWebGL:!0,support2D:!0,constructor:function(a){this.functionArguments=this.mixinIgnoreCase({colormap:null,colorRampName:null,
colorRamp:null,colorMapName:null,raster:null},a);this.invert=a&&a.invert;a=a.colormap||a.Colormap;if(a){if(a.features||a[0].attributes){a=a.features||a;var d=Object.keys(a[0].attributes);var b=d.filter(function(f){return"alpha"===f.toLowerCase()})[0];var c=d.filter(function(f){return"value"===f.toLowerCase()})[0];var e=d.filter(function(f){return"red"===f.toLowerCase()})[0];var g=d.filter(function(f){return"green"===f.toLowerCase()})[0];var l=d.filter(function(f){return"blue"===f.toLowerCase()})[0];
if(!(c&&e&&g&&l))throw"invalid colormap";a=a.map(function(f){return b?[f.attributes[c],f.attributes[e],f.attributes[g],f.attributes[l],f.attributes[b]]:[f.attributes[c],f.attributes[e],f.attributes[g],f.attributes[l]]});var h=1.1>Math.max.apply(null,a.map(function(f){return f[1]}));d=b&&1.1>Math.max.apply(null,a.map(function(f){return f[4]}));if(h)for(h=0;h<a.length;h++)a[h][1]=Math.round(255*a[h][1]),a[h][2]=Math.round(255*a[h][2]),a[h][3]=Math.round(255*a[h][3]),d&&(a[h][4]=Math.round(255*a[h][4]))}this.functionArguments.colormap=
this._sortClr(a)}this._initialize()},bind:function(a){this._initialize();a=this.getSourceRasterInfo(a);if(!a.raster||"F32"===a.raster.pixelType)return Error("The raster input to colormap function is invalid. It must be integer type.");this.rasterInfo=p.mixin(a.raster,{bandCount:3,pixelType:this._calculatePixelType(this.pixelType,"U8"),statistics:null,histograms:null});this.rasterInfo.keyProperties=this.rasterInfo.keyProperties||{};this.rasterInfo.keyProperties.DataType="Processed";return!0},read2D:function(a){return this._colorize(a.raster)},
readGL:function(a){return this._colorizeGL(a.raster)},_colorize:function(a){this._performance.start();var d=m.colorize(a.pixelBlock,{indexedColormap:this._indexedColormap,indexedColormapOffset:this._indexedColormapOffset,indexed2DColormap:this._indexed2DColormap,alphaSpecified:this._alphaSpecified});this._addPerformanceMetric(this._performance.elapsed());return{extent:a.extent,pixelBlock:d}},_binarySearchClr:function(a,d){for(var b=0,c=a.length-1,e=0,g=0;b<c;)if(e=Math.floor((b+c)/2),g=a[e],g[0]<
d)b=e;else if(g[0]>d)c=e;else return g.slice(1);return null},_sortClr:function(a,d){var b,c=[];for(b=0;b<a.length;b++)c.push(a[b]);for(b=0;b<c.length-1;b++){var e=c[b];for(a=b+1;a<c.length;a++)e[0]>c[a][0]&&(e=c[a],c[a]=c[b],c[b]=e)}if(d)for(b=0;b<c.length/2;b++)e=c[b],c[c.length-1-b]=c[b],c[b]=e;return c},_invertColorRamp:function(a){if(!a)return a;var d={type:a.type};"random"===a.type?d=a:"multipart"===a.type?d.colorRamps=a.colorRamps.map(function(b){return{fromColor:b.toColor,toColor:b.fromColor}}).reverse():
(d.fromColor=a.toColor,d.toColor=a.fromColor);return d},_initialize:function(){this._indexedColormapOffset=0;if(this.functionArguments.colormap){var a=m.buildIndexedColormap(this.functionArguments.colormap);this._alphaSpecified=a&&a.alphaSpecified;this._indexedColormap=a&&a.indexedColormap;this._indexedColormapOffset=a&&a.offset;this._indexedColormap||(this._indexed2DColormap=this._getIndexed2DColormap())}else this.functionArguments.colorRamp?this._indexedColormap="multipart"===this.functionArguments.colorRamp.type?
this.invert?k.createMultiPartColorRamp(this._invertColorRamp(this.functionArguments.colorRamp)):k.createMultiPartColorRamp(this.functionArguments.colorRamp):this.invert?k.createAlgorithmicColorRamp(this._invertColorRamp(this.functionArguments.colorRamp)):k.createAlgorithmicColorRamp(this.functionArguments.colorRamp):this.functionArguments.colormapName&&"random"===this.functionArguments.colormapName.toLowerCase()&&(this._indexedColormap=k.createRandomColorRamp())},_getIndexed2DColormap:function(){var a=
this.functionArguments.colormap;if(!a)return null;var d=0;0>a[0][0]&&(d=a[0][0]);var b=[],c=5===a[0].length,e;for(e=0;e<a.length;e++)b[a[e][0]-d]=c?a[e].slice(1):a[e].slice(1).concat([255]);return b},_colorizeGL:function(a){this._performance.start();this._initializeProgram({fragment:r.colormap,fragmentName:"Colormap"});var d=this._indexedColormap,b=this._indexedColormapOffset;this._clrTexture||(this._clrTexture=this._setupColormapTexture(d));var c=this._clrTexture,e=this.bindFrameBuffer();a=this._setupTextureData(a);
this._setUniforms({u_indexedColormapOffset:b,u_indexedColormapMaxIndex:d.length/4-1});this._bindTexture(c,"u_image1");this._bindTexture(a.texture,"u_image");this._drawGL();return{extent:a.extent,texture:e.texture}},_setupColormapTexture:function(a){var d=this._createTexture(),b=this.gl,c=a.length/4,e=new Float32Array(a.length),g,l=this.renderTexture?255:1;for(g=0;g<a.length;g++)e[g]=a[g]/l;b.getExtension("OES_texture_float");b.texImage2D(b.TEXTURE_2D,0,b.RGBA,c,1,0,b.RGBA,b.FLOAT,e);return d}})});