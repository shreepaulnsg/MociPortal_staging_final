// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/rasterLib/function/StretchFunction","dojo/_base/declare dojo/_base/lang ./RasterFunctionX ../../PixelBlock ./vertexShaders ./pixelShaders ./RasterFunctionWebGLMixin".split(" "),function(K,E,L,M,F,x,N){return K([L,N],{declaredClass:"esri.layers.rasterLib.function.StretchFunction",functionName:"Stretch",supportWebGL:!0,support2D:!0,constructor:function(b){this.functionArguments=this.mixinIgnoreCase({stretchType:0,min:0,max:255,numberOfStandardDeviations:2,statistics:null,histograms:null,
dra:!1,minPercent:.25,maxPercent:.5,useGamma:!1,gamma:null,raster:null,computeGamma:!1},b);this.functionArguments.statistics=this._convertStats(this.functionArguments.statistics);-1===[0,3,5,6].indexOf(this.functionArguments.stretchType)&&(console.error("The specific stretch type has not been implemented: "+this.functionArguments.stretchType),this.functionArguments.stretchType=5);this.min=null==this.min?0:this.min;this.max=null==this.max?255:this.max},bind:function(b){b=this.getSourceRasterInfo(b);
if(!b.raster)return Error("The raster input to stretch function is invalid.");b.raster.statistics&&(this.srcStatistics=this._convertStats(b.raster.statistics));b.raster.histograms&&(this.srcHistograms=b.raster.histograms);this.rasterInfo=E.mixin({},b.raster,{bandCount:b.raster.bandCount,pixelType:this._calculatePixelType(this.pixelType,"U8"),statistics:null,histograms:null});this.rasterInfo.keyProperties=this.rasterInfo.keyProperties||{};this.rasterInfo.keyProperties.DataType="Generic";return!0},
read2D:function(b){b=b.raster;this._stretch(b);return b},hasTilingEffects:function(b){b=b||this.functionArguments;return!!(b.dra||b.raster&&"object"===typeof b.raster&&b.raster.dra)},_convertStats:function(b){return b?b.map(function(d){return d&&null!=d.min?[d.min,d.max,d.mean,d.stddev]:d}):null},_updateStatistisHistograms:function(b){var d=this.functionArguments,c=d.histograms||this.srcHistograms;if(b&&b.pixelBlock&&b.pixelBlock.pixels){if(0===d.stretchType)this._statistics=d.statistics&&0<d.statistics.length?
d.statistics:this.srcStatistics,this._histograms=c;else{var a=b.pixelBlock,k=a.pixels.length,f=6===d.stretchType&&(d.dra||!c)||3===d.stretchType&&d.dra;f&&(a.statistics||a.calculateStatistics(),this._calculateStatisticsHistograms(b));if(d.dra)if(a.statistics||a.calculateStatistics(),f)this._statistics=a.statistics,this._histograms=a.histograms;else for(d=a.statistics,this._statistics=[],b=0;b<k;b++)this._statistics[b]=[d[b].minValue,d[b].maxValue,0,0];else this._statistics=d.statistics&&0<d.statistics.length?
d.statistics:this.srcStatistics,this._histograms=c}this._statistics=this._convertStats(this._statistics);this._gammaCorrection=this._getGammaCorrection()}else this._statistics=d.statistics&&0<d.statistics.length?d.statistics:this.srcStatistics,this._histograms=c,this._gammaCorrection=this._getGammaCorrection(),this._statistics=this._convertStats(this._statistics)},_getGammaCorrection:function(){var b=this.functionArguments.gamma;if(b){var d=[],c;for(c=0;c<b.length;c++)d[c]=1<b[c]?2<b[c]?6.5+Math.pow(b[c]-
2,2.5):6.5+100*Math.pow(2-b[c],4):1;return d}},_stretch:function(b){if(null!==b&&null!==b.pixelBlock&&null!==b.pixelBlock.pixels&&0!==this.functionArguments.stretchType){this._updateStatistisHistograms(b);var d=b.pixelBlock,c=d.pixels;d=d.width*d.height;var a=c.length,k,f;this._createLUT(b);if(null==this.LUT)return this._filterNoLUT(b);var g=this.LUT,n=this.LUTOffset;for(k=0;k<a;k++){var l=g[k];for(f=0;f<d;f++){var r=c[k][f];c[k][f]=l[r-n]}}b.pixelBlock.pixelType="U8"}},_calculateStatisticsHistograms:function(b){b=
b.pixelBlock;var d=b.pixelType,c=b.pixels,a=b.mask,k=c.length,f,g,n=function(v){this.min=-.5;this.max=255.5;this.size=256;E.mixin(this,v);this.counts=this.counts||new Uint32Array(this.size)},l=[],r,p;for(f=0;f<k;f++){var h=new n;var e=h.counts;var q=c[f];if("U8"===d)if(a)for(g=0;g<b.width*b.height;g++)a[g]&&e[q[g]]++;else for(g=0;g<b.width*b.height;g++)e[q[g]]++;else{var t=b.statistics[f].minValue;var m=b.statistics[f].maxValue;h.min=t;h.max=m;m=(m-t)/256;var u=new Uint32Array(257);if(a)for(g=0;g<
b.width*b.height;g++)a[g]&&u[Math.floor((q[g]-t)/m)]++;else for(g=0;g<b.width*b.height;g++)u[Math.floor((q[g]-t)/m)]++;for(g=0;255>g;g++)e[g]=u[g];e[255]=u[255]+u[256]}l.push(h);q=[];t=b.statistics[f].minValue;m=b.statistics[f].maxValue;for(g=p=r=u=0;g<h.size;g++)u+=e[g],r+=g*e[g];r/=u;for(g=0;g<h.size;g++)p+=e[g]*Math.pow(g-r,2);e=Math.sqrt(p/(u-1));g=(r+.5)*(h.max-h.min)/h.size+h.min;h=e*(h.max-h.min)/h.size;q.push(t);q.push(m);q.push(g);q.push(h);b.statistics[f]={min:t,minValue:t,max:m,maxValue:m,
mean:g,stddev:h}}b.histograms=l},_getCutOffPoints:function(b){var d=this.functionArguments,c=999;b&&b.pixelBlock?c=b.pixelBlock.pixels.length:b&&b.texture&&(c=3);b=Math.min(c,this._statistics.length);var a=[],k=[],f,g;switch(d.stretchType){case 5:for(f=0;f<b;f++)a[f]=this._statistics[f][0],k[f]=this._statistics[f][1];break;case 3:for(f=0;f<b;f++)a[f]=this._statistics[f][2]-d.numberOfStandardDeviations*this._statistics[f][3],k[f]=this._statistics[f][2]+d.numberOfStandardDeviations*this._statistics[f][3],
a[f]<this._statistics[f][0]&&(a[f]=this._statistics[f][0]),k[f]>this._statistics[f][1]&&(k[f]=this._statistics[f][1]);break;case 6:for(f=0;f<b;f++){c=this._histograms[f];var n=new Uint32Array(c.size);var l=c.counts;var r=0;var p=-.5===c.min&&1===(c.max-c.min)/l?.5:0;for(g=0;g<c.size;g++)r+=l[g],n[g]=r;l=d.minPercent*r/100;for(g=0;g<c.size;g++)if(n[g]>l){a[f]=c.min+(c.max-c.min)/c.size*(g+p);break}l=(1-d.maxPercent/100)*r;for(g=c.size-2;0<=g;g--)if(n[g]<l){k[f]=c.min+(c.max-c.min)/c.size*(g+2-p);break}}break;
default:for(f=0;f<c;f++)a[f]=0,k[f]=255}return{minCutOff:a,maxCutOff:k}},_createLUT:function(b){var d=this.functionArguments,c=b.pixelBlock,a=c.pixelType;if("U8"===a||"U16"===a||"S8"===a||"S16"===a){if(this._LUTSignature&&(a=this._computeLutSignature(),a.length===this._LUTSignature.length&&!a.some(function(z,A){return z!==this._LUTSignature[A]}.bind(this))))return;a=c.pixels.length;var k=[],f=[],g=d.max,n=d.min,l=d.gamma,r=g-n,p=this._getCutOffPoints(b);b=p.minCutOff;p=p.maxCutOff;var h=0,e=256;"S8"===
c.pixelType?h=-127:"S16"===c.pixelType&&(h=-32767);if("U16"===c.pixelType||"S16"===c.pixelType)e=65536;for(c=0;c<a;c++)k[c]=p[c]-b[c];var q=this._gammaCorrection;if(d.useGamma)for(c=0;c<a;c++){var t=[];for(d=0;d<e;d++){var m=d+h;var u=(m-b[c])/k[c];var v=1;1<l[c]&&(v-=Math.pow(1/r,u*q[c]));m<p[c]&&m>b[c]?t[d]=Math.floor(v*r*Math.pow(u,1/l[c]))+n:m>p[c]?t[d]=g:m<b[c]&&(t[d]=n)}f[c]=t}else for(c=0;c<a;c++){t=[];for(d=0;d<e;d++)m=d+h,t[d]=m<b[c]?n:m>p[c]?g:Math.floor((m-b[c])/k[c]*r)+n;f[c]=t}this.LUT=
f;this.LUTOffset=h;this._LUTSignature=this._computeLutSignature()}},_computeLutSignature:function(){var b=this.functionArguments,d=[],c,a;d.push(b.stretchType);d.push(b.min);d.push(b.max);d.push(b.numberOfStandardDeviations);if(this._statistics)for(c=0;c<this._statistics.length;c++)for(a=0;a<this._statistics[c].length;a++)d.push(this._statistics[c][a]);d.push(b.dra?1:0);d.push(b.minPercent);d.push(b.maxPercent);if(b.gamma)for(c=0;c<this._statistics.length;c++)d.push(b.gamma[c]);d.push(b.useGamma?
1:0);return d},_filterNoLUT:function(b){if(null!==b&&null!==b.pixelBlock&&null!==b.pixelBlock.pixels){var d=this.functionArguments,c=b.pixelBlock,a=c.pixels,k=c.mask;c=c.width*c.height;var f=a.length,g=[],n=[],l=d.max,r=d.min,p=d.gamma,h=l-r;var e=this._getCutOffPoints(b);var q=e.minCutOff,t=e.maxCutOff;for(e=0;e<f;e++)g[e]=t[e]-q[e];if(d.useGamma&&null!==p&&p.length>=f)for(e=0;e<f;e++)n[e]=1<p[e]?2<p[e]?6.5+Math.pow(p[e]-2,2.5):6.5+100*Math.pow(2-p[e],4):1;if(d.useGamma)if(void 0!==k&&null!==k)for(d=
0;d<c;d++){if(k[d])for(e=0;e<f;e++){var m=a[e][d];var u=(m-q[e])/g[e];var v=1;1<p[e]&&(v-=Math.pow(1/h,u*n[e]));m<t[e]&&m>q[e]?a[e][d]=Math.floor(v*h*Math.pow(u,1/p[e]))+r:m>t[e]?a[e][d]=l:m<q[e]&&(a[e][d]=r)}}else for(d=0;d<c;d++)for(e=0;e<f;e++)m=a[e][d],u=(m-q[e])/g[e],v=1,1<p[e]&&(v-=Math.pow(1/h,u*n[e])),m<t[e]&&m>q[e]?a[e][d]=Math.floor(v*h*Math.pow(u,1/p[e]))+r:m>t[e]?a[e][d]=l:m<q[e]&&(a[e][d]=r);else if(void 0!==k&&null!==k)for(d=0;d<c;d++){if(k[d])for(e=0;e<f;e++)m=a[e][d],m<t[e]&&m>q[e]?
a[e][d]=Math.floor((m-q[e])/g[e]*h)+r:m>t[e]?a[e][d]=l:m<q[e]&&(a[e][d]=r)}else for(d=0;d<c;d++)for(e=0;e<f;e++)m=a[e][d],m<t[e]&&m>q[e]?a[e][d]=Math.floor((m-q[e])/g[e]*h)+r:m>t[e]?a[e][d]=l:m<q[e]&&(a[e][d]=r);b.pixelBlock.pixelType="U8";return b}},_computeGammaValues:function(b){var d=this._statistics.length,c,a=[];for(c=0;c<d;c++){var k=this._statistics[c][2];"U8"!==b&&(k=255*(k-this._statistics[c][0])/(this._statistics[c][1]-this._statistics[c][0]));a.push(this._computeGammaValue(k))}return a},
_computeGammaValue:function(b){if(0!==b&&!(255<b||0>b)){var d=0;0<b&&150!=b&&255>b&&(d=150>=b?45*Math.cos(.01047*b):17*Math.sin(.021*b));d=Math.log((b+d)/255);if(0!==d&&(b=Math.log(b/255)/d,!isNaN(b)))return Math.min(9.9,Math.max(.01,b))}},readGL:function(b){return this._stretchGL(b.raster)},_stretchGL:function(b){this._performance.start();var d=this.renderTexture,c,a=b.pixelBlock&&b.pixelBlock.pixels&&b.pixelBlock.pixels.length||this.sourceRasterInfo.raster.bandCount,k=b.pixelBlock,f=this.gl,g=f.drawingBufferWidth,
n=f.drawingBufferHeight;if(!k&&this.functionArguments.dra){var l=new Float32Array(g*n*4),r=new Uint8Array(g*n);var p=new Float32Array(g*n);var h=new Float32Array(g*n);var e=new Float32Array(g*n);f.checkFramebufferStatus(f.FRAMEBUFFER)==f.FRAMEBUFFER_COMPLETE&&f.readPixels(0,0,g,n,f.RGBA,f.FLOAT,l);for(c=0;c<g*n;c++)p[c]=l[4*c],h[c]=l[4*c+1],e[c]=l[4*c+2],r[c]=l[4*c+3];b.pixelBlock=new M({width:g,height:n,pixels:[p,h,e],mask:r});b.pixelBlock.calculateStatistics()}!k&&this.functionArguments.dra&&this._useGPUStats?
(p=new Float32Array(a),h=new Float32Array(a)):(this._updateStatistisHistograms(b),l=this._getCutOffPoints(b),p=new Float32Array(a),h=new Float32Array(a),p.set(l.minCutOff.slice(0,a)),h.set(l.maxCutOff.slice(0,a)));this._initializeProgram({fragment:x.stretch,fragmentName:"Stretch"});l=this._setupTextureData(b);r=this.bindFrameBuffer();this.renderTexture=!1;this._performance.start();if(!k&&this.functionArguments.dra&&this._useGPUStats){this._setUniforms({u_sourceDim:[g,n],u_bandCount:a});if(1===a)var q=
this._readMinMax(l,2);else{q=this._readMinMax(l,0);var t=this._readMinMax(l,1)}if(6===this.functionArguments.stretchType||3===this.functionArguments.stretchType&&this.functionArguments.dra)c=this._readHistogram(q,t,b),p=c.minCutOff||p,h=c.minCutOff||h}e=this.functionArguments.max-this.functionArguments.min;b=new Float32Array(a);for(c=0;c<a;c++)b[c]=e/(h[c]-p[c]);this._useGPUStats&&this._initializeProgram({fragment:x.stretch,fragmentName:"Stretch"});f.blendFunc(f.SRC_ALPHA,f.ZERO);e=new Float32Array(3);
var m=new Float32Array(3);for(c=0;3>c;c++)e[c]=this.functionArguments.min,m[c]=this.functionArguments.max;c=this.functionArguments.useGamma;var u=this.functionArguments.gamma,v=this._gammaCorrection;Array.isArray(u)&&u.length>=a||(c=!1);this._setUniforms({u_sourceDim:[g,n],u_bandCount:a,u_minOutput:e,u_maxOutput:m,u_minCutOff:p,u_maxCutOff:h,u_factor:b,u_state:100,u_useGamma:c,u_gamma:u,u_scaled:!d,u_gammaCorrection:v,u_minMaxTexture:!k&&this.functionArguments.dra&&this._useGPUStats?!0:!1});this.renderTexture=
d;f.viewport(0,0,g,n);this._bindTexture(l.texture,"u_image");!k&&this.functionArguments.dra&&this._useGPUStats&&(d=f.getUniformLocation(this.rasterProgram,"u_image1"),f.uniform1i(d,1),f.activeTexture(f.TEXTURE1),f.bindTexture(f.TEXTURE_2D,q.texture),1<a&&(a=f.getUniformLocation(this.rasterProgram,"u_image2"),f.uniform1i(a,2),f.activeTexture(f.TEXTURE2),f.bindTexture(f.TEXTURE_2D,t.texture)));this._drawGL();return{extent:l.extent,texture:r.texture}},_readMinMax:function(b,d){var c=this.gl,a=b.width||
c.drawingBufferWidth,k=b.height||c.drawingBufferHeight;this._setUniforms({u_state:d});this.renderTexture=!1;var f=b.texture;for(c.activeTexture(c.TEXTURE0);1<a||1<k;){var g=this._createTexture();d=Math.max(Math.ceil(a/2),1);var n=Math.max(Math.ceil(k/2),1);c.getExtension("OES_texture_float");c.texImage2D(c.TEXTURE_2D,0,c.RGBA,d,n,0,c.RGBA,c.FLOAT,null);b=c.createFramebuffer();c.bindFramebuffer(c.FRAMEBUFFER,b);c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,g,0);c.viewport(0,
0,d,n);c.bindTexture(c.TEXTURE_2D,f);this._setUniforms({u_sourceDim:[a,k]});a=d;k=n;this._drawGL(!0);f=g}b=new Float32Array(a*k*4);c.checkFramebufferStatus(c.FRAMEBUFFER)==c.FRAMEBUFFER_COMPLETE&&c.readPixels(0,0,a,k,c.RGBA,c.FLOAT,b);return{texture:g,minmax:b}},_readHistogram:function(b,d,c){if(b)try{var a=this.gl,k=a.drawingBufferWidth,f=a.drawingBufferHeight,g,n,l;if(b.texture instanceof WebGLTexture){var r=!0;var p=[1,0,0,1];if(d){var h=b.minmax;var e=d.minmax}else h=[b.minmax[0]],e=[b.minmax[1]]}else for(e=
d,h=b,p=new Float32Array(e.length),g=0;g<e.length;g++)p[g]=256/(e[g]-h[g]);var q=new Float32Array(k*f);for(l=0;l<q.length;l++)q[l]=l;if(!this.histogramProgram){var t=F.getShader(a,F.histogram),m=x.getShader(a,x.constant);this.histogramProgram=this._loadProgram(t,m)}a.blendFunc(a.ONE,a.ONE);a.enable(a.BLEND);a.useProgram(this.histogramProgram);var u=a.getAttribLocation(this.histogramProgram,"a_pixelIndex"),v=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,v);a.bufferData(a.ARRAY_BUFFER,q,a.STATIC_DRAW);
a.enableVertexAttribArray(u);a.vertexAttribPointer(u,1,a.FLOAT,!1,0,0);var z=this._setupHistTexture(c),A=this._createTexture();a.getExtension("OES_texture_float");a.texImage2D(a.TEXTURE_2D,0,a.RGBA,257,1,0,a.RGBA,a.FLOAT,null);var O=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,O);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,A,0);a.viewport(0,0,257,1);var P=a.getUniformLocation(this.histogramProgram,"u_image");a.uniform1i(P,0);a.activeTexture(a.TEXTURE0);a.bindTexture(a.TEXTURE_2D,
z);var Q=a.getUniformLocation(this.histogramProgram,"u_sourceDim");a.uniform2f(Q,k,f);var R=a.getUniformLocation(this.histogramProgram,"u_bandCount");a.uniform1i(R,3);var S=a.getUniformLocation(this.histogramProgram,"u_halfPixel");a.uniform2f(S,.5/k,.5/f);var G=a.getUniformLocation(this.histogramProgram,"u_minMaxTexture");if(r){a.uniform1i(G,1);var T=a.getUniformLocation(this.histogramProgram,"u_image1");a.uniform1i(T,1);a.activeTexture(a.TEXTURE1);a.bindTexture(a.TEXTURE_2D,b.texture);if(d){var U=
a.getUniformLocation(this.histogramProgram,"u_image2");a.uniform1i(U,2);a.activeTexture(a.TEXTURE2);a.bindTexture(a.TEXTURE_2D,d.texture)}}else{var V=a.getUniformLocation(this.histogramProgram,"u_mins");a.uniform4f(V,h[0],h[0],h[0],h[0]);a.uniform1i(G,0)}var B=a.getUniformLocation(this.histogramProgram,"u_color"),C=a.getUniformLocation(this.histogramProgram,"u_factors"),W=a.getUniformLocation(this.histogramProgram,"u_size");a.uniform1f(W,256);b=[];d=[];a.uniform4fv(B,[1,0,0,1]);a.uniform4fv(C,[p[0],
0,0,1]);a.drawArrays(a.POINTS,0,q.length);var H=this.sourceRasterInfo.raster.bandCount;1<H&&(a.uniform4fv(B,[0,1,0,1]),a.uniform4fv(C,[0,p[0],0,1]),a.drawArrays(a.POINTS,0,q.length),a.uniform4fv(B,[0,0,1,1]),a.uniform4fv(C,[0,0,p[0],1]),a.drawArrays(a.POINTS,0,q.length));if(a.checkFramebufferStatus(a.FRAMEBUFFER)==a.FRAMEBUFFER_COMPLETE){var w=new Float32Array(1028);a.readPixels(0,0,257,1,a.RGBA,a.FLOAT,w);a=0;var I=-.5===h[0]&&1===(e[0]-h[0])/256?.5:0;for(g=0;g<H;g++){var y=new Float32Array(257);
var J=new Float32Array(257);for(l=a=0;256>l;l++)a+=w[4*l+g],y[l]=a,J[l]=w[4*l+g];J[256]=w[1024+g];y[256]=a+w[1024+g];var D=this.functionArguments.minPercent*a/100;if(e){for(n=0;256>n;n++)if(y[n]>D){b[g]=h[0]+(e[0]-h[0])/256*(n+I);break}D=(1-this.functionArguments.maxPercent/100)*a;for(n=254;0<=n;n--)if(y[n]<D){d[g]=h[0]+(e[0]-h[0])/256*(n+2-I);break}}}}return{histogram:w,minCutOff:b,maxCutOff:d}}catch(X){console.debug("webgl filter exception: "+X.message)}},_setupHistTexture:function(b){if(b instanceof
WebGLTexture)return b;var d=this.originalHistTexture=this._createTexture(),c=this.gl;b=b.pixelBlock;var a=b.width,k=b.height;c.getExtension("OES_texture_float");this.rgbaFloatData=b.getAsRGBAFloat();c.texImage2D(c.TEXTURE_2D,0,c.RGBA,a,k,0,c.RGBA,c.FLOAT,this.rgbaFloatData);return d}})});