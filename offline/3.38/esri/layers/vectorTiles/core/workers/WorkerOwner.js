// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/core/workers/WorkerOwner","require exports dojo/Deferred ../../kernel ../Error ../Logger ../promiseUtils ./utils ./workerFactory".split(" "),function(A,B,p,q,r,t,u,e,v){var w=t.getLogger("esri.core.workers"),m=e.MessageType.CANCEL,x=e.MessageType.INVOKE,y=e.MessageType.OPEN,z=e.MessageType.OPENED,h=e.MessageType.RESPONSE;return function(){function f(a,c){this._outJobs=new Map;this._inJobs=new Map;this.worker=a;this.id=c;a.addEventListener("message",this._onMessage.bind(this));
a.addEventListener("error",function(b){b.preventDefault();w.error(b)})}f.create=function(a){return v.createWorker().then(function(c){return new f(c,a)})};f.prototype.terminate=function(){this.worker.terminate()};f.prototype.open=function(a){var c=this,b=e.newJobId(),d=new p(function(k){c._outJobs["delete"](b);c._post({type:m,jobId:b})});this._outJobs.set(b,d);this._post({type:y,jobId:b,modulePath:a});return d.promise};f.prototype._onMessage=function(a){if(a=e.receiveMessage(a))switch(a.type){case z:case h:this._onResponse(a);
break;case m:this._onCancel(a);break;case x:this._onInvoke(a)}};f.prototype._onCancel=function(a){(a=this._inJobs.get(a.jobId))&&a.cancel()};f.prototype._onInvoke=function(a){var c=this,b=a.methodName,d=a.jobId;a=a.data;var k=this._inJobs,n=q.workerMessages[b];try{if("function"!==typeof n)throw new TypeError(b+" is not a function");var l=n.call(null,a)}catch(g){this._post({type:h,jobId:d,error:e.toInvokeError(g)});return}u.isThenable(l)?(k.set(d,l),l.then(function(g){k["delete"](d);c._post({type:h,
jobId:d},g)}).catch(function(g){k["delete"](d);g||(g={message:"Error encountered at method"+b});g.dojoType&&"cancel"===g.dojoType||c._post({type:h,jobId:d,error:e.toInvokeError(g)})})):this._post({type:h,jobId:d},l)};f.prototype._onResponse=function(a){var c=a.jobId,b=a.error;a=a.data;var d=this._outJobs.get(c);d&&(this._outJobs["delete"](c),b?d.reject(r.fromJSON(JSON.parse(b))):d.resolve(a))};f.prototype._post=function(a,c,b){return e.postMessage(this.worker,a,c,b)};return f}()});