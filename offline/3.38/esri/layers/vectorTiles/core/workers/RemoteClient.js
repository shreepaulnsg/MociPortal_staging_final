// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/core/workers/RemoteClient","require exports dojo/Deferred ../Error ../promiseUtils ./utils".split(" "),function(B,C,u,v,w,g){function l(d,a){d["delete"](a)}var x=g.MessageType.CLOSE,r=g.MessageType.CANCEL,y=g.MessageType.INVOKE,m=g.MessageType.RESPONSE,z=g.MessageType.OPEN_PORT,A=function(){function d(a){this._timer=null;this._cancelledJobIds=new Set;this._invokeMessages=[];this._invoke=a;this._timer=null;this._process=this._process.bind(this)}d.prototype.push=function(a){a.type===
g.MessageType.CANCEL?this._cancelledJobIds.add(a.jobId):(this._invokeMessages.push(a),null===this._timer&&(this._timer=setTimeout(this._process,0)))};d.prototype.clear=function(){this._invokeMessages.length=0;this._cancelledJobIds.clear();this._timer=null};d.prototype._process=function(){this._timer=null;for(var a=0,b=this._invokeMessages;a<b.length;a++){var c=b[a];this._cancelledJobIds.has(c.jobId)||this._invoke(c)}this._cancelledJobIds.clear();this._invokeMessages.length=0};return d}();return function(){function d(a,
b,c){this._outJobs=new Map;this._inJobs=new Map;this._queue=new A(this._onInvoke.bind(this));this._onMessage=this._onMessage.bind(this);this._client=b;this._port=a;this._port.addEventListener("message",this._onMessage);this._port.start();this._channel=c}d.connect=function(a){var b=new MessageChannel;a="function"===typeof a?new a:"default"in a&&"function"===typeof a.default?new a.default:a;a.remoteClient=new d(b.port1,a,b);return b.port2};d.prototype.close=function(){this._post({type:x});this._close()};
d.prototype.isBusy=function(){return 0<this._outJobs.size};d.prototype.invoke=function(a,b,c){var e=this;if(!this._port)return w.reject(new v("remote-client:port-closed","Can't invoke(), port is closed"));var f=g.newJobId(),h=new u(function(){l(e._outJobs,f);e._post({type:r,jobId:f})});this._outJobs.set(f,h);this._post({type:y,jobId:f,methodName:a},b,c);return h.promise};d.prototype.openPort=function(){var a=this,b=g.newJobId(),c=new u(function(){l(a._outJobs,b);a._post({type:r,jobId:b})});this._outJobs.set(b,
c);this._post({type:z,jobId:b});return c.promise};d.prototype._close=function(){this._channel&&(this._channel=null);this._port.removeEventListener("message",this._onMessage);this._port.close();this._outJobs.forEach(function(a){a.cancel()});this._inJobs.clear();this._outJobs.clear();this._queue.clear();this._port=this._client=null};d.prototype._onMessage=function(a){if(a=g.receiveMessage(a))switch(a.type){case m:this._onResponse(a);break;case y:this._queue.push(a);break;case r:this._onCancel(a);break;
case x:this._close();break;case z:this._onOpenPort(a)}};d.prototype._onCancel=function(a){var b=this._inJobs,c=a.jobId,e=b.get(c);this._queue.push(a);e&&(l(b,c),e.cancel())};d.prototype._onInvoke=function(a){var b=this,c=a.methodName,e=a.jobId;a=a.data;var f=this._inJobs,h=this._client,n=h[c];try{if(!n&&c&&-1!==c.indexOf("."))for(var t=c.split("."),p=0;p<t.length-1;p++)h=h[t[p]],n=h[t[p+1]];if("function"!==typeof n)throw new TypeError(c+" is not a function");var q=n.call(h,a,this)}catch(k){this._post({type:m,
jobId:e,error:g.toInvokeError(k)});return}w.isThenable(q)?(f.set(e,q),q.then(function(k){f.has(e)&&(l(f,e),b._post({type:m,jobId:e},k))}).catch(function(k){f.has(e)&&(l(f,e),k&&"cancel"===k.dojoType||b._post({type:m,jobId:e,error:g.toInvokeError(k||{message:"Error encountered at method "+c})}))})):this._post({type:m,jobId:e},q)};d.prototype._onOpenPort=function(a){var b=new MessageChannel;new d(b.port1,this._client);this._post({type:m,jobId:a.jobId},b.port2,[b.port2])};d.prototype._onResponse=function(a){var b=
a.jobId,c=a.error;a=a.data;var e=this._outJobs;if(e.has(b)){var f=e.get(b);l(e,b);c?f.reject(v.fromJSON(JSON.parse(c))):f.resolve(a)}};d.prototype._post=function(a,b,c){return g.postMessage(this._port,a,b,c)};return d}()});