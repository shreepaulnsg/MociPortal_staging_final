// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/renderers/Renderer","../core/declare ../core/Accessor ../core/JSONSupport ../core/kebabDictionary ../core/screenUtils ../core/lang ../core/Error ../support/arcadeUtils ../webdoc/support/opacityUtils ../Color ./support/utils ./support/AuthoringInfo".split(" "),function(P,Q,R,w,H,n,I,q,J,r,S,T){var z=w({sizeInfo:"size",colorInfo:"color",transparencyInfo:"opacity",rotationInfo:"rotation"}),K=w({widthAndDepth:"width-and-depth"}),U=w({unknown:"unknown",inch:"inches",foot:"feet",
yard:"yards",mile:"miles","nautical-mile":"nautical-miles",millimeter:"millimeters",centimeter:"centimeters",decimeter:"decimeters",meter:"meters",kilometer:"kilometers","decimal-degree":"decimal-degrees"});w({classedSize:"classed-size",classedColor:"classed-color",univariateColorSize:"univariate-color-size"});w({esriClassifyEqualInterval:"equal-interval",esriClassifyManual:"manual",esriClassifyNaturalBreaks:"natural-breaks",esriClassifyQuantile:"quantile",esriClassifyStandardDeviation:"standard-deviation"});
w({percentTotal:"percent-of-total"});var B=Math.PI,L=J.opacityToTransparency,M=J.transparencyToOpacity;return P([Q,R],{declaredClass:"esri.renderers.Renderer",properties:{authoringInfo:{type:T,value:null,json:{write:!0}},requiredFields:{dependsOn:["visualVariables"],get:function(){var a=Object.create(null);this.collectRequiredFields(a);return Object.keys(a).sort()}},type:{type:String,readOnly:!0,json:{read:!1,write:{ignoreOrigin:!0}}},visualVariables:{json:{read:{source:["visualVariables","rotationType",
"rotationExpression"],reader:function(a,b){return this._readVariables(a,b)}},write:function(a,b,c,d){var e=[];a.forEach(function(f,l){"size"===f.type?e.push(this._writeSizeInfo(f,d,l)):"color"===f.type?e.push(this._writeColorInfo(f,d,l)):"opacity"===f.type?e.push(this._writeOpacityInfo(f,d,l)):"rotation"===f.type&&e.push(this._writeRotationInfo(f,d,l))},this);b.visualVariables=e}}}},constructor:function(){this._cache={}},_rotationRE:/^\[([^\]]+)\]$/i,_viewScaleRE:/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,
_visualVariablesSetter:function(a){var b=this._cache;this.visualVariables&&this.visualVariables.forEach(function(c,d){b.hasOwnProperty(d)&&(b[d]=null)},this);a&&a.some(function(c){return!!c.target})&&a.sort(function(c,d){return c.target===d.target?0:c.target?1:-1});a&&a.forEach(function(c,d){"color"===c.type?b[d]=this._processColorInfo(c):"opacity"===c.type?b[d]=this._processOpacityInfo(c):"size"===c.type?b[d]=this._processSizeInfo(c):"rotation"===c.type&&(b[d]=this._processRotationInfo(c))},this);
this._set("visualVariables",a)},getSymbol:function(a,b){},getVisualVariableValues:function(a,b){var c=this.visualVariables,d;c&&(d=c.map(function(e){var f=e.type,l=f+"Info";b=n.mixin({},b);b[l]=e;switch(f){case "size":var g=this.getSize(a,b);break;case "color":g=this.getColor(a,b);break;case "opacity":g=this.getOpacity(a,b);break;case "rotation":g=this.getRotationAngle(a,b)}return{variable:e,value:g}},this).filter(function(e){return null!=e.value},this));return d},hasVisualVariables:function(a,b){return a?
!!this.getVisualVariablesForType(a,b):!!(this.getVisualVariablesForType("size",b)||this.getVisualVariablesForType("color",b)||this.getVisualVariablesForType("opacity",b)||this.getVisualVariablesForType("rotation",b))},getVisualVariablesForType:function(a,b){var c=this.visualVariables,d;c&&(d=c.filter(function(e){return e.type===a&&("string"===typeof b?e.target===b:!1===b?!e.target:!0)}))&&0===d.length&&(d=void 0);return d},getSize:function(a,b){var c=this._getVarInfo(b&&b.sizeInfo,"size"),d=c.variable;
c=this._cache[c.cacheKey];var e=null;if(d){var f=d.minSize;e=d.maxSize;f="object"===typeof f&&f?this._getSize(a,f,c&&c.minSize,b):f;e="object"===typeof e&&e?this._getSize(a,e,c&&c.maxSize,b):e;e=this._getSize(a,d,c&&c.root,b,[f,e])}return e},getSizeRangeAtScale:function(a,b){a=this._getVarInfo(a,"size");var c=this._cache[a.cacheKey],d={scale:b};if((a=a.variable)&&b){b=a.minSize;var e=a.maxSize;a="object"===typeof b&&b?this._getSize({},b,c&&c.minSize,d):b;c="object"===typeof e&&e?this._getSize({},
e,c&&c.maxSize,d):e;if(null!=a||null!=c){if(a>c){var f=c;c=a;a=f}f={minSize:a,maxSize:c}}}return f},getColor:function(a,b){var c=this._getVarInfo(b&&b.colorInfo,"color");return this._getColorComponent(a,c.variable,this._cache[c.cacheKey],b)},getOpacity:function(a,b){var c=this._getVarInfo(b&&b.opacityInfo,"opacity");return this._getColorComponent(a,c.variable,this._cache[c.cacheKey],b,!0)},getRotationAngle:function(a,b){var c=this._getVarInfo(b&&b.rotationInfo,"rotation"),d=c.variable,e=this._cache[c.cacheKey],
f=d.axis||"heading";c="heading"===f&&"arithmetic"===d.rotationType?90:0;f="heading"===f&&"arithmetic"===d.rotationType?-1:1;d=d.field;e=e&&e.compiledFunc;var l=a.attributes,g=0;if(d||e)e?g=q.executeFunction(e,q.createExecContext(a,q.getViewInfo(b))):"function"===typeof d?g=d.apply(this,arguments):l&&(g=l[d]||0),g="number"!==typeof g||isNaN(g)?null:c+f*g;return g},collectRequiredFields:function(a){var b=[];this.visualVariables&&(b=b.concat(this.visualVariables));b.forEach(function(c){c&&(c.field&&
(a[c.field]=!0),c.normalizationField&&(a[c.normalizationField]=!0),c.valueExpression&&q.extractFieldNames(c.valueExpression).forEach(function(d){a[d]=!0}))})},_getVarInfo:function(a,b){if(a&&a.type===b&&this.visualVariables){var c=this.visualVariables.indexOf(a);a=this.visualVariables[c]}else this.visualVariables&&(a=(a=this.getVisualVariablesForType(b))&&a[0],c=this.visualVariables.indexOf(a));return{variable:a,cacheKey:c}},_readSizeInfo:function(a){a.axis&&(a.axis=K.fromJSON(a.axis));a.valueUnit&&
(a.valueUnit=U.fromJSON(a.valueUnit));return a},_readColorInfo:function(a){a&&(a.colors&&a.colors.forEach(function(b,c){Array.isArray(b)?a.colors[c]=r.fromJSON(b):a.colors[c]=new r(b)}),a.stops&&a.stops.forEach(function(b,c){b.color&&Array.isArray(b.color)?a.stops[c].color=r.fromJSON(b.color):b.color&&(a.stops[c].color=new r(b.color))}));return a},_readOpacityInfo:function(a){if(a){var b=n.mixin({},a);b.transparencyValues&&(b.opacityValues=b.transparencyValues.map(M),delete b.transparencyValues);
b.stops&&(b.stops=b.stops.map(function(c){c=n.mixin({},c);c.opacity=M(c.transparency);delete c.transparency;return c}))}return b},_readVariables:function(a,b){a&&(a=a.map(function(d){d=n.clone(d);d.type=z.fromJSON(d.type);"size"===d.type?d=this._readSizeInfo(d):"color"===d.type?d=this._readColorInfo(d):"opacity"===d.type&&(d=this._readOpacityInfo(d));return d},this));var c=b.rotationType;if(b=b.rotationExpression)c={type:"rotation",rotationType:c},(b=b.match(this._rotationRE))&&b[1]&&(c.field=b[1],
a||(a=[]),a.push(c));return a},_createCache:function(a){var b=a&&a.valueExpression,c=q.createSyntaxTree(b);c=q.createFunction(c);var d=!(!a||!a.expression)||this._viewScaleRE.test(b);return{ipData:this._interpolateData(a),hasExpr:!!b,compiledFunc:c,isScaleDriven:d}},_processColorInfo:function(a){a&&(a.colors&&a.colors.forEach(function(b,c){b instanceof r||(a.colors[c]=new r(b))}),a.stops&&a.stops.forEach(function(b,c){!b.color||b.color instanceof r||(a.stops[c].color=new r(b.color))}),this._sortStops(a.stops));
return this._createCache(a)},_processOpacityInfo:function(a){this._sortStops(a&&a.stops);return this._createCache(a)},_processSizeInfo:function(a){a.stops&&Array.isArray(a.stops)?a.stops=this._processSizeInfoStops(a.stops):(a.minSize=a.minSize&&this._processSizeInfoSize(a.minSize),a.maxSize=a.maxSize&&this._processSizeInfoSize(a.maxSize));return{root:this._createCache(a),minSize:this._createCache(a.minSize),maxSize:this._createCache(a.maxSize)}},_processSizeInfoSize:function(a){"object"===typeof a?
a.stops=this._processSizeInfoStops(a.stops):a=H.toPt(a);return a},_processSizeInfoStops:function(a){a&&Array.isArray(a)&&(a.forEach(function(b){b.size=H.toPt(b.size)}),this._sortStops(a));return a},_sortStops:function(a){a&&Array.isArray(a)&&a.sort(function(b,c){return b.value-c.value})},_processRotationInfo:function(a){return this._createCache(a)},_getSize:function(a,b,c,d,e){var f=a.attributes,l=b.field,g=b.stops,h=0,t=c&&c.hasExpr,C=c&&c.compiledFunc,E=c&&c.ipData,A=c&&c.isScaleDriven,x="number"===
typeof a,k=x?a:null;if(l||A||t){var u=d&&d.scale,m=e?e[0]:b.minSize,p=e?e[1]:b.maxSize,v=b.minDataValue,F=b.maxDataValue,N=b.valueUnit||"unknown",G=b.valueRepresentation;h=b.scaleBy;var O=b.normalizationField,D=f?parseFloat(f[O]):void 0,y=d&&d.shape;A?k=null==u?this._getAverageValue(b):u:"number"!==typeof k&&(t?k=q.executeFunction(C,q.createExecContext(a,q.getViewInfo(d))):"function"===typeof l?k=l.apply(this,arguments):f&&(k=f[l]));if(null==k||O&&!x&&(isNaN(D)||0===D))return null;isNaN(D)||x||(k/=
D);if(g)p=this._lookupData(k,E),k=p[0],m=p[1],k===m?h=g[k].size:(k=g[k].size,g=g[m].size,h=k+(g-k)*p[2]);else if(null!=m&&null!=p&&null!=v&&null!=F)k<=v?h=m:k>=F?h=p:(g=(k-v)/(F-v),"area"===h&&y?(m=(k="circle"===y)?B*Math.pow(m/2,2):m*m,g=m+g*((k?B*Math.pow(p/2,2):p*p)-m),h=k?2*Math.sqrt(g/B):Math.sqrt(g)):h=m+g*(p-m));else if("unknown"===N)null!=m&&null!=v?(m&&v?(g=k/v,h="circle"===y?2*Math.sqrt(g*Math.pow(m/2,2)):"square"===y||"diamond"===y||"image"===y?Math.sqrt(g*Math.pow(m,2)):g*m):h=k+(m||v),
h=h<m?m:h,null!=p&&h>p&&(h=p)):h=k;else{g=(d&&d.resolution?d.resolution:1)*S.meterIn[N];if("area"===G)h=Math.sqrt(k/B)/g,h*=2;else if(h=k/g,"radius"===G||"distance"===G)h*=2;null!=m&&h<m&&(h=m);null!=p&&h>p&&(h=p)}}else b&&(h=g&&g[0]&&g[0].size,null==h&&(h=b.minSize));return h=isNaN(h)?0:h},_getAverageValue:function(a){var b=a.stops;if(b){var c=b[0].value;a=b[b.length-1].value}else c=a.minDataValue||0,a=a.maxDataValue||0;return(c+a)/2},_getColorComponent:function(a,b,c,d,e,f){var l=a.attributes,g=
b&&b.field,h="number"===typeof a,t=h?a:null,C=c&&c.hasExpr,E=c&&c.compiledFunc,A=c&&c.ipData;if(g||C){var x=b.normalizationField,k=l?parseFloat(l[x]):void 0;"number"!==typeof t&&(C?t=q.executeFunction(E,q.createExecContext(a,q.getViewInfo(d))):"function"===typeof g?t=g.apply(this,arguments):l&&(t=l[g]));if(null!=t&&(!x||h||!isNaN(k)&&0!==k)){isNaN(k)||h||(t/=k);var u=e?this._getOpacity(t,b,A):this._getColor(t,b,A)}}else b&&(l=b.stops,e?(u=l&&l[0]&&l[0].opacity,null==u&&(u=b.opacityValues&&b.opacityValues[0])):
u=l&&l[0]&&l[0].color||b.colors&&b.colors[0]);f&&(f.data=t,f.value=u);return f||u},_interpolateData:function(a){if(a)if(a.colors||a.opacityValues){var b=(a.colors||a.opacityValues).length,c=a.minDataValue,d=(a.maxDataValue-c)/(b-1);var e=[];for(a=0;a<b;a++)e[a]=c+a*d}else a.stops&&(e=a.stops.map(function(f){return f.value||0}));return e},_getOpacity:function(a,b,c){a=this._lookupData(a,c);b=b||this.opacityInfo;if(a){c=a[0];var d=a[1];c===d?d=this._getOpacValue(b,c):(c=this._getOpacValue(b,c),b=this._getOpacValue(b,
d),d=c+(b-c)*a[2])}return d},_getOpacValue:function(a,b){return a.opacityValues?a.opacityValues[b]:a.stops[b].opacity},_getColor:function(a,b,c){a=this._lookupData(a,c);b=b||this.colorInfo;if(a){var d=a[0];c=a[1];d=d===c?this._getColorObj(b,d):r.blendColors(this._getColorObj(b,d),this._getColorObj(b,c),a[2]);d=new r(d)}return d},_getColorObj:function(a,b){return a.colors?a.colors[b]:a.stops[b].color},_lookupData:function(a,b){if(b){var c=0,d=b.length-1;b.some(function(f,l){if(a<f)return d=l,!0;c=
l;return!1});var e=[c,d,(a-b[c])/(b[d]-b[c])]}return e},_processForContext:function(a,b,c){if(b&&"web-scene"===b.origin){var d=null!=a.expression,e=null!=a.valueExpressionTitle&&"rotation"===a.type;b.messages&&(d&&b.messages.push(new I("property:unsupported",a.type+"VisualVariable.expression is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:c+".expression",context:b})),e&&b.messages.push(new I("property:unsupported",a.type+"VisualVariable.valueExpressionTitle is not supported in Web Scene. Please remove this property to save the Web Scene.",
{instance:this,propertyName:c+".valueExpressionTitle",context:b})));d&&delete a.expression;e&&delete a.valueExpressionTitle}else"size"===a.type&&this._convertExpressionToArcade(a)},_writeRotationInfo:function(a,b,c){a&&(a=n.mixin({},a),this._processForContext(a,b,"visualVariables["+c+"]"),a.type=z.toJSON(a.type),a=n.fixJson(a,!0));return a},_convertExpressionToArcade:function(a){a&&a.expression&&(a.valueExpression="$view.scale")},_writeSizeInfo:function(a,b,c){if(a){a=n.mixin({},a);this._processForContext(a,
b,"string"===typeof c?c:"visualVariables["+c+"]");var d=a.minSize,e=a.maxSize;d&&(a.minSize="number"===typeof d?d:this._writeSizeInfo(d,b,"visualVariables["+c+"].minSize"));e&&(a.maxSize="number"===typeof e?e:this._writeSizeInfo(e,b,"visualVariables["+c+"].maxSize"));b=a.legendOptions;c=a.axis;a.type=z.toJSON(a.type);c&&(a.axis=K.toJSON(c));b&&(a.legendOptions=n.mixin({},b),b=b.customValues)&&(a.legendOptions.customValues=b.slice(0));a.stops&&(a.stops=a.stops.map(function(f){f=n.mixin({},f);null===
f.label&&delete f.label;return f}));a=n.fixJson(a,!0)}return a},_writeColorInfo:function(a,b,c){a&&(a=n.mixin({},a),this._processForContext(a,b,"visualVariables["+c+"]"),a.type=z.toJSON(a.type),a.colors&&(a.colors=a.colors.map(function(d){return r.toJSON(d)})),a.stops&&(a.stops=a.stops.map(function(d){d=n.mixin({},d);d.color&&(d.color=r.toJSON(d.color));null==d.value&&(d.value=0);null===d.label&&delete d.label;return d})),a.legendOptions&&(a.legendOptions=n.mixin({},a.legendOptions)),a=n.fixJson(a,
!0));return a},_writeOpacityInfo:function(a,b,c){if(a){var d=n.mixin({},a);this._processForContext(d,b,"visualVariables["+c+"]");d.type=z.toJSON(d.type);d.opacityValues&&(d.transparencyValues=d.opacityValues.map(L),delete d.opacityValues);d.stops&&(d.stops=d.stops.map(function(e){e=n.mixin({},e);e.transparency=L(e.opacity);delete e.opacity;null===e.label&&delete e.label;return e}));d.legendOptions&&(d.legendOptions=n.mixin({},d.legendOptions));d=n.fixJson(d,!0)}return d}})});