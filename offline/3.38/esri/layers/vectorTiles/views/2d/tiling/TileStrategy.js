// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/2d/tiling/TileStrategy",["require","exports","../../../core/tsSupport/extendsHelper","./enums","./TileKey"],function(E,F,G,r,B){var k=new B(0,0,0,0),f=new Map,h=[],m=[];return function(){function n(a){this._previousResolution=Number.POSITIVE_INFINITY;this.cachePolicy="keep";this.coveragePolicy="closest";this.tileIndex=new Map;this.tiles=[];this.buffer=192;this.acquireTile=a.acquireTile;this.releaseTile=a.releaseTile;this.tileInfoView=a.tileInfoView;a.cachePolicy&&
(this.cachePolicy=a.cachePolicy);a.coveragePolicy&&(this.coveragePolicy=a.coveragePolicy);null!=a.buffer&&(this.buffer=a.buffer)}n.prototype.destroy=function(){this.clear()};n.prototype.update=function(a){var g=this,b=this.tileIndex,p=this.tileInfoView.getTileCoverage(a.state,this.buffer,this.coveragePolicy);if(p){var d=p.spans,t=p.lodInfo,u=t.level,c=a.state.resolution,v=!a.stationary&&c>this._previousResolution;this._previousResolution=c;b.forEach(function(e){return e.visible=!0});this.tiles.length=
0;f.clear();var x=0,y=0;if(0<d.length)for(var w=0;w<d.length;w++){a=d[w];for(var C=a.row,D=a.colTo,q=a.colFrom;q<=D;q++)x++,a=k.set(u,C,t.normalizeCol(q),t.getWorldForColumn(q)).id,b.has(a)?(c=b.get(a),c.status!==r.TileStatus.INITIALIZED&&y++,c.attached?f.set(a,c):c.attached||v||this._addParentTile(a,f)):(c=this.acquireTile(k),this.tileIndex.set(a,c),v||this._addParentTile(a,f))}var z=y===x;m.length=0;h.length=0;b.forEach(function(e,l){k.set(l);if(!f.has(l)){var A=g.tileInfoView.intersects(p,k);!A||
!v&&z?"purge"===g.cachePolicy&&e.status!==r.TileStatus.MODIFIED&&e.status!==r.TileStatus.READY?h.push(l):(k.level>u||!A)&&h.push(l):e.attached?m.push(l):k.level>u&&h.push(l)}});for(d=0;d<m.length;d++)a=m[d],(c=b.get(a))&&c.attached&&f.set(a,c);for(d=0;d<h.length;d++)a=h[d],c=b.get(a),this.releaseTile(c),b["delete"](a);f.forEach(function(e){return g.tiles.push(e)});b.forEach(function(e){f.has(e.key.id)||(e.visible=!1)});m.length=0;h.length=0;f.clear();return z}};n.prototype.clear=function(){var a=
this,g=this.tileIndex;g.forEach(function(b){a.releaseTile(b)});g.clear()};n.prototype._addParentTile=function(a,g){for(var b=null;;){a=this.tileInfoView.getTileParentId(a);if(!a)break;if(this.tileIndex.has(a)&&(b=this.tileIndex.get(a))&&b.attached){g.has(b.key.id)||g.set(b.key.id,b);break}}};return n}()});