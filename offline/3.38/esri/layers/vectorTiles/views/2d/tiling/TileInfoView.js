// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/2d/tiling/TileInfoView","require exports ../../../geometry/support/spatialReferenceUtils ./LODInfo ./TileCoverage ./TileKey ./TileSpan".split(" "),function(C,D,y,z,A,r,w){var u=new r("0/0/0/0"),B=function(){function g(b,a,c,e,l,d,f,t){this.x=b;this.ymin=a;this.ymax=c;this.invM=e;this.leftAdjust=l;this.rightAdjust=d;this.leftBound=f;this.rightBound=t}g.create=function(b,a){if(b[1]>a[1]){var c=[a,b];b=c[0];a=c[1]}c=b[0];b=b[1];var e=a[0];a=a[1];var l=e-c,d=a-b;
d=0!==d?l/d:0;var f=(Math.ceil(b)-b)*d,t=(Math.floor(b)-b)*d;return new g(c,Math.floor(b),Math.ceil(a),d,0>l?f:t,0>l?t:f,0>l?e:c,0>l?c:e)};g.prototype.incrRow=function(){this.x+=this.invM};g.prototype.getLeftCol=function(){return Math.max(this.x+this.leftAdjust,this.leftBound)};g.prototype.getRightCol=function(){return Math.min(this.x+this.rightAdjust,this.rightBound)};return g}(),n=[[0,0],[0,0],[0,0],[0,0]];return function(){function g(b,a){var c=this;this.tileInfo=b;this.fullExtent=a;this.scales=
[];this._lodInfos=null;this._infoByScale={};this._infoByLevel={};var e=b.lods.slice();e.sort(function(d,f){return f.scale-d.scale});var l=this._lodInfos=e.map(function(d){return z.create(b,d,a)});e.forEach(function(d,f){c._infoByLevel[d.level]=l[f];c._infoByScale[d.scale]=l[f];c.scales[f]=d.scale},this);this._wrap=b.isWrappable}g.prototype.getLODInfoAt=function(b){return this._infoByLevel[b.level]};g.prototype.getTileBounds=function(b,a,c){void 0===c&&(c=!1);u.set(a);return(a=this._infoByLevel[u.level])?
a.getTileBounds(b,u,c):b};g.prototype.getTileCoords=function(b,a,c){void 0===c&&(c=!1);u.set(a);return(a=this._infoByLevel[u.level])?a.getTileCoords(b,u,c):b};g.prototype.getTileCoverage=function(b,a,c){void 0===a&&(a=192);void 0===c&&(c="closest");c="closest"===c?this.getClosestInfoForScale(b.scale):this.getSmallestInfoForScale(b.scale);var e=A.pool.acquire(c),l=this._wrap;var d=Infinity;var f=-Infinity,t=e.spans;n[0][0]=n[0][1]=n[1][1]=n[3][0]=-a;n[1][0]=n[2][0]=b.size[0]+a;n[2][1]=n[3][1]=b.size[1]+
a;for(a=0;a<n.length;a++){var h=n[a];b.toMap(h,h);h[0]=c.getColumnForX(h[0]);h[1]=c.getRowForY(h[1])}b=[];h=3;for(a=0;4>a;a++){if(n[a][1]!==n[h][1]){var k=B.create(n[a],n[h]);d=Math.min(k.ymin,d);f=Math.max(k.ymax,f);void 0===b[k.ymin]&&(b[k.ymin]=[]);b[k.ymin].push(k)}h=a}if(null==d||null==f||100<f-d)return null;for(h=[];d<f;){null!=b[d]&&(h=h.concat(b[d]));var p=Infinity;var q=-Infinity;for(a=h.length-1;0<=a;a--)k=h[a],p=Math.min(p,k.getLeftCol()),q=Math.max(q,k.getRightCol());p=Math.floor(p);q=
Math.floor(q);if(d>=c.first[1]&&d<=c.last[1])if(l)if(c.size[0]<c.worldSize[0])for(k=Math.floor(q/c.worldSize[0]),a=Math.floor(p/c.worldSize[0]);a<=k;a++)t.push(new w(d,Math.max(c.getFirstColumnForWorld(a),p),Math.min(c.getLastColumnForWorld(a),q)));else t.push(new w(d,p,q));else p>c.last[0]||q<c.first[0]||(p=Math.max(p,c.first[0]),q=Math.min(q,c.last[0]),t.push(new w(d,p,q)));d+=1;for(a=h.length-1;0<=a;a--)k=h[a],k.ymax>=d?k.incrRow():h.splice(a,1)}return e};g.prototype.getTileIdAtParent=function(b,
a){a=r.pool.acquire(a);var c=this._infoByLevel[a.level];if(b.resolution<c.resolution)throw Error("Cannot calculate parent tile. destination LOD's resolution "+b.resolution+" is not a parent resolution of "+c.resolution);return b.resolution===c.resolution?a.id:r.getId(b.level,Math.floor(a.row*c.resolution/b.resolution+.01),Math.floor(a.col*c.resolution/b.resolution+.01),a.world)};g.prototype.getTileParentId=function(b){b=r.pool.acquire(b);var a=this._lodInfos.indexOf(this._infoByLevel[b.level])-1;
if(0>a)return r.pool.release(b),null;a=this.getTileIdAtParent(this._lodInfos[a],b);r.pool.release(b);return a};g.prototype.getTileResolution=function(b){return(b=this._infoByLevel[b.level])?b.resolution:-1};g.prototype.getTileScale=function(b){return(b=this._infoByLevel[b.level])?b.scale:-1};g.prototype.intersects=function(b,a){var c=r.pool.acquire(a);a=this._infoByLevel[c.level];var e=b.lodInfo;if(e.resolution>a.resolution){var l=r.pool.acquire(this.getTileIdAtParent(e,c)),d=e.denormalizeCol(l.col,
l.world);a=b.spans.some(function(m){return m.row===l.row&&m.colFrom<=d&&m.colTo>=d});r.pool.release(c);r.pool.release(l);return a}if(e.resolution<a.resolution){var f=b.spans.reduce(function(m,v){m[0]=Math.min(m[0],v.row);m[1]=Math.max(m[1],v.row);m[2]=Math.min(m[2],v.colFrom);m[3]=Math.max(m[3],v.colTo);return m},[Infinity,-Infinity,Infinity,-Infinity]);b=f[0];var t=f[1],h=f[2];f=f[3];var k=a.denormalizeCol(c.col,c.world),p=e.getColumnForX(a.getXForColumn(k)),q=e.getRowForY(a.getYForRow(c.row));k=
e.getColumnForX(a.getXForColumn(k+1))-1;a=e.getRowForY(a.getYForRow(c.row+1))-1;r.pool.release(c);return!(p>f||k<h||q>t||a<b)}var x=e.denormalizeCol(c.col,c.world);a=b.spans.some(function(m){return m.row===c.row&&m.colFrom<=x&&m.colTo>=x});r.pool.release(c);return a};g.prototype.normalizeBounds=function(b,a,c){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];this._wrap&&(a=y.getInfo(this.tileInfo.spatialReference),c=-c*(a.valid[1]-a.valid[0]),b[0]+=c,b[2]+=c);return b};g.prototype.getSmallestInfoForScale=
function(b){var a=this.scales;if(this._infoByScale[b])return this._infoByScale[b];if(b>a[0])return this._infoByScale[a[0]];for(var c=1;c<a.length-1;c++)if(b>a[c]+1E-6)return this._infoByScale[a[c-1]];return this._infoByScale[a[a.length-1]]};g.prototype.getClosestInfoForScale=function(b){var a=this.scales;this._infoByScale[b]||(b=a.reduce(function(c,e,l,d){return Math.abs(e-b)<Math.abs(c-b)?e:c},a[0]));return this._infoByScale[b]};return g}()});