// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/2d/engine/webgl/WGLTile","require exports ../../../../core/tsSupport/extendsHelper ../../../../core/libs/gl-matrix/mat2d ../../../../core/libs/gl-matrix/mat4 ../../../../core/libs/gl-matrix/vec2 ../DisplayObject ./definitions ./DirtyMap ./DisplayRecordStore ./enums ./number ./Utils ./WGLBuffers ./WGLDisplayList ./WGLDisplayObject ../../tiling/enums ../../tiling/TileKey".split(" "),function(J,K,x,y,z,v,A,t,B,w,p,C,u,D,E,F,m,G){function H(r,e){return r.sortKey-
e.sortKey}return function(r){function e(a,c){var b=r.call(this)||this;b.status=m.TileStatus.INITIALIZED;b._data=null;b.hlDisplayList=null;b._wglBuffers=null;b._dirtyMap=new B.default;b.coords=[0,0];b.bounds=[0,0,0,0];b.tileTransform={transform:Float32Array[16],screenTransform:Float32Array[16],displayCoord:Float32Array[2],screenCoord:Float32Array[2]};b._hasVisualVariables=!1;b._labelIndex=null;b.tileTransform.screenTransform=y.create();b.tileTransform.transform=z.create();b.tileTransform.displayCoord=
v.create();b.tileTransform.screenCoord=v.create();b.key=G.pool.acquire(a);b.coords[0]=c[0];b.coords[1]=c[3];b.bounds=c;return b}x(e,r);Object.defineProperty(e.prototype,"iconGeometry",{get:function(){return this.getGeometry(p.WGLGeometryType.MARKER)},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"textGeometry",{get:function(){return this.getGeometry(p.WGLGeometryType.TEXT)},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"fillGeometry",{get:function(){return this.getGeometry(p.WGLGeometryType.FILL)},
enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"lineGeometry",{get:function(){return this.getGeometry(p.WGLGeometryType.LINE)},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"labelGeometry",{get:function(){return this.getGeometry(p.WGLGeometryType.LABEL)},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"displayObjects",{get:function(){return this._data.tileDisplayData.displayObjects},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,
"canDisplay",{get:function(){return!!this.attached&&!!this._data},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"isDirty",{get:function(){return this.status===m.TileStatus.MODIFIED},set:function(a){a&&this.status===m.TileStatus.READY?this.setStatus(m.TileStatus.MODIFIED):a||this.status!==m.TileStatus.MODIFIED||this.setStatus(m.TileStatus.READY);this.requestRender()},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"hasData",{get:function(){return this.status===
m.TileStatus.MODIFIED||this.status===m.TileStatus.READY},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"labelIndex",{get:function(){return this._labelIndex},enumerable:!0,configurable:!0});e.prototype.getGeometry=function(a){return this._wglBuffers&&this._wglBuffers.has(a)?this._wglBuffers.get(a):null};e.prototype.getDisplayList=function(a){switch(a){case p.WGLDrawPhase.HIGHLIGHT:return this.hlDisplayList;default:return this._data&&this._data.tileDisplayData.displayList}};Object.defineProperty(e.prototype,
"data",{get:function(){return this._data},enumerable:!0,configurable:!0});e.prototype.setData=function(a,c,b){this._hasVisualVariables=c;a&&a.tileDisplayData?(this._dispRecStore=w.default.fromTileData(a,this._dirtyMap),this._data=a,a.tileBufferData.geometries[4].indexBuffer.length?(this.setStatus(b?m.TileStatus.MODIFIED:m.TileStatus.READY),this._rebuildLabelIndex()):this.setStatus(m.TileStatus.READY),this._dirtyMap.markAllDirty()):(this.clear(),this.setStatus(m.TileStatus.NO_DATA))};e.prototype.patchData=
function(a,c){this._data||(this.setData(a.addOrUpdate,this._hasVisualVariables,c),a.addOrUpdate=null);this._patchData(a)||(this._dirtyMap.markAllDirty(),this._data.reshuffle(),this._dispRecStore=w.default.fromTileData(this._data,this._dirtyMap));a.addOrUpdate.tileBufferData.geometries[4].indexBuffer.length?(this.setStatus(c?m.TileStatus.MODIFIED:m.TileStatus.READY),this._rebuildLabelIndex()):this.setStatus(m.TileStatus.READY)};e.prototype.commitChanges=function(a){this._data&&this.status===m.TileStatus.READY&&
(this._wglBuffers||(this._wglBuffers=new D.default(a.context,this._hasVisualVariables)),this._wglBuffers.upload(this._data.tileBufferData,this._dirtyMap),this._dirtyMap.markAllClean())};e.prototype.setVisibility=function(a,c){for(var b=this._data.tileBufferData.geometries.map(function(I){return{vertexFrom:void 0,vertexTo:void 0,geometry:I}}),k=0;k<a.length;k++)for(var f=a[k],h=0,g=this._data.tileDisplayData.displayObjectRegistry.get(f.id).displayRecords;h<g.length;h++){var d=g[h];if(null==c||c===
d.geometryType){var l=b[d.geometryType],n=l.geometry.vertexBuffer[u.C_VBO_VISIBILITY];if(n){l.vertexFrom=null==l.vertexFrom?d.vertexFrom:Math.min(l.vertexFrom,d.vertexFrom);l.vertexTo=null==l.vertexTo?d.vertexFrom+d.vertexCount:Math.max(l.vertexTo,d.vertexFrom+d.vertexCount);l=d.vertexFrom*n.stride/4;d=d.vertexCount*n.stride/4;for(var q=0;q<d;++q)n.data[l+q]=f.visibility?4294967295:0}}}c=!1;for(a=0;a<b.length;++a)l=b[a],null!=l.vertexFrom&&null!=l.vertexTo&&(c=l.vertexTo?l.vertexTo-l.vertexFrom:0,
this.setStatus(m.TileStatus.MODIFIED),this._dirtyMap.markDirtyVertices(a,u.C_VBO_VISIBILITY,l.vertexFrom,c),c=!0);c&&this.requestRender()};e.prototype.setVisibilityRange=function(a,c,b,k){b=C.i8888to32(b,k,b,k);var f=k=void 0,h=this._data.tileBufferData.geometries[p.WGLGeometryType.LABEL].vertexBuffer[u.C_VBO_VISIBILITY_RANGE];a=this._data.tileDisplayData.displayObjectRegistry.get(a);c=a.metrics[c];var g=c.range.from;for(c=g+c.range.count;g<c;++g){var d=a.displayRecords[g];if(d.geometryType===p.WGLGeometryType.LABEL){k=
null==k?d.vertexFrom:Math.min(k,d.vertexFrom);f=null==f?d.vertexFrom+d.vertexCount:Math.max(f,d.vertexFrom+d.vertexCount);var l=d.vertexFrom*h.stride/4;d=d.vertexCount*h.stride/4;for(var n=0;n<d;++n)h.data[l+n]=b}}this._dirtyMap.markDirtyVertices(p.WGLGeometryType.LABEL,u.C_VBO_VISIBILITY_RANGE,k,f?f-k:0)};e.prototype.setStatus=function(a){this.status=a;if(a===m.TileStatus.READY||a===m.TileStatus.NO_DATA)this.attached=!0};e.prototype.clear=function(){this._data=null;this.setStatus(m.TileStatus.INVALID);
this._wglBuffers&&(this._wglBuffers.dispose(),this._wglBuffers=null);this.hlDisplayList&&(this.hlDisplayList=null)};e.prototype.dispose=function(){this.clear()};e.prototype.attach=function(a){return this.canDisplay};e.prototype.detach=function(a){r.prototype.detach.call(this,a)};e.prototype.doRender=function(a){var c=this;this.attached&&(this.commitChanges(a),a.context.setStencilFunction(514,this.stencilRef,255),a.painter.getBrushes(a.drawPhase).forEach(function(b){return b.draw(a,c)}))};e.prototype.buildHLList=
function(a){var c=this;this.hlDisplayList=new E;a.forEach(function(b){c._addToHLDisplayList(c.hlDisplayList,b)})};e.prototype._addToHLDisplayList=function(a,c){if(this._data){var b=this._data.tileDisplayData.displayObjectRegistry.get(c);if(b){c=[];var k=0;for(b=b.displayRecords;k<b.length;k++){var f=b[k].copy();f.meshData=null;f.symbolLevel=0;f.zOrder=0;c.push(f)}c.sort(H);a.addToList(c)}}};e.prototype._rebuildLabelIndex=function(){this._labelIndex=this._initLabelIndex();for(var a=0,c=this.displayObjects;a<
c.length;a++)this._insertIntoLabelIndex(c[a])};e.prototype._insertIntoLabelIndex=function(a){var c=a.anchor;-1!==a.xBucket&&c&&this.labelIndex[a.yBucket][a.xBucket].push(a)};e.prototype._initLabelIndex=function(){for(var a=[],c=0;c<t.TILE_SIZE/t.COLLISION_BUCKET_SIZE;c++){a.push([]);for(var b=0;b<t.TILE_SIZE/t.COLLISION_BUCKET_SIZE;b++)a[c].push([])}return a};e.prototype._patchData=function(a){for(var c=!0,b=0,k=a.remove||[];b<k.length;b++){var f=k[b],h=this._data.tileDisplayData.displayObjectRegistry.get(f);
if(h){this._data.tileDisplayData.displayList.removeFromList(h.displayRecords);for(var g=0,d=h.displayRecords;g<d.length;g++)this._dispRecStore.delete(d[g]);this._data.tileDisplayData.displayObjectRegistry.delete(f);h=this._data.tileDisplayData.displayObjects.indexOf(h);this._data.tileDisplayData.displayObjects.splice(h,1)}}b=0;for(k=a.addOrUpdate&&a.addOrUpdate.tileDisplayData&&a.addOrUpdate.tileDisplayData.displayObjects||[];b<k.length;b++){f=k[b];if(h=this._data.tileDisplayData.displayObjectRegistry.get(f.id)){var l=
h.displayRecords.length;for(g=0;g<l;++g){d=h.displayRecords[g];var n=f.displayRecords[g];if(g>=f.displayRecords.length||d.geometryType!==n.geometryType||d.symbolLevel!==n.symbolLevel||d.zOrder!==n.zOrder||d.materialInfo.materialKey!==n.materialInfo.materialKey)this._dispRecStore.delete(h.displayRecords[g]),g<f.displayRecords.length&&(h.displayRecords[g]=void 0)}h.displayRecords.length=f.displayRecords.length}else h=new F(f.id),this._data.tileDisplayData.displayObjectRegistry.set(f.id,h),this._data.tileDisplayData.displayObjects.push(h);
l=f.displayRecords.length;for(g=0;g<l;++g){n=f.displayRecords[g];(d=h.displayRecords[g])?(d.meshData=n.meshData,d.materialInfo=n.materialInfo):(d=n.copy(),d.vertexFrom=void 0,d.indexFrom=void 0,h.displayRecords[g]=d);var q=a.addOrUpdate.tileBufferData.geometries[n.geometryType];c=this._dispRecStore.setMeshData(d,n,q.vertexBuffer,q.indexBuffer)&&c}}return c};return e}(A)});