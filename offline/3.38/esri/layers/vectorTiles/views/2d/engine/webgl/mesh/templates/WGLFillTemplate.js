// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/2d/engine/webgl/mesh/templates/WGLFillTemplate","require exports ../../../../../../core/tsSupport/extendsHelper dojo/has ../../../../../../core/Logger ../../../../../../core/libs/earcut/earcut ../../color ../../definitions ../../enums ../../enums ../../number ../../TileClipper ../../WGLDisplayRecord ../Tesselator ./WGLMeshTemplate".split(" "),function(D,E,H,I,J,K,L,M,C,N,v,O,F,P,Q){Object.defineProperty(E,"__esModule",{value:!0});var R=J.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLFillTemplate"),
w=[],B=[];D=function(G){function l(c,a,d,e,b,g,f,k){var h=G.call(this)||this;h.fillColor=e;h.tl=b;h.br=g;h.aux=f;h.isBFS=k;h.geometryType=C.WGLGeometryType.FILL;h.useLibtess=!1;e=I("esri-featurelayer-webgl");h.useLibtess="libtess"===((e||{}).tesselator||"libtess");h.useLibtess&&(h._tesselator=new P.default);h.vvFlags=a;h._materialStore=c;h.materialId=h._materialStore.createSpriteMaterial(d,h.geometryType,a);h._tileClipper=new O.TileClipper(0,0,0,1,8);h._tileClipper.setExtent(512);return h}H(l,G);
l.fromSimpleFill=function(c,a,d,e,b,g){void 0===g&&(g=!1);d=(b=d.color)&&"none"!==d.style&&L.premultiplyAlphaRGBA(b)||0;if(!e)return new l(c,a,null,d,0,0,0,g);var f=e.rect;b=f.x+1;var k=f.y+1,h=f.x+1+e.width,r=f.y+1+e.height;f=v.i1616to32(b,k);var n=v.i1616to32(h,r);b=v.i8888to32(v.nextHighestPowerOfTwo(h-b),v.nextHighestPowerOfTwo(r-k),0,0);return new l(c,a,e,d,f,n,b,g)};l.fromPictureFill=function(c,a,d,e,b,g){void 0===g&&(g=!1);b=M.PICTURE_FILL_COLOR;var f=e.rect,k=f.x+1+e.width,h=f.y+1+e.height;
f=v.i1616to32(f.x+1,f.y+1);k=v.i1616to32(k,h);d=v.i8888to32(v.nextHighestPowerOfTwo(d.width),v.nextHighestPowerOfTwo(d.height),0,0);return new l(c,a,e,b,f,k,d,g)};l.prototype.writeMesh=function(c,a,d,e,b,g,f){w.length=0;if(this.vvFlags&N.WGLVVFlag.COLOR||0!==this.fillColor)if("esriGeometryPolygon"!==d)R.error("Unable to handle geometryType: "+d);else{var k=b.geometry;k=(b=this._isClippingRequired(k))?this._clip(k,!this.useLibtess):k.rings;return this.useLibtess?this._writeMeshLibtess(c,a,d,e,k,b,
g,f):this._writeMeshEarcut(c,a,d,e,k,b,g,f)}};l.prototype._isClippingRequired=function(c){var a=0;for(c=c.rings;a<c.length;a++){var d=c[a],e=d.length;if(!(3>e)){var b=d[0][0],g=d[0][1];if(-8>b||520<b||-8>g||520<g)return!0;for(var f=1;f<e;++f)if(b+=d[f][0],g+=d[f][1],-8>b||520<b||-8>g||520<g)return!0}}return!1};l.prototype._clip=function(c,a){this._tileClipper.reset(3);for(var d=0,e=c.rings;d<e.length;d++){var b=e[d],g=b.length;if(!(3>g)){c=b[0][0];var f=b[0][1];this._tileClipper.moveTo(c,f);for(var k=
1;k<g;++k)c+=b[k][0],f+=b[k][1],this._tileClipper.lineTo(c,f);this._tileClipper.close()}}return this._tileClipper.result(a)};l.prototype._writeMeshLibtess=function(c,a,d,e,b,g,f,k){if(b&&b.length){d=this._materialStore.get(this.materialId);f=[];var h=a.indexVector;a=a.get("geometry");var r=new F(e,this.geometryType,this.materialId),n=this._getOffset(a,d);r.vertexFrom=n;r.indexFrom=h.length;c.push(r);this._tesselator.beginPolygon(w,f);for(c=0;c<b.length;c++){var t=b[c];if(!(3>t.length)){this._tesselator.beginContour();
var p=void 0,u=void 0;g?(p=t[0].x,u=t[0].y):(p=t[0][0],u=t[0][1]);var m=[p,u,0];this._tesselator.addVertex(m,m);for(m=1;m<t.length-1;m++){var q=void 0,x=void 0;g?(p=t[m].x,u=t[m].y):(q=t[m][0],x=t[m][1],p+=q,u+=x);q=[p,u,0];this._tesselator.addVertex(q,q)}this._tesselator.endContour()}}this._tesselator.endPolygon();this._writeVerticesLibTess(r,a,e,w,d,k);this._writeIndicesLibTess(r,h,n,f)}};l.prototype._writeMeshEarcut=function(c,a,d,e,b,g,f,k){if(b&&b.length){d=this._materialStore.get(this.materialId);
f=a.indexVector;a=a.get("geometry");var h=new F(e,this.geometryType,this.materialId),r=this._getOffset(a,d);h.vertexFrom=r;h.indexFrom=f.length;c.push(h);for(var n=c=0,t=0;t<b.length;t++){var p=b[t],u=n,m=void 0,q=void 0;g?(m=p[0].x,q=p[0].y):(m=p[0][0],q=p[0][1]);w[n++]=m;w[n++]=q;for(var x=0,y=1;y<p.length;++y){var z=void 0,A=void 0;g?(z=m,A=q,m=p[y].x,q=p[y].y,z=m-z,A=q-A):(z=p[y][0],A=p[y][1],m+=z,q+=A);x-=z*(q+q+A);w[n++]=m;w[n++]=q}0<x?(0<u-c&&(this._write(h,f,a,r,e,w,B,c,u,d,k),c=u),B.length=
0):0>x?0<u-c?B.push(.5*(u-c)):n=u:n=u}0<n-c&&this._write(h,f,a,r,e,w,B,c,n,d,k);w.length=B.length=0}};l.prototype._write=function(c,a,d,e,b,g,f,k,h,r,n){e=K(g.slice(k,h),f,2);e.length&&(k=this._getOffset(d,r),this._writeVertices(c,d,b,g,f,r,n),this._writeIndices(c,a,k,e))};l.prototype._getOffset=function(c,a){a=a.materialKeyInfo.hasVV()?8:6;return c.length/a};l.prototype._writeVertices=function(c,a,d,e,b,g,f){for(b=0;b<e.length;b+=2){var k=v.i1616to32(e[b],e[b+1]);a.push(k);a.push(d);a.push(this.fillColor);
a.push(this.tl);a.push(this.br);a.push(this.aux);this._writeVV(a,f,g);c.vertexCount++}};l.prototype._writeIndices=function(c,a,d,e){for(var b=0;b<e.length;b+=3)a.push(d+e[b]),a.push(d+e[b+1]),a.push(d+e[b+2]),c.indexCount+=3};l.prototype._writeVerticesLibTess=function(c,a,d,e,b,g){for(var f=0;f<e.length;f+=2){var k=v.i1616to32(e[f],e[f+1]);a.push(k);a.push(d);a.push(this.fillColor);a.push(this.tl);a.push(this.br);a.push(this.aux);this._writeVV(a,g,b);c.vertexCount++}};l.prototype._writeIndicesLibTess=
function(c,a,d,e){for(var b=0;b<e.length;b++)a.push(d+e[b]),c.indexCount++};l.prototype._writeVV=function(c,a,d){d.materialKeyInfo.hasVV()&&(this.isBFS?(c.push(4294967295),c.push(4294967295)):(c.push(a[C.VVType.COLOR]),c.push(a[C.VVType.OPACITY])))};return l}(Q.default);E.default=D});