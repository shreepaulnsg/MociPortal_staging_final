// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/2d/engine/StageGL","require exports ../../../core/tsSupport/extendsHelper dojo/has ../../../core/promiseUtils ./Container ../engine/webgl/Fader ./webgl/BitBlitRenderer ./webgl/enums ./webgl/WGLPainter ./webgl/shaders/glShaderSnippets ../libs/gl-matrix/common ../libs/gl-matrix/mat2d ../libs/gl-matrix/vec2 ../../support/screenshotUtils ../../webgl/BufferObject ../../webgl/context-util ../../webgl/FramebufferObject ../../webgl/Program ../../webgl/RenderingContext ../../webgl/VertexArrayObject".split(" "),
function(S,T,F,C,G,H,I,J,x,K,D,L,z,t,M,E,N,A,O,P,Q){function B(w){return{state:w.state,pixelRatio:w.pixelRatio,stationary:w.stationary}}var R={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"};return function(w){function n(){var a=null!==w&&w.apply(this,arguments)||this;a._clipData=new Float32Array(8);a._upperLeft=t.create();a._upperRight=t.create();a._lowerLeft=t.create();a._lowerRight=t.create();a._mat2=z.create();a._clipRendererInitialized=!1;a._contextVersion=null;a._labelFader=new I.default(a);
return a}F(n,w);Object.defineProperty(n.prototype,"glPainter",{get:function(){return this._painter},enumerable:!0,configurable:!0});n.prototype.fadeInLabels=function(){this._labelFader.reset();this.requestRender()};n.prototype.createElement=function(){var a=document.createElement("canvas");a.setAttribute("class","esri-display-object");return a};n.prototype.setElement=function(a){this.element=a};n.prototype.useContextVersion=function(a){this._renderingContext||(this._contextVersion=a)};n.prototype.attach=
function(a){if(this.attached)return!0;this._resizeCanvas(a);var b=N.createContextOrErrorHTML(this.element,{alpha:!0,antialias:!1,depth:!0,stencil:!0},this._contextVersion);this._renderingContext=new P(b);this._contextVersion=this._renderingContext.contextVersion;this.attached=!0;this._cachedRenderParams=B(a);this._painter||(this._painter=new K.default,this._painter.initialize(this._renderingContext));return w.prototype.attach.call(this,a)};n.prototype.detach=function(a){w.prototype.detach.call(this,
a);this._boundFBO=null;this._clipFBO&&(this._clipFBO.dispose(),this._clipFBO=null);this._labelsFBO1&&(this._labelsFBO1.dispose(),this._labelsFBO1=null);this._labelsFBO2&&(this._labelsFBO2.dispose(),this._labelsFBO2=null);this._blitRenderer&&(this._blitRenderer.dispose(),this._blitRenderer=null);this._clipVAO&&(this._clipVAO.dispose(),this._clipVBO=this._clipVAO=null);this._painter&&(this._painter.dispose(),this._painter=null);this._clipStencilProgram&&(this._clipStencilProgram.dispose(),this._clipStencilProgram=
null);this._renderingContext&&(this._renderingContext.dispose(),this._renderingContext=null);this._cachedRenderParams=null};n.prototype.renderChildren=function(a){var b=this.children;a.drawPhase=x.WGLDrawPhase.FILL|x.WGLDrawPhase.LINE|x.WGLDrawPhase.MARKER|x.WGLDrawPhase.TEXT;for(var e=b.length,c=0;c<e;c++){var d=b[c];d.attached&&this.renderChild(d,a)}if(C("esri-featurelayer-webgl-labeling")){var f=a.context,m=f.getBoundFramebufferObject();f.bindFramebuffer(this._labelsFBO2);c=a.stationary;f.setClearColor(0,
0,0,c?0:1);f.clear(f.gl.COLOR_BUFFER_BIT);if(c)for(a.drawPhase=x.WGLDrawPhase.LABEL_ALPHA,a.labelFBO=this._labelsFBO1,a.labelStep=this._labelFader.step(),c=0;c<e;c++)d=b[c],d.attached&&this.renderChild(d,a);else this._labelFader.reset();f.bindFramebuffer(m);a.labelFBO=this._labelsFBO2;a.drawPhase=x.WGLDrawPhase.LABEL;for(c=0;c<e;c++)d=b[c],d.attached&&this.renderChild(d,a);a=this._labelsFBO2;this._labelsFBO2=this._labelsFBO1;this._labelsFBO1=a}};n.prototype.beforeRenderChildren=function(a,b){a=b.context;
var e=b.state,c=b.pixelRatio;if(b=this._painter){a.enforceState();b.update(e,c);var d=e.width;b=e.height;var f=e.rotation;d=Math.round(d*c);b=Math.round(b*c);this._boundFBO=a.getBoundFramebufferObject();!C("esri-featurelayer-webgl-labeling")||this._labelsFBO1&&this._labelsFBO1.width===d&&this._labelsFBO1.height===b||(this._labelsFBO1&&(this._labelsFBO1.dispose(),this._labelsFBO2.dispose()),this._labelsFBO1=A.createWithAttachments(a,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,samplingMode:9728,
wrapMode:33071,width:d,height:b},{colorTarget:0,depthStencilTarget:0}),a.bindFramebuffer(this._labelsFBO1),a.setDepthWriteEnabled(!0),a.setStencilWriteMask(255),a.setClearColor(0,0,0,0),a.setClearDepth(1),a.setClearStencil(0),a.clear(a.gl.COLOR_BUFFER_BIT|a.gl.DEPTH_BUFFER_BIT|a.gl.STENCIL_BUFFER_BIT),a.setDepthWriteEnabled(!1),a.bindFramebuffer(this._boundFBO),this._labelsFBO2=A.createWithAttachments(a,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,
width:d,height:b},{colorTarget:0,depthStencilTarget:0}));if(e.spatialReference&&(e.spatialReference._isWrappable?e.spatialReference._isWrappable():e.spatialReference.isWrappable)){var m=L.toRadian(f),l=Math.abs(Math.cos(m)),h=Math.abs(Math.sin(m)),p=Math.round(e.worldScreenWidth);if(Math.round(d*l+b*h)<=p)this._clipFrame=!1;else{this._clipFBO&&this._clipFBO.width===d&&this._clipFBO.height===b||(this._clipFBO=new A(a,{colorTarget:0,depthStencilTarget:3,width:d,height:b}));var y=.5*d,g=.5*b;e=1/d;var r=
1/b;c*=.5*p;var v=.5*(d*h+b*l);d=this._upperLeft;l=this._upperRight;h=this._lowerLeft;p=this._lowerRight;t.set(d,-c,-v);t.set(l,c,-v);t.set(h,-c,v);t.set(p,c,v);z.identity(this._mat2);z.translate(this._mat2,this._mat2,[y,g]);0!==f&&z.rotate(this._mat2,this._mat2,m);t.transformMat2d(d,d,this._mat2);t.transformMat2d(l,l,this._mat2);t.transformMat2d(h,h,this._mat2);t.transformMat2d(p,p,this._mat2);f=this._clipData;f.set([2*h[0]*e-1,2*(b-h[1])*r-1,2*p[0]*e-1,2*(b-p[1])*r-1,2*d[0]*e-1,2*(b-d[1])*r-1,2*
l[0]*e-1,2*(b-l[1])*r-1]);this._clipRendererInitialized||this._initializeClipRenderer(a);this._clipVBO.setData(f);this._boundFBO=a.getBoundFramebufferObject();a.bindFramebuffer(this._clipFBO);a.setDepthWriteEnabled(!0);a.setStencilWriteMask(255);a.setClearColor(0,0,0,0);a.setClearDepth(1);a.setClearStencil(0);a.clear(a.gl.COLOR_BUFFER_BIT|a.gl.DEPTH_BUFFER_BIT|a.gl.STENCIL_BUFFER_BIT);a.setDepthWriteEnabled(!1);this._clipFrame=!0}}else this._clipFrame=!1}};n.prototype.afterRenderChildren=function(a,
b){this._clipFrame&&this._clipRendererInitialized&&(a=this._renderingContext,a.bindFramebuffer(this._boundFBO),this._boundFBO=null,a.bindVAO(this._clipVAO),a.bindProgram(this._clipStencilProgram),a.setDepthWriteEnabled(!1),a.setDepthTestEnabled(!1),a.setStencilTestEnabled(!0),a.setBlendingEnabled(!1),a.setColorMask(!1,!1,!1,!1),a.setStencilOp(7680,7680,7681),a.setStencilWriteMask(255),a.setStencilFunction(519,1,255),a.drawElements(4,6,5123,0),a.bindVAO(),a.setColorMask(!0,!0,!0,!0),a.setBlendingEnabled(!0),
a.setStencilFunction(514,1,255),this._blitRenderer.render(a,this._clipFBO.colorTexture,9728,1),a.setStencilTestEnabled(!1))};n.prototype.doRender=function(a){var b=this.element.style;this.visible?(b.display="block",b.opacity=""+this.opacity,this._resizeCanvas(a),w.prototype.doRender.call(this,a),this._cachedRenderParams=B(a)):b.display="none"};n.prototype.takeScreenshot=function(a){void 0===a&&(a={});var b=a.pixelRatio||1;this._cachedRenderParams.pixelRatio=b;var e=Math.round(b*this._cachedRenderParams.state.width),
c=Math.round(b*this._cachedRenderParams.state.height),d=0,f=0,m=e,l=c,h=e,p=c;if(h=a.area)d=Math.round(b*h.x),f=Math.round(b*h.y),m=Math.round(b*h.width),l=Math.round(b*h.height);void 0!==a.width&&void 0!==a.height?(h=a.width/a.height,l*h<m?(h*=l,d+=Math.floor((m-h)/2),m=Math.floor(h)):(h=m/h,f+=Math.floor((l-h)/2),l=Math.floor(h)),h=a.width,p=a.height):(h=m,p=l);b=document.createElement("canvas");b.width=h;b.height=p;var y=b.getContext("2d"),g=new Uint8Array(m*l*4),r=this._renderingContext,v=A.create(r,
{colorTarget:1,depthStencilTarget:3,width:e,height:c});r.bindFramebuffer(v);r.setViewport(0,0,e,c);var k=this._cachedRenderParams,q=this._renderingContext.gl;this._renderingContext.setClearColor(0,0,0,0);this._renderingContext.setClearDepth(1);this._renderingContext.setClearStencil(0);this._renderingContext.clear(q.COLOR_BUFFER_BIT|q.DEPTH_BUFFER_BIT|q.STENCIL_BUFFER_BIT);k.context=this._renderingContext;k.painter=this._painter;this.beforeRenderChildren(k,k);if(void 0!==a.rotation&&null!==a.rotation){q=
k.state;var u=q.clone();u.viewpoint.rotation=a.rotation;k.state=u;this.renderChildren(k);k.state=q}else this.renderChildren(k);this.afterRenderChildren(k,k);v.readPixels(d,c-(f+l),m,l,6408,5121,g);r.bindFramebuffer();r=y.getImageData(0,0,h,p);if(0!==d||0!==f||m!==e||l!==c||h!==e||p!==c)M.resampleHermite(g,m,l,r.data,h,p,!0);else{f=l-1;l=0;v=4*m;for(u=q=d=c=e=m=k=void 0;l<f;){q=l*v;u=f*v;for(k=0;k<v;k+=4)m=g[q+k],e=g[q+k+1],c=g[q+k+2],d=g[q+k+3],g[q+k]=g[u+k],g[q+k+1]=g[u+k+1],g[q+k+2]=g[u+k+2],g[q+
k+3]=g[u+k+3],g[u+k]=m,g[u+k+1]=e,g[u+k+2]=c,g[u+k+3]=d;l++;f--}m=r.data;e=g.length;for(f=0;f<e;f++)m[f]=g[f]}g=r.data;l=g.length;for(f=0;f<l;f+=4)d=g[f+3],0<d&&(c=d/255,m=Math.floor(g[f+0]/c),e=Math.floor(g[f+1]/c),c=Math.floor(g[f+2]/c),g[f+0]=255>=m?m:255,g[f+1]=255>=e?e:255,g[f+2]=255>=c?c:255);y.putImageData(r,0,0);y=R[a.format?a.format.toLowerCase():"png"];g=1;void 0!==a.quality&&(g=a.quality/100);a=b.toDataURL(y,g);return G.resolve({dataURL:a,x:0,y:0,width:h,height:p})};n.prototype.prepareChildrenRenderParameters=
function(a){if(!this.attached||!this._renderingContext)return null;a=B(a);var b=this._renderingContext,e=b.gl;b.setDepthWriteEnabled(!0);b.setStencilWriteMask(255);b.setClearColor(0,0,0,0);b.setClearDepth(1);b.setClearStencil(0);b.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT);b.setViewport(0,0,this.element.width,this.element.height);b.setDepthWriteEnabled(!1);a.context=b;a.painter=this._painter;return a};n.prototype.attachChild=function(a,b){return a.attach(b)};n.prototype.detachChild=
function(a,b){return a.detach(b)};n.prototype.renderChild=function(a,b){return a.processRender(b)};n.prototype._resizeCanvas=function(a){var b=this.element,e=b.style,c=a.state,d=a.pixelRatio;a=Math.round(c.width*d);d=Math.round(c.height*d);if(b.width!==a||b.height!==d)b.width=a,b.height=d;e.width=c.width+"px";e.height=c.height+"px"};n.prototype._initializeClipRenderer=function(a){if(this._clipRendererInitialized)return!0;this._blitRenderer=new J;var b={a_pos:0},e=new O(a,D.stencilVS,D.stencilFS,b);
if(!e)return!1;var c=E.createVertex(a,35040,32),d=new Uint16Array([0,1,2,2,1,3]);d=E.createIndex(a,35044,d);a=new Q(a,b,{geometry:[{name:"a_pos",count:2,type:5126,offset:0,stride:8,normalized:!1,divisor:0}]},{geometry:c},d);this._clipStencilProgram=e;this._clipVBO=c;this._clipVAO=a;return this._clipRendererInitialized=!0};return n}(H)});