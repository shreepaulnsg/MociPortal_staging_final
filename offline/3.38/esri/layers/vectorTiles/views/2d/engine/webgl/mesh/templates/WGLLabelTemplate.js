// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/2d/engine/webgl/mesh/templates/WGLLabelTemplate","require exports ../../../../../../core/tsSupport/extendsHelper ../../../../../../core/Logger ../../../../../../core/screenUtils ../../../../../../core/libs/gl-matrix/mat2d ../../../../../../core/libs/gl-matrix/vec2 ../../../../../../geometry/support/centroid ../../color ../../enums ../../fontUtils ../../number ../../TextShaping ../../WGLDisplayRecord ../../collisions/BoundingBox ./WGLMeshTemplate ./WGLTextTemplate".split(" "),
function(x,y,I,J,u,z,q,K,A,B,L,t,v,C,M,N,O){Object.defineProperty(y,"__esModule",{value:!0});var P=J.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),D=24*1.2,E=t.i8888to32(255,255,255,255),F={xOffset:0,yOffset:0,width:0,height:0};x=function(G){function h(b,a,d){var c=G.call(this)||this;c.geometryType=B.WGLGeometryType.LABEL;c.vvFlags=0;c._textBoxVerticalOffset=0;c._textBoxHorizontalOffset=0;c._refTemplate=F;c._xOffset=a.xoffset;c._yOffset=-a.yoffset;c._decorationOffset=L.getFontDecorationOffset(a.font);
var f=a.haloColor;c._color=(a.color&&A.premultiplyAlphaRGBA(a.color))|0;var e=a.yoffset/a.font.size;c._shapingXOffset=a.xoffset/a.font.size*24;c._shapingYOffset=24*e;c._haloColor=(f&&A.premultiplyAlphaRGBA(f))|0;c._haloSize=10*u.pt2px(u.toPt(a.haloSize||0));c._textPropSize=u.pt2px(a.font.size);c._textPropAngle=a.angle*Math.PI/180;c._textPropHJustification="left"===a.horizontalAlignment?0:"right"===a.horizontalAlignment?1:.5;f=0;e=.5;switch(d){case "above-center":case "above-left":case "above-right":f=
-.5;e=0;break;case "below-center":case "below-left":case "below-right":f=.5,e=1}var g=0,l=.5;switch(d){case "above-left":case "center-left":case "below-left":g=-.5;l=1;break;case "above-right":case "center-right":case "below-right":g=.5,l=0}c._textPropHAnchorPlacement=l;c._textPropVAnchorPlacement=e;c._placementDirection=[g,f];c._materialStore=b;c.symbolId=a.id;c.anchor=q.create();return c}I(h,G);h.fromText=function(b,a,d,c,f,e){return new h(b,d,f)};Object.defineProperty(h.prototype,"bounds",{get:function(){return this._bounds},
enumerable:!0,configurable:!0});h.prototype.computeGlyphs=function(b,a){var d=a.text;if(!d||!d.length)return this._computedGlyphs=[],1;b=this._computeShaping(b,240,D,0,this._shapingXOffset,this._shapingYOffset,this._textPropHAnchorPlacement,this._textPropVAnchorPlacement,this._textPropHJustification).getShaping(d,a.rtl);isNaN(this._decorationOffset)||v.addDecoration(b,this._decorationOffset);a=Array(b.length);for(d=0;d<b.length;d++){var c=this._textPropAngle,f=this._textPropSize,e=this._haloSize,
g=this._materialStore.createGlyphMaterial(b[d].glyphMosaicItem,B.WGLGeometryType.LABEL,this.vvFlags);a[d]=O.ComputedGlyph.from(b[d],g,c,f,e)}this._computedGlyphs=a;if(!b||0===b.length)return 2;b=v.getBox(b);a=this._textPropSize/24;b.width*=a;b.height*=a;b.x*=a;b.y*=a;0>this._placementDirection[0]?this._textBoxHorizontalOffset=-b.x-b.width:0<this._placementDirection[0]&&(this._textBoxHorizontalOffset=-b.x);0>this._placementDirection[1]?this._textBoxVerticalOffset=-b.y:0<this._placementDirection[1]&&
(this._textBoxVerticalOffset=-b.y+b.height);d=b.width/2;c=b.height/2;this._textPropAngle&&(a=q.fromValues(-d,-c),d=q.fromValues(d,c),c=z.create(),z.rotate(c,c,this._textPropAngle),q.transformMat2d(a,a,c),q.transformMat2d(d,d,c),c=Math.abs(d[1]-a[1]),b.width=Math.abs(d[0]-a[0]),b.height=c);this._bounds=new M.default(b.x,b.y,b.width+10,b.height+10);b=this._placementDirection[1]*(this._refTemplate.height+this._bounds.height);this._bounds.center[0]=this._placementDirection[0]*(this._refTemplate.width+
this._bounds.width)+this._xOffset;this._bounds.center[1]=b+this._yOffset;return 0};h.prototype.bindReferenceTemplate=function(b){this._refTemplate=b?b:F};h.prototype.computeAnchor=function(b,a){var d=this._refTemplate.xOffset,c=this._refTemplate.yOffset;switch(b){case "esriGeometryPoint":a=a.geometry;b=a.x;a=a.y;this._setAnchor(b,a);break;case "esriGeometryMultipoint":b=a.geometry;a=this._computeAnchorMultipoint(b.points);b=a.x;a=a.y;this._setAnchor(b,a);break;case "esriGeometryPolygon":if(a.centroid){b=
a.centroid;this._setAnchor(b.x,b.y);break}b=a.geometry;a=this._computeAnchorRings(b.rings);if(!a)break;b=a.x;a=a.y;this._setAnchor(b,a);break;case "esriGeometryPolyline":b=a.geometry;a=this._computeAnchorRings(b.paths);if(!a)break;b=a.x;a=a.y;this._setAnchor(b,a);break;default:P.error("Unable to handle geometryType: "+b)}return q.fromValues(this.anchor[0]+d,this.anchor[1]+c)};h.prototype.writeMesh=function(b,a,d,c,f,e,g){d=a.indexVector;f=a.get("geometry");e=a.get("visibility");a=a.get("visibilityRange");
g=this._getOffset(f);var l=t.i8888to32(this._refTemplate.xOffset,-this._refTemplate.yOffset,this._placementDirection[0]*(this._refTemplate.width+10)+this._textBoxHorizontalOffset,this._placementDirection[1]*(this._refTemplate.height+10)+this._textBoxVerticalOffset);this._writeVertices(b,d,f,e,a,c,g,l,this.anchor[0],this.anchor[1])};h.prototype._setAnchor=function(b,a){this.anchor[0]=b;this.anchor[1]=a};h.prototype._computeAnchorMultipoint=function(b){return b.length&&b[0].length?{x:b[0][0],y:b[0][1]}:
null};h.prototype._computeAnchorRings=function(b){if(!b.length||!b[0].length||!b[0][0].length)return null;b=K.ringsCentroid(b,!1);return{x:b[0],y:b[1]}};h.prototype._computeShaping=function(b,a,d,c,f,e,g,l,m){return this._shaping=new v([b],240,D,0,[f,e],g,l,m)};h.prototype._getOffset=function(b){return b.length/5};h.prototype._writeVertices=function(b,a,d,c,f,e,g,l,m,n){var r=this._computedGlyphs,Q=t.i1616to32(2*m,2*n);m=t.i1616to32(2*m+1,2*n);n=0;var H=t.i8888to32(0,(e&16711680)>>16,(e&65280)>>8,
e&255);if(this._haloSize)for(var p=0;p<r.length;p++,n+=4){var k=r[p].materialId,w=this._materialStore.get(k);k=new C(e,this.geometryType,k);k.vertexFrom=g+n;k.indexFrom=a.length;this._writeGlyph(k,d,c,f,H,m,this._haloColor,l,r[p],w);this._writeIndices(k,a,g+n);b.push(k)}for(p=0;p<r.length;p++,n+=4)k=r[p].materialId,w=this._materialStore.get(k),k=new C(e,this.geometryType,k),k.vertexFrom=g+n,k.indexFrom=a.length,this._writeGlyph(k,d,c,f,H,Q,this._color,l,r[p],w),this._writeIndices(k,a,g+n),b.push(k)};
h.prototype._writeGlyph=function(b,a,d,c,f,e,g,l,m,n){a.push(e);a.push(g);a.push(m.vertexOffsetUpperLeft);a.push(m.texFontSizeUpperLeft);a.push(l);a.push(e);a.push(g);a.push(m.vertexOffsetUpperRight);a.push(m.texFontSizeUpperRight);a.push(l);a.push(e);a.push(g);a.push(m.vertexOffsetLowerLeft);a.push(m.texFontSizeLowerLeft);a.push(l);a.push(e);a.push(g);a.push(m.vertexOffsetLowerRight);a.push(m.texFontSizeLowerRight);a.push(l);d.push(4294967295);c.push(E);c.push(E);b.vertexCount+=4};h.prototype._writeIndices=
function(b,a,d){a.push(d+0);a.push(d+1);a.push(d+2);a.push(d+1);a.push(d+3);a.push(d+2);b.indexCount+=6};return h}(N.default);y.default=x});