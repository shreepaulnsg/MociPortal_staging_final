// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/2d/engine/webgl/mesh/factories/WGLMeshFactory","require exports ../../../../../../core/tsSupport/extendsHelper ../../../../../../core/Error ../../../../../../core/Logger ../../../../../../symbols/SimpleLineSymbol ../../definitions ../../enums ../../MaterialInfo ../../Utils ../../visualVariablesUtils ../../WGLDisplayObject ../VertexVector ../templates/meshTemplateUtils ../templates/WGLLabelTemplate ../templates/WGLLineTemplate ../templates/WGLMarkerTemplate ../../util/Matcher ../../util/serializationUtils ../../util/vvFlagUtils ../../util/Writer".split(" "),
function(K,F,Y,D,P,Q,x,k,G,H,L,R,w,y,S,T,M,I,J,z,N){Object.defineProperty(F,"__esModule",{value:!0});var A=P.getLogger("esri.views.2d.engine.webgl.WGLMeshFactory"),U={esriGeometryPoint:"above-center above-left above-right center-center center-left center-right below-center below-left below-right".split(" "),esriGeometryPolygon:["always-horizontal"],esriGeometryPolyline:null,esriGeometryMultipoint:null,esriGeometryEnvelope:null},E=function(){function f(){this._materials=[];this._materialsIndex=new Map}
f.prototype.insert=function(a){var b=this._materials.length;this._materials.push(a);return b};f.prototype._hashGlyph=function(a,b,c){return"G-"+b+"-"+c+"-"+a.page};f.prototype._hashSprite=function(a,b,c){return"S-"+b+"-"+c+"-"+(a?a.page:-1)+"-"+(a?a.sdf:!1)};f.prototype.createSpriteMaterial=function(a,b,c){var d=this._hashSprite(a,b,c);if(this._materialsIndex.has(d))return this._materialsIndex.get(d);var e=this._materials.length;a=G.default.fromSprite(a,b,c);this._materials.push(a);this._materialsIndex.set(d,
e);return e};f.prototype.createGlyphMaterial=function(a,b,c){var d=this._hashGlyph(a,b,c);if(this._materialsIndex.has(d))return this._materialsIndex.get(d);var e=this._materials.length;a=G.default.fromGlyph(a,b,c);this._materials.push(a);this._materialsIndex.set(d,e);return e};f.prototype.get=function(a){return this._materials[a]};f.prototype.serialize=function(a){J.serializeList(a,this._materials);return a};f.deserialize=function(a){var b=new f;b._materials=J.deserializeList(a,G.default);return b};
return f}();F.MaterialStore=E;var V=function(){function f(a){this._bucketSize=a;this._rowsLength=x.TILE_SIZE/a;this._colsLength=x.TILE_SIZE/a;this._grid=this._initGrid()}f.prototype.checkOverlap=function(a,b){a=Math.floor(a/this._bucketSize);b=Math.floor(b/this._bucketSize);if(0>a||a>=this._rowsLength||0>b||b>=this._colsLength||this._grid[b][a])return!0;this._grid[b][a]=!0;return!1};f.prototype.reset=function(){this._grid=this._initGrid()};f.prototype._initGrid=function(){for(var a=[],b=0;b<this._rowsLength;b++)a.push(Array(this._colsLength));
return a};return f}(),W=function(){function f(a,b,c){this.displayObjects=a;this.vertexVectorsMap=b;this._materials=c;this.grid=new V(x.COLLISION_EARLY_REJECT_BUCKET_SIZE)}f.prototype.get=function(a){return this.vertexVectorsMap[a]};f.prototype.pushDisplayObject=function(a){this.displayObjects.push(a)};f.prototype.encode=function(a,b){var c=J.serializeList(new N.default(Uint32Array,this._guessSize()),this.displayObjects).buffer(),d=this._materials.serialize(new N.default(Uint32Array)).buffer(),e={};
b.push(c);b.push(d);for(var h=0;h<this.vertexVectorsMap.length;h++){var g=this.vertexVectorsMap[h];e[h]={};g.transfer(e[h],b)}a.displayObjects=c;a.materialStore=d;a.vertexBuffersMap=e;this.destroy()};f.prototype.destroy=function(){this.displayObjects=this.vertexVectorsMap=null};f.prototype._guessSize=function(){for(var a=this.displayObjects,b=Math.min(a.length,4),c=0,d=0;d<b;d++)c=Math.max(c,a[d].displayRecords.length);return 2*(12*a.length+a.length*c*40)};return f}(),X=function(){function f(){this._vvMap=
new Map}f.prototype.set=function(a,b){this._vvMap.set(a,b)};f.prototype.getValue=function(a,b,c){return this._vvMap.has(a)?this._vvMap.get(a)(b,c):0};return f}();K=function(){function f(a,b,c,d,e,h,g,q,n,p){var m=this;this._labelsDebugTemplate=null;this._matcher=a;this._materials=c;this._geometryType=d;this._idField=e;this._pixelRatio=n;this._vvMap=null;this._vvFlags=g;this._vvBuf=new ArrayBuffer(16);this._vvBufU32=new Uint32Array(this._vvBuf);this._vvBufF32=new Float32Array(this._vvBuf);this._createVVFunctionMap(h,
b,q);p&&(this._validateLabelingInfo(p)?this._labelTemplates=p.map(function(l){return S.default.fromText(m._materials,0,l.symbol,n,l.labelPlacement)}):A.error(new D("mapview-labeling:unsupported-geometry","LabelingInfo failed validation - unable to create labels for layer.")))}f.from=function(a,b,c,d,e,h,g,q){switch(a.type){case "simple":return f._fromSimpleRenderer(a,b,c,d,e,h,g,q);case "unique-value":case "uniqueValue":return f._fromUniqueValueRenderer(a,b,c,d,e,h,g,q);case "class-breaks":case "classBreaks":return f._fromClassBreaksRenderer(a,
b,c,d,e,h,g,q);default:return A.error(new D("mapview-mesh:invalid-renderer","Unable to handle unknown renderer type")),null}};Object.defineProperty(f.prototype,"materials",{get:function(){return this._materials},enumerable:!0,configurable:!0});f.prototype.createMeshData=function(a){var b=Array(5),c=this._matcher.getDefault(),d=!!z.getMarkerVVFlags(this._vvFlags),e=!!z.getFillVVFlags(this._vvFlags),h=!!z.getLineVVFlags(this._vvFlags,"esriGeometryPolyline"!==this._geometryType),g=!!z.getTextVVFlags(this._vvFlags);
!this._labelTemplates&&c&&1===c.length&&c[0]instanceof M.default?(b[k.WGLGeometryType.MARKER]=new w.VertexVectors(k.WGLGeometryType.MARKER,d,a),b[k.WGLGeometryType.FILL]=new w.VertexVectors(k.WGLGeometryType.FILL,e,0),b[k.WGLGeometryType.LINE]=new w.VertexVectors(k.WGLGeometryType.LINE,h,0),b[k.WGLGeometryType.TEXT]=new w.VertexVectors(k.WGLGeometryType.TEXT,g,0),b[k.WGLGeometryType.LABEL]=new w.VertexVectors(k.WGLGeometryType.LABEL,!1,0)):(b[k.WGLGeometryType.MARKER]=new w.VertexVectors(k.WGLGeometryType.MARKER,
d,a),b[k.WGLGeometryType.FILL]=new w.VertexVectors(k.WGLGeometryType.FILL,e,a),b[k.WGLGeometryType.LINE]=new w.VertexVectors(k.WGLGeometryType.LINE,h,a),b[k.WGLGeometryType.TEXT]=new w.VertexVectors(k.WGLGeometryType.TEXT,g,a),b[k.WGLGeometryType.LABEL]=new w.VertexVectors(k.WGLGeometryType.LABEL,!1,this._labelTemplates&&0<this._labelTemplates.length?a:0));return new W([],b,this._materials)};f.prototype.write=function(a,b,c,d,e){var h=1===this._matcher.size()&&this._matcher.getDefault()||this._matcher.match(b,
c),g=b.attributes[this._idField],q=new R(g),n=!!d&&!!this._labelTemplates;this._computeVV(b,c);if(h&&(b.geometry||b.centroid)){c=q.displayRecords;for(var p=0;p<h.length;p++){var m=h[p],l=a.get(m.geometryType);m.writeMesh(c,l,this._geometryType,g,b,this._pixelRatio,this._vvBufU32)}n&&(h=this._getLabelReference(h),this._writeLabelMesh(q,a,g,b,e,d.get(g),h));a.pushDisplayObject(q)}};f.prototype._hasBadLabelClass=function(a,b){var c=a.labelPlacement,d=U[b];if(!d)return A.error(new D("mapview-labeling:unsupported-geometry-type",
"Unable to create labels for WebGL Feature Layer, "+b+" is not supported")),!0;d.some(function(e){return e===c})||(d=d[0],A.warn("Found invalid label placement type "+c+" for "+b+". Defaulting to "+d),a.labelPlacement=d);return!1};f.prototype._validateLabelingInfo=function(a){var b=this;return!a.some(function(c){return b._hasBadLabelClass(c,b._geometryType)})};f.prototype._getLabelReference=function(a){for(var b=0;b<a.length;b++){var c=a[b];if(c instanceof M.default)return c}return null};f.prototype._writeLabelMesh=
function(a,b,c,d,e,h,g){for(var q=a.displayRecords,n=0,p=0,m=-1,l=-1,r=0;r<h.labelingInfo.length;r++){var t=h.labelingInfo[r],u=h.text[r],v=this._labelTemplates[t],B=b.get(v.geometryType),C=e.get(v.symbolId).glyphMosaicItems,O=q.length;v.bindReferenceTemplate(g);if(!v.computeGlyphs(C,u)){C=v.computeAnchor(this._geometryType,d);u=v.bounds;if(-1===m&&(m=Math.floor(C[0]/x.COLLISION_BUCKET_SIZE),l=Math.floor(C[1]/x.COLLISION_BUCKET_SIZE),b.grid.checkOverlap(C[0],C[1])))return;v.writeMesh(q,B,this._geometryType,
c,d,this._pixelRatio,this._vvBufU32);a.anchor=C;a.addMetric(u,O,q.length-O,t);t=u.center;n=Math.max(u.halfWidth+Math.abs(t[0]),n);p=Math.max(u.halfHeight+Math.abs(t[1]),p)}}-1!==m&&(c=2.5*Math.max(n,p),b=Math.ceil(Math.abs((c-a.anchor[0]%x.COLLISION_BUCKET_SIZE)/x.COLLISION_BUCKET_SIZE)),c=Math.ceil(Math.abs((c-a.anchor[1]%x.COLLISION_BUCKET_SIZE)/x.COLLISION_BUCKET_SIZE)),a.xBucket=m,a.yBucket=l,a.xOverflow=b,a.yOverflow=c)};f.prototype._debugLabels=function(a,b,c,d,e){d={geometry:{paths:[[[d[0]+
e.center[0]-e.width/2,d[1]+e.center[1]+e.height/2],[0,-e.height],[e.width,0],[0,e.height],[-e.width,0]]]},attributes:{}};e=this._getLabelDebugTemplate();b=b.get(e.geometryType);e.writeMesh(a,b,"esriGeometryPolyline",c,d,this._pixelRatio,this._vvBufU32)};f.prototype._getLabelDebugTemplate=function(){this._labelsDebugTemplate||(this._labelsDebugTemplate=this._createLabelsDebugTemplate());return this._labelsDebugTemplate};f.prototype._createLabelsDebugTemplate=function(){var a=new Q({style:"solid",width:1,
color:[255,0,0,1]});return T.default.fromSimpleLine(this._materials,0,a,null,this._pixelRatio)};f.prototype._isErrorVV=function(a){return null===a||isNaN(a)||Infinity===a};f.prototype._computeVV=function(a,b){if(!this._vvMap)return 0;var c=this._vvMap.getValue(k.VVType.SIZE,a,b),d=this._vvMap.getValue(k.VVType.COLOR,a,b),e=this._vvMap.getValue(k.VVType.OPACITY,a,b);a=this._vvMap.getValue(k.VVType.ROTATION,a,b);this._vvBufF32[k.VVType.SIZE]=this._isErrorVV(c)?NaN:c;this._vvBufF32[k.VVType.COLOR]=this._isErrorVV(d)?
NaN:d;this._vvBufF32[k.VVType.OPACITY]=this._isErrorVV(e)?NaN:e;this._vvBufF32[k.VVType.ROTATION]=this._isErrorVV(a)?NaN:a;return 0};f.prototype._createVVFunctionMap=function(a,b,c){if(a&&a.length)for(var d=0;d<a.length;d++){var e=a[d],h=H.getVVType(e.type);if(e=this._createGetValueFunction(e,b,c))this._vvMap||(this._vvMap=new X),this._vvMap.set(h,e)}};f.prototype._createGetValueFunction=function(a,b,c){if(H.getVVType(a.type)===k.VVType.SIZE){var d=L.getTypeOfSizeVisualVariable(a);return d===k.WGLVVFlag.SIZE_SCALE_STOPS?
null:this._createNormalizedFunction(a,b,c,d===k.WGLVVFlag.SIZE_UNIT_VALUE&&function(e){return L.getVisualVariableSizeValueRepresentationRatio(e,a.valueRepresentation)})}return this._createNormalizedFunction(a,b,c)};f.prototype._createNormalizedFunction=function(a,b,c,d){var e=a.field;if(e){if("string"===typeof e){var h=a.normalizationField;return h?function(g){if(g.attributes[e]&&g.attributes[h])return g=g.attributes[e]/g.attributes[h],d?d(g):g}:d?function(g){return d(g.attributes[e])}:function(g){return g.attributes[e]}}if("function"===
typeof e)return A.error(new D("mapview-rendering:unsupported-feature","Function field types are not currently supported. Please use a valueExpression instead")),function(g){};A.error(new D("mapview-rendering:invalid-type","The field for a vv must be a string or a number, but got "+typeof e));return function(g){}}if(a.valueExpression&&"$view.scale"!==a.valueExpression)return H.createArcadeFunction({valueExpression:a.valueExpression,spatialReference:c,layer:b},d);A.error("Unable to create a normalized function for visual variable: "+
a);return function(g){}};f._fromSimpleRenderer=function(a,b,c,d,e,h,g,q){var n=a.getSymbols();a=a.visualVariables;var p=z.getVVFlags(a),m=new I.default,l=new E;n.length&&m.setDefault(y.createMeshTemplates([],l,n[0],c,p,g));return new f(m,b,l,d,e,a,p,h,g,q)};f._fromUniqueValueRenderer=function(a,b,c,d,e,h,g,q){var n=a.uniqueValueInfos,p=a.visualVariables,m=z.getVVFlags(p),l=[a.field];a.field2&&l.push(a.field2);a.field3&&l.push(a.field3);var r=a.valueExpression;l=new I.MapMatcher(l,a.fieldDelimiter,
r?{valueExpression:r,spatialReference:h,layer:b}:null);r=new E;var t=a.backgroundFillSymbol;t=t&&y.createMeshTemplates([],r,t,c,m,g);for(var u=0;u<n.length;u++){var v=n[u],B=y.createMeshTemplates([],r,v.symbol,c,m,g);l.add(v.value,t?t.concat(B):B)}if(a=a.defaultSymbol)c=y.createMeshTemplates([],r,a,c,m,g),l.setDefault(t?t.concat(c):c);return new f(l,b,r,d,e,p,m,h,g,q)};f._fromClassBreaksRenderer=function(a,b,c,d,e,h,g,q){var n=a.isMaxInclusive,p=a.visualVariables,m=a.valueExpression,l=a.normalizationField,
r=a.normalizationTotal,t=a.normalizationType,u=z.getVVFlags(p);n=new I.IntervalMatcher(a.field,n,m?{valueExpression:m,spatialReference:h,layer:b}:null,{normalizationField:l,normalizationTotal:r,normalizationType:t});m=new E;l=(l=a.backgroundFillSymbol)&&y.createMeshTemplates([],m,l,c,u,g,!0);r=0;for(t=a.classBreakInfos;r<t.length;r++){var v=t[r],B=y.createMeshTemplates([],m,v.symbol,c,u,g);n.add({min:v.minValue,max:v.maxValue},l?l.concat(B):B)}if(a=a.defaultSymbol)c=y.createMeshTemplates([],m,a,c,
u,g),n.setDefault(l?l.concat(c):c);return new f(n,b,m,d,e,p,u,h,g,q)};return f}();F.default=K});