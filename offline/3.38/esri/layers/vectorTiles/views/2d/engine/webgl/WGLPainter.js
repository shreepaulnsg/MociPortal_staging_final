// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/2d/engine/webgl/WGLPainter","require exports ../../../../core/tsSupport/assignHelper dojo/has ../../../../core/libs/gl-matrix/mat4 ./enums ./GeometryUtils ./MaterialManager ./Utils ./brushes/WGLBrushInfo ./brushes/WGLBrushStencil ./brushes/WGLGeometryBrushFill ./brushes/WGLGeometryBrushLabel ./brushes/WGLGeometryBrushLine ./brushes/WGLGeometryBrushMarker ./brushes/WGLGeometryBrushText ./painter/WGLHighlightPainter ./../../../webgl/FramebufferObject".split(" "),
function(r,t,w,x,l,g,y,z,u,A,B,C,D,E,F,G,H,I){Object.defineProperty(t,"__esModule",{value:!0});r=function(){function d(){this._initialized=!1}d.prototype.registerPass=function(a,c){this._initialize();for(var b=0;b<c.length;b++)this._passMap.set(c[b],a);return this};d.prototype.getPaintPassTs=function(a){this._initialize();return this._passMap.has(a)?[this._passMap.get(a)]:[]};d.prototype._initialize=function(){this._initialized||(this._passMap=new Map,this._initialized=!0)};return d}();t.WGLPainterOptions=
r;var v=new Uint8Array(4*u.C_HITTEST_SEARCH_SIZE*u.C_HITTEST_SEARCH_SIZE),J=new Uint32Array(v.buffer);r=function(){function d(){this._hlPainter=new H;this._extrudeMatrix=new Float32Array(16);this._extrudeNoRotationMatrix=new Float32Array(16);this._extrudeRotateVector=new Float32Array([0,0,1]);this._extrudeScaleVector=new Float32Array([1,1,1]);this._state={rotation:0,width:0,height:0};this._cachedRotation=this._cachedHeight=this._cachedWidth=0;this.materialManager=new z}d.allGeometryPhases=function(){return[g.WGLDrawPhase.FILL,
g.WGLDrawPhase.LINE,g.WGLDrawPhase.MARKER,g.WGLDrawPhase.TEXT]};d.toWGLDrawPhases=function(a){for(var c=[],b,e=0;e<g.WGLDrawPhase.NUM_DRAW_PHASES;e++)b=1<<e,b&a&&c.push(b);return c};Object.defineProperty(d.prototype,"extrudeMatrix",{get:function(){return this._extrudeMatrix},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"extrudeNoRotationMatrix",{get:function(){return this._extrudeNoRotationMatrix},enumerable:!0,configurable:!0});d.prototype.dispose=function(){this.materialManager.dispose();
this.textureManager=null;this._hlPainter&&(this._hlPainter.dispose(),this._hlPainter=null);this._hittestFBO&&(this._hittestFBO.dispose(),this._hittestFBO=null);this._passes&&(this._passes.forEach(function(a){return a.dispose()}),this._passes.clear());this._brushes&&(this._brushes.forEach(function(a){return a.forEach(function(c){return c.dispose()})}),this._brushes.clear())};d.prototype.initialize=function(a){this.materialManager.initialize(a)};d.prototype.update=function(a,c){this._state=a;if(this._state.width!==
this._cachedWidth||this._state.height!==this._cachedHeight||this._state.rotation!==this._cachedRotation)this._extrudeScaleVector[0]=2/a.width,this._extrudeScaleVector[1]=-2/a.height,l.identity(this._extrudeMatrix),l.rotate(this._extrudeMatrix,this._extrudeMatrix,-a.rotation*y.C_DEG_TO_RAD,this._extrudeRotateVector),l.scale(this._extrudeMatrix,this._extrudeMatrix,this._extrudeScaleVector),l.transpose(this._extrudeMatrix,this._extrudeMatrix),l.identity(this._extrudeNoRotationMatrix),l.scale(this._extrudeNoRotationMatrix,
this._extrudeNoRotationMatrix,this._extrudeScaleVector),l.transpose(this._extrudeNoRotationMatrix,this._extrudeNoRotationMatrix),this._cachedWidth=this._state.width,this._cachedHeight=this._state.height,this._cachedRotation=this._state.rotation};d.prototype.getBrushes=function(a){if(!this._brushes){var c=new C.default,b=new F.default,e=new E.default,h=new G.default,f=new D.default,k=new A.default,m=new B.default;this._brushes=new Map;this._brushes.set(g.WGLDrawPhase.FILL,[c]);this._brushes.set(g.WGLDrawPhase.MARKER,
[b]);this._brushes.set(g.WGLDrawPhase.LINE,[e]);this._brushes.set(g.WGLDrawPhase.TEXT,[h]);this._brushes.set(g.WGLDrawPhase.LABEL,[f]);this._brushes.set(g.WGLDrawPhase.LABEL_ALPHA,[f]);this._brushes.set(g.WGLDrawPhase.HITTEST,[c,b,e,h]);this._brushes.set(g.WGLDrawPhase.HIGHLIGHT,[c,b,e,h]);this._brushes.set(g.WGLDrawPhase.CLIP,[m]);this._brushes.set(g.WGLDrawPhase.DEBUG,[k])}if(!this._brushes.has(a))throw Error("WGLPainter: Tried to get brush for unknown phase: "+a);return this._brushes.get(a)};d.prototype.bindTextureManager=
function(a){this.textureManager=a};d.prototype.draw=function(a,c,b,e){b[0]===g.WGLDrawPhase.LABEL_ALPHA&&b[0]===g.WGLDrawPhase.LABEL||this._drawClippingRects(a,c);var h=a.context;h.setBlendingEnabled(!0);h.setStencilWriteMask(0);h.setBlendFunctionSeparate(1,771,1,771);this._drawPhases(a,c,b,e);this._debugTiles(a,c)};d.prototype.setHighlightOptions=function(a){this._hlPainter.setHighlightOptions(a)};d.prototype.highlight=function(a,c){var b=a.context,e=b.getViewport();this._hlPainter.setup(b,e.width,
e.height);this._hlPainter.startMaskDraw(b);this._drawClippingRects(a,c);b.setBlendingEnabled(!0);b.setStencilWriteMask(0);b.setBlendFunctionSeparate(1,771,1,771);this._drawPhases(a,c,[g.WGLDrawPhase.HIGHLIGHT]);this._hlPainter.draw(b)};d.prototype.hitTest=function(a,c){var b=u.C_HITTEST_SEARCH_SIZE,e=[0,0],h=[0,0],f=a.state;f.toMap(e,[0,0]);f.toMap(h,[b,b]);if(0===c.filter(function(p){return!(e[0]>p.bounds[2]||h[0]<p.bounds[0]||e[1]<p.bounds[1]||h[1]>p.bounds[3])}).length)return[];f=a.context;this._hittestFBO||
(this._hittestFBO=I.create(f,{colorTarget:0,depthStencilTarget:3,width:b,height:b}));var k=f.getViewport(),m=f.getBoundFramebufferObject();f.bindFramebuffer(this._hittestFBO);f.setViewport(0,0,b,b);this._drawClippingRects(a,c);var n=f.gl;f.setClearColor(1,1,1,1);f.clear(n.COLOR_BUFFER_BIT);f.setBlendingEnabled(!1);f.setStencilWriteMask(0);this._drawPhases(a,c,[g.WGLDrawPhase.HITTEST]);f.setBlendingEnabled(!0);this._hittestFBO.readPixels(0,0,b,b,6408,5121,v);a=b*b;c=new Set;for(b=0;b<a;b++)n=J[b],
4294967295!==n&&c.add(n);f.bindFramebuffer(m);f.setViewport(k.x,k.y,k.width,k.height);var q=[];c.forEach(function(p){q.push(p)});return q};d.prototype._getPaintPass=function(a){this._passes||(this._passes=new Map);if(!this._passes.has(a))try{this._passes.set(a,new a)}catch(c){throw Error("Tried to instantiate WGLPaintPass with unknown constructor: "+a+",\n"+c);}return this._passes.get(a)};d.prototype._getPaintPasses=function(a,c){var b=this;return c.getPaintPassTs(a).map(function(e){return b._getPaintPass(e)})};
d.prototype._drawPhases=function(a,c,b,e){a.context.setStencilTestEnabled(!0);for(var h=0;h<b.length;h++){var f=b[h],k=e?this._getPaintPasses(f,e):[];f=w({},a,{drawPhase:f});k.forEach(function(q){return q.preRender(a,a.rendererInfo)});for(var m=0,n=c;m<n.length;m++)n[m].doRender(f);k.reverse().forEach(function(q){return q.postRender(a,a.rendererInfo)})}a.context.setStencilTestEnabled(!1)};d.prototype._debugTiles=function(a,c){x("esri-feature-tiles-debug")&&this._drawPhases(a,c,[g.WGLDrawPhase.DEBUG])};
d.prototype._drawClippingRects=function(a,c){if(0!==c.length){var b=a.context;b.setDepthWriteEnabled(!1);b.setDepthTestEnabled(!1);b.setStencilTestEnabled(!0);b.setBlendingEnabled(!1);b.setColorMask(!1,!1,!1,!1);b.setStencilOp(7680,7680,7681);b.setClearStencil(0);b.clear(b.gl.STENCIL_BUFFER_BIT);b.setStencilWriteMask(255);b=0;for(var e=c.length;b<c.length;b++,e--){var h=c[b];h.attached&&(h.stencilRef=e)}this._drawPhases(a,c,[g.WGLDrawPhase.CLIP]);a.context.setColorMask(!0,!0,!0,!0)}};return d}();
t.default=r});