// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/2d/engine/webgl/TextureManager","require exports ../../../../config ../../../../core/Error ../../../../core/Logger ../../../../core/promiseUtils ./CIMSymbolHelper ./fontUtils ./GlyphMosaic ./GlyphSource ./SDFHelper ./SpriteMosaic ./Utils ../../../3d/support/imageUtils ../../../support/screenshotUtils ./SDFConverter".split(" "),function(C,D,r,m,t,k,l,u,v,w,q,x,h,y,z,A){function B(e){if(e.type){switch(h.normalizeSymbolType(e.type)){case "simple-marker":return e.path?
"simple-marker"+e.style+e.path:"simple-marker"+e.style;case "simple-line":return"simple-line"+e.style}if(h.isPictureSymbol(e))return e.url?e.url:e.imageData+(""+e.width+e.height)}return JSON.stringify(e)}var n=t.getLogger("esri.views.2d.engine.webgl.TextureManager");return function(){function e(){this._invalidFontsMap=new Map;this._spriteMosaic=new x(1024,1024,500);this._glyphSource=new w(r.fontsUrl+"/{fontstack}/{range}.pbf");this._glyphMosaic=new v(1024,1024,this._glyphSource);this._sdfConverter=
new A.default(126)}Object.defineProperty(e.prototype,"sprites",{get:function(){return this._spriteMosaic},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"glyphs",{get:function(){return this._glyphMosaic},enumerable:!0,configurable:!0});e.prototype.dispose=function(){this._spriteMosaic.dispose();this._glyphMosaic.dispose();this._rasterizationCanvas=null};e.prototype.rasterizeItem=function(a,b){void 0===b&&(b=null);return a?a.type&&-1!==a.type.toLowerCase().indexOf("3d")?(n.error(new m("mapview-invalid-type",
"Mapviewer does not support 3d symbol type: "+a.type,a)),k.resolve({glyphMosaicItems:[],spriteMosaicItem:null})):!a.type||"text"!==a.type&&"esriTS"!==a.type?this._rasterizeSpriteSymbol(a).then(function(c){return{spriteMosaicItem:c}}):this._rasterizeTextSymbol(a,b).then(function(c){return{glyphMosaicItems:c}}):(n.error(new m("mapview-null-resource","Unable to rasterize null resource")),k.resolve(null))};e.prototype.bindSpritePage=function(a,b,c,d){d||(d=9729);this._spriteMosaic.bind(a,d,b,c)};e.prototype.bindGlyphsPage=
function(a,b,c){this._glyphMosaic.bind(a,9729,b,c)};e.prototype._rasterizeTextSymbol=function(a,b){var c=this,d=u.getFullyQualifiedFontName(a.font);a=this._invalidFontsMap.has(d);return this._glyphMosaic.getGlyphItems(a?"arial-unicode-ms-regular":d,b).catch(function(f){n.error(new m("mapview-invalid-resource","Couldn't find font "+d+". Falling back to Arial Unicode MS Regular"));c._invalidFontsMap.set(d,!0);return c._glyphMosaic.getGlyphItems("arial-unicode-ms-regular",b)})};e.prototype._rasterizeSpriteSymbol=
function(a){var b=this;if(a&&(h.isFillSymbol(a)||h.isLineSymbol(a))&&"style"in a&&("solid"===a.style||"esriSFSSolid"===a.style||"esriSLSSolid"===a.style||"none"===a.style||"esriSFSNull"===a.style||"esriSLSNull"===a.style))return k.resolve(null);var c=B(a);if(this._spriteMosaic.has(c))return k.resolve(this._spriteMosaic.getSpriteItem(c));if("simple-marker"!==a.type&&"esriSMS"!==a.type||!a.path){if(a.url||a.imageData)return y.requestImage(a.imageData?"data:"+a.contentType+";base64,"+a.imageData:a.url).then(function(g){g=
b._rasterizeResource(g);return b._addItemToMosaic(c,g.size,g.anchor,g.image,!h.isMarkerSymbol(a),g.sdf)});var d=this._rasterizeResource(a);return k.resolve(this._addItemToMosaic(c,d.size,d.anchor,d.image,!h.isMarkerSymbol(a),d.sdf))}var f=[126,126],p=this;return this._sdfConverter.draw(a.path).then(function(g){return p._addItemToMosaic(c,f,[0,0],new Uint32Array(g.buffer),!1,!0)})};e.prototype._rasterizeResource=function(a){if(a instanceof HTMLImageElement){this._rasterizationCanvas||(this._rasterizationCanvas=
document.createElement("canvas"));this._rasterizationCanvas.width=a.width;this._rasterizationCanvas.height=a.height;var b=this._rasterizationCanvas.getContext("2d");b.drawImage(a,0,0,a.width,a.height);b=b.getImageData(0,0,a.width,a.height);b=new Uint8Array(b.data);for(var c=void 0,d=0;d<b.length;d+=4)c=b[d+3]/255,b[d]*=c,b[d+1]*=c,b[d+2]*=c;c=a.width;d=a.height;var f=b;if(500<=c||500<=d)f=a.width/a.height,1<f?(c=500,d=Math.round(500/f)):(d=500,c=Math.round(500*f)),f=new Uint8Array(4*c*d),z.resampleHermite(b,
a.width,a.height,new Uint8ClampedArray(f.buffer),c,d,!1);return{size:[c,d],anchor:[0,0],image:new Uint32Array(f.buffer),sdf:!1}}return this._rasterizeJSON(a)};e.prototype._addItemToMosaic=function(a,b,c,d,f,p){return this._spriteMosaic.addSpriteItem(a,b,c,d,f,p)};e.prototype._rasterizeJSON=function(a){this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas"));if("simple-fill"===a.type||"esriSFS"===a.type){var b=l.SymbolHelper.rasterizeSimpleFill(this._rasterizationCanvas,
a.style);a=b[0];var c=b[1];b=b[2];return{size:[c,b],anchor:[0,0],image:new Uint32Array(a.buffer),sdf:!1}}if("simple-line"===a.type||"esriSLS"===a.type)return b=l.SymbolHelper.rasterizeSimpleLine(this._rasterizationCanvas,a.style),a=b[0],c=b[1],b=b[2],{size:[c,b],anchor:[0,0],image:new Uint32Array(a.buffer),sdf:!0};"simple-marker"===a.type||"esriSMS"===a.type?(a=l.CIMSymbolHelper.fromSimpleMarker(a),c=!0):c=q.SDFHelper.checkSDF(a);if(c)return c=(new q.SDFHelper).buildSDF(a),a=c[0],{size:[c[1],c[2]],
anchor:[0,0],image:new Uint32Array(a.buffer),sdf:!0};var d=l.CIMSymbolHelper.rasterize(this._rasterizationCanvas,a);a=d[0];c=d[1];b=d[2];return{size:[c,b],anchor:[d[3],d[4]],image:new Uint32Array(a.buffer),sdf:!1}};return e}()});