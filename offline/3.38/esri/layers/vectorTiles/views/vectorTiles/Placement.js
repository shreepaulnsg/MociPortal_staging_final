// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/vectorTiles/Placement",["require","exports","../2d/engine/webgl/Geometry","./Conflict","./GeometryUtils"],function(N,J,u,E,n){Object.defineProperty(J,"__esModule",{value:!0});N=function(){return function(p,a,f,b,d){void 0===f&&(f=0);void 0===b&&(b=-1);void 0===d&&(d=D);this.x=p;this.y=a;this.angle=f;this.segment=b;this.minzoom=d}}();J.Anchor=N;var R=function(){return function(p,a,f,b,d,e,h){void 0===d&&(d=!1);void 0===e&&(e=D);void 0===h&&(h=n.C_INFINITY);this.anchor=
p;this.labelAngle=a;this.glyphAngle=f;this.page=b;this.upsideDown=d;this.minzoom=e;this.maxzoom=h}}(),S=function(){return function(p,a,f,b,d,e,h,v,y,r){this.tl=p;this.tr=a;this.bl=f;this.br=b;this.mosaicRect=d;this.labelAngle=e;this.anchor=h;this.minzoom=v;this.maxzoom=y;this.page=r}}();J.PlacedSymbol=S;var T=function(){return function(p,a){this.footprint=p;this.shapes=a}}();J.Placement=T;var D=.5;N=function(){function p(){this.mapAngle=0;this._conflictEngine=new E.ConflictEngine}p.prototype.reset=
function(){this._conflictEngine.reset()};p.prototype.setAngle=function(a){this.mapAngle=a;this._conflictEngine.setAngle(a)};p.prototype.getIconPlacement=function(a,f,b,d,e,h,v){var y=b.width/b.pixelRatio,r=b.height/b.pixelRatio;e=h.offset[0]-y/2;var C=h.offset[1]-r/2;y=e+y;r=C+r;var w=b.rect,l=b.sdf?17:2,c=e-l,g=C-l,k=c+w.width/b.pixelRatio,q=g+w.height/b.pixelRatio;b=new u.Point(c,g);l=new u.Point(k,q);q=new u.Point(c,q);g=new u.Point(k,g);k=h.rotate*n.C_DEG_TO_RAD;c=1===h.rotationAlignment;0<=a.segment&&
!c&&(k+=a.angle);if(0!==k){var m=Math.cos(k),z=Math.sin(k);b.rotate(m,z);l.rotate(m,z);q.rotate(m,z);g.rotate(m,z)}m=8*h.padding;z=new u.Point(a.x,a.y);a=new E.Footprint(this.mapAngle,m,c);a.addBox(z,new E.Box(e,C,y,r),d,k,f,D,n.C_INFINITY);f=new S(b,g,q,l,w,0,z,D,n.C_INFINITY,0);f=new T(a,[f]);d=D;h.allowOverlap||(d=this._conflictEngine.getMinZoom(f.footprint,d,v,c));a.minzoom=d;return f};p.prototype.getTextPlacement=function(a,f,b,d,e,h,v,y){for(var r=new u.Point(a.x,a.y),C=v.rotate*n.C_DEG_TO_RAD,
w=0===v.rotationAlignment,l=v.keepUpright,c=D,g=!w,k=g?0:a.angle,q=0<=a.segment&&w,m=new E.Footprint(this.mapAngle,8*v.padding,g),z=[],U=!q,F=Number.POSITIVE_INFINITY,G=Number.NEGATIVE_INFINITY,K=F,L=G,ha=q?l:w&&l,V,W=0;W<d.length;W++){var A=d[W],t=A.glyphMosaicItem;if(t&&!t.rect.isEmpty){var X=t.rect,H=t.metrics,B=t.page;U&&(V&&V!==A.y&&(m.addBox(r,new E.Box(F,K,G,L),e,C,f,D,n.C_INFINITY),F=Number.POSITIVE_INFINITY,G=Number.NEGATIVE_INFINITY,K=F,L=G),V=A.y);var I=[];if(q){if(t=(b.x+A.x+H.left-4+
.5*t.metrics.width)*e,c=this._placeGlyph(a,c,t,h,a.segment,1,B,I),l&&(c=this._placeGlyph(a,c,t,h,a.segment,-1,B,I)),2<=c)break}else I.push(new R(r,k,k,B)),w&&l&&I.push(new R(r,k+n.C_PI,k+n.C_PI,B,!0));B=A.x+b.x+H.left;A=A.y+b.y-H.top;t=B+H.width;H=A+H.height;for(var M=new u.Point(B-4,A-4),Y=new u.Point(M.x+X.width,M.y+X.height),ia=new u.Point(M.x,Y.y),ja=new u.Point(Y.x,M.y),Z=0;Z<I.length;Z++){var x=I[Z],ca=M.clone(),da=ia.clone(),ea=ja.clone(),fa=Y.clone(),aa=A,ba=H,O=x.glyphAngle+C;if(0!==O){var P=
Math.cos(O),Q=Math.sin(O);ca.rotate(P,Q);fa.rotate(P,Q);da.rotate(P,Q);ea.rotate(P,Q)}z.push(new S(ca,ea,da,fa,X,x.labelAngle,x.anchor,x.minzoom,x.maxzoom,x.page));if(!ha||this._legible(x.labelAngle))U?(B<F&&(F=B),aa<K&&(K=aa),t>G&&(G=t),ba>L&&(L=ba)):2>x.minzoom&&m.addBox(x.anchor,new E.Box(B,aa,t,ba),e,O,f,x.minzoom,x.maxzoom)}}}if(2<=c)return null;U&&m.addBox(r,new E.Box(F,K,G,L),e,C,f,D,n.C_INFINITY);a=new T(m,z);v.allowOverlap||(c=this._conflictEngine.getMinZoom(a.footprint,c,y,g));m.minzoom=
c;return a};p.prototype.add=function(a){this._conflictEngine.add(a.footprint)};p.prototype._legible=function(a){a=n.radToByte(a);return 65>a||193<=a};p.prototype._placeGlyph=function(a,f,b,d,e,h,v,y){var r=0>h?n.positiveMod(a.angle+n.C_PI,n.C_2PI):a.angle,C=this._legible(r),w=0;0>b&&(h*=-1,b*=-1,w=n.C_PI);0<h&&++e;a=new u.Point(a.x,a.y);var l=d[e],c=n.C_INFINITY;if(d.length<=e)return c;for(;;){var g=l.x-a.x,k=l.y-a.y,q=Math.sqrt(g*g+k*k),m=Math.max(b/q,f);g=n.positiveMod(Math.atan2(k/q,g/q)+w,n.C_2PI);
y.push(new R(a,r,g,v,C,m,c));if(m<=f)return m;a=l.clone();do{e+=h;if(d.length<=e||0>e)return m;l=d[e]}while(a.isEqual(l));c=l.x-a.x;g=l.y-a.y;k=Math.sqrt(c*c+g*g);c*=q/k;g*=q/k;a.x-=c;a.y-=g;c=m}};return p}();J.PlacementEngine=N});