// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/vectorTiles/TileParser","require exports dojo/promise/all ../../core/executeAsync ../../core/pbf ../../core/promiseUtils ../2d/engine/webgl/TileClipper ../2d/tiling/enums ./BackgroundBucket ./CircleBucket ./Feature ./FillBucket ./LineBucket ./SourceLayerData ./SymbolBucket".split(" "),function(ba,ca,Q,J,R,K,L,y,S,T,U,V,W,X,Y){return function(){function m(a,b,f){this._pbfTile=new R(new Uint8Array(a),new DataView(a));this._tile=b;this._connection=f;this._layers=
b.getLayers();f=b.tileKey.split("/").map(parseFloat);var h=f[0];a=f[1];f=f[2];this._level=h;b.refKey&&(b=b.refKey.split("/").map(parseFloat)[0],b=h-b,0<b&&(h=(1<<b)-1,this._tileClipper=new L.TileClipper(b,a&h,f&h)));this._tileClipper||(this._tileClipper=new L.SimpleBuilder)}m.prototype.parse=function(){var a=this,b=this._parseTileData(this._pbfTile),f=this._layers,h=f.length,M=this._level,r=[],t={},N=new Set;for(--h;0<=h;h--){var d=f[h];if(!(d.minzoom&&M<d.minzoom||d.maxzoom&&M>=d.maxzoom||d.layout&&
"none"===d.layout.visibility))if(0===d.type)d=this._createBucket(d),d.layerIndex=h,r.push(d);else{var z=d.sourceLayer,u=b[z];u&&(N.add(z),d=this._createBucket(d))&&(d.layerIndex=h,d.layerExtent=u.extent,(u=t[z])||(u=t[z]=[]),u.push(d))}}var Z=10*this._level,aa=10*(this._level+1),v=[],D=[],A=[],O=[],E=this._tileClipper,F=new Set,G={},H=[];N.forEach(function(e){return H.push(e)});var B=0,w=0,I=H.length;return J(function(){if(a._tile.status===y.TileStatus.INVALID)return!0;switch(B){case 0:if(w<I){var e=
H[w++],q=b[e],g=t[e];if(g&&0!==g.length)for(e=q.getData();e.next(2);){var n=new U(e.getMessage(),q),c=n.values;if(c){var k=c._minzoom;if(k&&k>=aa)continue;if((c=c._maxzoom)&&c<=Z)continue}k=0;for(var p=g;k<p.length;k++)c=p[k],c.pushFeature(n)}}else{q=a._tile;for(e in t)for(g=t[e],n=0;n<g.length;n++)c=g[n],c.hasFeatures()&&(3===c.layer.type?(v.push(c),q.addBucket(c)):c.layer.refLayerId?A.push(c):(D.push(c),O[c.layer.id]=c));B=1;w=0;I=v.length}break;case 1:w<I?v[w++].getResources(E,F,G):B=2}return 2===
B}).then(function(){if(a._tile.status===y.TileStatus.INVALID)return[];var e=[],q=a._tile.getWorkerTileHandler();if(0<F.size){var g=q.fetchSprites(F,a._connection);e.push(g)}for(var n in G)g=G[n],0<g.size&&(g=q.fetchGlyphs(a._tile.tileKey,n,g,a._connection),e.push(g));return Q(e).then(function(c){if(a._tile.status===y.TileStatus.INVALID)return[];var k=0,p=0,C=D.length;return J(function(){if(a._tile.status===y.TileStatus.INVALID)return!0;switch(k){case 0:if(p<C){var l=D[p++];l.processFeatures(E,a._tile);
r.push(l)}else k=1,p=0,C=A.length;break;case 1:for(var x=0;x<A.length;x++){l=A[x];var P=O[l.layer.refLayerId];P&&(P.assignBufferInfo(l),r.push(l))}k=2;p=0;C=v.length;break;case 2:p<C?(l=v[p++],l.processFeatures(E,a._tile),r.push(l)):k=3}return 3===k}).then(function(){r.sort(function(l,x){return l.layerIndex-x.layerIndex});return r})}).catch(function(c){return K.reject(Error(c))})}).catch(function(e){return K.reject(Error(e))})};m.prototype._parseTileData=function(a){for(var b={};a.next();)switch(a.tag()){case 3:var f=
new X(a.getMessage());b[f.name]=f;break;default:a.skip()}return b};m.prototype._createBucket=function(a){switch(a.type){case 0:return this._createBackgroundBucket(a);case 1:return this._createFillBucket(a);case 2:return this._createLineBucket(a);case 4:return this._createCircleBucket(a);case 3:return this._createSymbolBucket(a)}};m.prototype._createBackgroundBucket=function(a){return new S(a,this._level)};m.prototype._createFillBucket=function(a){var b=this._tile;return new V(a,this._level,a.hasDataDrivenFill?
b.fillDDVertexBuffer:b.fillVertexBuffer,b.fillIndexBuffer,a.hasDataDrivenOutline?b.outlineDDVertexBuffer:b.outlineVertexBuffer,b.outlineIndexBuffer)};m.prototype._createLineBucket=function(a){var b=this._tile;return new W(a,this._level,a.hasDataDrivenLine?b.lineDDVertexBuffer:b.lineVertexBuffer,b.lineIndexBuffer)};m.prototype._createCircleBucket=function(a){var b=this._tile;return new T(a,this._level,b.circleVertexBuffer,b.circleIndexBuffer)};m.prototype._createSymbolBucket=function(a){var b=this._tile;
return new Y(a,this._level,a.hasDataDrivenIcon?b.iconDDVertexBuffer:b.iconVertexBuffer,b.iconIndexBuffer,a.hasDataDrivenText?b.textDDVertexBuffer:b.textVertexBuffer,b.textIndexBuffer,b.placementEngine,b.getWorkerTileHandler())};return m}()});