// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/vectorTiles/renderers/SDFRenderer","require exports dojo/has ../../../core/libs/gl-matrix/mat4 ../../../core/libs/gl-matrix/vec3 ../../../core/libs/gl-matrix/vec4 ../GeometryUtils ./rendererUtils ./vtShaderSnippets ../../webgl/ShaderVariations ../../webgl/VertexArrayObject".split(" "),function(S,T,L,l,D,E,F,M,N,O,G){var P=1/65536;return function(){function t(){this._attributeLocations={a_pos:0,a_vertexOffset:1,a_tex:2,a_levelInfo:3};this._attributeLocationsDD=
{a_pos:0,a_vertexOffset:1,a_tex:2,a_levelInfo:3,a_color:4,a_size:5};this._initialized=!1;this._viewProjMat=l.create();this._offsetVector=D.create();this._extrudeMat=l.create();this._haloColor=E.create();this._sdfColor=E.create();this._scaleVec=D.create()}t.prototype.dispose=function(){};t.prototype.render=function(c,e,b,h,u,k,p,d,A,v,B,C,H){var m=this;if(!L("esri-vector-tiles-avoid-text")){this._initialized||this._initialize(c);var Q=F.degToByte(u),w=d.getLayoutValue("text-rotation-alignment",b);
2===w&&(w=1===d.getLayoutValue("symbol-placement",b)?0:1);var I=0===w;w=d.getLayoutValue("text-keep-upright",b)&&I;h=3===h;C=.8*3/C;var R=d.hasDataDrivenTextSize?1:d.getLayoutValue("text-size",b),g=d.hasDataDrivenTextColor?[1,1,1,1]:d.getPaintValue("text-color",b),J=d.hasDataDrivenTextOpacity?1:d.getPaintValue("text-opacity",b),f=g[3]*J*H;this._sdfColor[0]=f*g[0];this._sdfColor[1]=f*g[1];this._sdfColor[2]=f*g[2];this._sdfColor[3]=f;this._glyphTextureSize||(this._glyphTextureSize=new Float32Array([A.width/
4,A.height/4]));g=p.tileTransform.transform;f=d.getPaintValue("text-translate",b);if(0!==f[0]||0!==f[1]){l.copy(this._viewProjMat,p.tileTransform.transform);g=f[0];f=f[1];var q=0,r=0;r=(1<<p.key.level)/Math.pow(2,b)*(p.coordRange/512);if(1===d.getPaintValue("text-translate-anchor",b)){q=-F.C_DEG_TO_RAD*u;u=Math.sin(q);var K=Math.cos(q);q=r*(g*K-f*u);r*=g*u+f*K}else q=r*g,r*=f;this._offsetVector[0]=q;this._offsetVector[1]=r;this._offsetVector[2]=0;l.translate(this._viewProjMat,this._viewProjMat,this._offsetVector);
g=this._viewProjMat}I?l.copy(this._extrudeMat,v):l.copy(this._extrudeMat,B);this._scaleVec[0]=1/24;this._scaleVec[1]=1/24;this._scaleVec[2]=1;l.scale(this._extrudeMat,this._extrudeMat,this._scaleVec);v=d.hasDataDrivenText;if(B=this._getSDFVAO(c,p,v)){c.bindVAO(B);var a=this._shaderVariations.getProgram([v,h],void 0,void 0,v?this._attributeLocationsDD:this._attributeLocations);c.bindProgram(a);a.setUniformMatrix4fv("u_transformMatrix",g);a.setUniformMatrix4fv("u_extrudeMatrix",this._extrudeMat);a.setUniform2fv("u_normalized_origin",
p.tileTransform.displayCoord);a.setUniform1f("u_depth",d.z+P);a.setUniform2fv("u_mosaicSize",this._glyphTextureSize);a.setUniform1f("u_mapRotation",Q);a.setUniform1f("u_keepUpright",w?1:0);a.setUniform1f("u_level",10*b);a.setUniform1f("u_fadeSpeed",10*k.fadeSpeed);a.setUniform1f("u_minfadeLevel",10*k.minfadeLevel);a.setUniform1f("u_maxfadeLevel",10*k.maxfadeLevel);a.setUniform1f("u_fadeChange",10*(b+k.fadeChange));a.setUniform1i("u_texture",0);a.setUniform1f("u_size",R);a.setUniform1f("u_antialiasingWidth",
C);h&&(k=M.int32To4Bytes(e.layerID),a.setUniform4f("u_id",k[0],k[1],k[2],k[3]));e.glyphPerPageElementsMap.forEach(function(y,x){A.bind(c,9729,x,0);var n=d.getPaintValue("text-halo-color",b);x=d.getPaintValue("text-halo-width",b);if(0<n[3]&&0<x){var z=n[3]*J*H;m._haloColor[0]=z*n[0];m._haloColor[1]=z*n[1];m._haloColor[2]=z*n[2];m._haloColor[3]=z;n=3*d.getPaintValue("text-halo-blur",b);x*=3;a.setUniform4fv("u_color",m._haloColor);a.setUniform1f("u_halo",1);a.setUniform1f("u_edgeDistance",x);a.setUniform1f("u_edgeBlur",
n);c.drawElements(4,y[1],5125,12*y[0])}0<m._sdfColor[3]&&(a.setUniform4fv("u_color",m._sdfColor),a.setUniform1f("u_halo",0),a.setUniform1f("u_edgeDistance",0),a.setUniform1f("u_edgeBlur",0),c.drawElements(4,y[1],5125,12*y[0]))});c.bindVAO()}}};t.prototype._initialize=function(c){if(this._initialized)return!0;c=new O("text",["textVS","textFS"],[],N,c);c.addDefine("DD","DD",[!0,!1],"DD");c.addDefine("ID","ID",[!0,!0],"ID");this._shaderVariations=c;this._vertexAttributes={geometry:[{name:"a_pos",count:2,
type:5122,offset:0,stride:16,normalized:!1,divisor:0},{name:"a_vertexOffset",count:2,type:5122,offset:4,stride:16,normalized:!1,divisor:0},{name:"a_tex",count:4,type:5121,offset:8,stride:16,normalized:!1,divisor:0},{name:"a_levelInfo",count:4,type:5121,offset:12,stride:16,normalized:!1,divisor:0}]};this._vertexAttributesDD={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:24,normalized:!1,divisor:0},{name:"a_vertexOffset",count:2,type:5122,offset:4,stride:24,normalized:!1,divisor:0},{name:"a_tex",
count:4,type:5121,offset:8,stride:24,normalized:!1,divisor:0},{name:"a_levelInfo",count:4,type:5121,offset:12,stride:24,normalized:!1,divisor:0},{name:"a_color",count:4,type:5121,offset:16,stride:24,normalized:!0,divisor:0},{name:"a_size",count:1,type:5126,offset:20,stride:24,normalized:!1,divisor:0}]};return this._initialized=!0};t.prototype._getSDFVAO=function(c,e,b){if(b){if(e.textDDVertexArrayObject)return e.textDDVertexArrayObject;b=e.textDDVertexBuffer;var h=e.textIndexBuffer;if(!b||!h)return null;
e.textDDVertexArrayObject=new G(c,this._attributeLocationsDD,this._vertexAttributesDD,{geometry:b},h);return e.textDDVertexArrayObject}if(e.textVertexArrayObject)return e.textVertexArrayObject;b=e.textVertexBuffer;h=e.textIndexBuffer;if(!b||!h)return null;e.textVertexArrayObject=new G(c,this._attributeLocations,this._vertexAttributes,{geometry:b},h);return e.textVertexArrayObject};return t}()});