// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/vectorTiles/SpriteMosaic","require exports ./GeometryUtils ./Rect ./RectangleBinPack ../webgl/Texture".split(" "),function(v,w,r,t,q,u){return function(){function f(a,c,b){void 0===b&&(b=0);this._size=[];this._mosaicsData=[];this._textures=[];this._dirties=[];this._pageHeight=this._pageWidth=this._currentPage=this._maxItemSize=0;this._mosaicRects={};this.pixelRatio=1;(0>=a||0>=c)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!");
this._pageWidth=a;this._pageHeight=c;0<b&&(this._maxItemSize=b);this._binPack=new q(a-4,c-4)}f.prototype.getWidth=function(a){return a>=this._size.length?-1:this._size[a][0]};f.prototype.getHeight=function(a){return a>=this._size.length?-1:this._size[a][1]};f.prototype.setSpriteSource=function(a){this.dispose();this.pixelRatio=a.devicePixelRatio;if(0===this._mosaicsData.length){this._binPack=new q(this._pageWidth-4,this._pageHeight-4);var c=new Uint32Array(Math.floor(this._pageWidth)*Math.floor(this._pageHeight));
this._mosaicsData[0]=c;this._dirties.push(!0);this._size.push([this._pageWidth,this._pageHeight]);this._textures.push(void 0)}this._sprites=a};f.prototype.getSpriteItem=function(a,c){void 0===c&&(c=!1);var b=this._mosaicRects[a];if(b)return b;if(!this._sprites||"loaded"!==this._sprites.loadStatus)return null;b=this._sprites.getSpriteInfo(a);if(!b||!b.width||!b.height||0>b.width||0>b.height)return null;var d=b.width,k=b.height,h=this._allocateImage(d,k),g=h[0],e=h[1];if(0>=g.width)return null;this._copy(g,
b,e,h[2],c);b={rect:g,width:d,height:k,anchorX:0,anchorY:0,sdf:b.sdf,pixelRatio:b.pixelRatio,page:e};return this._mosaicRects[a]=b};f.prototype.preloadSpriteItems=function(){for(var a=0,c=this._sprites.spriteNames;a<c.length;a++)this.getSpriteItem(c[a],!0)};f.prototype.getSpriteItems=function(a){for(var c={},b=0;b<a.length;b++){var d=a[b];c[d]=this.getSpriteItem(d)}return c};f.prototype.getMosaicItemPosition=function(a,c){c=(a=this.getSpriteItem(a,c))&&a.rect;if(!c)return null;c.width=a.width;c.height=
a.height;return{size:[a.width,a.height],tl:[(c.x+2)/this._size[a.page][0],(c.y+2)/this._size[a.page][1]],br:[(c.x+2+a.width)/this._size[a.page][0],(c.y+2+a.height)/this._size[a.page][1]],page:a.page}};f.prototype.bind=function(a,c,b,d){void 0===b&&(b=0);void 0===d&&(d=0);this._textures[b]||(this._textures[b]=new u(a,{pixelFormat:6408,dataType:5121,width:this._size[b][0],height:this._size[b][1]},new Uint8Array(this._mosaicsData[b].buffer)));var k=this._textures[b];k.setSamplingMode(c);this._dirties[b]&&
k.setData(new Uint8Array(this._mosaicsData[b].buffer));a.bindTexture(k,d);this._dirties[b]=!1};f._copyBits=function(a,c,b,d,k,h,g,e,m,n,l){var p=d*c+b;g=e*h+g;if(l)for(g-=h,l=-1;l<=n;l++,p=((l+n)%n+d)*c+b,g+=h)for(e=-1;e<=m;e++)k[g+e]=a[p+(e+m)%m];else for(l=0;l<n;l++){for(e=0;e<m;e++)k[g+e]=a[p+e];p+=c;g+=h}};f.prototype._copy=function(a,c,b,d,k,h){if(this._sprites&&"loaded"===this._sprites.loadStatus&&!(b>=this._mosaicsData.length)){var g=new Uint32Array(h?h.buffer:this._sprites.image.buffer),e=
this._mosaicsData[b];e&&g||console.error("Source or target images are uninitialized!");f._copyBits(g,h?c.width:this._sprites.width,c.x,c.y,e,d[0],a.x+2,a.y+2,c.width,c.height,k);this._dirties[b]=!0}};f.prototype._allocateImage=function(a,c){a+=2;c+=2;var b=Math.max(a,c);if(this._maxItemSize&&this._maxItemSize<b){b=Math.pow(2,Math.ceil(r.log2(a)));var d=Math.pow(2,Math.ceil(r.log2(c)));a=new t(0,0,a,c);this._mosaicsData.push(new Uint32Array(b*d));this._dirties.push(!0);this._size.push([b,d]);this._textures.push(void 0);
return[a,this._mosaicsData.length-1,[b,d]]}b=a%4?4-a%4:4;d=c%4?4-c%4:4;1===b&&(b=5);1===d&&(d=5);b=this._binPack.allocate(a+b,c+d);return 0>=b.width?(this._dirties[this._currentPage]||(this._mosaicsData[this._currentPage]=null),this._currentPage=this._mosaicsData.length,this._mosaicsData.push(new Uint32Array(this._pageWidth*this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0),this._binPack=new q(this._pageWidth-4,this._pageHeight-
4),this._allocateImage(a,c)):[b,this._currentPage,[this._pageWidth,this._pageHeight]]};f.prototype.dispose=function(){this._binPack=null;this._mosaicRects={};for(var a=0,c=this._textures;a<c.length;a++){var b=c[a];b&&b.dispose()}this._textures.length=0};return f}()});