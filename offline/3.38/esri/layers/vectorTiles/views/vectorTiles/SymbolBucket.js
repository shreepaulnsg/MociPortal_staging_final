// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/vectorTiles/SymbolBucket","require exports ../../core/tsSupport/extendsHelper ../../core/tsSupport/decorateHelper dojox/string/BidiEngine ../2d/engine/webgl/Geometry ../2d/engine/webgl/TextShaping ./Bucket ./GeometryUtils ./Placement ./style/StyleLayer".split(" "),function(U,V,O,W,P,F,Q,R,E,K,M){function S(G,v){if(G.iconMosaicItem&&v.iconMosaicItem){if(G.iconMosaicItem.page!==v.iconMosaicItem.page)return G.iconMosaicItem.page<v.iconMosaicItem.page?-1:1}else{if(G.iconMosaicItem&&
!v.iconMosaicItem)return 1;if(!G.iconMosaicItem&&v.iconMosaicItem)return-1}return 0}(function(){return function(){}})();return function(G){function v(a,b,f,c,g,d,e,l){b=G.call(this,a,b)||this;b._markerMap=new Map;b._glyphMap=new Map;b._glyphBufferDataStorage=new Map;b._sdfMarkers=!1;if(a.hasDataDrivenIcon!==f.isDataDriven())throw Error("incompatible icon buffer");if(a.hasDataDrivenText!==g.isDataDriven())throw Error("incompatible text buffer");b._iconVertexBuffer=f;b._iconIndexBuffer=c;b._textVertexBuffer=
g;b._textIndexBuffer=d;b._placementEngine=e;b._workerTileHandler=l;return b}O(v,G);Object.defineProperty(v.prototype,"markerPageMap",{get:function(){return this._markerMap},enumerable:!0,configurable:!0});Object.defineProperty(v.prototype,"glyphsPageMap",{get:function(){return this._glyphMap},enumerable:!0,configurable:!0});Object.defineProperty(v.prototype,"sdfMarker",{get:function(){return this._sdfMarkers},enumerable:!0,configurable:!0});v.prototype.copy=function(a,b,f,c,g){a=new v(this.layer,
this.zoom,a,b,f,c,g,this._workerTileHandler);a.layerIndex=this.layerIndex;a.layerExtent=this.layerExtent;a._iconIndexStart=b.index;a._textIndexStart=c.index;a._iconIndexCount=0;a._textIndexCount=0;a._symbolInstances=this._symbolInstances;a._workerTileHandler=this._workerTileHandler;a._fontArray=this._fontArray;a._textLayout=this._textLayout;a._iconLayout=this._iconLayout;a._isLinePlacement=this._isLinePlacement;a._avoidEdges=this._avoidEdges;return a};v.prototype.getResources=function(a,b,f){var c=
this.layer,g=this.zoom,d=c.hasDataDrivenIcon,e=c.hasDataDrivenText;a&&a.setExtent(this.layerExtent);for(var l=c.getLayoutProperty("icon-image"),h=c.getLayoutProperty("text-field"),t=c.getLayoutValue("text-font",g),m=c.getLayoutValue("text-transform",g),u=[],k=[1,1,1,1],w=1,q=1,n=[1,1,1,1],z=1,r=1,p=0,y=this._features;p<y.length;p++){var x=y[p],B=x.getGeometry(a);if(B&&0!==B.length){var C=void 0;l&&(C=c.getLayoutValue("icon-image",g,x),l.isDataDriven||(C=this._replaceKeys(C,x.values)),C&&b.add(C));
var A=void 0,D=!1;if(h&&(A=c.getLayoutValue("text-field",g,x),h.isDataDriven||(A=this._replaceKeys(A,x.values)),A=A.replace(/\\n/g,"\n"))){switch(m){case 2:A=A.toLowerCase();break;case 1:A=A.toUpperCase()}v._bidiEngine.hasBidiChar(A)&&(D=void 0,D="rtl"===v._bidiEngine.checkContextual(A)?"IDNNN":"ICNNN",A=v._bidiEngine.bidiTransform(A,D,"VLYSN"),D=!0);var H=A.length;if(0<H)for(var I=0,N=t;I<N.length;I++){var J=N[I],L=f[J];L||(L=f[J]=new Set);for(J=0;J<H;J++){var T=A.charCodeAt(J);L.add(T)}}}if(C||
A)H=c.getLayoutValue("icon-size",g,x),I=c.getLayoutValue("text-size",g,x),c.hasDataDrivenIconColor&&(k=c.getPaintValue("icon-color",g,x)),c.hasDataDrivenIconOpacity&&(w=c.getPaintValue("icon-opacity",g,x)),c.hasDataDrivenIconSize&&(q=H),c.hasDataDrivenTextColor&&(n=c.getPaintValue("text-color",g,x)),c.hasDataDrivenTextOpacity&&(z=c.getPaintValue("text-opacity",g,x)),c.hasDataDrivenTextSize&&(r=I),x={sprite:C,label:A,rtl:D,type:x.type,geometry:B,iconSize:H,iconRotate:c.getLayoutValue("icon-rotate",
g,x),ddIconValues:d?{color:k,opacity:w,size:q}:null,textSize:I,textRotate:c.getLayoutValue("text-rotate",g,x),ddTextValues:e?{color:n,opacity:z,size:r}:null},u.push(x)}}this._symbolFeatures=u};v.prototype.processFeatures=function(a,b){a&&a.setExtent(this.layerExtent);var f=this.layer,c=this.zoom;b=this._isLinePlacement=1===f.getLayoutValue("symbol-placement",c);a=this._avoidEdges=f.getLayoutValue("symbol-avoid-edges",c)&&!b;var g=8*f.getLayoutValue("symbol-spacing",c),d=f.getLayoutProperty("icon-image"),
e=f.getLayoutProperty("text-field"),l=this._workerTileHandler;if(d){this._iconLayout=new M.IconLayout(f,c,b);var h=l.getSpriteItems();var t=this._getTranslate(!0)}if(e){var m=this._textLayout=new M.TextLayout(f,c,b);this._fontArray=m.fontArray;var u=.5;switch(m.anchor){case 5:case 1:case 7:u=0;break;case 6:case 2:case 8:u=1}var k=.5;switch(m.anchor){case 5:case 3:case 6:k=0;break;case 7:case 4:case 8:k=1}f=.5;switch(m.justify){case 0:f=0;break;case 2:f=1}c=24*m.letterSpacing;d=b?0:24*m.maxWidth;e=
24*m.lineHeight;var w=[24*m.offset[0],24*m.offset[1]];m=this._fontArray.map(function(H){return l.getGlyphItems(H)});k=new Q(m,d,e,c,w,u,k,f);u=this._getTranslate(!1)}this._iconIndexStart=this._iconIndexBuffer.index;this._textIndexStart=this._textIndexBuffer.index;this._textIndexCount=this._iconIndexCount=0;this._markerMap.clear();this._glyphMap.clear();this._symbolInstances=f=[];c=this._textLayout;d=1;c&&c.size&&(d=c.size/24);e=c?c.maxAngle*E.C_DEG_TO_RAD:0;m=c?8*c.size:0;w=0;for(var q=this._symbolFeatures;w<
q.length;w++){var n=q[w],z=void 0;n.sprite&&(z=h[n.sprite])&&z.sdf&&(this._sdfMarkers=!0);var r=void 0,p=n.label,y=0;if(p&&(r=k.getShaping(p,n.rtl))&&0<r.length){y=1E30;p=-1E30;for(var x=0,B=r;x<B.length;x++){var C=B[x];y=Math.min(y,C.x);p=Math.max(p,C.x)}y=(p-y+48)*d*8}p=0;for(x=n.geometry;p<x.length;p++){B=x[p];var A=void 0;b?(r&&0<r.length&&c&&c.size&&v._smoothVertices(B,8*c.size*(2+Math.min(2,4*Math.abs(c.offset[1])))),A=v._findAnchors(B,g,y)):A=3===n.type?v._findCentroid(B):[new K.Anchor(B[0].x,
B[0].y)];for(C=0;C<A.length;C++){var D=A[C];0>D.x||4096<D.x||0>D.y||4096<D.y||b&&0<y&&0===c.rotationAlignment&&!v._honorsTextMaxAngle(B,D,y,e,m)||f.push({shaping:r,line:B,iconMosaicItem:z,anchor:D,iconSize:n.iconSize,iconRotate:n.iconRotate,ddIconValues:n.ddIconValues,textSize:n.textSize,textRotate:n.textRotate,ddTextValues:n.ddTextValues})}}}f.sort(S);for(h=0;h<f.length;h++)this._processFeature(f[h],t,u,a);this._addPlacedGlyphs()};v.prototype.updateSymbols=function(){this._iconIndexStart=this._iconIndexBuffer.index;
this._textIndexStart=this._textIndexBuffer.index;this._textIndexCount=this._iconIndexCount=0;this._markerMap.clear();this._glyphMap.clear();var a=this._avoidEdges,b=this.layer,f;b.getLayoutProperty("icon-image")&&(f=this._getTranslate(!0));var c;b.getLayoutProperty("text-field")&&(c=this._getTranslate(!1));b=0;for(var g=this._symbolInstances;b<g.length;b++)this._processFeature(g[b],f,c,a);this._addPlacedGlyphs()};v.prototype._getTranslate=function(a){var b=this.layer.getPaintValue(a?"icon-translate":
"text-translate",this.zoom);if(0!==b[0]||0!==b[1]){var f=this._placementEngine.mapAngle;return 0!==f&&0===this.layer.getPaintValue(a?"icon-translate-anchor":"text-translate-anchor",this.zoom)?(a=Math.sin(f),f=Math.cos(f),[8*(b[0]*f-b[1]*a),8*(b[0]*a+b[1]*f)]):[8*b[0],8*b[1]]}};v.prototype._replaceKeys=function(a,b){return a.replace(/{([^{}]+)}/g,function(f,c){return c in b?b[c]:""})};v.prototype._processFeature=function(a,b,f,c){var g=a.line,d=a.iconMosaicItem,e=a.shaping,l=a.anchor,h=this._iconLayout,
t=h&&!!d,m=!0,u=1;t&&(h.size=a.iconSize,h.rotate=a.iconRotate,u=8*h.size,m=h.optional||!d);var k=this._textLayout,w=k&&e&&0<e.length;var q=1;var n=!0;w&&(k.size=a.textSize,k.rotate=a.textRotate,q=k.size/24,q*=8,n=k.optional||!e||0===e.length);var z=new F.Point(0,-17);if(t){var r=this._placementEngine.getIconPlacement(l,b,d,u,g,h,c);l.minzoom>r.footprint.minzoom&&(r.footprint.minzoom=l.minzoom);r.footprint.minzoom===E.C_INFINITY&&(r=null)}if(r||m){var p;w&&(p=this._placementEngine.getTextPlacement(l,
f,z,e,q,g,k,c))&&(l.minzoom>p.footprint.minzoom&&(p.footprint.minzoom=l.minzoom),p.footprint.minzoom===E.C_INFINITY&&(p=null));if(p||n)r&&p||(n||m?n||p?m||r||(p=null):r=null:p=r=null),r&&p&&!n&&!m&&(b=Math.max(r.footprint.minzoom,p.footprint.minzoom),r.footprint.minzoom=b,p.footprint.minzoom=b),p&&(k.ignorePlacement||this._placementEngine.add(p),this._storePlacedGlyphs(p.shapes,p.footprint.minzoom,this.zoom,a.ddTextValues)),r&&(h.ignorePlacement||this._placementEngine.add(r),this._addPlacedIcons(r.shapes,
r.footprint.minzoom,this.zoom,d.page,a.ddIconValues))}};v.prototype._addPlacedIcons=function(a,b,f,c,g){b=Math.max(f+E.log2(b),0);for(var d=this._iconVertexBuffer,e=this._iconIndexBuffer,l=0;l<a.length;l++){var h=a[l],t=Math.max(f+E.log2(h.minzoom),b),m=Math.min(f+E.log2(h.maxzoom),25);if(!(m<=t)){var u=h.tl,k=h.tr,w=h.bl,q=h.br,n=h.mosaicRect,z=h.labelAngle;h=h.anchor;var r=d.index,p=n.x,y=n.y,x=p+n.width;n=y+n.height;d.add(h.x,h.y,u.x,u.y,p,y,z,t,m,b,g);d.add(h.x,h.y,k.x,k.y,x,y,z,t,m,b,g);d.add(h.x,
h.y,w.x,w.y,p,n,z,t,m,b,g);d.add(h.x,h.y,q.x,q.y,x,n,z,t,m,b,g);e.add(r+0,r+1,r+2);e.add(r+1,r+2,r+3);this._markerMap.has(c)?this._markerMap.get(c)[1]+=6:this._markerMap.set(c,[this._iconIndexStart+this._iconIndexCount,6]);this._iconIndexCount+=2}}};v.prototype._addPlacedGlyphs=function(){var a=this,b=this._textVertexBuffer,f=this._textIndexBuffer;this._glyphBufferDataStorage.forEach(function(c,g){for(var d=0;d<c.length;d++){var e=c[d],l=b.index;b.add(e.glyphAnchor[0],e.glyphAnchor[1],e.tl[0],e.tl[1],
e.xmin,e.ymin,e.labelAngle,e.minLod,e.maxLod,e.placementLod,e.ddValues);b.add(e.glyphAnchor[0],e.glyphAnchor[1],e.tr[0],e.tr[1],e.xmax,e.ymin,e.labelAngle,e.minLod,e.maxLod,e.placementLod,e.ddValues);b.add(e.glyphAnchor[0],e.glyphAnchor[1],e.bl[0],e.bl[1],e.xmin,e.ymax,e.labelAngle,e.minLod,e.maxLod,e.placementLod,e.ddValues);b.add(e.glyphAnchor[0],e.glyphAnchor[1],e.br[0],e.br[1],e.xmax,e.ymax,e.labelAngle,e.minLod,e.maxLod,e.placementLod,e.ddValues);f.add(l+0,l+1,l+2);f.add(l+1,l+2,l+3);a._glyphMap.has(g)?
a._glyphMap.get(g)[1]+=6:a._glyphMap.set(g,[a._textIndexStart+a._textIndexCount,6]);a._textIndexCount+=2}});this._glyphBufferDataStorage.clear()};v.prototype._storePlacedGlyphs=function(a,b,f,c){b=Math.max(f+E.log2(b),0);for(var g=0;g<a.length;g++){var d=a[g],e=Math.max(f+E.log2(d.minzoom),b),l=Math.min(f+E.log2(d.maxzoom),25);if(!(l<=e)){var h=d.tl,t=d.tr,m=d.bl,u=d.br,k=d.labelAngle,w=d.anchor,q=d.mosaicRect;this._glyphBufferDataStorage.has(d.page)||this._glyphBufferDataStorage.set(d.page,[]);this._glyphBufferDataStorage.get(d.page).push({glyphAnchor:[w.x,
w.y],tl:[h.x,h.y],tr:[t.x,t.y],bl:[m.x,m.y],br:[u.x,u.y],xmin:q.x,ymin:q.y,xmax:q.x+q.width,ymax:q.y+q.height,labelAngle:k,minLod:e,maxLod:l,placementLod:b,ddValues:c})}}};v._findAnchors=function(a,b,f){b+=f;for(var c=0,g=a.length-1,d=0;d<g;d++)c+=F.Point.distance(a[d],a[d+1]);d=.5*(f||b);if(c<=d)return[];f=d/c;b=c/Math.max(Math.round(c/b),1);c=0;g=-b/2;var e=[],l=a.length-1;for(d=0;d<l;d++){for(var h=a[d],t=a[d+1],m=t.x-h.x,u=t.y-h.y,k=Math.sqrt(m*m+u*u),w=void 0;g+b<c+k;){g+=b;var q=(g-c)/k,n=E.interpolate(h.x,
t.x,q);q=E.interpolate(h.y,t.y,q);void 0===w&&(w=Math.atan2(u,m));e.push(new K.Anchor(n,q,w,d,f))}c+=k}return e};v._deviation=function(a,b,f){return Math.atan2((b.x-a.x)*(f.y-b.y)-(b.y-a.y)*(f.x-b.x),(b.x-a.x)*(f.x-b.x)+(b.y-a.y)*(f.y-b.y))};v._honorsTextMaxAngle=function(a,b,f,c,g){var d=0;f/=2;for(var e=new F.Point(b.x,b.y),l=b.segment+1;d>-f;){--l;if(0>l)return!1;d-=F.Point.distance(a[l],e);e=a[l]}d+=F.Point.distance(a[l],a[l+1]);b=[];e=0;for(var h=a.length;d<f;){var t=a[l],m=void 0;do{++l;if(l===
h)return!1;m=a[l]}while(m.isEqual(t));var u=l,k=void 0;do{++u;if(u===h)return!1;k=a[u]}while(k.isEqual(m));t=this._deviation(t,m,k);b.push({deviation:t,distToAnchor:d});for(e+=t;d-b[0].distToAnchor>g;)e-=b.shift().deviation;if(Math.abs(e)>c)return!1;d+=F.Point.distance(m,k)}return!0};v._smoothVertices=function(a,b){if(!(0>=b)){var f=a.length;if(!(3>f)){var c=[],g=0;c.push(0);for(var d=1;d<f;d++)g+=F.Point.distance(a[d],a[d-1]),c.push(g);b=Math.min(b,.2*g);g=[];g.push(a[0].x);g.push(a[0].y);var e=
a[f-1].x,l=a[f-1].y;d=F.Point.sub(a[0],a[1]);d.normalize();a[0].x+=b*d.x;a[0].y+=b*d.y;d.assignSub(a[f-1],a[f-2]);d.normalize();a[f-1].x+=b*d.x;a[f-1].y+=b*d.y;for(d=1;d<f;d++)c[d]+=b;c[f-1]+=b;var h=.5*b;for(d=1;d<f-1;d++){for(var t=0,m=0,u=0,k=d-1;0<=k&&!(c[k+1]<c[d]-h);k--){var w=h+c[k+1]-c[d],q=c[k+1]-c[k],n=c[d]-c[k]<h?1:w/q;if(1E-6>Math.abs(n))break;var z=n*n,r=n*w-.5*z*q,p=n*q/b,y=a[k+1],x=a[k].x-y.x,B=a[k].y-y.y;t+=p/r*(y.x*n*w+.5*z*(w*x-q*y.x)-z*n*q*x/3);m+=p/r*(y.y*n*w+.5*z*(w*B-q*y.y)-
z*n*q*B/3);u+=p}for(k=d+1;k<f&&!(c[k-1]>c[d]+h);k++){w=h-c[k-1]+c[d];q=c[k]-c[k-1];n=c[k]-c[d]<h?1:w/q;if(1E-6>Math.abs(n))break;z=n*n;r=n*w-.5*z*q;p=n*q/b;y=a[k-1];x=a[k].x-y.x;B=a[k].y-y.y;t+=p/r*(y.x*n*w+.5*z*(w*x-q*y.x)-z*n*q*x/3);m+=p/r*(y.y*n*w+.5*z*(w*B-q*y.y)-z*n*q*B/3);u+=p}g.push(t/u);g.push(m/u)}g.push(e);g.push(l);for(k=d=0;d<f;d++)a[d].x=g[k++],a[d].y=g[k++]}}};v._findCentroid=function(a){var b=a.length-1,f=0,c=0,g=0,d=a[0].x,e=a[0].y;4096<d&&(d=4096);0>d&&(d=0);4096<e&&(e=4096);0>e&&
(e=0);for(var l=1;l<b;l++){var h=a[l].x,t=a[l].y,m=a[l+1].x,u=a[l+1].y;4096<h&&(h=4096);0>h&&(h=0);4096<t&&(t=4096);0>t&&(t=0);4096<m&&(m=4096);0>m&&(m=0);4096<u&&(u=4096);0>u&&(u=0);var k=(h-d)*(u-e)-(m-d)*(t-e);f+=k*(d+h+m);c+=k*(e+t+u);g+=k}f/=3*g;c/=3*g;return isNaN(f)||isNaN(c)?[]:[new K.Anchor(f,c)]};v._bidiEngine=new P;return v}(R)});