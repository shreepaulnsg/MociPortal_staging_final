// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/vectorTiles/FillBucket","require exports ../../core/tsSupport/extendsHelper ../../core/tsSupport/decorateHelper ../../core/ArrayPool ../../core/libs/earcut/earcut ../2d/engine/webgl/Geometry ./Bucket".split(" "),function(F,G,C,H,A,D,y,E){return function(B){function r(b,a,c,e,l,g){a=B.call(this,b,a)||this;if(b.hasDataDrivenFill!==c.isDataDriven())throw Error("incompatible fill buffer");if(b.hasDataDrivenOutline!==l.isDataDriven())throw Error("incompatible outline buffer");
a._fillVertexBuffer=c;a._fillIndexBuffer=e;a._outlineVertexBuffer=l;a._outlineIndexBuffer=g;return a}C(r,B);Object.defineProperty(r.prototype,"fillIndexStart",{get:function(){return this._fillIndexStart},enumerable:!0,configurable:!0});Object.defineProperty(r.prototype,"fillIndexCount",{get:function(){return this._fillIndexCount},enumerable:!0,configurable:!0});Object.defineProperty(r.prototype,"outlineIndexStart",{get:function(){return this._outlineIndexStart},enumerable:!0,configurable:!0});Object.defineProperty(r.prototype,
"outlineIndexCount",{get:function(){return this._outlineIndexCount},enumerable:!0,configurable:!0});r.prototype.assignBufferInfo=function(b){b._fillIndexStart=this._fillIndexStart;b._fillIndexCount=this._fillIndexCount;b.layer.getPaintProperty("fill-outline-color")?(b._outlineIndexStart=this._outlineIndexStart,b._outlineIndexCount=this._outlineIndexCount):(b._outlineIndexStart=0,b._outlineIndexCount=0)};r.prototype.processFeatures=function(b,a){this._fillIndexStart=this._fillIndexBuffer.index;this._fillIndexCount=
0;this._outlineIndexStart=this._outlineIndexBuffer.index;this._outlineIndexCount=0;a=this.layer;var c=this.zoom,e=a.hasDataDrivenFill,l=a.hasDataDrivenOutline;b&&b.setExtent(this.layerExtent);var g=a.getPaintValue("fill-pattern",c),d=a.getPaintValue("fill-antialias",c)&&void 0===g,m=[1,1,1,1],p=[1,1,1,1],k=1;if(a.outlineUsesFillColor){if(d&&!a.hasDataDrivenOpacity){var f=a.getPaintValue("fill-opacity",c),h=a.getPaintValue("fill-opacity",c+1);1>f&&1>h&&(d=!1)}d&&!a.hasDataDrivenColor&&(f=a.getPaintValue("fill-color",
c),h=a.getPaintValue("fill-color",c+1),1>f[3]&&1>h[3]&&(d=!1))}f=0;for(h=this._features;f<h.length;f++){var q=h[f];!g&&a.hasDataDrivenColor&&(m=a.getPaintValue("fill-color",c,q));a.hasDataDrivenOpacity&&(k=a.getPaintValue("fill-opacity",c,q));!g&&a.hasDataDrivenOutlineColor&&(p=a.getPaintValue("fill-outline-color",c,q));var t=void 0;e&&(t={color:m,opacity:k});var x=void 0;l&&(x={color:a.outlineUsesFillColor?m:p,opacity:k});q=q.getGeometry(b);this._processFeature(q,d,a.outlineUsesFillColor,t,x)}};
r.prototype._processFeature=function(b,a,c,e,l){if(b){var g=b.length;if(a&&(!c||!l||1===l.color[3]*l.opacity))for(a=0;a<g;a++)this._processOutline(b[a],l);for(a=0;a<g;a++)if(l=r._area(b[a]),128<l){void 0!==d&&this._processFill(b,d,e);var d=[a]}else-128>l&&void 0!==d&&d.push(a);void 0!==d&&this._processFill(b,d,e)}};r.prototype._processOutline=function(b,a){var c=this._outlineVertexBuffer,e=this._outlineIndexBuffer,l=e.index,g,d=new y.Point(0,0),m=new y.Point(0,0),p=new y.Point(0,0),k=-1,f=-1,h=-1,
q=-1,t=-1,x=!1,u=b.length;if(!(2>u)){var w=b[0];for(g=b[u-1];u&&g.isEqual(w);)--u,g=b[u-1];if(!(2>u-0)){for(w=0;w<u;++w){if(0===w){g=b[u-1];var n=b[0];var z=b[1];d.assignSub(n,g);d.normalize();d.rightPerpendicular()}else g=n,n=z,z=w!==u-1?b[w+1]:b[0],d.assign(m);g=this._isClipEdge(g,n);-1===q&&(x=g);m.assignSub(z,n);m.normalize();m.rightPerpendicular();h=d.x*m.y-d.y*m.x;p.assignAdd(d,m);p.normalize();var v=-p.x*-d.x+-p.y*-d.y;v=Math.abs(0!==v?1/v:1);8<v&&(v=8);0<=h?(h=c.add(n.x,n.y,d.x,d.y,0,1,a),
-1===q&&(q=h),0<=k&&0<=f&&0<=h&&!g&&e.add(k,f,h),f=c.add(n.x,n.y,v*-p.x,v*-p.y,0,-1,a),-1===t&&(t=f),0<=k&&0<=f&&0<=h&&!g&&e.add(k,f,h),k=f,f=h,h=c.add(n.x,n.y,p.x,p.y,0,1,a),0<=k&&0<=f&&0<=h&&!g&&e.add(k,f,h),f=c.add(n.x,n.y,m.x,m.y,0,1,a)):(h=c.add(n.x,n.y,v*p.x,v*p.y,0,1,a),-1===q&&(q=h),0<=k&&0<=f&&0<=h&&!g&&e.add(k,f,h),f=c.add(n.x,n.y,-d.x,-d.y,0,-1,a),-1===t&&(t=f),0<=k&&0<=f&&0<=h&&!g&&e.add(k,f,h),k=f,f=h,h=c.add(n.x,n.y,-p.x,-p.y,0,-1,a),0<=k&&0<=f&&0<=h&&!g&&e.add(k,f,h),k=c.add(n.x,n.y,
-m.x,-m.y,0,-1,a));0<=k&&0<=f&&0<=h&&!g&&e.add(k,f,h)}0<=k&&0<=f&&0<=q&&!x&&e.add(k,f,q);0<=k&&0<=q&&0<=t&&!x&&e.add(k,t,q);this._outlineIndexCount+=3*(e.index-l)}}};r.prototype._processFill=function(b,a,c){var e;1<a.length&&(e=[]);for(var l=0,g=0;g<a.length;g++){var d=a[g];0!==l&&e.push(l);l+=b[d].length}g=2*l;l=A.acquire();for(var m=0;m<a.length;m++){d=a[m];d=b[d];for(var p=d.length,k=0;k<p;++k)l.push(d[k].x),l.push(d[k].y)}b=D(l,e,2);a=b.length;if(0<a){e=this._fillVertexBuffer.index;for(m=0;m<
g;)this._fillVertexBuffer.add(l[m++],l[m++],c);for(c=0;c<a;)this._fillIndexBuffer.add(e+b[c++],e+b[c++],e+b[c++]);this._fillIndexCount+=a}A.release(l)};r.prototype._isClipEdge=function(b,a){return b.x===a.x?-64>=b.x||4160<=b.x:b.y===a.y?-64>=b.y||4160<=b.y:!1};r._area=function(b){for(var a=0,c=b.length-1,e=0;e<c;e++)a+=(b[e].x-b[e+1].x)*(b[e].y+b[e+1].y);a+=(b[c].x-b[0].x)*(b[c].y+b[0].y);return.5*a};return r}(E)});