// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/vectorTiles/LineBucket","require exports ../../core/tsSupport/extendsHelper ../../core/tsSupport/decorateHelper ../2d/engine/webgl/LineTess ./Bucket ./style/StyleLayer".split(" "),function(y,z,u,A,k,v,w){var p=new k.Tessellator({distanceAlongCorrection:!0});return function(t){function n(b,a,c,d){a=t.call(this,b,a)||this;a.extrudeVectorsDoubleBuffer=[k.allocExtrudeVectors(),k.allocExtrudeVectors()];a.firstExtrudeVectors=k.allocExtrudeVectors();a.recycledTriangleBridge=
k.allocTriangles(20);a.recycledTrianglePie=k.allocTriangles(20);if(b.hasDataDrivenLine!==c.isDataDriven())throw Error("incompatible line buffer");a._lineVertexBuffer=c;a._lineIndexBuffer=d;return a}u(n,t);Object.defineProperty(n.prototype,"lineIndexStart",{get:function(){return this._lineIndexStart},enumerable:!0,configurable:!0});Object.defineProperty(n.prototype,"lineIndexCount",{get:function(){return this._lineIndexCount},enumerable:!0,configurable:!0});n.prototype.assignBufferInfo=function(b){b._lineIndexStart=
this._lineIndexStart;b._lineIndexCount=this._lineIndexCount};n.prototype.processFeatures=function(b,a){this._lineIndexStart=this._lineIndexBuffer.index;this._lineIndexCount=0;a=this.layer;var c=this.zoom,d=a.hasDataDrivenLine;b&&b.setExtent(this.layerExtent);for(var e=a.getPaintValue("line-pattern",c),f=[1,1,1,1],g=1,h=1,m=0,l=this._features;m<l.length;m++){var q=l[m],x=new w.LineLayout(a,c,q);!e&&a.hasDataDrivenColor&&(f=a.getPaintValue("line-color",c,q));a.hasDataDrivenOpacity&&(g=a.getPaintValue("line-opacity",
c,q));a.hasDataDrivenWidth&&(h=a.getPaintValue("line-width",c,q));var r=void 0;if(d&&(r={color:f,opacity:g,size:Math.max(Math.min(h,256),0)},0>=r.size||0>=r.opacity||0>=r.color[3]))continue;q=q.getGeometry(b);this._processFeature(x,q,r)}};n.prototype._processFeature=function(b,a,c){if(a)for(var d=a.length,e=0;e<d;e++)this._processGeometry(a[e],b,c)};n.prototype._processGeometry=function(b,a,c){if(!(2>b.length)){var d=b[0],e=b[b.length-1],f=e.x-d.x;e=e.y-d.y;d=1E-6>f*f+e*e;for(var g=b[0],h=1;h<b.length;)f=
b[h].x-g.x,e=b[h].y-g.y,1E-6>f*f+e*e?b.splice(h,1):(g=b[h],++h);if(!(2>b.length)){this.vertices=b;this.verticesLen=b.length;this.isClosed=d;this.cap=a.cap;this.join=a.join;this.almostParallelRads=.05;this.veryShallowRads=.1;this.miterSafeRads=k.MITER_SAFE_RADS;this.miterLimitMag=Math.min(a.miterLimit,k.SYSTEM_MAG_LIMIT);this.roundLimitRads=Math.min(a.roundLimit,.5);this.newRoundJoinsSafeRads=2.3;a=this._lineIndexBuffer.index;f=0;var m=void 0;e=this.verticesLen;for(g=0;g<e;++g){h=b[g];var l=b[(g+e-
1)%e],q=d&&this._isClipEdge(l,h);l=m===this.extrudeVectorsDoubleBuffer[g%2]?this.extrudeVectorsDoubleBuffer[(g+1)%2]:this.extrudeVectorsDoubleBuffer[g%2];g<e-1||!d||this.hasPattern?(this._computeExtrudeVectors(l,g),this._writeGPUVertices(h.x,h.y,f,l,c),!l.capCenter||d&&g===e-1||this._writeGPUPieElements(l,q),d&&0===g&&!this.hasPattern&&k.copyExtrudeVectors(this.firstExtrudeVectors,l)):k.copyExtrudeVectors(l,this.firstExtrudeVectors);m&&this._writeGPUBridgeElements(m,l,q);g<e-1&&(m=b[g+1],h=k.length([m.x-
h.x,m.y-h.y]),f+=h);m=l}this._lineIndexCount+=3*(this._lineIndexBuffer.index-a)}}};n.prototype._computeExtrudeVectors=function(b,a){var c=this.vertices,d=this.verticesLen,e=this.isClosed,f=c[a],g=[void 0,void 0],h=[void 0,void 0];if(0<a&&a<d-1){var m=c[(a+d-1)%d],l=c[(a+1)%d];k.normalize(g,[f.x-m.x,f.y-m.y]);k.normalize(h,[l.x-f.x,l.y-f.y])}else if(0===a)l=c[(a+1)%d],k.normalize(h,[l.x-f.x,l.y-f.y]),e?(c=c[d-2],k.normalize(g,[f.x-c.x,f.y-c.y])):g=h;else if(a===d-1)m=c[(a+d-1)%d],k.normalize(g,[f.x-
m.x,f.y-m.y]),e?(c=c[1],k.normalize(h,[c.x-f.x,c.y-f.y])):h=g;else{console.error("Vertex index 'i' out of range.");return}e||0!==a?e||a!==d-1?this._computeJoinExtrudeVectors(b,g,h):this._computeCapExtrudeVectors(b,g,h,k.CapPosition.END):this._computeCapExtrudeVectors(b,g,h,k.CapPosition.START)};n.prototype._computeCapExtrudeVectors=function(b,a,c,d){0===this.cap?p.buttCap(b,a,c):1===this.cap?p.roundCap(b,a,c,d,k.getNumberOfSlices(Math.PI),d===k.CapPosition.START?-1:1):2===this.cap?p.squareCap(b,a,
c,d):p.buttCap(b,a,c)};n.prototype._computeJoinExtrudeVectors=function(b,a,c){var d=k.getRads(a,c);if(d>Math.PI-this.almostParallelRads)p.rectJoin(b,a,c);else if(0===this.join&&d>=this.veryShallowRads)p.bevelJoin(b,a,c,1);else if(1===this.join&&d>=this.veryShallowRads){var e=k.getNumberOfSlices(d);d<this.newRoundJoinsSafeRads?2>e||d<this.roundLimitRads?p.bevelJoin(b,a,c,1):p.roundJoin(b,a,c,e):p.unitRoundJoin(b,a,c,e)}else d<this.almostParallelRads?p.fastMiterJoin(b,a,c):d<this.miterSafeRads?p.miterJoin(b,
a,c):p.bevelJoin(b,a,c,this.miterLimitMag)};n.prototype._writeGPUVertices=function(b,a,c,d,e){for(var f=0;f<d.vectors.count;++f){var g=d.vectors.items[f].vector[0],h=d.vectors.items[f].vector[1],m=d.vectors.items[f].texCoords[0],l=d.vectors.items[f].texCoords[1];d.vectors.items[f].base=this._lineVertexBuffer.index;this._lineVertexBuffer.add(b,a,g,h,m,l,c,e)}};n.prototype._writeGPUBridgeElements=function(b,a,c){p.bridge(this.recycledTriangleBridge,b,a);if(!c)for(b=0;b<this.recycledTriangleBridge.count;++b)a=
this.recycledTriangleBridge.items[b],this._lineIndexBuffer.add(a.v1.base,a.v2.base,a.v3.base)};n.prototype._writeGPUPieElements=function(b,a){p.pie(this.recycledTrianglePie,b);if(!a)for(b=0;b<this.recycledTrianglePie.count;++b)a=this.recycledTrianglePie.items[b],this._lineIndexBuffer.add(a.v1.base,a.v2.base,a.v3.base)};n.prototype._isClipEdge=function(b,a){return b.x===a.x?-64>=b.x||4160<=b.x:b.y===a.y?-64>=b.y||4160<=b.y:!1};return n}(v)});