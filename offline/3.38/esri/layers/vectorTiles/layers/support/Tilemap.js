// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/layers/support/Tilemap","require exports ../../core/tsSupport/assignHelper ../../request ../../core/Error ../../core/lang ../../core/promiseUtils".split(" "),function(n,m,t,u,l,v,w){function q(b){if("vector-tile"===b.service.type)var a=b.service.url+"/tilemap/"+b.level+"/"+b.row+"/"+b.col+"/"+b.width+"/"+b.height;else a=b.service.tileServers,a=(a&&a.length?a[b.row%a.length]:b.service.url)+"/tilemap/"+b.level+"/"+b.row+"/"+b.col+"/"+b.width+"/"+b.height;(b=b.service.query)&&
(a=a+"?"+b);return a}Object.defineProperty(m,"__esModule",{value:!0});n=function(){function b(){this.location={left:0,top:0,width:0,height:0};this.byteSize=40}b.prototype.getAvailability=function(a,c){if(this._isAllAvailable)return"available";if(this._isAllUnvailable)return"unavailable";a=(a-this.location.top)*this.location.width+(c-this.location.left);c=a>>3;var g=this._tileAvailabilityBitSet;return 0>c||c>g.length?"unknown":g[c]&1<<a%8?"available":"unavailable"};b.prototype._updateFromData=function(a){for(var c=
!0,g=!0,f=new Uint8Array(Math.ceil(this.location.width*this.location.height/8)),h=0,e=0;e<a.length;e++){var k=e%8;a[e]?(g=!1,f[h]|=1<<k):c=!1;7===k&&++h}this._isAllUnvailable=g;this._isAllAvailable=c;this._isAllAvailable||this._isAllUnvailable||(this._tileAvailabilityBitSet=f,this.byteSize+=f.length)};b.fromDefinition=function(a,c){var g=a.service.request||u,f=a.row,h=a.col,e=a.width,k=a.height,r={query:{f:"json"},callbackParamName:"callback"};c=c?t({},r,c):r;return g(q(a),c).then(function(d){return d.data}).catch(function(d){if(d&&
d.details&&422===d.details.httpStatus){d=[];for(var p=0,x=e*k;p<x;p++)d[p]=0;return{location:{top:f,left:h,width:e,height:k},valid:!0,data:d}}return w.reject(d)}).then(function(d){if(d.location&&(d.location.top!==f||d.location.left!==h||d.location.width!==e||d.location.height!==k))throw new l("tilemap:location-mismatch","Tilemap response for different location than requested",{response:d,definition:{top:f,left:h,width:e,height:k}});return b.fromJSON(d)})};b.fromJSON=function(a){b.validateJSON(a);
var c=new b;c.location=Object.freeze(v.clone(a.location));c._updateFromData(a.data);return Object.freeze(c)};b.validateJSON=function(a){if(!a||!a.location)throw new l("tilemap:missing-location","Location missing from tilemap response");if(!1===a.valid)throw new l("tilemap:invalid","Tilemap response was marked as invalid");if(!a.data)throw new l("tilemap:missing-data","Data missing from tilemap response");if(!Array.isArray(a.data))throw new l("tilemap:data-mismatch","Data must be an array of numbers");
if(a.data.length!==a.location.width*a.location.height)throw new l("tilemap:data-mismatch","Number of data items does not match width/height of tilemap");};return b}();m.Tilemap=n;m.tilemapDefinitionId=function(b){return b.level+"/"+b.row+"/"+b.col+"/"+b.width+"/"+b.height};m.tilemapDefinitionUrl=q;m.default=n});