// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/layers/graphics/optimizedFeatures",["require","exports","../../core/Error","../../core/Logger"],function(ja,t,E,da){function A(a,b){return Math.round((b-a.translate[0])/a.scale[0])}function B(a,b){return Math.round((a.translate[1]-b)/a.scale[1])}function F(a,b){return b*a.scale[0]+a.translate[0]}function G(a,b){return a.translate[1]-b*a.scale[1]}function H(a){a=a.coords;return{x:a[0],y:a[1]}}function N(a){var b=new z;b.coords[0]=a.x;b.coords[1]=a.y;return b}function O(a){a=
a.coords;return{x:a[0],y:a[1],z:a[2]}}function ea(a){var b=new z;b.coords[0]=a.x;b.coords[1]=a.y;b.coords[2]=a.z;return b}function P(a){a=a.coords;return{x:a[0],y:a[1],m:a[2]}}function fa(a){var b=new z;b.coords[0]=a.x;b.coords[1]=a.y;b.coords[2]=a.m;return b}function Q(a){a=a.coords;return{x:a[0],y:a[1],z:a[2],m:a[3]}}function ha(a){var b=new z;b.coords[0]=a.x;b.coords[1]=a.y;b.coords[2]=a.z;b.coords[3]=a.m;return b}function R(a,b,c){for(var d=b?c?4:3:c?3:2,f=[],e=0;e<a.coords.length;e+=d){for(var g=
[],h=0;h<d;h++)g.push(a.coords[e+h]);f.push(g)}return b?c?{points:f,hasZ:b,hasM:c}:{points:f,hasZ:b}:c?{points:f,hasM:c}:{points:f}}function S(a,b,c){var d=b?c?4:3:c?3:2,f=a.coords,e=[],g=0,h=0;for(a=a.lengths;h<a.length;h++){for(var k=a[h],m=[],p=0;p<k;p++){for(var l=[],n=0;n<d;n++)l.push(f[g++]);m.push(l)}e.push(m)}return b?c?{paths:e,hasZ:b,hasM:c}:{paths:e,hasZ:b}:c?{paths:e,hasM:c}:{paths:e}}function T(a,b,c){var d=b?c?4:3:c?3:2,f=a.coords,e=[],g=0,h=0;for(a=a.lengths;h<a.length;h++){for(var k=
a[h],m=[],p=0;p<k;p++){for(var l=[],n=0;n<d;n++)l.push(f[g++]);m.push(l)}e.push(m)}return b?c?{rings:e,hasZ:b,hasM:c}:{rings:e,hasZ:b}:c?{rings:e,hasM:c}:{rings:e}}function U(a,b,c,d){if(!b)return[];switch(b){case "esriGeometryPoint":b=N;d&&c?b=ha:d?b=ea:c&&(b=fa);c=[];for(d=0;d<a.length;d++){var f=a[d],e=f.geometry;f=f.attributes;e=e?b(e):void 0;c.push(new C(e,f))}return c;case "esriGeometryMultipoint":b=c?d?4:3:d?3:2;c=[];for(d=0;d<a.length;d++){e=a[d];var g=e.geometry;e=e.attributes;f=void 0;if(g){f=
new z;f.lengths[0]=g.points.length;var h=f.coords,k=0,m=0;for(g=g.points;m<g.length;m++)for(var p=g[m],l=0;l<b;l++)h[k++]=p[l]}c.push(new C(f,e))}return c;case "esriGeometryPolyline":b=c?d?4:3:d?3:2;c=[];for(d=0;d<a.length;d++){e=a[d];p=e.geometry;e=e.attributes;f=void 0;if(p)for(f=new z,h=f.lengths,k=f.coords,g=m=0,p=p.paths;g<p.length;g++){l=p[g];for(var n=0,q=l;n<q.length;n++)for(var r=q[n],u=0;u<b;u++)k[m++]=r[u];h.push(l.length)}c.push(new C(f,e))}return c;case "esriGeometryPolygon":b=c?d?4:
3:d?3:2;c=[];for(d=0;d<a.length;d++){f=a[d];l=f.geometry;e=f.centroid;f=f.attributes;h=void 0;if(l)for(h=new z,k=h.lengths,m=h.coords,p=g=0,l=l.rings;p<l.length;p++){n=l[p];q=0;for(r=n;q<r.length;q++){u=r[q];for(var v=0;v<b;v++)m[g++]=u[v]}k.push(n.length)}e?c.push(new C(h,f,N(e))):c.push(new C(h,f))}return c;default:return I.error("convertToFeatureSet:unknown-geometry",new E("Unable to parse unknown geometry type "+b)),[]}}function J(a,b,c,d,f,e){f=V[f];var g=b.coords;b=b.lengths;var h=c?d?4:3:d?
3:2;c=c?d?K:D:d?D:L;a.lengths.length=0;a.coords.length=0;if(!g.length)return a;if(!b.length)return c(a.coords,g,0,0,A(e,g[0]),B(e,g[1])),a.lengths.length=0,a.coords.length=h,a;for(var k,m,p,l=0,n,q=0,r=0;r<b.length;r++){var u=b[r];if(!(u<f)){var v=0;n=q;m=d=A(e,g[l]);p=k=B(e,g[l+1]);c(a.coords,g,n,l,m,p);v++;l+=h;n+=h;for(var x=1;x<u;x++,l+=h)if(m=A(e,g[l]),p=B(e,g[l+1]),m!==d||p!==k)c(a.coords,g,n,l,m-d,p-k),n+=h,v++,d=m,k=p;v>=f&&(a.lengths.push(v),q=n)}}a.coords.length=q;return a.coords.length?
a:null}function M(a,b,c,d,f){var e=b.coords;b=b.lengths;var g=c?d?K:D:d?D:L;c=c?d?4:3:d?3:2;if(!e.length)return a.lengths.length=0,a.coords.length=0,a;if(!b.length)return g(a.coords,e,0,0,F(f,e[0]),G(f,e[1])),a.lengths.length=0,a.coords.length=c,a;var h=f.scale;d=h[0];h=h[1];for(var k=0,m=0;m<b.length;m++){var p=b[m];a.lengths[m]=p;var l=F(f,e[k]),n=G(f,e[k+1]);g(a.coords,e,k,k,l,n);k+=c;for(var q=1;q<p;q++,k+=c)l+=e[k]*d,n-=e[k+1]*h,g(a.coords,e,k,k,l,n)}a.lengths.length=b.length;a.coords.length=
e.length;return a}function ia(a,b,c,d,f,e){e=f?e?4:3:e?3:2;var g=c,h=c+e,k=0,m=0,p=c=0,l=0,n=0;for(--d;n<d;n++,g+=e,h+=e){var q=b[g],r=b[g+1],u=b[g+2],v=b[h],x=b[h+1],y=b[h+2],w=q*x-v*r;p+=w;k+=(q+v)*w;m+=(r+x)*w;f&&(w=q*y-v*u,c+=(u+y)*w,l+=w);q<a[0]&&(a[0]=q);q>a[1]&&(a[1]=q);r<a[2]&&(a[2]=r);r>a[3]&&(a[3]=r);f&&(u<a[4]&&(a[4]=u),u>a[5]&&(a[5]=u))}0<p&&(p*=-1);0<l&&(l*=-1);if(!p)return null;a=[k,m,.5*p];f&&(a[3]=c,a[4]=.5*l);return a}function W(a,b,c,d,f){f=d?f?4:3:f?3:2;for(var e=b,g=b+f,h=0,k=
0,m=0,p=0,l=0,n=c-1;l<n;l++,e+=f,g+=f){var q=a[e],r=a[e+1],u=a[e+2],v=a[g],x=a[g+1],y=a[g+2],w=d?X(q,r,u,v,x,y):Y(q,r,v,x);w&&(h+=w,d?(q=Z(q,r,u,v,x,y),k+=w*q[0],m+=w*q[1],p+=w*q[2]):(q=aa(q,r,v,x),k+=w*q[0],m+=w*q[1]))}return 0<h?d?[k/h,m/h,p/h]:[k/h,m/h]:0<c?d?[a[b],a[b+1],a[b+2]]:[a[b],a[b+1]]:null}function Y(a,b,c,d){a=c-a;b=d-b;return Math.sqrt(a*a+b*b)}function X(a,b,c,d,f,e){a=d-a;b=f-b;c=e-c;return Math.sqrt(a*a+b*b+c*c)}function aa(a,b,c,d){return[a+.5*(c-a),b+.5*(d-b)]}function Z(a,b,c,
d,f,e){return[a+.5*(d-a),b+.5*(f-b),c+.5*(e-c)]}Object.defineProperty(t,"__esModule",{value:!0});var I=da.getLogger("esri.tasks.support.optimizedFeatureSet"),V={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0},L=function(a,b,c,d,f,e){a[c]=f;a[c+1]=e},D=function(a,b,c,d,f,e){a[c]=f;a[c+1]=e;a[c+2]=b[d+2]},K=function(a,b,c,d,f,e){a[c]=f;a[c+1]=e;a[c+2]=b[d+2];a[c+3]=b[d+3]};t.quantizeX=A;t.quantizeY=B;t.hydrateX=F;t.hydrateY=G;var ba=function(){return function(){this.spatialReference=
this.geometryType=this.geometryProperties=this.geohashFieldName=this.globalIdFieldName=this.objectIdFieldName=null;this.hasM=this.hasZ=!1;this.features=[];this.fields=[];this.transform=null;this.exceededTransferLimit=!1}}();t.OptimizedFeatureSet=ba;var z=function(){return function(a,b){void 0===a&&(a=[]);void 0===b&&(b=[]);this.lengths=a;this.coords=b}}();t.OptimizedGeometry=z;var C=function(){return function(a,b,c){void 0===a&&(a=null);void 0===b&&(b={});this.geometry=a;this.attributes=b;c&&(this.centroid=
c)}}();t.OptimizedFeature=C;t.convertToPoint=function(a,b,c){return b?c?Q(a):O(a):c?P(a):H(a)};t.convertToMultipoint=R;t.convertToPolyline=S;t.convertToPolygon=T;t.convertFromFeatures=U;t.convertToFeatureSet=function(a){var b=[],c=a.objectIdFieldName,d=a.spatialReference,f=a.transform,e=a.fields,g=a.hasM,h=a.hasZ,k=a.features,m=a.geometryType;a=a.exceededTransferLimit;switch(m){case "esriGeometryPoint":b=H;g&&h?b=Q:g?b=O:h&&(b=P);for(var p=[],l=0;l<k.length;l++){var n=k[l],q=n.geometry;n=n.attributes;
q=q?b(q):null;p.push({attributes:n,geometry:q})}b=p;break;case "esriGeometryMultipoint":b=[];for(p=0;p<k.length;p++)q=k[p],l=q.geometry,q=q.attributes,n=void 0,l&&(n=R(l,h,g)),b.push({attributes:q,geometry:n});break;case "esriGeometryPolyline":b=[];for(p=0;p<k.length;p++)q=k[p],l=q.geometry,q=q.attributes,n=void 0,l&&(n=S(l,h,g)),b.push({attributes:q,geometry:n});break;case "esriGeometryPolygon":b=[];for(p=0;p<k.length;p++){n=k[p];q=n.geometry;l=n.attributes;var r=n.centroid;n=void 0;q&&(n=T(q,h,
g));r?(q=H(r),b.push({attributes:l,centroid:q,geometry:n})):b.push({attributes:l,geometry:n})}break;default:I.error("convertToFeatureSet:unknown-geometry",new E("Unable to parse unknown geometry type "+m))}c={features:b,fields:e,geometryType:m,objectIdFieldName:c,spatialReference:d};f&&(c.transform=f);a&&(c.exceededTransferLimit=a);g&&(c.hasM=g);h&&(c.hasZ=h);return c};t.convertFromFeatureSet=function(a){var b=new ba,c=a.hasM,d=a.hasZ,f=a.features,e=a.objectIdFieldName,g=a.spatialReference,h=a.geometryType,
k=a.exceededTransferLimit,m=a.transform;b.fields=a.fields;b.geometryType=h;b.objectIdFieldName=e;b.spatialReference=g;b.features=U(f,h,d,c);k&&(b.exceededTransferLimit=k);c&&(b.hasM=c);d&&(b.hasZ=d);m&&(b.transform=m);return b};t.hydrateOptimizedFeatureSet=function(a){var b=a.transform,c=a.hasM,d=a.hasZ;if(!b)return a;for(var f=0,e=a.features;f<e.length;f++){var g=e[f];M(g.geometry,g.geometry,c,d,b);g.centroid&&M(g.centroid,g.centroid,c,d,b)}a.transform=null;return a};t.quantizeOptimizedFeatureSet=
function(a,b){var c=b.geometryType,d=b.features,f=b.hasM,e=b.hasZ;if("esriGeometryEnvelope"===c)return I.error(new E("optimized-features:invalid-geometry-type",'FeatureSet with geometry type "'+c+'" is not supported')),b;if(!a)return b;for(var g=0;g<d.length;g++){var h=d[g],k=new C(new z,h.attributes);J(k.geometry,h.geometry,f,e,c,a);h.centroid&&(k.centroid=new z,J(k.centroid,h.centroid,f,e,"esriGeometryPoint",a));d[g]=k}b.transform=a;return b};t.quantizeOptimizedGeometry=J;t.quantizeOptimizedGeometryRemoveCollinear=
function(a,b,c,d,f,e){f=V[f];var g=b.coords;b=b.lengths;var h=c?d?4:3:d?3:2;c=c?d?K:D:d?D:L;a.lengths.length=0;a.coords.length=0;if(!g.length)return a;if(!b.length)return c(a.coords,g,0,0,A(e,g[0]),B(e,g[1])),a.lengths.length=0,a.coords.length=h,a;for(var k,m,p,l=0,n,q=0,r=0;r<b.length;r++){var u=b[r];if(!(u<f)){var v=0;n=q;d=k=A(e,g[l]);p=m=B(e,g[l+1]);c(a.coords,g,n,l,d,p);v++;l+=h;for(var x=!1,y=0,w=0,ca=1;ca<u;ca++,l+=h)if(d=A(e,g[l]),p=B(e,g[l+1]),d!==k||p!==m)k=d-k,m=p-m,x&&(0===y&&0===k||0===
w&&0===m)?(y+=k,w+=m):(x=!0,y=k,w=m,n+=h,v++),c(a.coords,g,n,l,y,w),k=d,m=p;x&&(n+=h,c(a.coords,g,n,l,y,w));v>=f&&(a.lengths.push(v),q=n)}}a.coords.length=q;return a.coords.length?a:null};t.getBoundsOptimizedGeometry=function(a,b,c,d){c=c?d?4:3:d?3:2;b=b.coords;for(var f=d=Number.POSITIVE_INFINITY,e=Number.NEGATIVE_INFINITY,g=Number.NEGATIVE_INFINITY,h=0;h<b.length;h+=c){var k=b[h],m=b[h+1];d=Math.min(d,k);e=Math.max(e,k);f=Math.min(f,m);g=Math.max(g,m)}a[0]=d;a[1]=f;a[2]=e;a[3]=g;return a};t.getQuantizedBoundsOptimizedGeometry=
function(a,b,c,d){c=c?d?4:3:d?3:2;d=b.coords;var f=Number.POSITIVE_INFINITY,e=Number.POSITIVE_INFINITY,g=Number.NEGATIVE_INFINITY,h=Number.NEGATIVE_INFINITY,k=0,m=0;for(b=b.lengths;m<b.length;m++){var p=b[m],l=d[k],n=d[k+1];f=Math.min(l,f);e=Math.min(n,e);g=Math.max(l,g);h=Math.max(n,h);k+=c;for(var q=1;q<p;q++,k+=c){var r=d[k],u=d[k+1];l+=r;n+=u;0>r&&(f=Math.min(f,l));0<r&&(g=Math.max(g,l));0>u?e=Math.min(e,n):0<u&&(h=Math.max(h,n))}}a[0]=f;a[1]=e;a[2]=g;a[3]=h;return a};t.hydrateOptimizedGeometry=
M;t.getCentroidOptimizedGeometry=function(a,b,c,d){if(!b||!b.lengths.length)return null;a.lengths.length=0;a.coords.length=0;for(var f=a.coords,e=[],g=c?[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY]:[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY],h=b.lengths,k=b.coords,m=c?d?4:3:d?3:2,p=0,l=0;l<h.length;l++){var n=h[l],q=ia(g,k,p,n,c,d);q&&
e.push(q);p+=n*m}e.sort(function(r,u){var v=r[2]-u[2];0===v&&c&&(v=r[4]-u[4]);return v});e.length&&(m=6*e[0][2],f[0]=e[0][0]/m,f[1]=e[0][1]/m,c&&(m=6*e[0][4],f[2]=0!==m?e[0][3]/m:0),f[0]<g[0]||f[0]>g[1]||f[1]<g[2]||f[1]>g[3]||c&&(f[2]<g[4]||f[2]>g[5]))&&(f.length=0);if(!f.length)if(b=b.lengths[0]?W(k,0,h[0],c,d):null)f[0]=b[0],f[1]=b[1],c&&2<b.length&&(f[2]=b[2]);else return null;return a};t.lineCentroid=W;t.getLength2D=Y;t.getLength3D=X;t.getMidpoint2D=aa;t.getMidpoint3D=Z});