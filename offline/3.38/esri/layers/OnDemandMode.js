// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/OnDemandMode","dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/has ../kernel ../geometry/Point ../tasks/query ./RenderMode ./GridLayout".split(" "),function(p,m,r,q,u,v,y,t,w,x){p=p([w],{declaredClass:"esri.layers._OnDemandMode",constructor:function(a){this.featureLayer=a;this._featureMap={}},initialize:function(a){this.inherited(arguments);this._cellMap={};this._gridLayer=x.createFromFeatureLayer({layer:this.featureLayer,map:a})},startup:function(){if(!this._started||
this._isSuspendedAtStartup)this.inherited(arguments),this._ioQueue=[],this._isSuspendedAtStartup=this.featureLayer.suspended,this.featureLayer.suspended||(this._zoomHandler(),this._enableConnectors())},propertyChangeHandler:function(a){this._init&&(2>a?this._zoomHandler():console.log("FeatureLayer: layer in on-demand mode does not support time definitions. Layer id \x3d "+this.featureLayer.id+", Layer URL \x3d "+this.featureLayer.url))},destroy:function(){this._disableConnectors();this._processIOQueue(!0);
this.inherited(arguments)},drawFeature:function(a){var b=a.geometry,c=[];if(b){c=this._gridLayer.getCellsInExtent("point"===b.type?{xmin:b.x,ymin:b.y,xmax:b.x,ymax:b.y}:b.getExtent(),!1).cells;b=this._cellMap;var d,f=a.attributes[this.featureLayer.objectIdField];for(d=0;d<c.length;d++){var e=c[d];var g=e.latticeID;var h=e.row;var k=e.col;g?e=b[g]=b[g]||e:(b[h]=b[h]||{},e=b[h][k]=b[h][k]||e);e.features=e.features||[];e.features.push(a);this._addFeatureIIf(f,a);this._incRefCount(f)}}},suspend:function(){this._init&&
this._disableConnectors()},resume:function(){this._init&&(this._enableConnectors(),this._zoomHandler())},refresh:function(){this._zoomHandler()},hasAllFeatures:function(){var a=!1,b=this._getCurrentCells(),c;for(c=0;c<b.length;c++)if(b[c].hasPartialFeatures){a=!0;break}return!a},hasUpdateError:function(){var a=!1,b=this._getCurrentCells(),c;for(c=0;c<b.length;c++)if(b[c].hasUpdateError){a=!0;break}return a},canFetchPBF:function(a){return this.inherited(arguments)&&this.featureLayer._canFetchPBFForQuery(a)},
_enableConnectors:function(){var a=this.map;this._zoomConnect=m.connect(a,"onZoomEnd",this,this._zoomHandler);this._panConnect=m.connect(a,"onPanEnd",this,this._panHandler);this._resizeConnect=m.connect(a,"onResize",this,this._panHandler)},_disableConnectors:function(){m.disconnect(this._zoomConnect);m.disconnect(this._panConnect);m.disconnect(this._resizeConnect)},_zoomHandler:function(){this._processIOQueue(!0);var a=this.featureLayer,b=this.map;!a.suspended&&a.isQueryable()&&(a._fireUpdateStart(),
this._clearIIf(),(a=a._trackManager)&&a.clearTracks(),this._cellMap={},this._gridLayer.setResolution(b.extent),this._sendRequest())},_panHandler:function(a){if(this.featureLayer.isQueryable()){this.featureLayer._fireUpdateStart();var b=this.featureLayer._resized;a=b?a:null;b&&this._gridLayer.setMapState(a,this.map.width,this.map.height);this._sendRequest(a)}},_sendRequest:function(a){this._exceeds=!1;var b=this.featureLayer,c=this.map;a=a||c.extent;c=this._gridLayer.getCellsInExtent(a,b.latticeTiling).cells;
if(!b.isEditable()){var d=this._cellMap;c=q.filter(c,function(h){if(h.lattice){if(d[h.latticeID])return!1}else if(d[h.row]&&d[h.row][h.col])return!1;return!0})}this._pending=this._pending||0;var f;for(f=0;f<c.length;f++){var e=c[f],g=this._createQueryInfo(e);this._pending++;this._ioQueue.push(b._task.execute(g.query,r.hitch(this,this._drawFeatures,e),r.hitch(this,this._queryErrorHandler,e),g.pbf?{format:"pbf"}:null))}this._removeOldCells(a);this._endCheck()},_drawFeatures:function(a,b){this.featureLayer._isImageService&&
10.7>this.featureLayer.version&&void 0===b.exceededTransferLimit&&(b.exceededTransferLimit=b.features.length===this.featureLayer.maxRecordCount);a.hasPartialFeatures=!!b.exceededTransferLimit;a.hasUpdateError=!1;this._exceeds=this._exceeds||b.exceededTransferLimit;this._finalizeIO();var c=this.featureLayer,d=this.map.extent,f=a.extent,e=a.row,g=a.col,h=c.objectIdField;b=b.features;var k=this._gridLayer,l=this._cellMap,n=a.latticeID;l=n?l[n]:l[e]&&l[e][g];if(a.resolution==k.resolution&&(n?n===k.getLatticeID(d):
k.intersects(f,d)))if(l)c._sortFeatures(b),this._updateCell(l,b);else for(c._sortFeatures(b),a.features=b,this._addCellToCellMap(a),c=b.length,a=0;a<c;a++)d=b[a],f=d.attributes[h],this._addFeatureIIf(f,d),this._incRefCount(f);else l&&this._removeCell(e,g,n);this._endCheck()},_queryErrorHandler:function(a,b){this._finalizeIO();a.hasPartialFeatures=!0;a.hasUpdateError=!0;this._addCellToCellMap(a);this.featureLayer._errorHandler(b);this._endCheck(b)},_finalizeIO:function(){this._pending--},_endCheck:function(a){if(0===
this._pending){this._processIOQueue();var b=this.featureLayer,c=b._trackManager;c&&(c.clearTracks(),c.addFeatures(b.graphics),b._ager&&q.forEach(b.graphics,function(d){d._shape&&b._repaint(d)}),c.moveLatestToFront(),c.drawTracks());this.featureLayer._fireUpdateEnd(!!a&&Error("FeatureLayer: "+(a.message||"an error occurred while updating the layer.")),this._exceeds?{queryLimitExceeded:!0}:null);if(this._exceeds)b.onQueryLimitExceeded()}},_processIOQueue:function(a){this._ioQueue=q.filter(this._ioQueue,
function(b){return-1<b.fired?!1:!0});a&&q.forEach(this._ioQueue,this._cancelPendingRequest)},_createQueryInfo:function(a){var b=this.featureLayer,c=new t;c.outFields=b.getOutFields();c.where=b._getAttributeFilter();c.returnGeometry=!0;c.geometry=a.extent||a.lattice;b.latticeTiling&&a.extent&&(c.spatialRelationship=t.SPATIAL_REL_CONTAINS);c.timeExtent=b._getOffsettedTE(b._mapTimeExtent);c.maxAllowableOffset=b._maxOffset;c.quantizationParameters=b._quantizationParameters;c.orderByFields=b.supportsAdvancedQueries?
b.getOrderByFields():null;c.multipatchOption=b.multipatchOption;b._ts&&(c._ts=(new Date).getTime());(a=b.advancedQueryCapabilities)&&a.supportsQueryWithResultType&&(c.resultType="tile");a=this.canFetchPBF(c);b._enableEditModeQuantization(c,a);return{query:c,pbf:a}},_getCurrentCells:function(a){var b=[];a=a||this._cellMap;for(var c in a)if(a.hasOwnProperty(c)){var d=a[c];d&&(d.hasOwnProperty("row")||d.hasOwnProperty("latticeID")?b.push(d):"object"===typeof d&&b.push.apply(b,this._getCurrentCells(d)))}return b},
_addCellToCellMap:function(a){var b=this._cellMap;if(a.latticeID)b[a.latticeID]=a;else{var c=a.row,d=a.col;b[c]=b[c]||{};b[c][d]=a}},_removeOldCells:function(a){var b=this._cellMap,c=this._gridLayer,d,f;for(d in b)if(b[d]){var e=b[d],g=e.latticeID,h=0,k=0;if(g)h++,g!==c.getLatticeID(a)&&(this._removeCell(null,null,g),k++);else for(f in e)e[f]&&(h++,c.intersects(e[f].extent,a)||(this._removeCell(d,f),k++));k===h&&delete b[d]}},_updateCell:function(a,b){var c=this.featureLayer,d=c.objectIdField;c=c._selectedFeatures;
var f,e=b.length;a.features=a.features||[];for(f=0;f<e;f++){var g=b[f],h=g.attributes[d],k=this._addFeatureIIf(h,g);k===g?(this._incRefCount(h),a.features.push(k)):h in c||(k.setGeometry(g.geometry),k.setAttributes(g.attributes))}},_removeCell:function(a,b,c){var d=this._cellMap,f=this.featureLayer,e=f.objectIdField,g=c?d[c]:d[a]&&d[a][b];if(g&&(c?delete d[c]:delete d[a][b],a=g.features))for(b=0;b<a.length;b++)c=a[b].attributes[e],this._decRefCount(c),c in f._selectedFeatures||this._removeFeatureIIf(c)}});
u("extend-esri")&&r.setObject("layers._OnDemandMode",p,v);return p});