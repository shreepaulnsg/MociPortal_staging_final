// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/TrackManager","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has dojo/dom-construct dojox/gfx ../kernel ../graphic ../geometry/Polyline ./GraphicsLayer".split(" "),function(r,t,l,u,v,w,x,y,z,A){var B=-1!==w.renderer.toLowerCase().indexOf("canvas");r=r(null,{declaredClass:"esri.layers._TrackManager",constructor:function(a){this.layer=a;this.trackMap={};this.trackLineMap={}},initialize:function(a){this.map=a;a=this.layer;this.createTracklineContainer()&&(this._handles=
[a.on("visibility-change",t.hitch(this,function(b){this.container.setVisibility(b.visible);this.container.evaluateSuspension()})),a.on("scale-range-change",t.hitch(this,function(){this.container.setScaleRange(this.layer.minScale,this.layer.maxScale)}))])},createTracklineContainer:function(){var a=this.layer;if("esriGeometryPoint"!==a.geometryType)return null;var b=this.map,c=a._getRenderer();c=c&&c.trackRenderer;var e=this.container=new A._GraphicsLayer({id:a.id+"_tracks",_child:!0,visible:a.visible,
minScale:a.minScale,maxScale:a.maxScale});e.loaded=!0;e.onLoad(e);e._setMap(b,a._div);B||(b=e._div.getNode(),a=a._div.getNode(),b&&a&&v.place(b,a,"first"));e.setRenderer(c);return e},addFeatures:function(a){var b=this.trackMap,c=this.layer,e=c._trackIdField,f=[];l.forEach(a,function(h){var k=h.attributes[e];(b[k]=b[k]||[]).push(h);-1===l.indexOf(f,k)&&f.push(k)});var g=c._startTimeField,d=c.objectIdField,m=function(h,k){var p=h.attributes[g],q=k.attributes[g];return p===q?h.attributes[d]<k.attributes[d]?
-1:1:p<q?-1:1};l.forEach(f,function(h){b[h].sort(m)})},trimTracks:function(a){function b(d){for(d=c[d]||[];d.length>e;)f.push(d.shift())}var c=this.trackMap,e=this.layer.maximumTrackPoints||0,f=[],g;if(!e)return f;if(a)l.forEach(a,function(d){b(d)});else for(g in c)c.hasOwnProperty(g)&&b(g);return f},drawTracks:function(a){function b(h){var k=g[h],p,q;var n=c.trackLineMap[h];e.remove(n);delete c.trackLineMap[h];n=null;if(!k||2>k.length)return!1;n=[];for(p=k.length-1;0<=p;p--)(q=k[p].geometry)&&n.push([q.x,
q.y]);k={};k[m]=h;1<n.length&&(n=new y(new z({paths:[n],spatialReference:d}),null,k),e.add(n),c.trackLineMap[h]=n)}var c=this,e=this.container,f;if(e){var g=this.trackMap;var d=this.map.spatialReference;var m=this.layer._trackIdField;if(a)l.forEach(a,function(h){b(h)});else for(f in g)g.hasOwnProperty(f)&&b(f)}},refreshTracks:function(a){function b(m){var h;c.drawTracks([m]);if(g&&g.latestObservationRenderer){m=e[m]||[];var k=m.length;for(h=0;h<k;h++)f._repaint(m[h],null,!0)}}var c=this,e=this.trackMap,
f=this.layer,g=f._getRenderer(),d;if(a)l.forEach(a,function(m){b(m)});else for(d in e)e.hasOwnProperty(d)&&b(d);this.moveLatestToFront()},moveLatestToFront:function(a){l.forEach(this.getLatestObservations(a),function(b){var c=b._shape;c&&c._moveToFront();this._repaint(b,null,!0)},this.layer)},getLatestObservations:function(a){function b(d){d=f[d];return d[d.length-1]}var c=[],e=this.layer._getRenderer(),f=this.trackMap,g;if(!e.latestObservationRenderer)return c;if(a)l.forEach(a,function(d){c.push(b(d))});
else for(g in f)f.hasOwnProperty(g)&&c.push(b(g));return c},clearTracks:function(a){var b=this.getLatestObservations(a),c=this.container,e=this.trackMap,f;if(a)l.forEach(a,function(d){delete this.trackMap[d];c&&(g=this.trackLineMap[d],c.remove(g),delete this.trackLineMap[d])},this);else{if(c)for(f in e){var g=this.trackLineMap[f];c.remove(g)}this.trackMap={};this.trackLineMap={}}l.forEach(b,function(d){this._repaint(d,null,!0)},this.layer)},isLatestObservation:function(a){var b=this.trackMap[a.attributes[this.layer._trackIdField]];
return b?b[b.length-1]===a:!1},destroy:function(){l.forEach(this._handles,function(b){b.remove()});var a=this.container;a&&(a.clear(),a._unsetMap(this.map,this.layer._div));this.map=this.layer=this.trackMap=this.container=null}});u("extend-esri")&&t.setObject("layers._TrackManager",r,x);return r});