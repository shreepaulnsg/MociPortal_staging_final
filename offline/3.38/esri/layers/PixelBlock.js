// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/PixelBlock",["dojo/_base/declare","dojo/_base/lang","dojo/has","../kernel"],function(n,q,r,t){n=n([],{declaredClass:"esri.layers.PixelBlock",planes:null,width:null,height:null,pixelType:null,pixels:[],statistics:[],maskIsAlpha:!1,validPixelCount:null,constructor:function(a){if(a){if(!a.width||Math.floor(a.width)!==a.width)throw"PixelBlock: incorrect width";if(!a.height||Math.floor(a.height)!==a.height)throw"PixelBlock: incorrect height";if(!a.pixels)throw"PixelBlock: pixel data not present";
this.width=a.width;this.height=a.height;this.pixels=a.pixels;this.pixelType=a.pixelType||null;this.statistics=a.statistics;this.mask=a.mask||null;this.maskIsAlpha=a.maskIsAlpha||!1;a=a.validPixelCount;null==a&&(a=this.mask?this._getValidPixelCount(this.mask):this.width*this.height);this.validPixelCount=a}},getPlaneCount:function(){return this.pixels.length!==this.statistics.length?console.error("Inconsistent pixel data and statistics"):this.statistics.length},addData:function(a){if(!a.pixels||!a.statistics)throw"Pixel data or statistics are not present";
if(a.pixels.length!==this.width*this.height)throw"Inconsistent pixel data size";this.statistics.push(a.statistics);this.pixels.push(a.pixels)},getAsRGBA:function(){var a=new ArrayBuffer(this.width*this.height*4);switch(this.pixelType){case "S8":case "S16":case "U16":case "S32":case "U32":case "F32":case "F64":this._fillFromNon8Bit(a);break;default:this._fillFrom8Bit(a)}return new Uint8ClampedArray(a)},getAsRGBAFloat:function(){var a=new Float32Array(this.width*this.height*4);this._fillFrom32Bit(a);
return a},clone:function(a){a=a||this;var b=new this.constructor;b.width=a.width;b.height=a.height;b.pixelType=a.pixelType;b.maskIsAlpha=a.maskIsAlpha;a.mask&&(b.mask=new Uint8Array(a.mask));var c,d;if(a.pixels){b.pixels=[];var e=(d=a.pixels.length)&&a.pixels[0].slice;for(c=0;c<d;c++)b.pixels[c]=e?a.pixels[c].slice(0,a.pixels[c].length):new a.pixels[c].constructor(a.pixels[c])}if(a.statistics)for(b.statistics=[],d=a.statistics.length,c=0;c<d;c++)b.statistics[c]=q.clone(a.statistics[c]);a=a.validPixelCount;
null==a&&(a=b.mask?this._getValidPixelCount(b.mask):b.width*b.height);return b},clamp:function(a){if("F64"!==a&&"F32"!==a){switch(a){case "U8":var b=[0,255];break;case "U16":b=[0,65535];break;case "U32":b=[0,4294967295];break;case "S8":b=[-128,127];break;case "S16":b=[-32768,32767];break;case "S32":b=[-2147483648,2147483647];break;default:b=[-3.4*1E39,3.4*1E39]}var c=b[0];b=b[1];var d=this.pixels,e=this.width*this.height,f=d.length,g,h,l=[];for(g=0;g<f;g++){var k=this._createEmptyBand(a,e);var m=
d[g];for(h=0;h<e;h++){var p=m[h];k[h]=p>b?b:p<c?c:p}l.push(k)}this.pixels=l;this.pixelType=a}},calculateStatistics:function(){var a,b=[],c=this.mask;for(a=0;a<this.pixels.length;a++){var d=this.pixels[a];b.push(this._calculateBandStatistics(d,c))}this.statistics=b},_getValidPixelCount:function(a){var b,c=0;for(b=0;b<a.length;b++)a[b]&&c++;return c},_createEmptyBand:function(a,b){switch(a){case "U8":a=new Uint8Array(b);break;case "U16":a=new Uint16Array(b);break;case "U32":a=new Uint32Array(b);break;
case "S8":a=new Int8Array(b);break;case "S16":a=new Int16Array(b);break;case "S32":a=new Int32Array(b);break;case "U32":a=new Uint32Array(b);break;case "F32":a=new Float32Array(b);break;case "F64":a=new Float64Array(b);break;default:a=new Float32Array(b)}return a},_fillFrom8Bit:function(a){var b=this.pixels,c=this.mask;if(!a||!b||!b.length)return console.error("Unable to convert to RGBA. The input pixel block is empty.");var d,e;var f=d=e=b[0];3<=b.length&&(d=b[1],e=b[2]);b=new Uint32Array(a);var g=
this.width*this.height;if(f.length!==g)return console.error("Unable to convert to RGBA. The pixelblock is invalid.");if(c&&c.length===g)if(this.maskIsAlpha)for(a=0;a<g;a++)c[a]&&(b[a]=c[a]<<24|e[a]<<16|d[a]<<8|f[a]);else for(a=0;a<g;a++)c[a]&&(b[a]=-16777216|e[a]<<16|d[a]<<8|f[a]);else for(a=0;a<g;a++)b[a]=-16777216|e[a]<<16|d[a]<<8|f[a]},_fillFromNon8Bit:function(a){var b=this.pixels,c=this.mask,d=this.statistics;if(!a||!b||!b.length)return console.error("Unable to convert to RGBA. The input pixel block is empty.");
var e=1,f=0;e=1;d&&0<d.length?(f=d.map(function(k){return k.minValue}).reduce(function(k,m){return Math.min(k,m)}),e=d.map(function(k){return k.maxValue-k.minValue}).reduce(function(k,m){return Math.max(k,m)}),e=255/e):(e=255,"S8"===this.pixelType?(f=-128,e=127):"U16"===this.pixelType?e=65535:"S16"===this.pixelType?(f=-32768,e=32767):"U32"===this.pixelType?e=4294967295:"S32"===this.pixelType?(f=-2147483648,e=2147483647):"F32"===this.pixelType?(f=-3.4*1E39,e=3.4*1E39):"F64"===this.pixelType&&(f=-Number.MAX_VALUE,
e=Number.MAX_VALUE),e=255/(e-f));a=new Uint32Array(a);d=this.width*this.height;var g=b[0];if(g.length!==d)return console.error("Unable to convert to RGBA. The pixelblock is invalid.");if(3<=b.length){var h=b[1];var l=b[2];if(c&&c.length===d)for(b=0;b<d;b++)c[b]&&(a[b]=-16777216|(l[b]-f)*e<<16|(h[b]-f)*e<<8|(g[b]-f)*e);else for(b=0;b<d;b++)a[b]=-16777216|(l[b]-f)*e<<16|(h[b]-f)*e<<8|(g[b]-f)*e}else if(c&&c.length===d)for(b=0;b<d;b++)h=(g[b]-f)*e,c[b]&&(a[b]=-16777216|h<<16|h<<8|h);else for(b=0;b<d;b++)h=
(g[b]-f)*e,a[b]=-16777216|h<<16|h<<8|h},_fillFrom32Bit:function(a){var b=this.pixels,c=this.mask;if(!a||!b||!b.length)return console.error("Unable to convert to RGBA. The input pixel block is empty.");var d,e;var f=d=e=b[0];3<=b.length&&(d=b[1],e=b[2]);var g=this.width*this.height;if(f.length!==g)return console.error("Unable to convert to RGBA. The pixelblock is invalid.");var h=0;if(c&&c.length===g)for(b=0;b<g;b++)a[h++]=f[b],a[h++]=d[b],a[h++]=e[b],a[h++]=c[b]&1;else for(b=0;b<g;b++)a[h++]=f[b],
a[h++]=d[b],a[h++]=e[b],a[h++]=1},_calculateBandStatistics:function(a,b){var c=Infinity,d=-Infinity,e=a.length,f,g=0;if(b)for(f=0;f<e;f++)b[f]&&(g=a[f],c=g<c?g:c,d=g>d?g:d);else for(f=0;f<e;f++)g=a[f],c=g<c?g:c,d=g>d?g:d;return{minValue:c,maxValue:d}}});r("extend-esri")&&q.setObject("layers.PixelBlock",n,t);return n});