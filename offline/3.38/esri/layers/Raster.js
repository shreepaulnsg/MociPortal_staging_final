// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/Raster","require dojo/_base/declare dojo/_base/lang dojo/_base/Deferred dojo/_base/array dojo/_base/config dojo/json dojo/sniff ../kernel ../Evented ../request ../geometry/Extent ../SpatialReference ../deferredUtils ./PixelBlock ./rasterFormats/LercCodec ./rasterFormats/Lerc2Codec".split(" "),function(I,u,r,y,F,S,J,z,K,L,M,N,O,G,n,P,Q){var A,B,v,H,C,p;u=u(L,{declaredClass:"esri.layers.Raster",imageServiceUrl:null,validPixelTypes:"U1 U2 U4 U8 U16 U32 S8 S16 S32 F32".split(" "),
validFormats:"lerc jpeg jpg jpgpng png png8 png24 png32 bip bsq tiff".split(" "),_eventMap:{"raster-read-complete":["pixelData","params"]},constructor:function(a){this.imageServiceUrl=a;this.registerConnectEvents();this._loadRasterFormatModules()},read:function(a,b,c){var e=this,d=new y(G._dfdCanceller);if(10>z("ie"))throw"This browser is not supported.";if(!a.imageServiceParameters)throw"Insufficient parameters to read data";var f=r.clone(a.imageServiceParameters),g=a.pixelType;F.some(this.validPixelTypes,
function(q){return q===g})||(f.pixelType="F32");F.some(this.validFormats,function(q){return q.toLowerCase()===f.format.toLowerCase()})||(f.format="lerc");var k=a.decodeFunc,m;this._prepareGetImageParameters(f);var w=f.width,x=f.height,R=f.extent;delete f.width;delete f.height;delete f.extent;d._pendingDfd=M({url:this.imageServiceUrl+"/exportImage",handleAs:"arraybuffer",content:r.mixin(f,{f:"image"}),load:function(q){e.decode(q,{width:w,height:x,planes:null,pixelType:g,noDataValue:f.noData,format:f.format,
decodeFunc:k}).then(function(D){m={pixelBlock:D,extent:R};e._resolve([m,f],"onRasterReadComplete",b,d)},function(D){e._resolve([D],null,c,d,!0)})},error:function(q){e._resolve([q],null,c,d,!0)}});return d.promise},decode:function(a,b){if(void 0===b||null===b)throw"missing decode options";var c;b.format&&(c=b.format.toUpperCase());"BSQ"!==c&&"BIP"!==c&&(c=this._getFormat(a));var e=b.decodeFunc;if(void 0===e||null===e)e=this._getFormatDecoderDfd(c);return e(a,b)},onRasterReadComplete:function(){},_prepareGetImageParameters:function(a){if(a.size&&
a.bbox){var b=a.size.split(",");a.width=parseFloat(b[0]);a.height=parseFloat(b[1]);a.extent||(b=a.bbox.split(","),a.extent=new N(parseFloat(b[0]),parseFloat(b[1]),parseFloat(b[2]),parseFloat(b[3]),new O(a.bboxSR)))}else{if(!a.width||Math.floor(a.width)!==a.width||!a.height||Math.floor(a.height)!==a.height)throw"Incorrect Image Dimensions";if(!a.extent||"esri.geometry.Extent"!==a.extent.declaredClass)throw"Incorrect extent";b=a.extent;var c=b.spatialReference.wkid||J.toJson(b.spatialReference.toJson());
delete a._ts;r.mixin(a,{bbox:b.xmin+","+b.ymin+","+b.xmax+","+b.ymax,imageSR:c,bboxSR:c,size:a.width+","+a.height},a.disableClientCaching?{_ts:(new Date).getTime()}:{})}},_adjustExtent:function(a,b,c){var e=a.ymax-a.ymin,d=a.xmax-a.xmin;c>=b?a.ymax=a.ymin+d*b/c:a.xmax=a.xmin+e*c/b;return a},_resolve:function(a,b,c,e,d){b&&this[b].apply(this,a);c&&c.apply(null,a);e&&G._resDfd(e,a,d)},_getFormatDecoderDfd:function(a){var b=null;switch(a){case "LERC":b=this._decodeLerc;break;case "LERC2":b=this._decodeLerc2;
break;case "JPEG":b=this._decodeJpeg;break;case "PNG":b=this._decodePng;break;case "BSQ":b=this._decodeBsq;break;case "BIP":b=this._decodeBip;break;case "TIFF":b=this._decodeTiff;break;default:b=function(c,e){throw"The raster format is not supported";}}b=r.hitch(this,b);return function(c,e){var d=new y;try{if("LERC"===a||!0===C){var f=b(c,e);d.resolve(f)}else p.then(function(){f=b(c,e);d.resolve(f)})}catch(g){d.reject(g)}return d}},_getFormat:function(a){a=new Uint8Array(a,0,10);var b="";if(255===
a[0]&&216===a[1])b="JPEG";else if(137===a[0]&&80===a[1]&&78===a[2]&&71===a[3])b="PNG";else if(67===a[0]&&110===a[1]&&116===a[2]&&90===a[3]&&73===a[4]&&109===a[5]&&97===a[6]&&103===a[7]&&101===a[8]&&32===a[9])b="LERC";else if(76===a[0]&&101===a[1]&&114===a[2]&&99===a[3]&&50===a[4]&&32===a[5])b="LERC2";else if(-1<String.fromCharCode.apply(null,a).toLowerCase().indexOf("error"))b="ERROR";else if(73===a[0]&&73===a[1]&&42===a[2]&&0===a[3]||77===a[0]&&77===a[1]&&0===a[2]&&42===a[3])b="TIFF";return b},_validateDecodeParams:function(a){if(!a.height||
Math.floor(a.height)!==a.height)throw"Height not provided.";if(!a.width||Math.floor(a.width)!==a.width)throw"Width not provided.";},_decodeJpeg:function(a,b){if(!A)throw"The jpeg decoder module is not loaded.";this._validateDecodeParams(b);a=(new A).decode(a);if(!E(a,b))throw"The decoded image dimensions are incorrect.";b=[];var c;for(c=0;c<a.pixels.length;c++){var e=a.pixels[c];b.push(this._calculateBandStatistics(e))}return new n({width:a.width,height:a.height,pixels:a.pixels,pixelType:"U8",mask:a.mask,
statistics:b})},_decodePng:function(a,b){if(!B)throw"The png decoder module is not loaded.";this._validateDecodeParams(b);a=new Uint8Array(a);var c=new B(a);a=new Uint8Array(b.width*b.height*4);c.copyToImageData(a,c.decodePixels());var e=c=0;e=new Uint8Array(b.width*b.height);for(c=0;c<b.width*b.height;c++)e[c]=a[4*c+3];var d=new n({width:b.width,height:b.height,pixels:[],pixelType:"U8",mask:e,statistics:[]});for(c=0;3>c;c++){var f=new Uint8Array(b.width*b.height);for(e=0;e<b.width*b.height;e++)f[e]=
a[4*e+c];d.addData({pixels:f,statistics:this._calculateBandStatistics(f)})}return d},_decodeBsq:function(a,b){if(!v)throw"The bsq decoder module is not loaded.";this._validateDecodeParams(b);h=b.noDataValue;b.pixelType=t(b.pixelType);a=v.decodeBSQ(a,{bandCount:b.planes,width:b.width,height:b.height,pixelType:l,noDataValue:h});var c=[],e,d=null;for(e=0;e<a.pixels.length;e++)d=a.pixels[e],c.push(this._calculateBandStatistics(d));return new n({width:b.width,height:b.height,pixels:a.pixels,pixelType:b.pixelType,
mask:a.maskData,statistics:c})},_decodeBip:function(a,b){this._validateDecodeParams(b);h=b.noDataValue;b.pixelType=t(b.pixelType);a=v.decodeBIP(a,{bandCount:b.planes,width:b.width,height:b.height,pixelType:l,noDataValue:h});var c=[],e,d=null;for(e=0;e<a.pixels.length;e++)d=a.pixels[e],c.push(this._calculateBandStatistics(d));return new n({width:b.width,height:b.height,pixels:a.pixels,pixelType:b.pixelType,mask:a.maskData,statistics:c})},_decodeTiff:function(a,b){this._validateDecodeParams(b);h=b.noDataValue;
b.pixelType=t(b.pixelType);a=H.decode(a);b=[];var c,e=null;for(c=0;c<a.pixels.length;c++)e=a.pixels[c],b.push(this._calculateBandStatistics(e,a.maskData));return new n({width:a.width,height:a.height,pixels:a.pixels,pixelType:a.pixelType,mask:a.maskData,statistics:b})},_decodeLerc:function(a,b){this._validateDecodeParams(b);h=b.noDataValue;b.pixelType=t(b.pixelType);for(var c=0,e,d=0,f,g=a.byteLength-10;d<g;){var k=P.decode(a,{inputOffset:d,encodedMaskData:e,returnMask:0===c?!0:!1,returnEncodedMask:0===
c?!0:!1,returnFileInfo:!0,pixelType:l,noDataValue:h});d=k.fileInfo.eofOffset;0===c&&(e=k.encodedMaskData,f=new n({width:b.width,height:b.height,pixels:[],pixelType:b.pixelType,mask:k.maskData,statistics:[]}));c++;if(!E(k,b))throw"The decoded image dimensions are incorrect";f.addData({pixels:k.pixelData,statistics:{minValue:k.minValue,maxValue:k.maxValue,noDataValue:k.noDataValue}})}return f},_decodeLerc2:function(a,b){this._validateDecodeParams(b);h=b.noDataValue;b.pixelType=t(b.pixelType);for(var c=
0,e,d,f=0,g,k=a.byteLength-10,m=[];f<k;){d=Q.decode(a,{inputOffset:f,maskData:e,returnFileInfo:!0});f=d.fileInfo.eofOffset;0===c&&(e=d.maskData,g=new n({width:b.width,height:b.height,pixels:[],pixelType:d.fileInfo.pixelType,mask:d.maskData,statistics:[]}));d.fileInfo.mask&&0<d.fileInfo.mask.numBytes&&m.push(d.maskData);c++;if(!E(d,b))throw"The decoded image dimensions are incorrect";if(1<d.dimCount&&d.pixelData&&d.pixelData.length===d.width*d.height*d.dimCount){d.pixelData=d.pixelData.slice(-d.width*
d.height);var w=d.dimStats&&d.dimStats.minValues&&d.dimStats.minValues[d.dimCount-1],x=d.dimStats&&d.dimStats.maxValues&&d.dimStats.maxValues[d.dimCount-1];null!=w&&null!=x&&(d.minValue=w,d.maxValue=x)}g.addData({pixels:d.pixelData,statistics:{minValue:d.minValue,maxValue:d.maxValue,noDataValue:d.noDataValue}})}if(1<m.length){d=g.width*g.height;g.bandMasks=m;e=new Uint8Array(d);e.set(m[0]);for(b=1;b<m.length;b++)for(a=m[b],c=0;c<d;c++)e[c]&=a[c];g.maskData=e}return g},_calculateBandStatistics:function(a,
b){var c=Infinity,e=-Infinity,d=a.length,f,g=0;if(b)for(f=0;f<d;f++)b[f]&&(g=a[f],c=g<c?g:c,e=g>e?g:e);else for(f=0;f<d;f++)g=a[f],c=g<c?g:c,e=g>e?g:e;return{minValue:c,maxValue:e}},_loadRasterFormatModules:function(){C||(p||(p=new y),10>z("ie")?p.isRejected()||p.reject("unsupported browser version"):I(["./rasterFormats/JpgPlus","./rasterFormats/Png","./rasterFormats/Raw","./rasterFormats/TiffDecoder","./rasterFormats/Zlib"],function(a,b,c,e){A=a;B=b;v=c;H=e;C=!0;p.isResolved()||p.resolve(!0)}))}});
var l=null,h=null,t=function(a){if("U1"===a||"U2"===a||"U4"===a||"U8"===a)return h=Math.pow(2,8)-1,l=Uint8Array,"U8";"U16"===a?(h=h||Math.pow(2,16)-1,l=Uint16Array):"U32"===a?(h=h||Math.pow(2,32)-1,l=Uint32Array):"S8"===a?(h=h||0-Math.pow(2,7),l=Int8Array):"S16"===a?(h=h||0-Math.pow(2,15),l=Int16Array):"S32"===a?(h=h||0-Math.pow(2,31),l=Int32Array):l=Float32Array;return a},E=function(a,b){return a.height!==b.height||a.width!==b.width?!1:!0};z("extend-esri")&&r.setObject("layers.Raster",u,K);return u});