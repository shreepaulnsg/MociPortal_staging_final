// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/FeatureLayer","require module dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/_base/json dojo/_base/Deferred dojo/date/locale dojo/io-query dojo/dom-construct dojo/i18n dojo/when dojo/global dojo/promise/all ../sniff ../kernel ../lang ../request ../config ../deferredUtils ../promiseList ../SpatialReference ../urlUtils ../symbols/SimpleMarkerSymbol ../symbols/SimpleLineSymbol ../symbols/SimpleFillSymbol ../symbols/jsonUtils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/jsonUtils ../support/expressionUtils ../arcadeProfiles/labelingProfile ../tasks/QueryTask ../tasks/query ../tasks/FeatureSet ../tasks/StatisticDefinition ../geometry/Extent ../geometry/jsonUtils ../geometry/normalizeUtils ../geometry/scaleUtils ./GraphicsLayer ./Field ./TimeInfo ./TimeReference ./FeatureType ./FeatureTemplate ./FeatureSubtype ./FeatureEditResult ./LabelClass ./support/domainUtils ./SnapshotMode ./OnDemandMode ./SelectionMode ./StreamMode ./GridLayout ./TrackManager ./HeatmapManager ./clustering/ClusterManager dojo/i18n!../nls/jsapi dojo/has!extend-esri?./agscommon".split(" "),
function(S,ca,da,I,r,h,K,C,ea,fa,ha,Ma,T,O,ia,E,L,z,G,ja,H,U,P,ka,la,ma,V,na,W,oa,pa,X,qa,ra,Q,M,sa,Y,ta,ua,va,wa,xa,ya,za,Aa,Z,Ba,J,Ca,Da,N,R,Ea,Fa,Ga,aa,ba,Ha,Ia){var Ja=ja.defaults,Ka=!!E("esri-pbf"),La=!!E("esri-featurelayer-pbf"),q=da(wa,{declaredClass:"esri.layers.FeatureLayer",invalidParams:"query contains one or more unsupported parameters",reSQLCurrentTimestamp:/current_timestamp|current_date|current_time/i,reHostedFS:/(https?:)?\/\/services.*\.arcgis\.com/i,maxPointCountForAuto:4E3,maxRecordCountForAuto:2E3,
maxVertexCountForAuto:25E4,generalizeForScale:4E3,_eventMap:{"add-attachment-complete":["result"],"before-apply-edits":["adds","updates","deletes"],"delete-attachments-complete":["results"],"edits-complete":["adds","updates","deletes"],"query-attachment-infos-complete":["results"],"query-count-complete":["count"],"query-features-complete":["featureSet"],"query-ids-complete":["objectIds"],"query-related-features-complete":["featureSets"],"selection-complete":["features","method"],"update-end":["error",
"info"]},constructor:function(a,b){this._preventInit||this._initFeatureLayer(a,b)},_initFeatureLayer:function(a,b){b=b||{};this._tileWidth=b.tileWidth||512;this._tileHeight=b.tileHeight||512;this.i18n=Ia;this._featureReduction=this._featureReduction||b.featureReduction;this._featureReductionEnabled=null!=b.featureReductionEnabled?b.featureReductionEnabled:!0;this._featureUpdatesCheckEnabled=null!=b.featureUpdatesCheckEnabled?b.featureUpdatesCheckEnabled:!0;this.showLabels=null!=b.showLabels?b.showLabels:
!0;this._outFields=b.outFields;this._defnExpr=b.definitionExpression;this._loadCallback=b.loadCallback;this._trackIdField=b.trackIdField;this.objectIdField=b.objectIdField;var c=null!=b.resolution,d=null!=b.maxAllowableOffset;this._maxOffset=this._optMaxOffset=c||d?c?b.resolution:b.maxAllowableOffset:this.maxAllowableOffset;this.quantize=null!=b.quantize?b.quantize:!0;this._optEditable=b.editable;this._optAutoGen=b.autoGeneralize;this.editSummaryCallback=b.editSummaryCallback;this.userId=b.userId;
this.userIsAdmin=b.userIsAdmin;this.useMapTime=b.hasOwnProperty("useMapTime")?!!b.useMapTime:!0;this.source=b.source;this.gdbVersion=b.gdbVersion;this.orderByFields=b.orderByFields;this.maxPointCountForAuto=null!=b.maxPointCountForAuto?b.maxPointCountForAuto:this.maxPointCountForAuto;this.maxRecordCountForAuto=null!=b.maxRecordCountForAuto?b.maxRecordCountForAuto:this.maxRecordCountForAuto;this.maxVertexCountForAuto=null!=b.maxVertexCountForAuto?b.maxVertexCountForAuto:this.maxVertexCountForAuto;
this.generalizeForScale=null!=b.generalizeForScale?b.generalizeForScale:this.generalizeForScale;this.queryPagination=this._optQueryPagination=null!=b.queryPagination?b.queryPagination:!0;this.multipatchOption=b.multipatchOption;this.subtypeSublayerInfo=b.subtypeSublayerInfo;this._selectedFeatures={};this._newFeatures=[];this._deletedFeatures={};this._ulid=this._getUniqueId();c=z.isDefined(b.mode)?b.mode:q.MODE_ONDEMAND;this._isStream&&(c=q.MODE_STREAM);this.mode=c;switch(c){case q.MODE_SNAPSHOT:this.currentMode=
q.MODE_SNAPSHOT;this._mode=new N(this);break;case q.MODE_ONDEMAND:case q.MODE_AUTO:this.currentMode=q.MODE_ONDEMAND;this._mode=new R(this);this.latticeTiling=b.latticeTiling;break;case q.MODE_SELECTION:this.currentMode=q.MODE_SELECTION;this._mode=new Ea(this);this._isSelOnly=!0;break;case q.MODE_STREAM:this.currentMode=q.MODE_STREAM,this._mode=new Fa(this),this._isStream=!0}this._initLayer=r.hitch(this,this._initLayer);this._selectHandler=r.hitch(this,this._selectHandler);this._editable=!1;if(r.isObject(a)&&
a.layerDefinition)return this._collection=!0,this.mode=this._isStream?q.MODE_STREAM:q.MODE_SNAPSHOT,this._isStream||this._outFields||(this._outFields=["*"]),this._initLayer(a),this;this.source&&(a={source:this.source.toJson()},this._url.query=r.mixin(this._url.query,{layer:K.toJson(a)}));this.gdbVersion&&(this._url.query=r.mixin(this._url.query,{gdbVersion:this.gdbVersion}));this._task=new ra(this.url,{source:this.source,gdbVersion:this.gdbVersion});a=this._url.path;this._fserver=!1;-1!==a.search(/\/FeatureServer\//i)&&
(this._fserver=!0);this._checkFeatureLimit();(b=b.resourceInfo)?this._initLayer(b):G({url:a,content:r.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler});this.registerConnectEvents()},_initLayer:function(a,b){if(a||b){this._json=a;b=this.subtypeSublayerInfo;this._findCredential();if(this.credential&&this.credential.ssl||a&&a._ssl)this._useSSL(),this._task._useSSL();this._collection&&(this._isStream||(this.currentMode=q.MODE_SNAPSHOT,this._mode=
new N(this)),this._featureSet=a.featureSet,this._nextId=a.nextObjectId,a=a.layerDefinition);this.version=a.currentVersion;this.version||(this.version="capabilities"in a||"drawingInfo"in a||"hasAttachments"in a||"htmlPopupType"in a||"relationships"in a||"timeInfo"in a||"typeIdField"in a||"types"in a?10:9.3);this.geometryType=a.geometryType;a.bandCount&&a.fields&&1<a.fields.length&&(this.geometryType="esriGeometryPolygon",this._isImageService=!0);"string"!==typeof this.multipatchOption&&"esriGeometryMultiPatch"===
this.geometryType&&(this.multipatchOption="xyFootprint");if(a.hasOwnProperty("capabilities")){var c=this.capabilities=a.capabilities;c&&-1!==c.toLowerCase().indexOf("editing")?this._editable=!0:this._editable=!1}else this._collection||(this._editable=this._fserver);z.isDefined(this._optEditable)?(this._editable=this._optEditable,delete this._optEditable):"esriGeometryMultiPatch"===this.geometryType&&(this._editable=!1);this._isImageService&&(this._editable=!1);this._json=K.toJson(this._json);this.isEditable()?
this._setMaxOffset(null):this._canAutoGeneralize()&&(this._autoGeneralize=z.isDefined(this._optAutoGen)?this._optAutoGen:this.mode===q.MODE_ONDEMAND||this.mode===q.MODE_AUTO,delete this._optAutoGen);c=a.effectiveMinScale||a.minScale;var d=a.effectiveMaxScale||a.maxScale;!this._hasMin&&c&&this.setMinScale(c);!this._hasMax&&d&&this.setMaxScale(d);this.layerId=a.id;this.name=b&&b.title||a.name;this.description=a.description;this.copyright=a.copyrightText;this.type=a.type;this.displayField=a.displayField;
this.defaultDefinitionExpression=a.definitionExpression||(a.isView?a.viewDefinitionQuery:a.definitionQuery);this.fullExtent=new Y(a.extent);this.initialExtent=new Y(this.fullExtent.toJson());this.fullExtent.spatialReference&&(this.spatialReference=new P(this.fullExtent.spatialReference.toJson()));this.defaultVisibility=a.defaultVisibility;this.editingInfo=a.editingInfo;this.supportsLastEditDate=!(!this.editingInfo||null==this.editingInfo.lastEditDate);if("esriGeometryPoint"===this.geometryType||"esriGeometryMultipoint"===
this.geometryType)this.latticeTiling=!1;this.hasM=a.hasM||!1;this.hasZ=a.hasZ||!1;this.indexedFields=a.indexedFields;this.indexes=a.indexes;this.maxRecordCount=a.maxRecordCount;this.canModifyLayer=a.canModifyLayer;this.supportsStatistics=a.supportsStatistics;this.supportsAdvancedQueries=this._collection?!1:a.supportsAdvancedQueries;this.supportsCalculate=a.supportsCalculate;this.supportsASyncCalculate=a.supportsASyncCalculate;this.supportsAttachmentsByUploadId=a.supportsAttachmentsByUploadId;this.supportsCoordinatesQuantization=
a.supportsCoordinatesQuantization;this.supportsQuantizationEditMode=a.supportsQuantizationEditMode;this.supportsFieldDescription=a.supportsFieldDescriptionProperty;this.supportsFormatPBF=a.supportedQueryFormats?-1!==h.map(a.supportedQueryFormats.toLowerCase().split(","),r.trim).indexOf("pbf"):!1;this.quantize=this.quantize&&this.supportsCoordinatesQuantization;this.hasLabels=a.hasLabels;this.canScaleSymbols=a.canScaleSymbols;this.supportsRollbackOnFailureParameter=this.supportsRollbackOnFailure=a.supportsRollbackOnFailure;
this.syncCanReturnChanges=a.syncCanReturnChanges;this.isDataVersioned=a.isDataVersioned;this.editFieldsInfo=a.editFieldsInfo;this.ownershipBasedAccessControlForFeatures=a.ownershipBasedAccessControlForFeatures;this.editFieldsInfo&&this.ownershipBasedAccessControlForFeatures&&(this.creatorField=this.editFieldsInfo.creatorField);this.relationships=a.relationships;this.allowGeometryUpdates=z.isDefined(a.allowGeometryUpdates)?a.allowGeometryUpdates:!0;this.allowUpdateWithoutMValues=!!a.allowUpdateWithoutMValues;
this.enableZDefaults=!!a.enableZDefaults;this.zDefault=z.isDefined(a.zDefault)?a.zDefault:null;this.advancedQueryCapabilities=a.advancedQueryCapabilities||{supportsStatistics:this.supportsStatistics,supportsOrderBy:this.supportsAdvancedQueries,supportsDistinct:this.supportsAdvancedQueries};this.geometryProperties=a.hasGeometryProperties&&a.geometryProperties||null;this.url&&(this.advancedQueryCapabilities.supportsPagination=this.advancedQueryCapabilities.supportsPagination&&(this.reHostedFS.test(this.url)||
10.3<this.version));this.queryPagination=this._optQueryPagination&&this.advancedQueryCapabilities.supportsPagination;this.useStandardizedQueries=a.useStandardizedQueries;this.tileMaxRecordCount=a.tileMaxRecordCount;this.standardMaxRecordCount=a.standardMaxRecordCount;if(c=a.dateFieldsTimeReference)this.dateFieldsTimeReference=new za(c);this._setMaxOffset(this._maxOffset,!0);this._isTable="Table"===this.type;d=a.fields;this._createFields(d);if(!this.objectIdField){this.objectIdField=a.objectIdField;
if(!this.objectIdField)for(d=a.fields,c=0;c<d.length;c++){var e=d[c];if("esriFieldTypeOID"===e.type){this.objectIdField=e.name;break}}this.objectIdField||this._isStream||console.debug("esri.layers.FeatureLayer: "+z.substitute({url:this.url},"objectIdField is not set [url: ${url}]"))}if(!z.isDefined(this._nextId)){d=this.objectIdField;e=-1;if(this._collection&&d){var f=(c=this._featureSet)&&c.features,g=f?f.length:0;for(c=0;c<g;c++){var k=(k=f[c].attributes)&&k[d];k>e&&(e=k)}}this._nextId=e+1}this.globalIdField=
a.globalIdField;if(c=this.typeIdField=a.typeIdField)if(c=!this._getField(c)&&this._getField(c,!0))this.typeIdField=c.name;this.visibilityField=a.visibilityField;if(d=a.defaultSymbol)this.defaultSymbol=na.fromJson(d);var n=this.types=[],l=a.types;e=(c=this.editFieldsInfo)&&c.creatorField;f=c&&c.editorField;k=e||f;g=[];if(l)for(c=0;c<l.length;c++){var t=new Aa(l[c]);var p=t.templates;k&&p&&p.length&&(g=g.concat(p));n.push(t)}l=a.templates;t=this.templates=[];if(l)for(c=0;c<l.length;c++)n=new Z(l[c]),
k&&g.push(n),t.push(n);for(c=0;c<g.length;c++)if(k=r.getObject("prototype.attributes",!1,g[c]))e&&delete k[e],f&&delete k[f];if(c=a.subtypeField)this.subtypeField=(c=this.getField(c))?c.name:null;this.defaultSubtypeCode=a.defaultSubtypeCode;this.subtypes=h.map(a.subtypes,function(w){return new Ba(w)});this._applySTSublayerInfo(b);if(b=a.timeInfo)this.timeInfo=new ya(b),this._startTimeField=b.startTimeField,this._endTimeField=b.endTimeField,this._startTimeField&&this._endTimeField&&(this._twoTimeFields=
!0),this._trackIdField?b.trackIdField=this._trackIdField:this._trackIdField=b.trackIdField;this.hasAttachments=!this._collection&&a.hasAttachments?!0:!1;this.htmlPopupType=a.htmlPopupType;b=a.drawingInfo;(c=b&&b.labelingInfo)&&!this.labelingInfo&&(this.labelingInfo=h.map(c,function(w){return new Ca(w)}),this._fixLabelExpr());if(!this.renderer)if(b&&b.renderer){var m=b.renderer;this.setRenderer(pa.fromJson(m,{geometryType:this.geometryType}));"classBreaks"===m.type&&this.renderer.setMaxInclusive(!0);
if(!this._collection){var u=m.type;c=[];m=this.renderer;switch(u){case "simple":c.push(m.symbol);break;case "uniqueValue":case "classBreaks":c.push(m.defaultSymbol),c=c.concat(h.map(m.infos,function(w){return w.symbol}))}c=h.filter(c,z.isDefined);var v=this._url.path+"/images/",x=this._getToken();h.forEach(c,function(w){var y=w.url;y&&(-1===y.search(/https?:/)&&-1===y.indexOf("data:")&&(w.url=v+y),x&&-1!==w.url.search(/https?:/)&&(w.url+="?token\x3d"+x))})}}else if(d)l=this.types,0<l.length?(m=new oa(this.defaultSymbol,
this.typeIdField),h.forEach(l,function(w){m.addValue(w.id,w.symbol)})):m=new W(this.defaultSymbol),this.setRenderer(m);else if(!this._isTable){switch(this.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":u=new la;break;case "esriGeometryPolyline":u=new ma;break;case "esriGeometryPolygon":u=new V;break;default:this.hasXYFootprint()&&(u=new V)}this.setRenderer(u?new W(u):null)}u=b&&b.transparency||0;!this.hasOwnProperty("opacity")&&0<u&&(this.opacity=1-u/100);(E("ie")||7<=E("trident")||
E("safari"))&&this.isEditable()&&10.02>this.version&&(this._ts=!0);this.statistics=a.statistics;this._fixRendererFields();this._updateRequiredFieldsFromLabelingInfo();this._checkFields();this._updateCaps();var A=function(){null==this._maxOffset||this._isFractionalOffsetAllowed()||this._setMaxOffset(this._maxOffset);this.loaded=!0;this.setFeatureReduction(this.getFeatureReduction());this.currentMode!==q.MODE_SNAPSHOT&&(this.queryPagination=!1);this.onLoad(this);var w=this._loadCallback;w&&(delete this._loadCallback,
w(this))};a=[];this._collection?(u=this._featureSet,this._featureSet=null,this._mode._drawFeatures(new M(u)),this._fcAdded=!0):(a.push(this._forceIdentity()),this._limitPromise&&a.push(this._limitPromise));a.push(this._evalArcadeSupport());a.length?U(a).then(r.hitch(this,function(){A.call(this)})):A.call(this)}},_applySTSublayerInfo:function(a){a&&this.subtypeField&&(this.subtypeCode=a.subtypeCode,this._applySTSublayerDefinitionExpression(a),this._filterSubtypes(a),this._applySTTemplates(a),this._applySTFieldOverrides(a))},
_applySTSublayerDefinitionExpression:function(a){var b=[],c=this.getDefinitionExpression();c&&b.push(c);(a=a.layerDefinition&&a.layerDefinition.definitionExpression)&&b.push(a);1<b.length&&(b=h.map(b,function(d){return"("+d+")"}));this.setDefinitionExpression(b.length?b.join(" AND "):null)},_applySTTemplates:function(a){if(a=a.layerDefinition&&a.layerDefinition.templates)this.templates=h.map(a,function(b){return new Z(b)})},_filterSubtypes:function(){this.subtypes&&(this.subtypes=h.filter(this.subtypes,
function(a){return a.code===this.subtypeCode},this))},_applySTFieldOverrides:function(a){var b=a.layerDefinition&&a.layerDefinition.fieldOverrides;if(b){this.fields=h.filter(this.fields,function(d){return h.some(b,function(e){return e.name===d.name})});var c=this.getSubtypeByCode(this.subtypeCode).domains;this.fields.forEach(function(d){var e=h.filter(b,function(f){return f.name===d.name})[0];e.alias&&(d.alias=e.alias);if(!1===e.editable||d.name===this.subtypeField)d.editable=!1;c&&(e=c[d.name])&&
"inherited"!==e.type&&(d.domain=Da.fromJson(e.toJson()))},this)}},setShowLabels:function(a){var b=this.showLabels;this.showLabels=a;b!==this.showLabels&&(this._evalSurfaceType(),this.onShowLabelsChange())},onShowLabelsChange:function(){},onRendererChange:function(a){this.inherited(arguments);var b=this._map;this._ager=!!(a&&a.observationAger&&a.observationRenderer);a&&"colors"in a&&"blurRadius"in a&&"maxPixelIntensity"in a?(this._evalSurfaceType(!0),"esriGeometryPoint"==this.geometryType&&!this._heatmapManager&&
b&&(this._heatmapManager=new ba(this),this._heatmapManager.initialize(b))):this.renderer&&this.renderer.getRendererInfo?h.some(this.renderer.rendererInfos,function(e){return e.renderer&&"colors"in e.renderer&&"blurRadius"in e.renderer})||(this._heatmapManager=null):this._heatmapManager=null;this.timeInfo&&b&&(a&&(a.latestObservationRenderer||a.trackRenderer)?this._trackManager||(this._trackManager=new aa(this),this._trackManager.initialize(b),this._childLayer=this._trackManager.container,this._mode._applyTimeFilter()):
this._trackManager&&!this._isStream&&(this._trackManager.destroy(),this._trackManager=null));if(a){var c=[];b=h.filter([a,a.observationRenderer,a.latestObservationRenderer,a.trackRenderer],z.isDefined);var d=function(e){return null!=e&&"function"!=typeof e&&e};h.forEach(b,function(e){var f=d(e.attributeField),g=d(e.attributeField2);e=d(e.attributeField3);!1!==f&&c.push(f);!1!==g&&c.push(g);!1!==e&&c.push(e)});this._requiredFields=c}else this._requiredFields=[];this.loaded&&(this._fixRendererFields(),
this._checkFields(this._requiredFields),this._collection&&(this._typesDirty=!0))},setFeatureReduction:function(a){a&&(a=r.mixin({},a),null!=a.clusterSize&&null==a.clusterRadius&&(a.clusterRadius=a.clusterSize),delete a.clusterSize);this.loaded?this._isFeatureReductionSupported(a)?this._featureReduction=a:(this._featureReduction=null,a&&console.log("Clustering is not supported for this layer: "+this.url)):this._featureReduction=a;this._evalFeatureReduction(this._featureReduction)},hasFeatureReduction:function(){return!!this._featureReduction},
getFeatureReduction:function(){var a=this._featureReduction;if(a){a=r.mixin({},a);var b=this._clusterManager;if(b=b&&b.aggregationInfo)a.clusterRadius=b.clusterRadius,a.infoTemplate=b.infoTemplate}return a},isFeatureReductionActive:function(){var a=this._clusterManager;return!!(a&&a.isClusteringEnabled()&&a.isClusteringActive())},isFeatureReductionEnabled:function(){return this._featureReductionEnabled},enableFeatureReduction:function(){this._featureReductionEnabled||(this._featureReductionEnabled=
!0,this._evalFeatureReduction(this._featureReduction))},disableFeatureReduction:function(){this._featureReductionEnabled&&(this._featureReductionEnabled=!1,this._evalFeatureReduction(this._featureReduction))},isFeatureReductionApplied:function(){return this.hasFeatureReduction()&&this.isFeatureReductionEnabled()&&this._canCluster(this.getFeatureReduction())},getAggregateGraphics:function(){return this._clusterManager?this._clusterManager.getAggregateGraphics():[]},getChildGraphics:function(a){return this._clusterManager?
this._clusterManager.getFeaturesInCluster(a):[]},getSingleGraphics:function(){return this._clusterManager?this._clusterManager.getSingleGraphics():[]},getFeatureReductionRenderer:function(){return this.isFeatureReductionActive()?this._clusterManager.getClusterRenderer():null},getFeatureReductionLayer:function(){return this._clusterManager?this._clusterManager.container:null},getFeatureReductionField:function(a){var b,c=this._clusterManager?this._clusterManager.getClusterFields():null;a=a?a.toLowerCase():
"";h.some(c,function(d){a===d.name.toLowerCase()&&(b=d);return!!b});return b},_isFeatureReductionSupported:function(a){return a&&"cluster"===a.type&&"esriGeometryPoint"===this.geometryType&&(this._collection||this._isStream||this._optQueryPagination&&this.advancedQueryCapabilities.supportsPagination)},_isReductionCompatibleRenderer:function(a){a=a&&a.declaredClass||"";a=a.toLowerCase();return-1<a.indexOf("simplerenderer")||-1<a.indexOf("classbreaksrenderer")||-1<a.indexOf("uniquevaluerenderer")},
_evalFeatureReduction:function(a){this.loaded&&this.getMap()&&(a=a||this.getFeatureReduction(),this._evalModeFromFReduction(a),a&&this.isFeatureReductionEnabled()?this._canCluster(a)?this._clusterManager?this._updateClusterManager(a):(this._clusterManager=this._createClusterManager(a),this.onFeatureReductionChange()):(console.log("Clustering is supported only for point layers where map spatial reference is WGS84 or Web Mercator"),this._destroyClusterManager()):this._destroyClusterManager())},_canCluster:function(a){var b=
this._map;if(!b)return!1;b=b.spatialReference;return this._isFeatureReductionSupported(a)&&this._isReductionCompatibleRenderer(this.renderer)&&(b.isWebMercator()||4326===b.wkid)},_createClusterManager:function(a){a=new Ha({layer:this,aggregationInfo:a});this._clusterHandles=[a.on("renderer-change",r.hitch(this,function(){this.onFeatureReductionRendererChange()}))];a.initialize(this._map);return a},_updateClusterManager:function(a){var b=this._clusterManager;b&&b.setAggregationInfo(a)},_destroyClusterManager:function(a){h.forEach(this._clusterHandles,
function(b){b.remove()});this._clusterHandles=null;this._clusterManager&&(this._clusterManager.destroy(a),this._clusterManager=null,this.onFeatureReductionChange())},redraw:function(){this.inherited(arguments);this._clusterManager&&this._clusterManager.redraw();this._trackManager&&this._trackManager.container&&this._trackManager.container.redraw()},_evalSDRenderer:function(a){this.inherited(arguments);var b=this._getRenderer();this._ager=!!(b&&b.observationAger&&b.observationRenderer);this._trackManager&&
this._trackManager.container&&this._trackManager.container.setRenderer(b&&b.trackRenderer);a&&this._evalFeatureReduction()},_graphicVisibilityChanged:function(a){this._clusterManager?this._clusterManager.toggleFeatureVisibility(a):this._heatmapManager&&this._heatmapManager.redraw()},setWebGLFetchOptions:function(a){this._hasOnDemandDrillMode()&&(a=a||{},null!=a.maxDrillLevel&&(this._mode.maxDrillLevel=a.maxDrillLevel),null!=a.maxRecordCountFactor&&(this._mode.maxRecordCountFactor=a.maxRecordCountFactor),
null!=a.enablePBFQuery&&(this._mode.enablePBFQuery=a.enablePBFQuery))},_isWebGLCompatible:function(){return this.loaded&&!this.isEditable()&&!this.isFeatureReductionApplied()&&(!this.labelingInfo||!1===this.showLabels)&&!this._isGeometryOperationsUsed()&&this._isRendererSupportedInWebGL()&&this.supportsCoordinatesQuantization&&("esriGeometryPolygon"!==this.geometryType||this.advancedQueryCapabilities.supportsReturningGeometryCentroid)&&this.currentMode===q.MODE_ONDEMAND&&(!this._preSurfaceChangeState||
this._preSurfaceChangeState.currentMode===q.MODE_ONDEMAND)},_isRendererSupportedInWebGL:function(){if(!this.renderer)return!1;var a=this.renderer,b=a.declaredClass?a.declaredClass.toLowerCase():"";return(-1<b.indexOf("simplerenderer")||-1<b.indexOf("classbreaksrenderer")||-1<b.indexOf("uniquevaluerenderer"))&&this._hasWebGLCompatibleSymbols(a)&&this._hasWebGLCompatibleVVs(a)},_hasWebGLCompatibleSymbols:function(a){a=this._getAllSymbolsInRenderer(a);return!(this._hasSLSWithMarker(a)||this._hasIncompatibleSMSStyles(a)||
this._hasGIFMarker(a))},_hasWebGLCompatibleVVs:function(a){return!h.some(a&&a.visualVariables,function(b){var c=b.type;return("colorInfo"===c||"opacityInfo"===c)&&b.stops&&8<b.stops.length||"sizeInfo"===c&&(b.field||b.valueExpression&&"$view.scale"!==b.valueExpression||b.expression&&"view.scale"!==b.expression)&&b.stops&&6<b.stops.length?!0:!1})},_hasSLSWithMarker:function(a){return h.some(a,function(b){return b&&"simplelinesymbol"===b.type&&!!b.marker})},_hasIncompatibleSMSStyles:function(a){var b=
void 0===E("ie")&&7==E("trident");return h.some(a,function(c){return c&&"simplemarkersymbol"===c.type&&("triangle"===c.style||"path"===c.style&&b)})},_hasGIFMarker:function(a){var b=/\.gif$/,c=/^image\/gif$/;return h.some(a,function(d){return d&&"picturemarkersymbol"===d.type?b.test(d.url)||c.test(d.contentType):!1})},_getAllSymbolsInRenderer:function(a){var b=[];a&&(b.push(a.symbol),b.push(a.defaultSymbol),h.forEach(a.infos,function(c){b.push(c.symbol)}),b=h.filter(b,function(c){return!!c}));return b},
_setMap:function(a){var b=this.inherited(arguments),c=this._mode,d=this;c&&a.loaded&&c.initialize(a);this.geometryType&&this.attr("data-geometry-type",this.geometryType.replace(/esriGeometry/i,"").toLowerCase());this._addHandle=this.on("graphic-node-add",function(e){e=e.graphic.attributes;(e=d._selectedFeatures[e&&e[d.objectIdField]])&&e.attr("data-selected","")});return b},_unsetMap:function(a){this._suspendImpl(!0);this._destroyClusterManager(!1);this._trackManager&&(this._trackManager.destroy(),
this._trackManager=null);I.disconnect(this._zoomConnect);I.disconnect(this._addHandle);this._zoomConnect=this._addHandle=null;this.inherited("_unsetMap",arguments)},onAttach:function(){this._evalModeFromSurface()},onRefreshTick:function(){this.isFeatureUpdatesCheckActive()&&this._evalFeatureUpdates()},refresh:function(a){!this._needsRefresh&&a&&a.scheduled&&this.isFeatureUpdatesCheckActive()||(this._needsRefresh=!1,(a=this._mode)&&a.refresh())},setFeatureUpdatesCheckEnabled:function(a){this._featureUpdatesCheckEnabled=
a},isFeatureUpdatesCheckEnabled:function(){return!!this._featureUpdatesCheckEnabled},isFeatureUpdatesCheckActive:function(){return this.supportsLastEditDate&&this.isFeatureUpdatesCheckEnabled()&&!!this.refreshInterval&&!!r.getObject("onFeatureUpdatesResult.after",!1,this)},hasFeatureUpdates:function(){var a=new C;if(!this.supportsLastEditDate)return a.reject(Error("FeatureLayer does not support supportsLastEditDate")),a.promise;if(!this._fetchMetadataPromise||this._fetchMetadataPromise.isFulfilled())this._fetchMetadataPromise=
G({url:this._url.path,content:r.mixin({f:"json"},this._url.query),callbackParamName:"callback"}).then(r.hitch(this,function(b){b=b.editingInfo.lastEditDate;var c=this.editingInfo.lastEditDate!==b;this.editingInfo.lastEditDate=b;return c}));this._fetchMetadataPromise.then(function(b){a.isFulfilled()||a.resolve(b)}).otherwise(function(b){a.isFulfilled()||a.reject(b)});return a.promise},hasXYFootprint:function(){return"esriGeometryMultiPatch"===this.geometryType&&"xyFootprint"===this.multipatchOption},
getOutFields:function(){return h.filter(this._getOutFields(),function(a){return"*"===a||!!this._getField(a)},this)},getField:function(a){return this._getField(a,!0)},isOutField:function(a){a=this.getField(a);if(!a)return!1;var b=this.getOutFields();return-1<h.indexOf(b,"*")||-1<h.indexOf(b,a.name)},getFieldLabel:function(a){var b=this.infoTemplate;b=b&&b.getFieldInfo&&b.getFieldInfo(a);a=r.isFunction(a)?null:this.getField(a);var c=b||a,d="";c&&(d=b&&b.label||a&&a.alias||c.name||c.fieldName);return d},
getDomain:function(a,b){var c,d,e=(b=b&&b.feature)&&this.typeIdField&&b.attributes&&b.attributes[this.typeIdField];null!=e&&h.some(this.types,function(f){return f.id==e?((c=f.domains&&f.domains[a])&&"inherited"===c.type&&(c=this._getLayerDomain(a),d=!0),!0):!1},this);d||c||(c=this._getLayerDomain(a));return c},_getLayerDomain:function(a){this._createFieldsIndex();var b=this._fieldsIndex;if(b)return b=b.caseSensitive,(b=b.get(a))?b.domain:null;var c;h.some(this.fields,function(d){d.name===a&&(c=d.domain);
return!!c});return c},getType:function(a){return this.getTypeById(a&&this.typeIdField&&a.attributes&&a.attributes[this.typeIdField])},getTypeById:function(a){var b;h.some(this.types,function(c){c.id==a&&(b=c);return!!b});return b},getSubtypeByCode:function(a){var b;h.some(this.subtypes,function(c){c.code==a&&(b=c);return!!b});return b},setEditable:function(a){if(!this._collection)return console.log("FeatureLayer:setEditable - this functionality is not yet supported for layer in a feature service"),
this;if(this._isImageService)return this;if(!this.loaded)return this._optEditable=a,this;var b=this._editable;this._editable=a;this._updateCaps();if(b!==a)this.onCapabilitiesChange();return this},getEditCapabilities:function(a){var b={canCreate:!1,canUpdate:!1,canDelete:!1,canUpdateGeometry:!1};if(!this.loaded||!this.isEditable())return b;var c=a&&a.feature;a=a&&a.userId||this.getUserId();var d=h.map(this.capabilities?this.capabilities.toLowerCase().split(","):[],r.trim),e=(b=-1<h.indexOf(d,"editing"))&&
-1<h.indexOf(d,"create"),f=b&&-1<h.indexOf(d,"update");d=b&&-1<h.indexOf(d,"delete");var g=this.ownershipBasedAccessControlForFeatures,k=this.editFieldsInfo,n=k&&k.creatorField;k=k&&k.realm;c=(c=c&&c.attributes)&&n?c[n]:void 0;var l=!!this.userIsAdmin;n=!g||l||!(!g.allowOthersToUpdate&&!g.allowUpdateToOthers);var t=!g||l||!(!g.allowOthersToDelete&&!g.allowDeleteToOthers),p=!g||l||!g.hasOwnProperty("allowAnonymousToUpdate")||g.allowAnonymousToUpdate;g=!g||l||!g.hasOwnProperty("allowAnonymousToDelete")||
g.allowAnonymousToDelete;a&&k&&(a=a+"@"+k);if(l||b&&!(e||f||d))e=f=d=!0;b={canCreate:e,canUpdate:f,canDelete:d,canUpdateGeometry:l||this.allowGeometryUpdates};a||(b.canUpdate=b.canUpdate&&p,b.canDelete=b.canDelete&&g);null===c?(b.canUpdate=b.canUpdate&&n,b.canDelete=b.canDelete&&t):""!==c&&c&&a.toLowerCase()!==c.toLowerCase()&&(b.canUpdate=b.canUpdate&&n,b.canDelete=b.canDelete&&t);return b},getUserId:function(){var a;this.loaded&&(a=this.credential&&this.credential.userId||this.userId||"");return a},
setUserIsAdmin:function(a){this.userIsAdmin=a},setEditSummaryCallback:function(a){this.editSummaryCallback=a},getEditSummary:function(a,b,c){c=z.isDefined(c)?c:(new Date).getTime();var d="";c=this.getEditInfo(a,b,c);(b=b&&b.callback||this.editSummaryCallback)&&(c=b(a,c)||"");if(r.isString(c))d=c;else{if(c){a=c.action;b=c.userId;var e=c.timeValue,f=0;a&&f++;b&&f++;z.isDefined(e)&&f++;1<f&&(d=("edit"===a?"edit":"create")+(b?"User":"")+(z.isDefined(e)?c.displayPattern:""))}d=d&&z.substitute(c,this.i18n.layers.FeatureLayer[d])}return d},
getEditInfo:function(a,b,c){if(this.loaded){c=z.isDefined(c)?c:(new Date).getTime();b=b&&b.action||"last";var d=this.editFieldsInfo,e=d&&d.creatorField,f=d&&d.creationDateField,g=d&&d.editorField;d=d&&d.editDateField;g=(a=a&&a.attributes)&&g?a[g]:void 0;d=a&&d?a[d]:null;e=this._getEditData(a&&e?a[e]:void 0,a&&f?a[f]:null,c);c=this._getEditData(g,d,c);switch(b){case "creation":var k=e;break;case "edit":k=c;break;case "last":k=c||e}k&&(k.action=k===c?"edit":"creation");return k}},_getEditData:function(a,
b,c){if(z.isDefined(b)){var d=c-b;var e=0>d?"Full":6E4>d?"Seconds":12E4>d?"Minute":36E5>d?"Minutes":72E5>d?"Hour":864E5>d?"Hours":6048E5>d?"WeekDay":"Full"}if(void 0!==a||e){var f=f||{};f.userId=a;e&&(a=ea.format,c=new Date(b),f.minutes=Math.floor(d/6E4),f.hours=Math.floor(d/36E5),f.weekDay=a(c,{datePattern:"EEEE",selector:"date"}),f.formattedDate=a(c,{selector:"date"}),f.formattedTime=a(c,{selector:"time"}),f.displayPattern=e,f.timeValue=b)}return f},isEditable:function(){return!(!this._editable&&
!this.userIsAdmin)},isQueryable:function(){var a=h.map(this.capabilities?this.capabilities.toLowerCase().split(","):[],r.trim);return this._isStream||this.userIsAdmin||this._collection||-1!==h.indexOf(a,"query")||-1!==h.indexOf(a,"catalog")},setResolution:function(a){return this.setMaxAllowableOffset(a)},setMaxAllowableOffset:function(a){this.isEditable()||(this._optMaxOffset=a,this._setMaxOffset(a,!0));return this},_resetMaxAllowableOffset:function(){this.setMaxAllowableOffset(this._optMaxOffset);
this._prevScale=null;this._refreshMaxAllowableOffset()},_refreshMaxAllowableOffset:function(){this._calcMaxOffsetForAutoSnapshot();this._updateMaxOffset();this._needsRefresh=!1},getResolution:function(){return this.getMaxAllowableOffset()},getMaxAllowableOffset:function(){var a=this._quantizationParameters?this._quantizationParameters.tolerance:void 0;return null!=this._maxOffset?this._maxOffset:a},_setMaxOffset:function(a,b){if(null==a)return delete this._maxOffset,delete this._quantizationParameters,
this;this.quantize&&this.supportsCoordinatesQuantization?("esriGeometryPolyline"===this.geometryType?this._maxOffset=a:delete this._maxOffset,this._quantizationParameters=a?{mode:"view",originPosition:"upperLeft",tolerance:a,extent:this.fullExtent}:null):(this._isFractionalOffsetAllowed()&&b||(a=Math.floor(a)),isNaN(a)||0===a?delete this._maxOffset:this._maxOffset=a,delete this._quantizationParameters);return this},_isFractionalOffsetAllowed:function(){return null==this.version||10.1<=this.version||
navigator.languages&&this._isLangWithDot(navigator.languages[0])},_isLangWithDot:function(a){a=(a=a&&a.split("-"))&&a[0]&&a[0].toLowerCase();return-1!==h.indexOf(this._langsWithDot,a)},_langsWithDot:"ar en et fr he ja ko th vi zh".split(" "),setAutoGeneralize:function(a){this.loaded?this._canAutoGeneralize()&&((this._autoGeneralize=a)?(this._isAutoSnapshotMode()&&(this._prevScale=null),this._updateMaxOffset()):this._setMaxOffset(null)):this._optAutoGen=a;return this},_canAutoGeneralize:function(){return!this.isEditable()&&
this.mode!==q.MODE_SNAPSHOT},setGDBVersion:function(a){this._collection||a===this.gdbVersion||!a&&!this.gdbVersion||(this.gdbVersion=a,this._task.gdbVersion=a,this._url.query=r.mixin(this._url.query,{gdbVersion:a}),this.loaded&&(this.clearSelection(),this._map&&this.refresh()),this.onGDBVersionChange());return this},hasAllFeatures:function(){return this._mode?this._mode.hasAllFeatures():!0},hasUpdateError:function(){return this._mode?this._mode.hasUpdateError():!1},setDefinitionExpression:function(a){this._defnExpr=
a;this._hasPendingLimitQuery()||((a=this._checkFeatureLimit())?this._evalModeAndApplyDefnExpr(a):this._applyDefnExpr());return this},_applyDefnExpr:function(){var a=this._mode;a&&a.propertyChangeHandler(1)},_evalModeAndApplyDefnExpr:function(a){a.then(r.hitch(this,function(b){b&&(b instanceof Error||!b.modeChanged)&&this._applyDefnExpr()}))},getDefinitionExpression:function(){return this._defnExpr},hasDefinitionExpressionWithCurrentTimestamp:function(){return this.reSQLCurrentTimestamp.test(this.getDefinitionExpression())},
setTimeDefinition:function(a){this._isSnapshotMode()?(this._timeDefn=a,(a=this._mode)&&a.propertyChangeHandler(2)):console.log("FeatureLayer.setTimeDefinition: layer in on-demand or selection mode does not support time definitions. Layer id \x3d "+this.id+", Layer URL \x3d "+this.url);return this},getTimeDefinition:function(){return this._timeDefn},setTimeOffset:function(a,b){this._timeOffset=a;this._timeOffsetUnits=b;(a=this._mode)&&a.propertyChangeHandler(0);return this},setUseMapTime:function(a){this.useMapTime=
a;this._toggleTime(!this.suspended);(a=this._mode)&&a.propertyChangeHandler(0)},selectFeatures:function(a,b,c,d){b=b||q.SELECTION_NEW;this._hasSelectionError=this._hasPartialSelectedFeatures=!1;a=this._getShallowClone(a);var e=this._map,f=this,g=H._fixDfd(new C(H._dfdCanceller));a.outFields=this.getOutFields();a.returnGeometry=!0;a.multipatchOption=this.multipatchOption;e&&(a.outSpatialReference=new P(e.spatialReference.toJson()));if(!this._applyQueryFilters(a,!0)){var k={features:[]};this._selectHandler(k,
b,c,d,g);return g}if(e=this._canDoClientSideQuery(a))g._pendingDfd=T(this._doQuery(a,e)),g._pendingDfd.then(function(l){k={features:l};f._selectHandler(k,b,c,d,g)});else{if(this._collection)return this._resolve([Error("FeatureLayer::selectFeatures - "+this.invalidParams)],null,d,g,!0),g;if(this.loaded&&!this.isQueryable())return this._resolve([Error("Layer does not support query capability.")],null,d,g,!0),g;var n=this;this._ts&&(a._ts=(new Date).getTime());e=this._canFetchPBFForQuery(a);this._enableEditModeQuantization(a,
e);(g._pendingDfd=this._task.execute(a,null,null,e?{format:"pbf"}:null)).addCallbacks(function(l){n._selectHandler(l,b,c,d,g)},function(l){n._hasPartialSelectedFeatures=!0;n._hasSelectionError=!0;n._resolve([l],null,d,g,!0)})}return g},getSelectedFeatures:function(){var a=this._selectedFeatures,b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b},clearSelection:function(a){var b=this._selectedFeatures,c=this._mode,d;for(d in b)b.hasOwnProperty(d)&&(this._unSelectFeatureIIf(d,c),c._removeFeatureIIf(d));
this._selectedFeatures={};this._isSelOnly&&c._applyTimeFilter(!0);if(!a)this.onSelectionClear();return this},setSelectionSymbol:function(a){if(this._selectionSymbol=a){var b=this._selectedFeatures,c;for(c in b)b.hasOwnProperty(c)&&b[c].setSymbol(a)}return this},getSelectionSymbol:function(){return this._selectionSymbol},setLabelingInfo:function(a){a?(this.labelingInfo=a,this._fixLabelExpr()):delete this.labelingInfo;this._collection&&(this._typesDirty=!0);this._evalSurfaceType();this.onLabelingInfoChange()},
_fixLabelExpr:function(){var a=/\[([^\[\]]+)\]/ig,b,c=this,d=function(e,f){e=c._getField(f,!0);return"["+(e&&e.name||f)+"]"};h.forEach(this.labelingInfo,function(e){if(b=e.labelExpression)e.labelExpression=b.replace(a,d)})},_updateRequiredFieldsFromLabelingInfo:function(){var a=[];h.forEach(this.labelingInfo,function(b){var c=b.labelExpressionInfo;if(b.labelExpression){var d=/[\[\]]/ig;b=b.labelExpression.match(/\[[^\[\]]+\]/ig);(b=h.map(b,function(f){return f.replace(d,"")}))&&(a=a.concat(b))}if(c){if(c.value){var e=
/[\{\}]/ig;b=c.value.match(/\{[^\{\}]+\}/ig);(b=h.map(b,function(f){return f.replace(e,"")}))&&(a=a.concat(b))}c.expression&&(b=h.map(this.fields,function(f){return f.name},this),a=a.concat(X.extractFieldNames(c.expression,b)))}},this);a=h.map(a,function(b){var c=this.getField(b);return c?c.name:b},this);this._requiredFields&&(this._requiredFields=this._requiredFields.concat(a))},__msigns:[{n:"applyEdits",c:5,a:[{i:0},{i:1}],e:4,f:1}],applyEdits:function(a,b,c,d,e,f){var g=f.assembly,k=f.dfd;this._applyNormalized(a,
g&&g[0]);this._applyNormalized(b,g&&g[1]);this.onBeforeApplyEdits(a,b,c);var n={},l=this.objectIdField;g={f:"json"};var t=!1;if(this._collection)f={},f.addResults=a?h.map(a,function(){t=!0;return{objectId:this._nextId++,success:!0}},this):null,f.updateResults=b?h.map(b,function(u){t=!0;var v=u.attributes[l];n[v]=u;return{objectId:v,success:!0}},this):null,f.deleteResults=c?h.map(c,function(u){t=!0;return{objectId:u.attributes[l],success:!0}},this):null,t?this._editHandler(f,a,n,d,e,k):this._resolve([f.addResults,
f.updateResults,f.deleteResults],null,d,k);else{a&&0<a.length&&(g.adds=this._convertFeaturesToJson(a,0,1),t=!0);if(b&&0<b.length){for(f=0;f<b.length;f++){var p=b[f];n[p.attributes[l]]=p}g.updates=this._convertFeaturesToJson(b,0,0,1);t=!0}if(c&&0<c.length){b=[];for(f=0;f<c.length;f++)b.push(c[f].attributes[l]);g.deletes=b.join(",");t=!0}if(t){var m=this;return G({url:this._url.path+"/applyEdits",content:r.mixin(g,this._url.query),callbackParamName:"callback",load:function(u){m._editHandler(u,a,n,d,
e,k)},error:function(u){m._resolve([u],null,e,k,!0)}},{usePost:!0})}this._resolve([],null,d,k)}},queryFeatures:function(a,b,c,d){return this._query("execute","onQueryFeaturesComplete",a,b,c,d)},queryRelatedFeatures:function(a,b,c){return this._query("executeRelationshipQuery","onQueryRelatedFeaturesComplete",a,b,c)},queryIds:function(a,b,c,d){return this._query("executeForIds","onQueryIdsComplete",a,b,c,d)},queryCount:function(a,b,c,d){return this._query("executeForCount","onQueryCountComplete",a,
b,c,d)},queryExtent:function(a,b,c,d){return this._query("executeForExtent","onQueryExtentComplete",a,b,c,d)},queryAttachmentInfos:function(a,b,c){var d=this._url.path+"/"+a+"/attachments",e=new C(H._dfdCanceller),f=this;d=ka.normalize(d);e._pendingDfd=G({url:d,content:r.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:function(g){g=g.attachmentInfos;var k;h.forEach(g,function(n){k=fa.objectToQuery({gdbVersion:f._url.query&&f._url.query.gdbVersion,layer:f._url.query&&f._url.query.layer,
token:f._getToken()});n.url=d+"/"+n.id+(k?"?"+k:"");n.objectId=a});f._resolve([g],"onQueryAttachmentInfosComplete",b,e)},error:function(g){f._resolve([g],null,c,e,!0)}});return e},addAttachment:function(a,b,c,d){return this._sendAttachment("add",a,b,c,d)},updateAttachment:function(a,b,c,d,e){c.appendChild(ha.create("input",{type:"hidden",name:"attachmentId",value:b}));return this._sendAttachment("update",a,c,d,e)},deleteAttachments:function(a,b,c,d){var e=this._url.path+"/"+a+"/deleteAttachments",
f=new C(H._dfdCanceller),g=this;b={f:"json",attachmentIds:b.join(",")};f._pendingDfd=G({url:e,content:r.mixin(b,this._url.query),callbackParamName:"callback",load:r.hitch(this,function(k){k=k.deleteAttachmentResults;k=h.map(k,function(n){n=new J(n);n.attachmentId=n.objectId;n.objectId=a;return n});g._resolve([k],"onDeleteAttachmentsComplete",c,f)}),error:function(k){g._resolve([k],null,d,f,!0)}},{usePost:!0});return f},addType:function(a){var b=this.types;if(b){if(h.some(b,function(c){return c.id==
a.id?!0:!1}))return!1;b.push(a)}else this.types=[a];return this._typesDirty=!0},deleteType:function(a){if(this._collection){var b=this.types;if(b){var c=-1;h.some(b,function(d,e){return d.id==a?(c=e,!0):!1});if(-1<c)return this._typesDirty=!0,b.splice(c,1)[0]}}},toJson:function(){var a=this._cloneJson();if(a){a=a.layerDefinition?a:{layerDefinition:a};var b=a.layerDefinition,c=this._collection;this._updateLayerDefinition(b);var d=null;if(!c||this._fcAdded)d={geometryType:b.geometryType,features:this._convertFeaturesToJson(this.graphics,
!0)};a.featureSet=r.mixin({},a.featureSet||{},d);if(a.featureSet.transform){var e=a.featureSet.transform;delete a.featureSet.transform;d=new M(a.featureSet);d.quantize(e);a.featureSet=d.toJson()}c&&(a.nextObjectId=this._nextId,b.capabilities=this.capabilities);return a}},getLayerDefinition:function(){var a=this._cloneJson();(a=a?a.layerDefinition||a:null)&&this._updateLayerDefinition(a);return a},getFeatureCollectionLayer:function(a){var b=new C,c=this.getLayerDefinition();if(!c)return b.reject(Error("layerDefinition not available")),
b.promise;a=a||[];var d=new q({layerDefinition:c,featureSet:{geometryType:c.geometryType,features:h.map(a,function(g){return g.toJson()})}}),e=d.on("load",function(){e.remove();f.remove();b.resolve(d)}),f=d.on("error",function(){d.loaded||(e.remove(),f.remove(),b.reject(d.loadError))});return b.promise},onSelectionComplete:function(){},onSelectionClear:function(){},onBeforeApplyEdits:function(){},onEditsComplete:function(){},onQueryFeaturesComplete:function(){},onQueryRelatedFeaturesComplete:function(){},
onQueryIdsComplete:function(){},onQueryCountComplete:function(){},onQueryExtentComplete:function(){},onQueryAttachmentInfosComplete:function(){},onAddAttachmentComplete:function(){},onUpdateAttachmentComplete:function(){},onDeleteAttachmentsComplete:function(){},onCapabilitiesChange:function(){},onGDBVersionChange:function(){},onQueryLimitExceeded:function(){},onLabelingInfoChange:function(){},onFeatureReductionRendererChange:function(){},onFeatureReductionChange:function(){},onFeatureUpdatesResult:function(){},
_cloneJson:function(){var a=this._json;return r.isString(a)?K.fromJson(a):r.clone(a)},_updateLayerDefinition:function(a){if(this._collection&&this._typesDirty){a.types=h.map(this.types||[],function(e){return e.toJson()});var b=this.renderer,c=this.labelingInfo,d=a.drawingInfo;!b&&!c||d||(d=a.drawingInfo={});d&&b&&-1===b.declaredClass.indexOf("TemporalRenderer")&&(d.renderer=b.toJson());c&&(d.labelingInfo=h.map(c,function(e){return e.toJson()}))}},_evalFeatureUpdates:function(){if(!this._featureUpdatesPromise||
this._featureUpdatesPromise.isFulfilled())this._featureUpdatesPromise=this.hasFeatureUpdates().otherwise(function(a){return!(a&&"cancel"===a.dojoType)}).always(r.hitch(this,function(a){this._featureUpdatesPromise=null;this.onFeatureUpdatesResult({hasUpdates:a})}))},_evalRefresh:function(a){(a.hasUpdates||this.hasDefinitionExpressionWithCurrentTimestamp())&&this.refresh()},_evalArcadeSupport:function(){var a=new C;setTimeout(r.hitch(this,function(){this._initializeArcadeEngine().always(function(){a.resolve()})}),
0);return a.promise},_initializeArcadeEngine:function(){var a=[],b=this.infoTemplate;b&&b.initializeArcadeEngine&&a.push(b.initializeArcadeEngine());(b=this.renderer)&&b.initializeArcadeEngine&&a.push(b.initializeArcadeEngine());var c=[];h.forEach(this.labelingInfo,function(d){(d=d.labelExpressionInfo)&&d.expression&&c.push(d.expression)});a.push(qa.initialize(c));return U(a)},_isGeometryOperationsUsed:function(){var a=this.infoTemplate,b=this.renderer,c=this.labelingInfo;return a&&a.hasGeometryOperations&&
a.hasGeometryOperations()||b&&b.hasGeometryOperations&&b.hasGeometryOperations()||h.some(c,function(d){return X.hasGeometryOperations(d.labelExpressionInfo&&d.labelExpressionInfo.expression)})?!0:!1},_forceIdentity:function(){var a=new C,b=this,c=this._url&&this._url.path;var d=c&&c.toLowerCase().indexOf("/rest/services");var e=this.editFieldsInfo;e=e&&(e.creatorField||e.editorField);(this.userIsAdmin||e)&&!this._getToken()&&-1<d&&L.id?(d=c.substring(0,d)+"/rest/info",G({url:d,content:{f:"json"},
handleAs:"json",callbackParamName:"callback"}).then(function(f){if(f.owningSystemUrl)return L.id.checkSignInStatus(f.owningSystemUrl+"/sharing")}).then(function(f){if(f)return L.id.getCredential(c)}).then(function(f){f&&b._findCredential()}).always(function(){a.resolve()})):a.resolve();return a.promise},_isSnapshotMode:function(){return this._mode?this._mode.isInstanceOf(N):!1},_isOnDemandMode:function(){return this._mode?this._mode.isInstanceOf(R):!1},_isAutoSnapshotMode:function(){return this._isAutoModeEnabled()&&
this.currentMode===q.MODE_SNAPSHOT},_getMaxFeaturesForAutoSnapshotMode:function(){var a=this.geometryType;if("esriGeometryPolyline"===a||"esriGeometryPolygon"===a||"esriGeometryMultipoint"===a||this.hasXYFootprint())var b=this.maxRecordCountForAuto;else"esriGeometryPoint"===a&&(b=this.maxPointCountForAuto);return b},getLastExceedsLimitResult:function(){return this._lastExceedsLimitResult},_canUseSnapshotMode:function(a){this._lastExceedsLimitResult=a=(a=a&&a.features&&a.features[0])&&a.attributes&&
a.attributes.exceedslimit;return!(this.mode!==q.MODE_AUTO||this.isEditable()||0!==a||!(this._isPaginationAllowed()||this.maxRecordCount>=this._getMaxFeaturesForAutoSnapshotMode()))},_evalModeFromFLimit:function(a){this._canUseSnapshotMode(a)?this._enableAutoSnapshotMode():this._enableAutoOnDemandMode()},_enableAutoSnapshotMode:function(){var a=q.MODE_SNAPSHOT;this.isFeatureReductionApplied()?this._updatePreFReductionState(a):this._preSurfaceChangeState?(this._updatePreSurfaceChangeState(a),this._evalSurfaceType(!0)):
this.currentMode!==a&&this._setFetchMode(q.MODE_AUTO,a)},_enableAutoOnDemandMode:function(){var a=q.MODE_ONDEMAND;this.isFeatureReductionApplied()?this._updatePreFReductionState(a):this._preSurfaceChangeState?this._updatePreSurfaceChangeState(a):this.currentMode!==a&&(this._setFetchMode(q.MODE_AUTO,a),this._evalSurfaceType())},_evalModeFromFReduction:function(a){this.loaded&&(a&&this.isFeatureReductionEnabled()&&this._canCluster(a)?this._enableFReductionMode():this._disableFReductionMode())},_enableFReductionMode:function(){this._evalSurfaceType(!0);
if(!this._preFReductionState){var a=this.currentMode;a!==q.MODE_SNAPSHOT&&a!==q.MODE_STREAM&&a!==q.MODE_SELECTION&&(this._preFReductionState={mode:this.mode,currentMode:this.currentMode},this._setFetchMode(this.mode===q.MODE_AUTO?q.MODE_AUTO:q.MODE_SNAPSHOT,q.MODE_SNAPSHOT))}},_disableFReductionMode:function(){var a=this._preFReductionState;this._preFReductionState=null;!a||a.mode===this.mode&&a.currentMode===this.currentMode||(this._setFetchMode(a.mode,a.currentMode),this._evalSurfaceType())},_updatePreFReductionState:function(a){this._preFReductionState=
this._preFReductionState||{};this._preFReductionState.mode=q.MODE_AUTO;this._preFReductionState.currentMode=a},_evalModeFromSurface:function(){this.hasWebGLSurface()?this._enableWebGLSurfaceMode():this._disableWebGLSurfaceMode()},_enableWebGLSurfaceMode:function(){this._preSurfaceChangeState||(this._preSurfaceChangeState={mode:this.mode,currentMode:this.currentMode},this._setFetchMode(this.mode===q.MODE_AUTO?q.MODE_AUTO:q.MODE_ONDEMAND,q.MODE_ONDEMAND,this.webglDeps.OnDemandDrillMode))},_disableWebGLSurfaceMode:function(){var a=
this._preSurfaceChangeState;a&&(this._preSurfaceChangeState=null,this._setFetchMode(a.mode,a.currentMode))},_updatePreSurfaceChangeState:function(a){this._preSurfaceChangeState=this._preSurfaceChangeState||{};this._preSurfaceChangeState.mode=q.MODE_AUTO;this._preSurfaceChangeState.currentMode=a},_setFetchMode:function(a,b,c){this.clearSelection();this._mode.suspend();this._mode.destroy();this.mode=a;this.currentMode=b;c=c||this._getModeConstructor(b);this._mode=new c(this);this.queryPagination=b===
q.MODE_ONDEMAND&&-1===c.prototype.declaredClass.toLowerCase().indexOf("ondemanddrillmode")?!1:this._isPaginationAllowed();(a=this.getMap())&&a.loaded&&(this._resetMaxAllowableOffset(),this._mode.initialize(a),this._mode.startup())},_isPaginationAllowed:function(){return!(!this._optQueryPagination||this.loaded&&!this.advancedQueryCapabilities.supportsPagination)},_getModeConstructor:function(a){var b;a===q.MODE_SNAPSHOT?b=N:a===q.MODE_ONDEMAND&&(b=R);return b},_hasOnDemandDrillMode:function(){var a=
this._mode;a=a&&a.declaredClass;return!!(a&&-1<a.toLowerCase().indexOf("ondemanddrillmode"))},_checkFeatureLimit:function(){this._limitPromise&&(this._limitPromise.cancel(),this._limitPromise=null);var a=this._queryLimit();a&&(this._lastExceedsLimitResult=null,this._limitPromise=a.then(r.hitch(this,function(b){var c=this.currentMode;this._evalModeFromFLimit(b);return{modeChanged:this.currentMode!==c}})).always(r.hitch(this,function(b){this._limitPromise=null;return b})));return this._limitPromise},
_hasPendingLimitQuery:function(){return!!this._exceedsLimitTimer},_queryLimit:function(){if(this._isAutoModeEnabled()){var a,b,c=new C(function(){clearTimeout(a);a=null;b&&!b.isFulfilled()&&b.cancel();b=null});this._exceedsLimitTimer=a=setTimeout(r.hitch(this,function(){this._exceedsLimitTimer=null;var d=new Q,e=new sa;e.statisticType="exceedslimit";e.maxPointCount=this.maxPointCountForAuto;e.maxRecordCount=this.maxRecordCountForAuto;e.maxVertexCount=this.maxVertexCountForAuto;e.outStatisticFieldName=
"exceedslimit";d.outStatistics=[e];b=this.queryFeatures(d).promise.then(function(f){c.resolve(f)}).otherwise(function(f){c.reject(f)})}),0);return c.promise}},_isAutoModeEnabled:function(){return this.mode===q.MODE_AUTO&&this.reHostedFS.test(this.url)},_updateCaps:function(){var a=this._editable,b=r.trim(this.capabilities||""),c=h.map(b?b.split(","):[],r.trim),d=h.map(b?b.toLowerCase().split(","):[],r.trim);b=h.indexOf(d,"editing");var e;d={Create:h.indexOf(d,"create"),Update:h.indexOf(d,"update"),
Delete:h.indexOf(d,"delete")};if(a&&-1===b)c.push("Editing");else if(!a&&-1<b){a=[b];for(e in d)-1<d[e]&&a.push(d[e]);a.sort();for(e=a.length-1;0<=e;e--)c.splice(a[e],1)}this.capabilities=c.join(",")},_counter:{value:0},_getUniqueId:function(){return this._counter.value++},onSuspend:function(){this.inherited(arguments);this._suspendImpl()},_suspendImpl:function(a){this._toggleTime(!1);this._refreshHandle&&(this._refreshHandle.remove(),this._refreshHandle=null);var b=this._mode;b&&(b.suspend(),a&&
b.destroy())},onResume:function(a){this.inherited(arguments);this._toggleTime(!0);this._refreshHandle=this.on("feature-updates-result",r.hitch(this,this._evalRefresh));var b=this._map,c=this._getRenderer();if(a.firstOccurrence){if(this._fixRendererFields(),this._updateRequiredFieldsFromLabelingInfo(),this._checkFields(),this.clearSelection(),this._evalFeatureReduction(),this.timeInfo&&!this._trackManager&&(this._trackIdField||c&&(c.latestObservationRenderer||c.trackRenderer))&&(this._trackManager=
new aa(this),this._trackManager.initialize(b),this._childLayer=this._trackManager.container),c&&"colors"in c&&"blurRadius"in c&&"maxPixelIntensity"in c&&"esriGeometryPoint"==this.geometryType&&!this._heatmapManager&&(this._heatmapManager=new ba(this),this._heatmapManager.initialize(b)),this._zoomConnect=I.connect(b,"onZoomEnd",this,this._zoomEndHandler),this._refreshMaxAllowableOffset(),c=this._mode)c._init||c.initialize(b),c.startup()}else this._zoomEndHandler(),this._mode&&this._mode.resume()},
_zoomEndHandler:function(){var a=this._map;this._updateMaxOffset();this._prevScale=a.getScale();!this.suspended&&this._needsRefresh&&this.refresh()},_updateMaxOffset:function(){var a=this._map;a&&a.loaded&&this._autoGeneralize&&(this._isAutoSnapshotMode()?(a=this.getMaxAllowableOffset(),this._setMaxOffset(this._getMaxOffsetForScale(),!0),this._needsRefresh||(this._needsRefresh=a!=this.getMaxAllowableOffset())):this._setMaxOffset(a.extent.getWidth()/a.width,!a.extent.spatialReference.isWebMercator()))},
_getMaxOffsetForScale:function(){if(this._map){var a=this._map.getScale(),b=this._calculatedScale,c=this._calcMaxOffset,d=this._prevScale;return a>=b&&(null==d||d<b)?c:a<b&&(null==d||d>=b)?null:this.getMaxAllowableOffset()}},_calcMaxOffsetForAutoSnapshot:function(){var a=this._map;if(a&&this._canAutoGeneralize()&&this._isAutoSnapshotMode()&&this._autoGeneralize&&null==this.getMaxAllowableOffset()){var b=this.generalizeForScale;this._calculatedScale=b=this.maxScale?this.maxScale:this.minScale?Math.min(b,
this.minScale):Math.min(b,va.getScale(a,this.initialExtent));this._calcMaxOffset=a.extent.getWidth()/a.width/a.getScale()*b}else this._calculatedScale=this._calcMaxOffset=void 0},_toggleTime:function(a){var b=this._map;a&&this.timeInfo&&this.useMapTime&&b?(this._mapTimeExtent=b.timeExtent,this._timeConnect||(this._timeConnect=I.connect(b,"onTimeExtentChange",this,this._timeChangeHandler))):(this._mapTimeExtent=null,I.disconnect(this._timeConnect),this._timeConnect=null)},_timeChangeHandler:function(a){this._mapTimeExtent=
a;(a=this._mode)&&a.propertyChangeHandler(0)},_getOffsettedTE:function(a){var b=this._timeOffset,c=this._timeOffsetUnits;return a&&b&&c?a.offset(-1*b,c):a},_getTimeOverlap:function(a,b){return a&&b?a.intersection(b):a||b},_getTimeFilter:function(a){var b=this.getTimeDefinition();if(b){var c=this._getTimeOverlap(b,null);if(!c)return[!1]}if(a){if(a=c?this._getTimeOverlap(a,c):a,!a)return[!1]}else a=c;return[!0,a]},_getAttributeFilter:function(a){var b=[],c=this.getDefinitionExpression();c&&b.push(c);
a&&b.push(a);this.subtypeField&&this.subtypeCode&&b.push(this.subtypeField+" \x3d "+this.subtypeCode);1<b.length&&(b=h.map(b,function(d){return"("+d+")"}));return b.length?b.join(" AND "):null},_applyQueryFilters:function(a,b){a.where=this._getAttributeFilter(a.where);a.returnGeometry&&null==a.maxAllowableOffset&&!a.quantizationParameters&&(a.maxAllowableOffset=this._maxOffset,a.quantizationParameters=this._quantizationParameters);b&&this.supportsAdvancedQueries&&(a.orderByFields=a.orderByFields||
this.getOrderByFields());if(this.timeInfo)if(b=this._getTimeFilter(a.timeExtent),b[0])a.timeExtent=b[1];else return!1;return!0},_add:function(a){var b=this._selectionSymbol,c=a.attributes,d=this.visibilityField;b&&this._isSelOnly&&a.setSymbol(b);if(d&&c&&c.hasOwnProperty(d))a[c[d]?"show":"hide"]();return this.add.apply(this,arguments)},_remove:function(){return this.remove.apply(this,arguments)},_canDoClientSideQuery:function(a,b){var c=[],d=this._map,e;if((this._collection||!this._isTable&&d)&&!(a.text||
a.where&&a.where!==this.getDefinitionExpression()||a.orderByFields&&a.orderByFields.length&&(e=this.getOrderByFields()||[])&&a.orderByFields.join()!==e.join()||a.outStatistics||a.returnDistinctValues)){e=this._isSnapshotMode();var f=this._isSelOnly;b=e?null:b?this._getExtentOfTiles(d.extent):d.extent;if(d=a.geometry){if(f||a.spatialRelationship!==Q.SPATIAL_REL_INTERSECTS||"extent"!==d.type||!e&&!b.contains(d))return;c.push(1)}if(b=a.objectIds)if(e)c.push(2);else{d=b.length;var g=this._mode,k=0,n;
for(n=0;n<d;n++)g._getFeature(b[n])&&k++;if(k===d)c.push(2);else return}if(this.timeInfo)if(a=a.timeExtent,b=this._mapTimeExtent,e)a&&c.push(3);else if(f){if(a)return}else if(b)if(-1!==h.indexOf(c,2))a&&c.push(3);else if(-1!==h.indexOf(c,1))a==b&&c.push(3);else return;else if(0<c.length)a&&c.push(3);else if(a)return;return 0<c.length?c:null}},_getAbsMid:function(a){return S.toAbsMid?S.toAbsMid(a):ca.id.replace(/\/[^\/]*$/ig,"/")+a},_doQuery:function(a,b,c){var d=[],e=this.objectIdField,f=this,g=new C,
k=new C,n=this.graphics;if(-1!==h.indexOf(b,1)){var l=this.spatialIndex||this._map&&this._map.spatialIndex,t,p=a.geometry._normalize(null,!0);null==l&&Ja.autoSpatialIndexing?t=(this._map||this).addPlugin(this._getAbsMid("../plugins/spatialIndex")).then(r.hitch(this,r.partial(this._getFromIndex,p,l)),function(m){k.resolve(r.hitch(this,r.partial(this._filterByExtent,n,p)))}):l&&(t=this._getFromIndex(p,l));t?t.then(function(m){for(var u=0;u<m.length;u++)m[u].results&&(d=d.concat(m[u].results));k.resolve(d)}).otherwise(function(m){k.reject(m)}):
k.resolve(this._filterByExtent(n,p))}else k.resolve(n);k.then(function(m){d=m;if(-1!==h.indexOf(b,2)){var u=a.objectIds;d=h.filter(d,function(v){return-1<h.indexOf(u,v.attributes[e])})}-1!==h.indexOf(b,3)&&f.timeInfo&&(m=a.timeExtent,d=f._filterByTime(d,m.startTime,m.endTime).match);c&&(d=h.map(d,function(v){return v.attributes[e]},this));g.resolve(d)});return g},_getFromIndex:function(a,b){b=b||this.spatialIndex||this._map.spatialIndex;a instanceof Array||(a=[a]);var c=this.id;return ia(h.map(a,
function(d){return b.intersects(d,c)}))},_filterByExtent:function(a,b){for(var c=[],d=0,e=a.length;d<e;d++){var f=a[d],g=f.geometry;g&&(this.normalization&&b.length?(b[0].intersects(g)||b[1].intersects(g))&&c.push(f):b.intersects(g)&&c.push(f))}return c},_filterByTime:function(a,b,c){var d=this._startTimeField,e=this._endTimeField,f;this._twoTimeFields||(f=d||e);var g=z.isDefined,k=[],n=[],l,t=a.length;b=b?b.getTime():-Infinity;c=c?c.getTime():Infinity;if(f)for(l=0;l<t;l++){var p=a[l];var m=p.attributes;
d=m[f];d>=b&&d<=c?k.push(p):n.push(p)}else for(l=0;l<t;l++)p=a[l],m=p.attributes,f=m[d],m=m[e],f=g(f)?f:-Infinity,m=g(m)?m:Infinity,f>=b&&f<=c||m>=b&&m<=c||b>=f&&c<=m?k.push(p):n.push(p);return{match:k,noMatch:n}},_getSizeVariables:function(a){return a&&h.filter(a.getVisualVariablesForType("sizeInfo",!1),function(b){return!(!b.field&&!b.valueExpression)})},_needClientSideSorting:function(a){return this._collection?!(!a||!a.length):h.some(a,function(b){return!!b.valueExpression})},_sortFeatures:function(a){var b=
this.renderer,c=this._getSizeVariables(b);if(a&&1<a.length&&this._needClientSideSorting(c)){var d=c[0],e=this;a.sort(function(f,g){f._layer||(f._layer=e);g._layer||(g._layer=e);f=b._getDataValue(f,d,"sizeInfo");g=b._getDataValue(g,d,"sizeInfo");return null==f?-1:null==g?1:g-f})}return a},_resolve:function(a,b,c,d,e){b&&this[b].apply(this,a);c&&c.apply(null,a);d&&H._resDfd(d,a,e)},_getShallowClone:function(a){var b=new Q,c;for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},_canFetchPBF:function(){return!!(Ka&&
La&&this.supportsFormatPBF)},_canFetchPBFForQuery:function(a){return!(!this._canFetchPBF()||!this._isCacheHintEnabled(a)&&this._isAutoSnapshotMode()||!(a.quantizationParameters||!this.isEditable()&&this.supportsQuantizationEditMode)||a.outStatistics)},_enableEditModeQuantization:function(a,b){a&&b&&!a.quantizationParameters&&(a.quantizationParameters={mode:"edit"})},_enableCacheHint:function(a,b){var c=this.advancedQueryCapabilities;c&&c.supportsQueryWithCacheHint?null==a.cacheHint&&(a.cacheHint=
!0):c&&c.supportsQueryWithResultType&&this.reHostedFS.test(this.url)&&!a.resultType&&(a.resultType=b||"coherent")},_isCacheHintSupported:function(){var a=this.advancedQueryCapabilities;return a?!!(a.supportsQueryWithCacheHint||a.supportsQueryWithResultType&&this.reHostedFS.test(this.url)):!1},_isCacheHintEnabled:function(a){var b=this.advancedQueryCapabilities;return a&&b?!!(b.supportsQueryWithCacheHint&&a.cacheHint||b.supportsQueryWithResultType&&this.reHostedFS.test(this.url)&&("coherent"===a.resultType||
"tile"===a.resultType)):!1},_query:function(a,b,c,d,e,f){var g=this,k=this._map;f=f&&f.snapToTiles;var n=new C(H._dfdCanceller),l=c,t,p,m;if("executeRelationshipQuery"!==a){l=this._getShallowClone(c);var u=this.getOutFields();l.outFields||(l.outFields=u);l.outFields&&l.outFields.length&&(p=-1<h.indexOf(u,"*")?!1:!h.every(l.outFields,function(x){return-1<h.indexOf(u,x)}));l.returnGeometry=c.hasOwnProperty("returnGeometry")?c.returnGeometry:!c.outStatistics;l.returnGeometry&&(l.multipatchOption=this.multipatchOption,
null!=l.maxAllowableOffset||l.quantizationParameters)&&(c=null!=l.maxAllowableOffset?l.maxAllowableOffset:l.quantizationParameters.tolerance,null!=c&&c!==this.getMaxAllowableOffset()&&(m=!0));k&&(k=k&&k.spatialReference,(c=l.outSpatialReference)?t=!c.equals(k):l.outSpatialReference=new P(k.toJson()));f&&(k=l.geometry)&&"extent"===k.type&&(l.geometry=this._getExtentOfTiles(k),k!==l.geometry&&this._enableCacheHint(l));if(!this._applyQueryFilters(l,"execute"===a&&!l.outStatistics)){switch(a){case "execute":var v=
new M({features:[]});break;case "executeForIds":v=[];break;case "executeForCount":v=0;break;case "executeForExtent":v={}}this._resolve([v],b,d,n);return n}if(f="executeForExtent"!==a&&!t&&!p&&!m&&this._canDoClientSideQuery(l,f))return n._pendingDfd=T(this._doQuery(l,f,"executeForIds"===a||"executeForCount"===a)),n._pendingDfd.then(function(x){switch(a){case "execute":v=new M;v.features=x;break;case "executeForIds":v=x;break;case "executeForCount":v=x.length}g._resolve([v],b,d,n)}),n}if(this._collection)return this._resolve([Error("FeatureLayer::_query - "+
this.invalidParams)],null,e,n,!0),n;if(this.loaded&&!this.isQueryable())return this._resolve([Error("Layer does not support query capability.")],null,e,n,!0),n;this._ts&&(l._ts=(new Date).getTime());f="execute"===a&&this._canFetchPBFForQuery(l);this._enableEditModeQuantization(l,f);(n._pendingDfd=this._task[a](l,null,null,f?{format:"pbf"}:null)).addCallbacks(function(x){var A=!!l.outStatistics||t||p||m;if("execute"===a||"executeRelationshipQuery"===a)if("execute"===a){var w=x.features;var y=w.length;
for(--y;0<=y;y--)if(w[y]._layer=g,!A&&!g._isTable){var F=g._mode._getFeature(w[y].attributes[g.objectIdField]);F&&w.splice(y,1,F)}}else for(F in x)if(x.hasOwnProperty(F))for(w=x[F].features,y=w.length,--y;0<=y;y--)w[y]._layer=g;g._resolve([x],b,d,n)},function(x){g._resolve([x],null,e,n,!0)});return n},_getExtentOfTiles:function(a){var b=this._isOnDemandMode()&&this._mode._gridLayer||Ga.createFromFeatureLayer({layer:this}),c=this.getMap();c=c&&c.getTargetExtent(a);return b&&c&&b.getExtentOfIntersectingCells(c)||
a},_convertFeaturesToJson:function(a,b,c,d){var e=[],f=this._selectionSymbol,g=this.visibilityField,k,n=this.objectIdField;this.loaded&&(c||d)&&(k=h.filter(this.fields,function(v){return!1===v.editable&&(!d||v.name!==n)}));for(c=0;c<a.length;c++){var l=a[c],t={},p=l.geometry,m=l.attributes,u=l.symbol;!p||d&&this.loaded&&!this.allowGeometryUpdates||(t.geometry=p.toJson());g?(t.attributes=m=r.mixin({},m),m[g]=l.visible?1:0):m&&(t.attributes=r.mixin({},m));t.attributes&&k&&k.length&&h.forEach(k,function(v){delete t.attributes[v.name]});
u&&u!==f&&(t.symbol=u.toJson());e.push(t)}return b?e:K.toJson(e)},_selectHandler:function(a,b,c,d,e){switch(b){case q.SELECTION_NEW:this.clearSelection(!0);var f=!0;break;case q.SELECTION_ADD:f=!0;break;case q.SELECTION_SUBTRACT:f=!1}d=a.features;var g=this._mode,k=[],n=this.objectIdField;if(f)for(f=0;f<d.length;f++){var l=d[f];var t=l.attributes[n];l=g._addFeatureIIf(t,l);k.push(l);this._selectFeatureIIf(t,l,g)}else for(f=0;f<d.length;f++)l=d[f],t=l.attributes[n],this._unSelectFeatureIIf(t,g),t=
g._removeFeatureIIf(t),k.push(t||l);this._isSelOnly&&g._applyTimeFilter(!0);this._isImageService&&10.7>this.version&&void 0===a.exceededTransferLimit&&(a.exceededTransferLimit=d.length===this.maxRecordCount);this._hasPartialSelectedFeatures=!!a.exceededTransferLimit;this._resolve([k,b,a.exceededTransferLimit?{queryLimitExceeded:!0}:null],"onSelectionComplete",c,e);if(a.exceededTransferLimit)this.onQueryLimitExceeded()},_selectFeatureIIf:function(a,b,c){var d=this._selectedFeatures,e=d[a];e||(c._incRefCount(a),
d[a]=b,this._isTable||(this._setSelectSymbol(b),b.attr("data-selected","")));return e||b},_unSelectFeatureIIf:function(a,b){var c=this._selectedFeatures[a];c&&(b._decRefCount(a),delete this._selectedFeatures[a],this._isTable||(this._setUnSelectSymbol(c),c.attr("data-selected")));return c},_setSelectSymbol:function(a){var b=this._selectionSymbol;b&&!this._isSelOnly&&a.setSymbol(b)},_setUnSelectSymbol:function(a){var b=this._selectionSymbol;b&&!this._isSelOnly&&b===a.symbol&&a.setSymbol(null,!0)},_getOutFields:function(){var a=
[this.objectIdField,this.typeIdField,this.creatorField,this._startTimeField,this._endTimeField,this._trackIdField].concat(this._requiredFields).concat(this.dataAttributes);a=h.filter(a,function(c,d,e){return!!c&&h.indexOf(e,c)===d});var b=r.clone(this._outFields);if(b){if(-1!==h.indexOf(b,"*"))return b;h.forEach(a,function(c){-1===h.indexOf(b,c)&&b.push(c)});return b}return a},_checkFields:function(a){var b=a||this._getOutFields();h.forEach(b,function(c){"*"!==c&&(this._getField(c)||console.debug("esri.layers.FeatureLayer: "+
z.substitute({url:this.url,field:c},"unable to find '${field}' field in the layer 'fields' information [url: ${url}]")))},this);a||this._isTable||this._fserver||this._collection||this._isStream||h.some(this.fields,function(c){return c&&"esriFieldTypeGeometry"===c.type?!0:!1})||console.debug("esri.layers.FeatureLayer: "+z.substitute({url:this.url},"unable to find a field of type 'esriFieldTypeGeometry' in the layer 'fields' information. If you are using a map service layer, features will not have geometry [url: ${url}]"))},
_fixFieldCase:function(a,b,c){var d=a&&a[b],e;if(d&&!r.isFunction(d)){if(e=!this._getField(d)&&this._getField(d,!0))d=a[b]=e.name;c&&c.push(d)}return d},_fixRendererFields:function(){var a=this.renderer;this._orderBy=null;this._requiredFields=[];if(a&&0<this.fields.length){var b=[],c;a=h.filter([a,a.observationRenderer,a.latestObservationRenderer,a.trackRenderer],z.isDefined);var d=[].concat(a);h.forEach(a,function(e){h.forEach(e.rendererInfos,function(f){f.renderer&&d.push(f.renderer)})});h.forEach(d,
function(e){this._fixFieldCase(e,"attributeField",b);this._fixFieldCase(e,"attributeField2",b);this._fixFieldCase(e,"attributeField3",b);this._fixFieldCase(e.rotationInfo,"field",b);(c=this._fixFieldCase(e.sizeInfo,"field",b))&&!this._orderBy&&(this._orderBy=[c+" DESC"]);this._fixFieldCase(e.sizeInfo,"normalizationField",b);this._fixFieldCase(e.colorInfo,"field",b);this._fixFieldCase(e.colorInfo,"normalizationField",b);this._fixFieldCase(e.field,"field",b);this._fixFieldCase(e.opacityInfo,"field",
b);this._fixFieldCase(e.opacityInfo,"normalizationField",b);h.forEach(e.visualVariables,function(g){c=this._fixFieldCase(g,"field",b);"sizeInfo"===g.type&&c&&!this._orderBy&&(this._orderBy=[c+" DESC"]);this._fixFieldCase(g,"normalizationField",b)},this);var f=h.map(this.fields,function(g){return g.name},this);f=h.map(e.getFieldsUsedInExpressions(f),function(g){var k=this.getField(g);return k?k.name:g},this);b=b.concat(f);this._orderBy||!e.addBreak||r.isFunction(e.attributeField)||!e.backgroundFillSymbol&&
!this._hasSizeDiff(e)||(this._orderBy=[e.attributeField+" DESC"])},this);this._requiredFields=h.filter(b,z.isDefined)}},_hasSizeDiff:function(a){var b=Number.MAX_VALUE,c=-Number.MAX_VALUE,d,e;h.forEach(a.infos,function(f){if(e=f.symbol){d=0;switch(e.type){case "simplemarkersymbol":d=e.size;break;case "picturemarkersymbol":d=(e.width+e.height)/2;break;case "simplelinesymbol":case "cartographiclinesymbol":d=e.width;break;case "simplefillsymbol":case "picturefillsymbol":d=e.outline&&e.outline.width}d&&
(b=Math.min(b,d),c=Math.max(c,d))}});return b!==Number.MAX_VALUE&&c!==-Number.MAX_VALUE&&1<Math.abs(c-b)},getOrderByFields:function(){var a=this.orderByFields||this._orderBy;return this.supportsAdvancedQueries&&a?h.filter(a,function(b){b=b.split(" ")[0];return!!this._getField(b,!0)},this):null},_createFields:function(a){var b=a?a.length:0,c,d=[];for(c=0;c<b;c++)d.push(new xa(a[c]));this.fields=d},_createFieldsIndex:function(){if(this._fieldsIndexDirty){var a=this.fields,b=a?a.length:0;if(50<b&&this._canUseFieldsIndex()){var c=
new Map;for(var d=new Map,e=0;e<b;e++){var f=a[e];c.set(f.name,f);d.set(f.name.toLowerCase(),f)}c={caseSensitive:c,caseInsensitive:d}}this._fieldsIndex=c;this._fieldsIndexDirty=!1}},_canUseFieldsIndex:function(){var a=O.Map;return!("function"!==typeof O.Proxy||"function"!==typeof O.Proxy.revocable||"function"!==typeof a||!a.prototype||"function"!==typeof a.prototype.set)},_getField:function(a,b){var c=this.fields;if(!c||0===c.length)return null;b&&(a=a.toLowerCase());this._createFieldsIndex();var d=
this._fieldsIndex;if(d)return d=b?d.caseInsensitive:d.caseSensitive,d.get(a);var e;h.some(c,function(f){var g=!1;(g=b?f&&f.name.toLowerCase()===a?!0:!1:f&&f.name===a?!0:!1)&&(e=f);return g});return e},_getDateOpts:function(){this._dtOpts||(this._dtOpts={properties:h.map(h.filter(this.fields,function(a){return!(!a||"esriFieldTypeDate"!==a.type)}),function(a){return a.name})});return this._dtOpts},_applyNormalized:function(a,b){a&&b&&h.forEach(a,function(c,d){c&&b[d]&&c.setGeometry(b[d])})},_editHandler:function(a,
b,c,d,e,f){e=a.addResults;var g=a.updateResults;a=a.deleteResults;var k,n=this.objectIdField,l=this._mode,t=this._isTable;var p=this.editFieldsInfo;var m=this.getOutFields()||[];var u=p&&p.creatorField,v=p&&p.creationDateField,x=p&&p.editorField,A=p&&p.editDateField;p=p&&p.realm;-1===h.indexOf(m,"*")&&(u&&-1===h.indexOf(m,u)&&(u=null),v&&-1===h.indexOf(m,v)&&(v=null),x&&-1===h.indexOf(m,x)&&(x=null),A&&-1===h.indexOf(m,A)&&(A=null));var w=v||A?(new Date).getTime():null,y=u||x?this.getUserId():void 0;
y&&p&&(y=y+"@"+p);if(e){var F=this.globalIdField;for(p=0;p<e.length;p++)if(e[p]=new J(e[p]),!t){var D=e[p];if(D.success){var B=D.objectId;m=b[p];(k=m._graphicsLayer)&&k!==this&&k.remove(m);k=m.attributes||{};k[n]=B;B=D.globalId;F&&B&&(k[F]=B);u&&(k[u]=y);x&&(k[x]=y);v&&(k[v]=w);A&&(k[A]=w);m.setAttributes(k);l._init&&l.drawFeature(m)}}}if(g)for(p=0;p<g.length;p++)if(g[p]=new J(g[p]),!t&&(D=g[p],D.success)){B=D.objectId;m=c[B];if(b=l._getFeature(B))b.geometry!==m.geometry&&m.geometry&&b.setGeometry(ta.fromJson(m.geometry.toJson())),
b.attributes!==m.attributes&&m.attributes&&b.setAttributes(r.mixin(b.attributes,m.attributes)),this._repaint(b,B);m=b||m;k=m.attributes||{};x&&(k[x]=y);A&&(k[A]=w);m.setAttributes(k)}if(a){c=[];for(p=0;p<a.length;p++)if(a[p]=new J(a[p]),!t&&(D=a[p],D.success&&(B=D.objectId,m=l._getFeature(B))))this._unSelectFeatureIIf(B,l)&&c.push(m),m._count=0,l._removeFeatureIIf(B);if(0<c.length)this.onSelectionComplete(c,q.SELECTION_SUBTRACT)}this._resolve([e,g,a],"onEditsComplete",d,f)},_sendAttachment:function(a,
b,c,d,e){var f=this;return G({url:this._url.path+"/"+b+"/"+("add"===a?"addAttachment":"updateAttachment"),form:c,content:r.mixin(this._url.query,{f:"json",token:this._getToken()||void 0}),callbackParamName:"callback.html",handleAs:"json"}).addCallback(function(g){var k="add"===a?"onAddAttachmentComplete":"onUpdateAttachmentComplete";g=new J(g["add"===a?"addAttachmentResult":"updateAttachmentResult"]);g.attachmentId=g.objectId;g.objectId=b;f._resolve([g],k,d);return g}).addErrback(function(g){f._resolve([g],
null,e,null,!0)})},_repaint:function(a,b,c){b=z.isDefined(b)?b:a.attributes[this.objectIdField];b in this._selectedFeatures&&this._selectionSymbol||a.setSymbol(a.symbol,c)},_getKind:function(a){var b=this._trackManager;return b?b.isLatestObservation(a)?1:0:0}});r.mixin(q,{MODE_SNAPSHOT:0,MODE_ONDEMAND:1,MODE_SELECTION:2,SELECTION_NEW:3,SELECTION_ADD:4,SELECTION_SUBTRACT:5,MODE_AUTO:6,MODE_STREAM:7,POPUP_NONE:"esriServerHTMLPopupTypeNone",POPUP_HTML_TEXT:"esriServerHTMLPopupTypeAsHTMLText",POPUP_URL:"esriServerHTMLPopupTypeAsURL"});
ua._createWrappers(q);Object.defineProperty(q.prototype,"graphics",{get:function(){return this._hasOnDemandDrillMode()?this._mode.graphics:this._graphicsVal},set:function(a){this._graphicsVal=a}});Object.defineProperty(q.prototype,"name",{get:function(){return this.arcgisProps&&this.arcgisProps.title?this.arcgisProps.title:this._name},set:function(a){this._name=a;this.loaded&&this.arcgisProps&&(this.arcgisProps.title=null)}});Object.defineProperty(q.prototype,"fields",{get:function(){return this._fields},
set:function(a){a&&this._canUseFieldsIndex()&&(a=new Proxy(a,{set:r.hitch(this,function(b,c,d){if(c)if("length"===c)this._fieldsIndexDirty=!0;else{var e=Number(c);"number"!==typeof e||isNaN(e)||(this._fieldsIndexDirty=!0)}b[c]=d;return!0})}));this._fields=a;this._fieldsIndexDirty=!0}});E("extend-esri")&&r.setObject("layers.FeatureLayer",q,L);return q});