// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/WCSConnection","dojo/_base/declare dojo/_base/lang dojo/io-query dojo/has dojo/_base/Deferred dojo/DeferredList ../deferredUtils ../request ../kernel ./WCSCapabilities ./WCSCoverageDescription".split(" "),function(p,f,B,C,q,D,H,u,E,F,G){var v=function(b,c,d){var a;if(d)for(a=0;a<b.length;a++){if(b[a][d].toLowerCase()===c.toLowerCase())return b[a]}else for(a=0;a<b.length;a++)if(b[a].toLowerCase()===c.toLowerCase())return b[a]};p=p(null,{declaredClass:"esri.layers.WCSConnection",
url:null,supportedVersions:["1.0.0","1.1.0","1.1.1","2.0.1"],version:null,name:null,onlineResources:null,coverages:null,supportedFormats:null,profiles:null,supportedInterpolations:null,onConnected:null,constructor:function(b,c){if(b){var d=b.indexOf("?");-1<d&&d<=b.length-1?(this.optionalParameters=B.queryToObject(b.substring(d+1,b.length)),this.url=b.substring(0,d+1)):this.url=b}this.optionalParameters=this.optionalParameters||{};c&&f.mixin(this.optionalParameters,c);this.optionalParameters.version&&
(this.version=this.optionalParameters.version);var a=this.optionalParameters;Object.keys(a).forEach(function(h){a[h]||delete a[h]});this.connect=f.hitch(this,this.connect);this.url&&this.connect(this.version)},_getCapabilities:function(b){var c=new q,d=f.mixin({},this.optionalParameters);if(b)var a={version:b,AcceptVersions:b};var h=["service","request","coverageId","coverage","identifier"];Object.keys(d).forEach(function(g){h.some(function(l){return l.toLowerCase()===g.toLowerCase()})&&delete d[g]});
u({url:this.url,content:f.mixin({request:"GetCapabilities",service:"WCS"},d,a),handleAs:"xml"}).then(f.hitch(this,function(g){g=new F(g);c.resolve(g)}),function(g){c.reject(g)});return c.promise},_getCapabilitiesHelper:function(b){if(b)b=this._getCapabilities(b);else{var c=new q;b=c.promise;this._getCapabilities().then(f.hitch(this,function(d){!this.version&&-1<this.url.toLowerCase().indexOf("wcsserver")?1===d.supportedVersions.length&&"2.0.1"===d.supportedVersions[0]?this._getCapabilities().then(f.hitch(this,
function(a){c.resolve(a)}),f.hitch(this,function(a){c.reject(a)})):c.resolve(d):c.resolve(d)}),f.hitch(this,function(d){c.reject(d)}))}return b},_describeCoverage:function(){var b=new q,c=this.coverageId||this.optionalParameters.coverage||this.optionalParameters.coverageId||this.optionalParameters.identifiers||this.coverages.map(function(e){return e.id}).join(","),d=this.version,a={request:"DescribeCoverage",service:"WCS",version:d};switch(d){case "1.0.0":a=f.mixin(a,{coverage:c});break;case "1.1.0":case "1.1.1":case "1.1.2":a=
f.mixin(a,{identifiers:c});break;case "2.0.1":a=f.mixin(a,{coverageId:c})}var h=f.mixin({},this.optionalParameters),g=["service","request"];Object.keys(h).forEach(function(e){g.some(function(k){return k.toLowerCase()===e.toLowerCase()})&&delete h[e]});var l=u({url:this._onlineResources?this._onlineResources.describeCoverage:this.url,content:f.mixin(a,h),handleAs:"xml"});"2.0.1"===d&&(d=c,-1<c.indexOf(",")?d=c.split(",").map(function(e){return 0===e.toLowerCase().indexOf("coverage")?e.slice(8):e}).join(","):
0===c.toLowerCase().indexOf("coverage")&&(d=c.slice(8)),c=u({url:this._onlineResources?this._onlineResources.describeCoverage:this.url,content:f.mixin(a,h,{identifiers:d,version:"1.1.1"}),handleAs:"xml"}),l=new D([l,c]));l.then(f.hitch(this,function(e){if("2.0.1"===this.version){var k=e[0][0]&&e[0][1]?this._parseCoverageDescriptions(e[0][1],this.version):null;if((e=e[1][0]&&e[1][1]?this._parseCoverageDescriptions(e[1][1],"1.1.1"):null)&&e.length){var y,z,m,r,t;for(m=0;m<k.length;m++){var w=k[m].multidimensionalInfo;
var A=e[m].multidimensionalInfo;if(w&&A)for(t=0;t<w.variables.length;t++){var x=w.variables[t];if(y=v(A.variables,x.name,"name"))for(r=0;r<x.dimensions.length;r++){var n=x.dimensions[r];if(z=v(y.dimensions,n.name,"name"))n.values=n.values||z.values,n.values&&(n.hasRegularIntervals=!1)}}}}}else k=this._parseCoverageDescriptions(e,this.version);b.resolve(k)}),function(e){b.reject(e)});return b.promise},_parseCoverageDescriptions:function(b,c){var d,a=[];b="1.0.0"===c?b.getElementsByTagNameNS("*","CoverageOffering"):
b.getElementsByTagNameNS("*","CoverageDescription");for(d=0;d<b.length;d++)a.push(new G(b[d],c));return a},connect:function(b){var c=new q(function(){return"cancelled"});this._connectPromise&&this._connectPromise.cancel();this.version=(b=b||this.version)||this.version;var d=function(a){c.reject(a);this._connectPromise=null;if(this.onConnectionFailed)this.onConnectionFailed(a)};this._getCapabilitiesHelper(b).then(f.hitch(this,function(a){if(!c.isCanceled()){this.supportedInterpolations=a.supportedInterpolations;
this.supportedVersions=a.supportedVersions;-1<this.url.toLowerCase().indexOf("wcsserver")?("2.0.1"===this.supportedVersions[0]&&1===this.supportedVersions.length&&(this.supportedVersions=["1.0.0","1.1.0","1.1.1","2.0.1"]),this.version=this.version||a.version||this.supportedVersions.reduce(function(h,g){return h>g?h:g})):this.version=this.version||"1.0.0";this.name=this.name||a.name;this.version=this.version||a.version;this.onlineResources=this.onlineResources||a.onlineResources;this.coverages=this.coverages||
a.coverages;if(void 0===this.coverages||null===this.coverages||0===this.coverages.length)throw"No valid coverages";this.supportedFormats=this.supportedFormats||a.supportedFormats;this.profiles=this.profiles||a.profiles;this._describeCoverage().then(f.hitch(this,function(h){if(!c.isCanceled())if(h){if(h.forEach(f.hitch(this,function(g){g.lonLatEnvelope=v(this.coverages,g.id,"id").lonLatEnvelope||g.lonLatEnvelope})),this.coverages=h,c.resolve(this),this._connectPromise=null,this.onConnected)this.onConnected()}else d("cannot parse coverage descriptions")}),
d)}}),d);return this._connectPromise=c.promise}});C("extend-esri")&&f.setObject("layers.WCSConnection",p,E);return p});