// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
require({cache:{"esri/layers/ImageServiceLayerMixin":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/Deferred dojo/_base/array dojo/_base/json dojo/_base/config dojo/_base/connect dojo/has dojo/io-query dojo/DeferredList ../kernel ../config ../lang ../request ../deferredUtils ../urlUtils ../geometry/Extent ../geometry/Point ../geometry/Polygon ../renderers/colorRampUtils ./MosaicRule ./RasterFunction ./DimensionalDefinition ./Raster ./PixelBlock ./pixelFilters/VectorFieldPixelFilter ./rasterFormats/ImageCanvasDecoder ./TimeInfo ./Field ../graphic ../tasks/ImageServiceIdentifyTask ../tasks/ImageServiceIdentifyParameters".split(" "),
function(L,z,H,e,b,d,g,f,h,n,p,k,t,u,r,A,x,E,M,Q,S,N,I,P,K,G,R,m,v,D,F,C){L=L(null,{declaredClass:"esri.layers.ImageServiceLayerMixin",_rasterFieldPrefix:"Raster.",_renderingRuleFieldSubPrefix:"ServicePixelValue.",_rasterFunctionServiceInfoProps:"bandCount pixelType hasRasterAttributeTable hasColormap hasHistograms minValues maxValues meanValues stdvValues serviceDataType".split(" "),_pixelTypeRanges:{U1:[0,1],U2:[0,3],U4:[0,15],U8:[0,255],S8:[-128,127],U16:[0,65535],S16:[-32768,32767]},_eventMap:{"rendering-change":!0,
"mosaic-rule-change":!0,"spatial-reference-change":!0,"renderer-change":!0},_cachedVariableStats:{},_cachedVariableHistogram:{},constructor:function(a,c){this.useMapTime=c&&c.hasOwnProperty("useMapTime")?!!c.useMapTime:!0},_initialize:function(a,c){this._url=A.urlToObject(a);this.raster=new P(this._url.path);this._rasterFunctionTemplateInfos={};this._customRenderingRuleId={};this.infoTemplate=c&&c.infoTemplate;this.format=(a=c&&c.imageServiceParameters)&&a.format;this.compressionTolerance=a&&a.compressionTolerance?
a.compressionTolerance:.01;this.interpolation=a?a.interpolation:null;this.compressionQuality=a?a.compressionQuality:null;this.bandIds=a?a.bandIds:null;this.mosaicRule=a?a.mosaicRule:null;this.renderingRule=a?a.renderingRule:null;this.renderer=a?a.renderer:null;this.useMapDimensionValue=c&&c.hasOwnProperty("useMapDimensionValue")?!!c.useMapDimensionValue:!0;this.hasImageFilter=c&&c.hasImageFilter;this.activeMapDimensions=c&&c.activeMapDimensions;this._params=z.mixin({},this._url.query,{f:"image",interpolation:this.interpolation,
format:this.format,compressionQuality:this.compressionQuality,bandIds:this.bandIds?this.bandIds.join(","):null},a?a.toJson():{});this.pixelFilter=c&&c.pixelFilter;this.originalPixelData=this.pixelData=null;this.hasDataChanged=!0;this._requestDataHandler=z.hitch(this,this._requestDataHandler);this._requestDataErrorHandler=z.hitch(this,this._requestDataErrorHandler);this._rasterReadPromise=null;this._initLayer=z.hitch(this,this._initLayer);this._queryVisibleRastersHandler=z.hitch(this,this._queryVisibleRastersHandler);
this._visibleRasters=[];this._rasterAttributeTableFields=[];this._rasterAttributeTableFeatures=[];this._renderingRuleAttributeTable={};this._renderingRuleColormap={};this._useRenderingRuleAttributeTable=!1;this._loadCallback=c&&c.loadCallback;a&&a.renderer&&(a.renderer.outputUnit||a.renderer.inputUnit)&&(this.vectorFieldPixelFilter=new G,this.vectorFieldPixelFilter.setUnits(a.renderer.inputUnit,a.renderer.outputUnit));(c=c&&c.resourceInfo)?this._initLayer(c):u({url:this._url.path,content:z.mixin({f:"json"},
this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler});this.registerConnectEvents()},disableClientCaching:!1,_initLayer:function(a,c){if(null!==a&&void 0!==a){this._findCredential();(this.credential&&this.credential.ssl||a&&a._ssl)&&this._useSSL();c=this.minScale;var l=this.maxScale;z.mixin(this,a);this.minScale=c;this.maxScale=l;this.initialExtent=this.fullExtent=this.extent=new x(a.extent);this.spatialReference=this.initialExtent.spatialReference;this.pixelSizeX=
parseFloat(this.pixelSizeX);this.pixelSizeY=parseFloat(this.pixelSizeY);var q=this.minValues,w=this.maxValues,B=this.meanValues,y=this.stdvValues,O=this.bands=[];c=0;for(l=this.bandCount;c<l;c++)O[c]={min:q[c],max:w[c],mean:B[c],stddev:y[c]};this.timeInfo=(c=this.timeInfo)&&c.timeExtent?new m(c):null;l=this.fields=[];if(q=a.fields)for(c=0;c<q.length;c++)l.push(new v(q[c]));this._updateInfoTemplateFields(this.fields);this.version=a.currentVersion;this.version||(this.version="fields"in a||"objectIdField"in
a||"timeInfo"in a?10:9.3);t.isDefined(a.minScale)&&!this._hasMin&&"Raster"!==a.cacheType&&this.setMinScale(a.minScale);t.isDefined(a.maxScale)&&!this._hasMax&&"Raster"!==a.cacheType&&this.setMaxScale(a.maxScale);c={};a.defaultMosaicMethod?(c.method=a.defaultMosaicMethod,c.operation=a.mosaicOperator,c.sortField=a.sortField,c.sortValue=a.sortValue):c.method=S.METHOD_NONE;this.defaultMosaicRule=new S(c);this.defaultMosaicRule.ascending=!0;this._useRenderingRuleAttributeTable=10<this.version&&"esriImageServiceDataTypeThematic"===
this.serviceDataType;this._setDefaultRenderingRule(!0);this._getRenderingRuleAttributeTableAndColormap();this._isScientificData()&&(!this.mosaicRule||this.mosaicRule&&!this.mosaicRule.multidimensionalDefinition)&&this._setDefaultMultidimensionalDefinition(!0);10<this.version&&this.hasRasterAttributeTable&&this.getRasterAttributeTable().then(z.hitch(this,function(J){J&&(J.features&&J.fields&&(this.rasterAttributeTable=z.clone(J)),J.features&&0<J.features.length&&(this._rasterAttributeTableFeatures=
z.clone(J.features)),J.fields&&0<J.fields.length&&(this._rasterAttributeTableFields=z.clone(J.fields)),this.renderingRule||!this.renderer||"esri.renderer.ClassBreaksRenderer"!==this.renderer.declaredClass&&"esri.renderer.UniqueValueRenderer"!==this.renderer.declaredClass||this.refresh())}));this._initVectorPixelFilter();this.bandIds||2!==this.bandCount||this.renderingRule||"esri.layers.ArcGISImageServiceLayer"!==this.declaredClass||this.setBandIds([0,0,0],!0);!(10.3<=this.version&&this.rasterFunctionInfos&&
this.rasterFunctionInfos.length)||this._url.query&&this._url.query.raster||this.getRasterFunctionInfos().then(z.hitch(this,function(J){if(J&&J.length){this.rasterFunctionInfos=J;var W=[],X;e.forEach(J,function(V){if(V){var T=V.functionType;X=X||1===T||2===T;W.push(V.name)}},this);this._hasItemLevelRFT=X;this._rasterFunctionNames=W;X&&(this._initVectorPixelFilter(),this.refresh())}}));this.loaded=!0;this._setDefaultFilter();this.onLoad(this);if(a=this._loadCallback)delete this._loadCallback,a(this)}},
_updateInfoTemplateFields:function(a){if(a&&!(1>a.length)&&this.infoTemplate&&this.infoTemplate.info&&this.infoTemplate.info.fieldInfos&&!(1>this.infoTemplate.info.fieldInfos.length)){var c,l;var q=this.infoTemplate.info.fieldInfos;for(c=0;c<a.length;c++){var w=a[c];for(l=0;l<q.length;l++)if(q[l].fieldName.toLowerCase()===w.name.toLowerCase()&&q[l].fieldName!==w.name){q[l].fieldName=w.name;break}}}},getKeyProperties:function(a){var c=this._url.path+"/keyProperties",l=new H(r._dfdCanceller),q={f:"json"};
a&&a.renderingRule&&(q.renderingRule=b.toJson(a.renderingRule.toJson()));10<this.version?(l._pendingDfd=u({url:c,content:q,handleAs:"json",callbackParamName:"callback"}),l._pendingDfd.then(function(w){l.callback(w)},function(w){l.errback(w)})):(a=Error("Layer does not have key properties"),a.log=!!d.isDebug,l.errback(a));return l},getRasterAttributeTable:function(a){var c=this._url.path+"/rasterAttributeTable",l=new H(r._dfdCanceller),q={f:"json"},w=this.hasRasterAttributeTable;a&&a.renderingRule&&
(q.renderingRule=b.toJson(a.renderingRule.toJson()),w=!0);!this.loaded||10<this.version&&w?(l._pendingDfd=u({url:c,content:q,handleAs:"json",callbackParamName:"callback"}),l._pendingDfd.then(function(B){l.callback(B)},function(B){l.errback(B)})):(a=Error("Layer does not support raster attribute table"),a.log=!!d.isDebug,l.errback(a));return l},getRenderingRuleAttributeTable:function(a){var c=new H(r._dfdCanceller);if(!a||!a.renderingRule)return c.errback(Error("Rendering rule is not specified")),
c;a=a.renderingRule;var l=this._getRenderingRuleId(a);this._renderingRuleAttributeTable&&l&&this._renderingRuleAttributeTable.hasOwnProperty(l)?c.resolve(this._renderingRuleAttributeTable[l]):c=this.getRasterAttributeTable({renderingRule:a}).then(z.hitch(this,function(q){if(q&&q.features&&q.features.length&&q.fields&&q.fields.length){var w={features:z.clone(q.features),fields:z.clone(q.fields)};l&&(this._renderingRuleAttributeTable[l]=w)}return w}));return c},_initVectorPixelFilter:function(){var a;
this._hasItemLevelRFT&&this.renderingRule&&(a=this._getItemLevelRenderingRule(this.renderingRule));if(a=a||this.renderingRule)return this.getRenderingRuleServiceInfo(a).then(z.hitch(this,function(c){!c||!this._isVectorData(c)&&"esri.layers.ArcGISImageServiceVectorLayer"!==this.declaredClass||t.isDefined(this.pixelFilter)||(this.vectorFieldPixelFilter=this.vectorFieldPixelFilter||new G,this.vectorFieldPixelFilter.isDataUV="esriImageServiceDataTypeVector-UV"===c.serviceDataType,this.pixelFilter=this.vectorFieldPixelFilter.computeMagnitudeAndDirection,
this.getKeyProperties().then(z.hitch(this,this._setFlowRepresentation)),this._applyVectorResamplingType(c.serviceDataType))}))},_applyVectorResamplingType:function(a){if(a){var c=this.renderingRule;c&&"Resample"===c.functionName&&((c.functionArguments||{}).ResamplingType="esriImageServiceDataTypeVector-UV"===a?7:10,this.setRenderingRule(new N(c.toJson())))}},_getRasterAttributeTableFeatures:function(){var a=new H;if(this._rasterAttributeTableFeatures&&0<this._rasterAttributeTableFeatures.length)return a.resolve(this._rasterAttributeTableFeatures),
a;if(10<this.version&&this.hasRasterAttributeTable)return a=this.getRasterAttributeTable(),a.then(z.hitch(this,function(c){c&&c.features&&0<c.features.length&&(this._rasterAttributeTableFeatures=z.clone(c.features))})),a;a.resolve(this._rasterAttributeTableFeatures);return a},_getRenderingRuleAttributeTableFeatures:function(a){a=a&&a.renderingRule;return a?this.getRenderingRuleAttributeTable({renderingRule:a}).then(function(c){return c&&c.features}):(a=new H,a.errback(Error("Rendering rule is not specified")),
a)},_getRenderingRuleAttributeTableAndColormap:function(){this.renderingRule&&this.getRenderingRuleServiceInfo(this.renderingRule).then(z.hitch(this,function(a){a.hasRasterAttributeTable&&this.getRenderingRuleAttributeTable({renderingRule:this.renderingRule}).then(z.hitch(this,function(){!this.renderer||"esri.renderer.ClassBreaksRenderer"!==this.renderer.declaredClass&&"esri.renderer.UniqueValueRenderer"!==this.renderer.declaredClass||this.refresh()}));a.hasColormap&&this.getRenderingRuleColormap({renderingRule:this.renderingRule}).then(z.hitch(this,
function(){this.renderer&&"esri.renderer.ColormapRenderer"===this.renderer.declaredClass&&this.refresh()}))}))},getCustomRasterFields:function(a){var c=a?a.rasterAttributeTableFieldPrefix:this._rasterFieldPrefix;a=10.3<=this.version?"esriFieldTypeDouble":"esriFieldTypeString";var l={name:this._rasterFieldPrefix+"ItemPixelValue",alias:"Item Pixel Value",domain:null,editable:!1,length:50,type:a},q={name:this._rasterFieldPrefix+"ServicePixelValue",alias:"Service Pixel Value",domain:null,editable:!1,
length:50,type:a},w={name:this._rasterFieldPrefix+"ServicePixelValue.Raw",alias:"Raw Service Pixel Value",domain:null,editable:!1,length:50,type:"esriFieldTypeDouble"},B=this.fields?z.clone(this.fields):[];a=B.length;B[a]=q;10.4<=this.version&&"esri.layers.ArcGISImageServiceLayer"===this.declaredClass&&(!this.rasterFunctionInfos||!this.rasterFunctionInfos.length||this._isRenderingRuleAProcessingTemplate({functionName:"none"}))&&(a++,B[a]=w);if(this.capabilities&&-1<this.capabilities.toLowerCase().indexOf("catalog")||
this.fields&&0<this.fields.length)a++,B[a]=l;!t.isDefined(this.pixelFilter)||"esriImageServiceDataTypeVector-UV"!==this.serviceDataType&&"esriImageServiceDataTypeVector-MagDir"!==this.serviceDataType||(l={name:this._rasterFieldPrefix+"Magnitude",alias:"Magnitude",domain:null,editable:!1,type:"esriFieldTypeDouble"},q={name:this._rasterFieldPrefix+"Direction",alias:"Direction",domain:null,editable:!1,type:"esriFieldTypeDouble"},a++,B[a]=l,a++,B[a]=q);a=this._rasterAttributeTableFields;(l=this.renderingRule&&
this._getRenderingRuleId(this.renderingRule))&&this._renderingRuleAttributeTable&&this._renderingRuleAttributeTable.hasOwnProperty(l)&&(a=this._renderingRuleAttributeTable[l].fields);a&&0<a.length&&(a=e.filter(a,function(O){return"esriFieldTypeOID"!==O.type&&"value"!==O.name.toLowerCase()}),a=e.map(a,function(O){var J=z.clone(O);J.name=c+O.name;return J}),B=B.concat(a));var y=this._rasterFieldPrefix+this._renderingRuleFieldSubPrefix;10.4<=this.version&&this.rasterFunctionInfos&&e.forEach(this.rasterFunctionInfos,
function(O){O&&O.name&&"none"!==O.name.toLowerCase()&&(O={name:y+O.name.replace(/ /gi,"_"),alias:O.name,domain:null,editable:!1,type:"esriFieldTypeDouble"},B.push(O))});return B},_applyTimeToMultidimensionalCRF:function(a,c){var l=this._isTimeSupportedOnCRF();if(l&&(!a||!a.multidimensionalDefinition))return a;var q=this.timeInfo&&this.timeInfo.startTimeField;if((c=c||this._params.time)&&q&&this._isMultidimensionalCRF()){a=z.clone(a||this.defaultMosaicRule)||new S;a.multidimensionalDefinition=a.multidimensionalDefinition||
[];var w=a.multidimensionalDefinition.filter(function(y){return y.dimensionName===q}),B=c.split(",").map(function(y){return parseInt(y,10)});2===B.length&&B[0]===B[1]&&(B.length=1);0<w.length?l?a.multidimensionalDefinition.forEach(function(y){y.dimensionName===q&&(y.dimensionName=null,y.isSlice=null,y.values=null)}):a.multidimensionalDefinition.forEach(function(y){y.dimensionName===q&&(y.isSlice=1===B.length,y.values=1===B.length?B:[B])}):l||(a.multidimensionalDefinition.some(function(y){return null!=
y.variableName&&null==y.dimensionName})?a.multidimensionalDefinition.forEach(function(y){null!=y.variableName&&null==y.dimensionName&&(y.dimensionName=q,y.isSlice=1===B.length,y.values=1===B.length?B:[B])}):a.multidimensionalDefinition.push(new I({variableName:"",dimensionName:q,isSlice:1===B.length,values:1===B.length?B:[B]})));this._cleanupMultidimensionalDefinition(a)}return a},_prepareGetImageParameters:function(a,c,l,q){q=t.isDefined(q)?q:this._params;if(this.renderer||this._hasItemLevelRFT&&
this.renderingRule){var w=this.getExportImageRenderingRule();q.renderingRule=w?b.toJson(w.toJson()):null}w=this.getExportImageMosaicRule(q);q.mosaicRule=w?b.toJson(w.toJson()):null;w=a.spatialReference.wkid||b.toJson(a.spatialReference.toJson(!1));delete q._ts;z.mixin(q,{bbox:a.xmin+","+a.ymin+","+a.xmax+","+a.ymax,imageSR:w,bboxSR:w,size:c+","+l},this.disableClientCaching?{_ts:(new Date).getTime()}:{});delete q.compressionTolerance;q.format&&"LERC"===q.format.toUpperCase()&&(q.compressionTolerance=
this.compressionTolerance);q.token=this._getToken()},getImageUrl:function(a,c,l,q,w){w=t.isDefined(w)?w:this._params;this._prepareGetImageParameters(a,c,l,w);a=z.clone(w);this._cleanupRequestParams(a);c=this._url.path+"/exportImage?";l=A.addProxy(c+h.objectToQuery(z.mixin(a,{f:"image"})));var B=a.token;l.length>k.defaults.io.postLength||this.useMapImage?this._jsonRequest=u({url:c,content:z.mixin(a,{f:"json"}),callbackParamName:"callback",load:function(y,O){y=y.href;B&&(y+=-1===y.indexOf("?")?"?token\x3d"+
B:"\x26token\x3d"+B);q(A.addProxy(y))},error:this._errorHandler}):q(l)},onRenderingChange:function(){},onMosaicRuleChange:function(){},onRendererChange:function(){},setInterpolation:function(a,c){this.interpolation=this._params.interpolation=a;c||this.refresh(!0)},setCompressionQuality:function(a,c){this.compressionQuality=this._params.compressionQuality=a;c||this.refresh(!0)},setCompressionTolerance:function(a,c){this.compressionTolerance=a;c||this.refresh(!0)},setBandIds:function(a,c){var l=!1;
this.bandIds!==a&&(l=!0);this.bandIds=a;this._params.bandIds=a?a.join(","):null;if(l&&!c)this.onRenderingChange();c||this.refresh(!0)},setDefaultBandIds:function(a){this.bandIds=this._params.bandIds=null;a||this.refresh(!0)},setDisableClientCaching:function(a){this.disableClientCaching=a},setMosaicRule:function(a,c){var l=!1;this.mosaicRule!==a&&(l=!0);this.mosaicRule=a;this._params.mosaicRule=b.toJson(a.toJson());if(l&&!c)this.onMosaicRuleChange();c||this.refresh(!0)},getRasterFunctionInfos:function(){if(10.3>
this.version||!this.rasterFunctionInfos||!this.rasterFunctionInfos.length)console.log("Layer doesn't support /rasterFunctionInfos resource.");else return u({url:this._url.path+"/rasterFunctionInfos",content:{f:"json"},handleAs:"json",load:function(a){return a&&a.rasterFunctionInfos}})},setRenderingRule:function(a,c){var l=!1;this.renderingRule!==a&&(l=!0);this.renderingRule=a;this._params.renderingRule=a?b.toJson(a.toJson()):null;this._useRenderingRuleAttributeTable?this.getRenderingRuleAttributeTable({renderingRule:a}):
"esri.layers.RasterXLayer"!==this.declaredClass&&this._getRenderingRuleAttributeTableAndColormap();if(l)this.onRenderingChange();this._setDefaultFilter();c||this.refresh(!0)},setImageFormat:function(a,c){this.format=this._params.format=a;this._setDefaultFilter();c||this.refresh(!0)},setInfoTemplate:function(a){this.infoTemplate=a;this._updateInfoTemplateFields(this.fields)},setDefinitionExpression:function(a,c){var l=this.mosaicRule?this.mosaicRule.toJson():{};this.mosaicRule||(this.defaultMosaicRule?
l=this.defaultMosaicRule.toJson():l.method=S.METHOD_NONE);l.where=a;a=new S(l);this.setMosaicRule(a,c);return this},getDefinitionExpression:function(){return this.mosaicRule?this.mosaicRule.where:null},setPixelFilter:function(a){this.pixelFilter=a;this._isDefaultPixelFilter=!1},getPixelData:function(a){return a?(this._useBrowserDecoding()&&(this.originalPixelData={pixelBlock:this._getPixelBlockFromCanvas(this._context,this._map.width,this._map.height),extent:this._map.extent}),this.originalPixelData):
this.pixelData},getExportImageRenderingRule:function(){var a;this._hasItemLevelRFT&&this.renderingRule&&(a=this._getServiceLevelRenderingRule(this.renderingRule));a=a||this.renderingRule;this._isItemLevelRasterFunction(this.renderingRule)&&(a=void 0);return this._combineRenderingRule(this._convertRendererToRenderingRule(this.renderer),a)},getExportImageMosaicRule:function(){var a=this.mosaicRule,c;this._hasItemLevelRFT&&this.renderingRule&&(c=this._getItemLevelRenderingRule(this.renderingRule));c&&
(a=a||this.defaultMosaicRule||new S,a.itemRenderingRule=c);return a=this._applyTimeToMultidimensionalCRF(a)},redraw:function(){this.hasDataChanged=!1;this._setPixelData(this.originalPixelData)},getHistograms:function(a){var c=new H(r._dfdCanceller);if(a&&this._cachedVariableHistogram[a])return c.resolve(this._cachedVariableHistogram[a]),c;if(this.hasHistograms){var l={f:"json"};a&&(l.variable=a);c._pendingDfd=u({url:this._url.path+"/histograms",content:l,handleAs:"json",callbackParamName:"callback"});
c._pendingDfd.then(z.hitch(this,function(q){a&&(this._cachedVariableHistogram[a]=q);c.callback(q)}),function(q){c.errback(q)})}else l=Error("Layer does not have histograms."),l.log=!!d.isDebug,c.errback(l);return c},computeHistograms:function(a){var c=new H(r._dfdCanceller);if(10.1<=this.currentVersion){a=a||{};var l=a.geometry||this.fullExtent,q=(a.geometry||this.fullExtent).toJson();l="extent"===l.type?"esriGeometryEnvelope":"esriGeometryPolygon";var w=a.renderingRule||this.renderingRule||this.defaultRenderingRule;
w=w?w.toJson():null;var B=a.mosaicRule||this.mosaicRule||this.defaultMosaicRule;B=B?B.toJson():null;a=a.pixelSize||{x:this.pixelSizeX,y:this.pixelSizeY};c._pendingDfd=u({url:this._url.path+"/computeHistograms",content:z.mixin({f:"json",geometry:JSON.stringify(q),geometryType:l,renderingRule:JSON.stringify(w),mosaicRule:JSON.stringify(B),pixelSize:JSON.stringify(a),callbackParamName:"callback"}),handleAs:"json"});c._pendingDfd.then(function(y){c.callback(y)},function(y){c.errback(y)})}else q=Error("Layer doesn't support computeHistograms."),
q.log=!!d.isDebug,c.errback(q);return c},getRenderingRuleServiceInfo:function(a,c){function l(B){return B.name&&B.arguments&&B.function&&B.hasOwnProperty("functionType")}var q=new r._fixDfd(new H(r._dfdCanceller));if(!a)return q.errback(Error("Rendering rule is not specified")),q;if(l(a))"ClipFunction"===a.function.type&&(a=this._handleClipFunctionInRenderingRule(a));else{var w=this._getRenderingRuleId(a);if(w&&this._rasterFunctionTemplateInfos[w])return q.resolve(this._rasterFunctionTemplateInfos[w]),
q}return u({url:this._url.path,content:z.mixin(z.mixin({f:"json",renderingRule:JSON.stringify(a.toJson())},this._url.query)),callbackParamName:"callback",load:z.hitch(this,function(B){var y={};e.forEach(this._rasterFunctionServiceInfoProps,function(O){y[O]=B[O]});l(a)||(this._rasterFunctionTemplateInfos[w]=y);return y}),error:c||this._errorHandler})},queryVisibleRasters:function(a,c,l,q){var w=this._map,B=r._fixDfd(new H(r._dfdCanceller));this._visibleRasters=[];var y,O,J=!0,W=!0,X=null,V=this.infoTemplate?
this.infoTemplate.info:null,T=V?z.clone(this.infoTemplate.info.fieldInfos):null;c=c||{};if(V&&this.infoTemplate.info.mediaInfos&&this.infoTemplate.info.mediaInfos.length){var Y=[];e.forEach(this.infoTemplate.info.mediaInfos,function(U){Y=Y.concat(U&&U.value&&U.value.fields||[])});Y.length&&e.forEach(T,function(U){U&&-1<Y.indexOf(U.fieldName)&&(U.visible=!0)})}var ea=function(U){var ja=V&&V.title&&-1<V.title.toLowerCase().indexOf(U.toLowerCase());U=V&&V.description&&-1<V.description.toLowerCase().indexOf(U.toLowerCase());
return ja||U};if(T&&0<T.length)for(J=!1,y=0;y<T.length;y++)if((O=T[y])&&O.fieldName.toLowerCase()!==this._rasterFieldPrefix.toLowerCase()+"servicepixelvalue"&&(O.visible||ea(O.fieldName))){J=!0;break}this.infoTemplate&&this.infoTemplate.info&&this.infoTemplate.info.layerOptions&&this.infoTemplate.info.layerOptions.hasOwnProperty("returnTopmostRaster")&&(X=this.infoTemplate.info.layerOptions.returnTopmostRaster?1:null);T&&0<T.length&&(W=!1,e.some(T,function(U){if(U&&U.fieldName.toLowerCase()===this._rasterFieldPrefix.toLowerCase()+
"itempixelvalue"&&U.visible)return W=!0},this),ea(this._rasterFieldPrefix.toLowerCase()+"itempixelvalue")&&(W=!0));var fa=(O=this._removeVisualizationStretchFunction(this.renderingRule))&&O.functionName,ha=[];if(10.4<=this.version){var aa=!1;if(this.rasterFunctionInfos&&T){var ia=this._rasterFieldPrefix+this._renderingRuleFieldSubPrefix;e.forEach(this.rasterFunctionInfos,function(U){var ja=ia+U.name.replace(/ /gi,"_");e.some(T,function(qa){return qa.visible&&qa.fieldName===ja})&&(aa=aa||fa&&fa===
U.name,ha.push(new N({rasterFunction:U.name})))})}O&&!aa&&ha.push(O)}y=new C;y.geometry=a.geometry;y.returnGeometry=this._map.spatialReference.equals(this.spatialReference);y.returnCatalogItems=J;y.timeExtent=this.timeInfo?a.timeExtent:null;y.returnPixelValues=W;y.maxItemCount=X||a.maxItemCount;this._params.time&&this.mosaicRule?(a=z.clone(this.mosaicRule),a=this._filterOutTimeDimension(a),y.mosaicRule=a):y.mosaicRule=this.mosaicRule||null;this._isMultidimensionalCRF()&&y.timeExtent&&(y.mosaicRule=
this._applyTimeToMultidimensionalCRF(y.mosaicRule,y.timeExtent.toJson().join(",")),this._isTimeSupportedOnCRF()||delete y.timeExtent);y.renderingRule=10.4>this.version&&O||null;y.renderingRules=ha||null;10.8>this.version&&(y.returnPixelValues=void 0,y.maxItemCount=void 0);w&&(w=new E((w.extent.xmax-w.extent.xmin)/w.width,(w.extent.ymax-w.extent.ymin)/w.height,w.extent.spatialReference),y.pixelSize=w);c.requestParams=y;var Z=this;w=new F(this.url);(B._pendingDfd=w.execute(y)).addCallbacks(function(U){Z._queryVisibleRastersHandler(U,
c,l,q,B)},function(U){Z._resolve([U],null,q,B,!0)});return B},_queryVisibleRastersHandler:function(a,c,l,q,w){function B(){var ba=this.getCustomRasterFields(c),ma=this._getDomainFields(ba),ua=c?c.returnDomainValues:!1,Ba=c&&c.rasterAttributeTableFieldPrefix,ka,va,ra,wa,la,sa,Ca,xa,ya,za;ba=(ba=this._getRenderingRuleId(this.renderingRule))&&this._rasterFunctionTemplateInfos[ba];this.renderingRule&&(this._useRenderingRuleAttributeTable||ba)?(ba=this._getRenderingRuleAttributeTableFeatures({renderingRule:this.renderingRule}),
this.hasRasterAttributeTable||(za=y)):ba=this._getRasterAttributeTableFeatures();ba.then(z.hitch(this,function(Aa){for(ka=0;ka<Z.length;ka++){da=Z[ka];da.setInfoTemplate(this.infoTemplate);da._layer=this;if(y){ya=y.replace(/ /gi,"").split(",");va=y;ra=ya;U&&U.length>=ka&&(va=U[ka].replace(/ /gi,", "),ra=U[ka].split(" "));da.attributes[this._rasterFieldPrefix+"ItemPixelValue"]=ra;da.attributes[this._rasterFieldPrefix+"ServicePixelValue"]=ya;O&&(da.attributes[this._rasterFieldPrefix+"ServicePixelValue.Raw"]=
O.replace(/ /gi,"").split(","));if(this.pixelFilter){var ta=new K({height:1,width:1,pixelType:"F32",pixels:[],statistics:[]});e.forEach(ra,function(ca){ta.addData({pixels:[ca],statistics:{minValue:ca,maxValue:ca,noDataValue:null}})});this.pixelFilter({pixelBlock:ta,extent:new x(0,0,0,0,this._map.spatialReference)});if("esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType)da.attributes[this._rasterFieldPrefix+"Magnitude"]=ta.pixels[0][0],
da.attributes[this._rasterFieldPrefix+"Direction"]=ta.pixels[1][0]}e.forEach(T,function(ca){da.attributes[ca.name]=ca.value});var Da=0<this.fields.length?za||va:za||O;if(Aa&&0<Aa.length&&(wa=e.filter(Aa,function(ca){if(ca&&ca.attributes)return ca.attributes.hasOwnProperty("Value")?ca.attributes.Value==Da:ca.attributes.VALUE==Da}),0<wa.length&&(la=z.clone(wa[0]),Ba&&la))){xa={};for(sa in la.attributes)la.attributes.hasOwnProperty(sa)&&(Ca=Ba+sa,xa[Ca]=la.attributes[sa]);la.attributes=xa;da.attributes=
z.mixin(da.attributes,la.attributes)}}ua&&ma&&0<ma.length&&e.forEach(ma,function(ca){if(ca){var na=da.attributes[ca.name];t.isDefined(na)&&(na=this._getDomainValue(ca.domain,na),t.isDefined(na)&&(da.attributes[ca.name]=na))}},this);oa.push(da);this._visibleRasters.push(da)}this._resolve([oa,null,!0],null,l,w)}))}var y=a.value,O=a.value,J=0,W=0,X=this,V=this.objectIdField,T=[];q=c.requestParams.renderingRules;var Y=a.processedValues,ea=this.renderingRule&&b.toJson(this._removeVisualizationStretchFunction(this.renderingRule).toJson());
if(q&&Y&&q.length===Y.length){var fa=this._rasterFieldPrefix+this._renderingRuleFieldSubPrefix;e.forEach(q,function(ba,ma){if(ba.functionName){var ua={name:fa+ba.functionName.replace(/ /gi,"_"),value:Y[ma].replace(/ /gi,"").split(",")};T.push(ua);ea&&ea===b.toJson(ba.toJson())&&(y=Y[ma])}})}q=this.infoTemplate&&this.infoTemplate.info&&this.infoTemplate.info.layerOptions&&this.infoTemplate.info.layerOptions.hasOwnProperty("showNoDataRecords")?this.infoTemplate.info.layerOptions.showNoDataRecords:!0;
if(a.catalogItems){var ha=0,aa=a.catalogItems.features.length;var ia=0;var Z=Array(aa);var U=Array(aa);var ja=Array(aa);if(a.properties&&a.properties.Values){aa=a.properties.Values.length;for(J=0;J<aa;J++)-1<a.properties.Values[J].toLowerCase().indexOf("nodata")&&ia++;var qa=aa-ia;for(J=0;J<aa;J++){ia=!0;if(-1<a.properties.Values[J].toLowerCase().indexOf("nodata")){var pa=qa++;q||(ia=!1,Z.length--,U.length--,ja.length--)}else pa=ha++;ia&&(Z[pa]=a.catalogItems.features[J],U[pa]=a.properties.Values[J],
ja[pa]=Z[pa].attributes[V])}}else{for(J=0;J<aa;J++)Z[J]=a.catalogItems.features[J],ja[J]=Z[J].attributes[V];U=null}}this._visibleRasters=[];(a=-1<y.toLowerCase().indexOf("nodata"))&&!q&&(Z=[],U=[],ja=[]);if(y&&!Z&&!a){V="ObjectId";Z=[];var da=new D(new x(this.fullExtent),null,{ObjectId:0});Z.push(da)}var oa=[];Z?!this._map.spatialReference.equals(this.spatialReference)&&ja&&0<ja.length?u({url:this._url.path+"/query",content:{f:"json",objectIds:ja.join(","),returnGeometry:!0,outSR:b.toJson(X._map.spatialReference.toJson()),
outFields:V},handleAs:"json",callbackParamName:"callback",load:function(ba){if(0===ba.features.length)X._resolve([oa,null,null],null,l,w);else{for(J=0;J<ba.features.length;J++)for(W=0;W<Z.length;W++)Z[W].attributes[V]==ba.features[J].attributes[V]&&(Z[W].geometry=new M(ba.features[J].geometry),Z[W].geometry.setSpatialReference(X._map.spatialReference));B.call(X)}},error:function(ba){X._resolve([oa,null,null],null,l,w)}}):B.call(this):this._resolve([oa,null,null],null,l,w)},getVisibleRasters:function(){var a=
this._visibleRasters,c=[],l;for(l in a)a.hasOwnProperty(l)&&c.push(a[l]);return c},_getDomainFields:function(a){if(a){var c=[];e.forEach(a,function(l){if(l.domain){var q={};q.name=l.name;q.domain=l.domain;c.push(q)}});return c}},_getDomainValue:function(a,c){if(a&&a.codedValues){var l;e.some(a.codedValues,function(q){return q.code===c?(l=q.name,!0):!1});return l}},_requestData:function(a,c,l){this._rasterReadPromise&&this._rasterReadPromise.cancel();a=z.clone(a);var q=a._normalize(!0);this._prepareGetImageParameters(q,
c,l);c=z.clone(this._params);this._cleanupRequestParams(c);c.extent=a;c.format=c.format||(10.3<=this.version?"lerc":"jpgpng");"lerc"===c.format.toLowerCase()&&!c.lercVersion&&10.5<=this.version&&(c.lercVersion=2);this._params.time&&this._isMultidimensionalCRF()&&!this._isTimeSupportedOnCRF()&&delete c.time;l=null;this._useBrowserDecoding()&&(l=new R({ctx:this._context}));c={imageServiceParameters:c,nBands:Math.min(this.bandCount,3),pixelType:this.pixelType,decodeFunc:l?z.hitch(l,"decode"):null};this._rasterReadPromise=
this.raster.read(c,this._requestDataHandler,this._requestDataErrorHandler)},_requestDataHandler:function(a){this._rasterReadPromise&&this._rasterReadPromise.isCanceled()||(this.originalPixelData=a,this.hasDataChanged=!0,this._setPixelData(a))},_setPixelData:function(a){a=this._clonePixelData(a);this.pixelFilter&&this.pixelFilter(a);this.pixelData=a;this._rasterReadPromise&&this._rasterReadPromise.isCanceled()||(this._drawPixelData(),this._rasterReadPromise=null)},_clonePixelData:function(a){if(null===
a||void 0===a)return a;var c={};a.extent&&(c.extent=z.clone(a.extent));a=a.pixelBlock;if(null===a||void 0===a)return c;c.pixelBlock=a.clone();return c},_setDefaultFilter:function(){},_getPixelBlockFromCanvas:function(a,c,l){a=a.getImageData(0,0,c,l).data;var q=c*l,w=0,B=0,y=new Uint8Array(q),O=new Uint8Array(q),J=new Uint8Array(q),W=new Uint8Array(q),X=Infinity,V=Infinity,T=Infinity,Y=-Infinity,ea=-Infinity,fa=-Infinity;for(w=0;w<q;w++){var ha=a[B++];var aa=a[B++];var ia=a[B++];X=X<ha?X:ha;Y=Y>ha?
Y:ha;V=V<aa?V:aa;ea=ea>aa?ea:aa;T=T<ia?T:ia;fa=fa>ia?fa:ia;y[w]=ha;O[w]=aa;J[w]=ia;W[w]=a[B++]&1}return new K({width:c,height:l,pixels:[y,O,J],pixelType:"U8",mask:W,statistics:[{minValue:X,maxValue:Y},{minValue:V,maxValue:ea},{minValue:T,maxValue:fa}]})},_useBrowserDecoding:function(){return(void 0===this.pixelFilter||null===this.pixelFilter)&&("jpeg"===this.format.toLowerCase()||"jpg"===this.format.toLowerCase()||-1<this.format.toLowerCase().indexOf("png"))},getMultidimensionalInfo:function(){var a=
this._url.path+"/multiDimensionalInfo",c=new H(r._dfdCanceller);if(this._multidimensionalInfo)return c.resolve(this._multidimensionalInfo),c;!this.loaded||10.3<=this.version&&this.hasMultidimensions?(c._pendingDfd=u({url:a,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}),c._pendingDfd.then(z.hitch(this,function(l){this._multidimensionalInfo=l.multidimensionalInfo;c.callback(l.multidimensionalInfo)}),function(l){c.errback(l)})):(a=Error("Layer does not support multidimensional info"),
a.log=!!d.isDebug,c.errback(a));return c},getStatistics:function(a){var c=new H(r._dfdCanceller);if(a&&this._cachedVariableStats[a])c.resolve(this._cachedVariableStats[a]);else{var l={f:"json"};a&&(l.variable=a);c._pendingDfd=u({url:this._url.path+"/statistics",content:l,handleAs:"json",callbackParamName:"callback"});c._pendingDfd.then(z.hitch(this,function(q){q=q.statistics||q.statitsics;var w=[];q&&q[0]&&null!=q[0].min?q.forEach(function(B){w.push([B.min,B.max,B.mean,B.standardDeviation])}):w=this.minValues&&
this.minValues.length?this.minValues.map(function(B,y){return[B,this.maxValues[y],this.meanValues[y],this.stdvValues[y]]}.bind(this)):q;a&&(this._cachedVariableStats[a]=w);c.callback(w)}),function(q){c.errback(q)})}return c},getDefaultMultidimensionalDefinition:function(){var a=new H(r._dfdCanceller);if(this._defaultMultidimensionalDefinition)return a.resolve(z.clone(this._defaultMultidimensionalDefinition)),a;a._pendingDfd=this.getMultidimensionalInfo();a._pendingDfd.then(z.hitch(this,function(c){c=
this._getDefaultMultidimensionalDefinition(c);a.callback(c)}),function(c){a.errback(c)});return a},_getDefaultMultidimensionalDefinition:function(a,c,l){var q,w=[],B=this.defaultVariable||"",y=B.length?a.variables.filter(function(O){return O.name===B})[0].dimensions:a.variables[0].dimensions;l&&(B=this.defaultVariable||a.variables[0].name);for(q in y)y.hasOwnProperty(q)&&(c||"StdTime"!==y[q].name)&&(a=y[q],w.push(new I({variableName:B,dimensionName:a.name,isSlice:!a.hasRanges,values:[this._getDefaultDimensionValue(a)]})));
this._defaultMultidimensionalDefinition=w;return z.clone(w)},_getDefaultDimensionValue:function(a){if(a&&a.values&&a.values.length){var c=Infinity,l;if(a.hasRanges)return a.values[0];if(a.name&&"stdz"===a.name.toLowerCase()){for(l=0;l<a.values.length;l++){var q=a.values[l];var w=Math.abs(q-0);if(w<c){c=w;var B=q}if(0===w)break}return B}return a.extent[0]}},_setDefaultMultidimensionalDefinition:function(a){var c,l={};this.getDefaultMultidimensionalDefinition().then(z.hitch(this,function(q){c=q;0<c.length&&
(this.mosaicRule?(l=z.clone(this.mosaicRule),l.multidimensionalDefinition=c):this.defaultMosaicRule?(l=z.clone(this.defaultMosaicRule),l.multidimensionalDefinition=c):l=new S({multidimensionalDefinition:c}),this.setMosaicRule(l,a))}))},_setDefaultRenderingRule:function(a){var c={},l=this.renderingRule;if(!l&&"esri.layers.ArcGISImageServiceVectorLayer"!==this.declaredClass&&!this.bandIds&&this.rasterFunctionInfos&&this.rasterFunctionInfos.length&&"none"!==this.rasterFunctionInfos[0].name.toLowerCase())c.rasterFunction=
this.rasterFunctionInfos[0].name;else if("esri.layers.ArcGISImageServiceVectorLayer"===this.declaredClass&&10.3<this.version&&(!l||"Resample"!==l.functionName)){var q="esriImageServiceDataTypeVector-UV"===this.serviceDataType?7:10;c.rasterFunction="Resample";c.rasterFunctionArguments={ResamplingType:q,InputCellSize:{x:this.pixelSizeX,y:this.pixelSizeY}};l&&(c.rasterFunctionArguments.Raster=l.toJson())}c.hasOwnProperty("rasterFunction")&&(this.defaultRenderingRule=new N(c),this.setRenderingRule(this.defaultRenderingRule,
a))},_cleanupRequestParams:function(a){if(!a)return a;if(a.time&&a.mosaicRule){var c=new S(b.fromJson(a.mosaicRule));c=this._filterOutTimeDimension(c);a.mosaicRule=b.toJson(c.toJson())}c="displayOnPan drawMode styling id opacity visible resourceInfo useMapDimensionValue extent renderer".split(" ");for(var l in c)a.hasOwnProperty(c[l])&&delete a[c[l]];return a},_filterOutTimeDimension:function(a){if(this._isMultidimensionalCRF())return a;if(a&&a.multidimensionalDefinition&&0<a.multidimensionalDefinition.length){var c=
e.filter(a.multidimensionalDefinition,function(l){return"StdTime"!==l.dimensionName});a.multidimensionalDefinition=c}return a},_removeVisualizationStretchFunction:function(a){var c=a&&a.functionName;if(!c||"stretch"!==c.toLowerCase())return a;var l=a.functionArguments.Raster;return l&&l.functionName&&e.some(this.rasterFunctionInfos,function(q){return l.functionName===q.name})?l:a},_isMultidimensionalCRF:function(){return 10.71<=this.version&&this.hasMultidimensions&&this.timeInfo&&!(this.objectIdField&&
this.fields&&1<this.fields.length)},_isTimeSupportedOnCRF:function(){return 10.8<=this.version},_cleanupMultidimensionalDefinition:function(a){a&&a.multidimensionalDefinition&&(a.multidimensionalDefinition=a.multidimensionalDefinition.filter(function(c){return!(!c.variableName&&!c.dimensionName)}),0===a.multidimensionalDefinition.length&&(a.multidimensionalDefinition=null))},_isScientificData:function(){return"esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===
this.serviceDataType||"esriImageServiceDataTypeScientific"===this.serviceDataType||this.hasMultidimensions},_isVectorData:function(a){a=(a=a||this)&&a.serviceDataType;return"esriImageServiceDataTypeVector-UV"===a||"esriImageServiceDataTypeVector-MagDir"===a},_isRenderingRuleAProcessingTemplate:function(a){var c=a&&a.functionName;return!c||a.functionArguments?!1:e.some(c&&(this.rasterFunctionInfos||[]),function(l){return l&&l.name&&l.name.toLowerCase()===c.toLowerCase()})},_getRenderingRuleId:function(a){var c=
a&&a.functionName;if(c){if(this._isRenderingRuleAProcessingTemplate(a))return c;var l=this._customRenderingRuleId[c];if(l){if(l!==a){for(var q in this._customRenderingRuleId)if(this._customRenderingRuleId[q]===a)return q;for(l=0;this._customRenderingRuleId[w];)l+=1;var w;this._customRenderingRuleId[c+l]=a}}else this._customRenderingRuleId[c]=a;return c}},_createPixelData:function(a){a=new K({width:2,height:2,pixels:a,pixelType:this.pixelType,statistics:a});var c=this.fullExtent.getCenter();c=new x(c.x,
c.y,c.x+this.pixelSizeX,c.y+this.pixelSizeY,this.spatialReference);return{pixelBlock:a,extent:c}},_convertRendererToRenderingRule:function(a){var c=a&&a.declaredClass;if(!c||"esri.renderer.UniqueValueRenderer"!==c&&"esri.renderer.ClassBreaksRenderer"!==c&&"esri.renderer.StretchRenderer"!==c&&"esri.renderer.ShadedReliefRenderer"!==c&&"esri.renderer.ColormapRenderer"!==c)return null;var l=null;"esri.renderer.StretchRenderer"===c?l=a.toRenderingRule({convertToColormap:10.6>this.version}):"esri.renderer.ClassBreaksRenderer"===
c?l=this._convertClassifyRenderer(a):"esri.renderer.UniqueValueRenderer"===c?l=this._convertUniqueValueRenderer(a):"esri.renderer.ShadedReliefRenderer"===c?l=this._convertShadedReliefRenderer(a):"esri.renderer.ColormapRenderer"===c&&(l=this._convertColormapRenderer(a));return l},_getValueField:function(a){if(a&&a.length){var c,l;e.some(a,function(q){if((l=q.name)&&"value"===l.toLowerCase())return c=l,!0});return c}},_convertColormapRenderer:function(a){var c=new N;c.functionName="Colormap";c.functionArguments=
{};a=a.colormapInfos.map(function(l){return[l.value].concat(l.color)});c.functionArguments.Colormap=a;return c},_convertShadedReliefRenderer:function(a){var c=new N;c.functionName="Hillshade";var l="traditional"===a.hillshadeType?0:1,q="none"===a.scalingType?1:3,w={HillshadeType:l,SlopeType:q,ZFactor:a.zFactor};0===l&&(w.Azimuth=a.azimuth,w.Altitude=a.altitude);3===q&&(w.PSPower=a.pixelSizePower,w.PSZFactor=a.pixelSizeFactor);c.functionArguments=w;c.variableName="Raster";a.colorRamp&&(c.functionName=
"ShadedRelief",w.Colormap=Q.convertColorRampToColormap(a.colorRamp,256));return c},_convertClassifyRenderer:function(a){var c=[],l=[],q=[],w=[],B;var y=this.renderingRule&&this._getRenderingRuleId(this.renderingRule);var O=this.hasRasterAttributeTable;if(y){O=this._rasterFunctionTemplateInfos[y]?this._rasterFunctionTemplateInfos[y].hasRasterAttributeTable:this.hasRasterAttributeTable;var J=this._renderingRuleAttributeTable[y];var W=this._rasterFunctionTemplateInfos[y]}var X=J&&J.features?J.features:
this._rasterAttributeTableFeatures;var V=this._getValueField(J&&J.fields?J.fields:this._rasterAttributeTableFields);O&&X?(e.forEach(a.infos,function(T,Y){var ea,fa=T.symbol.color;fa.a&&e.forEach(X,function(ha){ea=ha.attributes[a.attributeField];(ea>=T.minValue&&ea<T.maxValue||Y===a.infos.length-1&&ea>=T.minValue)&&w.push([ha.attributes[V],fa.r,fa.g,fa.b])},this)},this),y=W&&W.pixelType||this.pixelType,this._adjustColormapToPixelTypeRange(w,y),y=new N,y.functionName="Colormap",y.functionArguments=
{},y.functionArguments.Colormap=w,y.variableName="Raster"):(e.forEach(a.infos,function(T,Y){B=T.symbol&&T.symbol.color;B.a?(0===Y?c.push.call(c,T.minValue,T.maxValue+1E-4):c.push.call(c,T.minValue+1E-4,T.maxValue+1E-4),l.push(Y),w.push([Y,B.r,B.g,B.b])):q.push(T.minValue,T.maxValue)}),y=W&&W.pixelType||this.pixelType,this._adjustColormapToPixelTypeRange(w,y),y=new N,y.functionName="Remap",y.functionArguments={InputRanges:c,OutputValues:l,NoDataRanges:q},y.variableName="Raster",J=new N,J.functionName=
"Colormap",J.functionArguments={Colormap:w,Raster:y},y=J);return y},_convertUniqueValueRenderer:function(a){var c=[],l=this.renderingRule&&this._getRenderingRuleId(this.renderingRule);if(l){var q=this._renderingRuleAttributeTable[l];var w=this._rasterFunctionTemplateInfos[l]}var B=q&&q.features?q.features:this._rasterAttributeTableFeatures;var y=(l=q&&q.fields?q.fields:this._rasterAttributeTableFields)&&l.length?this._getValueField(l):"Value";e.forEach(a.infos,function(O){var J=O.symbol.color;J.a&&
(a.attributeField!==y&&B?e.forEach(B,function(W){W.attributes[a.attributeField]==O.value&&c.push([W.attributes[y],J.r,J.g,J.b])},this):c.push([O.value,J.r,J.g,J.b]))},this);this._adjustColormapToPixelTypeRange(c,w&&w.pixelType||this.pixelType);w=new N;w.functionName="Colormap";w.functionArguments={};w.functionArguments.Colormap=c;w.variableName="Raster";return w},_adjustColormapToPixelTypeRange:function(a,c){(c=this._pixelTypeRanges[c])&&a.push([Math.floor(c[0]-1),0,0,0],[Math.ceil(c[1]+1),0,0,0]);
return a},_combineRenderingRule:function(a,c){if(!a||!c)return a||c;var l=function(q){var w=q.Raster;return w=w&&"esri.layers.RasterFunction"===w.declaredClass?l(w.functionArguments):q};a=z.clone(a);"none"!==c.functionName.toLocaleLowerCase()&&(l(a.functionArguments).Raster=c);return a},_isItemLevelRasterFunction:function(a){var c=a&&a.functionName;if(!c||!this._hasItemLevelRFT)return!1;var l=!1;e.some(this.rasterFunctionInfos,function(q){if(q&&q.name===c){if(1===q.functionType||2===q.functionType)l=
!0;return!0}});return l},_getServiceLevelRenderingRule:function(a){if(!this._hasItemLevelRFT||!a)return a;a=new N(a.toJson());var c=a.functionArguments;for(var l;;)if((l=c&&c.Raster)&&l.functionArguments&&l.functionArguments.Raster)c=l,c=c.functionArguments;else{this._isItemLevelRasterFunction(l)&&delete c.Raster;break}return a},_getItemLevelRenderingRule:function(a){if(!this._hasItemLevelRFT||!a)return null;if(this._isItemLevelRasterFunction(a))return a;a=new N(a.toJson());for(a=a.functionArguments;;)if((a=
a&&a.Raster)&&a.functionArguments&&a.functionArguments.Raster)a=a.functionArguments;else{if(this._isItemLevelRasterFunction(a))return a;break}},_resolve:function(a,c,l,q,w){c&&this[c].apply(this,a);l&&l.apply(null,a);q&&r._resDfd(q,a,w)},_toggleTime:function(){var a=this._map;this.timeInfo&&this.useMapTime&&a&&!this.suspended?(this._timeConnect||(this._timeConnect=g.connect(a,"onTimeExtentChange",this,this._onTimeExtentChangeHandler)),this._setTime(a.timeExtent)):(g.disconnect(this._timeConnect),
this._timeConnect=null,this._setTime(null))},setUseMapTime:function(a,c){this.useMapTime=a;this._toggleTime();!c&&this._map&&this.refresh(!0)},_setTime:function(a){this._params&&(this._params.time=a?a.toJson().join(","):null)},_onTimeExtentChangeHandler:function(a){this.suspended||(this._setTime(a),this.refresh(!0))},handleSpatialReferenceChange:function(){this.onSpatialReferenceChange()},getColormap:function(a){var c=this._url.path+"/colormap",l=new H(r._dfdCanceller),q={f:"json"};a&&a.renderingRule&&
(q.renderingRule=b.toJson(a.renderingRule.toJson()));this.hasColormap?(l._pendingDfd=u({url:c,content:q,handleAs:"json",callbackParamName:"callback"}),l._pendingDfd.then(function(w){l.callback(w)},function(w){l.errback(w)})):(a=Error("Layer does not support colormap"),a.log=!!d.isDebug,l.errback(a));return l},getRenderingRuleColormap:function(a){var c=new H(r._dfdCanceller);if(!a||!a.renderingRule)return c.errback(Error("Rendering rule is not specified")),c;a=a.renderingRule;var l=this._getRenderingRuleId(a);
this._renderingRuleColormap&&l&&this._renderingRuleColormap.hasOwnProperty(l)?c.resolve(this._renderingRuleColormap[l]):c=this.getColormap({renderingRule:a}).then(z.hitch(this,function(q){q=q&&q.colormap;l&&(this._renderingRuleColormap[l]=q);return q}));return c},_handleClipFunctionInRenderingRule:function(a){a=z.clone(a);var c=a.arguments,l=c.ClippingGeometry&&c.ClippingGeometry.value,q=c.Extent&&c.Extent.value;c.ClippingRaster&&c.ClippingRaster.value||l||q||(c=this._map.extent.toJson(),a.arguments.Extent.value=
c,a.functionArguments.Extent.value=c,a._isTemplate&&(a._templateJson.arguments.Extent.value=c));return a}});f("extend-esri")&&z.setObject("layers.ImageServiceLayerMixin",L,p);return L})},"esri/layers/MosaicRule":function(){define("dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../lang ../geometry/Point ./RasterFunction".split(" "),function(L,z,H,e,b,d,g){var f=L(null,{declaredClass:"esri.layers.MosaicRule",method:null,where:null,sortField:null,sortValue:null,ascending:!1,lockRasterIds:null,
viewpoint:null,objectIds:null,operation:null,multidimensionalDefinition:[],itemRenderingRule:null,constructor:function(h){z.isObject(h)&&(z.mixin(this,h),h.mosaicMethod&&(this.method=h.mosaicMethod),this.method&&"esri"!==this.method.toLowerCase().substring(0,4)&&(this.method=this._getMethodEnum(this.method)),h.mosaicOperation&&(this.operation=h.mosaicOperation),this.operation&&"MT_"!==this.operation.toUpperCase().substring(0,3)&&(this.operation=this._getOperatorEnum(this.operation)),h.fids&&(this.objectIds=
h.fids),h.viewpoint&&(this.viewpoint=new d(h.viewpoint)),h.itemRenderingRule&&(this.itemRenderingRule=new g(h.itemRenderingRule)),this.multidimensionalDefinition=h.multidimensionalDefinition||[])},toJson:function(){var h=null,n=this.multidimensionalDefinition?this.multidimensionalDefinition.length:0;if(n){h=[];for(var p=0;p<n;p++)h.push("esri.layers.DimensionalDefinition"===this.multidimensionalDefinition[p].declaredClass?this.multidimensionalDefinition[p].toJson():this.multidimensionalDefinition[p])}h=
{mosaicMethod:this.method,where:this.where,sortField:this.sortField,sortValue:this.sortValue,ascending:this.ascending,lockRasterIds:z.clone(this.lockRasterIds),viewpoint:this.viewpoint?this.viewpoint.toJson():null,fids:z.clone(this.objectIds),mosaicOperation:this.operation,multidimensionalDefinition:h,itemRenderingRule:this.itemRenderingRule?this.itemRenderingRule.toJson():null};return b.filter(h,function(k){if(null!==k)return!0})},_getMethodEnum:function(h){if(h){var n=f.METHOD_NONE;switch(h.toLowerCase()){case "byattribute":n=
f.METHOD_ATTRIBUTE;break;case "center":n=f.METHOD_CENTER;break;case "lockraster":n=f.METHOD_LOCKRASTER;break;case "nadir":n=f.METHOD_NADIR;break;case "northwest":n=f.METHOD_NORTHWEST;break;case "seamline":n=f.METHOD_SEAMLINE;break;case "viewpoint":n=f.METHOD_VIEWPOINT}return n}},_getOperatorEnum:function(h){if(h)switch(h.toLowerCase()){case "first":return f.OPERATION_FIRST;case "last":return f.OPERATION_LAST;case "max":return f.OPERATION_MAX;case "min":return f.OPERATION_MIN;case "blend":return f.OPERATION_BLEND;
case "mean":return f.OPERATION_MEAN;case "sum":return f.OPERATION_SUM}}});z.mixin(f,{METHOD_NONE:"esriMosaicNone",METHOD_CENTER:"esriMosaicCenter",METHOD_NADIR:"esriMosaicNadir",METHOD_VIEWPOINT:"esriMosaicViewpoint",METHOD_ATTRIBUTE:"esriMosaicAttribute",METHOD_LOCKRASTER:"esriMosaicLockRaster",METHOD_NORTHWEST:"esriMosaicNorthwest",METHOD_SEAMLINE:"esriMosaicSeamline",OPERATION_FIRST:"MT_FIRST",OPERATION_LAST:"MT_LAST",OPERATION_MIN:"MT_MIN",OPERATION_MAX:"MT_MAX",OPERATION_MEAN:"MT_MEAN",OPERATION_BLEND:"MT_BLEND",
OPERATION_SUM:"MT_SUM"});H("extend-esri")&&z.setObject("layers.MosaicRule",f,e);return f})},"esri/layers/DimensionalDefinition":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","../kernel","../lang"],function(L,z,H,e,b){L=L(null,{declaredClass:"esri.layers.DimensionalDefinition",variableName:null,dimensionName:null,values:[],isSlice:!1,constructor:function(d){z.isObject(d)&&z.mixin(this,d)},toJson:function(){var d={variableName:this.variableName,dimensionName:this.dimensionName,
values:z.clone(this.values),isSlice:this.isSlice};return b.filter(d,function(g){return null!==g})}});H("extend-esri")&&z.setObject("layers.DimensionalDefinition",L,e);return L})},"esri/layers/Raster":function(){define("require dojo/_base/declare dojo/_base/lang dojo/_base/Deferred dojo/_base/array dojo/_base/config dojo/json dojo/sniff ../kernel ../Evented ../request ../geometry/Extent ../SpatialReference ../deferredUtils ./PixelBlock ./rasterFormats/LercCodec ./rasterFormats/Lerc2Codec".split(" "),
function(L,z,H,e,b,d,g,f,h,n,p,k,t,u,r,A,x){var E,M,Q,S,N,I;z=z(n,{declaredClass:"esri.layers.Raster",imageServiceUrl:null,validPixelTypes:"U1 U2 U4 U8 U16 U32 S8 S16 S32 F32".split(" "),validFormats:"lerc jpeg jpg jpgpng png png8 png24 png32 bip bsq tiff".split(" "),_eventMap:{"raster-read-complete":["pixelData","params"]},constructor:function(m){this.imageServiceUrl=m;this.registerConnectEvents();this._loadRasterFormatModules()},read:function(m,v,D){var F=this,C=new e(u._dfdCanceller);if(10>f("ie"))throw"This browser is not supported.";
if(!m.imageServiceParameters)throw"Insufficient parameters to read data";var a=H.clone(m.imageServiceParameters),c=m.pixelType;b.some(this.validPixelTypes,function(O){return O===c})||(a.pixelType="F32");b.some(this.validFormats,function(O){return O.toLowerCase()===a.format.toLowerCase()})||(a.format="lerc");var l=m.decodeFunc,q;this._prepareGetImageParameters(a);var w=a.width,B=a.height,y=a.extent;delete a.width;delete a.height;delete a.extent;C._pendingDfd=p({url:this.imageServiceUrl+"/exportImage",
handleAs:"arraybuffer",content:H.mixin(a,{f:"image"}),load:function(O){F.decode(O,{width:w,height:B,planes:null,pixelType:c,noDataValue:a.noData,format:a.format,decodeFunc:l}).then(function(J){q={pixelBlock:J,extent:y};F._resolve([q,a],"onRasterReadComplete",v,C)},function(J){F._resolve([J],null,D,C,!0)})},error:function(O){F._resolve([O],null,D,C,!0)}});return C.promise},decode:function(m,v){if(void 0===v||null===v)throw"missing decode options";var D;v.format&&(D=v.format.toUpperCase());"BSQ"!==
D&&"BIP"!==D&&(D=this._getFormat(m));var F=v.decodeFunc;if(void 0===F||null===F)F=this._getFormatDecoderDfd(D);return F(m,v)},onRasterReadComplete:function(){},_prepareGetImageParameters:function(m){if(m.size&&m.bbox){var v=m.size.split(",");m.width=parseFloat(v[0]);m.height=parseFloat(v[1]);m.extent||(v=m.bbox.split(","),m.extent=new k(parseFloat(v[0]),parseFloat(v[1]),parseFloat(v[2]),parseFloat(v[3]),new t(m.bboxSR)))}else{if(!m.width||Math.floor(m.width)!==m.width||!m.height||Math.floor(m.height)!==
m.height)throw"Incorrect Image Dimensions";if(!m.extent||"esri.geometry.Extent"!==m.extent.declaredClass)throw"Incorrect extent";v=m.extent;var D=v.spatialReference.wkid||g.toJson(v.spatialReference.toJson());delete m._ts;H.mixin(m,{bbox:v.xmin+","+v.ymin+","+v.xmax+","+v.ymax,imageSR:D,bboxSR:D,size:m.width+","+m.height},m.disableClientCaching?{_ts:(new Date).getTime()}:{})}},_adjustExtent:function(m,v,D){var F=m.ymax-m.ymin,C=m.xmax-m.xmin;D>=v?m.ymax=m.ymin+C*v/D:m.xmax=m.xmin+F*D/v;return m},
_resolve:function(m,v,D,F,C){v&&this[v].apply(this,m);D&&D.apply(null,m);F&&u._resDfd(F,m,C)},_getFormatDecoderDfd:function(m){var v=null;switch(m){case "LERC":v=this._decodeLerc;break;case "LERC2":v=this._decodeLerc2;break;case "JPEG":v=this._decodeJpeg;break;case "PNG":v=this._decodePng;break;case "BSQ":v=this._decodeBsq;break;case "BIP":v=this._decodeBip;break;case "TIFF":v=this._decodeTiff;break;default:v=function(D,F){throw"The raster format is not supported";}}v=H.hitch(this,v);return function(D,
F){var C=new e;try{if("LERC"===m||!0===N){var a=v(D,F);C.resolve(a)}else I.then(function(){a=v(D,F);C.resolve(a)})}catch(c){C.reject(c)}return C}},_getFormat:function(m){m=new Uint8Array(m,0,10);var v="";if(255===m[0]&&216===m[1])v="JPEG";else if(137===m[0]&&80===m[1]&&78===m[2]&&71===m[3])v="PNG";else if(67===m[0]&&110===m[1]&&116===m[2]&&90===m[3]&&73===m[4]&&109===m[5]&&97===m[6]&&103===m[7]&&101===m[8]&&32===m[9])v="LERC";else if(76===m[0]&&101===m[1]&&114===m[2]&&99===m[3]&&50===m[4]&&32===m[5])v=
"LERC2";else if(-1<String.fromCharCode.apply(null,m).toLowerCase().indexOf("error"))v="ERROR";else if(73===m[0]&&73===m[1]&&42===m[2]&&0===m[3]||77===m[0]&&77===m[1]&&0===m[2]&&42===m[3])v="TIFF";return v},_validateDecodeParams:function(m){if(!m.height||Math.floor(m.height)!==m.height)throw"Height not provided.";if(!m.width||Math.floor(m.width)!==m.width)throw"Width not provided.";},_decodeJpeg:function(m,v){if(!E)throw"The jpeg decoder module is not loaded.";this._validateDecodeParams(v);m=(new E).decode(m);
if(!R(m,v))throw"The decoded image dimensions are incorrect.";v=[];var D;for(D=0;D<m.pixels.length;D++){var F=m.pixels[D];v.push(this._calculateBandStatistics(F))}return new r({width:m.width,height:m.height,pixels:m.pixels,pixelType:"U8",mask:m.mask,statistics:v})},_decodePng:function(m,v){if(!M)throw"The png decoder module is not loaded.";this._validateDecodeParams(v);m=new Uint8Array(m);var D=new M(m);m=new Uint8Array(v.width*v.height*4);D.copyToImageData(m,D.decodePixels());var F=D=0;F=new Uint8Array(v.width*
v.height);for(D=0;D<v.width*v.height;D++)F[D]=m[4*D+3];var C=new r({width:v.width,height:v.height,pixels:[],pixelType:"U8",mask:F,statistics:[]});for(D=0;3>D;D++){var a=new Uint8Array(v.width*v.height);for(F=0;F<v.width*v.height;F++)a[F]=m[4*F+D];C.addData({pixels:a,statistics:this._calculateBandStatistics(a)})}return C},_decodeBsq:function(m,v){if(!Q)throw"The bsq decoder module is not loaded.";this._validateDecodeParams(v);K=v.noDataValue;v.pixelType=G(v.pixelType);m=Q.decodeBSQ(m,{bandCount:v.planes,
width:v.width,height:v.height,pixelType:P,noDataValue:K});var D=[],F,C=null;for(F=0;F<m.pixels.length;F++)C=m.pixels[F],D.push(this._calculateBandStatistics(C));return new r({width:v.width,height:v.height,pixels:m.pixels,pixelType:v.pixelType,mask:m.maskData,statistics:D})},_decodeBip:function(m,v){this._validateDecodeParams(v);K=v.noDataValue;v.pixelType=G(v.pixelType);m=Q.decodeBIP(m,{bandCount:v.planes,width:v.width,height:v.height,pixelType:P,noDataValue:K});var D=[],F,C=null;for(F=0;F<m.pixels.length;F++)C=
m.pixels[F],D.push(this._calculateBandStatistics(C));return new r({width:v.width,height:v.height,pixels:m.pixels,pixelType:v.pixelType,mask:m.maskData,statistics:D})},_decodeTiff:function(m,v){this._validateDecodeParams(v);K=v.noDataValue;v.pixelType=G(v.pixelType);m=S.decode(m);v=[];var D,F=null;for(D=0;D<m.pixels.length;D++)F=m.pixels[D],v.push(this._calculateBandStatistics(F,m.maskData));return new r({width:m.width,height:m.height,pixels:m.pixels,pixelType:m.pixelType,mask:m.maskData,statistics:v})},
_decodeLerc:function(m,v){this._validateDecodeParams(v);K=v.noDataValue;v.pixelType=G(v.pixelType);for(var D=0,F,C=0,a,c=m.byteLength-10;C<c;){var l=A.decode(m,{inputOffset:C,encodedMaskData:F,returnMask:0===D?!0:!1,returnEncodedMask:0===D?!0:!1,returnFileInfo:!0,pixelType:P,noDataValue:K});C=l.fileInfo.eofOffset;0===D&&(F=l.encodedMaskData,a=new r({width:v.width,height:v.height,pixels:[],pixelType:v.pixelType,mask:l.maskData,statistics:[]}));D++;if(!R(l,v))throw"The decoded image dimensions are incorrect";
a.addData({pixels:l.pixelData,statistics:{minValue:l.minValue,maxValue:l.maxValue,noDataValue:l.noDataValue}})}return a},_decodeLerc2:function(m,v){this._validateDecodeParams(v);K=v.noDataValue;v.pixelType=G(v.pixelType);for(var D=0,F,C,a=0,c,l=m.byteLength-10,q=[];a<l;){C=x.decode(m,{inputOffset:a,maskData:F,returnFileInfo:!0});a=C.fileInfo.eofOffset;0===D&&(F=C.maskData,c=new r({width:v.width,height:v.height,pixels:[],pixelType:C.fileInfo.pixelType,mask:C.maskData,statistics:[]}));C.fileInfo.mask&&
0<C.fileInfo.mask.numBytes&&q.push(C.maskData);D++;if(!R(C,v))throw"The decoded image dimensions are incorrect";if(1<C.dimCount&&C.pixelData&&C.pixelData.length===C.width*C.height*C.dimCount){C.pixelData=C.pixelData.slice(-C.width*C.height);var w=C.dimStats&&C.dimStats.minValues&&C.dimStats.minValues[C.dimCount-1],B=C.dimStats&&C.dimStats.maxValues&&C.dimStats.maxValues[C.dimCount-1];null!=w&&null!=B&&(C.minValue=w,C.maxValue=B)}c.addData({pixels:C.pixelData,statistics:{minValue:C.minValue,maxValue:C.maxValue,
noDataValue:C.noDataValue}})}if(1<q.length){C=c.width*c.height;c.bandMasks=q;F=new Uint8Array(C);F.set(q[0]);for(v=1;v<q.length;v++)for(m=q[v],D=0;D<C;D++)F[D]&=m[D];c.maskData=F}return c},_calculateBandStatistics:function(m,v){var D=Infinity,F=-Infinity,C=m.length,a,c=0;if(v)for(a=0;a<C;a++)v[a]&&(c=m[a],D=c<D?c:D,F=c>F?c:F);else for(a=0;a<C;a++)c=m[a],D=c<D?c:D,F=c>F?c:F;return{minValue:D,maxValue:F}},_loadRasterFormatModules:function(){N||(I||(I=new e),10>f("ie")?I.isRejected()||I.reject("unsupported browser version"):
L(["./rasterFormats/JpgPlus","./rasterFormats/Png","./rasterFormats/Raw","./rasterFormats/TiffDecoder","./rasterFormats/Zlib"],function(m,v,D,F){E=m;M=v;Q=D;S=F;N=!0;I.isResolved()||I.resolve(!0)}))}});var P=null,K=null,G=function(m){if("U1"===m||"U2"===m||"U4"===m||"U8"===m)return K=Math.pow(2,8)-1,P=Uint8Array,"U8";"U16"===m?(K=K||Math.pow(2,16)-1,P=Uint16Array):"U32"===m?(K=K||Math.pow(2,32)-1,P=Uint32Array):"S8"===m?(K=K||0-Math.pow(2,7),P=Int8Array):"S16"===m?(K=K||0-Math.pow(2,15),P=Int16Array):
"S32"===m?(K=K||0-Math.pow(2,31),P=Int32Array):P=Float32Array;return m},R=function(m,v){return m.height!==v.height||m.width!==v.width?!1:!0};f("extend-esri")&&H.setObject("layers.Raster",z,h);return z})},"esri/layers/PixelBlock":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","../kernel"],function(L,z,H,e){L=L([],{declaredClass:"esri.layers.PixelBlock",planes:null,width:null,height:null,pixelType:null,pixels:[],statistics:[],maskIsAlpha:!1,validPixelCount:null,constructor:function(b){if(b){if(!b.width||
Math.floor(b.width)!==b.width)throw"PixelBlock: incorrect width";if(!b.height||Math.floor(b.height)!==b.height)throw"PixelBlock: incorrect height";if(!b.pixels)throw"PixelBlock: pixel data not present";this.width=b.width;this.height=b.height;this.pixels=b.pixels;this.pixelType=b.pixelType||null;this.statistics=b.statistics;this.mask=b.mask||null;this.maskIsAlpha=b.maskIsAlpha||!1;b=b.validPixelCount;null==b&&(b=this.mask?this._getValidPixelCount(this.mask):this.width*this.height);this.validPixelCount=
b}},getPlaneCount:function(){return this.pixels.length!==this.statistics.length?console.error("Inconsistent pixel data and statistics"):this.statistics.length},addData:function(b){if(!b.pixels||!b.statistics)throw"Pixel data or statistics are not present";if(b.pixels.length!==this.width*this.height)throw"Inconsistent pixel data size";this.statistics.push(b.statistics);this.pixels.push(b.pixels)},getAsRGBA:function(){var b=new ArrayBuffer(this.width*this.height*4);switch(this.pixelType){case "S8":case "S16":case "U16":case "S32":case "U32":case "F32":case "F64":this._fillFromNon8Bit(b);
break;default:this._fillFrom8Bit(b)}return new Uint8ClampedArray(b)},getAsRGBAFloat:function(){var b=new Float32Array(this.width*this.height*4);this._fillFrom32Bit(b);return b},clone:function(b){b=b||this;var d=new this.constructor;d.width=b.width;d.height=b.height;d.pixelType=b.pixelType;d.maskIsAlpha=b.maskIsAlpha;b.mask&&(d.mask=new Uint8Array(b.mask));var g,f;if(b.pixels){d.pixels=[];var h=(f=b.pixels.length)&&b.pixels[0].slice;for(g=0;g<f;g++)d.pixels[g]=h?b.pixels[g].slice(0,b.pixels[g].length):
new b.pixels[g].constructor(b.pixels[g])}if(b.statistics)for(d.statistics=[],f=b.statistics.length,g=0;g<f;g++)d.statistics[g]=z.clone(b.statistics[g]);b=b.validPixelCount;null==b&&(b=d.mask?this._getValidPixelCount(d.mask):d.width*d.height);return d},clamp:function(b){if("F64"!==b&&"F32"!==b){switch(b){case "U8":var d=[0,255];break;case "U16":d=[0,65535];break;case "U32":d=[0,4294967295];break;case "S8":d=[-128,127];break;case "S16":d=[-32768,32767];break;case "S32":d=[-2147483648,2147483647];break;
default:d=[-3.4*1E39,3.4*1E39]}var g=d[0];d=d[1];var f=this.pixels,h=this.width*this.height,n=f.length,p,k,t=[];for(p=0;p<n;p++){var u=this._createEmptyBand(b,h);var r=f[p];for(k=0;k<h;k++){var A=r[k];u[k]=A>d?d:A<g?g:A}t.push(u)}this.pixels=t;this.pixelType=b}},calculateStatistics:function(){var b,d=[],g=this.mask;for(b=0;b<this.pixels.length;b++){var f=this.pixels[b];d.push(this._calculateBandStatistics(f,g))}this.statistics=d},_getValidPixelCount:function(b){var d,g=0;for(d=0;d<b.length;d++)b[d]&&
g++;return g},_createEmptyBand:function(b,d){switch(b){case "U8":b=new Uint8Array(d);break;case "U16":b=new Uint16Array(d);break;case "U32":b=new Uint32Array(d);break;case "S8":b=new Int8Array(d);break;case "S16":b=new Int16Array(d);break;case "S32":b=new Int32Array(d);break;case "U32":b=new Uint32Array(d);break;case "F32":b=new Float32Array(d);break;case "F64":b=new Float64Array(d);break;default:b=new Float32Array(d)}return b},_fillFrom8Bit:function(b){var d=this.pixels,g=this.mask;if(!b||!d||!d.length)return console.error("Unable to convert to RGBA. The input pixel block is empty.");
var f,h;var n=f=h=d[0];3<=d.length&&(f=d[1],h=d[2]);d=new Uint32Array(b);var p=this.width*this.height;if(n.length!==p)return console.error("Unable to convert to RGBA. The pixelblock is invalid.");if(g&&g.length===p)if(this.maskIsAlpha)for(b=0;b<p;b++)g[b]&&(d[b]=g[b]<<24|h[b]<<16|f[b]<<8|n[b]);else for(b=0;b<p;b++)g[b]&&(d[b]=-16777216|h[b]<<16|f[b]<<8|n[b]);else for(b=0;b<p;b++)d[b]=-16777216|h[b]<<16|f[b]<<8|n[b]},_fillFromNon8Bit:function(b){var d=this.pixels,g=this.mask,f=this.statistics;if(!b||
!d||!d.length)return console.error("Unable to convert to RGBA. The input pixel block is empty.");var h=1,n=0;h=1;f&&0<f.length?(n=f.map(function(u){return u.minValue}).reduce(function(u,r){return Math.min(u,r)}),h=f.map(function(u){return u.maxValue-u.minValue}).reduce(function(u,r){return Math.max(u,r)}),h=255/h):(h=255,"S8"===this.pixelType?(n=-128,h=127):"U16"===this.pixelType?h=65535:"S16"===this.pixelType?(n=-32768,h=32767):"U32"===this.pixelType?h=4294967295:"S32"===this.pixelType?(n=-2147483648,
h=2147483647):"F32"===this.pixelType?(n=-3.4*1E39,h=3.4*1E39):"F64"===this.pixelType&&(n=-Number.MAX_VALUE,h=Number.MAX_VALUE),h=255/(h-n));b=new Uint32Array(b);f=this.width*this.height;var p=d[0];if(p.length!==f)return console.error("Unable to convert to RGBA. The pixelblock is invalid.");if(3<=d.length){var k=d[1];var t=d[2];if(g&&g.length===f)for(d=0;d<f;d++)g[d]&&(b[d]=-16777216|(t[d]-n)*h<<16|(k[d]-n)*h<<8|(p[d]-n)*h);else for(d=0;d<f;d++)b[d]=-16777216|(t[d]-n)*h<<16|(k[d]-n)*h<<8|(p[d]-n)*
h}else if(g&&g.length===f)for(d=0;d<f;d++)k=(p[d]-n)*h,g[d]&&(b[d]=-16777216|k<<16|k<<8|k);else for(d=0;d<f;d++)k=(p[d]-n)*h,b[d]=-16777216|k<<16|k<<8|k},_fillFrom32Bit:function(b){var d=this.pixels,g=this.mask;if(!b||!d||!d.length)return console.error("Unable to convert to RGBA. The input pixel block is empty.");var f,h;var n=f=h=d[0];3<=d.length&&(f=d[1],h=d[2]);var p=this.width*this.height;if(n.length!==p)return console.error("Unable to convert to RGBA. The pixelblock is invalid.");var k=0;if(g&&
g.length===p)for(d=0;d<p;d++)b[k++]=n[d],b[k++]=f[d],b[k++]=h[d],b[k++]=g[d]&1;else for(d=0;d<p;d++)b[k++]=n[d],b[k++]=f[d],b[k++]=h[d],b[k++]=1},_calculateBandStatistics:function(b,d){var g=Infinity,f=-Infinity,h=b.length,n,p=0;if(d)for(n=0;n<h;n++)d[n]&&(p=b[n],g=p<g?p:g,f=p>f?p:f);else for(n=0;n<h;n++)p=b[n],g=p<g?p:g,f=p>f?p:f;return{minValue:g,maxValue:f}}});H("extend-esri")&&z.setObject("layers.PixelBlock",L,e);return L})},"esri/layers/rasterFormats/LercCodec":function(){define([],function(){var L=
{defaultNoDataValue:-3.4027999387901484E38,decode:function(H,e){e=e||{};var b=e.inputOffset||0,d=e.encodedMaskData||null===e.encodedMaskData,g={},f=new Uint8Array(H,b,10);g.fileIdentifierString=String.fromCharCode.apply(null,f);if("CntZImage"!=g.fileIdentifierString.trim())throw"Unexpected file identifier string: "+g.fileIdentifierString;b+=10;f=new DataView(H,b,24);g.fileVersion=f.getInt32(0,!0);g.imageType=f.getInt32(4,!0);g.height=f.getUint32(8,!0);g.width=f.getUint32(12,!0);g.maxZError=f.getFloat64(16,
!0);b+=24;if(!d)if(f=new DataView(H,b,16),g.mask={},g.mask.numBlocksY=f.getUint32(0,!0),g.mask.numBlocksX=f.getUint32(4,!0),g.mask.numBytes=f.getUint32(8,!0),g.mask.maxValue=f.getFloat32(12,!0),b+=16,0<g.mask.numBytes){d=new Uint8Array(Math.ceil(g.width*g.height/8));f=new DataView(H,b,g.mask.numBytes);var h=f.getInt16(0,!0),n=2,p=0;do{if(0<h)for(;h--;)d[p++]=f.getUint8(n++);else{var k=f.getUint8(n++);for(h=-h;h--;)d[p++]=k}h=f.getInt16(n,!0);n+=2}while(n<g.mask.numBytes);if(-32768!==h||p<d.length)throw"Unexpected end of mask RLE encoding";
g.mask.bitset=d;b+=g.mask.numBytes}else 0===(g.mask.numBytes|g.mask.numBlocksY|g.mask.maxValue)&&(d=new Uint8Array(Math.ceil(g.width*g.height/8)),g.mask.bitset=d);f=new DataView(H,b,16);g.pixels={};g.pixels.numBlocksY=f.getUint32(0,!0);g.pixels.numBlocksX=f.getUint32(4,!0);g.pixels.numBytes=f.getUint32(8,!0);g.pixels.maxValue=f.getFloat32(12,!0);b+=16;d=g.pixels.numBlocksX;f=g.pixels.numBlocksY;d+=0<g.width%d?1:0;h=f+(0<g.height%f?1:0);g.pixels.blocks=Array(d*h);for(p=n=0;p<h;p++)for(k=0;k<d;k++){var t=
0;f=new DataView(H,b,Math.min(10,H.byteLength-b));var u={};g.pixels.blocks[n++]=u;var r=f.getUint8(0);t++;u.encoding=r&63;if(3<u.encoding)throw"Invalid block encoding ("+u.encoding+")";if(2===u.encoding)b++;else{if(0!==r&&2!==r){r>>=6;u.offsetType=r;if(2===r)u.offset=f.getInt8(1),t++;else if(1===r)u.offset=f.getInt16(1,!0),t+=2;else if(0===r)u.offset=f.getFloat32(1,!0),t+=4;else throw"Invalid block offset type";if(1===u.encoding)if(r=f.getUint8(t),t++,u.bitsPerPixel=r&63,r>>=6,u.numValidPixelsType=
r,2===r)u.numValidPixels=f.getUint8(t),t++;else if(1===r)u.numValidPixels=f.getUint16(t,!0),t+=2;else if(0===r)u.numValidPixels=f.getUint32(t,!0),t+=4;else throw"Invalid valid pixel count type";}b+=t;if(3!=u.encoding)if(0===u.encoding){r=(g.pixels.numBytes-1)/4;if(r!==Math.floor(r))throw"uncompressed block has invalid length";f=new ArrayBuffer(4*r);t=new Uint8Array(f);t.set(new Uint8Array(H,b,4*r));f=new Float32Array(f);u.rawData=f;b+=4*r}else 1===u.encoding&&(r=Math.ceil(u.numValidPixels*u.bitsPerPixel/
8),f=new ArrayBuffer(4*Math.ceil(r/4)),t=new Uint8Array(f),t.set(new Uint8Array(H,b,r)),u.stuffedData=new Uint32Array(f),b+=r)}}g.eofOffset=b;H=null!=e.noDataValue?e.noDataValue:L.defaultNoDataValue;d=e.encodedMaskData;r=e.returnMask;h=0;n=g.pixels.numBlocksX;p=g.pixels.numBlocksY;k=Math.floor(g.width/n);u=Math.floor(g.height/p);t=2*g.maxZError;b=Number.MAX_VALUE;d=d||(g.mask?g.mask.bitset:null);var A;f=new (e.pixelType||Float32Array)(g.width*g.height);r&&d&&(A=new Uint8Array(g.width*g.height));r=
new Float32Array(k*u);for(var x,E,M=0;M<=p;M++){var Q=M!==p?u:g.height%p;if(0!==Q)for(var S=0;S<=n;S++){var N=S!==n?k:g.width%n;if(0!==N){var I=M*g.width*u+S*k,P=g.width-N,K=g.pixels.blocks[h],G;if(2>K.encoding){if(0===K.encoding)var R=K.rawData;else{var m=G=R=void 0;x=K.stuffedData;E=K.bitsPerPixel;var v=K.numValidPixels,D=K.offset,F=t,C=r,a=g.pixels.maxValue,c=(1<<E)-1,l=0,q=0,w=Math.ceil((a-D)/F);x[x.length-1]<<=8*(4*x.length-Math.ceil(E*v/8));for(m=0;m<v;m++)0===q&&(R=x[l++],q=32),q>=E?(G=R>>>
q-E&c,q-=E):(q=E-q,G=(R&c)<<q&c,R=x[l++],q=32-q,G+=R>>>q),C[m]=G<w?D+G*F:a;R=r}G=0}else var B=2===K.encoding?0:K.offset;if(d)for(E=0;E<Q;E++){if(I&7){var y=d[I>>3];y<<=I&7}for(x=0;x<N;x++)I&7||(y=d[I>>3]),y&128?(A&&(A[I]=1),m=2>K.encoding?R[G++]:B,b=b>m?m:b,f[I++]=m):(A&&(A[I]=0),f[I++]=H),y<<=1;I+=P}else if(2>K.encoding)for(E=0;E<Q;E++){for(x=0;x<N;x++)m=R[G++],b=b>m?m:b,f[I++]=m;I+=P}else for(b=b>B?B:b,E=0;E<Q;E++){for(x=0;x<N;x++)f[I++]=B;I+=P}if(1===K.encoding&&G!==K.numValidPixels)throw"Block and Mask do not match";
h++}}}B=A;A={width:g.width,height:g.height,pixelData:f,minValue:b,maxValue:g.pixels.maxValue,noDataValue:H};B&&(A.maskData=B);e.returnEncodedMask&&g.mask&&(A.encodedMaskData=g.mask.bitset?g.mask.bitset:null);if(e.returnFileInfo&&(A.fileInfo=z(g),e.computeUsedBitDepths)){e=A.fileInfo;B=g.pixels.numBlocksX*g.pixels.numBlocksY;y={};for(R=0;R<B;R++)G=g.pixels.blocks[R],0===G.encoding?y.float32=!0:1===G.encoding?y[G.bitsPerPixel]=!0:y[0]=!0;g=Object.keys(y);e.bitDepths=g}return A}},z=function(H){return{fileIdentifierString:H.fileIdentifierString,
fileVersion:H.fileVersion,imageType:H.imageType,height:H.height,width:H.width,maxZError:H.maxZError,eofOffset:H.eofOffset,mask:H.mask?{numBlocksX:H.mask.numBlocksX,numBlocksY:H.mask.numBlocksY,numBytes:H.mask.numBytes,maxValue:H.mask.maxValue}:null,pixels:{numBlocksX:H.pixels.numBlocksX,numBlocksY:H.pixels.numBlocksY,numBytes:H.pixels.numBytes,maxValue:H.pixels.maxValue,noDataValue:this.noDataValue}}};return L})},"esri/layers/rasterFormats/Lerc2Codec":function(){define([],function(){var L={unstuff:function(e,
b,d,g,f,h,n,p){var k=(1<<d)-1,t=0,u,r=0;e[e.length-1]<<=8*(4*e.length-Math.ceil(d*g/8));if(f)for(u=0;u<g;u++){if(0===r){var A=e[t++];r=32}if(r>=d){var x=A>>>r-d&k;r-=d}else r=d-r,x=(A&k)<<r&k,A=e[t++],r=32-r,x+=A>>>r;b[u]=f[x]}else for(f=Math.ceil((p-h)/n),u=0;u<g;u++)0===r&&(A=e[t++],r=32),r>=d?(x=A>>>r-d&k,r-=d):(r=d-r,x=(A&k)<<r&k,A=e[t++],r=32-r,x+=A>>>r),b[u]=x<f?h+x*n:p},unstuffLUT:function(e,b,d,g,f,h){var n=(1<<b)-1,p=0,k=0,t=0,u=t=0,r=[];e[e.length-1]<<=8*(4*e.length-Math.ceil(b*d/8));var A=
Math.ceil((h-g)/f);for(k=0;k<d;k++){if(0===t){var x=e[p++];t=32}t>=b?(u=x>>>t-b&n,t-=b):(t=b-t,u=(x&n)<<t&n,x=e[p++],t=32-t,u+=x>>>t);r[k]=u<A?g+u*f:h}r.unshift(g);return r},unstuff2:function(e,b,d,g,f,h,n,p){var k=(1<<d)-1,t=0,u,r=0,A=0;if(f)for(u=0;u<g;u++){if(0===r){var x=e[t++];r=32;A=0}if(r>=d){var E=x>>>A&k;r-=d;A+=d}else{var M=d-r;E=x>>>A&k;x=e[t++];r=32-M;E|=(x&(1<<M)-1)<<d-M;A=M}b[u]=f[E]}else for(f=Math.ceil((p-h)/n),u=0;u<g;u++)0===r&&(x=e[t++],r=32,A=0),r>=d?(E=x>>>A&k,r-=d,A+=d):(M=d-
r,E=x>>>A&k,x=e[t++],r=32-M,E|=(x&(1<<M)-1)<<d-M,A=M),b[u]=E<f?h+E*n:p;return b},unstuffLUT2:function(e,b,d,g,f,h){var n=(1<<b)-1,p=0,k=0,t=0,u=0,r=0,A=0,x=[],E=Math.ceil((h-g)/f);for(k=0;k<d;k++){if(0===u){var M=e[p++];u=32;A=0}u>=b?(r=M>>>A&n,u-=b,A+=b):(t=b-u,r=M>>>A&n,M=e[p++],u=32-t,r|=(M&(1<<t)-1)<<b-t,A=t);x[k]=r<E?g+r*f:h}x.unshift(g);return x},originalUnstuff:function(e,b,d,g){var f=(1<<d)-1,h=0,n,p=0;e[e.length-1]<<=8*(4*e.length-Math.ceil(d*g/8));for(n=0;n<g;n++){if(0===p){var k=e[h++];
p=32}if(p>=d){var t=k>>>p-d&f;p-=d}else p=d-p,t=(k&f)<<p&f,k=e[h++],p=32-p,t+=k>>>p;b[n]=t}return b},originalUnstuff2:function(e,b,d,g){var f=(1<<d)-1,h=0,n,p=0,k=0;for(n=0;n<g;n++){if(0===p){var t=e[h++];p=32;k=0}if(p>=d){var u=t>>>k&f;p-=d;k+=d}else{var r=d-p;u=t>>>k&f;t=e[h++];p=32-r;u|=(t&(1<<r)-1)<<d-r;k=r}b[n]=u}return b}},z={HUFFMAN_LUT_BITS_MAX:12,computeChecksumFletcher32:function(e){for(var b=65535,d=65535,g=e.length,f=Math.floor(g/2),h=0;f;){var n=359<=f?359:f;f-=n;do b+=e[h++]<<8,d+=b+=
e[h++];while(--n);b=(b&65535)+(b>>>16);d=(d&65535)+(d>>>16)}g&1&&(d+=b+=e[h]<<8);return((d&65535)+(d>>>16)<<16|(b&65535)+(b>>>16))>>>0},readHeaderInfo:function(e,b){var d=b.ptr,g=new Uint8Array(e,d,6),f={};f.fileIdentifierString=String.fromCharCode.apply(null,g);if(0!==f.fileIdentifierString.lastIndexOf("Lerc2",0))throw"Unexpected file identifier string (expect Lerc2 ): "+f.fileIdentifierString;d+=6;g=new DataView(e,d,8);var h=g.getInt32(0,!0);f.fileVersion=h;d+=4;3<=h&&(f.checksum=g.getUint32(4,
!0),d+=4);g=new DataView(e,d,12);f.height=g.getUint32(0,!0);f.width=g.getUint32(4,!0);d+=8;4<=h?(f.numDims=g.getUint32(8,!0),d+=4):f.numDims=1;g=new DataView(e,d,40);f.numValidPixel=g.getUint32(0,!0);f.microBlockSize=g.getInt32(4,!0);f.blobSize=g.getInt32(8,!0);f.imageType=g.getInt32(12,!0);f.maxZError=g.getFloat64(16,!0);f.zMin=g.getFloat64(24,!0);f.zMax=g.getFloat64(32,!0);d+=40;b.headerInfo=f;b.ptr=d;if(3<=h&&(e=this.computeChecksumFletcher32(new Uint8Array(e,d-(4<=h?52:48),f.blobSize-14)),e!==
f.checksum))throw"Checksum failed.";return!0},checkMinMaxRanges:function(e,b){var d=b.headerInfo,g=this.getDataTypeArray(d.imageType),f=d.numDims*this.getDataTypeSize(d.imageType),h=this.readSubArray(e,b.ptr,g,f);e=this.readSubArray(e,b.ptr+f,g,f);b.ptr+=2*f;f=!0;for(b=0;b<d.numDims;b++)if(h[b]!==e[b]){f=!1;break}d.minValues=h;d.maxValues=e;return f},readSubArray:function(e,b,d,g){if(d===Uint8Array)e=new Uint8Array(e,b,g);else{var f=new ArrayBuffer(g);(new Uint8Array(f)).set(new Uint8Array(e,b,g));
e=new d(f)}return e},readMask:function(e,b){var d=b.ptr,g=b.headerInfo,f=g.width*g.height,h=g.numValidPixel,n=new DataView(e,d,4);g={};g.numBytes=n.getUint32(0,!0);d+=4;if((0===h||f===h)&&0!==g.numBytes)throw"invalid mask";if(0===h)h=new Uint8Array(Math.ceil(f/8)),g.bitset=h,n=new Uint8Array(f),b.pixels.resultMask=n,d+=g.numBytes;else if(0<g.numBytes){h=new Uint8Array(Math.ceil(f/8));n=new DataView(e,d,g.numBytes);e=n.getInt16(0,!0);var p=2,k=0,t=0;do{if(0<e)for(;e--;)h[k++]=n.getUint8(p++);else for(t=
n.getUint8(p++),e=-e;e--;)h[k++]=t;e=n.getInt16(p,!0);p+=2}while(p<g.numBytes);if(-32768!==e||k<h.length)throw"Unexpected end of mask RLE encoding";n=new Uint8Array(f);for(p=p=e=0;p<f;p++)p&7?(e=h[p>>3],e<<=p&7):e=h[p>>3],e&128&&(n[p]=1);b.pixels.resultMask=n;g.bitset=h;d+=g.numBytes}b.ptr=d;b.mask=g;return!0},readDataOneSweep:function(e,b,d,g){var f=b.ptr,h=b.headerInfo,n=h.numDims,p=h.width*h.height;h=h.numValidPixel*z.getDataTypeSize(h.imageType)*n;var k=b.pixels.resultMask;if(d===Uint8Array)e=
new Uint8Array(e,f,h);else{var t=new ArrayBuffer(h);(new Uint8Array(t)).set(new Uint8Array(e,f,h));e=new d(t)}if(e.length===p*n)b.pixels.resultPixels=g?z.swapDimensionOrder(e,p,n,d,!0):e;else{b.pixels.resultPixels=new d(p*n);var u=t=d=0,r=0;if(1<n)if(g)for(t=0;t<p;t++){if(k[t])for(r=t,u=0;u<n;u++,r+=p)b.pixels.resultPixels[r]=e[d++]}else for(t=0;t<p;t++){if(k[t])for(r=t*n,u=0;u<n;u++)b.pixels.resultPixels[r+u]=e[d++]}else for(t=0;t<p;t++)k[t]&&(b.pixels.resultPixels[t]=e[d++])}b.ptr=f+h;return!0},
readHuffmanTree:function(e,b){var d=this.HUFFMAN_LUT_BITS_MAX,g=new DataView(e,b.ptr,16);b.ptr+=16;if(2>g.getInt32(0,!0))throw"unsupported Huffman version";var f=g.getInt32(4,!0),h=g.getInt32(8,!0);g=g.getInt32(12,!0);if(h>=g)return!1;var n=new Uint32Array(g-h);z.decodeBits(e,b,n);var p=[],k;for(k=h;k<g;k++){var t=k-(k<f?0:f);p[t]={first:n[k-h],second:null}}k=e.byteLength-b.ptr;n=new ArrayBuffer(4*Math.ceil(k/4));(new Uint8Array(n)).set(new Uint8Array(e,b.ptr,k));e=new Uint32Array(n);b=0;n=0;var u=
e[0];for(k=h;k<g;k++){t=k-(k<f?0:f);var r=p[t].first;0<r&&(p[t].second=u<<b>>>32-r,32-b>=r?(b+=r,32===b&&(b=0,n++,u=e[n])):(b+=r-32,n++,u=e[n],p[t].second|=u>>>32-b))}var A=u=0,x=new H;for(k=0;k<p.length;k++)void 0!==p[k]&&(u=Math.max(u,p[k].first));A=u>=d?d:u;d=[];var E;for(k=h;k<g;k++)if(t=k-(k<f?0:f),r=p[t].first,0<r)if(h=[r,t],r<=A){t=p[t].second<<A-r;var M=1<<A-r;for(r=0;r<M;r++)d[t|r]=h}else for(t=p[t].second,M=x,--r;0<=r;r--)(E=t>>>r&1)?(M.right||(M.right=new H),M=M.right):(M.left||(M.left=
new H),M=M.left),0!==r||M.val||(M.val=h[1]);return{decodeLut:d,numBitsLUTQick:A,numBitsLUT:u,tree:x,stuffedData:e,srcPtr:n,bitPos:b}},readHuffman:function(e,b,d,g){var f=b.headerInfo.numDims,h=b.headerInfo.height,n=b.headerInfo.width,p=n*h,k=this.readHuffmanTree(e,b);e=k.decodeLut;var t=k.tree,u=k.stuffedData,r=k.srcPtr,A=k.bitPos,x=k.numBitsLUTQick;k=k.numBitsLUT;var E=0===b.headerInfo.imageType?128:0,M=b.pixels.resultMask,Q,S,N,I,P,K,G=0;0<A&&(r++,A=0);var R=u[r],m=1===b.encodeMode,v=new d(p*f),
D=v,F;if(2>f||m)for(F=0;F<f;F++)if(1<f&&(D=new d(v.buffer,p*F,p),G=0),b.headerInfo.numValidPixel===n*h)for(N=P=0;N<h;N++)for(I=0;I<n;I++,P++){var C=0;var a=Q=R<<A>>>32-x;32-A<x&&(a=Q|=u[r+1]>>>64-A-x);if(e[a])C=e[a][1],A+=e[a][0];else for(a=Q=R<<A>>>32-k,32-A<k&&(a=Q|=u[r+1]>>>64-A-k),a=t,K=0;K<k;K++)if(a=(S=Q>>>k-K-1&1)?a.right:a.left,!a.left&&!a.right){C=a.val;A=A+K+1;break}32<=A&&(A-=32,r++,R=u[r]);C-=E;m?(C=0<I?C+G:0<N?C+D[P-n]:C+G,C&=255,G=D[P]=C):D[P]=C}else for(N=P=0;N<h;N++)for(I=0;I<n;I++,
P++){if(M[P]){C=0;a=Q=R<<A>>>32-x;32-A<x&&(a=Q|=u[r+1]>>>64-A-x);if(e[a])C=e[a][1],A+=e[a][0];else for(a=Q=R<<A>>>32-k,32-A<k&&(a=Q|=u[r+1]>>>64-A-k),a=t,K=0;K<k;K++)if(a=(S=Q>>>k-K-1&1)?a.right:a.left,!a.left&&!a.right){C=a.val;A=A+K+1;break}32<=A&&(A-=32,r++,R=u[r]);C-=E;m?(C=0<I&&M[P-1]?C+G:0<N&&M[P-n]?C+D[P-n]:C+G,C&=255,G=D[P]=C):D[P]=C}}else for(N=P=0;N<h;N++)for(I=0;I<n;I++)if(P=N*n+I,!M||M[P])for(F=0;F<f;F++,P+=p){C=0;a=Q=R<<A>>>32-x;32-A<x&&(a=Q|=u[r+1]>>>64-A-x);if(e[a])C=e[a][1],A+=e[a][0];
else for(a=Q=R<<A>>>32-k,32-A<k&&(a=Q|=u[r+1]>>>64-A-k),a=t,K=0;K<k;K++)if(a=(S=Q>>>k-K-1&1)?a.right:a.left,!a.left&&!a.right){C=a.val;A=A+K+1;break}32<=A&&(A-=32,r++,R=u[r]);C-=E;D[P]=C}b.ptr=b.ptr+4*(r+1)+(0<A?4:0);b.pixels.resultPixels=v;1<f&&!g&&(b.pixels.resultPixels=z.swapDimensionOrder(v,p,f,d))},decodeBits:function(e,b,d,g,f){var h=b.headerInfo,n=h.fileVersion,p=0,k=new DataView(e,b.ptr,5<=e.byteLength-b.ptr?5:e.byteLength-b.ptr),t=k.getUint8(0);p++;var u=t>>6,r=0===u?4:3-u,A=0<(t&32)?!0:
!1;u=t&31;t=0;if(1===r)t=k.getUint8(p),p++;else if(2===r)t=k.getUint16(p,!0),p+=2;else if(4===r)t=k.getUint32(p,!0),p+=4;else throw"Invalid valid pixel count type";r=2*h.maxZError;f=1<h.numDims?h.maxValues[f]:h.zMax;if(A){b.counter.lut++;A=k.getUint8(p);p++;h=Math.ceil((A-1)*u/8);var x=Math.ceil(h/4);x=new ArrayBuffer(4*x);var E=new Uint8Array(x);b.ptr+=p;E.set(new Uint8Array(e,b.ptr,h));p=new Uint32Array(x);b.ptr+=h;for(k=0;A-1>>>k;)k++;h=Math.ceil(t*k/8);x=Math.ceil(h/4);x=new ArrayBuffer(4*x);
E=new Uint8Array(x);E.set(new Uint8Array(e,b.ptr,h));e=new Uint32Array(x);b.ptr+=h;b=3<=n?L.unstuffLUT2(p,u,A-1,g,r,f):L.unstuffLUT(p,u,A-1,g,r,f);3<=n?L.unstuff2(e,d,k,t,b):L.unstuff(e,d,k,t,b)}else b.counter.bitstuffer++,k=u,b.ptr+=p,0<k&&(h=Math.ceil(t*k/8),x=Math.ceil(h/4),x=new ArrayBuffer(4*x),E=new Uint8Array(x),E.set(new Uint8Array(e,b.ptr,h)),e=new Uint32Array(x),b.ptr+=h,3<=n?null==g?L.originalUnstuff2(e,d,k,t):L.unstuff2(e,d,k,t,!1,g,r,f):null==g?L.originalUnstuff(e,d,k,t):L.unstuff(e,
d,k,t,!1,g,r,f))},readTiles:function(e,b,d,g){var f=b.headerInfo,h=f.width,n=f.height,p=h*n,k=f.microBlockSize,t=f.imageType,u=z.getDataTypeSize(t),r=Math.ceil(h/k),A=Math.ceil(n/k);b.pixels.numBlocksY=A;b.pixels.numBlocksX=r;var x=b.pixels.ptr=0,E=0,M=0,Q=0,S=0,N=0,I=0,P=0,K=x=0,G=0,R=0,m=I=0;I=I=0;var v=new d(k*k);n=n%k||k;var D=h%k||k,F=f.numDims,C,a=b.pixels.resultMask,c=b.pixels.resultPixels,l=5<=f.fileVersion?14:15,q=f.zMax;for(M=0;M<A;M++)for(S=M!==A-1?k:n,Q=0;Q<r;Q++)for(N=Q!==r-1?k:D,G=M*
h*k+Q*k,R=h-N,C=0;C<F;C++){1<F?(m=c,G=M*h*k+Q*k,c=new d(b.pixels.resultPixels.buffer,p*C*u,p),q=f.maxValues[C]):m=null;I=e.byteLength-b.ptr;E=new DataView(e,b.ptr,Math.min(10,I));var w={};I=0;P=E.getUint8(0);I++;var B=5<=f.fileVersion?P&4:0;x=P>>6&255;K=P>>2&l;if(K!==(Q*k>>3&l))throw"integrity issue";if(B&&0===C)throw"integrity issue";P&=3;if(3<P)throw b.ptr+=I,"Invalid block encoding ("+P+")";if(2===P){if(B)if(a)for(x=0;x<S;x++)for(E=0;E<N;E++)a[G]&&(c[G]=m[G]),G++;else for(x=0;x<S;x++)for(E=0;E<
N;E++)c[G]=m[G],G++;b.counter.constant++;b.ptr+=I}else if(0===P){if(B)throw"integrity issue";b.counter.uncompressed++;b.ptr+=I;I=S*N*u;m=e.byteLength-b.ptr;I=I<m?I:m;m=new ArrayBuffer(0===I%u?I:I+u-I%u);B=new Uint8Array(m);B.set(new Uint8Array(e,b.ptr,I));m=new d(m);I=0;if(a)for(x=0;x<S;x++){for(E=0;E<N;E++)a[G]&&(c[G]=m[I++]),G++;G+=R}else for(x=0;x<S;x++){for(E=0;E<N;E++)c[G++]=m[I++];G+=R}b.ptr+=I*u}else if(x=z.getDataTypeUsed(B&&6>t?4:t,x),w=z.getOnePixel(w,I,x,E),I+=z.getDataTypeSize(x),3===
P)if(b.ptr+=I,b.counter.constantoffset++,a)for(x=0;x<S;x++){for(E=0;E<N;E++)a[G]&&(c[G]=B?Math.min(q,m[G]+w):w),G++;G+=R}else for(x=0;x<S;x++){for(E=0;E<N;E++)c[G]=B?Math.min(q,m[G]+w):w,G++;G+=R}else if(b.ptr+=I,z.decodeBits(e,b,v,w,C),I=0,B)if(a)for(x=0;x<S;x++){for(E=0;E<N;E++)a[G]&&(c[G]=v[I++]+m[G]),G++;G+=R}else for(x=0;x<S;x++){for(E=0;E<N;E++)c[G]=v[I++]+m[G],G++;G+=R}else if(a)for(x=0;x<S;x++){for(E=0;E<N;E++)a[G]&&(c[G]=v[I++]),G++;G+=R}else for(x=0;x<S;x++){for(E=0;E<N;E++)c[G++]=v[I++];
G+=R}}1<F&&!g&&(b.pixels.resultPixels=z.swapDimensionOrder(b.pixels.resultPixels,p,F,d))},formatFileInfo:function(e){return{fileIdentifierString:e.headerInfo.fileIdentifierString,fileVersion:e.headerInfo.fileVersion,imageType:e.headerInfo.imageType,height:e.headerInfo.height,width:e.headerInfo.width,numValidPixel:e.headerInfo.numValidPixel,microBlockSize:e.headerInfo.microBlockSize,blobSize:e.headerInfo.blobSize,maxZError:e.headerInfo.maxZError,pixelType:z.getPixelType(e.headerInfo.imageType),eofOffset:e.eofOffset,
mask:e.mask?{numBytes:e.mask.numBytes}:null,pixels:{numBlocksX:e.pixels.numBlocksX,numBlocksY:e.pixels.numBlocksY,maxValue:e.headerInfo.zMax,minValue:e.headerInfo.zMin,noDataValue:e.noDataValue}}},constructConstantSurface:function(e,b){var d=e.headerInfo.zMax,g=e.headerInfo.zMin,f=e.headerInfo.maxValues,h=e.headerInfo.numDims,n=e.headerInfo.height*e.headerInfo.width,p=0,k=0,t=0,u=e.pixels.resultMask;e=e.pixels.resultPixels;if(u)if(1<h)if(b)for(p=0;p<h;p++)for(t=p*n,d=f[p],k=0;k<n;k++)u[k]&&(e[t+k]=
d);else for(k=0;k<n;k++){if(u[k])for(t=k*h,p=0;p<h;p++)e[t+h]=f[p]}else for(k=0;k<n;k++)u[k]&&(e[k]=d);else if(1<h&&g!==d)if(b)for(p=0;p<h;p++)for(t=p*n,d=f[p],k=0;k<n;k++)e[t+k]=d;else for(k=0;k<n;k++)for(t=k*h,p=0;p<h;p++)e[t+p]=f[p];else for(k=0;k<n*h;k++)e[k]=d},getDataTypeArray:function(e){switch(e){case 0:e=Int8Array;break;case 1:e=Uint8Array;break;case 2:e=Int16Array;break;case 3:e=Uint16Array;break;case 4:e=Int32Array;break;case 5:e=Uint32Array;break;case 6:e=Float32Array;break;case 7:e=Float64Array;
break;default:e=Float32Array}return e},getPixelType:function(e){switch(e){case 0:e="S8";break;case 1:e="U8";break;case 2:e="S16";break;case 3:e="U16";break;case 4:e="S32";break;case 5:e="U32";break;case 6:e="F32";break;case 7:e="F64";break;default:e="F32"}return e},isValidPixelValue:function(e,b){if(null==b)return!1;switch(e){case 0:e=-128<=b&&127>=b;break;case 1:e=0<=b&&255>=b;break;case 2:e=-32768<=b&&32767>=b;break;case 3:e=0<=b&&65536>=b;break;case 4:e=-2147483648<=b&&2147483647>=b;break;case 5:e=
0<=b&&4294967296>=b;break;case 6:e=-3.4027999387901484E38<=b&&3.4027999387901484E38>=b;break;case 7:e=4.9E-324<=b&&1.7976931348623157E308>=b;break;default:e=!1}return e},getDataTypeSize:function(e){var b=0;switch(e){case 0:case 1:b=1;break;case 2:case 3:b=2;break;case 4:case 5:case 6:b=4;break;case 7:b=8;break;default:b=e}return b},getDataTypeUsed:function(e,b){var d=e;switch(e){case 2:case 4:d=e-b;break;case 3:case 5:d=e-2*b;break;case 6:d=0===b?e:1===b?2:1;break;case 7:d=0===b?e:e-2*b+1;break;default:d=
e}return d},getOnePixel:function(e,b,d,g){e=0;switch(d){case 0:e=g.getInt8(b);break;case 1:e=g.getUint8(b);break;case 2:e=g.getInt16(b,!0);break;case 3:e=g.getUint16(b,!0);break;case 4:e=g.getInt32(b,!0);break;case 5:e=g.getUInt32(b,!0);break;case 6:e=g.getFloat32(b,!0);break;case 7:e=g.getFloat64(b,!0);break;default:throw"the decoder does not understand this pixel type";}return e},swapDimensionOrder:function(e,b,d,g,f){var h=0,n=0,p=0,k=0,t=e;if(1<d)if(t=new g(b*d),f)for(h=0;h<b;h++)for(k=h,p=0;p<
d;p++,k+=b)t[k]=e[n++];else for(h=0;h<b;h++)for(k=h,p=0;p<d;p++,k+=b)t[n++]=e[k];return t}},H=function(e,b,d){this.val=e;this.left=b;this.right=d};return{decode:function(e,b){b=b||{};var d=b.noDataValue,g=0,f={};f.ptr=b.inputOffset||0;f.pixels={};if(z.readHeaderInfo(e,f)){g=f.headerInfo;var h=g.fileVersion,n=z.getDataTypeArray(g.imageType);if(5<h)throw"unsupported lerc version 2."+h;z.readMask(e,f);g.numValidPixel===g.width*g.height||f.pixels.resultMask||(f.pixels.resultMask=b.maskData);var p=g.width*
g.height;f.pixels.resultPixels=new n(p*g.numDims);f.counter={onesweep:0,uncompressed:0,lut:0,bitstuffer:0,constant:0,constantoffset:0};var k=!b.returnPixelInterleavedDims;if(0!==g.numValidPixel)if(g.zMax===g.zMin)z.constructConstantSurface(f,k);else if(4<=h&&z.checkMinMaxRanges(e,f))z.constructConstantSurface(f,k);else{var t=new DataView(e,f.ptr,2),u=t.getUint8(0);f.ptr++;if(u)z.readDataOneSweep(e,f,n,k);else if(1<h&&1>=g.imageType&&1E-5>Math.abs(g.maxZError-.5)){t=t.getUint8(1);f.ptr++;f.encodeMode=
t;if(2<t||4>h&&1<t)throw"Invalid Huffman flag "+t;t?z.readHuffman(e,f,n,k):z.readTiles(e,f,n,k)}else z.readTiles(e,f,n,k)}f.eofOffset=f.ptr;b.inputOffset?(e=f.headerInfo.blobSize+b.inputOffset-f.ptr,1<=Math.abs(e)&&(f.eofOffset=b.inputOffset+f.headerInfo.blobSize)):(e=f.headerInfo.blobSize-f.ptr,1<=Math.abs(e)&&(f.eofOffset=f.headerInfo.blobSize));e={width:g.width,height:g.height,pixelData:f.pixels.resultPixels,minValue:g.zMin,maxValue:g.zMax,validPixelCount:g.numValidPixel,dimCount:g.numDims,dimStats:{minValues:g.minValues,
maxValues:g.maxValues},maskData:f.pixels.resultMask};if(f.pixels.resultMask&&z.isValidPixelValue(g.imageType,d)){h=f.pixels.resultMask;for(g=0;g<p;g++)h[g]||(e.pixelData[g]=d);e.noDataValue=d}f.noDataValue=d;b.returnFileInfo&&(e.fileInfo=z.formatFileInfo(f));return e}},getBandCount:function(e){for(var b=0,d=0,g={ptr:0,pixels:{}};d<e.byteLength-58;)z.readHeaderInfo(e,g),d+=g.headerInfo.blobSize,b++,g.ptr=d;return b}}})},"esri/layers/pixelFilters/VectorFieldPixelFilter":function(){define("dojo/_base/declare dojo/_base/lang dojo/has ../../kernel ../../lang dojo/_base/array".split(" "),
function(L,z,H,e,b,d){L=L(null,{declaredClass:"esri.layers.pixelFilters.VectorFieldPixelFilter",speedUnits:["esriMetersPerSecond","esriKilometersPerHour","esriKnots","esriFeetPerSecond","esriMilesPerHour"],constructor:function(g){z.mixin(this,g);this.isDataUV=g&&g.isDataUV?g.isDataUV:!1;this.computeMagnitudeAndDirection=z.hitch(this,this.computeMagnitudeAndDirection);this.unitConversionFactor=1;this._updateUnitConvFactor()},setUnits:function(g,f){this.inputUnit=g;this.outputUnit=f;this.unitConversionFactor=
1;this._updateUnitConvFactor()},_updateUnitConvFactor:function(){var g=d.indexOf(this.speedUnits,this.inputUnit),f=d.indexOf(this.speedUnits,this.outputUnit);if(this.inputUnit&&this.outputUnit&&0<=g&&0<=f){var h=[1,.277778,.514444,.3048,.44704,0];this.unitConversionFactor=h[g]/h[f]}},computeMagnitudeAndDirection:function(g){if(!b.isDefined(g))throw"Could not compute magnitude and direction. No pixel data is available.";var f=g.pixelBlock;if(!b.isDefined(f)||2!==f.getPlaneCount())throw"Could not compute magnitude and direction. Pixel data does not contain two bands.";
var h=g.extent,n=(h.xmax-h.xmin)/f.width,p=(h.ymax-h.ymin)/f.height,k=h.xmin+n/2;h=h.ymax-p/2;f.statistics[0].minValue=0;f.statistics[0].maxValue=0;var t=180/Math.PI,u=[],r=0,A=0,x=0,E=!b.isDefined(f.mask),M,Q,S,N;var I=S=Infinity;var P=N=-Infinity;for(r=0;r<f.height;r++)for(A=0;A<f.width;A++,x++)if(u.push([k+n*A,h-p*r]),E||f.mask[x]){var K=M=f.pixels[0][x];var G=Q=f.pixels[1][x];this.isDataUV&&(K=Math.sqrt(M*M+Q*Q),G=90-t*Math.atan2(Q,M));f.pixels[0][x]=K*this.unitConversionFactor;f.pixels[1][x]=
G;K>P&&(P=K);K<I&&(I=K);G>N&&(N=G);G<S&&(S=G)}f.statistics[0].maxValue=P;f.statistics[0].minValue=I;f.statistics[1].maxValue=N;f.statistics[1].minValue=S;g.locations=u;return g}});H("extend-esri")&&z.setObject("layers.pixelFilters.VectorFieldPixelFilter",L,e);return L})},"esri/layers/rasterFormats/ImageCanvasDecoder":function(){define(["require","dojo/_base/declare","dojo/Deferred","dojo/sniff"],function(L,z,H,e){var b;return z(null,{constructor:function(d){this.ctx=d.ctx;this._loadRasterFormatModule()},
decode:function(d,g){if(!g.width||!g.height)throw"Native decoding requires the image format, width and height";var f=new H,h,n=new Uint8Array(d);d=this._getFormat(d);if("error"===d)throw"invalid format";"jpeg"===d&&(h=this._getMask(n,g));var p="",k;for(k=0;k<n.length;k+=65535){var t=n.subarray(k,k+65535>n.length-1?n.length-1:k+65535);p+=String.fromCharCode.apply(null,t)}n="data:image/"+d+";base64,"+window.btoa(p);var u=new Image,r;u.src=n;var A=this;u.onload=function(){A.ctx.clearRect(0,0,g.width,
g.height);A.ctx.drawImage(u,0,0);var x=A.ctx.getImageData(0,0,u.width,u.height);r=x.data;if(h)for(k=0;k<h.length;k++)r[4*k+3]=h[k]?255:0;A.ctx.putImageData(x,0,0);f.resolve(null)};u.onerror=function(){f.reject("cannot load image")};return f},_getFormat:function(d){d=new Uint8Array(d,0,10);var g="error";255===d[0]&&216===d[1]?g="jpeg":137===d[0]&&80===d[1]&&78===d[2]&&71===d[3]&&(g="png");return g},_getMask:function(d,g){try{if(!b)throw"The zlib decoder module is not loaded.";var f=0,h=0,n=Math.round(d.length/
2);1===n%2&&(n+=1);var p=d.length-2;for(f=n;f<p&&(255!==d[f]||217!==d[f+1]);f++);n=f+=2;if(n<d.length-1){var k=(new b(d.subarray(n))).getBytes();var t=new Uint8Array(g.width*g.height);for(f=d=0;f<k.length;f++)for(h=7;0<=h;h--)t[d++]=k[f]>>h&1}}catch(u){}return t},_loadRasterFormatModule:function(){10>e("ie")||L(["./Zlib"],function(d){b=d})}})})},"esri/tasks/ImageServiceIdentifyTask":function(){define("dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../request ../geometry/normalizeUtils ./Task ./ImageServiceIdentifyResult".split(" "),
function(L,z,H,e,b,d,g,f){L=L(g,{declaredClass:"esri.tasks.ImageServiceIdentifyTask",constructor:function(h){this._url.path+="/identify";this._handler=z.hitch(this,this._handler)},__msigns:[{n:"execute",c:3,a:[{i:0,p:["geometry"]}],e:2}],_handler:function(h,n,p,k,t){try{var u=new f(h);this._successHandler([u],"onComplete",p,t)}catch(r){this._errorHandler(r,k,t)}},execute:function(h,n,p,k){var t=k.assembly;h=this._encode(z.mixin({},this._url.query,{f:"json"},h.toJson(t&&t[0])));var u=this._handler,
r=this._errorHandler;return b({url:this._url.path,content:h,callbackParamName:"callback",load:function(A,x){u(A,x,n,p,k.dfd)},error:function(A){r(A,p,k.dfd)}})},onComplete:function(){}});d._createWrappers(L);H("extend-esri")&&z.setObject("tasks.ImageServiceIdentifyTask",L,e);return L})},"esri/tasks/ImageServiceIdentifyResult":function(){define("dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../geometry/jsonUtils ./FeatureSet".split(" "),function(L,z,H,e,b,d){L=L(null,{declaredClass:"esri.tasks.ImageServiceIdentifyResult",
constructor:function(g){g.catalogItems&&(this.catalogItems=new d(g.catalogItems));g.location&&(this.location=b.fromJson(g.location));this.catalogItemVisibilities=g.catalogItemVisibilities;this.name=g.name;this.objectId=g.objectId;this.value=g.value;this.processedValues=g.processedValues;this.properties=g.properties}});H("extend-esri")&&z.setObject("tasks.ImageServiceIdentifyResult",L,e);return L})},"esri/tasks/ImageServiceIdentifyParameters":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/json dojo/_base/array dojo/has ../kernel ../lang ../geometry/jsonUtils".split(" "),
function(L,z,H,e,b,d,g,f){L=L(null,{declaredClass:"esri.tasks.ImageServiceIdentifyParameters",geometry:null,mosaicRule:null,renderingRule:null,renderingRules:null,pixelSizeX:null,pixelSizeY:null,pixelSize:null,returnGeometry:!1,returnCatalogItems:!0,timeExtent:null,maxItemCount:null,returnPixelValues:!0,toJson:function(h){var n=h&&h.geometry||this.geometry;h={geometry:n,returnGeometry:this.returnGeometry,returnCatalogItems:this.returnCatalogItems,mosaicRule:this.mosaicRule?H.toJson(this.mosaicRule.toJson()):
null,renderingRule:this.renderingRule?H.toJson(this.renderingRule.toJson()):null};n&&(h.geometryType=f.getJsonType(n));n=this.timeExtent;h.time=n?n.toJson().join(","):null;g.isDefined(this.pixelSizeX)&&g.isDefined(this.pixelSizeY)?h.pixelSize=H.toJson({x:parseFloat(this.pixelSizeX),y:parseFloat(this.pixelSizeY)}):this.pixelSize&&(h.pixelSize=this.pixelSize?H.toJson(this.pixelSize.toJson()):null);this.renderingRules&&(h.renderingRules=H.toJson(e.map(this.renderingRules,function(p){return p.toJson()})));
g.isDefined(this.returnPixelValues)&&(h.returnPixelValues=this.returnPixelValues);g.isDefined(this.maxItemCount)&&(h.maxItemCount=this.maxItemCount);return h}});b("extend-esri")&&z.setObject("tasks.ImageServiceIdentifyParameters",L,d);return L})},"*noref":1}});
define("esri/layers/ArcGISImageServiceLayer","dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../config ./DynamicMapServiceLayer ./ImageServiceLayerMixin".split(" "),function(L,z,H,e,b,d,g){L=L([d,g],{declaredClass:"esri.layers.ArcGISImageServiceLayer",constructor:function(f,h){this._initialize(f,h);this.useMapImage=h&&h.useMapImage||!1},refresh:function(f){if(!0===f)this.inherited(arguments);else{var h=this.disableClientCaching;this.disableClientCaching=!0;this.inherited(arguments);this.disableClientCaching=
h}},setRenderer:function(f,h){this.renderer=f;this.onRendererChange();h||this.refresh(!0)},exportMapImage:function(f,h){var n=b.defaults.map;f=z.mixin({size:n.width+","+n.height},this._params,f?f.toJson(this.normalization):{},{f:"json"});delete f._ts;this._exportMapImage(this._url.path+"/exportImage",f,h)}});H("extend-esri")&&z.setObject("layers.ArcGISImageServiceLayer",L,e);return L});