// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/HeatmapManager","dojo/_base/declare dojo/_base/lang dojo/aspect dojo/_base/array require ../kernel ../sniff ../geometry/Point ../geometry/webMercatorUtils ./MapImage ../renderers/HeatmapRenderer ../tasks/query dojo/_base/fx".split(" "),function(m,r,w,t,x,y,z,A,B,C,u,D,v){function E(){}function F(b){var a=b.layer;return{geometry:b.geometry,attributes:b.attributes,getLayer:function(){return a}}}m=m(null,{declaredClass:"esri.layers.HeatmapManager",heatmapRenderer:null,sourceLayer:null,
imageLayer:null,useTiles:!0,useWorker:!1,map:null,constructor:function(b){this.sourceLayer=b;this._hndls=[]},initialize:function(b){this.map=b;var a=this.sourceLayer,c=a.renderer;a.setDrawMode(!1);this.imageLayer=b._getMapImageLyr();var d=this;this.heatmapRenderer=c instanceof u?c:(c.getRendererInfoByZoom(b.getZoom())||c.getRendererInfoByScale(b.getScale())).renderer;this.redraw=this.redraw.bind(this);this.recalculateHeatmap=this.recalculateHeatmap.bind(this);this._removeRenderer=this._removeRenderer.bind(this);
this._handleRendererChange=this._handleRendererChange.bind(this);this._rendererChangeHandle=this.sourceLayer.on("renderer-change",this._handleRendererChange);this._handleOpacityChange=this._handleOpacityChange.bind(this);this._reprojectFeature=this._reprojectFeature.bind(this);x(["../workers/heatmapCalculator"],function(e){d._calculator=new e(r.mixin({width:d.map.width,height:d.map.height},d._getOptions()));d._setupRenderer();d.heatmapRenderer.getStats=e.calculateStats;d.heatmapRenderer.getHistogramData=
e.getHistogramData})},destroy:function(){this._removeHandlers();this._rendererChangeHandle&&this._rendererChangeHandle.remove();this._rendererChangeHandle=this.sourceLayer=this.imageLayer=this.map=this.heatmapRenderer=this._hndls=null},_handleRendererChange:function(b){var a=b.renderer,c=a instanceof u;this.heatmapRenderer?c?this.heatmapRenderer=a:this._removeRenderer(b):c&&(this.heatmapRenderer=a,this.sourceLayer&&this.map&&this._setupRenderer())},_handleOpacityChange:function(b){b=b.opacity;var a=
this._getImageBySourceId(this.sourceLayer.id);a&&a.setOpacity(b)},_setupRenderer:function(){var b=this._hndls,a=this.sourceLayer,c=this.map,d=this;a._originalDraw=a._draw;a._draw=E;a._div.clear();clearTimeout(this._resetTimer);this._resetTimer=setTimeout(this._resetGraphics.bind(this),250);b.push(a.on("update-end",this.redraw));b.push(a.on("suspend",function(e){(e=d._getImageBySourceId(d.sourceLayer.id))&&e.hide()}));b.push(a.on("resume",function(e){(e=d._getImageBySourceId(d.sourceLayer.id))&&e.show()}));
b.push(w.after(a,"redraw",this.redraw));b.push(c.on("layer-remove",function(e){e.layer==a&&((e=d._getImageBySourceId(d.sourceLayer.id))&&d.imageLayer.removeImage(e),d._removeRenderer({target:a}))}));a._collection&&b.push(a.on("graphic-add",function(e){d._reprojectFeature(e.graphic);d.redraw()}));1!==a.mode&&(b.push(c.on("resize, pan-end",this.redraw)),b.push(c.on("zoom-end",this.redraw)));b.push(a.on("opacity-change",this._handleOpacityChange));this.imageLayer.suspended&&this.imageLayer.resume();
a.graphics&&a.graphics.length&&(a.graphics[0].geometry&&!c.spatialReference.equals(a.graphics[0].geometry.spatialReference)&&t.forEach(a.graphics,function(e){this._reprojectFeature(e)}.bind(this)),this.redraw())},redraw:function(){if(!this._drawTimer){var b=this;this._drawTimer=setTimeout(function(){clearTimeout(b._drawTimer);b._drawTimer=null;b.sourceLayer._getRenderer().isInstanceOf(u)&&b.recalculateHeatmap()},16)}},_removeRenderer:function(b){var a=b.target;a._draw=a._originalDraw;delete a._originalDraw;
a.setDrawMode(!0);this._removeHandlers();this._hndls=[];var c=this._getImageBySourceId(this.sourceLayer.id);c&&this.imageLayer.removeImage(c);clearTimeout(this._drawTimer);clearTimeout(this._resetTimer);this._drawTimer=this._resetTimer=null;a.renderer!=b.renderer&&a.renderer.getRendererInfo?this.heatmapRenderer=null:(this.destroy(),a.renderer&&a.renderer.getRendererInfo&&a.redraw())},recalculateHeatmap:function(){this._calculator?this._doMainCalculation():this._calculatorClient&&this._doWorkerCalculation()},
_reprojectFeature:function(b){if(b&&b.geometry){var a=b.geometry,c=this.map.spatialReference;c.equals(a.spatialReference)||(a=B.project(a,c),null==a?console.log("Unable to reproject features to map's spatial reference. Please convert feature geometry before adding to layer"):b.geometry=a)}},_doWorkerCalculation:function(){},_doMainCalculation:function(){var b=this.sourceLayer,a=this.map,c=this.heatmapRenderer,d=this.map.extent,e=this.map.width,n=this.map.height,g=this._calculator,h=this,k=function(f){f=
h._getScreenPoints(f.features,a,b);f=g.calculateImageData(r.mixin({screenPoints:f,mapinfo:{extent:[d.xmin,d.ymin,d.xmax,d.ymax],resolution:a.getResolution()},width:e,height:n},h._getOptions()));f=c.getSymbol(F({geometry:a.extent,attributes:{size:[e,n],imageData:f},layer:b}));f=new C({extent:a.extent,href:f.url,opacity:0,sourceId:b.id});h._swapMapImages(f,h._getImageBySourceId(b.id));b.suspended&&f.hide()},p={geometry:a.extent,timeExtent:b.useMapTime?a.timeExtent:void 0,spatialRelationship:D.SPATIAL_REL_INTERSECTS};
null!=b._canDoClientSideQuery(p)?b.queryFeatures(p,k):k({features:b.graphics})},_getScreenPoints:function(b,a,c){var d=[],e=b.length,n=0,g=0,h=new A(a.extent.xmin,a.extent.ymax,a.spatialReference),k=a.toScreen(h),p=k.x;k=k.y;var f=a.getResolution(),l;for((g=a.extent.getCacheValue("_parts"))&&(l=t.map(g,function(G){return c._intersects(a,G.extent)[0]}));e--;)if(g=b[e],g.geometry&&g.visible){var q={x:Math.ceil((g.geometry.x-h.x)/f+p),y:Math.floor((h.y-g.geometry.y)/f-k),attributes:g.attributes};l&&
(g=1<l.length&&q.x<-l[0]?l[1]:l[0],q.x+=g);d[n++]=q}return d},_getImageBySourceId:function(b){var a=this.imageLayer.getImages();a=t.filter(a,function(c){return c.sourceId==b});if(a.length)return a[a.length-1]},_swapMapImages:function(b,a){function c(){d.removeImage(a)}var d=this.imageLayer,e=this.sourceLayer.opacity;d.addImage(b);v.anim(b._node,{opacity:e},null,null,function(){b.opacity=e});null!=a&&v.anim(a._node,{opacity:0},null,null,c)},_removeHandlers:function(){if(null!=this._hndls)for(var b=
this._hndls.length;b--;)this._hndls[b].remove()},_getOptions:function(){var b=this.heatmapRenderer;return{blurRadius:b.blurRadius,gradient:b.gradient,maxPixelIntensity:b.maxPixelIntensity,minPixelIntensity:b.minPixelIntensity,field:b.field,fieldOffset:b.fieldOffset}},_resetGraphics:function(){clearTimeout(this._resetTimer);this._resetTimer=null;for(var b=this.sourceLayer.graphics,a=b.length,c;a--;)c=b[a],c._shape=c._offsets=void 0}});z("extend-esri")&&r.setObject("layers.HeatmapManager",m,y);return m});