// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/layer","dojo/_base/declare dojo/_base/config dojo/_base/connect dojo/_base/lang dojo/_base/Deferred dojo/_base/json dojo/has ../Evented ../kernel ../lang ../request ../deferredUtils ../urlUtils ../SpatialReference ../geometry/Extent".split(" "),function(u,v,h,g,w,x,q,y,m,k,z,A,r,t,B){var n=u([y],{declaredClass:"esri.layers.Layer",_eventMap:{error:["error"],load:["layer"],"opacity-change":["opacity"],"update-end":["error"],"visibility-change":["visible"]},constructor:function(a,
b){this._attrs={};a&&g.isString(a)?this._url=r.urlToObject(this.url=r.normalize(a)):(this.url=this._url=null,(b=b||a)&&(b.layerDefinition||b.query)&&(b=null));this.spatialReference=new t(4326);this.initialExtent=new B(-180,-90,180,90,new t(4326));this._map=this._div=null;this.normalization=!0;b&&(b.id&&(this.id=b.id),this.arcgisProps=b.arcgisProps,this.parentLayer=b.parentLayer,!1===b.visible&&(this.visible=!1),k.isDefined(b.opacity)&&(this.opacity=b.opacity),k.isDefined(b.minScale)&&this.setMinScale(b.minScale),
k.isDefined(b.maxScale)&&this.setMaxScale(b.maxScale),this.attributionDataUrl=b.attributionDataUrl||"",this.hasAttributionData=!!this.attributionDataUrl,k.isDefined(b.showAttribution)&&(this.showAttribution=b.showAttribution),this.className=b.className,this.refreshInterval=b.refreshInterval||0);this._errorHandler=g.hitch(this,this._errorHandler);this._scheduledRefresh=g.hitch(this,this._scheduledRefresh);this.refresh=g.hitch(this,this.refresh);if(this.managedSuspension){var c=this._setMap;this._setMap=
function(d){var e=c.apply(this,arguments);this._fireAttach(d);this.evaluateSuspension();if(this.suspended&&!d.loaded)var f=h.connect(d,"onLoad",this,function(){h.disconnect(f);f=null;this.evaluateSuspension()});return e}}this.registerConnectEvents()},id:null,visible:!0,opacity:1,loaded:!1,loadError:null,minScale:0,maxScale:0,visibleAtMapScale:!1,suspended:!0,attached:!1,attributionDataUrl:"",hasAttributionData:!1,showAttribution:!0,refreshInterval:0,_errorHandler:function(a){this.loaded||(this.loadError=
a);this.onError(a)},_setMap:function(a,b,c,d){this._map=a;this._lyrZEHandle=h.connect(a,"onZoomEnd",this,this._processMapScale);if(a.loaded)this.visibleAtMapScale=this._isMapAtVisibleScale();else var e=h.connect(a,"onLoad",this,function(){h.disconnect(e);e=null;this._processMapScale()})},_unsetMap:function(a,b){h.disconnect(this._lyrZEHandle);this._map=this._lyrZEHandle=null;this._resumedOnce=void 0;this.suspended=!0;this._fireDetach(a)},_fireAttach:function(a){this.attached=!0;this.onAttach({map:a})},
_fireDetach:function(a){this.attached=!1;this.onDetach({map:a})},_cleanUp:function(){this._map=this._div=null},_fireUpdateStart:function(){this.updating||(this.updating=!0,this.attr("data-updating",""),this.onUpdateStart(),this._map&&this._map._incr())},_fireUpdateEnd:function(a,b){this.updating&&(this.updating=!1,this.attr("data-updating"),this._refreshRT(),this.onUpdateEnd(a,b),this._map&&this._map._decr())},_getToken:function(){var a=this._url,b=this.credential;return a&&a.query&&a.query.token||
b&&b.token||void 0},_findCredential:function(){this.credential=m.id&&this._url&&m.id.findCredential(this._url.path)},_useSSL:function(){var a=this._url,b=/^http:/i;this.url&&(this.url=this.url.replace(b,"https:"));a&&a.path&&(a.path=a.path.replace(b,"https:"))},refresh:function(a){},show:function(){this.setVisibility(!0)},hide:function(){this.setVisibility(!1)},setMinScale:function(a){this.setScaleRange(a)},setMaxScale:function(a){this.setScaleRange(null,a)},setScaleRange:function(a,b){var c=k.isDefined(a),
d=k.isDefined(b);this.loaded||(this._hasMin=this._hasMin||c,this._hasMax=this._hasMax||d);var e=this.minScale,f=this.maxScale;this.minScale=(c?a:this.minScale)||0;this.maxScale=(d?b:this.maxScale)||0;if(e!==this.minScale||f!==this.maxScale)this.onScaleRangeChange(),this._processMapScale()},suspend:function(){this._suspended=!0;this.evaluateSuspension()},resume:function(){this._suspended=!1;this.evaluateSuspension()},canResume:function(){return this.loaded&&this._map&&this._map.loaded&&this.visible&&
this.visibleAtMapScale&&!this._suspended},evaluateSuspension:function(){this.canResume()?this.suspended&&this._resume():this.suspended||this._suspend()},_suspend:function(){this.suspended=!0;this.attr("data-suspended","");this.onSuspend();if(this._map)this._map.onLayerSuspend(this)},_resume:function(){this.suspended=!1;this.attr("data-suspended");var a=void 0===this._resumedOnce,b=this.className,c=this._attrs,d=this.getNode(),e;if(a){this._resumedOnce=!0;if(b&&d){var f=d.getAttribute("class")||"";
(new RegExp("(^|\\s)"+b+"(\\s|$)","i")).test(f)||d.setAttribute("class",f+((f?" ":"")+b))}if(c&&d)for(e in c)c.hasOwnProperty(e)&&d.setAttribute(e,c[e])}this._refreshRT();this.onResume({firstOccurrence:a});if(this._map)this._map.onLayerResume(this)},_processMapScale:function(){var a=this.visibleAtMapScale;this.visibleAtMapScale=this._isMapAtVisibleScale();a!==this.visibleAtMapScale&&(this.onScaleVisibilityChange(),this.evaluateSuspension())},isVisibleAtScale:function(a){return a?n.prototype._isMapAtVisibleScale.apply(this,
arguments):!1},_isMapAtVisibleScale:function(a,b){if(!(a||this._map&&this._map.loaded))return!1;var c=this._map;a=a||c.getScale();var d=this.minScale,e=this.maxScale,f=!d,l=!e,p;b&&(p=c.width>c.height?c.width:c.height);f||(a<=d?f=!0:b&&(f=Math.abs(d-a)/d<1/p));l||(a>=e?l=!0:b&&(l=Math.abs(e-a)/e<1/p));return f&&l},getAttributionData:function(){var a=this.attributionDataUrl,b=new w(A._dfdCanceller);this.hasAttributionData&&a?(b._pendingDfd=z({url:a,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}),
b._pendingDfd.then(function(c){b.callback(c)},function(c){b.errback(c)})):(a=Error("Layer does not have attribution data"),a.log=!!v.isDebug,b.errback(a));return b},getResourceInfo:function(){var a=this.resourceInfo;return g.isString(a)?x.fromJson(a):g.clone(a)},getMap:function(){return this._map},getNode:function(){return this._div},attr:function(a,b){var c=this.getNode();if("data-reference"===a&&11>q("ie"))return this;c&&(null==b?c.removeAttribute(a):c.setAttribute(a,b));this._attrs&&(null==b?delete this._attrs[a]:
this._attrs[a]=b);return this},setRefreshInterval:function(a){var b=this.refreshInterval;this.refreshInterval=a;this._toggleRT(!1);a&&this._toggleRT(!0);if(b!==a)this.onRefreshIntervalChange();return this},_toggleRT:function(a){a&&this.refreshInterval?(clearInterval(this._refreshTimer),this._refreshTimer=setInterval(this._scheduledRefresh,6E4*this.refreshInterval)):this._refreshTimer&&(clearInterval(this._refreshTimer),this._refreshTimer=null)},_refreshRT:function(){this._toggleRT(!1);this._toggleRT(!0)},
_scheduledRefresh:function(){this.onRefreshTick();!this._map||this.suspended||this.updating||this.refresh({scheduled:!0})},_refreshTS:null,_reCheckTS:/[\?&]_ts=/ig,_reReplaceTS:/([\?&]_ts=)[0-9]+/ig,addTimestampToURL:function(a){var b=this._refreshTS;b&&(a=this._reCheckTS.test(a)?a.replace(this._reReplaceTS,"$$$1"+b):a+((-1===a.indexOf("?")?"?":"\x26")+"_ts\x3d"+b));return a},setNormalization:function(a){this.normalization=a},setVisibility:function(a){this.visible!==a&&(this.visible=a,this.onVisibilityChange(this.visible),
this.evaluateSuspension());this.attr("data-hidden",a?null:"")},onLoad:function(){},onAttach:function(a){},onDetach:function(a){},onVisibilityChange:function(){},onScaleRangeChange:function(){},onScaleVisibilityChange:function(){},onSuspend:function(){},onResume:function(){},onUpdate:function(){},onUpdateStart:function(){},onUpdateEnd:function(){},onRefreshIntervalChange:function(){},onRefreshTick:function(){},onError:function(){}});q("extend-esri")&&g.setObject("layers.Layer",n,m);return n});