// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/rasterFormats/ImageCanvasDecoder",["require","dojo/_base/declare","dojo/Deferred","dojo/sniff"],function(q,r,t,u){var m;return r(null,{constructor:function(a){this.ctx=a.ctx;this._loadRasterFormatModule()},decode:function(a,e){if(!e.width||!e.height)throw"Native decoding requires the image format, width and height";var b=new t,f,c=new Uint8Array(a);a=this._getFormat(a);if("error"===a)throw"invalid format";"jpeg"===a&&(f=this._getMask(c,e));var h="",d;for(d=0;d<c.length;d+=65535){var k=
c.subarray(d,d+65535>c.length-1?c.length-1:d+65535);h+=String.fromCharCode.apply(null,k)}c="data:image/"+a+";base64,"+window.btoa(h);var g=new Image,n;g.src=c;var l=this;g.onload=function(){l.ctx.clearRect(0,0,e.width,e.height);l.ctx.drawImage(g,0,0);var p=l.ctx.getImageData(0,0,g.width,g.height);n=p.data;if(f)for(d=0;d<f.length;d++)n[4*d+3]=f[d]?255:0;l.ctx.putImageData(p,0,0);b.resolve(null)};g.onerror=function(){b.reject("cannot load image")};return b},_getFormat:function(a){a=new Uint8Array(a,
0,10);var e="error";255===a[0]&&216===a[1]?e="jpeg":137===a[0]&&80===a[1]&&78===a[2]&&71===a[3]&&(e="png");return e},_getMask:function(a,e){try{if(!m)throw"The zlib decoder module is not loaded.";var b=0,f=0,c=Math.round(a.length/2);1===c%2&&(c+=1);var h=a.length-2;for(b=c;b<h&&(255!==a[b]||217!==a[b+1]);b++);c=b+=2;if(c<a.length-1){var d=(new m(a.subarray(c))).getBytes();var k=new Uint8Array(e.width*e.height);for(b=a=0;b<d.length;b++)for(f=7;0<=f;f--)k[a++]=d[b]>>f&1}}catch(g){}return k},_loadRasterFormatModule:function(){10>
u("ie")||q(["./Zlib"],function(a){m=a})}})});