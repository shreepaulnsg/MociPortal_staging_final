// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/rasterFormats/Png",["./Zlib"],function(u){return function(){function m(a){var d,c;this.data=a;this.pos=8;this.palette=[];this.imgData=[];this.transparency={};this.animation=null;this.text={};for(c=null;;){var b=this.readUInt32();var e=a=void 0;a=[];for(e=0;4>e;++e)a.push(String.fromCharCode(this.data[this.pos++]));a=a.join("");switch(a){case "IHDR":this.width=this.readUInt32();this.height=this.readUInt32();this.bits=this.data[this.pos++];this.colorType=this.data[this.pos++];this.compressionMethod=
this.data[this.pos++];this.filterMethod=this.data[this.pos++];this.interlaceMethod=this.data[this.pos++];break;case "acTL":this.animation={numFrames:this.readUInt32(),numPlays:this.readUInt32()||Infinity,frames:[]};break;case "PLTE":this.palette=this.read(b);break;case "fcTL":c&&this.animation.frames.push(c);this.pos+=4;c={width:this.readUInt32(),height:this.readUInt32(),xOffset:this.readUInt32(),yOffset:this.readUInt32()};a=this.readUInt16();b=this.readUInt16()||100;c.delay=1E3*a/b;c.disposeOp=this.data[this.pos++];
c.blendOp=this.data[this.pos++];c.data=[];break;case "IDAT":case "fdAT":"fdAT"===a&&(this.pos+=4,b-=4);a=(null!=c?c.data:void 0)||this.imgData;for(e=0;0<=b?e<b:e>b;0<=b?++e:--e)a.push(this.data[this.pos++]);break;case "tRNS":this.transparency={};switch(this.colorType){case 3:this.transparency.indexed=this.read(b);b=255-this.transparency.indexed.length;if(0<b)for(a=0;0<=b?a<b:a>b;0<=b?++a:--a)this.transparency.indexed.push(255);break;case 0:this.transparency.grayscale=this.read(b)[0];break;case 2:this.transparency.rgb=
this.read(b)}break;case "tEXt":e=this.read(b);b=e.indexOf(0);a=String.fromCharCode.apply(String,e.slice(0,b));this.text[a]=String.fromCharCode.apply(String,e.slice(b+1));break;case "IEND":c&&this.animation.frames.push(c);a:{switch(this.colorType){case 0:case 3:case 4:c=1;break a;case 2:case 6:c=3;break a}c=void 0}this.colors=c;this.hasAlphaChannel=4===(d=this.colorType)||6===d;d=this.colors+(this.hasAlphaChannel?1:0);this.pixelBitlength=this.bits*d;a:{switch(this.colors){case 1:d="DeviceGray";break a;
case 3:d="DeviceRGB";break a}d=void 0}this.colorSpace=d;this.imgData=new Uint8Array(this.imgData);return;default:this.pos+=b}this.pos+=4;if(this.pos>this.data.length)throw Error("Incomplete or corrupt PNG file");}}m.load=function(a,d,c){"function"===typeof d&&(c=d);var b=new XMLHttpRequest;b.open("GET",a,!0);b.responseType="arraybuffer";b.onload=function(){var e=new Uint8Array(b.response||b.mozResponseArrayBuffer);e=new m(e);"function"===typeof(null!=d?d.getContext:void 0)&&e.render(d);return"function"===
typeof c?c(e):void 0};return b.send(null)};m.prototype.read=function(a){var d;var c=[];for(d=0;0<=a?d<a:d>a;0<=a?++d:--d)c.push(this.data[this.pos++]);return c};m.prototype.readUInt32=function(){var a=this.data[this.pos++]<<24;var d=this.data[this.pos++]<<16;var c=this.data[this.pos++]<<8;var b=this.data[this.pos++];return a|d|c|b};m.prototype.readUInt16=function(){var a=this.data[this.pos++]<<8;var d=this.data[this.pos++];return a|d};m.prototype.decodePixels=function(a){var d,c,b,e,f,g,l,h;null==
a&&(a=this.imgData);if(0===a.length)return new Uint8Array(0);a=new u(a);a=a.getBytes();var k=this.pixelBitlength/8;var q=k*this.width;var n=new Uint8Array(q*this.height);var v=a.length;for(c=e=f=0;e<v;){switch(a[e++]){case 0:for(b=d=0;d<q;b=d+=1)n[c++]=a[e++];break;case 1:for(b=g=0;g<q;b=g+=1){d=a[e++];var p=b<k?0:n[c-k];n[c++]=(d+p)%256}break;case 2:for(b=p=0;p<q;b=p+=1){d=a[e++];var r=(b-b%k)/k;g=f&&n[(f-1)*q+r*k+b%k];n[c++]=(g+d)%256}break;case 3:for(b=h=0;h<q;b=h+=1)d=a[e++],r=(b-b%k)/k,p=b<k?
0:n[c-k],g=f&&n[(f-1)*q+r*k+b%k],n[c++]=(d+Math.floor((p+g)/2))%256;break;case 4:for(b=h=0;h<q;b=h+=1){d=a[e++];r=(b-b%k)/k;p=b<k?0:n[c-k];0===f?g=l=0:(g=n[(f-1)*q+r*k+b%k],l=r&&n[(f-1)*q+(r-1)*k+b%k]);var t=p+g-l;b=Math.abs(t-p);r=Math.abs(t-g);t=Math.abs(t-l);p=b<=r&&b<=t?p:r<=t?g:l;n[c++]=(d+p)%256}break;default:throw Error("Invalid filter algorithm: "+a[e-1]);}f++}return n};m.prototype.decodePalette=function(){var a,d,c,b,e;var f=this.palette;var g=this.transparency.indexed||[];var l=new Uint8Array((g.length||
0)+f.length);var h=c=a=d=0;for(b=f.length;c<b;h=c+=3)l[d++]=f[h],l[d++]=f[h+1],l[d++]=f[h+2],l[d++]=null!=(e=g[a++])?e:255;return l};m.prototype.copyToImageData=function(a,d){var c,b;var e=this.colors;var f=null;var g=this.hasAlphaChannel;this.palette.length&&(f=null!=(c=this._decodedPalette)?c:this._decodedPalette=this.decodePalette(),e=4,g=!0);a=a.data||a;var l=a.length;var h=f||d;c=b=0;if(1===e)for(;c<l;)e=f?4*d[c/4]:b,b=h[e++],a[c++]=b,a[c++]=b,a[c++]=b,a[c++]=g?h[e++]:this.transparency.grayscale&&
this.transparency.grayscale===b?0:255,b=e;else for(;c<l;)e=f?4*d[c/4]:b,a[c++]=h[e++],a[c++]=h[e++],a[c++]=h[e++],a[c++]=g?h[e++]:this.transparency.rgb&&this.transparency.rgb[1]===h[e-3]&&this.transparency.rgb[3]===h[e-2]&&this.transparency.rgb[5]===h[e-1]?0:255,b=e};m.prototype.decode=function(){var a=new Uint8Array(this.width*this.height*4);this.copyToImageData(a,this.decodePixels());return a};var w=function(a){(void 0).clearRect(0,0,a.width,a.height);(void 0).putImageData(a,0,0);a=new Image;a.src=
(void 0).toDataURL();return a};m.prototype.decodeFrames=function(a){var d,c;if(this.animation){var b=this.animation.frames;var e=[];var f=d=0;for(c=b.length;d<c;f=++d){f=b[f];var g=a.createImageData(f.width,f.height);var l=this.decodePixels(new Uint8Array(f.data));this.copyToImageData(g,l);f.imageData=g;e.push(f.image=w(g))}return e}};m.prototype.renderFrame=function(a,d){var c=this.animation.frames;var b=c[d];c=c[d-1];0===d&&a.clearRect(0,0,this.width,this.height);1===(null!=c?c.disposeOp:void 0)?
a.clearRect(c.xOffset,c.yOffset,c.width,c.height):2===(null!=c?c.disposeOp:void 0)&&a.putImageData(c.imageData,c.xOffset,c.yOffset);0===b.blendOp&&a.clearRect(b.xOffset,b.yOffset,b.width,b.height);return a.drawImage(b.image,b.xOffset,b.yOffset)};m.prototype.animate=function(a){var d,c=this;var b=0;var e=this.animation;var f=e.numFrames;var g=e.frames;var l=e.numPlays;return(d=function(){var h=b++%f;var k=g[h];c.renderFrame(a,h);if(1<f&&b/f<l)return c.animation._timeout=setTimeout(d,k.delay)})()};
m.prototype.stopAnimation=function(){var a;return clearTimeout(null!=(a=this.animation)?a._timeout:void 0)};m.prototype.render=function(a){a._png&&a._png.stopAnimation();a._png=this;a.width=this.width;a.height=this.height;a=a.getContext("2d");if(this.animation)return this.decodeFrames(a),this.animate(a);var d=a.createImageData(this.width,this.height);this.copyToImageData(d,this.decodePixels());return a.putImageData(d,0,0)};return m}()});