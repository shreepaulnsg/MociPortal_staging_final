// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/rasterFormats/rasterCodec","require dojo/_base/declare dojo/_base/lang dojo/_base/Deferred ../PixelBlock ./LercCodec ./Lerc2Codec ./JpgPlus ./Png ./Raw ./TiffDecoder".split(" "),function(C,D,x,y,q,z,A,v,w,u,B){return{validPixelTypes:"U1 U2 U4 U8 U16 U32 S8 S16 S32 F32".split(" "),supportedFormats:"lerc jpeg jpg jpgpng png png8 png24 png32 bip bsq tiff".split(" "),_isPlatformLittleEndian:function(){var a=new ArrayBuffer(4),b=new Uint8Array(a);(new Uint32Array(a))[0]=1;return 1===
b[0]}(),decode:function(a,b){if(void 0===b||null===b)throw"missing decode options";var d;b.format&&(d=b.format.toUpperCase());"BSQ"!==d&&"BIP"!==d&&(d=this._getFormat(a));var c=b.decodeFunc;if(void 0===c||null===c)c=this._getFormatDecoderDfd(d);return c(a,b)},_getFormatDecoderDfd:function(a){var b=null;switch(a){case "LERC":b=this._decodeLerc;break;case "LERC2":b=this._decodeLerc2;break;case "JPEG":b=this._decodeJpeg;break;case "PNG":b=this._decodePng;break;case "BSQ":b=this._decodeBsq;break;case "BIP":b=
this._decodeBip;break;case "TIFF":b=this._decodeTiff;break;default:b=function(d,c){throw"The raster format is not supported";}}b=x.hitch(this,b);return function(d,c){var e=new y;c.isPoint&&c.width&&(c.width++,c.height++);d=b(d,c);c.isPoint&&c.width&&(this._interpolatePointGrid(d),c.width--,c.height--);e.resolve(d);return e}.bind(this)},_getFormat:function(a){a=new Uint8Array(a,0,10);var b="";if(255===a[0]&&216===a[1])b="JPEG";else if(137===a[0]&&80===a[1]&&78===a[2]&&71===a[3])b="PNG";else if(67===
a[0]&&110===a[1]&&116===a[2]&&90===a[3]&&73===a[4]&&109===a[5]&&97===a[6]&&103===a[7]&&101===a[8]&&32===a[9])b="LERC";else if(76===a[0]&&101===a[1]&&114===a[2]&&99===a[3]&&50===a[4]&&32===a[5])b="LERC2";else if(-1<String.fromCharCode.apply(null,a).toLowerCase().indexOf("error"))b="ERROR";else if(73===a[0]&&73===a[1]&&42===a[2]&&0===a[3]||77===a[0]&&77===a[1]&&0===a[2]&&42===a[3])b="TIFF";return b},_validateDecodeParams:function(a){if(!a.height||Math.floor(a.height)!==a.height)throw"Height not provided.";
if(!a.width||Math.floor(a.width)!==a.width)throw"Width not provided.";},_decodeJpeg:function(a,b){if(!v)throw"The jpeg decoder module is not loaded.";this._validateDecodeParams(b);a=(new v).decode(a);if(!this._verifyResult(a,b))throw"The decoded image dimensions are incorrect.";b=new q({width:a.width,height:a.height,pixels:a.pixels,pixelType:"U8",mask:a.mask,statistics:null});b.calculateStatistics();return b},_decodePng:function(a,b){if(!w)throw"The png decoder module is not loaded.";this._validateDecodeParams(b);
a=new Uint8Array(a);var d=new w(a);a=new Uint8Array(b.width*b.height*4);d.copyToImageData(a,d.decodePixels());var c=d=0;c=new Uint8Array(b.width*b.height);for(d=0;d<b.width*b.height;d++)c[d]=a[4*d+3];var e=new q({width:b.width,height:b.height,pixels:[],pixelType:"U8",mask:c,statistics:[]});for(d=0;3>d;d++){var h=new Uint8Array(b.width*b.height);for(c=0;c<b.width*b.height;c++)h[c]=a[4*c+d];e.addData({pixels:h})}e.calculateStatistics();return e},_decodeBsq:function(a,b){if(!u)throw"The bsq decoder module is not loaded.";
this._validateDecodeParams(b);var d=b.noDataValue;b.pixelType=this._getpixelTypeAndNoData(b.pixelType);a=u.decodeBSQ(a,{bandCount:b.planes,width:b.width,height:b.height,pixelType:b.pixelType,noDataValue:d});b=new q({width:b.width,height:b.height,pixels:a.pixels,pixelType:b.pixelType,mask:a.maskData,statistics:null});b.calculateStatistics();return b},_decodeBip:function(a,b){this._validateDecodeParams(b);var d=b.noDataValue;b.pixelType=this._getpixelTypeAndNoData(b.pixelType);a=u.decodeBIP(a,{bandCount:b.planes,
width:b.width,height:b.height,pixelType:b.pixelType,noDataValue:d});b=new q({width:b.width,height:b.height,pixels:a.pixels,pixelType:b.pixelType,mask:a.maskData,statistics:null});b.calculateStatistics();return b},_decodeTiff:function(a,b){this._validateDecodeParams(b);b.pixelType=this._getpixelTypeAndNoData(b.pixelType);a=B.decode(a);a=new q({width:a.width,height:a.height,pixels:a.pixels,pixelType:a.pixelType,mask:a.maskData,statistics:null});a.calculateStatistics();return a},_decodeLerc:function(a,
b){if(!this._isPlatformLittleEndian)throw"lerc decoder is not supported on big endian platform";this._validateDecodeParams(b);var d=b.noDataValue;b.pixelType=this._getpixelTypeAndNoData(b.pixelType);for(var c=0,e,h=0,k,l=a.byteLength-10;h<l;){var m=z.decode(a,{inputOffset:h,encodedMaskData:e,returnMask:0===c?!0:!1,returnEncodedMask:0===c?!0:!1,returnFileInfo:!0,pixelType:b.pixelType,noDataValue:d});h=m.fileInfo.eofOffset;0===c&&(e=m.encodedMaskData,k=new q({width:b.width,height:b.height,pixels:[],
pixelType:b.pixelType,mask:m.maskData,statistics:[]}));c++;if(!this._verifyResult(m,b))throw"The decoded image dimensions are incorrect";k.addData({pixels:m.pixelData,statistics:{minValue:m.minValue,maxValue:m.maxValue,noDataValue:m.noDataValue}})}return k},_decodeLerc2:function(a,b){if(!this._isPlatformLittleEndian)throw"lerc2 decoder is not supported on big endian platform";this._validateDecodeParams(b);b.pixelType=this._getpixelTypeAndNoData(b.pixelType);for(var d=0,c,e,h,k=0,l,m=a.byteLength-
10,g=[],f,p=0;k<m;){e=A.decode(a,{inputOffset:k,maskData:c,returnFileInfo:!0});k=e.fileInfo.eofOffset;c=e.maskData;0===d&&(h=e.fileInfo.numValidPixel,l=new q({width:b.width,height:b.height,pixels:[],dimCount:e.dimCount||1,pixelType:e.fileInfo.pixelType,mask:c,statistics:[]}));e.fileInfo.mask&&0<e.fileInfo.mask.numBytes&&p++;c&&g.push(c);d++;if(!this._verifyResult(e,b))throw"The decoded image dimensions are incorrect";l.addData({pixels:e.pixelData,statistics:{minValue:e.minValue,maxValue:e.maxValue,
noDataValue:e.noDataValue,dimStats:e.dimStats}})}if(1<p){b=l.width*l.height;l.bandMasks=g;c=new Uint8Array(b);c.set(g[0]);for(h=1;h<g.length;h++)for(f=g[h],a=0;a<b;a++)c[a]&=f[a];for(a=h=0;a<b;a++)h+=f[a];l.mask=c}l.validPixelCount=h;return l},_interpolatePointGrid:function(a,b){var d=a.pixels;if(d&&0!==d.length){var c=d.length,e=a.width,h=a.mask,k=e-1,l=a.height-1,m=[],g,f;if(0===(null==b?1:b)){for(b=0;b<c;b++){var p=d[b];var r=new p.constructor(k*l);for(g=0;g<l;g++){var n=g*e;for(f=0;f<k;f++)r[g*
k+f]=p[n+f]}m.push(r)}if(h){var t=new Uint8Array(k*l);for(g=0;g<l;g++)for(n=g*e,f=0;f<k;f++)t[g*k+f]=h[n+f]}}else{for(b=0;b<c;b++){p=d[b];r=new p.constructor(k*l);for(g=0;g<l;g++)for(n=g*e,f=0;f<k;f++)r[g*k+f]=(p[n+f]+p[n+f+1]+p[n+e+f]+p[n+e+f+1])/4;m.push(r)}if(h)for(t=new Uint8Array(k*l),g=0;g<l;g++)for(n=g*e,f=0;f<k;f++)t[g*k+f]=Math.min.apply(null,[h[n+f],h[n+f+1],h[n+e+f],h[n+e+f+1]])}a.width=k;a.height=l;a.mask=t;a.pixels=m;return a}},_getpixelTypeAndNoData:function(a){return"U1"===a||"U2"===
a||"U4"===a||"U8"===a?"U8":a},_verifyResult:function(a,b){return a.height!==b.height||a.width!==b.width?!1:!0}}});