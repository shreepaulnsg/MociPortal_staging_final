// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/layers/StreamMode","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/Deferred dojo/has ../kernel ../SpatialReference ../tasks/query ../tasks/QueryTask ../geometry/jsonUtils ./RenderMode".split(" "),function(n,p,q,u,v,w,x,y,z,A,B){n=n([B],{declaredClass:"esri.layers._StreamMode",constructor:function(a,b){this.featureLayer=a;this._featureMap={};this._setRefreshRate();this._drawBuffer={adds:[],updates:[]};this._timeoutId=null;this._flushDrawBuffer=p.hitch(this,this._flushDrawBuffer);
this._featuresByTime={};this._lastEndTimeCheck=null;this._maxFeatureAge=0;a.purgeOptions&&a.purgeOptions.age&&"number"===typeof a.purgeOptions.age&&(this._maxFeatureAge=1E3*Math.ceil(60*a.purgeOptions.age));this._drawFeatures=p.hitch(this,this._drawFeatures);this._queryErrorHandler=p.hitch(this,this._queryErrorHandler)},startup:function(){this._started||this.inherited(arguments)},propertyChangeHandler:function(a){this._init&&(0===a?this._applyTimeFilter():3===a?this._redrawAllTracks():console.debug("StreamLayer: Stream Layer only supports changing map time or maximumTrackPoints. Layer id \x3d "+
this.featureLayer.id))},destroy:function(){this.inherited(arguments);clearTimeout(this._timeoutId);this._featuresByTime=this._drawBuffer=this._featureMap=null},drawFeature:function(a){var b=this.featureLayer,c=b.objectIdField;this._timeoutId||(this._timeoutId=setTimeout(this._flushDrawBuffer,this._refreshRate));b._joinField&&this._getFeature(a.attributes[c])?this._drawBuffer.updates.push({oid:a.attributes[c],updates:a}):this._drawBuffer.adds.push(a)},resume:function(){this.propertyChangeHandler(0)},
refresh:function(){this._pendingRequest&&this._cancelPendingRequest(this._pendingRequest);var a=this.featureLayer;a&&(a._relatedUrl||a._keepLatestUrl?(a._fireUpdateStart(),a._refreshing=!0,a.disconnect(),a.clear(),a._relatedQueried=!1,a._keepLatestQueried=!1,a.connect()):(a._fireUpdateStart(),a.clear(),a._fireUpdateEnd()))},_drawFeatures:function(a,b){var c=this.featureLayer;c._create(a.features||[]);c._fireUpdateEnd(null,b)},_applyTimeFilter:function(a){this.inherited(arguments);this._redrawAllTracks()},
_removeFeatures:function(a){var b=this.featureLayer,c=b.objectIdField;a&&q.forEach(a,function(d){d=d.attributes[c];b._unSelectFeatureIIf(d,this);this._decRefCount(d);this._removeFeatureIIf(d)},this)},_addFeatures:function(a){var b=this.featureLayer,c=b._endTimeField,d=b._startTimeField,f,e=[],g=[],k=[];var h=b._trackManager;var t=b.objectIdField;if(h)for(f in a=h.addFeatures(a),a)a.hasOwnProperty(f)&&(e.push(f),a[f].adds&&(g=g.concat(a[f].adds)),a[f].deletes&&(k=k.concat(a[f].deletes)));else g=a;
q.forEach(g,function(m){var r=m.attributes[t];var l=c&&m.attributes[c];!l&&this._maxFeatureAge&&(l=d&&m.attributes[d]?m.attributes[d]+this._maxFeatureAge:Date.now()+this._maxFeatureAge);l&&(l=1E3*Math.ceil(l/1E3),this._featuresByTime[l]?this._featuresByTime[l].push(r):this._featuresByTime[l]=[r]);this._addFeatureIIf(r,m);this._incRefCount(r)},this);k.length&&this._removeFeatures(k);h&&h.refreshTracks(e)},_updateFeatures:function(a){var b=this.featureLayer,c=[];var d=b._trackManager;var f=b._trackIdField;
q.forEach(a,function(e){var g=e.updates;e=this._getFeature(e.oid);var k;if(e){g.geometry&&e.setGeometry(g.geometry);g=g.attributes||{};for(k in g)g.hasOwnProperty(k)&&(e.attributes[k]=g[k]);e.setAttributes(e.attributes);e.visible=this._checkFeatureTimeIntersects(e);d&&e.attributes[f]?c.push(e.attributes[f]):b._repaint(e,null,!0)}},this);c.length&&d.refreshTracks(c)},_redrawAllTracks:function(){var a=this.featureLayer._trackManager,b;a&&(b=a.trimTracks())&&0<b.length&&(this._removeFeatures(b),a.refreshTracks())},
_flushDrawBuffer:function(){clearTimeout(this._timeoutId);var a=this._drawBuffer,b=a.adds.splice(0,a.adds.length),c=a.updates.splice(0,a.updates.length);a=this.featureLayer;if(!a)return!1;a.updating||a._fireUpdateStart();this._addFeatures(b);this._updateFeatures(c);(b=this._getExpiredFeatures())&&b.length&&(this._removeFeatures(b),a._trackManager&&a._trackManager.removeFeatures(b));a._purge();a._fireUpdateEnd();this._timeoutId=null},_clearDrawBuffer:function(){var a=this._timeoutId,b=this._drawBuffer,
c=b.adds;b=b.updates;a&&clearTimeout(a);c.splice(0,c.length);b.splice(0,b.length);this._timeoutId=null},_clearTimeBin:function(){this._featuresByTime={};this._lastEndTimeCheck=1E3*Math.ceil(Date.now()/1E3)},_clearFeatureMap:function(){this._featureMap={}},_setRefreshRate:function(a){a=a||0===a?a:200;0>a&&(a=200);this._refreshRate=a},_checkFeatureTimeIntersects:function(a){var b=this.featureLayer,c=b.getMap();return(c=c?c.timeExtent:null)&&b.timeInfo&&(b.timeInfo.startTimeField||b.timeInfo.endTimeField)?
0<b._filterByTime([a],c.startTime,c.endTime).match.length:!0},_fetchArchive:function(a){var b=new u,c=this.featureLayer;this._pendingRequest&&this._cancelPendingRequest(this._pendingRequest);c._fireUpdateStart();if(a&&this.map){a=new z(a);var d=new y;var f=this.map;var e=c.getFilter()||{};var g=e.where||"1\x3d1";var k=e.geometry?A.fromJson(e.geometry):null;e=e.outFields?e.outFields.split(","):["*"];d.geometry=k;d.where=g;d.outFields=e;d.returnGeometry=!0;d.outSpatialReference=new x(f.spatialReference.toJson());
this._pendingRequest=a.execute(d).then(function(h){this._pendingRequest=null;var t=this._fixFieldNameCasing(c,h);h.features=t;this._drawFeatures(h);c._fireUpdateEnd();b.resolve()}.bind(this)).otherwise(function(h){this._pendingRequest=null;c._errorHandler(h);c._fireUpdateEnd(h);b.reject(h)}.bind(this))}else b.resolve();return b.promise},_queryErrorHandler:function(a){var b=this.featureLayer;b._errorHandler(a);b._fireUpdateEnd(a)},_fixFieldNameCasing:function(a,b){var c=b.features||[],d=b.fields;if(!d||
!c.length)return c;a=this._mapFieldNameDifferences(a.fields,d);d=[];for(var f,e=0,g=b.features.length;e<g;e++)b=c[e],f=this._swizzleResponseAttributes(b.attributes,a),d.push({geometry:b.geometry,attributes:f});return d},_mapFieldNameDifferences:function(a,b){var c=[],d={},f;var e=0;for(f=b.length;e<f;e++)c.push(b[e].name);e=0;for(f=a.length;e<f;e++){b=a[e].name;var g=this._checkForStreamFieldName(b,c);g&&(d[g]=b)}return d},_checkForStreamFieldName:function(a,b){a=a.toLowerCase();for(var c,d=0,f=b.length;d<
f;d++)if(b[d].toLowerCase()===a){c=b[d];break}return c},_swizzleResponseAttributes:function(a,b){var c={},d;for(d in a)if(a.hasOwnProperty(d)){var f=a[d];b.hasOwnProperty(d)?c[b[d]]=f:c[d]=f}return c},_getExpiredFeatures:function(){var a,b,c=[],d=[];if(!this.featureLayer._endTimeField&&!this._maxFeatureAge)return d;var f=1E3*Math.floor(this._lastEndTimeCheck/1E3);this._lastEndTimeCheck=a=1E3*Math.ceil(Date.now()/1E3);if(f&&f!==a)for(b=this._featuresByTime;f<=a;f+=1E3)b[f]&&(c=c.concat(b[f]),delete b[f]);
q.forEach(c,function(e){(e=this._getFeature(e))&&d.push(e)},this);return d}});v("extend-esri")&&p.setObject("layers._StreamMode",n,w);return n});