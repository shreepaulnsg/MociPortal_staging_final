// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/toolbars/_VertexMover","dojo/_base/declare dojo/_base/lang dojo/_base/connect dojo/sniff dojo/dom-style dojox/gfx/Moveable dojox/gfx/matrix ../kernel ../PointerEvents ../sniff ../geometry/Point ../graphic ../geometry/webMercatorUtils".split(" "),function(m,q,k,r,t,w,u,x,y,p,z,A,v){m=m(null,{declaredClass:"esri.toolbars.VertexMover",constructor:function(a,b,c,e,h,g,f,d){this.point=a;this.symbol=b;this.relatedGraphic=c;this.segIndex=e;this.ptIndex=h;this.segLength=g;this.editor=f;this.map=
f.map;this._scratchGL=f.toolbar._scratchGL;this._placeholder=d||!1;this._type=c.geometry.type;this._init();this._enable()},refresh:function(a){if(a||this._needRefresh())this._disable(),this._enable()},destroy:function(){this._disable();this.graphic&&this._scratchGL.remove(this.graphic);this.point=this.symbol=this.graphic=this.relatedGraphic=this.segIndex=this.ptIndex=this.segLength=this.editor=this.map=this._scratchGL=null},_init:function(){var a=new z(this.point.toJson());a=new A(a,this.symbol);
switch(this._type){case "multipoint":a._shape=this.relatedGraphic.getDojoShape().children[this.ptIndex];break;case "polyline":case "polygon":this._scratchGL.add(a)}this.graphic=a},_enable:function(){var a=this.graphic.getDojoShape();a&&(a._hasMover=!0,this._moveable=this._getMoveable(a),(a=a.getEventSource())&&t.set(a,"cursor",this.editor.toolbar._cursors[this._placeholder?"move-gv":"move-v"]))},_disable:function(){var a=this._moveable;if(a){k.disconnect(this._startHandle);k.disconnect(this._firstHandle);
k.disconnect(this._movingHandle);k.disconnect(this._stopHandle);var b=a.shape;b&&(b=b.getEventSource())&&t.set(b,"cursor","inherit");a.destroy();this._moveable=null}},_needRefresh:function(){var a=this.graphic.getDojoShape(),b=!1;if(a)switch(this._type){case "multipoint":var c=this.relatedGraphic.getDojoShape();c&&(c=c.children[this.ptIndex],a!==c&&(this.graphic._shape=c,b=!0));break;case "polyline":case "polygon":b=!a._hasMover}return b},_getMoveable:function(a){a=new w(a,r("mac")&&r("ff")&&!p("esri-touch")&&
{leftButtonOnly:!0});this._startHandle=k.connect(a,"onMoveStart",this,this._moveStartHandler);this._firstHandle=k.connect(a,"onFirstMove",this,this._firstMoveHandler);this._movingHandle=k.connect(a,"onMoving",this,this._movingHandler);this._stopHandle=k.connect(a,"onMoveStop",this,this._moveStopHandler);return a},_getPtIndex:function(){return this.ptIndex+(this._placeholder?1:0)},_getInfo:function(){return{graphic:this.graphic,isGhost:this._placeholder,segmentIndex:this.segIndex,pointIndex:this._getPtIndex()}},
_moveStartHandler:function(a){var b=this.map;b.snappingManager&&b.snappingManager._setUpSnapping();this.editor.toolbar._deactivateScrollWheel();this._startTx=this.graphic.getDojoShape().getTransform();a.shape.moveToFront();this.constructor.onMoveStart(this);this.editor.toolbar.onVertexMoveStart(this.relatedGraphic,this._getInfo())},_firstMoveHandler:function(a){var b=a.shape,c=this._getControlEdges(),e=this._scratchGL._div,h,g=[],f=a.host.shape._wrapOffsets[0]||0;for(h=0;h<c.length;h++){var d=c[h];
d.x1+=f;d.x2+=f;g.push([e.createLine({x1:d.x1,y1:d.y1,x2:d.x2,y2:d.y2}).setStroke(this.editor._lineStroke),d.x1,d.y1,d.x2,d.y2])}b._lines=g;a.shape.moveToFront();this.constructor.onFirstMove(this);this.editor.toolbar.onVertexFirstMove(this.relatedGraphic,this._getInfo())},_movingHandler:function(a,b,c){b=this.map;var e;p("esri-pointer")?e=b.navigationManager.pointerEvents._processTouchEvent(c,c):c&&"pointermove"===c.type&&(e=y.prototype._processTouchEvent.call({map:b},c,c));e&&b.snappingManager&&
b.snappingManager._onSnappingMouseMoveHandler(e);c=a.shape;a=c.getTransform();c=c._lines;for(e=0;e<c.length;e++)b=c[e],b[0].setShape({x1:b[1]+a.dx,y1:b[2]+a.dy,x2:b[3],y2:b[4]});this.editor.toolbar.onVertexMove(this.relatedGraphic,this._getInfo(),a)},_moveStopHandler:function(a){a=a.shape;var b=this.editor.toolbar,c=a.getTransform(),e=this.map,h=this.graphic,g=b._geo?v.geographicToWebMercator(h.geometry):h.geometry;b._activateScrollWheel();var f,d=a._lines;if(d){for(f=0;f<d.length;f++)d[f][0].removeShape();
a._lines=null}f=!1;d=!0;var l=this._getInfo();c&&(c.dx||c.dy)?this._placeholder&&(this._placeholder=!1,f=!0):d=!1;if(e.snappingManager)var n=e.snappingManager._snappingPoint;var B=[c,u.invert(this._startTx)];n=n||e.toMap(u.multiplyPoint(B,e.toScreen(g,!0)));e.snappingManager&&e.snappingManager._killOffSnapping();a.setTransform(null);h.setGeometry(b._geo?v.webMercatorToGeographic(n,!0):n);this.constructor.onMoveStop(this,c);b.onVertexMoveStop(this.relatedGraphic,l,c);if(!d)b.onVertexClick(this.relatedGraphic,
l);if(f)b.onVertexAdd(this.relatedGraphic,this._getInfo())},_getControlEdges:function(){var a=this.map,b=this.relatedGraphic.geometry,c=this.segIndex,e=this.ptIndex,h=this.segLength,g=this._scratchGL.getNavigationTransform(),f=g.dx;g=g.dy;var d=a.toScreen(this.graphic.geometry);a=d.x-f;d=d.y-g;var l=[];b=this.editor._getControlPoints(this,b,c,e,h);b[0]&&l.push({x1:a,y1:d,x2:b[0].x-f,y2:b[0].y-g});b[1]&&l.push({x1:a,y1:d,x2:b[1].x-f,y2:b[1].y-g});return l}});p("extend-esri")&&q.setObject("toolbars.VertexMover",
m,x);q.mixin(m,{onMoveStart:function(){},onFirstMove:function(){},onMoveStop:function(){}});return m});