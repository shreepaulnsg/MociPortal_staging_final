// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/toolbars/_Box","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/Color dojo/has dojo/dom-style dojox/gfx/Moveable dojox/gfx/matrix ../kernel ../lang ../geometry/Point ../geometry/Polyline ../symbols/SimpleMarkerSymbol ../geometry/webMercatorUtils ../geometry/jsonUtils ../graphic".split(" "),function(n,m,k,p,E,w,x,y,l,z,A,q,B,F,t,C,u){n=n(null,{declaredClass:"esri.toolbars._Box",constructor:function(a,b,c,d,e,f,g){this._graphic=a;this._map=b;this._toolbar=
c;this._scale=d;this._rotate=e;this._defaultEventArgs={};this._scaleEvent="Scale";this._rotateEvent="Rotate";this._uniformScaling=f;a=c._options;this._markerSymbol=a.boxHandleSymbol;this._lineSymbol=a.boxLineSymbol;this._moveStartHandler=m.hitch(this,this._moveStartHandler);this._firstMoveHandler=m.hitch(this,this._firstMoveHandler);this._moveStopHandler=m.hitch(this,this._moveStopHandler);this._moveHandler=m.hitch(this,this._moveHandler);this._isTextPoint=g;this._init()},destroy:function(){this._cleanUp();
this._graphic=this._map=this._toolbar=this._markerSymbol=this._lineSymbol=null},refresh:function(){this._draw()},suspend:function(){k.forEach(this._getAllGraphics(),function(a){a.hide()})},resume:function(){k.forEach(this._getAllGraphics(),function(a){a.show()});this._draw()},_init:function(){this._draw()},_cleanUp:function(){this._connects&&k.forEach(this._connects,p.disconnect);var a=this._toolbar._scratchGL;this._anchors&&k.forEach(this._anchors,function(b){a.remove(b.graphic);(b=b.moveable)&&
b.destroy()});this._box&&a.remove(this._box);this._box=this._anchors=this._connects=null},_draw:function(){if(this._graphic.getDojoShape()){var a=this._map,b=this._toolbar._scratchGL,c=this._getBoxCoords(),d=new B(a.spatialReference),e=m.clone(k.filter(c,function(f,g){return 8!==g&&0===g%2}));e[0]&&e.push([e[0][0],e[0][1]]);d.addPath(e);this._rotate&&d.addPath([c[1],c[8]]);this._box?this._box.setGeometry(d):(this._box=new u(d,this._lineSymbol),b.add(this._box));this._anchors?k.forEach(this._anchors,
function(f,g){this._scale||(g=8);var h=new q(c[g],a.spatialReference);f.graphic.setGeometry(h);h=f.moveable;var r=f.graphic.getDojoShape();r&&(h?r!==h.shape&&(h.destroy(),f.moveable=this._getMoveable(f.graphic,g)):f.moveable=this._getMoveable(f.graphic,g))},this):(this._anchors=[],this._connects=[],k.forEach(c,function(f,g){!this._scale&&8>g||(f=new q(f,a.spatialReference),f=new u(f,this._markerSymbol),this._isTextPoint&&1===g%2&&f.hide(),b.add(f),this._anchors.push({graphic:f,moveable:this._getMoveable(f,
g)}))},this))}else this._cleanUp()},_getBoxCoords:function(a){var b=this._map,c=[],d,e,f;if(this._isTextPoint){var g=this._graphic.getNode().getBoundingClientRect();var h=b.__container.getBoundingClientRect();g=[{x:g.left-h.left,y:g.top-h.top},{x:g.right-h.left,y:g.top-h.top},{x:g.right-h.left,y:g.bottom-h.top},{x:g.left-h.left,y:g.bottom-h.top}]}else g=this._getTransformedBoundingBox(this._graphic);k.forEach(g,function(r,D,v){d=r;(e=v[D+1])||(e=v[0]);f={x:(d.x+e.x)/2,y:(d.y+e.y)/2};a||(d=b.toMap(d),
f=b.toMap(f));c.push([d.x,d.y]);c.push([f.x,f.y])});this._rotate&&(g=m.clone(c[1]),g=a?{x:g[0],y:g[1]}:b.toScreen({x:g[0],y:g[1],spatialReference:b.spatialReference}),g.y-=this._toolbar._options.rotateHandleOffset,a||(g=b.toMap(g)),c.push([g.x,g.y]));return c},_getTransformedBoundingBox:function(a){var b=this._map,c=a.geometry.getExtent(),d=a.geometry.spatialReference;a=new q(c.xmin,c.ymax,d);c=new q(c.xmax,c.ymin,d);a=b.toScreen(a);c=b.toScreen(c);return[{x:a.x,y:a.y},{x:c.x,y:a.y},{x:c.x,y:c.y},
{x:a.x,y:c.y}]},_getAllGraphics:function(){var a=[this._box];this._anchors&&k.forEach(this._anchors,function(b){a.push(b.graphic)});return a=k.filter(a,A.isDefined)},_getMoveable:function(a,b){var c=a.getDojoShape();if(c)return a=new y(c),a._index=b,this._connects.push(p.connect(a,"onMoveStart",this._moveStartHandler)),this._connects.push(p.connect(a,"onFirstMove",this._firstMoveHandler)),this._connects.push(p.connect(a,"onMoveStop",this._moveStopHandler)),a.onMove=this._moveHandler,(c=c.getEventSource())&&
x.set(c,"cursor",this._toolbar._cursors["box"+b]),a},_moveStartHandler:function(a){this._toolbar["on"+(8===a.host._index?this._rotateEvent:this._scaleEvent)+"Start"](this._graphic)},_firstMoveHandler:function(a){this._toolbar._deactivateScrollWheel();var b=a.host._index,c=this._wrapOffset=a.host.shape._wrapOffsets[0]||0,d=this._graphic.getLayer().getNavigationTransform();a=k.map(this._getBoxCoords(!0),function(f){return{x:f[0]+c,y:f[1]}});var e=this._isTextPoint?this._map.toScreen(this._graphic.geometry):
{x:a[1].x,y:a[3].y};this._centerCoord=l.multiplyPoint(l.invert(d),e);if(8===b)e=l.multiplyPoint(l.invert(d),a[1]),this._isTextPoint&&(this._centerCoord=this._deNormalizePoint(this._centerCoord,e)),this._startLine=[this._centerCoord,e],this._moveLine=m.clone(this._startLine);else if(e=l.multiplyPoint(l.invert(d),a[b]),d=l.multiplyPoint(l.invert(d),a[(b+4)%8]),this._isTextPoint&&(this._centerCoord=this._deNormalizePoint(this._centerCoord,e)),this._firstMoverToAnchor=Math.sqrt((e.x-this._centerCoord.x)*
(e.x-this._centerCoord.x)+(e.y-this._centerCoord.y)*(e.y-this._centerCoord.y)),this._startBox=d,this._startBox.width=a[4].x-a[0].x,this._startBox.height=a[4].y-a[0].y,this._moveBox=m.clone(this._startBox),this._xfactor=e.x>d.x?1:-1,this._yfactor=e.y>d.y?1:-1,1===b||5===b)this._xfactor=0;else if(3===b||7===b)this._yfactor=0;this._toolbar._beginOperation("BOX");this._toolbar["on"+(8===b?this._rotateEvent:this._scaleEvent)+"FirstMove"](this._graphic)},_moveHandler:function(a,b){a=a.host._index;var c=
this._defaultEventArgs;c.angle=0;c.scaleX=1;c.scaleY=1;if(8===a){var d=this._startLine;var e=this._moveLine;var f=e[1];f.x+=b.dx;f.y+=b.dy;b=this._getAngle(d,e);this._isTextPoint&&(b+=this._graphic.symbol.angle);e=l.rotategAt(b,d[0]);this._graphic.getDojoShape().setTransform(e);c.transform=e;c.angle=b;c.around=d[0]}else{d=this._startBox;e=this._moveBox;e.width+=b.dx*this._xfactor;e.height+=b.dy*this._yfactor;this._uniformScaling||this._isTextPoint?(d=e.x+this._xfactor*e.width,e=e.y+this._yfactor*
e.height,d=Math.sqrt((d-this._centerCoord.x)*(d-this._centerCoord.x)+(e-this._centerCoord.y)*(e-this._centerCoord.y)),this._scaleRatio=b=f=d/this._firstMoverToAnchor,d=this._centerCoord):(b=e.width/d.width,f=e.height/d.height,d={x:d.x,y:d.y});if(isNaN(b)||Infinity===b||-Infinity===b)b=1;if(isNaN(f)||Infinity===f||-Infinity===f)f=1;e=l.scaleAt(b,f,d);if(this._isTextPoint){var g=l.rotategAt(this._graphic.symbol.angle,d);this._graphic.getDojoShape().setTransform([g,e])}else this._graphic.getDojoShape().setTransform(e);
c.transform=e;c.scaleX=b;c.scaleY=f;c.around=d}this._toolbar["on"+(8===a?this._rotateEvent:this._scaleEvent)](this._graphic,c)},_moveStopHandler:function(a){this._toolbar._activateScrollWheel();var b=this._graphic,c=this._toolbar,d=c._geo?t.geographicToWebMercator(b.geometry):b.geometry,e=d.spatialReference,f=b.getDojoShape(),g=f.getTransform(),h=b.getLayer().getNavigationTransform();this._isTextPoint?(b=this._graphic.symbol,8===a.host._index?b.angle+=this._getAngle(this._startLine,this._moveLine):
b.font.setSize(Math.round(b.font.size*this._scaleRatio*100)/100),this._graphic.setSymbol(b)):(d=d.toJson(),this._updateSegments(d.paths||d.rings,g,h,e),f.setTransform(null),d=C.fromJson(d),b.setGeometry(c._geo?t.webMercatorToGeographic(d,!0):d));this._draw();this._startLine=this._moveLine=this._startBox=this._moveBox=this._xfactor=this._yfactor=null;c._endOperation("BOX");this._defaultEventArgs.transform=g;c["on"+(8===a.host._index?this._rotateEvent:this._scaleEvent)+"Stop"](this._graphic,this._defaultEventArgs)},
_updateSegments:function(a,b,c,d){var e=this._map,f=this._wrapOffset||0;k.forEach(a,function(g){k.forEach(g,function(h){this._updatePoint(h,d,f,l,e,c,b)},this)},this)},_updatePoint:function(a,b,c,d,e,f,g){b=e.toScreen({x:a[0],y:a[1],spatialReference:b},!0);b.x+=c;b=d.multiplyPoint([f,g,d.invert(f)],b);b.x-=c;c=e.toMap(b);a[0]=c.x;a[1]=c.y},_getAngle:function(a,b){return 180*Math.atan2(b[0].y-b[1].y,b[0].x-b[1].x)/Math.PI-180*Math.atan2(a[0].y-a[1].y,a[0].x-a[1].x)/Math.PI},_deNormalizePoint:function(a,
b){var c=this._map._getFrameWidth();if(-1===c)return a;for(a={x:a.x,y:a.y};Math.abs(a.x-b.x)>=c;)a.x=a.x<b.x?a.x+c:a.x-c;var d=Math.abs(a.x-b.x);Math.abs(a.x-b.x+c)<d?a.x+=c:Math.abs(a.x-b.x-c)<d&&(a.x-=c);return a}});w("extend-esri")&&m.setObject("toolbars._Box",n,z);return n});