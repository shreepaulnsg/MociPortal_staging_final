// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/tasks/PrintTask","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/json dojo/_base/Deferred dojo/has ../kernel ../lang ../layerUtils ../deferredUtils ../Color ../request ../urlUtils ../geometry/Polygon ../renderers/SimpleRenderer ../symbols/FillSymbol ./Geoprocessor ./PrintTemplate ./Task dojo/dom-attr dojo/dom-construct dojox/gfx/_base dojox/gfx/canvas dojox/json/query dojo/has!extend-esri?./PrintParameters dojo/has!extend-esri?./LegendLayer".split(" "),function(D,n,v,
G,H,I,C,E,J,K,M,N,O,P,Q,R,S,T,U,V,W,y,F,X){D=D(U,{declaredClass:"esri.tasks.PrintTask",constructor:function(b,e){this.url=b;this.printGp=new S(this.url);this._handler=n.hitch(this,this._handler);e&&e.async&&(this.async=!0);this._colorEvaluator=X("$..color")},async:!1,_vtlExtent:null,_cimVersion:null,_is11xService:!1,_loadGpServerMetadata:!0,execute:function(b,e,k){if(!this._loadGpServerMetadata)return this._execute(b,e,k);var h=new H(K._dfdCanceller),l=this._url.path,m=l.lastIndexOf("/GPServer/");
0<m&&(l=l.slice(0,m+9));h._pendingDfd=N({url:l,callbackParamName:"callback",content:n.mixin({},this._url.query,{f:"json"})}).then(n.hitch(this,function(a){this._loadGpServerMetadata=!1;this.async="esriExecutionTypeAsynchronous"===a.executionType;this._cimVersion=a.cimVersion;this._is11xService=!!this._cimVersion;h._pendingDfd=this._execute(b);return h._pendingDfd})).then(n.hitch(this,function(a){this._successHandler([a],null,e,h)})).otherwise(function(a){k&&k(a);h.errback(a)});return h},_handler:function(b,
e,k,h,l){try{if(this.async)"esriJobSucceeded"===b.jobStatus?this.printGp.getResultData(b.jobId,"Output_File",n.hitch(this,function(a){m=a.value;this._successHandler([m],"onComplete",k,l)})):this._errorHandler(Error(b.jobStatus),h,l);else{var m=b[0].value;this._successHandler([m],"onComplete",k,l)}}catch(a){this._errorHandler(a,h,l)}},_execute:function(b,e,k){var h=this._handler,l=this._errorHandler,m=b.template||new T;m.hasOwnProperty("showLabels")||(m.showLabels=!0);var a=m.exportOptions,d;a&&(d=
{outputSize:[a.width,a.height],dpi:a.dpi});a=m.layoutOptions;var c=[];if(a){this.legendAll=!1;a.legendLayers?v.forEach(a.legendLayers,function(w){var A={};A.id=w.layerId;w.subLayerIds&&(A.subLayerIds=w.subLayerIds);c.push(A)}):this.legendAll=!0;if("Miles"===a.scalebarUnit||"Kilometers"===a.scalebarUnit){var p="esriKilometers";var g="esriMiles"}else if("Meters"===a.scalebarUnit||"Feet"===a.scalebarUnit)p="esriMeters",g="esriFeet";var q={esriMiles:"mi",esriKilometers:"km",esriFeet:"ft",esriMeters:"m"};
q={titleText:a.titleText,authorText:a.authorText,copyrightText:a.copyrightText,customTextElements:a.customTextElements,scaleBarOptions:{metricUnit:p,metricLabel:q[p],nonMetricUnit:g,nonMetricLabel:q[g]},legendOptions:{operationalLayers:c}}}p=this._getPrintDefinition(b.map,m);b.outSpatialReference&&(p.mapOptions.spatialReference=b.outSpatialReference.toJson());b.template&&E.isDefined(b.template.showAttribution)&&(p.mapOptions.showAttribution=b.template.showAttribution);n.mixin(p,{exportOptions:d,layoutOptions:q});
this.allLayerslegend&&n.mixin(p.layoutOptions,{legendOptions:{operationalLayers:this.allLayerslegend}});if(p.operationalLayers){d=p.operationalLayers;var z=function(w){return E.fixJson(n.mixin(w,{type:"esriSLS",cap:void 0,join:void 0,meterLimit:void 0}))},x=/[\u4E00-\u9FFF\u0E00-\u0E7F\u0900-\u097F\u3040-\u309F\u30A0-\u30FF\u31F0-\u31FF]/,f=/[\u0600-\u06FF]/,r=function(w){var A=w.text,L=(w=w.font)&&w.family&&w.family.toLowerCase();A&&w&&("arial"===L||"arial unicode ms"===L)&&(w.family=x.test(A)?"Arial Unicode MS":
"Arial","normal"!==w.style&&f.test(A)&&(w.family="Arial Unicode MS"))};for(q=0;q<d.length;q++)if(d[q].featureCollection&&d[q].featureCollection.layers)for(g=0;g<d[q].featureCollection.layers.length;g++){var u=d[q].featureCollection.layers[g];if(u.layerDefinition&&u.layerDefinition.drawingInfo&&u.layerDefinition.drawingInfo.renderer&&u.layerDefinition.drawingInfo.renderer.symbol){var t=u.layerDefinition.drawingInfo.renderer;"esriCLS"===t.symbol.type?t.symbol=z(t.symbol):"esriTS"===t.symbol.type?r(t.symbol):
t.symbol.outline&&"esriCLS"===t.symbol.outline.type&&(t.symbol.outline=z(t.symbol.outline))}if(u.featureSet&&u.featureSet.features)for(a=0;a<u.featureSet.features.length;a++)t=u.featureSet.features[a],t.symbol&&("esriCLS"===t.symbol.type?t.symbol=z(t.symbol):"esriTS"===t.symbol.type?r(t.symbol):t.symbol.outline&&"esriCLS"===t.symbol.outline.type&&(t.symbol.outline=z(t.symbol.outline)))}}m={Web_Map_as_JSON:G.toJson(E.fixJson(p)),Format:m.format,Layout_Template:m.layout};b.extraParameters&&(m=n.mixin(m,
b.extraParameters));var B=new H(K._dfdCanceller);b=function(w,A){h(w,A,e,k,B)};p=function(w){l(w,k,B)};B._pendingDfd=this.async?this.printGp.submitJob(m,b,null,p):this.printGp.execute(m,b,p);return B},onComplete:function(){},_createMultipointLayer:function(){return{layerDefinition:{name:"multipointLayer",geometryType:"esriGeometryMultipoint",drawingInfo:{renderer:null}},featureSet:{geometryType:"esriGeometryMultipoint",features:[]}}},_createPolygonLayer:function(){return{layerDefinition:{name:"polygonLayer",
geometryType:"esriGeometryPolygon",drawingInfo:{renderer:null}},featureSet:{geometryType:"esriGeometryPolygon",features:[]}}},_createPointLayer:function(){return{layerDefinition:{name:"pointLayer",geometryType:"esriGeometryPoint",drawingInfo:{renderer:null}},featureSet:{geometryType:"esriGeometryPoint",features:[]}}},_createPolylineLayer:function(){return{layerDefinition:{name:"polylineLayer",geometryType:"esriGeometryPolyline",drawingInfo:{renderer:null}},featureSet:{geometryType:"esriGeometryPolyline",
features:[]}}},_convertSvgSymbol:function(b){if(!(8>=I("ie")||!b.path&&"image/svg+xml"!==b.contentType)){var e=F.createSurface(W.create("div"),1024,1024);var k="image/svg+xml"===b.contentType?e.createObject(F.Image,{src:"data:image/svg+xml;base64,"+b.imageData,width:y.pt2px(b.width),height:y.pt2px(b.height),x:0,y:0}):e.createObject(F.Path,b.path).setFill(b.color).setStroke(b.outline);"pendingRender"in e&&e._render(!0);var h=e.rawNode.getContext("2d"),l=Math.ceil(k.getBoundingBox().width),m=Math.ceil(k.getBoundingBox().height);
k=h.getImageData(k.getBoundingBox().x,k.getBoundingBox().y,l,m);h.canvas.width=l;h.canvas.height=m;h.putImageData(k,0,0);h=h.canvas.toDataURL("image/png");b={type:"esriPMS",imageData:h.substr(22,h.length),angle:b.angle,contentType:"image/png",height:b.size?b.size:y.px2pt(m),width:b.size?l/m*b.size:y.px2pt(l),xoffset:b.xoffset,yoffset:b.yoffset};e.destroy();return b}},_convertSvgRenderer:function(b){"simple"===b.type&&b.symbol&&(b.symbol.path||"image/svg+xml"===b.symbol.contentType)?b.symbol=this._convertSvgSymbol(b.symbol):
"uniqueValue"===b.type?(b.defaultSymbol&&(b.defaultSymbol.path||"image/svg+xml"===b.defaultSymbol.contentType)&&(b.defaultSymbol=this._convertSvgSymbol(b.defaultSymbol)),b.uniqueValueInfos&&v.forEach(b.uniqueValueInfos,function(e){if(e.symbol.path||"image/svg+xml"===e.symbol.contentType)e.symbol=this._convertSvgSymbol(e.symbol)},this)):"classBreaks"===b.type&&(b.defaultSymbol&&(b.defaultSymbol.path||"image/svg+xml"===b.defaultSymbol.contentType)&&(b.defaultSymbol=this._convertSvgSymbol(b.defaultSymbol)),
b.classBreakInfos&&v.forEach(b.classBreakInfos,function(e){if(e.symbol.path||"image/svg+xml"===e.symbol.contentType)e.symbol=this._convertSvgSymbol(e.symbol)},this))},_createFeatureCollection:function(b,e,k,h){var l=this._createPolygonLayer(),m=this._createPolylineLayer(),a=this._createPointLayer(),d=this._createMultipointLayer(),c=this._createPointLayer();c.layerDefinition.name="textLayer";delete c.layerDefinition.drawingInfo;if("esri.layers.FeatureLayer"===b.declaredClass||"esri.layers.StreamLayer"===
b.declaredClass)l.layerDefinition.name=m.layerDefinition.name=a.layerDefinition.name=d.layerDefinition.name=n.getObject("arcgisProps.title",!1,b)||b.name||b.id;var p=b.renderer&&"esri.renderer.SimpleRenderer"===b.renderer.declaredClass;if(!b.renderer||b.renderer.valueExpression||n.isFunction(b.renderer.attributeField))delete l.layerDefinition.drawingInfo,delete m.layerDefinition.drawingInfo,delete a.layerDefinition.drawingInfo,delete d.layerDefinition.drawingInfo;else{var g=b.renderer.toJson({useLegacyRotationProperties:!0});
if("temporal"===g.type){g={latestObservationRenderer:g.latestObservationRenderer,trackLinesRenderer:g.trackRenderer,observationAger:g.observationAger,renderer:g.observationRenderer};var q={};b._trackIdField&&(q.trackIdField=b._trackIdField);b._startTimeField&&(q.startTimeField=b._startTimeField);b._endTimeField&&(q.endTimeField=b._endTimeField);l.layerDefinition.drawingInfo=g;l.layerDefinition.timeInfo=q;m.layerDefinition.drawingInfo=g;m.layerDefinition.timeInfo=q;a.layerDefinition.drawingInfo=g;
a.layerDefinition.timeInfo=q;d.layerDefinition.drawingInfo=g;d.layerDefinition.timeInfo=q}else l.layerDefinition.drawingInfo.renderer=g,m.layerDefinition.drawingInfo.renderer=g,a.layerDefinition.drawingInfo.renderer=g,d.layerDefinition.drawingInfo.renderer=g}g=b.fields;g||!b.renderer||b.renderer.valueExpression||n.isFunction(b.renderer.attributeField)||("esri.renderer.ClassBreaksRenderer"===b.renderer.declaredClass?(g=[{name:b.renderer.attributeField,type:"esriFieldTypeDouble"}],b.renderer.normalizationField&&
g.push({name:b.renderer.normalizationField,type:"esriFieldTypeDouble"})):"esri.renderer.UniqueValueRenderer"===b.renderer.declaredClass&&(g=[{name:b.renderer.attributeField,type:"esriFieldTypeString"}],b.renderer.attributeField2&&g.push({name:b.renderer.attributeField2,type:"esriFieldTypeString"}),b.renderer.attributeField3&&g.push({name:b.renderer.attributeField3,type:"esriFieldTypeString"})));g&&(l.layerDefinition.fields=g,m.layerDefinition.fields=g,a.layerDefinition.fields=g,d.layerDefinition.fields=
g);g=b.graphics;b.isFeatureReductionActive&&b.isFeatureReductionActive()&&(g=b.getSingleGraphics());q=g.length;var z;for(z=0;z<q;z++){var x=g[z];if(!1!==x.visible&&x.geometry){var f=x.toJson();f.symbol&&f.symbol.outline&&f.symbol.outline.color&&f.symbol.outline.color[3]&&!this._is11xService&&(f.symbol.outline.color[3]=255);if(b.renderer&&!f.symbol&&(n.isFunction(b.renderer.attributeField)||b.renderer.valueExpression||this._isFeatureCollectionRequired(b.renderer,b)||"esri.renderer.DotDensityRenderer"===
b.renderer.declaredClass||k)){k=k||b.renderer;var r=null;try{r=k.getSymbol(x)}catch(u){}if(!r)continue;f.symbol=r.toJson();this._isFeatureCollectionRequired(k,b)&&this._applyVisualVariables(f.symbol,{renderer:k,graphic:x,symbol:r,mapResolution:e&&e.getResolutionInMeters(),mapScale:e&&e.getScale()})}f.symbol&&(f.symbol.path||"image/svg+xml"===f.symbol.contentType?f.symbol=this._convertSvgSymbol(f.symbol):f.symbol.text&&delete f.attributes);switch(x.geometry.type){case "polygon":l.featureSet.features.push(f);
break;case "polyline":m.featureSet.features.push(f);break;case "point":f.symbol&&f.symbol.text?c.featureSet.features.push(f):a.featureSet.features.push(f);break;case "multipoint":d.featureSet.features.push(f);break;case "extent":f.geometry=P.fromExtent(x.geometry).toJson(),l.featureSet.features.push(f)}}}e=[];0<l.featureSet.features.length&&e.push(l);0<m.featureSet.features.length&&e.push(m);0<d.featureSet.features.length&&e.push(d);0<a.featureSet.features.length&&e.push(a);0<c.featureSet.features.length&&
e.push(c);if(!e.length)return null;v.forEach(e,function(u){var t=v.every(u.featureSet.features,function(B){return B.symbol});if(p||t)h&&h.forceFeatureAttributes||v.forEach(u.featureSet.features,function(B){delete B.attributes}),h.forceFeatureAttributes||delete u.layerDefinition.fields;t&&delete u.layerDefinition.drawingInfo});v.forEach(e,function(u){u.layerDefinition.drawingInfo&&u.layerDefinition.drawingInfo.renderer&&this._convertSvgRenderer(u.layerDefinition.drawingInfo.renderer)},this);return{id:b.id,
opacity:b.opacity,minScale:b.minScale||0,maxScale:b.maxScale||0,featureCollection:{layers:e}}},_getPrintDefinition:function(b,e){var k={operationalLayers:this._createOperationalLayers(b,e)},h=this._vtlExtent||b.extent,l=b.spatialReference;this._vtlExtent=null;b.spatialReference._isWrappable()&&(h=h._normalize(!0),l=h.spatialReference);h={mapOptions:{showAttribution:b.showAttribution,extent:h.toJson(),spatialReference:l.toJson()}};e.preserveScale&&n.mixin(h.mapOptions,{scale:e.outScale||b.getScale()});
b.timeExtent&&n.mixin(h.mapOptions,{time:[b.timeExtent.startTime.getTime(),b.timeExtent.endTime.getTime()]});b={};n.mixin(b,h,k);return b},_createOperationalLayers:function(b,e){var k,h=[],l=0;e.preserveScale&&(l=e.outScale||b.getScale());this.allLayerslegend=this.legendAll?[]:null;this._vtlExtent=null;var m=v.map(b.layerIds,b.getLayer,b);b._mapImageLyr&&m.push(b._mapImageLyr);for(k=0;k<m.length;k++){var a=m[k];if(a.loaded&&a.visible&&(!l||a.isVisibleAtScale(l))){var d=a.declaredClass;var c={id:a.id,
title:n.getObject("arcgisProps.title",!1,a)||a.id,opacity:a.opacity,minScale:a.minScale||0,maxScale:a.maxScale||0};c=n.mixin(c,this._getUrlAndToken(a));a.getNode()&&V.get(a.getNode(),"data-reference")&&(c._isRefLayer=!0);switch(d){case "esri.layers.ArcGISDynamicMapServiceLayer":var p=[];d=!!a._params.layers;if(a._params.dynamicLayers)d=e.outScale?a._getDynLayerObjs(e.outScale):G.fromJson(a._params.dynamicLayers),v.forEach(d,function(f){p.push({id:f.id,name:f.name,layerDefinition:f});delete f.id;delete f.name;
delete f.maxScale;delete f.minScale}),0===p.length&&(c.visibleLayers=[-1]);else if(a.supportsDynamicLayers){if(d||a.layerDefinitions||a.layerTimeOptions){var g=a.createDynamicLayerInfosFromLayerInfos(),q=null;d&&(q=a.visibleLayers);q=J._getVisibleLayers(g,q);var z=J._getLayersForScale(e.outScale||b.getScale(),g);v.forEach(g,function(f){if(!f.subLayerIds){var r=f.id;-1<v.indexOf(q,r)&&-1<v.indexOf(z,r)&&(f={source:f.source.toJson()},a.layerDefinitions&&a.layerDefinitions[r]&&(f.definitionExpression=
a.layerDefinitions[r]),a.layerTimeOptions&&a.layerTimeOptions[r]&&(f.layerTimeOptions=a.layerTimeOptions[r].toJson()),p.push({id:r,layerDefinition:f}))}});0===p.length&&(c.visibleLayers=[-1])}}else v.forEach(a.layerInfos,function(f){var r={id:f.id,layerDefinition:{}};a.layerDefinitions&&a.layerDefinitions[f.id]&&(r.layerDefinition.definitionExpression=a.layerDefinitions[f.id]);a.layerTimeOptions&&a.layerTimeOptions[f.id]&&(r.layerDefinition.layerTimeOptions=a.layerTimeOptions[f.id].toJson());(r.layerDefinition.definitionExpression||
r.layerDefinition.layerTimeOptions)&&p.push(r)}),d&&(c.visibleLayers=a.visibleLayers.length?a.visibleLayers:[-1]);p.length&&(c.layers=p);h.push(c);this.allLayerslegend&&this.allLayerslegend.push({id:a.id,subLayerIds:a.visibleLayers});break;case "esri.layers.ArcGISImageServiceLayer":c=n.mixin(c,{url:a.url,bandIds:a.bandIds,compressionQuality:a.compressionQuality,format:a.format,interpolation:a.interpolation});a.mosaicRule&&n.mixin(c,{mosaicRule:a.mosaicRule.toJson()});if(a.renderingRule||a.renderer)this._is11xService?
(a.renderingRule&&(c.renderingRule=a.renderingRule.toJson()),a.renderer&&(c.layerDefinition=c.layerDefinition||{},c.layerDefinition.drawingInfo=c.layerDefinition.drawingInfo||{},c.layerDefinition.drawingInfo.renderer=a.renderer.toJson())):(d=a.getExportImageRenderingRule())&&n.mixin(c,{renderingRule:d.toJson()});h.push(c);this.allLayerslegend&&this.allLayerslegend.push({id:a.id});break;case "esri.layers.RasterXLayer":this._is11xService&&(c=n.mixin(c,{url:a.url,bandIds:a.bandIds,interpolation:a.interpolation}),
a.renderer&&(c.layerDefinition=c.layerDefinition||{},c.layerDefinition.drawingInfo=c.layerDefinition.drawingInfo||{},c.layerDefinition.drawingInfo.renderer=a.renderer.toJson()),h.push(c),this.allLayerslegend&&this.allLayerslegend.push({id:a.id}));break;case "esri.layers.WMSLayer":c=n.mixin(c,{url:a.url,title:a.title,type:"wms",version:a.version,transparentBackground:a.imageTransparency,visibleLayers:a.visibleLayers});h.push(c);this.allLayerslegend&&this.allLayerslegend.push({id:a.id,subLayerIds:a.visibleLayers});
break;case "esri.virtualearth.VETiledLayer":d=a.mapStyle;"roadOnDemand"===d?d="Road":"aerialWithLabelsOnDemand"===d&&(d="Hybrid");c=n.mixin(c,{visibility:a.visible,type:"BingMaps"+d,culture:a.culture,key:a.bingMapsKey});h.push(c);break;case "esri.layers.OpenStreetMapLayer":c=n.mixin(c,{credits:a.copyright,type:"OpenStreetMap",url:O.getAbsoluteUrl(a.tileServers[0])});h.push(c);break;case "esri.layers.WMTSLayer":c=n.mixin(c,{url:a.url,type:"wmts",layer:a._identifier,style:a._style,format:a.format,tileMatrixSet:a._tileMatrixSetId});
h.push(c);break;case "esri.layers.MapImageLayer":d=a.getImages();v.forEach(d,function(f,r){f.visible&&f.href&&(c={id:a.id+"_image"+r,type:"image",title:a.id,minScale:a.minScale||0,maxScale:a.maxScale||0,opacity:a.opacity*f.opacity,extent:f.extent.toJson()},"data:image/png;base64,"===f.href.substr(0,22)?c.imageData=f.href.substr(22):c.url=f.href,h.push(c))});break;case "esri.layers.VectorTileLayer":delete c.url;delete c.token;if(this._is11xService&&a.currentStyleInfo.serviceUrl&&a.currentStyleInfo.styleUrl&&
(d=C.id&&C.id.findCredential(a.currentStyleInfo.styleUrl),g=C.id&&C.id.findCredential(a.currentStyleInfo.serviceUrl),!d&&!g||"2.1.0"!==this._cimVersion)){c.type="VectorTileLayer";c.styleUrl=a.currentStyleInfo.styleUrl;d&&(c.token=d.token);g&&g.token!==c.token&&(c.additionalTokens=[{url:a.currentStyleInfo.serviceUrl,token:g.token}]);h.push(c);break}c.type="image";d=this._vtlExtent||b.extent.offset(0,0);var x=e.exportOptions&&e.exportOptions.dpi||96;g={format:"png",pixelRatio:x/96};"MAP_ONLY"!==e.layout||
!e.preserveScale||e.outScale&&e.outScale!==b.getScale()||96!==x||!e.exportOptions||e.exportOptions.width%2===b.width%2&&e.exportOptions.height%2===b.height%2||(g.area={x:0,y:0,width:b.width,height:b.height},e.exportOptions.width%2!==b.width%2&&--g.area.width,e.exportOptions.height%2!==b.height%2&&--g.area.height,this._vtlExtent||(x=b.toMap({x:g.area.width,y:g.area.height}),d.update(d.xmin,x.y,x.x,d.ymax,d.spatialReference),this._vtlExtent=d));c.extent=d._normalize(!0).toJson();d=a.takeScreenshot(g);
d.isResolved()?d.then(function(f){"data:image/png;base64,"===f.dataURL.substr(0,22)&&(c.imageData=f.dataURL.substr(22))}):console.error("PrintTask: VectorTileLayer.takeScreenshot() returned an unresolved Promise");c.imageData&&h.push(c);break;case "esri.layers.WebTiledLayer":d=a.url.replace(/\$\{/g,"{");c=n.mixin(c,{type:"WebTiledLayer",urlTemplate:d,credits:a.copyright});a.subDomains&&0<a.subDomains.length&&(c.subDomains=a.subDomains);a._wmtsInfo&&(c.wmtsInfo=a._wmtsInfo);delete c.url;h.push(c);
break;default:if(a.getTileUrl||a.getImageUrl)c=n.mixin(c,{url:a.url}),h.push(c)}}}m=v.map(b.graphicsLayerIds,b.getLayer,b);for(k=0;k<m.length;k++)a=m[k],a.isFeatureReductionActive&&a.isFeatureReductionActive()&&(a.getSingleGraphics().length?m.splice(++k,0,a.getFeatureReductionLayer()):m[k]=a.getFeatureReductionLayer());for(k=0;k<m.length;k++)if(a=m[k],a.loaded&&a.visible&&(!l||a.isVisibleAtScale(l)))switch(d=a.declaredClass,d){case "esri.layers.CSVLayer":if(this._is11xService){c={id:a.id,url:a.url,
title:a.title,opacity:a.opacity,minScale:a.minScale||0,maxScale:a.maxScale||0,type:"CSV",locationInfo:{latitudeFieldName:a.latitudeFieldName,longitudeFieldName:a.longitudeFieldName},layerDefinition:{drawingInfo:{renderer:a.renderer&&a.renderer.toJson({useLegacyRotationProperties:!0})}}};h.push(c);break}case "esri.layers.FeatureLayer":case "esri.layers.LabelLayer":case "esri.layers.StreamLayer":if("esri.layers.LabelLayer"===d&&!e.showLabels||a.renderer&&"esri.renderer.HeatmapRenderer"===a.renderer.declaredClass)continue;
d=null;a.url&&a.renderer&&("esri.renderer.ScaleDependentRenderer"===a.renderer.declaredClass?"scale"===a.renderer.rangeType?d=a.renderer.getRendererInfoByScale(b.getScale())&&a.renderer.getRendererInfoByScale(b.getScale()).renderer:"zoom"===a.renderer.rangeType&&(d=a.renderer.getRendererInfoByZoom(b.getZoom())&&a.renderer.getRendererInfoByZoom(b.getZoom()).renderer):d=a.renderer);g=d&&"esri.layers.CSVLayer"!==a.declaredClass&&!this._isFeatureCollectionRequired(d,a)&&!d.valueExpression;x=a.isFeatureReductionActive&&
a.isFeatureReductionActive();if(d&&!x&&"esri.renderer.DotDensityRenderer"!==d.declaredClass&&"esri.layers.StreamLayer"!==a.declaredClass&&(this._is11xService||g)&&("esri.renderer.SimpleRenderer"===d.declaredClass||"esri.renderer.TemporalRenderer"===d.declaredClass||null==d.attributeField||n.isString(d.attributeField)&&a._getField(d.attributeField,!0)))if(c={id:a.id,title:n.getObject("arcgisProps.title",!1,a)||a.id,opacity:a.opacity,minScale:a.minScale||0,maxScale:a.maxScale||0,layerDefinition:{drawingInfo:{renderer:d.toJson({useLegacyRotationProperties:!0})}}},
c=n.mixin(c,this._getUrlAndToken(a)),"esri.renderer.TemporalRenderer"===d.declaredClass&&(g=c.layerDefinition.drawingInfo,g.latestObservationRenderer=g.renderer.latestObservationRenderer,g.trackLinesRenderer=g.renderer.trackRenderer,g.observationAger=g.renderer.observationAger,g.renderer=g.renderer.observationRenderer,a._trackIdField&&(c.layerDefinition.timeInfo={trackIdField:a._trackIdField})),this._convertSvgRenderer(c.layerDefinition.drawingInfo.renderer),this._is11xService||1>a.opacity||"esri.renderer.TemporalRenderer"===
d.declaredClass||this._updateLayerOpacity(c))if(a._params.source&&(d=a._params.source.toJson(),n.mixin(c.layerDefinition,{source:d})),a.getDefinitionExpression()&&n.mixin(c.layerDefinition,{definitionExpression:a.getDefinitionExpression()}),2!==a.mode)0<a.getSelectedFeatures().length&&(d=v.map(a.getSelectedFeatures(),function(f){return f.attributes[a.objectIdField]}),0<d.length&&a.getSelectionSymbol()&&n.mixin(c,{selectionObjectIds:d,selectionSymbol:a.getSelectionSymbol().toJson()}));else{d=v.map(a.getSelectedFeatures(),
function(f){return f.attributes[a.objectIdField]});if(0===d.length||!a._params.drawMode)break;n.mixin(c.layerDefinition,{objectIds:d});d=null;a.getSelectionSymbol()&&(d=new Q(a.getSelectionSymbol()));n.mixin(c.layerDefinition.drawingInfo,{renderer:d&&d.toJson()})}else c=this._createFeatureCollection(a,b,null,e);else c=d&&(d.valueExpression||this._isFeatureCollectionRequired(d,a)||"esri.renderer.DotDensityRenderer"===d.declaredClass)?this._createFeatureCollection(a,b,d,e):this._createFeatureCollection(a,
b,null,e);if(!c)continue;h.push(c);this.allLayerslegend&&this.allLayerslegend.push({id:a.id});break;case "esri.layers._GraphicsLayer":case "esri.layers.GraphicsLayer":case "esri.layers.WFSLayer":c=this._createFeatureCollection(a,b,null,e);if(!c)continue;h.push(c);this.allLayerslegend&&this.allLayerslegend.push({id:a.id});break;case "esri.layers.ArcGISImageServiceVectorLayer":c={id:a.id,title:n.getObject("arcgisProps.title",!1,a)||a.id,opacity:a.opacity,minScale:a.minScale||0,maxScale:a.maxScale||
0,visibility:a.visible,symbolTileSize:a.symbolTileSize,layerDefinition:{drawingInfo:{renderer:a.renderer.toJson({useLegacyRotationProperties:!0})}}},c=n.mixin(c,this._getUrlAndToken(a)),a.mosaicRule&&n.mixin(c,{mosaicRule:a.mosaicRule.toJson()}),h.push(c),this.allLayerslegend&&this.allLayerslegend.push({id:a.id})}l&&v.forEach(h,function(f){f.minScale=0;f.maxScale=0});b.graphics&&0<b.graphics.graphics.length&&(c=this._createFeatureCollection(b.graphics,b,null,e))&&h.push(c);b._labels&&e.showLabels&&
(c=this._createFeatureCollection(b._labels,b,null,e))&&h.push(c);v.forEach(h,function(f,r,u){f._isRefLayer&&(delete f._isRefLayer,u.splice(r,1),u.push(f))});return h},_getUrlAndToken:function(b){return{token:b._getToken(),url:b._url?b._url.path:null}},_updateLayerOpacity:function(b){var e=this._colorEvaluator(b);e=v.filter(e,function(m){return n.isArray(m)&&4===m.length});var k=!0;if(e.length){var h=e[0][3],l;for(l=1;l<e.length;l++)if(h!==e[l][3]){k=!1;break}if(k)for(b.opacity=h/255,l=0;l<e.length;l++)e[l][3]=
255}return k},_isFeatureCollectionRequired:function(b,e){if(e&&e.isFeatureReductionActive&&e.isFeatureReductionActive())return!0;var k=!1;if(e=this._getVariable(b,"rotationInfo",!1))k=(k=e.field)&&n.isFunction(k)||e.valueExpression;return b.hasVisualVariables("sizeInfo")||b.hasVisualVariables("colorInfo")||b.hasVisualVariables("opacityInfo")||k},_getVariable:function(b,e,k){if(b)var h=(b=b.getVisualVariablesForType(e,k))&&b[0];return h},_applyVisualVariables:function(b,e){var k=e.renderer,h=e.graphic,
l=e.symbol,m=e.mapResolution,a=e.mapScale,d=l.type;if("textsymbol"!==d&&"shieldlabelsymbol"!==d){var c=this._getVariable(k,"sizeInfo",!1),p=this._getVariable(k,"colorInfo",!1),g=this._getVariable(k,"opacityInfo",!1);e=this._getVariable(k,"rotationInfo",!1);l instanceof R&&(c=this._getVariable(k,"sizeInfo","outline")||c);m=c?k.getSize(h,{sizeInfo:c,shape:"simplemarkersymbol"===d?l.style:null,resolution:m,scale:a}):h.size;null!=m&&("simplemarkersymbol"===d?b.size=y.px2pt(m):"picturemarkersymbol"===
d?(a=l.width/l.height*m,b.width=y.px2pt(a),b.height=y.px2pt(m),0!==l.xoffset&&(b.xoffset=y.px2pt(l.xoffset/l.width*a)),0!==l.yoffset&&(b.yoffset=y.px2pt(l.yoffset/l.height*m))):"simplelinesymbol"===d?b.width=y.px2pt(m):b.outline&&(b.outline.width=y.px2pt(m)));p&&(!(l=k.getColor(h,{colorInfo:p}))||"simplemarkersymbol"!==d&&"simplelinesymbol"!==d&&"simplefillsymbol"!==d||(b.color=M.toJsonColor(l)));g&&(l=k.getOpacity(h,{opacityInfo:g}),null!=l&&b.color&&(b.color[3]=Math.round(255*l)));e&&(k=k.getRotationAngle(h,
{rotationInfo:e}))&&(b.angle=-k)}}});I("extend-esri")&&n.setObject("tasks.PrintTask",D,C);return D});