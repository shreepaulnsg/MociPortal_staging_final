// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/renderers/smartMapping","require module dojo/_base/array dojo/_base/lang dojo/has dojo/Deferred dojo/DeferredList dojo/promise/all dojo/when dojo/on dojo/json ../kernel ../Color ../numberUtils ../promiseList ../lang ../styles/type ../styles/size ../styles/choropleth ../styles/heatmap ../styles/predominance ../styles/relationship ../symbols/SimpleMarkerSymbol ../symbols/SimpleLineSymbol ../symbols/SimpleFillSymbol ../symbols/utils ./UniqueValueRenderer ./ClassBreaksRenderer ./HeatmapRenderer ./BlendRenderer ./utils dojo/i18n!../nls/jsapi".split(" "),
function(la,Fa,u,A,Ga,z,N,Ha,ba,Ia,ca,Ja,B,P,Ka,La,ma,R,S,na,da,O,Ma,ea,Na,Oa,Pa,T,Qa,Ra,E,Sa){function n(a,b){a.reject(Error(b))}function oa(a,b){if(a.loaded)b.call();else Ia.once(a,"load",b)}function F(a,b,c,d,e){var g=a.outline&&a.outline.color;b=b?new B(b):null;g=g?new B(g):null;switch(c){case "point":var f=new Ma;f.setColor(b);f.setSize(null!=d?d:a.size);b=new ea;b.setColor(g);b.setWidth(a.outline.width);f.setOutline(b);break;case "line":f=new ea;f.setColor(b);f.setWidth(null!=d?d:a.width);break;
case "polygon":f=new Na,f.setColor(b),b=new ea,b.setColor(g),b.setWidth(a.outline.width),null!=e&&b.color&&(b.color.a=e),f.setOutline(b)}return f}function M(a){var b=a.geometryType;if("esriGeometryPoint"===b||"esriGeometryMultipoint"===b)b="point";else if("esriGeometryPolyline"===b)b="line";else if("esriGeometryPolygon"===b||a.hasXYFootprint())b="polygon";return b}function fa(a,b){var c=a.scheme;c=c?ma.cloneScheme(c):(c=ma.getSchemes({theme:a.theme||"default",basemap:a.basemap,geometryType:b}))&&
c.primaryScheme;return c}function pa(a,b){return a.label<b.label?-1:a.label>b.label?1:0}function qa(a,b){return a.value<b.value?-1:a.value>b.value?1:0}function Ta(a,b){var c=b.count-a.count;0===c&&(c=pa(a,b));return c}function Ua(a,b){var c=b.count-a.count;0===c&&(c=qa(a,b));return c}function Va(a,b,c){if(A.isFunction(b))var d=b;else"count"===b?(d=Ua,c&&c.codedValues&&(d=Ta)):"value"===b&&(d=qa,c&&c.codedValues&&(d=pa));d&&a.sort(d)}function ha(a,b,c){var d=c.layer,e=c.field,g=A.isFunction(e),f=e&&
!g?d.getField(e):null,h=f?d.getDomain(f.name):null,l=-1,k,m=null==c.numTypes?10:-1===c.numTypes?a.length:c.numTypes;g=null==c.showOthers?!0:c.showOthers;var t=null==c.sortBy?"count":c.sortBy,p=c&&c.labelCallback,q=M(d),r=fa(c,q),w=b&&b.opacity;d=new Pa(null,e);e=c.customScheme;var v=c.useSizeInfo,y,x;if(e){var C=(y="polygon"===q)&&v,I=e.sizeInfo;v=v?y?I.marker:I:null;if(I=C&&I?I.background:null)d.backgroundFillSymbol=F(I,I.color,"polygon",null,w);y=x=y?C?v.size:null:"line"===q?e.width:e.size;r=e;
q=C?"point":q}var G={domain:h,fieldInfo:f};u.forEach(a,function(D,Q){G.value=D.value;D.label=E.createUniqueValueLabel(G);p&&(D.label=p(D));null===D.value&&(l=Q)});-1<l&&(k=a.splice(l,1)[0]);!1!==c.sortEnabled&&Va(a,t,h);f&&"esriFieldTypeDate"===f.type&&(G.dateFormatInterval=E.calculateDateFormatInterval(u.map(u.filter(a,function(D,Q){return Q<m}),function(D){return D.value})));var K=H.createColors(r.colors,a.length);u.forEach(a,function(D,Q){G.value=D.value;D.label=E.createUniqueValueLabel(G);p&&
(D.label=p(D));D.symbol=F(r,K[Q],q,x,w)});c.valueExpression&&(d.setValueExpression(c.valueExpression),d.valueExpressionTitle=c.valueExpressionTitle);d.legendOptions=c.legendOptions;K=H.createColors(r.colors,m);for(f=0;f<m;f++)(h=a[f])&&d.addValue({value:h.value,label:h.label,symbol:F(r,K[f],q,x,w)});g&&(d.defaultSymbol=F(r,r.noDataColor,q,y,w),d.defaultLabel=L.other);k&&(k.symbol=F(r,r.noDataColor,q,y,w),a.push(k));b&&b.widthInfo&&d.setVisualVariables([b.widthInfo]);return{renderer:d,uniqueValueInfos:a,
othersStartIndex:d.infos.length===a.length?-1:d.infos.length,scheme:e?da.cloneScheme(e):fa(c,q)}}function U(a,b,c){var d=a.scheme;d=d?S.cloneScheme(d):(d=S.getSchemes({theme:c||a.theme||"high-to-low",basemap:a.basemap,geometryType:b}))&&d.primaryScheme;return d}function ia(a,b){var c=a.avg,d=c-a.stddev,e=c+a.stddev;d<a.min&&(d=a.min);e>a.max&&(e=a.max);b&&(c=d+(e-d)/2);a=P.round([d,e],{strictBounds:!0});d=a[0];e=a[1];a=[d,d+(c-d)/2,c,c+(e-c)/2,e];return P.round(a,{strictBounds:!0})}function Wa(a,
b,c){var d=(b-a)/(c-1),e,g=[a];for(e=1;e<=c-2;e++)g.push(a+e*d);g.push(b);return P.round(g,{strictBounds:!0})}function V(a,b,c,d){a=a.statisticsPlugin.getSuggestedDataRange({statistics:b,isDate:c});if(a.defaultStatistics){var e=a.min;var g=a.max}else!d||null!=b.avg&&b.stddev||(e=b.min,g=b.max);return null!=e?[e,g]:null}function ra(a,b,c,d,e){var g=null==d.useDefaultStatistics?!0:d.useDefaultStatistics;if(!a||a.count||g){var f=d.layer,h=d.field,l=A.isFunction(h),k=(l=h&&!l?f.getField(h):null)&&"esriFieldTypeDate"===
l.type;l=M(f);var m=U(d,l),t=d.semiContinuous,p=b&&b.classBreakInfos,q=p&&p.length,r=b?q:5;if(m){var w=-1<m.id.indexOf("seq-"),v=b&&w?sa(m,{length:r}):H.createColors(m.colors,r);if(v.length<r)n(e,"smartMapping.createColorInfo: not enough colors in the scheme.");else{if(b){var y=[];if(1===q){var x=[p[0].minValue,p[0].maxValue];y=[0,1];var C=H.createColors(v,r)[0];var I=[C,new B(C)]}else t?(x=[],I=[],u.forEach(p,function(G,K){var D=.1*(G.maxValue-G.minValue);0===K?x.push(G.minValue):x.push(G.minValue+
D);K===q-1?x.push(G.maxValue):x.push(G.maxValue-D);C=new B(v[K]);I.push(C);I.push(new B(C));y.push(2*K);y.push(2*K+1)})):(x=u.map(p,function(G,K){y.push(K);return(G.minValue+G.maxValue)/2}),I=H.createColors(v,r));x=P.round(x,{strictBounds:!0})}else x=(g=g?V(f,a,k,!0):null)?Wa(g[0],g[1],5):ia(a,w),y=[0,2,4],I=H.createColors(v,r);c={type:"colorInfo",field:h,valueExpression:d.valueExpression,valueExpressionTitle:d.valueExpressionTitle,normalizationField:c,stops:E.createColorStops({values:x,isDate:k,
dateFormatOptions:k?E.timelineDateFormatOptions:null,colors:I,labelIndexes:y}),legendOptions:d.legendOptions};e.resolve({colorInfo:c,statistics:a,classBreaks:b,scheme:U(d,l)})}}else n(e,"smartMapping.createColorInfo: unable to find the specified scheme.")}else n(e,"smartMapping.createColorInfo: cannot create renderer when statistics.count is 0.")}function ta(a,b){var c=E.getClassValuesForRelationship();c=A.clone(c[a]);return O.flatten2DArray(c,b)}function Xa(a,b){a=ta(a,b);return u.map(a,function(c){return{value:c,
count:0}})}function Ya(a,b,c){var d=ta(b,c);a.sort(function(e,g){e=u.indexOf(d,e.value);g=u.indexOf(d,g.value);return e<g?-1:e>g?1:0})}function ua(a){var b=a.field1.field,c=a.field2.field,d=a.field1.normalizationField,e=a.field2.normalizationField,g=u.map(a.breaks1,function(h){return[h.minValue,h.maxValue]});a=u.map(a.breaks2,function(h){return[h.minValue,h.maxValue]});var f=g.length;f=E.getClassCodesForRelationship()[f];return["var field1 \x3d $feature['"+b+"'];","var field2 \x3d $feature['"+c+"'];",
"var hasNormField1 \x3d "+(d?"true":"false")+";","var hasNormField2 \x3d "+(e?"true":"false")+";","var normField1 \x3d "+(d?"$feature['"+d+"']":"null")+";","var normField2 \x3d "+(e?"$feature['"+e+"']":"null")+";","if (\n  IsEmpty(field1) || \n  IsEmpty(field2) ||\n  (hasNormField1 \x26\x26 (IsEmpty(normField1) || normField1 \x3d\x3d 0)) ||\n  (hasNormField2 \x26\x26 (IsEmpty(normField2) || normField2 \x3d\x3d 0))\n) {\n  return null; \n}\nvar value1 \x3d IIf(hasNormField1, (field1 / normField1), field1);\nvar value2 \x3d IIf(hasNormField2, (field2 / normField2), field2);",
"var breaks1 \x3d "+ca.stringify(g)+";","var breaks2 \x3d "+ca.stringify(a)+";","var classCodes \x3d "+ca.stringify(f)+";","function getClassCode(value, breaks) {\n  var code \x3d null;\n  for (var i in breaks) {\n    var info \x3d breaks[i];\n    if (value \x3e\x3d info[0] \x26\x26 value \x3c\x3d info[1]) {\n      code \x3d classCodes[i];\n      break;\n    }\n  }\n  return code;\n}\nvar code1 \x3d getClassCode(value1, breaks1);\nvar code2 \x3d getClassCode(value2, breaks2);\nvar classValue \x3d IIf(IsEmpty(code1) || IsEmpty(code2), null, code1 + code2);\nreturn classValue;"].join("\n")}
function Za(){var a=L.relationship;return function(b){return a[b.value]}}function $a(a,b,c){return{type:"relationship",classificationMethod:ab[a.classificationMethod]||null,numClasses:a.numClasses,focus:a.focus,field1:{field:a.field1.field,normalizationField:a.field1.normalizationField,classBreakInfos:u.map(b,W)},field2:{field:a.field2.field,normalizationField:a.field2.normalizationField,classBreakInfos:u.map(c,W)}}}function bb(a,b){var c=a.authoringInfo;if(c){c.numClasses=b.numClasses;c.focus=b.focus||
null;c.focus||delete c.focus;var d=b.field1;b=b.field2;d&&b&&(c.field1={field:d.field,normalizationField:d.normalizationField,classBreakInfos:u.map(d.classBreakInfos,W)},c.field2={field:b.field,normalizationField:b.normalizationField,classBreakInfos:u.map(b.classBreakInfos,W)});a.setAuthoringInfo(c)}else console.log("smartMapping.updateRelationshipRenderer: authoringInfo is missing.")}function va(a,b,c,d){var e=null==c.useDefaultStatistics?!0:c.useDefaultStatistics;if(!a||a.count||e){var g=c.layer,
f=c.field,h=f&&!A.isFunction(f)?g.getField(f):null,l=h&&"esriFieldTypeDate"===h.type,k=(h=c.useStdDev)?ia(a):null;g=(e=e?V(g,a,l,h):null)||(h?[k[0],k[4]]:[a.min,a.max]);d.resolve({opacityInfo:{type:"opacityInfo",field:f,valueExpression:c.valueExpression,valueExpressionTitle:c.valueExpressionTitle,normalizationField:b,stops:[{value:g[0],opacity:.3},{value:g[1],opacity:1}],legendOptions:c.legendOptions},statistics:a,defaultStatistics:!!e})}else n(d,"smartMapping.createOpacityInfo: cannot create opacityInfo when statistics.count is 0.")}
function X(a,b){var c=a.scheme;c=c?R.cloneScheme(c):(c=R.getSchemes({theme:a.theme||"default",basemap:a.basemap,geometryType:b}))&&c.primaryScheme;return c}function wa(a,b){switch(b){case "point":var c=[a.minSize,a.maxSize];break;case "line":c=[a.minWidth,a.maxWidth];break;case "polygon":c=[a.marker.minSize,a.marker.maxSize]}return c}function xa(a,b,c,d,e){var g=null==d.useDefaultStatistics?!0:d.useDefaultStatistics,f=b&&[b.minSize,b.maxSize];if(!a||a.count||g){var h=d.layer,l=d.field,k=l&&!A.isFunction(l)?
h.getField(l):null,m=k&&"esriFieldTypeDate"===k.type;k=M(h);var t=X(d,k);f=f||wa(t,k);var p=(t=d.useStdDev)?ia(a):null;h=(g=g?V(h,a,m,t):null)||(t?[p[0],p[4]]:[a.min,a.max]);e.resolve({sizeInfo:{type:"sizeInfo",field:l,valueExpression:d.valueExpression,valueExpressionTitle:d.valueExpressionTitle,valueUnit:"unknown",normalizationField:c,legendOptions:d.legendOptions,minSize:f[0],maxSize:f[1],minDataValue:h[0],maxDataValue:h[1]},statistics:a,defaultStatistics:!!g,suggestedSizeRange:b,scheme:X(d,k)})}else n(e,
"smartMapping.createSizeInfo: cannot create renderer when statistics.count is 0.")}function Y(a,b,c){var d,e=[],g=1/(c+1);for(d=1;d<=c;d++)e.push(B.blendColors(a,b,g*d));return e}function ya(a,b){var c=[];1===b?c=[a[0]]:2===b?c=[a[0],a[2]]:3===b?c=a:(c=b-a.length,b=c/2,0===c%2?(c=Y(a[0],a[1],b),b=Y(a[1],a[2],b)):(c=Y(a[0],a[1],Math.floor(b)),b=Y(a[1],a[2],Math.ceil(b))),c=[a[0]].concat(c).concat([a[1]]).concat(b).concat([a[2]]));return c}function sa(a,b,c){var d=b.length,e=-1;c&&u.some(b,function(h,
l){h.hasAvg&&(e=l);return-1<e});if(-1<e){var g=a.colors;a=e+1;b=d-e;c=g.slice(0,3);g=g.slice(2);c.reverse();c=ya(c,a);g=ya(g,b);c.reverse();var f=[].concat(c).concat(g.slice(1))}else if((a=a.colorsForClassBreaks)&&0<a.length&&(u.some(a,function(h){h.numClasses===d&&(f=h.colors);return!!f}),!f&&(c=a[a.length-1],a=d-c.numClasses,0<a)))for(b=c.colors[c.numClasses-1],f=c.colors.splice(0),c=1;c<=a;c++)f.push(b);f&&(f=H.createColors(f,f.length));return f}function cb(a,b,c,d){var e=c.field,g=M(c.layer),
f=null==c.showOthers?!0:c.showOthers,h=b&&b.opacity,l=c.classificationMethod||"equal-interval",k="standard-deviation"===l,m=c.normalizationType,t,p,q=a.classBreakInfos;if(t=U(c,g,"high-to-low"))if((p=sa(t,q))&&p.length==q.length){var r=new T(null,e);c.valueExpression&&(r.setValueExpression(c.valueExpression),r.valueExpressionTitle=c.valueExpressionTitle);r.legendOptions=c.legendOptions;r.classificationMethod=l;r.normalizationType=m;r.normalizationField="field"===m?c.normalizationField:void 0;r.normalizationTotal=
"percent-of-total"===m?a.normalizationTotal:void 0;f&&(r.defaultSymbol=F(t,t.noDataColor,g,null,h),r.defaultLabel=L.other);u.forEach(q,function(w,v){r.addBreak({minValue:w.minValue,maxValue:w.maxValue,symbol:F(t,p[v],g,null,h),label:w.label})});k||E.setLabelsForClassBreaks({classBreaks:r.infos,classificationMethod:l,normalizationType:m,round:!0});b&&b.widthInfo&&r.setVisualVariables([b.widthInfo]);a.renderer=r;a.scheme=U(c,g,"high-to-low");d.resolve(a)}else n(d,"smartMapping.createClassedColorRenderer: unable to find suitable colors for number of classes.");
else n(d,"smartMapping.createClassedColorRenderer: unable to find suitable style scheme.")}function Z(a){var b=new z,c=a.layer,d=null==a.useDefaultBreaks?!0:a.useDefaultBreaks,e=a.optimizeOutline,g=[c.statisticsPlugin.getClassBreaks(a)];e&&g.push(c.statisticsPlugin.getSuggestedOutline("object"===typeof e?e:null));(new N(g)).then(function(f){var h=f[0];f=f[1];var l=e&&f[0]?f[1]:null;if(h[0]||d&&!c.graphics.length){h=h[1];var k=d?V(c,h?{min:h.minValue,max:h.maxValue}:{}):null;k&&(h=a.layer.statisticsPlugin.getClassBreaks(A.mixin(a,
{classificationMethod:"equal-interval",numClasses:1,analyzeData:!1,minValue:k[0],maxValue:k[1],normalizationTotal:k[0]+k[1]})));ba(h).then(function(m){m.defaultStatistics=!!k;b.resolve({cbResponse:m,suggestedOutline:l})}).otherwise(function(){n(b,"smartMapping: error when calculating default class breaks.")})}else n(b,"smartMapping: error when calculating class breaks.")});return b.promise}function db(a,b,c,d){b=d||wa(a,b);a=b[0];b=(b[1]-a)/(4<=c?c-1:c);var e=[];for(d=0;d<c;d++)e.push(a+b*d);return e}
function ja(a,b,c,d,e){var g=d.field,f=M(d.layer),h=null==d.showOthers?!0:d.showOthers,l=c&&c.opacity,k=d.classificationMethod||"equal-interval",m=d.normalizationType,t=a.classBreakInfos,p=X(d,f),q=db(p,f,t.length,b),r="polygon"===f,w=r?p.marker:p;b=r?p.background:null;var v=new T(null,g);d.valueExpression&&(v.setValueExpression(d.valueExpression),v.valueExpressionTitle=d.valueExpressionTitle);v.legendOptions=d.legendOptions;v.classificationMethod=k;v.normalizationType=m;v.normalizationField="field"===
m?d.normalizationField:void 0;v.normalizationTotal="percent-of-total"===m?a.normalizationTotal:void 0;h&&(v.defaultSymbol=F(w,w.noDataColor,r?"point":f),v.defaultLabel=L.other);b&&(v.backgroundFillSymbol=F(b,b.color,f,null,l));u.forEach(t,function(y,x){v.addBreak({minValue:y.minValue,maxValue:y.maxValue,symbol:F(w,w.color,r?"point":f,q[x]),label:y.label})});"standard-deviation"!==k&&E.setLabelsForClassBreaks({classBreaks:v.infos,classificationMethod:k,normalizationType:m,round:!0});c&&c.widthInfo&&
v.setVisualVariables([c.widthInfo]);a.renderer=v;a.scheme=X(d,f);e.resolve(a)}function ka(a){var b=a.scheme;b=b?na.cloneScheme(b):(b=na.getSchemes({theme:a.theme||"default",basemap:a.basemap}))&&b.primaryScheme;return b}function za(a,b,c){var d=null==b.useDefaultStatistics?!0:b.useDefaultStatistics;if(a.count||d){var e=a.fieldOffset,g=null==b.blurRadius?10:b.blurRadius,f=null==b.minRatio?.01:b.minRatio,h=null==b.maxRatio?1:b.maxRatio,l=null==b.fadeToTransparent?!0:b.fadeToTransparent,k=ka(b).colors,
m=k.length,t=(d=!a.count&&d)?[0,100]:[a.min,a.max],p=new Qa;p.setBlurRadius(g);p.setField(b.field);null!=e&&p.setFieldOffset(e);p.setMinPixelIntensity(t[0]);p.setMaxPixelIntensity(t[1]);e=k[0];var q=[{ratio:0,color:new B([e.r,e.g,e.b,0])},{ratio:.01,color:new B([e.r,e.g,e.b,0])},{ratio:l?f:.01,color:e}],r=(h-f)/(m-1);k=H.createColors(k,m);u.forEach(k,function(w,v){q.push({ratio:f+r*v,color:w})});p.setColorStops(q);c.resolve({renderer:p,statistics:a,defaultStatistics:d,scheme:ka(b)})}else n(c,"smartMapping.createHeatmapRenderer: cannot create renderer when statistics.count is 0.")}
function eb(a,b,c){var d=a.scheme;d=d?da.cloneScheme(d):(d=da.getSchemes({theme:a.theme||"default",basemap:a.basemap,geometryType:b,numColors:c}))&&d.primaryScheme;return d}function fb(a,b){var c={};u.forEach(a,function(d){var e=b.getField(d.name);c[d.name]=d.label||e&&e.alias||d.name});return function(d){return c[d.value]}}function gb(a,b,c,d,e){var g=new z,f=a.layer;f.statisticsPlugin.getPredominantCategories({fields:b}).always(function(h){h&&h.predominantCategoryInfos||(h={predominantCategoryInfos:u.map(b,
function(k){return{value:k,count:0}})});var l=ha(h.predominantCategoryInfos,e,{layer:f,valueExpression:d.valueExpression,valueExpressionTitle:L.predominantCategory,labelCallback:fb(a.fields,f),numTypes:-1,showOthers:a.showOthers,sortBy:"count",customScheme:c,useSizeInfo:a.includeSizeInfo});l.predominantCategoryInfos=l.uniqueValueInfos;delete l.uniqueValueInfos;l.source=h.source;g.resolve(l)});return g.promise}function hb(a,b,c,d){var e=new z;H.createSizeInfo({layer:a.layer,valueExpression:d.valueExpression,
sqlExpression:d.statisticsQuery.sqlExpression,sqlWhere:d.statisticsQuery.sqlWhere,scheme:c,optimizeForScale:a.optimizeForScale}).then(function(g){g.sizeInfo.legendOptions={title:L.sumOfCategories};e.resolve(g)}).otherwise(function(g){n(e,"smartMapping.createPredominanceRenderer: error when calculating statistics for visual variable(size).")});return e.promise}function ib(a,b,c){var d=new z;a.layer.statisticsPlugin.getFieldStatistics({valueExpression:c.valueExpression,sqlExpression:c.statisticsQuery.sqlExpression,
sqlWhere:c.statisticsQuery.sqlWhere}).then(function(e){var g=null==e.avg||null==e.stddev,f=1/b.length*100,h=g?100:e.avg+1.285*e.stddev;100<h&&(h=100);f=P.round([f,h],{strictBounds:!0});d.resolve({opacityInfo:{type:"opacityInfo",valueExpression:c.valueExpression,stops:[{value:f[0],opacity:.15},{value:f[1],opacity:1}],legendOptions:{title:L.strengthOfPredominance}},statistics:e,defaultStatistics:g})}).otherwise(function(e){n(d,"smartMapping.createPredominanceRenderer: error when calculating statistics for visual variable(opacity).")});
return d.promise}function jb(a,b,c,d){var e=b.length,g=M(a.layer),f=eb(a,g,e);a.layer.statisticsPlugin.getPredominanceExpressions({fields:b}).then(function(h){var l=gb(a,b,f,h.predominantCategory,c),k,m;a.includeSizeInfo&&(k=hb(a,b,f.sizeInfo,h.size));a.includeOpacityInfo&&(m=ib(a,b,h.opacity));Ka([l,k,m]).then(function(t){var p=t[0],q=t[1],r=t[2];t=[];if(p instanceof Error)n(d,"smartMapping.createPredominanceRenderer: unable to create unique-value renderer.");else{if(k){if(q instanceof Error){n(d,
"smartMapping.createPredominanceRenderer: unable to create visual variable for symbol size.");return}t.push(E.cloneSizeInfo(q.sizeInfo));delete q.scheme;p.size=q}if(m){if(r instanceof Error){n(d,"smartMapping.createPredominanceRenderer: unable to create visual variable for symbol opacity.");return}t.push(E.cloneOpacityInfo(r.opacityInfo));p.opacity=r}if(t.length){if(q=p.renderer.visualVariables)Array.prototype.push.apply(q,t),t=q;p.renderer.setVisualVariables(t)}d.resolve(p)}})}).otherwise(function(h){n(d,
"smartMapping.createPredominanceRenderer: unable to generate expressions.")})}function Aa(a,b,c){var d=a;if("string"===typeof a)(a=c.getField(a))&&"esriFieldTypeDate"===a.type&&(d=c.getFieldLabel(a.name));else if("number"===typeof a||a instanceof Date)c=-1<u.indexOf(kb,b)?null:"date",d=E.formatDate(a,{selector:c});return d}function lb(a,b,c){var d=b.startTime,e=b.endTime,g=b.layer;g.statisticsPlugin.getAgeExpressions({startTime:d,endTime:e,units:a.units}).then(function(f){var h=a.units,l="ageInfo_"+
h;a.legendOptions={title:La.substitute({units:h,startTime:Aa(d,h,g),endTime:Aa(e,h,g)},L[l])};A.mixin(a,f);c.resolve(a)}).otherwise(function(f){n(c,"smartMapping.createAgeInfo: unable to generate expressions to calculate age.")})}function Ba(a,b){var c,d,e,g,f,h,l,k={};a=u.filter(a,function(m){c=m.name;d=c.toLowerCase();if(f=c!==b&&-1===u.indexOf(Ca,d))h=h||(-1<u.indexOf(Da,m.type)?c:null),l=l||("esriFieldTypeString"===m.type?c:null);return f});u.forEach(a,function(m){c=m.name;d=c.toLowerCase();(e=
-1<u.indexOf(Da,m.type))&&(k=Ea(c,d,mb,k,"number"));k.rank&&"string"!==k.fieldType||(g="esriFieldTypeString"===m.type)&&(k=Ea(c,d,nb,k,"string"))});return k.fieldName||h||l}function Ea(a,b,c,d,e){var g=-1;var f=-1;var h;g=u.indexOf(c,b);for(h=0;h<c.length;h++)if(-1<b.indexOf(c[h])){f=h;break}b=g;-1<b&&(!d.rank||d.fieldType!==e||"exact"===d.matchType&&d.fieldType===e&&d.rank>b)?d={rank:b,matchType:"exact",fieldType:e,fieldName:a}:-1<f&&(!d.rank||d.fieldType===e&&"contains"===d.matchType&&d.rank>f)&&
(d={rank:f,matchType:"contains",fieldType:e,fieldName:a});return d}var H={},aa=Math.pow(2,53)-1,L=Sa.smartMapping,ob=/(https?:)?\/\/services.*\.arcgis\.com/i,Ca="id fips fid objectid _objectid __objectid x y lat long latitude longitude shape shape_length shape_leng shape_area perimeter stretched_value fnode_ tnode_ lpoly_ rpoly_ poly_ subclass rings_ok rings_nok st_length(shape) st_area(shape)".split(" "),mb="count percent sum elevation value valore valoare total gesamt score income age expected average median size cost expenditure revenue profit growth sale quantity population price unit length width difference distance".split(" "),
nb="type name status class category code value label zone symbol color owner district group species rating score party".split(" "),Da=["esriFieldTypeInteger","esriFieldTypeDouble","esriFieldTypeSingle","esriFieldTypeSmallInteger"],pb=["HH","HL","LH","LL"],ab={"equal-interval":"esriClassifyEqualInterval","natural-breaks":"esriClassifyNaturalBreaks",quantile:"esriClassifyQuantile"},W=function(a){return{minValue:a.minValue,maxValue:a.maxValue}},kb=["hours","minutes","seconds"],J=function(a){return la.toAbsMid?
la.toAbsMid(a):Fa.id.replace(/\/[^\/]*$/ig,"/")+a}("../plugins/FeatureLayerStatistics");A.mixin(H,{createColors:function(a,b){var c=[],d=a.length,e;for(e=0;e<b;e++)c.push(new B(a[e%d]));return c},createTypeRenderer:function(a){var b=new z;if(!a||!a.layer||!a.field&&!a.valueExpression||!a.scheme&&!a.basemap)return n(b,"smartMapping.createTypeRenderer: missing parameters."),b.promise;var c=a.layer,d=a.optimizeOutline;c.addPlugin(J).then(function(){var e=[c.statisticsPlugin.getUniqueValues({field:a.field,
valueExpression:a.valueExpression,includeAllCodedValues:a.includeAllCodedValues})];d&&e.push(c.statisticsPlugin.getSuggestedOutline("object"===typeof d?d:null));(new N(e)).then(function(g){var f=g[0];g=g[1];g=d&&g[0]?g[1]:null;f[0]?(f=f[1],g=ha(f.uniqueValueInfos,g,a),g.source=f.source,g.partialData=f.partialData,b.resolve(g)):n(b,"smartMapping.createTypeRenderer: error when calculating unique values.")})}).otherwise(function(e){n(b,"smartMapping.createTypeRenderer: error when adding feature layer statistics plugin.")});
return b.promise},createColorInfo:function(a){var b=new z;if(!(a&&a.layer&&(a.field||a.valueExpression||a.sqlExpression)))return n(b,"smartMapping.createColorInfo: missing parameters."),b.promise;var c=a.layer,d=a.normalizationField,e=d?"field":void 0;a.statistics?ra(a.statistics,null,d,a,b):c.addPlugin(J).then(function(){var g="group-similar"===a.theme||a.scheme&&0===a.scheme.id.indexOf("group-similar/");(g?c.statisticsPlugin.getClassBreaks({field:a.field,valueExpression:a.valueExpression,classificationMethod:"natural-breaks",
numClasses:a.numGroups||5,normalizationType:e,normalizationField:d,minValue:a.minValue,maxValue:a.maxValue}):c.statisticsPlugin.getFieldStatistics({field:a.field,valueExpression:a.valueExpression,sqlExpression:a.sqlExpression,sqlWhere:a.sqlWhere,normalizationType:e,normalizationField:d,minValue:a.minValue,maxValue:a.maxValue})).then(function(f){var h,l;g?h=f:l=f;ra(l,h,d,a,b)}).otherwise(function(f){n(b,g?"smartMapping.createColorInfo: error when calculating class breaks.":"smartMapping.createColorInfo: error when calculating field statistics.")})}).otherwise(function(g){n(b,
"smartMapping.createColorInfo: error when adding feature layer statistics plugin.")});return b.promise},createColorRenderer:function(a){var b=new z;if(!(a&&a.layer&&(a.field||a.valueExpression||a.sqlExpression)))return n(b,"smartMapping.createColorRenderer: missing parameters."),b.promise;var c=a.layer,d=a.normalizationField,e=d?"field":void 0,g=a.optimizeOutline;c.addPlugin(J).then(function(){var f=[H.createColorInfo(a)];g&&f.push(c.statisticsPlugin.getSuggestedOutline("object"===typeof g?g:null));
(new N(f)).then(function(h){var l=h[0];h=h[1];h=g&&h[0]?h[1]:null;if(l[0]){l=l[1];var k=a.field,m=M(a.layer),t=null==a.showOthers?!0:a.showOthers,p=h&&h.opacity,q=S.cloneScheme(l.scheme);k=new T(null,k);a.valueExpression&&k.setValueExpression(a.valueExpression);t&&(k.defaultSymbol=F(q,q.noDataColor,m,null,p),k.defaultLabel=L.other);k.addBreak({minValue:-aa,maxValue:aa,symbol:F(q,q.noDataColor,m,null,p)});k.normalizationType=e;k.normalizationField=d;m=[E.cloneColorInfo(l.colorInfo)];h&&h.widthInfo&&
m.push(h.widthInfo);k.setVisualVariables(m);b.resolve({renderer:k,colorInfo:E.cloneColorInfo(l.colorInfo),statistics:l.statistics,classBreaks:l.classBreaks,scheme:S.cloneScheme(l.scheme)})}else n(b,"smartMapping.createColorRenderer: error when calculating colorInfo.")})}).otherwise(function(f){n(b,"smartMapping.createColorRenderer: error when adding feature layer statistics plugin.")});return b.promise},createRelationshipRenderer:function(a){var b=new z;if(!(a&&a.layer&&a.field1&&a.field2))return n(b,
"smartMapping.createRelationshipRenderer: missing parameters."),b.promise;a=A.mixin({},a);a.classificationMethod=a.classificationMethod||"quantile";a.numClasses=a.numClasses||3;a.focus=a.focus||null;var c=a.classificationMethod,d=a.numClasses,e=a.layer;if("standard-deviation"===c||"geometrical-interval"===c)return n(b,"smartMapping.createRelationshipRenderer: classification method '"+c+"' is not supported."),b.promise;if(2>d||4<d)return n(b,"smartMapping.createRelationshipRenderer: numClasses must be 2, 3 or 4."),
b.promise;if(a.focus&&-1===u.indexOf(pb,a.focus))return n(b,"smartMapping.createRelationshipRenderer: 'focus' must be 'HH', 'HL', 'LH', 'LL' or null."),b.promise;e.addPlugin(J).then(function(){var g=a.field1,f=a.field2,h={layer:e,classificationMethod:c,numClasses:d};g=[Z(A.mixin({field:g.field,normalizationField:g.normalizationField,normalizationType:g.normalizationField?"field":null,minValue:g.minValue,maxValue:g.maxValue,analyzeData:!(null!=g.minValue&&null!=g.maxValue)},h)),Z(A.mixin({field:f.field,
normalizationField:f.normalizationField,normalizationType:f.normalizationField?"field":null,minValue:f.minValue,maxValue:f.maxValue,analyzeData:!(null!=f.minValue&&null!=f.maxValue)},h))];var l=a.optimizeOutline;l&&g.push(e.statisticsPlugin.getSuggestedOutline("object"===typeof l?l:null));(new N(g)).then(function(k){var m=k[0],t=k[1];if(m[0]&&t[0]){var p=k[2];k=a;m=m[1];t=t[1];var q=l&&p[0]?p[1]:null,r=k.numClasses;p=m.cbResponse.classBreakInfos;var w=t.cbResponse.classBreakInfos;if(r===p.length&&
p.length===w.length){var v=Xa(r,k.focus),y=ua({field1:k.field1,field2:k.field2,breaks1:p,breaks2:w});var x=M(k.layer);var C=k.scheme;C=C?O.cloneScheme(C):(C=O.getSchemes({theme:k.theme||"default",basemap:k.basemap,geometryType:x}))&&C.primaryScheme;x=C;q=ha(v,q,{layer:k.layer,valueExpression:y,valueExpressionTitle:L.relationship.legendTitle,labelCallback:Za(),numTypes:-1,showOthers:k.showOthers,sortEnabled:!1,customScheme:A.mixin({colors:O.getColors(x,r,k.focus)},x)});q.renderer.setAuthoringInfo($a(k,
p,w));b.resolve({classBreaks:{field1:m.cbResponse,field2:t.cbResponse},renderer:q.renderer,uniqueValueInfos:q.uniqueValueInfos,scheme:O.cloneScheme(x)})}else n(b,"smartMapping.createRelationshipRenderer: incompatible class breaks.")}else n(b,"smartMapping.createRelationshipRenderer: error when calculating class breaks.")}).otherwise(function(k){n(b,"smartMapping.createRelationshipRenderer: "+(k&&k.message||"error when calculating components."))})}).otherwise(function(g){n(b,"smartMapping.createRelationshipRenderer: "+
(g&&g.message||"error when adding feature layer statistics plugin."))});return b.promise},updateRelationshipRenderer:function(a){if(a&&a.renderer&&a.numClasses){var b=a.field1,c=a.field2;if(!b&&!c||b&&c&&b.field&&c.field)if(b&&!b.classBreakInfos||c&&!c.classBreakInfos)console.log("smartMapping.updateRelationshipRenderer: 'field1' and/or 'field2' is missing 'classBreakInfos'");else{var d=a.renderer,e=a.numClasses,g=a.focus||null,f=Math.pow(e,2);if(d.infos.length!==f)console.log("smartMapping.updateRelationshipRenderer: invalid 'renderer.infos'. Must have "+
f+" unique value infos.");else{var h=a.colors;if(h){h=u.map(h,function(k){return H.createColors(k,k.length)});var l=O.flatten2DArray(h,g);if(l.length!==f){console.log("smartMapping.updateRelationshipRenderer: invalid 'colors'. Must have "+f+" colors.");return}}b&&c&&(b=ua({field1:b,field2:c,breaks1:b.classBreakInfos,breaks2:c.classBreakInfos}),d.setValueExpression(b));Ya(d.infos,e,g);l&&u.map(d.infos,function(k,m){Oa.setSymbolFillColor(k.symbol,l[m])});bb(d,a)}}else console.log("smartMapping.updateRelationshipRenderer: Both 'field1' and 'field2' are required.")}else console.log("smartMapping.updateRelationshipRenderer: missing parameters: renderer, numClasses.")},
createOpacityInfo:function(a){var b=new z;if(!(a&&a.layer&&(a.field||a.valueExpression||a.sqlExpression)))return n(b,"smartMapping.createOpacityInfo: missing parameters."),b.promise;var c=a.layer,d=a.normalizationField,e=d?"field":void 0;a.statistics?va(a.statistics,d,a,b):c.addPlugin(J).then(function(){c.statisticsPlugin.getFieldStatistics({field:a.field,valueExpression:a.valueExpression,sqlExpression:a.sqlExpression,sqlWhere:a.sqlWhere,normalizationType:e,normalizationField:d,minValue:a.minValue,
maxValue:a.maxValue,features:a.features}).then(function(g){va(g,d,a,b)}).otherwise(function(g){n(b,"smartMapping.createOpacityInfo: error when calculating field statistics.")})}).otherwise(function(g){n(b,"smartMapping.createOpacityInfo: error when adding feature layer statistics plugin.")});return b.promise},createBlendRenderer:function(a){var b=new z,c=this,d=[],e={},g=[],f=[],h=a.opacityValueCombinationMethod||"avg",l={};if(!(a&&a.layer&&a.blendedFields))return n(b,"smartMapping.createBlendRenderer: missing parameters."),
b.promise;a.basemap=a.basemap||"topo";d=M(a.layer);var k=fa({basemap:a.basemap},d);k.colors=[new B("#e60000"),new B("#0000e6"),new B("#00e600"),new B("#e67300"),new B("#a900e6")];l.fields=[];l.normalizationField=a.normalizationField;l.blendMode=a.blendMode||"source-over";l.symbol=F(k,k.noDataColor,a.markers?"point":d);e.layer=a.layer;e.normalizationField=a.normalizationField;e.useStdDev=a.useStdDev||!1;d=u.map(a.blendedFields,function(m,t){l.fields.push({field:m,color:k.colors[t]});e.field=m;return c.createOpacityInfo(e)});
Ha(d).then(function(m){f[0]=m[0].opacityInfo.stops[0].value;f[1]=m[1].opacityInfo.stops[1].value;u.forEach(m.slice(0,1),function(t){var p=t.opacityInfo.stops[0].value,q=t.opacityInfo.stops[1].value;"union"===h?(f[0]=p<f[0]?p:f[0],f[1]=q>f[1]?q:f[1]):"avg"===h&&(f[0]+=t.opacityInfo.stops[0].value,f[1]+=t.opacityInfo.stops[1].value)});g[0]={value:"avg"===h?f[0]/m.length:f[0],opacity:a.minOpacity?a.minOpacity:m[0].opacityInfo.stops[0].opacity};g[1]={value:"avg"===h?f[1]/m.length:f[1],opacity:a.maxOpacity?
a.maxOpacity:m[0].opacityInfo.stops[1].opacity};l.opacityStops=g;b.resolve({renderer:new Ra(l),scheme:k,opacityInfos:m})});return b.promise},createSizeInfo:function(a){var b=new z;if(!(a&&a.layer&&(a.field||a.valueExpression||a.sqlExpression)))return n(b,"smartMapping.createSizeInfo: missing parameters."),b.promise;var c=a.layer,d=a.normalizationField,e=d?"field":void 0,g=a.optimizeForScale;a.statistics?xa(a.statistics,null,d,a,b):c.addPlugin(J).then(function(){var f=[c.statisticsPlugin.getFieldStatistics({field:a.field,
valueExpression:a.valueExpression,sqlExpression:a.sqlExpression,sqlWhere:a.sqlWhere,normalizationType:e,normalizationField:d,minValue:a.minValue,maxValue:a.maxValue})];g&&f.push(c.statisticsPlugin.getSuggestedSizeRange({optimizeForScale:!0===g?"map-scale":g}));(new N(f)).then(function(h){var l=h[0];h=g&&h[1];h=g&&h[0]?h[1]:null;l[0]?xa(l[1],h,d,a,b):n(b,"smartMapping.createSizeInfo: error when calculating field statistics.")})}).otherwise(function(f){n(b,"smartMapping.createSizeInfo: error when adding feature layer statistics plugin.")});
return b.promise},createSizeRenderer:function(a){var b=new z;if(!(a&&a.layer&&(a.field||a.valueExpression||a.sqlExpression)))return n(b,"smartMapping.createSizeRenderer: missing parameters."),b.promise;var c=a.layer,d=a.normalizationField,e=d?"field":void 0,g=a.optimizeOutline;c.addPlugin(J).then(function(){var f=[H.createSizeInfo(a)];g&&f.push(c.statisticsPlugin.getSuggestedOutline("object"===typeof g?g:null));(new N(f)).then(function(h){var l=h[0];h=h[1];h=g&&h[0]?h[1]:null;if(l[0]){l=l[1];var k=
a.field,m=M(a.layer),t=null==a.showOthers?!0:a.showOthers,p=h&&h.opacity,q=R.cloneScheme(l.scheme),r="polygon"===m,w=r?q.marker:q;q=r?q.background:null;var v="line"===m?w.noDataWidth:w.noDataSize;k=new T(null,k);a.valueExpression&&k.setValueExpression(a.valueExpression);t&&(k.defaultSymbol=F(w,w.noDataColor,r?"point":m,v),k.defaultLabel=L.other);k.addBreak({minValue:-aa,maxValue:aa,symbol:F(w,w.color,r?"point":m)});q&&(k.backgroundFillSymbol=F(q,q.color,m,null,p));k.normalizationType=e;k.normalizationField=
d;m=[E.cloneSizeInfo(l.sizeInfo)];h&&h.widthInfo&&m.push(h.widthInfo);k.setVisualVariables(m);b.resolve({renderer:k,sizeInfo:E.cloneSizeInfo(l.sizeInfo),statistics:l.statistics,defaultStatistics:l.defaultStatistics,suggestedSizeRange:l.suggestedSizeRange,scheme:R.cloneScheme(l.scheme)})}else n(b,"smartMapping.createSizeRenderer: error when calculating sizeInfo.")})}).otherwise(function(f){n(b,"smartMapping.createSizeRenderer: error when adding feature layer statistics plugin.")});return b.promise},
createClassedColorRenderer:function(a){var b=new z,c=a.minValue,d=a.maxValue;if(!a||!a.layer||!a.field&&!a.valueExpression)return n(b,"smartMapping.createClassedColorRenderer: missing parameters."),b.promise;var e=null!=c&&null!=d;if(!e&&(null!=c||null!=d))return n(b,"smartMapping.createClassedColorRenderer: both minValue and maxValue are required when specifying custom data range."),b.promise;a=A.mixin({analyzeData:!e},a);a.layer.addPlugin(J).then(function(){Z(a).then(function(g){cb(g.cbResponse,
g.suggestedOutline,a,b)}).otherwise(function(g){n(b,"smartMapping.createClassedColorRenderer: error when calculating class breaks.")})}).otherwise(function(g){n(b,"smartMapping.createClassedColorRenderer: error when adding feature layer statistics plugin.")});return b.promise},createClassedSizeRenderer:function(a){var b=new z,c=a.minValue,d=a.maxValue;if(!a||!a.layer||!a.field&&!a.valueExpression)return n(b,"smartMapping.createClassedSizeRenderer: missing parameters."),b.promise;var e=null!=c&&null!=
d;if(!e&&(null!=c||null!=d))return n(b,"smartMapping.createClassedColorRenderer: both minValue and maxValue are required when specifying custom data range."),b.promise;a=A.mixin({analyzeData:!e},a);var g=a.layer;g.addPlugin(J).then(function(){Z(a).then(function(f){a.optimizeForScale?g.statisticsPlugin.getSuggestedSizeRange().then(function(h){ja(f.cbResponse,[h.minSize,h.maxSize],f.suggestedOutline,a,b)}).otherwise(function(h){ja(f.cbResponse,null,f.suggestedOutline,a,b)}):ja(f.cbResponse,null,f.suggestedOutline,
a,b)}).otherwise(function(f){n(b,"smartMapping.createClassedSizeRenderer: error when calculating class breaks.")})}).otherwise(function(f){n(b,"smartMapping.createClassedSizeRenderer: error when adding feature layer statistics plugin.")});return b.promise},createHeatmapRenderer:function(a){var b=new z;if(!a||!a.layer)return n(b,"smartMapping.createHeatmapRenderer: missing parameters."),b.promise;var c=a.layer;a.statistics?za(a.statistics,a,b):c.addPlugin(J).then(function(){c.statisticsPlugin.getHeatmapStatistics(a).then(function(d){za(d,
a,b)}).otherwise(function(d){n(b,"smartMapping.createHeatmapRenderer: error when calculating heatmap statistics.")})}).otherwise(function(d){n(b,"smartMapping.createHeatmapRenderer: error when adding feature layer statistics plugin.")});return b.promise},applyHeatmapScheme:function(a){if(a&&a.renderer&&a.scheme){var b=ka({scheme:a.scheme});a=a.renderer;var c=a.colorStops;b=b.colors;if(c.length!==b.length+3)console.log("smartMapping.applyHeatmapScheme: incompatible number of colors in 'colors' and 'renderer.colorStops'.");
else{var d=new B(b[0]);c=u.map(c,function(e){return A.mixin({},e)});c[0].color=new B([d.r,d.g,d.b,0]);c[1].color=new B([d.r,d.g,d.b,0]);c[2].color=d;for(d=3;d<c.length;d++)c[d].color=b[d-3];a.setColorStops(c)}}else console.log("smartMapping.applyHeatmapScheme: missing parameters.")},sampleSize:500,createPredominanceRenderer:function(a){var b=new z;if(!(a&&a.layer&&a.fields&&1<a.fields.length))return n(b,"smartMapping.createPredominanceRenderer: missing parameters."),b.promise;if(10<a.fields.length)return n(b,
"smartMapping.createPredominanceRenderer: too many fields. Maximum supported is 10."),b.promise;var c=a.layer;c.addPlugin(J).then(function(){var d=u.map(a.fields,function(e){return e.name});oa(c,function(){var e=c.getOutFields()||[],g=-1!==u.indexOf(e,"*"),f=a.optimizeOutline;g=g?null:u.filter(d,function(h){return-1===u.indexOf(e,h)});!c.url||c._collection||ob.test(c.url)?g&&g.length?n(b,"smartMapping.createPredominanceRenderer: make sure the layer is configured to fetch all fields specified in parameters."):
(f=f?c.statisticsPlugin.getSuggestedOutline("object"===typeof f?f:null):null,ba(f).always(function(h){h&&!h.widthInfo&&(h=null);jb(a,d,h,b)})):n(b,"smartMapping.createPredominanceRenderer: predominance renderer is not supported for this layer. Make sure the layer supports advanced SQL expressions and standardized queries.")})}).otherwise(function(d){n(b,"smartMapping.createPredominanceRenderer: error when adding feature layer statistics plugin.")});return b.promise},createAgeInfo:function(a){var b=
new z;if(!(a&&a.layer&&a.startTime&&a.endTime))return n(b,"smartMapping.createAgeInfo: missing parameters."),b.promise;var c=a.layer;c.addPlugin(J).then(function(){var d=a.units?{units:a.units}:c.statisticsPlugin.getSuggestedAgeUnits({startTime:a.startTime,endTime:a.endTime});ba(d).then(function(e){lb(e,a,b)}).otherwise(function(e){n(b,"smartMapping.createAgeInfo: unable to calculate age units.")})}).otherwise(function(d){n(b,"smartMapping.createAgeInfo: error when adding feature layer statistics plugin.")});
return b.promise},excludedFields:Ca,getSuggestedField:function(a){var b=new z;if(!a||!(a.layer||a.fields&&a.objectIdField))return n(b,"smartMapping.getSuggestedField: missing parameters."),b.promise;a.layer?oa(a.layer,function(){b.resolve(Ba(a.layer.fields,a.layer.objectIdField))}):b.resolve(Ba(a.fields,a.objectIdField));return b.promise}});Ga("extend-esri")&&A.setObject("renderer.smartMapping",H,Ja);return H});