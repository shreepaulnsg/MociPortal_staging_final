// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/renderers/DotDensityRenderer","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/dom-construct dojo/has dojox/gfx/_base ../kernel ../lang ../Color ./Renderer ../symbols/PictureFillSymbol ../geometry/ScreenPoint ../geometry/Point".split(" "),function(h,l,t,u,v,w,x,m,n,y,z,A,r){h=h(y,{declaredClass:"esri.renderer.DotDensityRenderer",constructor:function(a){this.dotSize=a.dotSize||3;this.dotValue=a.dotValue;this.fields=a.fields;this.outline=a.outline;this.backgroundColor=a.backgroundColor;
this.exactCount=a.exactCount||!0;this.dotShape=a.dotShape||"square";this.legendOptions=a.legendOptions;this._exactCountMinArea=1E4;this._currentMapScale=this._map=this._canvas=null;this._symbolMap={};this._currentGraphic=this._currentResolution=this._objectIdField=null;this._supportsCanvas=window.CanvasRenderingContext2D?!0:!1;window.CanvasRenderingContext2D||console.log("The DotDensityRenderer requires a Canvas enabled Browser.  IE8 and less does not support Canvas.")},getSymbol:function(a){this._currentGraphic=
a;if(!this._supportsCanvas)return null;this._map||(this._map=a.getLayer()._map,this._objectIdField=a.getLayer().objectIdField,this._currentMapScale=this._map.getScale(),this._currentResolution=this._map.extent.getWidth()/this._map.width,this._map.on("zoom-end",l.hitch(this,function(d){this._currentMapScale=this._map.getScale();this._currentResolution=d.extent.getWidth()/this._map.width;this._symbolMap[this._currentMapScale]={}})));if(this._symbolMap[this._currentMapScale]&&this._symbolMap[this._currentMapScale][a.attributes[this._objectIdField]]){var b=
this._symbolMap[this._currentMapScale][a.attributes[this._objectIdField]];var c=this._getShapeProperties(a);b.setOffset(c.dx,c.dy);return b}b=this._generateFieldsCount(this.fields,a.attributes,this.dotValue);c=this._getShapeProperties(a);if(!c.width||!c.height)return null;b=new z(this._generateImageSrc(c.width,c.height,b,c.minXY,c.maxXY),this.outline,c.width,c.height);b.setOffset(c.dx,c.dy);this._symbolMap[this._currentMapScale]||(this._symbolMap[this._currentMapScale]={});return this._symbolMap[this._currentMapScale][a.attributes[this._objectIdField]]=
b},_generateFieldsCount:function(a,b,c){var d;for(d=a.length-1;0<=d;d--){var e=b[a[d].name]/c;a[d].numPoints=Math.round(e)}return a},_getShapeProperties:function(a){var b=a.geometry.getExtent();b.contains(this._map.extent)&&(b=this._map.extent);var c=Math.ceil(b.getWidth()/this._currentResolution);var d=Math.ceil(b.getHeight()/this._currentResolution);var e=this._map.toScreen(new r(b.xmin,b.ymin,b.spatialReference));b=this._map.toScreen(new r(b.xmax,b.ymax,b.spatialReference));a=a.getLayer().getNavigationTransform();
return{minXY:e,maxXY:b,dx:(e.x-a.dx)%c,dy:(b.y-a.dy)%d,width:c,height:d}},_generateImageSrc:function(a,b,c,d,e,f){var p=this.dotSize,q;this._canvas?(this._canvas.width=a,this._canvas.height=b):this._canvas=this._initCanvas(a,b);var g=this._canvas.getContext("2d");if(f=f||this.backgroundColor)g.fillStyle=f.toCss(!0),g.fillRect(0,0,a,b),g.fill();for(f=c.length-1;0<=f;f--)for(g.fillStyle=c[f].color.toCss(!0),q=c[f].numPoints-1;0<=q;q--){var k=this._getRandomPoint(a,b,d,e);"square"===this.dotShape?g.fillRect(k.x,
k.y,p,p):"circle"===this.dotShape&&(g.beginPath(),g.arc(k.x,k.y,p/2,0,2*Math.PI,!0));g.fill()}return this._canvas.toDataURL()},_initCanvas:function(a,b){a=u.create("canvas",{id:"canvas",width:a+"px",height:b+"px",style:"position: absolute; left: -10000px; top: 0px;"},null);document.body.appendChild(a);return a},_getRandomInt:function(a,b){return Math.floor(Math.random()*(b-a+1)+a)},_getRandomPoint:function(a,b,c,d){var e={},f=this.outline&&this.outline.width?this.outline.width:0;if(!0===this.exactCount&&
a*b>this._exactCountMinArea){a=!1;do e.x=this._getRandomInt(c.x,d.x),e.y=this._getRandomInt(d.y,c.y),a=new A(e.x,e.y),a=this._checkPointShapeBounds(a,this.dotSize+f,this._currentGraphic.geometry),!0===a&&(e.x-=c.x,e.y-=d.y);while(!1===a)}else e.x=this._getRandomInt(0,a),e.y=this._getRandomInt(0,b);return e},_checkPointShapeBounds:function(a,b,c){var d=null;d=!1;var e=!0,f=0;do{switch(f){case 1:a.x+=b;break;case 2:a.y+=b;break;case 3:a.x-=b}d=this._map.toMap(a);d=c.contains(d);!1===d&&(e=!1);f+=1}while(3>=
f&&!0===e);return d},setDotSize:function(a){0<a&&(this.dotSize=a)},setDotValue:function(a){0<a&&(this.dotValue=a)},setOutline:function(a){this.outline=a},setBackgroundColor:function(a){this.backgroundColor=a},toJson:function(){var a=l.mixin(this.inherited(arguments),{type:"dotDensity",backgroundColor:n.toJsonColor(this.backgroundColor),dotShape:this.dotShape,dotSize:0<this.dotSize?w.px2pt(this.dotSize):0,dotValue:this.dotValue,fields:t.map(this.fields,function(b){return m.fixJson({color:n.toJsonColor(b.color),
name:b.name})}),legendOptions:this.legendOptions&&m.fixJson({backgroundColor:n.toJsonColor(this.legendOptions.backgroundColor),dotCoverage:this.legendOptions.dotCoverage,outline:this.legendOptions.outline&&this.legendOptions.outline.toJson(),valueUnit:this.legendOptions.valueUnit}),outline:this.outline&&this.outline.toJson()});return m.fixJson(a)}});v("extend-esri")&&l.setObject("renderer.DotDensityRenderer",h,x);return h});