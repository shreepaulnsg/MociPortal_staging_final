// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/renderers/Renderer","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has dojox/gfx/_base ../kernel ../Color ../layers/support/attributeUtils ../support/expressionUtils ../arcadeProfiles/visualizationProfile".split(" "),function(u,m,k,B,r,C,q,D,w,E){var v=Math.PI;u=u(null,{declaredClass:"esri.renderer.Renderer",constructor:function(a){this._cache={};if(a&&!a.declaredClass){this.rotationInfo=a.rotationInfo;if(!this.rotationInfo){var b=a.rotationType,c=a.rotationExpression;if(b||
c)this.rotationInfo={type:b,expression:c}}this.setRotationInfo(this.rotationInfo);this.setSizeInfo(this._readSizeInfo(a.sizeInfo));this.setColorInfo(this._readColorInfo(a.colorInfo));this.setOpacityInfo(this._readOpacityInfo(a.transparencyInfo));this.setVisualVariables(this._readVariables(a.visualVariables));this.setAuthoringInfo(a.authoringInfo)}this.getSymbol=m.hitch(this,this.getSymbol)},getSymbol:function(a){},_readSizeInfo:function(a){if(a){var b=a.minSize,c=a.maxSize;b&&(a.minSize="number"===
typeof b?r.pt2px(b):this._readSizeInfo(b));c&&(a.maxSize="number"===typeof c?r.pt2px(c):this._readSizeInfo(c));a.stops&&k.forEach(a.stops,function(d){d.size&&"number"===typeof d.size&&(d.size=r.pt2px(d.size))})}return a},_readColorInfo:function(a){a&&(k.forEach(a.colors,function(b,c){m.isArray(b)&&(a.colors[c]=q.toDojoColor(b))}),k.forEach(a.stops,function(b,c){b.color&&m.isArray(b.color)&&(a.stops[c].color=q.toDojoColor(b.color))}));return a},_readOpacityInfo:function(a){if(a){var b=m.mixin({},a);
b.transparencyValues&&(b.opacityValues=k.map(b.transparencyValues,function(c){return 1-c/100}),delete b.transparencyValues);b.stops&&(b.stops=k.map(b.stops,function(c){c=m.mixin({},c);c.opacity=1-c.transparency/100;delete c.transparency;return c}))}return b},_readVariables:function(a){a&&(a=k.map(a,function(b){"sizeInfo"===b.type?b=this._readSizeInfo(b):"colorInfo"===b.type?b=this._readColorInfo(b):"transparencyInfo"===b.type&&(b=this._readOpacityInfo(b),b.type="opacityInfo");return b},this));return a},
setAuthoringInfo:function(a){this.authoringInfo=a},setRotationInfo:function(a){if(a=this.rotationInfo="string"===typeof a?{field:a}:a){if(a.expression&&!m.isFunction(a.expression)&&!a.field){var b=a.expression.match(this.rotationRE);b&&b[1]&&(a.field=b[1])}a.rotationType=a.type}this._cache.rotationInfo=this._processRotationInfo(a);return this},rotationRE:/^\[([^\]]+)\]$/i,_processRotationInfo:function(a){a&&!a.rotationType&&(a.rotationType="geographic");return this._createCache(a)},getRotationAngle:function(a,
b){var c=this._getVarInfo(b&&b.rotationInfo,"rotationInfo");b=c.variable;c=this._cache[c.cacheKey];var d="arithmetic"===this._getRotationType(b),e=c&&c.hasExpr,f=null;if(b.field||e)f=this._getDataValue(a,b,null,c),null!=f&&(f=(f+(d?-90:0))*(d?-1:1));return f},_getRotationType:function(a){return a&&("rotationInfo"===a.type?a.rotationType:a.type)},_getDataValue:function(a,b,c,d,e){d||(d=this._getVarInfo(b,c),b=d.variable,d=this._cache[d.cacheKey],"sizeInfo"===c&&(d=d.root));return a._getDataValue(b,
d,w,e)},setVisualVariables:function(a){var b=this._cache;k.forEach(this.visualVariables,function(c,d){b.hasOwnProperty(d)&&(b[d]=null)},this);this.visualVariables=a;k.some(a,function(c){return!!c.target})&&a.sort(function(c,d){return c.target===d.target?0:c.target?1:-1});k.forEach(a,function(c,d){"colorInfo"===c.type?b[d]=this._processColorInfo(c):"opacityInfo"===c.type?b[d]=this._processOpacityInfo(c):"sizeInfo"===c.type?b[d]=this._processSizeInfo(c):"rotationInfo"===c.type&&(b[d]=this._processRotationInfo(c))},
this);return this},getVisualVariableValues:function(a){var b=this.visualVariables,c;b&&(c=k.map(b,function(d){switch(d.type){case "sizeInfo":var e=this.getSize(a,{sizeInfo:d});break;case "colorInfo":e=this.getColor(a,{colorInfo:d});break;case "opacityInfo":e=this.getOpacity(a,{opacityInfo:d});break;case "rotationInfo":e=this.getRotationAngle(a,{rotationInfo:d})}return{variable:d,value:e}},this));return c},getFieldsUsedInExpressions:function(a){var b=[];k.forEach(this._getCacheObjects(),function(c){c.syntaxTree&&
(b=b.concat(w.extractFieldNames(c.syntaxTree,a)))});b.sort();return k.filter(b,function(c,d){return 0===d||b[d-1]!==c})},hasGeometryOperations:function(){return k.some(this._getCacheObjects(),function(a){return a.syntaxTree?w.hasGeometryOperations(a.syntaxTree):!1})},initializeArcadeEngine:function(){var a=[];k.forEach(this._getCacheObjects(),function(b){b.syntaxTree&&a.push(b.syntaxTree)});return E.initialize(a)},hasVisualVariables:function(a,b){return a?!!this.getVisualVariablesForType(a,b):!!(this.getVisualVariablesForType("sizeInfo",
b)||this.getVisualVariablesForType("colorInfo",b)||this.getVisualVariablesForType("opacityInfo",b)||this.getVisualVariablesForType("rotationInfo",b))},getVisualVariablesForType:function(a,b){var c=this.visualVariables;if(!b&&this[a]){"rotationInfo"===a&&(this[a].rotationType=this[a].type);var d=[this[a]]}else c&&(d=k.filter(c,function(e){return e.type===a&&("string"===typeof b?e.target===b:!1===b?!e.target:!0)}))&&0===d.length&&(d=void 0);return d},setSizeInfo:function(a){this.sizeInfo=this.proportionalSymbolInfo=
a;this._cache.sizeInfo=this._processSizeInfo(a);return this},_processSizeInfo:function(a){return a&&{root:this._createCache(a),minSize:this._createCache(a.minSize),maxSize:this._createCache(a.maxSize)}},_convertExpressionToArcade:function(a){a&&a.expression&&(a.valueExpression="$view.scale")},_getVarInfo:function(a,b){if(a&&a.type===b){var c=k.indexOf(this.visualVariables,a);a=this.visualVariables[c]}else c=b,a=this[b];return{variable:a,cacheKey:c}},setProportionalSymbolInfo:function(a){this.setSizeInfo(a);
return this},getSize:function(a,b){var c=this._getVarInfo(b&&b.sizeInfo,"sizeInfo"),d=c.variable;c=this._cache[c.cacheKey];var e=null;if(d){var f=d.minSize;e=d.maxSize;f="object"===typeof f&&f?this._getSize(a,f,c&&c.minSize,b):f;e="object"===typeof e&&e?this._getSize(a,e,c&&c.maxSize,b):e;e=this._getSize(a,d,c&&c.root,b,[f,e])}return e},_getSize:function(a,b,c,d,e){var f=b.stops,g=0,h=c&&c.hasExpr,n=c&&c.ipData,z=c&&c.isScaleDriven,F="object"===typeof a&&!!a,l="number"===typeof a?a:null;if(b.field||
z||h){var G=d&&d.scale;h=e?e[0]:b.minSize;e=e?e[1]:b.maxSize;var p=b.minDataValue,x=b.maxDataValue,A=b.valueUnit||"unknown",y=b.valueRepresentation,H=b.scaleBy,t=d&&d.shape;z?l=G:"number"!==typeof l&&F&&(l=this._getDataValue(a,b,null,c));if(!this._isValidNumber(l))return null;if(f)h=this._lookupData(l,n),l=h[0],e=h[1],l===e?g=f[l].size:(l=f[l].size,f=f[e].size,g=l+(f-l)*h[2]);else if(null!=h&&null!=e&&null!=p&&null!=x)l<=p?g=h:l>=x?g=e:(f=(l-p)/(x-p),"area"===H&&t?(h=(l="circle"===t)?v*Math.pow(h/
2,2):h*h,f=h+f*((l?v*Math.pow(e/2,2):e*e)-h),g=l?2*Math.sqrt(f/v):Math.sqrt(f)):g=h+f*(e-h));else if("unknown"===A)null!=h&&null!=p&&(h&&p?(f=l/p,g="circle"===t?2*Math.sqrt(f*Math.pow(h/2,2)):"square"===t||"diamond"===t||"image"===t?Math.sqrt(f*Math.pow(h,2)):f*h):g=l+(h||p),g=g<h?h:g,null!=e&&g>e&&(g=e));else{f=(d&&d.resolution?d.resolution:1)*this._meterIn[A];if("area"===y)g=Math.sqrt(l/v)/f,g*=2;else if(g=l/f,"radius"===y||"distance"===y)g*=2;null!=h&&g<h&&(g=h);null!=e&&g>e&&(g=e)}}else g=f&&
f[0]&&f[0].size,null==g&&(g=b.minSize);return g=isNaN(g)?0:g},getSizeRangeAtScale:function(a,b){a=this._getVarInfo(a,"sizeInfo");var c=this._cache[a.cacheKey],d={scale:b};if((a=a.variable)&&b){var e=a.minSize;b=a.maxSize;var f=a.stops;f&&f.length?(a=f[0].size,c=f[f.length-1].size):(a="object"===typeof e&&e?this._getSize({},e,c&&c.minSize,d):e,c="object"===typeof b&&b?this._getSize({},b,c&&c.maxSize,d):b);if(null!=a||null!=c){if(a>c){var g=c;c=a;a=g}g={minSize:a,maxSize:c}}}return g},setColorInfo:function(a){this.colorInfo=
a;this._cache.colorInfo=this._processColorInfo(a);return this},_createCache:function(a,b){if(b=D.createAttributeCache(a,b))b.ipData=this._interpolateData(a);return b},_getCacheObjects:function(a){var b;a=a||this._cache;var c=[];for(b in a){var d=a[b];a.hasOwnProperty(b)&&d&&"object"===typeof d&&(d.hasOwnProperty("idSource")?c.push(d):c=c.concat(this._getCacheObjects(d)))}return c},_processColorInfo:function(a){a&&(k.forEach(a.colors,function(b,c){m.isArray(b)&&(a.colors[c]=new q(b))}),k.forEach(a.stops,
function(b,c){b.color&&m.isArray(b.color)&&(a.stops[c].color=new q(b.color))}));return this._createCache(a)},getColor:function(a,b){b=this._getVarInfo(b&&b.colorInfo,"colorInfo");return this._getColorComponent(a,b.variable,this._cache[b.cacheKey])},setOpacityInfo:function(a){this.opacityInfo=a;this._cache.opacityInfo=this._processOpacityInfo(a);return this},_processOpacityInfo:function(a){return this._createCache(a)},getOpacity:function(a,b){b=this._getVarInfo(b&&b.opacityInfo,"opacityInfo");return this._getColorComponent(a,
b.variable,this._cache[b.cacheKey],!0)},_getColorComponent:function(a,b,c,d,e){var f="number"===typeof a?a:null,g=c&&c.hasExpr,h=c&&c.ipData,n;b&&b.field||g?("number"!==typeof f&&"object"===typeof a&&a&&(f=this._getDataValue(a,b,null,c)),this._isValidNumber(f)||(f=null),null!=f&&(n=d?this._getOpacity(f,b,h):this._getColor(f,b,h))):b&&(a=b.stops,d?(n=a&&a[0]&&a[0].opacity,null==n&&(n=b.opacityValues&&b.opacityValues[0])):n=a&&a[0]&&a[0].color||b.colors&&b.colors[0]);e&&(e.data=f,e.value=n);return e||
n},_isValidNumber:function(a){return"number"===typeof a&&!isNaN(a)&&Infinity!==a&&-Infinity!==a},_interpolateData:function(a){if(a)if(a.colors||a.opacityValues){var b=(a.colors||a.opacityValues).length,c=a.minDataValue,d=(a.maxDataValue-c)/(b-1);var e=[];for(a=0;a<b;a++)e[a]=c+a*d}else a.stops&&(e=k.map(a.stops,function(f){return f.value}));return e},_getOpacity:function(a,b,c){a=this._lookupData(a,c);b=b||this.opacityInfo;if(a){c=a[0];var d=a[1];c===d?d=this._getOpacValue(b,c):(c=this._getOpacValue(b,
c),b=this._getOpacValue(b,d),d=c+(b-c)*a[2])}return d},_getOpacValue:function(a,b){return a.opacityValues?a.opacityValues[b]:a.stops[b].opacity},_getColor:function(a,b,c){a=this._lookupData(a,c);b=b||this.colorInfo;if(a){var d=a[0];c=a[1];d=d===c?this._getColorObj(b,d):q.blendColors(this._getColorObj(b,d),this._getColorObj(b,c),a[2])}return d},_getColorObj:function(a,b){return a.colors?a.colors[b]:a.stops[b].color},_lookupData:function(a,b){if(b){var c=0,d=b.length-1;k.some(b,function(f,g){if(a<f)return d=
g,!0;c=g;return!1});var e=[c,d,(a-b[c])/(b[d]-b[c])]}return e},_meterIn:{inches:1/.0254,feet:1/.3048,yards:1/.9144,miles:1/1609.344,"nautical-miles":1/1852,millimeters:1E3,centimeters:100,decimeters:10,meters:1,kilometers:.001,"decimal-degrees":180/20015077},_writeSizeInfo:function(a){if(a){a=m.mixin({},a);this._convertExpressionToArcade(a);var b=a.minSize,c=a.maxSize;b&&(a.minSize="number"===typeof b?r.px2pt(b):this._writeSizeInfo(b));c&&(a.maxSize="number"===typeof c?r.px2pt(c):this._writeSizeInfo(c));
if(b=a.legendOptions)if(a.legendOptions=m.mixin({},b),b=b.customValues)a.legendOptions.customValues=b.slice(0);a.stops&&(a.stops=k.map(a.stops,function(d){d=m.mixin({},d);d.size&&"number"===typeof d.size&&(d.size=r.px2pt(d.size));return d}))}return a},_writeColorInfo:function(a){a&&(a=m.mixin({},a),a.colors&&(a.colors=k.map(a.colors,function(b){return q.toJsonColor(b)})),a.stops&&(a.stops=k.map(a.stops,function(b){b=m.mixin({},b);b.color&&(b.color=q.toJsonColor(b.color));return b})),a.legendOptions&&
(a.legendOptions=m.mixin({},a.legendOptions)));return a},_writeOpacityInfo:function(a){if(a){var b=m.mixin({},a);b.opacityValues&&(b.transparencyValues=k.map(b.opacityValues,function(c){return 100*(1-c)}),delete b.opacityValues);b.stops&&(b.stops=k.map(b.stops,function(c){c=m.mixin({},c);c.transparency=100*(1-c.opacity);delete c.opacity;return c}));b.legendOptions&&(b.legendOptions=m.mixin({},b.legendOptions))}return b},toJson:function(a){var b=this.visualVariables,c=m.clone(this.authoringInfo),d=
a&&a.useLegacyRotationProperties,e=(a=(a=this.getVisualVariablesForType("rotationInfo",!1))&&a[0])&&a.field,f;a&&(a===this.rotationInfo||d)&&(f=a.expression||e&&(m.isFunction(e)?e:"["+e+"]"));b&&(b=k.map(b,function(g){"sizeInfo"===g.type?g=this._writeSizeInfo(g):"colorInfo"===g.type?g=this._writeColorInfo(g):"opacityInfo"===g.type?(g=this._writeOpacityInfo(g),g.type="transparencyInfo"):"rotationInfo"===g.type&&(g=d?null:m.mixin({},g));return g},this),b=k.filter(b,function(g){return null!=g}));c&&
k.forEach(c.visualVariables,function(g){"opacityInfo"===g.type&&(g.type="transparencyInfo")});return{rotationType:f&&(this._getRotationType(a)||"geographic"),rotationExpression:f,colorInfo:this._writeColorInfo(this.colorInfo),transparencyInfo:this._writeOpacityInfo(this.opacityInfo),sizeInfo:this._writeSizeInfo(this.sizeInfo),visualVariables:b,authoringInfo:c}}});B("extend-esri")&&m.setObject("renderer.Renderer",u,C);return u});