// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
var __extends=this&&this.__extends||function(){var y=function(m,v){y=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(w,x){w.__proto__=x}||function(w,x){for(var G in x)Object.prototype.hasOwnProperty.call(x,G)&&(w[G]=x[G])};return y(m,v)};return function(m,v){function w(){this.constructor=m}if("function"!==typeof v&&null!==v)throw new TypeError("Class extends value "+String(v)+" is not a constructor or null");y(m,v);m.prototype=null===v?Object.create(v):(w.prototype=v.prototype,new w)}}(),
__assign=this&&this.__assign||function(){__assign=Object.assign||function(y){for(var m,v=1,w=arguments.length;v<w;v++){m=arguments[v];for(var x in m)Object.prototype.hasOwnProperty.call(m,x)&&(y[x]=m[x])}return y};return __assign.apply(this,arguments)},__spreadArray=this&&this.__spreadArray||function(y,m){for(var v=0,w=m.length,x=y.length;v<w;v++,x++)y[x]=m[v];return y};
define("esri/arcade/featureSetUtils","require exports ../IdentityManager ../request ./featureSetCollection ./featureset/actions/AttributeFilter ./featureset/actions/GroupBy ./featureset/actions/OrderBy ./featureset/actions/SpatialFilter ./featureset/actions/Top ./featureset/sources/FeatureLayerDynamic ./featureset/sources/FeatureLayerDynamicMap ./featureset/sources/FeatureLayerMemoryMap ./featureset/sources/FeatureSetRelated ./featureset/support/cache ./featureset/support/FeatureSet ./featureset/support/shared ./polyfill/promiseUtils ./polyfill/sql/WhereClause ../arcgis/Portal ../layers/FeatureLayer".split(" "),function(y,
m,v,w,x,G,N,O,P,Q,R,S,T,U,r,V,K,z,W,X,D){function L(e){if(null!==r.applicationCache){var f=r.applicationCache.getLayerInfo(e);if(null!==f)return f}f=w({url:e,content:{f:"json"},callbackParamName:"callback",handleAs:"json"}).then(function(c){return c?(c.layers||(c.layers=[]),c.tables||(c.tables=[]),z.resolve(c)):z.resolve({layers:[],tables:[]})});null!==r.applicationCache&&(r.applicationCache.setLayerInfo(e,f),f=f.catch(function(c){r.applicationCache.clearLayerInfo(e);throw c;}));return f}function Y(e){if(null!==
r.applicationCache){var f=r.applicationCache.getLayerInfo(e);if(null!==f)return f}f=w({url:e,content:{f:"json"},callbackParamName:"callback",handleAs:"json"}).then(function(c){return c?z.resolve(c):z.resolve(null)});null!==r.applicationCache&&(r.applicationCache.setLayerInfo(e,f),f=f.catch(function(c){r.applicationCache.clearLayerInfo(e);throw c;}));return f}function Z(e,f){var c="QUERYDATAELEMTS:"+f.toString()+":"+e;if(null!==r.applicationCache){var b=r.applicationCache.getLayerInfo(c);if(null!==
b)return b}e=w({url:e+"/queryDataElements",usePost:!0,handleAs:"json",content:{layers:JSON.stringify([f.toString()]),f:"json"}}).then(function(a){if(a&&a.layerDataElements&&a.layerDataElements[0])return a.layerDataElements[0];throw Error("Not Found");});null!==r.applicationCache&&(r.applicationCache.setLayerInfo(c,e),e=e.catch(function(a){r.applicationCache.clearLayerInfo(c);throw a;}));return e}function E(e,f,c,b,a,d){void 0===c&&(c=null);void 0===b&&(b=!0);void 0===a&&(a=null);void 0===d&&(d=null);
null===c&&(c=["*"]);return new R({url:e,outFields:c,spatialReference:f,includeGeometry:b,lrucache:a,interceptor:d})}function H(e,f,c,b,a,d){void 0===c&&(c=null);void 0===b&&(b=!0);void 0===a&&(a=null);void 0===d&&(d=null);return z.resolve(E(e,f,c,b,a,d))}function F(e,f,c,b,a,d){void 0===f&&(f=null);void 0===c&&(c=null);void 0===b&&(b=!0);void 0===a&&(a=null);void 0===d&&(d=null);if(!e.getMap()){if(e.url)return E(e.url,f,c,b,a,d);throw Error("FeatureSets can only be used once the layer is added to a Map");
}if(e.mode===D.MODE_SNAPSHOT&&!e.url)return new T({layer:e,spatialReference:f,outFields:c,includeGeometry:b});if(e.mode===D.MODE_SNAPSHOT||e.mode===D.MODE_ONDEMAND||e.mode===D.MODE_AUTO)return new S({layer:e,spatialReference:f,outFields:c,includeGeometry:b,lrucache:a,interceptor:d});throw Error("FeatureSets only support for Snapshot or OnDemand FeatureSet");}function aa(e,f){var c=f.portalUrl+(f.portalUrl.match(/\/$/)?"":"/")+"content/items/"+e;return z.create(function(b,a){return w({url:c,content:{f:"json"},
callbackParamName:"callback",load:function(d){b({item:d})},error:function(d){a(d)}})})}Object.defineProperty(m,"__esModule",{value:!0});m.lookupUser=m.constructAssociationMetaDataFeatureSetFromUrl=m.constructFeatureSetFromRelationship=m.constructFeatureSetFromPortalItem=m.convertToFeatureSet=m.getPortal=m.createFeatureSetCollectionFromService=m.createFeatureSetCollectionFromMap=m.constructFeatureSet=m.constructFeatureSetFromUrl=m.constructFeatureSetFromUrlRaw=m.initialiseMetaDataCache=void 0;G.registerAction();
N.registerAction();O.registerAction();P.registerAction();Q.registerAction();m.initialiseMetaDataCache=function(){null===r.applicationCache&&(r.applicationCache=new r)};m.constructFeatureSetFromUrlRaw=E;m.constructFeatureSetFromUrl=H;m.constructFeatureSet=F;var ba=function(e){function f(c,b,a,d){void 0===b&&(b=null);void 0===a&&(a=null);void 0===d&&(d=null);var g=e.call(this)||this;g._map=c;g._overridespref=b;g.lrucache=a;g.interceptor=d;g._instantLayers=[];return g}__extends(f,e);f.prototype.makeAndAddFeatureSet=
function(c,b,a){void 0===b&&(b=!0);void 0===a&&(a=null);var d=F(c,this._overridespref,null===a?["*"]:a,b,this.lrucache,this.interceptor);this._instantLayers.push({featureset:d,opitem:c,includeGeometry:b,outFields:JSON.stringify(a)});return d};f.prototype.makeAndAddFeatureSetTable=function(c,b,a){void 0===b&&(b=!0);void 0===a&&(a=null);var d=E(c.url,this._overridespref,a,b,this.lrucache,this.interceptor);this._instantLayers.push({featureset:d,opitem:{name:c.title,id:c.id},includeGeometry:b,outFields:JSON.stringify(a)});
return d};f.prototype.featureSetByName=function(c,b,a){void 0===b&&(b=!0);void 0===a&&(a=null);null===a&&(a=["*"]);a=a.slice(0);a=a.sort();for(var d=JSON.stringify(a),g=0;g<this._instantLayers.length;g++){var h=this._instantLayers[g];if(h.opitem.name===c&&h.includeGeometry===b&&h.outFields===d)return this.resolvePromise(this._instantLayers[g].featureset)}d=null;g=0;for(h=this._map.graphicsLayerIds;g<h.length;g++){var l=this._map.getLayer(h[g]);if(l instanceof D&&l.name===c){d=l;break}}return d?this.resolvePromise(this.makeAndAddFeatureSet(d,
b,a)):this._map.tables&&(d=this._map.tables.find(function(k){return k.title&&k.title===c||k.title&&k.title===c?!0:!1}))?this.resolvePromise(this.makeAndAddFeatureSetTable(d,b,a)):this.resolvePromise(null)};f.prototype.featureSetById=function(c,b,a){void 0===b&&(b=!0);void 0===a&&(a=["*"]);null===a&&(a=["*"]);a=a.slice(0);a=a.sort();for(var d=JSON.stringify(a),g=0;g<this._instantLayers.length;g++){var h=this._instantLayers[g];if(h.opitem.id===c&&h.includeGeometry===b&&h.outFields===d)return this.resolvePromise(this._instantLayers[g].featureset)}d=
null;g=0;for(h=this._map.graphicsLayerIds;g<h.length;g++){var l=this._map.getLayer(h[g]);if(l instanceof D&&l.id===c){d=l;break}}return d?this.resolvePromise(this.makeAndAddFeatureSet(d,b,a)):this._map.tables&&(d=this._map.tables.find(function(k){return k.id&&k.id===c||k.id&&k.id===c?!0:!1}))?this.resolvePromise(this.makeAndAddFeatureSetTable(d,b,a)):this.resolvePromise(null)};return f}(x);m.createFeatureSetCollectionFromMap=function(e,f,c,b){void 0===c&&(c=null);void 0===b&&(b=null);return new ba(e,
f,c,b)};var ca=function(e){function f(c,b,a,d){void 0===b&&(b=null);void 0===a&&(a=null);void 0===d&&(d=null);var g=e.call(this)||this;g._url=c;g._overridespref=b;g.lrucache=a;g.interceptor=d;g.metadata=null;g._instantLayers=[];return g}__extends(f,e);Object.defineProperty(f.prototype,"url",{get:function(){return this._url},enumerable:!1,configurable:!0});f.prototype._loadMetaData=function(){var c=this;return L(this._url).then(function(b){return c.metadata=b})};f.prototype.makeAndAddFeatureSet=function(c,
b,a){void 0===b&&(b=!0);void 0===a&&(a=null);var d=F(c,this._overridespref,null===a?["*"]:a,b,this.lrucache,this.interceptor);this._instantLayers.push({featureset:d,opitem:c,includeGeometry:b,outFields:JSON.stringify(a)});return d};f.prototype.load=function(){return this._loadMetaData()};f.prototype.clone=function(){return new f(this._url,this._overridespref,this.lrucache,this.interceptor)};f.prototype.featureSetByName=function(c,b,a){var d=this;void 0===b&&(b=!0);void 0===a&&(a=null);null===a&&(a=
["*"]);a=a.slice(0);a=a.sort();for(var g=JSON.stringify(a),h=0;h<this._instantLayers.length;h++){var l=this._instantLayers[h];if(l.opitem.name===c&&l.includeGeometry===b&&l.outFields===g)return this.resolvePromise(this._instantLayers[h].featureset)}return this._loadMetaData().then(function(k){for(var n=null,p=0,t=k.layers?k.layers:[];p<t.length;p++){var q=t[p];q.name===c&&(n=q)}if(!n)for(p=0,k=k.tables?k.tables:[];p<k.length;p++)q=k[p],q.name===c&&(n=q);return n?d.resolvePromise(E(d._url+"/"+n.id,
d._overridespref,a,b,d.lrucache,d.interceptor)):d.resolvePromise(null)})};f.prototype.featureSetById=function(c,b,a){var d=this;void 0===b&&(b=!0);void 0===a&&(a=["*"]);null===a&&(a=["*"]);a=a.slice(0);a=a.sort();var g=JSON.stringify(a);c=null!==c&&void 0!==c?c.toString():"";for(var h=0;h<this._instantLayers.length;h++){var l=this._instantLayers[h];if(l.opitem.id===c&&l.includeGeometry===b&&l.outFields===g)return this.resolvePromise(this._instantLayers[h].featureset)}return this._loadMetaData().then(function(k){for(var n=
null,p=0,t=k.layers?k.layers:[];p<t.length;p++){var q=t[p];null!==q.id&&void 0!==q.id&&q.id.toString()===c&&(n=q)}if(!n)for(p=0,k=k.tables?k.tables:[];p<k.length;p++)q=k[p],null!==q.id&&void 0!==q.id&&q.id.toString()===c&&(n=q);return n?d.resolvePromise(E(d._url+"/"+n.id,d._overridespref,a,b,d.lrucache,d.interceptor)):d.resolvePromise(null)})};return f}(x);m.createFeatureSetCollectionFromService=function(e,f,c,b){void 0===c&&(c=null);void 0===b&&(b=null);return new ca(e,f,c,b)};m.getPortal=function(e,
f){return null===e?f:new X.Portal(e.field("url"))};m.convertToFeatureSet=function(e,f,c,b,a){if(null===e)return null;if(e instanceof D){switch(f){case "datasource":return F(e,a,e.getOutFields(),!0,c,b).getDataSourceFeatureSet();case "parent":return F(e,a,e.getOutFields(),!0,c,b);case "root":return F(e,a,e.getOutFields(),!0,c,b)}return null}if(e instanceof V)switch(f){case "datasource":return e.getDataSourceFeatureSet();case "parent":return e;case "root":return e.getRootFeatureSet()}return null};m.constructFeatureSetFromPortalItem=
function(e,f,c,b,a,d,g,h){void 0===h&&(h=null);return z.create(function(l,k){if(r.applicationCache){var n=r.applicationCache.getLayerInfo(e+":"+d.url);if(n){n.then(function(p){try{var t=H(K.extractServiceUrl(p.item.url)+"/"+f,c,b,a,g,h);l(t)}catch(q){k(q)}},function(p){k(p)});return}}n=aa(e,d);r.applicationCache&&r.applicationCache.setLayerInfo(e+":"+d.url,n);n.then(function(p){try{var t=H(K.extractServiceUrl(p.item.url)+"/"+f,c,b,a,g,h);l(t)}catch(q){k(q)}},function(p){r.applicationCache&&r.applicationCache.clearLayerInfo(e+
":"+d.url);k(p)})})};m.constructFeatureSetFromRelationship=function(e,f,c,b,a,d,g,h){void 0===b&&(b=null);void 0===a&&(a=null);void 0===d&&(d=!0);void 0===g&&(g=null);void 0===h&&(h=null);var l=e.serviceUrl();if(!l)return null;l="/"===l.charAt(l.length-1)?l+f.relatedTableId.toString():l+"/"+f.relatedTableId.toString();return H(l,b,a,d,g,h).then(function(k){return new U({layer:e,relatedLayer:k,relationship:f,objectId:c,spatialReference:b,outFields:a,includeGeometry:d,lrucache:g,interceptor:h})})};
m.constructAssociationMetaDataFeatureSetFromUrl=function(e,f){var c=[],b=3,a=null,d={},g=null;return L(e).then(function(h){if(h.controllerDatasetLayers&&void 0!==h.controllerDatasetLayers.utilityNetworkLayerId&&null!==h.controllerDatasetLayers.utilityNetworkLayerId){if(h.layers)for(var l=0,k=h.layers;l<k.length;l++){var n=k[l];d[n.id]=n.name}if(h.tables)for(l=0,k=h.tables;l<k.length;l++)n=k[l],d[n.id]=n.name;var p=h.controllerDatasetLayers.utilityNetworkLayerId;return Z(e,p).then(function(t){if(t){(a=
t)&&a.dataElement&&void 0!==a.dataElement.schemaGeneration&&(b=a.dataElement.schemaGeneration);g={};a.dataElement.domainNetworks||(a.dataElement.domainNetworks=[]);t=0;for(var q=a.dataElement.domainNetworks;t<q.length;t++){for(var A=q[t],B=0,M=A.edgeSources?A.edgeSources:[];B<M.length;B++){var u=M[B];u={layerId:u.layerId,sourceId:u.sourceId,className:d[u.layerId]?d[u.layerId]:null};u.className&&(g[u.className]=u)}B=0;for(A=A.junctionSources?A.junctionSources:[];B<A.length;B++)u=A[B],u={layerId:u.layerId,
sourceId:u.sourceId,className:d[u.layerId]?d[u.layerId]:null},u.className&&(g[u.className]=u)}if(a.dataElement.terminalConfigurations)for(t=0,q=a.dataElement.terminalConfigurations;t<q.length;t++)for(A=0,u=q[t].terminals;A<u.length;A++)B=u[A],c.push({terminalId:B.terminalId,terminalName:B.terminalName});return Y(e+"/"+p).then(function(I){if(I.systemLayers&&void 0!==I.systemLayers.associationsTableId&&null!==I.systemLayers.associationsTableId){var J=[];4<=b&&(J.push("STATUS"),J.push("PERCENTALONG"));
return H(e+"/"+I.systemLayers.associationsTableId.toString(),f,__spreadArray("OBJECTID FROMNETWORKSOURCEID TONETWORKSOURCEID FROMGLOBALID TOGLOBALID TOTERMINALID FROMTERMINALID ASSOCIATIONTYPE ISCONTENTVISIBLE GLOBALID".split(" "),J),!1,null).then(function(C){return C.load()}).then(function(C){return 4<=b?(C=C.filter(W.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",
C.getFieldsIndex())),C.load()):C}).then(function(C){return{lkp:g,associations:C,unVersion:b,terminals:c}})}return{associations:null,unVersion:b,lkp:null,terminals:[]}})}return{associations:null,unVersion:b,lkp:null,terminals:[]}})}return{associations:null,unVersion:b,lkp:null,terminals:[]}})};m.lookupUser=function(e,f,c){if(!v.findCredential(e.portalUrl))return z.resolve(null);if(e.getPortalUser()&&""===f){var b=e.getPortalUser();if(b&&!1===c){for(var a={},d=0,g="username id fullName availableCredits assignedCredits firstName lastName preferredView description email idpUsername favGroupId lastLogin mfaEnabled access storageUsage storageQuota orgId role privileges".split(" ");d<
g.length;d++){var h=g[d];void 0!==b[h]&&(a[h]=b[h])}return z.resolve(a)}}return""===f?z.create(function(l,k){return w({url:e.portalUrl+"community/self",content:__assign({f:"json"},!1===c?{}:{returnUserLicenseTypeExtensions:!0}),callbackParamName:"callback",load:function(n){n&&n.username?l(n):l(null)},error:function(n){k(n)}})}):z.create(function(l,k){return w({url:e.portalUrl+"community/users/"+f,content:{f:"json"},callbackParamName:"callback",load:function(n){n.error?l(null):l(n)},error:function(n){k(n)}})})}});