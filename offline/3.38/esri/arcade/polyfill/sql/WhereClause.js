// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/arcade/polyfill/sql/WhereClause",["require","exports","dojo/has","./StandardizedFunctions","./WhereGrammar"],function(x,l,y,k,H){function p(c,a){c+="";return c.length>=a?c:Array(a-c.length+1).join("0")+c}function q(c,a,b,d,e,f,g,h,m){void 0===b&&(b="0");void 0===d&&(d="0");void 0===e&&(e="0");void 0===f&&(f="0");void 0===g&&(g="");void 0===h&&(h="0");void 0===m&&(m="0");return"+"===g||"-"===g?(c=p(parseInt(c,10),4)+"-"+p(parseInt(a,10),2)+"-"+p(parseInt(b,10),2),a="",10>parseFloat(f)&&
(a="0"),d=p(parseInt(d,10),2)+":"+p(parseInt(e,10),2)+":"+(a+parseFloat(f).toString()),g=""+g+p(parseInt(h,10),2)+":"+p(parseInt(m,10),2),new Date(c+"T"+d+g)):new Date(parseInt(c,10),parseInt(a,10)-1,parseInt(b,10),parseInt(d,10),parseInt(e,10),parseFloat(f))}function z(c){var a=I.exec(c);if(null!==a){c=a[1];var b=a[2],d=a[3],e=a[4],f=a[5],g=a[6];return q(c,b,d,e,f,g)}a=J.exec(c);if(null!==a){c=a[1];b=a[2];d=a[3];e=a[4];f=a[5];g=a[6];var h=a[7],m=a[8];a=a[9];return q(c,b,d,e,f,g,h,m,a)}a=K.exec(c);
if(null!==a)return c=a[1],b=a[2],d=a[3],e=a[4],f=a[5],h=a[6],m=a[7],a=a[8],q(c,b,d,e,f,"0",h,m,a);a=L.exec(c);if(null!==a)return c=a[1],b=a[2],d=a[3],e=a[4],f=a[5],q(c,b,d,e,f);a=A.exec(c);if(null!==a)return c=a[1],b=a[2],d=a[3],q(c,b,d);throw Error("SQL Invalid Timestamp");}function B(c){c=A.exec(c);if(null===c)throw Error("SQL Invalid Date");var a=c[2],b=c[3];return new Date(parseInt(c[1],10),parseInt(a,10)-1,parseInt(b,10))}function t(c){return Array.isArray(c)?c:[c]}function r(c){return null!==
c?!0!==c:null}function C(c,a){return null!=c&&null!=a?!0===c&&!0===a:!1===c||!1===a?!1:null}function D(c,a){return null!=c&&null!=a?!0===c||!0===a:!0===c||!0===a?!0:null}function u(c,a){if(null==c)return null;for(var b=!1,d=0;d<a.length;d++){var e=a[d];if(null==e)b=null;else if(c===e){b=!0;break}}return b}function v(c,a,b){if(null==c)return null;var d="",e,f=e||(e={});f[f.Normal=0]="Normal";f[f.Escaped=1]="Escaped";for(f=e=0;f<a.length;f++){var g=a.charAt(f);switch(e){case 0:g===b?e=1:d=0<="-[]/{}()*+?.\\^$|".indexOf(g)?
d+("\\"+g):"%"===g?d+".*":"_"===g?d+".":d+g;break;case 1:d=0<="-[]/{}()*+?.\\^$|".indexOf(g)?d+("\\"+g):d+g,e=0}}return(new RegExp("^"+d+"$")).test(c)}function n(c){return c instanceof Date?c.valueOf():c}function E(c,a,b){if(null==a||null==b)return null;a=n(a);b=n(b);switch(c){case "\x3c\x3e":return a!==b;case "\x3d":return a===b;case "\x3e":return a>b;case "\x3c":return a<b;case "\x3e\x3d":return a>=b;case "\x3c\x3d":return a<=b}}function w(c){for(var a=[],b={},d=0;d<c.length;d++){var e=c[d],f=e.toLowerCase();
void 0===b[f]&&(a.push(e),b[f]=1)}return a}function F(c,a,b){if(a instanceof k.SqlInterval)if(b instanceof Date)switch(c){case "+":return new Date(a.valueInMilliseconds()+b.getTime());case "-":return a.valueInMilliseconds()-b.getTime();case "*":return a.valueInMilliseconds()*b.getTime();case "/":return a.valueInMilliseconds()/b.getTime()}else if(b instanceof k.SqlInterval)switch(c){case "+":return k.SqlInterval.createFromMilliseconds(a.valueInMilliseconds()+b.valueInMilliseconds());case "-":return k.SqlInterval.createFromMilliseconds(a.valueInMilliseconds()-
b.valueInMilliseconds());case "*":return a.valueInMilliseconds()*b.valueInMilliseconds();case "/":return a.valueInMilliseconds()/b.valueInMilliseconds()}else a=a.valueInMilliseconds();else if(b instanceof k.SqlInterval)if(a instanceof Date)switch(c){case "+":return new Date(b.valueInMilliseconds()+a.getTime());case "-":return new Date(a.getTime()-b.valueInMilliseconds());case "*":return a.getTime()*b.valueInMilliseconds();case "/":return a.getTime()/b.valueInMilliseconds()}else b=b.valueInMilliseconds();
else if(a instanceof Date&&"number"===typeof b)switch(b*=864E5,a=a.getTime(),c){case "+":return new Date(a+b);case "-":return new Date(a-b);case "*":return new Date(a*b);case "/":return new Date(a/b)}else if(b instanceof Date&&"number"===typeof a)switch(a*=864E5,b=b.getTime(),c){case "+":return new Date(a+b);case "-":return new Date(a-b);case "*":return new Date(a*b);case "/":return new Date(a/b)}switch(c){case "+":return a+b;case "-":return a-b;case "*":return a*b;case "/":return a/b}}function G(c,
a,b,d){c=d.getAttribute(c,a);return null!=c&&1===b[a]?new Date(c):c}Object.defineProperty(l,"__esModule",{value:!0});l.defaultAttributeAdapter=l.WhereClause=void 0;var A=/^(\d{4})-(\d{1,2})-(\d{1,2})$/,I=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2}(\.[0-9]+)?)$/,J=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2}(\.[0-9]+)?)(\+|\-)(\d{1,2}):(\d{1,2})$/,K=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2})(\+|\-)(\d{1,2}):(\d{1,2})$/,L=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2})$/,
M=function(){function c(){}c.makeBool=function(a){return!0===a};c.featureValue=function(a,b,d,e){return G(a,b,d,e)};c.equalsNull=function(a){return null===a};c.applyLike=function(a,b,d){return v(a,b,d)};c.ensureArray=function(a){return t(a)};c.applyIn=function(a,b){return u(a,b)};c.currentDate=function(){var a=new Date;a.setHours(0,0,0,0);return a};c.makeSqlInterval=function(a,b,d){return k.SqlInterval.createFromValueAndQualifer(a,b,d)};c.convertInterval=function(a){return a instanceof k.SqlInterval?
a.valueInMilliseconds():a};c.currentTimestamp=function(){return new Date};c.compare=function(a,b,d){return E(a,b,d)};c.calculate=function(a,b,d){return F(a,b,d)};c.makeComparable=function(a){return n(a)};c.evaluateFunction=function(a,b){return k.evaluateFunction(a,b)};c.lookup=function(a,b){a=b[a];return void 0===a?null:a};c.between=function(a,b){return null==a||null==b[0]||null==b[1]?null:a>=b[0]&&a<=b[1]};c.notbetween=function(a,b){return null==a||null==b[0]||null==b[1]?null:a<b[0]||a>b[1]};c.ternaryNot=
function(a){return r(a)};c.ternaryAnd=function(a,b){return C(a,b)};c.ternaryOr=function(a,b){return D(a,b)};return c}();x=function(){function c(a,b){this.fieldsIndex=b;this.datefields={};this.parameters={};this.parseTree=H.WhereGrammar.parse(a);a=this.extractExpressionInfo(b);b=a.isStandardized;this.referencedFieldNames=a.referencedFieldNames;this.isStandardized=b}c.create=function(a,b){return new c(a,b)};Object.defineProperty(c.prototype,"fieldNames",{get:function(){return this.referencedFieldNames},
enumerable:!1,configurable:!0});c.prototype.testSet=function(a,b){void 0===b&&(b=l.defaultAttributeAdapter);for(var d={},e=function(h){d[h]=a.map(function(m){return b.getAttribute(m,h)})},f=0,g=this.fieldNames;f<g.length;f++)e(g[f]);return!!this.evaluateNode(this.parseTree,{attributes:d},l.defaultAttributeAdapter)};c.prototype.calculateValue=function(a,b){void 0===b&&(b=l.defaultAttributeAdapter);a=this.evaluateNode(this.parseTree,a,b);return a instanceof k.SqlInterval?a.valueInMilliseconds()/864E5:
a};c.prototype.calculateValueCompiled=function(a,b){void 0===b&&(b=l.defaultAttributeAdapter);if(null!=this.parseTree._compiledVersion)return this.parseTree._compiledVersion(a,this.parameters,b,this.datefields);if(y("csp-restrictions"))return this.calculateValue(a,b);this.compileMe();return this.parseTree._compiledVersion(a,this.parameters,b,this.datefields)};c.prototype.testFeature=function(a,b){void 0===b&&(b=l.defaultAttributeAdapter);return!!this.evaluateNode(this.parseTree,a,b)};c.prototype.testFeatureCompiled=
function(a,b){void 0===b&&(b=l.defaultAttributeAdapter);if(null!=this.parseTree._compiledVersion)return!!this.parseTree._compiledVersion(a,this.parameters,b,this.datefields);if(y("csp-restrictions"))return this.testFeature(a,b);this.compileMe();return!!this.parseTree._compiledVersion(a,this.parameters,b,this.datefields)};c.prototype.getFunctions=function(){var a=[];this.visitAll(this.parseTree,function(b){"function"===b.type&&a.push(b.name.toLowerCase())});return w(a)};c.prototype.getVariables=function(){var a=
[];this.visitAll(this.parseTree,function(b){"param"===b.type&&a.push(b.value.toLowerCase())});return w(a)};c.prototype.compileMe=function(){var a="return this.convertInterval("+this.evaluateNodeToJavaScript(this.parseTree)+")";this.parseTree._compiledVersion=(new Function("feature","lookups","attributeAdapter","datefields",a)).bind(M)};c.prototype.extractExpressionInfo=function(a){var b=this,d=[],e=!0;this.visitAll(this.parseTree,function(f){switch(f.type){case "column_ref":var g=a.get(f.column),
h=g&&g.name;!g||"date"!==g.type&&"esriFieldTypeDate"!==g.type||(b.datefields[g.name]=1);void 0!==h?(d.push(h),f.column=h):d.push(f.column);break;case "function":g=f.name,f=f.args.value.length,e&&(e=k.isStandardized(g,f))}});return{referencedFieldNames:w(d),isStandardized:e}};c.prototype.visitAll=function(a,b){if(null!=a)switch(b(a),a.type){case "when_clause":this.visitAll(a.operand,b);this.visitAll(a.value,b);break;case "case_expression":for(var d=0,e=a.clauses;d<e.length;d++){var f=e[d];this.visitAll(f,
b)}"simple"===a.format&&this.visitAll(a.operand,b);null!==a.else&&this.visitAll(a.else,b);break;case "expr_list":d=0;for(a=a.value;d<a.length;d++)f=a[d],this.visitAll(f,b);break;case "unary_expr":this.visitAll(a.expr,b);break;case "binary_expr":this.visitAll(a.left,b);this.visitAll(a.right,b);break;case "function":this.visitAll(a.args,b)}};c.prototype.evaluateNodeToJavaScript=function(a){switch(a.type){case "interval":return"this.makeSqlInterval("+this.evaluateNodeToJavaScript(a.value)+", "+JSON.stringify(a.qualifier)+
","+JSON.stringify(a.op)+")";case "case_expression":var b="";if("simple"===a.format){var d="this.makeComparable("+this.evaluateNodeToJavaScript(a.operand)+")";b="( ";for(var e=0;e<a.clauses.length;e++)b+=" ("+d+" \x3d\x3d\x3d this.makeComparable("+this.evaluateNodeToJavaScript(a.clauses[e].operand)+")) ? ("+this.evaluateNodeToJavaScript(a.clauses[e].value)+") : "}else for(b="( ",e=0;e<a.clauses.length;e++)b+=" this.makeBool("+this.evaluateNodeToJavaScript(a.clauses[e].operand)+")\x3d\x3d\x3dtrue ? ("+
this.evaluateNodeToJavaScript(a.clauses[e].value)+") : ";b=null!==a.else?b+this.evaluateNodeToJavaScript(a.else):b+"null";return b+" )";case "param":return"this.lookup("+JSON.stringify(a.value.toLowerCase())+",lookups)";case "expr_list":b="[";d=0;for(a=a.value;d<a.length;d++)e=a[d],"["!==b&&(b+=","),b+=this.evaluateNodeToJavaScript(e);return b+"]";case "unary_expr":return"this.ternaryNot("+this.evaluateNodeToJavaScript(a.expr)+")";case "binary_expr":switch(a.operator){case "AND":return"this.ternaryAnd("+
this.evaluateNodeToJavaScript(a.left)+","+this.evaluateNodeToJavaScript(a.right)+" )";case "OR":return"this.ternaryOr("+this.evaluateNodeToJavaScript(a.left)+","+this.evaluateNodeToJavaScript(a.right)+" )";case "IS":if("null"!==a.right.type)throw Error("Unsupported RHS for IS");return"this.equalsNull("+this.evaluateNodeToJavaScript(a.left)+")";case "ISNOT":if("null"!==a.right.type)throw Error("Unsupported RHS for IS");return"(!(this.equalsNull("+this.evaluateNodeToJavaScript(a.left)+")))";case "IN":return"this.applyIn("+
this.evaluateNodeToJavaScript(a.left)+",this.ensureArray("+this.evaluateNodeToJavaScript(a.right)+"))";case "NOT IN":return"this.ternaryNot(this.applyIn("+this.evaluateNodeToJavaScript(a.left)+",this.ensureArray("+this.evaluateNodeToJavaScript(a.right)+")))";case "BETWEEN":return"this.between("+this.evaluateNodeToJavaScript(a.left)+","+this.evaluateNodeToJavaScript(a.right)+")";case "NOTBETWEEN":return"this.notbetween("+this.evaluateNodeToJavaScript(a.left)+","+this.evaluateNodeToJavaScript(a.right)+
")";case "LIKE":return"this.applyLike("+this.evaluateNodeToJavaScript(a.left)+","+this.evaluateNodeToJavaScript(a.right)+","+JSON.stringify(a.escape)+")";case "NOT LIKE":return"this.ternaryNot(this.applyLike("+this.evaluateNodeToJavaScript(a.left)+","+this.evaluateNodeToJavaScript(a.right)+","+JSON.stringify(a.escape)+"))";case "\x3c\x3e":case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "\x3d":return"this.compare("+JSON.stringify(a.operator)+","+this.evaluateNodeToJavaScript(a.left)+","+
this.evaluateNodeToJavaScript(a.right)+")";case "*":case "-":case "+":case "/":return"this.calculate("+JSON.stringify(a.operator)+","+this.evaluateNodeToJavaScript(a.left)+","+this.evaluateNodeToJavaScript(a.right)+")"}throw Error("Not Supported Operator "+a.operator);case "null":case "bool":case "string":case "number":return JSON.stringify(a.value);case "date":return"(new Date("+B(a.value).getTime().toString()+"))";case "timestamp":return"(new Date("+z(a.value).getTime().toString()+"))";case "current_time":return"date"===
a.mode?"this.currentDate()":"this.currentTimestamp()";case "column_ref":return"this.featureValue(feature,"+JSON.stringify(a.column)+",datefields,attributeAdapter)";case "function":return"this.evaluateFunction("+JSON.stringify(a.name)+","+this.evaluateNodeToJavaScript(a.args)+")"}throw Error("Unsupported sql syntax "+a.type);};c.prototype.evaluateNode=function(a,b,d){switch(a.type){case "interval":return b=this.evaluateNode(a.value,b,d),k.SqlInterval.createFromValueAndQualifer(b,a.qualifier,a.op);
case "case_expression":if("simple"===a.format)for(var e=n(this.evaluateNode(a.operand,b,d)),f=0;f<a.clauses.length;f++){if(e===n(this.evaluateNode(a.clauses[f].operand,b,d)))return this.evaluateNode(a.clauses[f].value,b,d)}else for(f=0;f<a.clauses.length;f++)if(!0===this.evaluateNode(a.clauses[f].operand,b,d))return this.evaluateNode(a.clauses[f].value,b,d);return null!==a.else?this.evaluateNode(a.else,b,d):null;case "param":return this.parameters[a.value.toLowerCase()];case "expr_list":e=[];f=0;
for(a=a.value;f<a.length;f++)e.push(this.evaluateNode(a[f],b,d));return e;case "unary_expr":return r(this.evaluateNode(a.expr,b,d));case "binary_expr":switch(a.operator){case "AND":return C(this.evaluateNode(a.left,b,d),this.evaluateNode(a.right,b,d));case "OR":return D(this.evaluateNode(a.left,b,d),this.evaluateNode(a.right,b,d));case "IS":if("null"!==a.right.type)throw Error("Unsupported RHS for IS");return null===this.evaluateNode(a.left,b,d);case "ISNOT":if("null"!==a.right.type)throw Error("Unsupported RHS for IS");
return null!==this.evaluateNode(a.left,b,d);case "IN":return e=t(this.evaluateNode(a.right,b,d)),u(this.evaluateNode(a.left,b,d),e);case "NOT IN":return e=t(this.evaluateNode(a.right,b,d)),r(u(this.evaluateNode(a.left,b,d),e));case "BETWEEN":return e=this.evaluateNode(a.left,b,d),a=this.evaluateNode(a.right,b,d),null==e||null==a[0]||null==a[1]?null:e>=n(a[0])&&e<=n(a[1]);case "NOTBETWEEN":return e=this.evaluateNode(a.left,b,d),a=this.evaluateNode(a.right,b,d),null==e||null==a[0]||null==a[1]?null:
e<n(a[0])||e>n(a[1]);case "LIKE":return v(this.evaluateNode(a.left,b,d),this.evaluateNode(a.right,b,d),a.escape);case "NOT LIKE":return r(v(this.evaluateNode(a.left,b,d),this.evaluateNode(a.right,b,d),a.escape));case "\x3c\x3e":case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "\x3d":return E(a.operator,this.evaluateNode(a.left,b,d),this.evaluateNode(a.right,b,d));case "-":case "+":case "*":case "/":return F(a.operator,this.evaluateNode(a.left,b,d),this.evaluateNode(a.right,b,d))}throw Error("Not Supported Operator "+
a.operator);case "null":case "bool":case "string":case "number":return a.value;case "date":return B(a.value);case "timestamp":return z(a.value);case "current_time":return b=new Date,"date"===a.mode&&b.setHours(0,0,0,0),b;case "column_ref":return G(b,a.column,this.datefields,d);case "function":return b=this.evaluateNode(a.args,b,d),k.evaluateFunction(a.name,b)}throw Error("Unsupported sql syntax "+a.type);};return c}();l.WhereClause=x;l.defaultAttributeAdapter={getAttribute:function(c,a){return(c&&
"object"===typeof c.attributes?c.attributes:c)[a]}}});