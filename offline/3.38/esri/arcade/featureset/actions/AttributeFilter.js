// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
var __extends=this&&this.__extends||function(){var u=function(q,l){u=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(m,k){m.__proto__=k}||function(m,k){for(var p in k)Object.prototype.hasOwnProperty.call(k,p)&&(m[p]=k[p])};return u(q,l)};return function(q,l){function m(){this.constructor=q}if("function"!==typeof l&&null!==l)throw new TypeError("Class extends value "+String(l)+" is not a constructor or null");u(q,l);q.prototype=null===l?Object.create(l):(m.prototype=l.prototype,new m)}}();
define("esri/arcade/featureset/actions/AttributeFilter","require exports ../support/FeatureSet ../support/IdSet ../support/shared ../support/sqlUtils ../../polyfill/promiseUtils ../../polyfill/sql/WhereClause ../../../SpatialReference".split(" "),function(u,q,l,m,k,p,n,x,z){return function(y){function g(b){var a=y.call(this,b)||this;a.declaredClass="esri.arcade.featureset.actions.AttributeFilter";a._maxProcessing=1E3;a._parent=b.parentfeatureset;b.whereclause instanceof x.WhereClause?(a._whereclause=
b.whereclause,a._whereClauseFunction=null):(a._whereClauseFunction=b.whereclause,a._whereclause=null);return a}__extends(g,y);g.prototype._initialiseFeatureSet=function(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,
this.types=this._parent.types):(this.fields=[],this.globalIdField=this.objectIdField=this.typeIdField="",this.spatialReference=new z({wkid:4326}),this.geometryType=k.layerGeometryEsriConstants.point)};g.prototype._getSet=function(b){var a=this;return null===this._wset?this._ensureLoaded().then(function(){return a._parent._getFilteredSet("",null,a._whereclause,null,b)}).then(function(c){a._checkCancelled(b);a._wset=null!==a._whereClauseFunction?new m(c._candidates.slice(0).concat(c._known.slice(0)),
[],c._ordered,a._clonePageDefinition(c.pagesDefinition)):new m(c._candidates.slice(0),c._known.slice(0),c._ordered,a._clonePageDefinition(c.pagesDefinition));return a._wset}):n.resolve(this._wset)};g.prototype._isInFeatureSet=function(b){var a=this._parent._isInFeatureSet(b);if(a===k.IdState.NotInFeatureSet)return a;a=this._idstates[b];return void 0===a?k.IdState.Unknown:a};g.prototype._getFeature=function(b,a,c){return this._parent._getFeature(b,a,c)};g.prototype._getFeatures=function(b,a,c,e){return this._parent._getFeatures(b,
a,c,e)};g.prototype._featureFromCache=function(b){return this._parent._featureFromCache(b)};g.prototype.executeWhereClause=function(b){return this._whereclause.testFeature(b)};g.prototype.executeWhereClauseDeferred=function(b){if(null!==this._whereClauseFunction)try{var a=this._whereClauseFunction(b);return n.isPromiseLike(a)?a:n.resolve(a)}catch(c){return n.reject(c)}return n.resolve(this.executeWhereClause(b))};g.prototype._fetchAndRefineFeatures=function(b,a,c){var e=this,f=new m([],b,!1,null),
h=Math.min(a,b.length);return this._parent._getFeatures(f,-1,h,c).then(function(){e._checkCancelled(c);if(null==e._whereClauseFunction){for(var d=0;d<h;d++){var r=e._parent._featureFromCache(b[d]);!0===e.executeWhereClause(r)?e._idstates[b[d]]=k.IdState.InFeatureSet:e._idstates[b[d]]=k.IdState.NotInFeatureSet}return"success"}var t=[];for(d=0;d<h;d++)r=e._parent._featureFromCache(b[d]),t.push(e.executeWhereClauseDeferred(r));return n.all(t).then(function(v){for(var w=0;w<a;w++)e._idstates[b[w]]=!0===
v[w]?k.IdState.InFeatureSet:k.IdState.NotInFeatureSet;return"success"})})};g.prototype._getFilteredSet=function(b,a,c,e,f){var h=this;null===this._whereClauseFunction&&(null!==c?null!==this._whereclause&&(c=p.combine(this._whereclause,c)):c=this._whereclause);return this._ensureLoaded().then(function(){return h._parent._getFilteredSet(b,a,c,e,f)}).then(function(d){h._checkCancelled(f);return null!==h._whereClauseFunction?new m(d._candidates.slice(0).concat(d._known.slice(0)),[],d._ordered,h._clonePageDefinition(d.pagesDefinition)):
new m(d._candidates.slice(0),d._known.slice(0),d._ordered,h._clonePageDefinition(d.pagesDefinition))})};g.prototype._stat=function(b,a,c,e,f,h,d){var r=this;if(null!==this._whereClauseFunction)return null===f&&""===c&&null===e?this._manualStat(b,a,h,d):n.resolve({calculated:!1});var t=this._whereclause;null!==f&&null!==this._whereclause&&(t=p.combine(this._whereclause,f));return this._parent._stat(b,a,c,e,t,h,d).then(function(v){return!1===v.calculated?null===f&&""===c&&null===e?r._manualStat(b,a,
h,d):{calculated:!1}:v})};g.prototype._canDoAggregates=function(b,a,c,e,f){if(null!==this._whereClauseFunction)return n.resolve(!1);null!==f?null!==this._whereclause&&(f=p.combine(this._whereclause,f)):f=this._whereclause;return null===this._parent?n.resolve(!1):this._parent._canDoAggregates(b,a,c,e,f)};g.prototype._getAggregatePagesDataSourceDefinition=function(b,a,c,e,f,h,d){if(null===this._parent)return n.reject(Error("Should never be called"));null!==f?null!==this._whereclause&&(f=p.combine(this._whereclause,
f)):f=this._whereclause;return this._parent._getAggregatePagesDataSourceDefinition(b,a,c,e,f,h,d)};g.registerAction=function(){l._featuresetFunctions.filter=function(b){if("function"===typeof b)return new g({parentfeatureset:this,whereclause:b});var a=null;b instanceof x.WhereClause&&(a=b);return new g({parentfeatureset:this,whereclause:a})}};return g}(l)});