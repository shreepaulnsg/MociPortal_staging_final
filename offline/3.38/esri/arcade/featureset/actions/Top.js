// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
var __extends=this&&this.__extends||function(){var r=function(p,l){r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(m,f){m.__proto__=f}||function(m,f){for(var n in f)Object.prototype.hasOwnProperty.call(f,n)&&(m[n]=f[n])};return r(p,l)};return function(p,l){function m(){this.constructor=p}if("function"!==typeof l&&null!==l)throw new TypeError("Class extends value "+String(l)+" is not a constructor or null");r(p,l);p.prototype=null===l?Object.create(l):(m.prototype=l.prototype,new m)}}();
define("esri/arcade/featureset/actions/Top","require exports ../support/FeatureSet ../support/IdSet ../support/shared ../../polyfill/promiseUtils".split(" "),function(r,p,l,m,f,n){return function(u){function k(a){var b=u.call(this,a)||this;b._topnum=0;b.declaredClass="esri.arcade.featureset.actions.Top";b._countedin=0;b._maxProcessing=100;b._topnum=a.topnum;b._parent=a.parentfeatureset;return b}__extends(k,u);k.prototype._getSet=function(a){var b=this;return null===this._wset?this._ensureLoaded().then(function(){return b._parent._getSet(a)}).then(function(e){b._wset=
new m(e._candidates.slice(0),e._known.slice(0),!1,b._clonePageDefinition(e.pagesDefinition));b._setKnownLength(b._wset)>b._topnum&&(b._wset._known=b._wset._known.slice(0,b._topnum));b._setKnownLength(b._wset)>=b._topnum&&(b._wset._candidates=[]);return b._wset}):n.resolve(this._wset)};k.prototype._setKnownLength=function(a){return 0<a._known.length&&"GETPAGES"===a._known[a._known.length-1]?a._known.length-1:a._known.length};k.prototype._isInFeatureSet=function(a){var b=this._parent._isInFeatureSet(a);
if(b===f.IdState.NotInFeatureSet)return b;var e=this._idstates[a];return e===f.IdState.InFeatureSet||e===f.IdState.NotInFeatureSet?e:b===f.IdState.InFeatureSet&&void 0===e?this._countedin<this._topnum?(this._idstates[a]=f.IdState.InFeatureSet,this._countedin++,f.IdState.InFeatureSet):this._idstates[a]=f.IdState.NotInFeatureSet:f.IdState.Unknown};k.prototype._expandPagedSet=function(a,b,e,d,g){var c=this;if(null===this._parent)return n.reject(Error("Parent Paging not implemented"));b>this._topnum&&
(b=this._topnum);return this._countedin>=this._topnum&&a.pagesDefinition.internal.set.length<=a.pagesDefinition.resultOffset?(b=a._known.length,0<b&&"GETPAGES"===a._known[b-1]&&(a._known.length=b-1),b=a._candidates.length,0<b&&"GETPAGES"===a._candidates[b-1]&&(a._candidates.length=b-1),n.resolve("success")):this._parent._expandPagedSet(a,b,e,d,g).then(function(h){c._setKnownLength(a)>c._topnum&&(a._known.length=c._topnum);c._setKnownLength(a)>=c._topnum&&(a._candidates.length=0);return h})};k.prototype._getFeatures=
function(a,b,e,d){var g=this,c=[],h=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(a,h))return this._expandPagedSet(a,h,0,0,d).then(function(){return g._getFeatures(a,b,e,d)});-1!==b&&void 0===this._featureCache[b]&&c.push(b);for(var v=0,q=a._lastFetchedIndex;q<a._known.length&&!(v++,v<=e&&(a._lastFetchedIndex+=1),void 0===this._featureCache[a._known[q]]&&(a._known[q]!==b&&c.push(a._known[q]),c.length>h));q++);if(0===c.length)return n.resolve("success");h=new m([],c,!1,null);var w=
Math.min(c.length,e);return this._parent._getFeatures(h,-1,w,d).then(function(){for(var t=0;t<w;t++){var x=g._parent._featureFromCache(c[t]);void 0!==x&&(g._featureCache[c[t]]=x)}return"success"})};k.prototype._getFilteredSet=function(a,b,e,d,g){var c=this;return this._ensureLoaded().then(function(){return c._getSet(g)}).then(function(h){return new m(h._candidates.slice(0).concat(h._known.slice(0)),[],!1,c._clonePageDefinition(h.pagesDefinition))})};k.prototype._refineKnowns=function(a,b){for(var e=
0,d=null,g=[],c=0;c<a._candidates.length;c++){var h=this._isInFeatureSet(a._candidates[c]);if(h===f.IdState.InFeatureSet){if(a._known.push(a._candidates[c]),e+=1,null===d?d={start:c,end:c}:d.end===c-1?d.end=c:(g.push(d),d={start:c,end:c}),a._known.length>=this._topnum)break}else if(h===f.IdState.NotInFeatureSet)null===d?d={start:c,end:c}:d.end===c-1?d.end=c:(g.push(d),d={start:c,end:c}),e+=1;else if(h===f.IdState.Unknown)break;if(e>=b)break}null!==d&&g.push(d);for(b=g.length-1;0<=b;b--)a._candidates.splice(g[b].start,
g[b].end-g[b].start+1);this._setKnownLength(a)>this._topnum&&(a._known=a._known.slice(0,this._topnum));this._setKnownLength(a)>=this._topnum&&(a._candidates=[])};k.prototype._stat=function(){return n.resolve({calculated:!1})};k.prototype._canDoAggregates=function(){return n.resolve(!1)};k.registerAction=function(){l._featuresetFunctions.top=function(a){return new k({parentfeatureset:this,topnum:a})}};return k}(l)});