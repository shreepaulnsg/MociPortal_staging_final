// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
var __extends=this&&this.__extends||function(){var u=function(n,w){u=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(z,y){z.__proto__=y}||function(z,y){for(var A in y)Object.prototype.hasOwnProperty.call(y,A)&&(z[A]=y[A])};return u(n,w)};return function(n,w){function z(){this.constructor=n}if("function"!==typeof w&&null!==w)throw new TypeError("Class extends value "+String(w)+" is not a constructor or null");u(n,w);n.prototype=null===w?Object.create(w):(z.prototype=w.prototype,new z)}}();
define("esri/arcade/featureset/actions/Adapted","require exports ../../../graphic ../../kernel ../support/FeatureSet ../support/IdSet ../support/shared ../support/sqlUtils ../../polyfill/promiseUtils ../../polyfill/sql/WhereClause ../../../SpatialReference".split(" "),function(u,n,w,z,y,A,B,q,x,C,J){Object.defineProperty(n,"__esModule",{value:!0});n.AdaptedFeatureSet=n.SqlExpressionAdapted=n.StringToCodeAdapted=n.FieldRename=n.OriginalField=n.AdaptedField=void 0;u=function(){function p(f){this.field=
f;this.sqlRewritable=!1}p.prototype.postInitialization=function(f,a){};return p}();n.AdaptedField=u;var D=function(p){function f(a){a=p.call(this,a)||this;a.sqlRewritable=!0;return a}__extends(f,p);f.prototype.extractValue=function(a){return a.attributes[this.field.name]};f.prototype.rewriteSql=function(a){return{rewritten:this.sqlRewritable,where:a}};return f}(u);n.OriginalField=D;var F=function(p){function f(a,b,c){var e=p.call(this,B.cloneField(a))||this;e.originalField=a;e.sqlRewritable=!0;e.field.name=
b;e.field.alias=c;return e}__extends(f,p);f.prototype.rewriteSql=function(a,b){return{rewritten:this.sqlRewritable,where:q.reformulateWithoutField(a,this.field.name,this.originalField.name,b.getFieldsIndex())}};f.prototype.extractValue=function(a){return a.attributes[this.originalField.name]};return f}(u);n.FieldRename=F;var K=function(p){function f(a,b,c){a=p.call(this,a)||this;a.codefield=b;a.lkp=c;a.reverseLkp={};for(var e in c)a.reverseLkp[c[e]]=e;a.sqlRewritable=!0;return a}__extends(f,p);f.prototype.rewriteSql=
function(a,b){var c=this.evaluateNodeToWhereClause(a.parseTree,B.FeatureServiceDatabaseType.Standardised,this.field.name,this.codefield instanceof C.WhereClause?q.toWhereClause(this.codefield,B.FeatureServiceDatabaseType.Standardised):this.codefield,a.parameters);return 0<=c.indexOf(f.BADNESS)?{rewritten:!1,where:a}:{rewritten:this.sqlRewritable,where:C.WhereClause.create(c,b._parent.getFieldsIndex())}};f.prototype.evaluateNodeToWhereClause=function(a,b,c,e,d){void 0===c&&(c=null);void 0===e&&(e=
null);switch(a.type){case "interval":return q.convertIntervalToSql(this.evaluateNodeToWhereClause(a.value,b,c,e,d),a.qualifier,a.op);case "case_expression":var g=" CASE ";"simple"===a.format&&(g+=this.evaluateNodeToWhereClause(a.operand,b,c,f.BADNESS,d));for(e=0;e<a.clauses.length;e++)g+=" WHEN "+this.evaluateNodeToWhereClause(a.clauses[e].operand,b,c,f.BADNESS,d)+" THEN "+this.evaluateNodeToWhereClause(a.clauses[e].value,b,c,f.BADNESS,d);null!==a.else&&(g+=" ELSE "+this.evaluateNodeToWhereClause(a.else,
b,c,f.BADNESS,d));return g+" END ";case "param":c=d[a.value.toLowerCase()];if("string"===typeof c)return"'"+d[a.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(c instanceof Date)return q.makeDateString(c,b);if(c instanceof Array){a=[];for(e=0;e<c.length;e++)"string"===typeof c[e]?a.push("'"+c[e].toString().replace(/'/g,"''")+"'"):c[e]instanceof Date?a.push(q.makeDateString(c[e],b)):a.push(c[e].toString());return a}return c.toString();case "expr_list":g=[];var k=0;for(a=a.value;k<a.length;k++)g.push(this.evaluateNodeToWhereClause(a[k],
b,c,e,d));return g;case "unary_expr":return" ( NOT "+this.evaluateNodeToWhereClause(a.expr,b,c,f.BADNESS,d)+" ) ";case "binary_expr":switch(a.operator){case "AND":return" ("+this.evaluateNodeToWhereClause(a.left,b,c,e,d)+" AND "+this.evaluateNodeToWhereClause(a.right,b,c,e,d)+") ";case "OR":return" ("+this.evaluateNodeToWhereClause(a.left,b,c,e,d)+" OR "+this.evaluateNodeToWhereClause(a.right,b,c,e,d)+") ";case "IS":if("null"!==a.right.type)throw Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(a.left,
b,c,e,d)+" IS NULL )";case "ISNOT":if("null"!==a.right.type)throw Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(a.left,b,c,e,d)+" IS NOT NULL )";case "IN":g=[];if("expr_list"===a.right.type){if("column_ref"===a.left.type&&a.left.column.toUpperCase()===this.field.name.toUpperCase()){g=[];k=!0;for(var l=0,h=a.right.value;l<h.length;l++){var m=h[l];if("string"===m.type)if(void 0!==this.lkp[m.value])g.push(this.lkp[m.value].toString());else{k=!1;break}else{k=!1;break}}if(k)return" ("+
this.evaluateNodeToWhereClause(a.left,b,c,e,d)+" IN ("+g.join(",")+")) "}g=this.evaluateNodeToWhereClause(a.right,b,c,e,d);return" ("+this.evaluateNodeToWhereClause(a.left,b,c,e,d)+" IN ("+g.join(",")+")) "}g=this.evaluateNodeToWhereClause(a.right,b,c,e,d);return g instanceof Array?" ("+this.evaluateNodeToWhereClause(a.left,b,c,e,d)+" IN ("+g.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(a.left,b,c,e,d)+" IN ("+g+")) ";case "NOT IN":g=[];if("expr_list"===a.right.type){if("column_ref"===a.left.type&&
a.left.column.toUpperCase()===this.field.name.toUpperCase()){g=[];k=!0;l=0;for(h=a.right.value;l<h.length;l++)if(m=h[l],"string"===m.type)if(void 0!==this.lkp[m.value])g.push(this.lkp[m.value].toString());else{k=!1;break}else{k=!1;break}if(k)return" ("+this.evaluateNodeToWhereClause(a.left,b,c,e,d)+" NOT IN ("+g.join(",")+")) "}g=this.evaluateNodeToWhereClause(a.right,b,c,e,d);return" ("+this.evaluateNodeToWhereClause(a.left,b,c,e,d)+" NOT IN ("+g.join(",")+")) "}g=this.evaluateNodeToWhereClause(a.right,
b,c,e,d);return g instanceof Array?" ("+this.evaluateNodeToWhereClause(a.left,b,c,e,d)+" NOT IN ("+g.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(a.left,b,c,e,d)+" NOT IN ("+g+")) ";case "BETWEEN":return e=this.evaluateNodeToWhereClause(a.right,b,c,f.BADNESS,d)," ("+this.evaluateNodeToWhereClause(a.left,b,c,f.BADNESS,d)+" BETWEEN "+e[0]+" AND "+e[1]+" ) ";case "NOTBETWEEN":return e=this.evaluateNodeToWhereClause(a.right,b,c,f.BADNESS,d)," ("+this.evaluateNodeToWhereClause(a.left,b,c,f.BADNESS,
d)+" NOT BETWEEN "+e[0]+" AND "+e[1]+" ) ";case "LIKE":return""!==a.escape?" ("+this.evaluateNodeToWhereClause(a.left,b,c,f.BADNESS,d)+" LIKE "+this.evaluateNodeToWhereClause(a.right,b,c,f.BADNESS,d)+" ESCAPE '"+a.escape+"') ":" ("+this.evaluateNodeToWhereClause(a.left,b,c,f.BADNESS,d)+" LIKE "+this.evaluateNodeToWhereClause(a.right,b,c,f.BADNESS,d)+") ";case "NOT LIKE":return""!==a.escape?" ("+this.evaluateNodeToWhereClause(a.left,b,c,f.BADNESS,d)+" NOT LIKE "+this.evaluateNodeToWhereClause(a.right,
b,c,f.BADNESS,d)+" ESCAPE '"+a.escape+"') ":" ("+this.evaluateNodeToWhereClause(a.left,b,c,f.BADNESS,d)+" NOT LIKE "+this.evaluateNodeToWhereClause(a.right,b,c,f.BADNESS,d)+") ";case "\x3c\x3e":case "\x3d":if("column_ref"===a.left.type&&"string"===a.right.type){if(a.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[a.right.value.toString()])return" ("+e+" "+a.operator+" "+this.lkp[a.right.value.toString()].toString()+") "}else if("column_ref"===a.right.type&&"string"===
a.left.type&&a.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[a.right.value.toString()].toString()+" "+a.operator+" "+e+") ";return" ("+this.evaluateNodeToWhereClause(a.left,b,c,f.BADNESS,d)+" "+a.operator+" "+this.evaluateNodeToWhereClause(a.right,b,c,f.BADNESS,d)+") ";case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "*":case "-":case "+":case "/":return" ("+this.evaluateNodeToWhereClause(a.left,b,c,f.BADNESS,d)+" "+a.operator+" "+this.evaluateNodeToWhereClause(a.right,
b,c,f.BADNESS,d)+") "}throw Error("Not Supported Operator "+a.operator);case "null":return"null";case "bool":return!0===a.value?"1":"0";case "string":return"'"+a.value.toString().replace(/'/g,"''")+"'";case "timestamp":return q.makeDateString(a.value,b);case "date":return q.makeDateString(a.value,b);case "number":return a.value.toString();case "current_time":return q.makeToday("date"===a.mode,b);case "column_ref":return c&&c.toLowerCase()===a.column.toLowerCase()?"("+e+")":a.column;case "function":return d=
this.evaluateNodeToWhereClause(a.args,b,c,f.BADNESS,d),q.translateFunctionToDatabaseSpecific(a.name,d,b)}throw Error("Unsupported sql syntax "+a.type);};f.prototype.extractValue=function(a){return this.codefield instanceof C.WhereClause?this.reverseLkp[this.codefield.calculateValueCompiled(a)]:this.reverseLkp[a.attributes[this.codefield]]};f.BADNESS="_!!!_BAD_LKP_!!!!";return f}(u);n.StringToCodeAdapted=K;u=function(p){function f(a,b){a=p.call(this,a)||this;a.sql=b;return a}__extends(f,p);f.prototype.rewriteSql=
function(a,b){return{rewritten:!0,where:q.reformulateWithoutField(a,this.field.name,q.toWhereClause(this.sql,B.FeatureServiceDatabaseType.Standardised),b.getFieldsIndex())}};f.prototype.extractValue=function(a){return this.sql.calculateValueCompiled(a)};return f}(u);n.SqlExpressionAdapted=u;y=function(p){function f(a){var b=p.call(this,a)||this;b._calcFunc=null;b.declaredClass="esri.arcade.featureset.actions.Adapted";b.adaptedFields=null;b._extraFilter=null;b._extraFilter=a.extraFilter;b._parent=
a.parentfeatureset;b._maxProcessing=30;b.adaptedFields=a.adaptedFields;return b}__extends(f,p);f.findField=function(a,b){for(var c=0;c<a.length;c++){var e=a[c];if(e.name.toLowerCase()===b.toString().toLowerCase())return e}return null};f.prototype._initialiseFeatureSet=function(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,
this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new J({wkid:4326}),this.globalIdField=this.objectIdField="",this.geometryType=B.layerGeometryEsriConstants.point,this.typeIdField="",this.types=null);this.fields=[];for(var a=0,b=this.adaptedFields;a<b.length;a++){var c=b[a];c.postInitialization(this,this._parent);this.fields.push(c.field)}};f.prototype._getSet=function(a){var b=this;return null===this._wset?this._ensureLoaded().then(function(){return b._extraFilter?
b._getFilteredSet("",null,null,null,a):b._parent._getSet(a)}).then(function(c){b._checkCancelled(a);b._wset=new A(c._candidates.slice(0),c._known.slice(0),c._ordered,b._clonePageDefinition(c.pagesDefinition));return b._wset}):x.resolve(this._wset)};f.prototype._isInFeatureSet=function(a){return this._parent._isInFeatureSet(a)};f.prototype._getFeatures=function(a,b,c,e){var d=this,g=[];-1!==b&&void 0===this._featureCache[b]&&g.push(b);var k=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(a,
k))return this._expandPagedSet(a,k,0,0,e).then(function(){return d._getFeatures(a,b,c,e)});for(var l=0,h=a._lastFetchedIndex;h<a._known.length&&!(l++,l<=c&&(a._lastFetchedIndex+=1),void 0===this._featureCache[a._known[h]]&&(a._known[h]!==b&&g.push(a._known[h]),g.length>=k));h++);if(0===g.length)return x.resolve("success");a=new A([],g,a._ordered,null);var m=Math.min(g.length,c);return this._parent._getFeatures(a,-1,m,e).then(function(){d._checkCancelled(e);for(var v=[],t=0;t<m;t++){var r=d._parent._featureFromCache(g[t]);
void 0!==r&&v.push({geometry:r.geometry,attributes:r.attributes,id:g[t]})}for(t=0;t<v.length;t++){r=v[t];for(var G=[],E=0,H=d.adaptedFields;E<H.length;E++){var I=H[E];G[I.field.name]=I.extractValue(r)}d._featureCache[r.id]=new w({attributes:G,geometry:z.cloneGeometry(r.geometry)})}return"success"})};f.prototype._fetchAndRefineFeatures=function(){return x.reject(Error("Fetch and Refine should not be called in this featureset"))};f.prototype._getFilteredSet=function(a,b,c,e,d){var g=this,k=!1,l=this.reformulateWithoutAdaptions(c);
k=l.cannot;c=l.where;var h=!1;if(null!==e){h=!0;l=[];for(var m=0,v=this.adaptedFields;m<v.length;m++){var t=v[m];if(!(t instanceof D)&&!0===e.scanForField(t.field.name))if(t instanceof F)l.push({field:t.field.name,newfield:t.originalField.name});else{e=null;h=!1;break}}e&&0<l.length&&(e=e.replaceFields(l))}null!==c?null!==this._extraFilter&&(c=q.combine(this._extraFilter,c)):c=this._extraFilter;return this._ensureLoaded().then(function(){return g._parent._getFilteredSet(a,b,c,e,d)}).then(function(r){g._checkCancelled(d);
return!0===k?new A(r._candidates.slice(0).concat(r._known.slice(0)),[],!0===h?r._ordered:!1,g._clonePageDefinition(r.pagesDefinition)):new A(r._candidates.slice(0),r._known.slice(0),!0===h?r._ordered:!1,g._clonePageDefinition(r.pagesDefinition))})};f.prototype.reformulateWithoutAdaptions=function(a){var b={cannot:!1,where:a};if(null!==a)for(var c=0,e=this.adaptedFields;c<e.length;c++){var d=e[c];if(!0===q.scanForField(a,d.field.name))if(d=d.rewriteSql(a,this),!0===d.rewritten)b.where=d.where;else{b.cannot=
!0;b.where=null;break}}return b};f.prototype._stat=function(a,b,c,e,d,g,k){var l=this,h=!1,m=this.reformulateWithoutAdaptions(b);h=m.cannot;b=m.where;m=this.reformulateWithoutAdaptions(d);h=h||m.cannot;d=m.where;null!==d?null!==this._extraFilter&&(d=q.combine(this._extraFilter,d)):d=this._extraFilter;return!0===h?null===d&&""===c&&null===e?this._manualStat(a,b,g,k):x.resolve({calculated:!1}):this._parent._stat(a,b,c,e,d,g,k).then(function(v){return!1===v.calculated?null===d&&""===c&&null===e?l._manualStat(a,
b,g,k):{calculated:!1}:v})};f.prototype._canDoAggregates=function(a,b,c,e,d){if(null===this._parent)return x.resolve(!1);for(var g=0;g<a.length;g++)for(var k=0,l=this.adaptedFields;k<l.length;k++){var h=l[k];if(a[g].toLowerCase()===h.field.name.toLowerCase()&&!(h instanceof D))return x.resolve(!1)}k=[];for(g=0;g<b.length;g++)if(h=b[g],null!==h.workingexpr){l=this.reformulateWithoutAdaptions(h.workingexpr);if(l.cannot)return x.resolve(!1);h=h.clone();h.workingexpr=l.where;k.push(h)}else k.push(h);
b=this.reformulateWithoutAdaptions(d);if(b.cannot)return x.resolve(!1);d=b.where;null!==d?null!==this._extraFilter&&(d=q.combine(this._extraFilter,d)):d=this._extraFilter;return this._parent._canDoAggregates(a,k,c,e,d)};f.prototype._getAggregatePagesDataSourceDefinition=function(a,b,c,e,d,g,k){if(null===this._parent)return x.reject(Error("Should never be called"));for(var l=[],h=0;h<b.length;h++){var m=b[h];if(null!==m.workingexpr){var v=this.reformulateWithoutAdaptions(m.workingexpr);if(v.cannot)return x.reject(Error("Should never be called"));
m=m.clone();m.workingexpr=v.where;l.push(m)}else l.push(m)}b=this.reformulateWithoutAdaptions(d);if(b.cannot)return x.reject(Error("Should never be called"));d=b.where;null!==d?null!==this._extraFilter&&(d=q.combine(this._extraFilter,d)):d=this._extraFilter;return this._parent._getAggregatePagesDataSourceDefinition(a,l,c,e,d,g,k)};return f}(y);n.AdaptedFeatureSet=y});