// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
var __extends=this&&this.__extends||function(){var u=function(r,e){u=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(h,m){h.__proto__=m}||function(h,m){for(var n in m)Object.prototype.hasOwnProperty.call(m,n)&&(h[n]=m[n])};return u(r,e)};return function(r,e){function h(){this.constructor=r}if("function"!==typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");u(r,e);r.prototype=null===e?Object.create(e):(h.prototype=e.prototype,new h)}}();
define("esri/arcade/featureset/actions/SpatialFilter","require exports ../sources/Empty ../support/FeatureSet ../support/IdSet ../support/shared ../../polyfill/promiseUtils ../../../geometry/geometryEngineAsync".split(" "),function(u,r,e,h,m,n,t,q){return function(w){function c(a){var b=w.call(this,a)||this;b._relation="";b._relationGeom=null;b._relationString="";b.declaredClass="esri.arcade.featureset.actions.SpatialFilter";b._relationString=a.relationString;b._parent=a.parentfeatureset;b._maxProcessing=
40;b._relation=a.relation;b._relationGeom=a.relationGeom;return b}__extends(c,w);c.prototype._getSet=function(a){var b=this;return null===this._wset?this._ensureLoaded().then(function(){return b._parent._getFilteredSet("esriSpatialRelRelation"!==b._relation?b._relation:b._relation+":"+b._relationString,b._relationGeom,null,null,a)}).then(function(d){b._checkCancelled(a);b._wset=new m(d._candidates.slice(0),d._known.slice(0),d._ordered,b._clonePageDefinition(d.pagesDefinition));return b._wset}):t.resolve(this._wset)};
c.prototype._isInFeatureSet=function(a){var b=this._parent._isInFeatureSet(a);if(b===n.IdState.NotInFeatureSet)return b;b=this._idstates[a];return void 0===b?n.IdState.Unknown:b};c.prototype._getFeature=function(a,b,d){return this._parent._getFeature(a,b,d)};c.prototype._getFeatures=function(a,b,d,k){return this._parent._getFeatures(a,b,d,k)};c.prototype._featureFromCache=function(a){return this._parent._featureFromCache(a)};c.prototype.executeSpatialRelationTest=function(a){if(null===a.geometry)return t.resolve(!1);
switch(this._relation){case "esriSpatialRelEnvelopeIntersects":var b=n.shapeExtent(this._relationGeom);a=n.shapeExtent(a.geometry);return q.intersects(b,a);case "esriSpatialRelIntersects":return q.intersects(this._relationGeom,a.geometry);case "esriSpatialRelContains":return q.contains(this._relationGeom,a.geometry);case "esriSpatialRelOverlaps":return q.overlaps(this._relationGeom,a.geometry);case "esriSpatialRelWithin":return q.within(this._relationGeom,a.geometry);case "esriSpatialRelTouches":return q.touches(this._relationGeom,
a.geometry);case "esriSpatialRelCrosses":return q.crosses(this._relationGeom,a.geometry);case "esriSpatialRelRelation":return q.relate(this._relationGeom,a.geometry,this._relationString)}};c.prototype._fetchAndRefineFeatures=function(a,b,d){var k=this,l=new m([],a,!1,null),g=Math.min(b,a.length);return this._parent._getFeatures(l,-1,g,d).then(function(){k._checkCancelled(d);for(var f=[],p=0;p<g;p++){var v=k._parent._featureFromCache(a[p]);f.push(k.executeSpatialRelationTest(v))}return t.all(f)}).then(function(f){for(var p=
0;p<b;p++)k._idstates[a[p]]=!0===f[p]?n.IdState.InFeatureSet:n.IdState.NotInFeatureSet;return"success"})};c.prototype._getFilteredSet=function(a,b,d,k,l){var g=this;return this._ensureLoaded().then(function(){return g._parent._getFilteredSet("esriSpatialRelRelation"!==g._relation?g._relation:g._relation+":"+g._relationString,g._relationGeom,d,k,l)}).then(function(f){g._checkCancelled(l);return null!==b?new m(f._candidates.slice(0).concat(f._known.slice(0)),[],f._ordered,g._clonePageDefinition(f.pagesDefinition)):
new m(f._candidates.slice(0),f._known.slice(0),f._ordered,g._clonePageDefinition(f.pagesDefinition))})};c.prototype._stat=function(a,b,d,k,l,g,f){var p=this;return""!==d?t.resolve({calculated:!1}):this._parent._stat(a,b,"esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,l,g,f).then(function(v){return!1===v.calculated?null===l&&""===d&&null===k?p._manualStat(a,b,g,f):{calculated:!1}:v})};c.prototype._canDoAggregates=function(a,b,d,k,
l){return""!==d||null!==k||null===this._parent?t.resolve(!1):this._parent._canDoAggregates(a,b,"esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,l)};c.prototype._getAggregatePagesDataSourceDefinition=function(a,b,d,k,l,g,f){return null===this._parent?t.reject(Error("Should never be called")):this._parent._getAggregatePagesDataSourceDefinition(a,b,"esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,
this._relationGeom,l,g,f)};c.registerAction=function(){h._featuresetFunctions.intersects=function(a){return null===a||void 0===a?new e({parentfeatureset:this}):new c({parentfeatureset:this,relation:"esriSpatialRelIntersects",relationGeom:a})};h._featuresetFunctions.envelopeIntersects=function(a){return null===a||void 0===a?new e({parentfeatureset:this}):new c({parentfeatureset:this,relation:"esriSpatialRelEnvelopeIntersects",relationGeom:a})};h._featuresetFunctions.contains=function(a){return null===
a||void 0===a?new e({parentfeatureset:this}):new c({parentfeatureset:this,relation:"esriSpatialRelContains",relationGeom:a})};h._featuresetFunctions.overlaps=function(a){return null===a||void 0===a?new e({parentfeatureset:this}):new c({parentfeatureset:this,relation:"esriSpatialRelOverlaps",relationGeom:a})};h._featuresetFunctions.within=function(a){return null===a||void 0===a?new e({parentfeatureset:this}):new c({parentfeatureset:this,relation:"esriSpatialRelWithin",relationGeom:a})};h._featuresetFunctions.touches=
function(a){return null===a||void 0===a?new e({parentfeatureset:this}):new c({parentfeatureset:this,relation:"esriSpatialRelTouches",relationGeom:a})};h._featuresetFunctions.crosses=function(a){return null===a||void 0===a?new e({parentfeatureset:this}):new c({parentfeatureset:this,relation:"esriSpatialRelCrosses",relationGeom:a})};h._featuresetFunctions.relate=function(a,b){return null===a||void 0===a?new e({parentfeatureset:this}):new c({parentfeatureset:this,relation:"esriSpatialRelRelation",relationGeom:a,
relationString:b})}};return c}(h)});