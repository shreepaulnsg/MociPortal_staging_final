// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
var __extends=this&&this.__extends||function(){var G=function(z,x){G=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(A,y){A.__proto__=y}||function(A,y){for(var H in y)Object.prototype.hasOwnProperty.call(y,H)&&(A[H]=y[H])};return G(z,x)};return function(z,x){function A(){this.constructor=z}if("function"!==typeof x&&null!==x)throw new TypeError("Class extends value "+String(x)+" is not a constructor or null");G(z,x);z.prototype=null===x?Object.create(x):(A.prototype=x.prototype,new A)}}(),
__assign=this&&this.__assign||function(){__assign=Object.assign||function(G){for(var z,x=1,A=arguments.length;x<A;x++){z=arguments[x];for(var y in z)Object.prototype.hasOwnProperty.call(z,y)&&(G[y]=z[y])}return G};return __assign.apply(this,arguments)};
define("esri/arcade/featureset/sources/FeatureLayerDynamic","require exports dojox/encoding/digests/_base dojox/encoding/digests/MD5 ../../../graphic ../../../IdentityManager ../../../request ../../../sniff ../../../SpatialReference ../../../urlUtils ../../Attachment ../support/cache ../support/FeatureSet ../support/IdSet ../support/shared ../support/sqlUtils ../support/stats ../../polyfill/promiseUtils ../../../geometry/Extent ../../../geometry/jsonUtils ../../../layers/FeatureType ../../../layers/Field ../../../tasks/query ../../../tasks/QueryTask ../../../tasks/StatisticDefinition ../../Dictionary".split(" "),function(G,
z,x,A,y,H,K,N,P,Q,R,I,S,J,F,B,T,u,U,V,W,L,C,M,O,X){var Y=!!N("esri-pbf"),Z=!!N("esri-featurelayer-pbf"),aa=function(){function D(f,a,b){void 0===b&&(b=null);this.url=f;this.outFields=a;this.spatialReference=b;this._url=null;this.supportsQuantizationEditMode=this.supportsFormatPBF=!1;this.metadata=null;this.supportsAttachments=!1;this.relationships=[];this._queryTask=this._loadPromise=null;this.gdbVersion="";this.currentVersion=0;this.useStandardizedQueries=!1;this.fields=[];this._url=Q.urlToObject(f)}
D.prototype._canFetchPBFForQuery=function(f){return Y&&Z&&this.supportsFormatPBF&&!f.outStatistics&&this.supportsQuantizationEditMode};D.prototype._loadMetaData=function(f){if(null!==I.applicationCache){var a=I.applicationCache.getLayerInfo(f);if(null!==a)return a}a=u.create(function(b,g){K({url:f,content:{f:"json"},callbackParamName:"callback",load:function(e){b(e)},error:function(e){g(e)}})});null!==I.applicationCache&&(I.applicationCache.setLayerInfo(f,a),a=a.catch(function(b){I.applicationCache.clearLayerInfo(f);
throw b;}));return a};D.prototype.load=function(){var f=this;null===this._loadPromise&&(this._loadPromise=u.create(function(a,b){var g=f._url.path;f._loadMetaData(g).then(function(e){try{f.metadata=e;f.relationships=e.relationships;f._queryTask=new M(g);f.objectIdField=e.objectIdField;f.globalIdField=e.globalIdField;f.supportsAttachments=!0===e.hasAttachments;if(!f.objectIdField)for(var h=e.fields,d=0;d<h.length;d++){var k=h[d];if("esriFieldTypeOID"===k.type){f.objectIdField=k.name;break}}f.geometryType=
e.geometryType;f.typeIdField=e.typeIdField;f.fullExtent=new U(e.fullExtent);f.advancedQueryCapabilities=e.advancedQueryCapabilities||{supportsStatistics:e.supportsStatistics,supportsOrderBy:e.supportsAdvancedQueries,supportsDistinct:e.supportsAdvancedQueries};if(e.supportedQueryFormats){h=0;for(var c=e.supportedQueryFormats.split(",");h<c.length;h++)if("pbf"===c[h].replace(/^\s+|\s+$/gm,"").toLowerCase()){f.supportsFormatPBF=!0;break}}!0===e.supportsQuantizationEditMode&&(f.supportsQuantizationEditMode=
!0);!0===e.useStandardizedQueries&&(f.useStandardizedQueries=!0);void 0!==e.currentVersion&&(f.currentVersion=e.currentVersion);if(e.types){f.types=[];c=0;for(var n=e.types;c<n.length;c++){var l=n[c],m=new W(l);f.types.push(m)}}e.spatialReference&&!f.spatialReference&&(f.spatialReference=new P(e.spatialReference));if(1===f.outFields.length&&"*"===f.outFields[0])for(var t=0,p=e.fields;t<p.length;t++){l=p[t];var q=new L(l);f.fields.push(q)}else for(p=0,t=e.fields;p<t.length;p++)if(l=t[p],"esriFieldTypeOID"===
l.type)q=new L(l),f.fields.push(q);else{e=!1;n=0;for(var r=f.outFields;n<r.length;n++){var v=r[n];if(l.name.toUpperCase()===v.toUpperCase()){e=!0;break}}e&&(q=new L(l),f.fields.push(q))}f.definitionExpression="";a(f)}catch(w){b(w)}},b)}));return this._loadPromise};D.prototype.queryIds=function(f){var a=this;return u.create(function(b,g){a._queryTask.executeForIds(f,b,g)})};D.prototype.queryAttachments=function(f){var a=this,b=__assign(__assign({},f),{f:"json"});0<b.objectIds.length&&(b.objectIds=
b.objectIds.join(","));b.size&&(b.size=b.size.join(","));b.attachmentTypes&&(b.attachmentTypes=b.attachmentTypes.join(","));return u.create(function(g,e){K({url:a._url.path+"/queryAttachments",content:b,callbackParamName:"callback",load:function(h){var d={};if(h&&h.attachmentGroups){var k=0;for(h=h.attachmentGroups;k<h.length;k++){var c=h[k];void 0===d[c.parentObjectId]&&(d[c.parentObjectId]=[]);for(var n=0,l=c.attachmentInfos;n<l.length;n++){var m=l[n];d[c.parentObjectId].push({id:m.id,globalId:m.globalId,
name:m.name,contentType:m.contentType,size:m.size,exifInfo:m.exifInfo?m.exifInfo:null})}}}g(d)},error:function(h){e(h)}})})};return D}();return function(D){function f(a){var b=D.call(this,a)||this;b._layer=null;b._removeGeometry=!1;b.formulaCredential=null;b._pageJustIds=!1;b._requestStandardised=!1;b._useDefinitionExpression=!0;a.spatialReference&&(b.spatialReference=a.spatialReference);b._layer=new aa(a.url,a.outFields,b.spatialReference);b._transparent=!0;b._maxProcessing=1E3;b._wset=null;void 0!==
a.includeGeometry&&(b._removeGeometry=!1===a.includeGeometry);return b}__extends(f,D);f.prototype.optimisePagingFeatureQueries=function(a){this._pageJustIds=a};f.prototype._maxQueryRate=function(){return F.defaultMaxRecords};f.prototype.convertQueryToLruCacheKey=function(a){a=F.stableStringify(a.toJson());return A(a,x.outputTypes.String)};f.prototype.load=function(){var a=this;null===this._loadPromise&&(this._loadPromise=u.create(function(b,g){a._layer.load().then(function(){try{a._initialiseFeatureSet(),
b(a)}catch(e){g(e)}},function(e){g(e)})}));return this._loadPromise};f.prototype._initialiseFeatureSet=function(){null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference);this.geometryType=this._layer.geometryType;void 0===this.geometryType&&(this.geometryType="");this.fields=this._layer.fields.slice(0);var a=this._layer.currentVersion;!0===this._layer.useStandardizedQueries?(this._databaseType=F.FeatureServiceDatabaseType.StandardisedNoInterval,void 0!==a&&null!==a&&10.7<=
a&&(this._databaseType=F.FeatureServiceDatabaseType.Standardised)):void 0!==a&&null!==a&&(10.5<=a&&(this._databaseType=F.FeatureServiceDatabaseType.StandardisedNoInterval,this._requestStandardised=!0),10.7<=a&&(this._databaseType=F.FeatureServiceDatabaseType.Standardised));this.objectIdField=this._layer.objectIdField;this.globalIdField=this._layer.globalIdField;this.typeIdField=this._layer.typeIdField;this.types=this._layer.types};f.prototype._isInFeatureSet=function(a){return F.IdState.InFeatureSet};
f.prototype._refineSetBlock=function(a,b){return u.resolve(a)};f.prototype._candidateIdTransform=function(a){return a};f.prototype._transformSetWithIdChanges=function(a){};f.prototype._getSet=function(a){var b=this;return null===this._wset?this._ensureLoaded().then(function(){return b._getFilteredSet("",null,null,null,a)}).then(function(g){return b._wset=g}):u.resolve(this._wset)};f.prototype.nativeCapabilities=function(){return{title:this._layer.metadata.name,source:this,canQueryRelated:!0,capabilities:{query:{maxRecordCount:this._layer.maxRecordCount},
queryRelated:{supportsOrderBy:this._layer.metadata.advancedQueryCapabilities&&this._layer.metadata.advancedQueryCapabilities.supportsAdvancedQueryRelated,supportsPagination:this._layer.metadata.advancedQueryCapabilities&&this._layer.metadata.advancedQueryCapabilities.supportsQueryRelatedPagination}},databaseType:this._databaseType,requestStandardised:this._requestStandardised}};Object.defineProperty(f.prototype,"gdbVersion",{get:function(){return this._layer&&this._layer.metadata&&this._layer.metadata.isDataVersioned?
this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT":""},enumerable:!1,configurable:!0});f.prototype._runDatabaseProbe=function(a){var b=this;return u.create(function(g,e){try{b._ensureLoaded().then(function(){try{var h=new C;h.where=a.replace("OBJECTID",b._layer.objectIdField);b._layer.queryIds(h).then(function(d){g(!0)},function(d){try{g(!1)}catch(k){e(k)}})}catch(d){e(d)}})}catch(h){e(h)}})};f.prototype._canUsePagination=function(){return void 0!==this._layer.advancedQueryCapabilities&&
null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsPagination?!0:!1};f.prototype._cacheableFeatureSetSourceKey=function(){return this._layer.url};f.prototype._getFilteredSet=function(a,b,g,e,h){var d=this;return this.databaseType().then(function(k){if(d.isTable()&&b&&null!==a&&""!==a)return new J([],[],!0,null);if(d._canUsePagination())return d._getFilteredSetUsingPaging(a,b,g,e,h);var c="",n=!1;null!==e&&void 0!==d._layer.advancedQueryCapabilities&&null!==
d._layer.advancedQueryCapabilities&&!0===d._layer.advancedQueryCapabilities.supportsOrderBy&&(c=e.constructClause(),n=!0);var l=new C;d._requestStandardised&&(l.sqlFormat="standard");l.where=null===g?null===b?"1\x3d1":"":B.toWhereClause(g,k);l.spatialRelationship=d._makeRelationshipEnum(a);l.outSpatialReference=d.spatialReference;l.orderByFields=""!==c?c.split(","):null;l.geometry=null===b?null:b;l.relationParam=d._makeRelationshipParam(a);return d.executeQuery(l,"executeForIds").then(function(m){null===
m&&(m=[]);d._checkCancelled(h);return new J([],m,n,null)})})};f.prototype._expandPagedSet=function(a,b,g,e,h){return this._expandPagedSetFeatureSet(a,b,g,e,h)};f.prototype._getFilteredSetUsingPaging=function(a,b,g,e,h){var d=this;try{var k="",c=!1;null!==e&&void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsOrderBy&&(k=e.constructClause(),c=!0);return this.databaseType().then(function(n){n=null===g?null===
b?"1\x3d1":"":B.toWhereClause(g,n);d._layer.definitionExpression&&d._useDefinitionExpression&&(n=""!==n?"(("+d._layer.definitionExpression+") AND ("+n+"))":d._layer.definitionExpression);var l=d._maxQueryRate();void 0!==d._layer.maxRecordCount&&d._layer.maxRecordCount<l&&(l=d._layer.maxRecordCount);var m=null;if(!0===d._pageJustIds)m=new J([],["GETPAGES"],c,{spatialRel:d._makeRelationshipEnum(a),relationParam:d._makeRelationshipParam(a),outFields:d._layer.objectIdField,resultRecordCount:l,resultOffset:0,
geometry:null===b?"":b,where:n,orderByFields:k,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,fullyResolved:!1}});else{var t=!0;!0===d._removeGeometry&&(t=!1);var p=d._fieldsIncludingObjectId(d._layer.outFields);m=new J([],["GETPAGES"],c,{spatialRel:d._makeRelationshipEnum(a),relationParam:d._makeRelationshipParam(a),outFields:p.join(","),resultRecordCount:l,resultOffset:0,geometry:null===b?"":b,where:n,orderByFields:k,returnGeometry:t,returnIdsOnly:"false",internal:{set:[],
lastRetrieved:0,fullyResolved:!1}})}return d._expandPagedSet(m,l,0,1,h).then(function(q){return m})})}catch(n){return u.reject(n)}};f.prototype._clonePageDefinition=function(a){return null===a?null:!0!==a.groupbypage?{groupbypage:!1,spatialRel:a.spatialRel,relationParam:a.relationParam,outFields:a.outFields,resultRecordCount:a.resultRecordCount,resultOffset:a.resultOffset,geometry:a.geometry,where:a.where,orderByFields:a.orderByFields,returnGeometry:a.returnGeometry,returnIdsOnly:a.returnIdsOnly,
internal:a.internal}:{groupbypage:!0,spatialRel:a.spatialRel,relationParam:a.relationParam,outFields:a.outFields,resultRecordCount:a.resultRecordCount,useOIDpagination:a.useOIDpagination,generatedOid:a.generatedOid,groupByFieldsForStatistics:a.groupByFieldsForStatistics,resultOffset:a.resultOffset,outStatistics:a.outStatistics,geometry:a.geometry,where:a.where,orderByFields:a.orderByFields,returnGeometry:a.returnGeometry,returnIdsOnly:a.returnIdsOnly,internal:a.internal}};f.prototype._getPhysicalPage=
function(a,b,g){var e=this;try{var h=a.pagesDefinition.internal.lastRetrieved,d=new C;this._requestStandardised&&(d.sqlFormat="standard");d.spatialRelationship=a.pagesDefinition.spatialRel;d.relationParam=a.pagesDefinition.relationParam;d.outFields=a.pagesDefinition.outFields.split(",");d.num=a.pagesDefinition.resultRecordCount;d.start=a.pagesDefinition.internal.lastRetrieved;d.geometry=a.pagesDefinition.geometry;d.where=a.pagesDefinition.where;d.orderByFields=""!==a.pagesDefinition.orderByFields?
a.pagesDefinition.orderByFields.split(","):null;d.returnGeometry=a.pagesDefinition.returnGeometry;d.outSpatialReference=this.spatialReference;return this.executeQuery(d,"execute").then(function(k){e._checkCancelled(g);if(a.pagesDefinition.internal.lastRetrieved!==h)return"done";for(var c=0;c<k.features.length;c++)void 0===k.features[c].geometry&&(k.features[c].geometry=null),a.pagesDefinition.internal.set[h+c]=k.features[c].attributes[e._layer.objectIdField];if(!1===e._pageJustIds)for(c=0;c<k.features.length;c++)e._featureCache[k.features[c].attributes[e._layer.objectIdField]]=
k.features[c];k.features.length!==a.pagesDefinition.resultRecordCount&&(a.pagesDefinition.internal.fullyResolved=!0);a.pagesDefinition.internal.lastRetrieved=h+a.pagesDefinition.resultRecordCount;return"done"})}catch(k){return u.reject(k)}};f.prototype._fieldsIncludingObjectId=function(a){if(null===a)return[this.objectIdField];a=a.slice(0);if(-1<a.indexOf("*"))return a;for(var b=!1,g=0;g<a.length;g++)if(a[g].toUpperCase()===this.objectIdField.toUpperCase()){b=!0;break}!1===b&&a.push(this.objectIdField);
return a};f.prototype._getFeatures=function(a,b,g,e){var h=this,d=[];try{-1!==b&&void 0===this._featureCache[b]&&d.push(b);if(!0===this._checkIfNeedToExpandKnownPage(a,this._maxProcessingRate()))return this._expandPagedSet(a,this._maxProcessingRate(),0,0,e).then(function(p){return h._getFeatures(a,b,g,e)});for(var k=0,c=a._lastFetchedIndex;c<a._known.length;c++){a._lastFetchedIndex+=1;k++;if(void 0===this._featureCache[a._known[c]]){var n=!1;if(null!==this._layer._mode&&void 0!==this._layer._mode){var l=
this._layer._mode;if(void 0!==l._featureMap[a._known[c]]){var m=l._featureMap[a._known[c]];null!==m&&(n=!0,this._featureCache[a._known[c]]=m)}}if(!1===n&&(a._known[c]!==b&&d.push(a._known[c]),d.length>=this._maxProcessingRate()-1))break}if(k>=g&&0===d.length)break}if(0===d.length)return u.resolve("success");try{var t=new C;this._requestStandardised&&(t.sqlFormat="standard");t.objectIds=d;t.outFields=this._fieldsIncludingObjectId(this._layer.outFields);t.returnGeometry=!0;!0===this._removeGeometry&&
(t.returnGeometry=!1);t.outSpatialReference=this.spatialReference;return this.executeQuery(t,"execute").then(function(p){h._checkCancelled(e);if(void 0!==p.error)return u.reject(Error(p.error));for(var q=0;q<p.features.length;q++)void 0===p.features[q].geometry&&(p.features[q].geometry=null),h._featureCache[p.features[q].attributes[h._layer.objectIdField]]=p.features[q];return"success"})}catch(p){return u.reject(p)}}catch(p){return u.reject(p)}};f.prototype._layerUrl=function(){return this._layer.url};
f.prototype.pbfSupportedForQuery=function(a){return this._layer._canFetchPBFForQuery(a)};f.prototype.executeQuery=function(a,b){var g=new M(this._layerUrl()),e="execute"===b&&this.pbfSupportedForQuery(a);e&&(a.quantizationParameters={mode:"edit"});var h=null;if(this.recentlyUsedQueries){var d=this.convertQueryToLruCacheKey(a);(h=this.recentlyUsedQueries.getFromCache(d))&&h.isRejected()&&(h=null,this.recentlyUsedQueries.removeFromCache(d));null===h&&(h=!0!==e?g[b](a):g[b](a,null,null,{format:"pbf"}),
this.recentlyUsedQueries.addToCache(d,h))}null===h&&(h=!0!==e?g[b](a):g[b](a,null,null,{format:"pbf"}));return h};f.prototype._getDistinctPages=function(a,b,g,e,h,d,k,c,n){var l=this;return this._ensureLoaded().then(function(){for(var m=g.parseTree.column,t=0;t<l._layer.fields.length;t++)if(l._layer.fields[t].name.toLowerCase()===m.toLowerCase()){m=l._layer.fields[t].name;break}return l.databaseType().then(function(p){var q=new C;l._requestStandardised&&(q.sqlFormat="standard");p=null===d?null===
h?"1\x3d1":"":B.toWhereClause(d,p);l._layer.definitionExpression&&l._useDefinitionExpression&&(p=""!==p?"(("+l._layer.definitionExpression+") AND ("+p+"))":l._layer.definitionExpression);q.where=p;q.spatialRelationship=l._makeRelationshipEnum(e);q.relationParam=l._makeRelationshipParam(e);q.geometry=null===h?null:h;q.returnDistinctValues=!0;q.returnGeometry=!1;q.outFields=[m];return l.executeQuery(q,"execute").then(function(r){l._checkCancelled(n);if(!r.hasOwnProperty("features"))return u.reject(Error("Unnexected Result querying statistics from layer"));
for(var v=!1,w=0;w<l._layer.fields.length;w++)if(l._layer.fields[w].name===m){"esriFieldTypeDate"===l._layer.fields[w].type&&(v=!0);break}for(w=0;w<r.features.length;w++){if(v){var E=r.features[w].attributes[m];null!==E?c.push(new Date(E)):c.push(E)}else c.push(r.features[w].attributes[m]);if(c.length>=k)break}return 0===r.features.length?c:r.features.length===l._layer.maxRecordCount&&c.length<k?l._getDistinctPages(a+r.features.length,b,g,e,h,d,k,c,n).then(function(ba){return{calculated:!0,result:ba}}):
c})})})};f.prototype._distinctStat=function(a,b,g,e,h,d,k){return this._getDistinctPages(0,a,b,g,e,h,d,[],k).then(function(c){return{calculated:!0,result:c}})};f.prototype.isTable=function(){return null===this._layer.geometryType||""===this._layer.geometryType||void 0===this._layer.geometryType};f.prototype._countstat=function(a,b,g,e,h){var d=this;return this.databaseType().then(function(k){var c=new C;d._requestStandardised&&(c.sqlFormat="standard");if(d.isTable()&&g&&null!==b&&""!==b)return{calculated:!0,
result:0};k=null===e?null===g?"1\x3d1":"":B.toWhereClause(e,k);d._layer.definitionExpression&&d._useDefinitionExpression&&(k=""!==k?"(("+d._layer.definitionExpression+") AND ("+k+"))":d._layer.definitionExpression);c.where=k;c.where=k;c.spatialRelationship=d._makeRelationshipEnum(b);c.relationParam=d._makeRelationshipParam(b);c.geometry=null===g?null:g;c.returnGeometry=!1;return d.executeQuery(c,"executeForCount").then(function(n){return{calculated:!0,result:n}})})};f.prototype._stats=function(a,
b,g,e,h,d,k){var c=this;return this._ensureLoaded().then(function(){var n=c._layer.advancedQueryCapabilities&&!0===c._layer.advancedQueryCapabilities.supportsSqlExpression,l=c._layer.advancedQueryCapabilities&&!0===c._layer.advancedQueryCapabilities.supportsStatistics,m=c._layer.advancedQueryCapabilities&&!0===c._layer.advancedQueryCapabilities.supportsDistinct;return"count"===a?m?c._countstat(a,g,e,h,k):{calculated:!1}:!1===l||!1===B.isSingleField(b)&&!1===n||!1===b.isStandardized?""!==g||null!==
h?{calculated:!1}:c._manualStat(a,b,d,k):"distinct"===a?!1===m?""!==g||null!==h?{calculated:!1}:c._manualStat(a,b,d,k):c._distinctStat(a,b,g,e,h,d,k):c.databaseType().then(function(t){if(c.isTable()&&e&&null!==g&&""!==g)return{calculated:!0,result:null};var p=new C;c._requestStandardised&&(p.sqlFormat="standard");var q=null===h?null===e?"1\x3d1":"":B.toWhereClause(h,t);c._layer.definitionExpression&&c._useDefinitionExpression&&(q=""!==q?"(("+c._layer.definitionExpression+") AND ("+q+"))":c._layer.definitionExpression);
p.where=q;p.spatialRelationship=c._makeRelationshipEnum(g);p.relationParam=c._makeRelationshipParam(g);p.geometry=null===e?null:e;q=new O;q.statisticType=T.decodeStatType(a);q.onStatisticField=B.toWhereClause(b,t);var r=q.outStatisticFieldName="ARCADE_STAT_RESULT";p.returnGeometry=!1;p.outStatistics=[q];return c.executeQuery(p,"execute").then(function(v){if(!v.hasOwnProperty("features")||0===v.features.length)return u.reject(Error("Unnexected Result querying statistics from layer"));for(var w=!1,
E=0;E<v.fields.length;E++)if("ARCADE_STAT_RESULT"===v.fields[E].name.toUpperCase()){r=v.fields[E].name;"esriFieldTypeDate"===v.fields[E].type&&(w=!0);break}return w?(w=v.features[0].attributes[r],null!==w&&(w=new Date(v.features[0].attributes[r])),{calculated:!0,result:w}):{calculated:!0,result:v.features[0].attributes[r]}})})})};f.prototype._stat=function(a,b,g,e,h,d,k){return this._stats(a,b,g,e,h,d,k)};f.prototype._canDoAggregates=function(a,b,g,e,h){var d=this;return this._ensureLoaded().then(function(k){k=
!1;var c=d._layer.advancedQueryCapabilities&&!0===d._layer.advancedQueryCapabilities.supportsSqlExpression;void 0!==d._layer.advancedQueryCapabilities&&null!==d._layer.advancedQueryCapabilities&&!0===d._layer.advancedQueryCapabilities.supportsStatistics&&!0===d._layer.advancedQueryCapabilities.supportsOrderBy&&(k=!0);if(k)for(var n=0;n<b.length-1;n++)null!==b[n].workingexpr&&(!1===b[n].workingexpr.isStandardized?k=!1:!1===B.isSingleField(b[n].workingexpr)&&!1===c&&(k=!1));return!1===k?!1:!0})};f.prototype._makeRelationshipEnum=
function(a){return 0<=a.indexOf("esriSpatialRelRelation")?"esriSpatialRelRelation":a};f.prototype._makeRelationshipParam=function(a){return 0<=a.indexOf("esriSpatialRelRelation")?a.split(":")[1]:""};f.prototype._getAggregatePagesDataSourceDefinition=function(a,b,g,e,h,d,k){var c=this;return this._ensureLoaded().then(function(n){return c.databaseType().then(function(l){var m="",t=!1,p=!1;null!==d&&void 0!==c._layer.advancedQueryCapabilities&&null!==c._layer.advancedQueryCapabilities&&!0===c._layer.advancedQueryCapabilities.supportsOrderBy&&
(m=d.constructClause(),p=!0);void 0!==c._layer.advancedQueryCapabilities&&null!==c._layer.advancedQueryCapabilities&&!1===c._layer.advancedQueryCapabilities.supportsPagination&&(p=!1,t=!0,m=c._layer.objectIdField);for(var q=[],r=0;r<b.length;r++){var v=new O;v.onStatisticField=null!==b[r].workingexpr?B.toWhereClause(b[r].workingexpr,l):"";v.outStatisticFieldName=b[r].field;v.statisticType=b[r].toStatisticsName();q.push(v)}""===m&&(m=a.join(","));r=c._maxQueryRate();void 0!==c._layer.maxRecordCount&&
c._layer.maxRecordCount<r&&(r=c._layer.maxRecordCount);l=null===h?null===e?"1\x3d1":"":B.toWhereClause(h,l);c._layer.definitionExpression&&c._useDefinitionExpression&&(l=""!==l?"(("+c._layer.definitionExpression+") AND ("+l+"))":c._layer.definitionExpression);return new J([],["GETPAGES"],p,{groupbypage:!0,spatialRel:c._makeRelationshipEnum(g),relationParam:c._makeRelationshipParam(g),outFields:["*"],useOIDpagination:t,generatedOid:k,resultRecordCount:r,resultOffset:0,groupByFieldsForStatistics:a,
outStatistics:q,geometry:null===e?null:e,where:l,orderByFields:m,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,fullyResolved:!1}})})})};f.prototype._getAgregagtePhysicalPage=function(a,b,g){var e=this;try{var h=a.pagesDefinition.where;!0===a.pagesDefinition.useOIDpagination&&(h=""!==h?"("+h+") AND ("+a.pagesDefinition.generatedOid+"\x3e"+a.pagesDefinition.internal.lastMaxId.toString()+")":a.pagesDefinition.generatedOid+"\x3e"+a.pagesDefinition.internal.lastMaxId.toString());
var d=a.pagesDefinition.internal.lastRetrieved,k=new C;this._requestStandardised&&(k.sqlFormat="standard");k.where=h;k.spatialRelationship=a.pagesDefinition.spatialRel;k.relationParam=a.pagesDefinition.relationParam;k.outFields=a.pagesDefinition.outFields;k.outStatistics=a.pagesDefinition.outStatistics;k.geometry=a.pagesDefinition.geometry;k.groupByFieldsForStatistics=a.pagesDefinition.groupByFieldsForStatistics;k.num=a.pagesDefinition.resultRecordCount;k.start=a.pagesDefinition.internal.lastRetrieved;
k.returnGeometry=a.pagesDefinition.returnGeometry;k.orderByFields=""!==a.pagesDefinition.orderByFields?a.pagesDefinition.orderByFields.split(","):null;return this.isTable()&&k.geometry&&k.spatialRelationship?u.resolve([]):this.executeQuery(k,"execute").then(function(c){e._checkCancelled(g);if(!c.hasOwnProperty("features"))return u.reject(Error("Unnexected Result querying aggregates from layer"));var n=[];if(a.pagesDefinition.internal.lastRetrieved!==d)return u.resolve([]);for(var l=0;l<c.features.length;l++)void 0===
c.features[l].geometry&&(c.features[l].geometry=null),a.pagesDefinition.internal.set[d+l]=c.features[l].attributes[a.pagesDefinition.generatedOid];for(l=0;l<c.features.length;l++)n.push(new y({attributes:c.features[l].attributes,geometry:null}));!0===a.pagesDefinition.useOIDpagination?0===c.features.length?a.pagesDefinition.internal.fullyResolved=!0:a.pagesDefinition.internal.lastMaxId=c.features[c.features.length-1].attributes[a.pagesDefinition.generatedOid]:c.features.length!==a.pagesDefinition.resultRecordCount&&
(a.pagesDefinition.internal.fullyResolved=!0);a.pagesDefinition.internal.lastRetrieved=d+a.pagesDefinition.resultRecordCount;return n})}catch(c){return u.reject(c)}};f.create=function(a,b,g){return new f({url:a,outFields:null===b?["*"]:b,spatialReference:g})};f.prototype.queryAttachments=function(a,b,g,e,h){var d=this;if(this._layer.supportsAttachments){var k={objectIds:[a],returnMetadata:h};if(b&&0<b||g&&0<g)k.size=[b&&0<b?b:0,g&&0<g?g:b+1];e&&0<e.length&&(k.attachmentTypes=e);return this._layer.queryAttachments(k).then(function(c){var n=
[];if(c&&c[a]){var l=d._layer._url.path;c[a].forEach(function(m){var t=l+"/"+a.toString()+"/attachments/"+m.id.toString(),p=null;h&&m.exifInfo&&(p=X.convertJsonToArcade(m.exifInfo,!0));n.push(new R(m.id,m.name,m.contentType,m.size,t,p))})}return n})}return u.resolve([])};f.prototype.serviceUrl=function(){return F.extractServiceUrl(this._layer._url.path)};f.prototype.relationshipMetaData=function(){return this._layer.relationships};f.prototype.queryRelatedFeatures=function(a){var b=this,g={f:"json",
relationshipId:a.relationshipId.toString(),definitionExpression:a.definitionExpression,outFields:a.outFields.join(","),returnGeometry:a.returnGeometry.toString()};void 0!==a.resultOffset&&null!==a.resultOffset&&(g.resultOffset=a.resultOffset.toString());void 0!==a.resultRecordCount&&null!==a.resultRecordCount&&(g.resultRecordCount=a.resultRecordCount.toString());a.orderByFields&&(g.orderByFields=a.orderByFields.join(","));0<a.objectIds.length&&(g.objectIds=a.objectIds.join(","));a.outSpatialReference&&
(g.outSR=JSON.stringify(a.outSpatialReference.toJson()));return u.create(function(e,h){K({url:b._layer._url.path+"/queryRelatedRecords",content:g,callbackParamName:"callback",load:function(d){var k={};if(d&&d.relatedRecordGroups)for(var c=d.spatialReference,n=0,l=d.relatedRecordGroups;n<l.length;n++){var m=l[n],t=m.objectId,p=[],q=0;for(m=m.relatedRecords;q<m.length;q++){var r=m[q];r.geometry&&(r.geometry.spatialReference=c);r=new y({geometry:r.geometry?V.fromJson(r.geometry):null,attributes:r.attributes});
p.push(r)}k[t]={features:p,exceededTransferLimit:!0===d.exceededTransferLimit}}e(k)},error:function(d){h(d)}})})};f.prototype.getFeatureByObjectId=function(a,b){var g=new M(this._layer._url.path),e=new C;e.outFields=b;e.returnGeometry=!1;e.outSpatialReference=this.spatialReference;e.where=this.objectIdField+"\x3d"+a.toString();return g.execute(e).then(function(h){return 1===h.features.length?h.features[0]:null})};f.prototype.getIdentityUser=function(){var a=this;return this.load().then(function(){return u.resolve(H.findCredential(a._layer._url.path))}).then(function(b){return b?
b.userId:null})};f.prototype.getOwningSystemUrl=function(){var a=this;return this.load().then(function(){var b=H.findServerInfo(a._layer._url.path);if(b)return u.resolve(b.owningSystemUrl);var g=a._layer.url;b=g.toLowerCase().indexOf("/rest/services");return(g=-1<b?g.substring(0,b):g)?(g+="/rest/info",u.create(function(e){K({url:g,content:{f:"json"},callbackParamName:"callback",load:function(h){var d="";h&&h.owningSystemUrl&&(d=h.owningSystemUrl);e(d)},error:function(h){e("")}})})):u.resolve("")})};
f.prototype.getDataSourceFeatureSet=function(){var a=new f({url:this._layer.url,spatialReference:this.spatialReference,outFields:this._layer.outFields,includeGeometry:!this._removeGeometry,lrucache:this.recentlyUsedQueries,interceptor:this.featureSetQueryInterceptor});a._useDefinitionExpression=!1;return a};return f}(S)});