// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
var __extends=this&&this.__extends||function(){var w=function(v,l){w=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,m){r.__proto__=m}||function(r,m){for(var n in m)Object.prototype.hasOwnProperty.call(m,n)&&(r[n]=m[n])};return w(v,l)};return function(v,l){function r(){this.constructor=v}if("function"!==typeof l&&null!==l)throw new TypeError("Class extends value "+String(l)+" is not a constructor or null");w(v,l);v.prototype=null===l?Object.create(l):(r.prototype=l.prototype,new r)}}();
define("esri/arcade/featureset/sources/FeatureLayerMemoryMap","require exports ../../../graphic ../support/FeatureSet ../support/IdSet ../support/shared ../../polyfill/promiseUtils ../../../geometry/geometryEngineAsync".split(" "),function(w,v,l,r,m,n,h,t){return function(x){function f(a){var b=x.call(this,a)||this;b.declaredClass="esri.layers.featureset.sources.FeatureLayerMemory";b._removeGeometry=!1;b._overrideFields=null;b.allf=null;a.spatialReference&&(b.spatialReference=a.spatialReference);
b._transparent=!0;b._maxProcessing=1E3;b._layer=a.layer;b._wset=null;if(!1===b._layer.loaded)throw Error("Can only create Feature FeatureSets from Loaded FeatureLayers. Use FeatureLayer or FeatureCollection classes");void 0!==a.outFields&&(b._overrideFields=a.outFields);void 0!==a.includeGeometry&&(b._removeGeometry=!1===a.includeGeometry);return b}__extends(f,x);f.prototype._maxQueryRate=function(){return n.defaultMaxRecords};f.prototype.end=function(){return this._layer};f.prototype.optimisePagingFeatureQueries=
function(a){};f.prototype.load=function(){var a=this;null===this._loadPromise&&(this._loadPromise=h.create(function(b,c){a._initialiseFeatureSet();b(a)}));return this._loadPromise};f.prototype._initialiseFeatureSet=function(){if(!this._layer.getMap())throw Error("Can only use featuresets with layers attached to map");null==this.spatialReference&&(this.spatialReference=this._layer.getMap().spatialReference);this.geometryType=this._layer.geometryType;this.fields=this._layer.fields.slice(0);var a=this._layer.getOutFields();
if(1!==a.length||"*"!==a[0]){for(var b=[],c=0,e=this.fields;c<e.length;c++){var d=e[c];if("esriFieldTypeOID"===d.type)b.push(d);else for(var g=0,k=a;g<k.length;g++){var u=k[g];if(u.toLowerCase()===d.name.toLowerCase()){b.push(d);break}}}this.fields=b}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{b=[];a=[];c=0;for(e=this.fields;c<e.length;c++)if(d=e[c],"esriFieldTypeOID"===d.type)b.push(d),a.push(d.name);else for(g=0,
k=this._overrideFields;g<k.length;g++)if(u=k[g],u.toLowerCase()===d.name.toLowerCase()){b.push(d);a.push(d.name);break}this.fields=b;this._overrideFields=a}this.objectIdField=this._layer.objectIdField;this.globalIdField=this._layer.globalIdField;this._databaseType=n.FeatureServiceDatabaseType.Standardised;this.typeIdField=this._layer.typeIdField;this.types=this._layer.types};f.prototype._isInFeatureSet=function(a){return n.IdState.InFeatureSet};f.prototype._transformSetWithIdChanges=function(a){};
f.prototype._candidateIdTransform=function(a){return a};f.prototype._getSet=function(a){var b=this;return null===this._wset?this._ensureLoaded().then(function(){return b._getFilteredSet("",null,null,null,a)}).then(function(c){return b._wset=c}):h.resolve(this._wset)};f.prototype._getFilteredSet=function(a,b,c,e,d){var g=this;try{return this._ensureLoaded().then(function(){if(null===g._wset){var k=[];g._allFeatures().forEach(function(p){void 0===p.geometry&&(p.geometry=null);var q=p.attributes[g._layer.objectIdField];
k.push(q);g._featureCache[q]=p});g._wset=new m([],k,!1,null)}var u=g._wset._known.slice(0);g._checkCancelled(d);return g.fetchAndRefineFeaturesByWhere(u,c,d).then(function(p){g._checkCancelled(d);return null!==b?g.fetchAndRefineFeaturesSpatially(p,b,a,d).then(function(q){return new m([],q,!1,null)}):new m([],p,!1,null)})})}catch(k){return h.reject(k)}};f.prototype.executeSpatialRelationTest=function(a,b,c,e){if(null===a.geometry)return h.resolve(!1);switch(b){case "esriSpatialRelEnvelopeIntersects":return b=
n.shapeExtent(c),a=n.shapeExtent(a.geometry),t.intersects(b,a);case "esriSpatialRelIntersects":return t.intersects(c,a.geometry);case "esriSpatialRelContains":return t.contains(c,a.geometry);case "esriSpatialRelOverlaps":return t.overlaps(c,a.geometry);case "esriSpatialRelWithin":return t.within(c,a.geometry);case "esriSpatialRelTouches":return t.touches(c,a.geometry);case "esriSpatialRelCrosses":return t.crosses(c,a.geometry);case "esriSpatialRelRelation":return t.relate(c,a.geometry,e)}};f.prototype.executeWhereTest=
function(a,b){return b.testFeature(a)};f.prototype.fetchAndRefineFeaturesSpatially=function(a,b,c,e){var d=[];e=[];var g="";0<=c.indexOf("esriSpatialRelRelation")&&(g=c.split(":")[1],c="esriSpatialRelRelation");for(var k=0;k<a.length;k++){var u=this._featureFromCache(a[k]);e.push(this.executeSpatialRelationTest(u,c,b,g))}return 0===e.length?h.resolve(d):h.all(e).then(function(p){for(var q=0;q<a.length;q++)!0===p[q]&&d.push(a[q]);return d})};f.prototype.fetchAndRefineFeaturesByWhere=function(a,b,c){c=
[];if(null===b)return h.resolve(a);for(var e=0;e<a.length;e++){var d=this._featureFromCache(a[e]);this.executeWhereTest(d,b)&&c.push(a[e])}return h.resolve(c)};f.prototype._getFeatures=function(a,b,c,e){e=[];-1!==b&&void 0===this._featureCache[b]&&e.push(b);for(var d=a._lastFetchedIndex;d<a._known.length&&!(a._lastFetchedIndex+=1,void 0===this._featureCache[a._known[d]]&&(a._known[d]!==b&&e.push(a._known[d]),e.length>c));d++);return 0===e.length?h.resolve("success"):h.reject(Error("Unaccounted for Features. Not in Feature Collection"))};
f.prototype._refineSetBlock=function(a,b,c){return h.resolve(a)};f.prototype._stat=function(a,b,c,e,d,g,k){return h.resolve({calculated:!1})};f.prototype._canDoAggregates=function(a,b,c,e,d){return h.resolve(!1)};f._cloneAttr=function(a){var b={},c;for(c in a)b[c]=a[c];return b};f.prototype.cloneAttr=function(a){for(var b={},c=0,e=this.fields;c<e.length;c++){var d=e[c];b[d.name]=a[d.name]}return b};f.prototype.relationshipMetaData=function(){return[]};Object.defineProperty(f.prototype,"gdbVersion",
{get:function(){return""},enumerable:!1,configurable:!0});f.prototype.nativeCapabilities=function(){return{title:this._layer.name,source:this,canQueryRelated:!1,capabilities:{query:{maxRecordCount:1E3},queryRelated:{supportsOrderBy:!1,supportsPagination:!1}},databaseType:this._databaseType,requestStandardised:!1}};f.prototype._allFeatures=function(){var a=this;null==this.allf&&(this.allf=[],this._layer.graphics.forEach(function(b){a.allf.push(new l(!0===a._removeGeometry?null:b.geometry,null,a.cloneAttr(b.attributes)))}));
return this.allf};f.prototype.canBeBigDataFeatureSet=function(){return!1};f.prototype.shouldBeResolvedAsBigData=function(){return!1};f.prototype.queryAttachments=function(a,b,c,e){return h.resolve([])};f.prototype.getFeatureByObjectId=function(a,b){var c=this,e=null;this._layer.graphics.forEach(function(d){d.attributes[c.objectIdField]===a&&(e=d)});return h.resolve(e)};f.prototype.getIdentityUser=function(){return h.resolve("")};f.prototype.getOwningSystemUrl=function(){return h.resolve("")};return f}(r)});