// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
var __extends=this&&this.__extends||function(){var F=function(z,x){F=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(A,y){A.__proto__=y}||function(A,y){for(var G in y)Object.prototype.hasOwnProperty.call(y,G)&&(A[G]=y[G])};return F(z,x)};return function(z,x){function A(){this.constructor=z}if("function"!==typeof x&&null!==x)throw new TypeError("Class extends value "+String(x)+" is not a constructor or null");F(z,x);z.prototype=null===x?Object.create(x):(A.prototype=x.prototype,new A)}}(),
__assign=this&&this.__assign||function(){__assign=Object.assign||function(F){for(var z,x=1,A=arguments.length;x<A;x++){z=arguments[x];for(var y in z)Object.prototype.hasOwnProperty.call(z,y)&&(F[y]=z[y])}return F};return __assign.apply(this,arguments)};
define("esri/arcade/featureset/sources/FeatureLayerDynamicMap","require exports dojox/encoding/digests/_base dojox/encoding/digests/MD5 ../../../graphic ../../../IdentityManager ../../../request ../../Attachment ../support/FeatureSet ../support/IdSet ../support/shared ../support/sqlUtils ../support/stats ../../polyfill/promiseUtils ../../../geometry/jsonUtils ../../../layers/FeatureLayer ../../../tasks/query ../../../tasks/QueryTask ../../../tasks/StatisticDefinition ../../Dictionary".split(" "),function(F,
z,x,A,y,G,I,M,N,H,E,B,O,u,P,Q,C,J,K,R){return function(L){function l(a){var c=L.call(this,a)||this;c.declaredClass="esri.layers.featureset.sources.FeatureLayerDynamic";c._removeGeometry=!1;c._overrideFields=null;c.formulaCredential=null;c._pageJustIds=!1;c._requestStandardised=!1;c._useDefinitionExpression=!0;a.spatialReference&&(c.spatialReference=a.spatialReference);c._transparent=!0;c._maxProcessing=1E3;c._layer=a.layer;c._wset=null;if(!1===c._layer.loaded)throw Error("Can only create FeatureSets from Loaded FeatureLayers. Use FeatureLayer or FeatureCollection classes");
void 0!==a.outFields&&(c._overrideFields=a.outFields);void 0!==a.includeGeometry&&(c._removeGeometry=!1===a.includeGeometry);return c}__extends(l,L);l.prototype._maxQueryRate=function(){return E.defaultMaxRecords};l.prototype.convertQueryToLruCacheKey=function(a){a=E.stableStringify(a.toJson());return A(a,x.outputTypes.String)};l.prototype.end=function(){return this._layer};l.prototype.load=function(){var a=this;null===this._loadPromise&&(this._loadPromise=u.create(function(c,e){a._initialiseFeatureSet();
c(a)}));return this._loadPromise};l.prototype.optimisePagingFeatureQueries=function(a){this._pageJustIds=a};l.prototype._initialiseFeatureSet=function(){if(!this._layer.getMap())throw Error("Can only use featuresets with layers attached to map");null==this.spatialReference&&(this.spatialReference=this._layer.getMap().spatialReference);this.geometryType=this._layer.geometryType;this.fields=this._layer.fields.slice(0);var a=this._layer.getOutFields();if(1!==a.length||"*"!==a[0]){for(var c=[],e=0,h=
this.fields;e<h.length;e++){var g=h[e];if("esriFieldTypeOID"===g.type)c.push(g);else for(var b=0,f=a;b<f.length;b++){var d=f[b];if(d.toLowerCase()===g.name.toLowerCase()){c.push(g);break}}}this.fields=c}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{c=[];a=[];e=0;for(h=this.fields;e<h.length;e++)if(g=h[e],"esriFieldTypeOID"===g.type)c.push(g),a.push(g.name);else for(b=0,f=this._overrideFields;b<f.length;b++)if(d=f[b],
d.toLowerCase()===g.name.toLowerCase()){c.push(g);a.push(g.name);break}this.fields=c;this._overrideFields=a}this._layer&&(c=this._layer.version,!0===this._layer.useStandardizedQueries?(this._databaseType=E.FeatureServiceDatabaseType.StandardisedNoInterval,void 0!==c&&null!==c&&10.61<=c&&(this._databaseType=E.FeatureServiceDatabaseType.Standardised)):void 0!==c&&null!==c&&(10.5<=c&&(this._databaseType=E.FeatureServiceDatabaseType.StandardisedNoInterval,this._requestStandardised=!0),10.61<=c&&(this._databaseType=
E.FeatureServiceDatabaseType.Standardised)));this.objectIdField=this._layer.objectIdField;this.globalIdField=this._layer.globalIdField;this.typeIdField=this._layer.typeIdField;this.types=this._layer.types};l.prototype._isInFeatureSet=function(a){return E.IdState.InFeatureSet};l.prototype._refineSetBlock=function(a,c){return u.resolve(a)};l.prototype._candidateIdTransform=function(a){return a};l.prototype._transformSetWithIdChanges=function(a){};l.prototype._getSet=function(a){var c=this;return null===
this._wset?this._ensureLoaded().then(function(){return c._getFilteredSet("",null,null,null,a)}).then(function(e){return c._wset=e}):u.resolve(this._wset)};l.prototype.nativeCapabilities=function(){return{title:this._layer.name,source:this,canQueryRelated:!0,capabilities:{query:{maxRecordCount:this._layer.maxRecordCount},queryRelated:{supportsOrderBy:this._layer.advancedQueryCapabilities&&this._layer.advancedQueryCapabilities.supportsAdvancedQueryRelated,supportsPagination:this._layer.advancedQueryCapabilities&&
this._layer.advancedQueryCapabilities.supportsQueryRelatedPagination}},databaseType:this._databaseType,requestStandardised:this._requestStandardised}};Object.defineProperty(l.prototype,"gdbVersion",{get:function(){return this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT"},enumerable:!1,configurable:!0});l.prototype._runDatabaseProbe=function(a){var c=this;return u.create(function(e,h){try{c._ensureLoaded().then(function(){try{var g=new C;g.where=a.replace("OBJECTID",c._layer.objectIdField);
c.executeQuery(g,"executeForIds").then(function(b){e(!0)},function(b){try{e(!1)}catch(f){h(f)}})}catch(b){h(b)}})}catch(g){h(g)}})};l.prototype.pbfSupportedForQuery=function(a){return this._layer._canFetchPBFForQuery(a)&&this._layer.supportsQuantizationEditMode};l.prototype.executeQuery=function(a,c){var e=new J(this._layerUrl()),h="execute"===c&&this.pbfSupportedForQuery(a);h&&(a.quantizationParameters={mode:"edit"});var g=null;if(this.recentlyUsedQueries){var b=this.convertQueryToLruCacheKey(a);
(g=this.recentlyUsedQueries.getFromCache(b))&&g.isRejected()&&(g=null,this.recentlyUsedQueries.removeFromCache(b));null===g&&(g=!0!==h?e[c](a):e[c](a,null,null,{format:"pbf"}),this.recentlyUsedQueries.addToCache(b,g))}null===g&&(g=!0!==h?e[c](a):e[c](a,null,null,{format:"pbf"}));return g};l.prototype._canUsePagination=function(){return void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsPagination?!0:!1};
l.prototype._cacheableFeatureSetSourceKey=function(){return this._layer.url};l.prototype._getFilteredSet=function(a,c,e,h,g){var b=this;return this.databaseType().then(function(f){if(b.isTable()&&c&&null!==a&&""!==a)return new H([],[],!0,null);if(b._canUsePagination())return b._getFilteredSetUsingPaging(a,c,e,h,g);var d="",m=!1;null!==h&&void 0!==b._layer.advancedQueryCapabilities&&null!==b._layer.advancedQueryCapabilities&&!0===b._layer.advancedQueryCapabilities.supportsOrderBy&&(d=h.constructClause(),
m=!0);var k=new C;b._requestStandardised&&(k.sqlFormat="standard");k.where=null===e?null===c?"1\x3d1":"":B.toWhereClause(e,f);k.spatialRelationship=b._makeRelationshipEnum(a);k.outSpatialReference=b.spatialReference;k.orderByFields=""!==d?d.split(","):null;k.geometry=null===c?"":c;k.relationParam=b._makeRelationshipParam(a);return b.executeQuery(k,"executeForIds").then(function(n){null===n&&(n=[]);b._checkCancelled(g);return new H([],n,m,null)})})};l.prototype._expandPagedSet=function(a,c,e,h,g){return this._expandPagedSetFeatureSet(a,
c,e,h,g)};l.prototype._getFilteredSetUsingPaging=function(a,c,e,h,g){var b=this;try{var f="",d=!1;null!==h&&void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsOrderBy&&(f=h.constructClause(),d=!0);return this.databaseType().then(function(m){m=null===e?null===c?"1\x3d1":"":B.toWhereClause(e,m);b._layer.getDefinitionExpression()&&b._useDefinitionExpression&&(m=""!==m?"(("+b._layer.getDefinitionExpression()+
") AND ("+m+"))":b._layer.getDefinitionExpression());var k=b._maxQueryRate();void 0!==b._layer.maxRecordCount&&b._layer.maxRecordCount<k&&(k=b._layer.maxRecordCount);var n=null;if(!0===b._pageJustIds)n=new H([],["GETPAGES"],d,{spatialRel:b._makeRelationshipEnum(a),relationParam:b._makeRelationshipParam(a),outFields:b._layer.objectIdField,resultRecordCount:k,resultOffset:0,geometry:null===c?"":c,where:m,orderByFields:f,returnGeometry:"false",returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,fullyResolved:!1}});
else{var r=!0;!0===b._removeGeometry&&(r=!1);var p=null!==b._overrideFields?b._overrideFields:b._fieldsIncludingObjectId(b._layer.getOutFields());n=new H([],["GETPAGES"],d,{spatialRel:b._makeRelationshipEnum(a),relationParam:b._makeRelationshipParam(a),outFields:p.join(","),resultRecordCount:k,resultOffset:0,geometry:null===c?"":c,where:m,orderByFields:f,returnGeometry:r,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,fullyResolved:!1}})}return b._expandPagedSet(n,k,0,1,g).then(function(q){return n})})}catch(m){return u.reject(m)}};
l.prototype._clonePageDefinition=function(a){return null===a?null:!0!==a.groupbypage?{groupbypage:!1,spatialRel:a.spatialRel,relationParam:a.relationParam,outFields:a.outFields,resultRecordCount:a.resultRecordCount,resultOffset:a.resultOffset,geometry:a.geometry,where:a.where,orderByFields:a.orderByFields,returnGeometry:a.returnGeometry,returnIdsOnly:a.returnIdsOnly,internal:a.internal}:{groupbypage:!0,spatialRel:a.spatialRel,relationParam:a.relationParam,outFields:a.outFields,resultRecordCount:a.resultRecordCount,
useOIDpagination:a.useOIDpagination,generatedOid:a.generatedOid,groupByFieldsForStatistics:a.groupByFieldsForStatistics,resultOffset:a.resultOffset,outStatistics:a.outStatistics,geometry:a.geometry,where:a.where,orderByFields:a.orderByFields,returnGeometry:a.returnGeometry,returnIdsOnly:a.returnIdsOnly,internal:a.internal}};l.prototype._getPhysicalPage=function(a,c,e){var h=this;try{var g=a.pagesDefinition.internal.lastRetrieved,b=new C;this._requestStandardised&&(b.sqlFormat="standard");b.spatialRelationship=
a.pagesDefinition.spatialRel;b.relationParam=a.pagesDefinition.relationParam;b.outFields=a.pagesDefinition.outFields.split(",");b.num=a.pagesDefinition.resultRecordCount;b.start=a.pagesDefinition.internal.lastRetrieved;b.geometry=a.pagesDefinition.geometry;b.where=a.pagesDefinition.where;b.orderByFields=""!==a.pagesDefinition.orderByFields?a.pagesDefinition.orderByFields.split(","):null;b.returnGeometry=a.pagesDefinition.returnGeometry;b.outSpatialReference=this.spatialReference;return this.executeQuery(b,
"execute").then(function(f){h._checkCancelled(e);if(a.pagesDefinition.internal.lastRetrieved!==g)return"done";for(var d=0;d<f.features.length;d++)void 0===f.features[d].geometry&&(f.features[d].geometry=null),a.pagesDefinition.internal.set[g+d]=f.features[d].attributes[h._layer.objectIdField];if(!1===h._pageJustIds)for(d=0;d<f.features.length;d++)h._featureCache[f.features[d].attributes[h._layer.objectIdField]]=f.features[d];f.features.length!==a.pagesDefinition.resultRecordCount&&(a.pagesDefinition.internal.fullyResolved=
!0);a.pagesDefinition.internal.lastRetrieved=g+a.pagesDefinition.resultRecordCount;return"done"})}catch(f){return u.reject(f)}};l.prototype._fieldsIncludingObjectId=function(a){if(null===a)return[this.objectIdField];a=a.slice(0);if(-1<a.indexOf("*"))return a;for(var c=!1,e=0;e<a.length;e++)if(a[e].toUpperCase()===this.objectIdField.toUpperCase()){c=!0;break}!1===c&&a.push(this.objectIdField);return a};l.prototype._getFeatures=function(a,c,e,h){var g=this,b=[];try{-1!==c&&void 0===this._featureCache[c]&&
b.push(c);if(!0===this._checkIfNeedToExpandKnownPage(a,this._maxProcessingRate()))return this._expandPagedSet(a,this._maxProcessingRate(),0,0,h).then(function(p){return g._getFeatures(a,c,e,h)});for(var f=0,d=a._lastFetchedIndex;d<a._known.length;d++){a._lastFetchedIndex+=1;f++;if(void 0===this._featureCache[a._known[d]]){var m=!1;if(null!==this._layer._mode&&void 0!==this._layer._mode){var k=this._layer._mode;if(void 0!==k._featureMap[a._known[d]]){var n=k._featureMap[a._known[d]];null!==n&&(m=!0,
this._featureCache[a._known[d]]=n)}}if(!1===m&&(a._known[d]!==c&&b.push(a._known[d]),b.length>=this._maxProcessingRate()-1))break}if(f>=e&&0===b.length)break}if(0===b.length)return u.resolve("success");try{var r=new C;this._requestStandardised&&(r.sqlFormat="standard");r.objectIds=b;r.outFields=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.getOutFields());r.returnGeometry=!0;!0===this._removeGeometry&&(r.returnGeometry=!1);r.outSpatialReference=this.spatialReference;
return this.executeQuery(r,"execute").then(function(p){g._checkCancelled(h);if(void 0!==p.error)return u.reject(Error(p.error));for(var q=0;q<p.features.length;q++)void 0===p.features[q].geometry&&(p.features[q].geometry=null),g._featureCache[p.features[q].attributes[g._layer.objectIdField]]=p.features[q];return"success"})}catch(p){return u.reject(p)}}catch(p){return u.reject(p)}};l.prototype._layerUrl=function(){return this._layer.url};l.prototype._getDistinctPages=function(a,c,e,h,g,b,f,d,m){var k=
this;return this._ensureLoaded().then(function(){for(var n=e.parseTree.column,r=0;r<k._layer.fields.length;r++)if(k._layer.fields[r].name.toLowerCase()===n.toLowerCase()){n=k._layer.fields[r].name;break}return k.databaseType().then(function(p){var q=new C;k._requestStandardised&&(q.sqlFormat="standard");p=null===b?null===g?"1\x3d1":"":B.toWhereClause(b,p);k._layer.getDefinitionExpression()&&k._useDefinitionExpression&&(p=""!==p?"(("+k._layer.getDefinitionExpression()+") AND ("+p+"))":k._layer.getDefinitionExpression());
q.where=p;q.spatialRelationship=k._makeRelationshipEnum(h);q.relationParam=k._makeRelationshipParam(h);q.geometry=null===g?null:g;q.returnDistinctValues=!0;q.returnGeometry=!1;q.outFields=[n];return k.executeQuery(q,"execute").then(function(t){k._checkCancelled(m);if(!t.hasOwnProperty("features"))return u.reject(Error("Unnexected Result querying statistics from layer"));for(var v=!1,w=0;w<k._layer.fields.length;w++)if(k._layer.fields[w].name===n){"esriFieldTypeDate"===k._layer.fields[w].type&&(v=
!0);break}for(w=0;w<t.features.length;w++){if(v){var D=t.features[w].attributes[n];null!==D?d.push(new Date(D)):d.push(D)}else d.push(t.features[w].attributes[n]);if(d.length>=f)break}return 0===t.features.length?d:t.features.length===k._layer.maxRecordCount&&d.length<f?k._getDistinctPages(a+t.features.length,c,e,h,g,b,f,d,m).then(function(S){return{calculated:!0,result:S}}):d})})})};l.prototype._distinctStat=function(a,c,e,h,g,b,f){return this._getDistinctPages(0,a,c,e,h,g,b,[],f).then(function(d){return{calculated:!0,
result:d}})};l.prototype.isTable=function(){return!1};l.prototype._countstat=function(a,c,e,h,g){var b=this;return this.databaseType().then(function(f){var d=new C;b._requestStandardised&&(d.sqlFormat="standard");if(b.isTable()&&e&&null!==c&&""!==c)return{calculated:!0,result:0};f=null===h?null===e?"1\x3d1":"":B.toWhereClause(h,f);b._layer.getDefinitionExpression()&&b._useDefinitionExpression&&(f=""!==f?"(("+b._layer.getDefinitionExpression()+") AND ("+f+"))":b._layer.getDefinitionExpression());d.where=
f;d.where=f;d.spatialRelationship=b._makeRelationshipEnum(c);d.relationParam=b._makeRelationshipParam(c);d.geometry=null===e?null:e;d.returnGeometry=!1;new J(b._layerUrl());return b.executeQuery(d,"executeForCount").then(function(m){return{calculated:!0,result:m}})})};l.prototype._stats=function(a,c,e,h,g,b,f){var d=this;return this._ensureLoaded().then(function(){var m=d._layer.advancedQueryCapabilities&&!0===d._layer.advancedQueryCapabilities.supportsSqlExpression,k=d._layer.advancedQueryCapabilities&&
!0===d._layer.advancedQueryCapabilities.supportsStatistics,n=d._layer.advancedQueryCapabilities&&!0===d._layer.advancedQueryCapabilities.supportsDistinct;return"count"===a?n?d._countstat(a,e,h,g,f):{calculated:!1}:!1===k||!1===B.isSingleField(c)&&!1===m||!1===c.isStandardized?""!==e||null!==g?{calculated:!1}:d._manualStat(a,c,b,f):"distinct"===a?!1===n?""!==e||null!==g?{calculated:!1}:d._manualStat(a,c,b,f):d._distinctStat(a,c,e,h,g,b,f):d.databaseType().then(function(r){if(d.isTable()&&h&&null!==
e&&""!==e)return{calculated:!0,result:null};var p=new C;d._requestStandardised&&(p.sqlFormat="standard");var q=null===g?null===h?"1\x3d1":"":B.toWhereClause(g,r);d._layer.getDefinitionExpression()&&d._useDefinitionExpression&&(q=""!==q?"(("+d._layer.getDefinitionExpression()+") AND ("+q+"))":d._layer.getDefinitionExpression());p.where=q;p.spatialRelationship=d._makeRelationshipEnum(e);p.relationParam=d._makeRelationshipParam(e);p.geometry=null===h?null:h;q=new K;q.statisticType=O.decodeStatType(a);
q.onStatisticField=B.toWhereClause(c,r);var t=q.outStatisticFieldName="ARCADE_STAT_RESULT";p.returnGeometry=!1;p.outStatistics=[q];return d.executeQuery(p,"execute").then(function(v){if(!v.hasOwnProperty("features")||0===v.features.length)return u.reject(Error("Unnexected Result querying statistics from layer"));for(var w=!1,D=0;D<v.fields.length;D++)if("ARCADE_STAT_RESULT"===v.fields[D].name.toUpperCase()){t=v.fields[D].name;"esriFieldTypeDate"===v.fields[D].type&&(w=!0);break}return w?(w=v.features[0].attributes[t],
null!==w&&(w=new Date(v.features[0].attributes[t])),{calculated:!0,result:w}):{calculated:!0,result:v.features[0].attributes[t]}})})})};l.prototype._stat=function(a,c,e,h,g,b,f){return this._stats(a,c,e,h,g,b,f)};l.prototype._canDoAggregates=function(a,c,e,h,g){var b=this;return this._ensureLoaded().then(function(f){f=!1;var d=b._layer.advancedQueryCapabilities&&!0===b._layer.advancedQueryCapabilities.supportsSqlExpression;void 0!==b._layer.advancedQueryCapabilities&&null!==b._layer.advancedQueryCapabilities&&
!0===b._layer.advancedQueryCapabilities.supportsStatistics&&!0===b._layer.advancedQueryCapabilities.supportsOrderBy&&(f=!0);if(f)for(var m=0;m<c.length-1;m++)null!==c[m].workingexpr&&(!1===c[m].workingexpr.isStandardized?f=!1:!1===B.isSingleField(c[m].workingexpr)&&!1===d&&(f=!1));return!1===f?!1:!0})};l.prototype._makeRelationshipEnum=function(a){return 0<=a.indexOf("esriSpatialRelRelation")?"esriSpatialRelRelation":a};l.prototype._makeRelationshipParam=function(a){return 0<=a.indexOf("esriSpatialRelRelation")?
a.split(":")[1]:""};l.prototype._getAggregatePagesDataSourceDefinition=function(a,c,e,h,g,b,f){var d=this;return this._ensureLoaded().then(function(m){return d.databaseType().then(function(k){var n="",r=!1,p=!1;null!==b&&void 0!==d._layer.advancedQueryCapabilities&&null!==d._layer.advancedQueryCapabilities&&!0===d._layer.advancedQueryCapabilities.supportsOrderBy&&(n=b.constructClause(),p=!0);void 0!==d._layer.advancedQueryCapabilities&&null!==d._layer.advancedQueryCapabilities&&!1===d._layer.advancedQueryCapabilities.supportsPagination&&
(p=!1,r=!0,n=d._layer.objectIdField);for(var q=[],t=0;t<c.length;t++){var v=new K;v.onStatisticField=null!==c[t].workingexpr?B.toWhereClause(c[t].workingexpr,k):"";v.outStatisticFieldName=c[t].field;v.statisticType=c[t].toStatisticsName();q.push(v)}""===n&&(n=a.join(","));t=d._maxQueryRate();void 0!==d._layer.maxRecordCount&&d._layer.maxRecordCount<t&&(t=d._layer.maxRecordCount);k=null===g?null===h?"1\x3d1":"":B.toWhereClause(g,k);d._layer.getDefinitionExpression()&&d._useDefinitionExpression&&(k=
""!==k?"(("+d._layer.getDefinitionExpression()+") AND ("+k+"))":d._layer.getDefinitionExpression());return new H([],["GETPAGES"],p,{groupbypage:!0,spatialRel:d._makeRelationshipEnum(e),relationParam:d._makeRelationshipParam(e),outFields:["*"],useOIDpagination:r,generatedOid:f,resultRecordCount:t,resultOffset:0,groupByFieldsForStatistics:a,outStatistics:q,geometry:null===h?null:h,where:k,orderByFields:n,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,fullyResolved:!1}})})})};
l.prototype._getAgregagtePhysicalPage=function(a,c,e){var h=this;try{var g=a.pagesDefinition.where;!0===a.pagesDefinition.useOIDpagination&&(g=""!==g?"("+g+") AND ("+a.pagesDefinition.generatedOid+"\x3e"+a.pagesDefinition.internal.lastMaxId.toString()+")":a.pagesDefinition.generatedOid+"\x3e"+a.pagesDefinition.internal.lastMaxId.toString());var b=a.pagesDefinition.internal.lastRetrieved,f=new C;this._requestStandardised&&(f.sqlFormat="standard");f.where=g;f.spatialRelationship=a.pagesDefinition.spatialRel;
f.relationParam=a.pagesDefinition.relationParam;f.outFields=a.pagesDefinition.outFields;f.outStatistics=a.pagesDefinition.outStatistics;f.geometry=a.pagesDefinition.geometry;f.groupByFieldsForStatistics=a.pagesDefinition.groupByFieldsForStatistics;f.num=a.pagesDefinition.resultRecordCount;f.start=a.pagesDefinition.internal.lastRetrieved;f.returnGeometry=a.pagesDefinition.returnGeometry;f.orderByFields=""!==a.pagesDefinition.orderByFields?a.pagesDefinition.orderByFields.split(","):null;return this.isTable()&&
f.geometry&&f.spatialRelationship?u.resolve([]):this.executeQuery(f,"execute").then(function(d){h._checkCancelled(e);if(!d.hasOwnProperty("features"))return u.reject(Error("Unnexected Result querying aggregates from layer"));var m=[];if(a.pagesDefinition.internal.lastRetrieved!==b)return[];for(var k=0;k<d.features.length;k++)void 0===d.features[k].geometry&&(d.features[k].geometry=null),a.pagesDefinition.internal.set[b+k]=d.features[k].attributes[a.pagesDefinition.generatedOid];for(k=0;k<d.features.length;k++)m.push(new y({attributes:d.features[k].attributes,
geometry:null}));!0===a.pagesDefinition.useOIDpagination?0===d.features.length?a.pagesDefinition.internal.fullyResolved=!0:a.pagesDefinition.internal.lastMaxId=d.features[d.features.length-1].attributes[a.pagesDefinition.generatedOid]:d.features.length!==a.pagesDefinition.resultRecordCount&&(a.pagesDefinition.internal.fullyResolved=!0);a.pagesDefinition.internal.lastRetrieved=b+a.pagesDefinition.resultRecordCount;return m})}catch(d){return u.reject(d)}};l.create=function(a,c,e){a=new Q({url:a,outFields:null===
c?["*"]:c});return new l({layer:a,spatialReference:e})};l.prototype._queryAttachments=function(a){var c=this,e=__assign(__assign({},a),{f:"json"});0<e.objectIds.length&&(e.objectIds=e.objectIds.join(","));e.size&&(e.size=e.size.join(","));e.attachmentTypes&&(e.attachmentTypes=e.attachmentTypes.join(","));return u.create(function(h,g){I({url:c._layer._url.path+"/queryAttachments",content:e,callbackParamName:"callback",load:function(b){var f={};if(b&&b.attachmentGroups){var d=0;for(b=b.attachmentGroups;d<
b.length;d++){var m=b[d];void 0===f[m.parentObjectId]&&(f[m.parentObjectId]=[]);for(var k=0,n=m.attachmentInfos;k<n.length;k++){var r=n[k];f[m.parentObjectId].push({id:r.id,globalId:r.globalId,name:r.name,contentType:r.contentType,size:r.size,exifInfo:r.exifInfo?r.exifInfo:null})}}}h(f)},error:function(b){g(b)}})})};l.prototype.queryAttachments=function(a,c,e,h,g){var b=this;if(this._layer.hasAttachments){var f={objectIds:[a],returnMetadata:g};if(c&&0<c||e&&0<e)f.size=[c&&0<c?c:0,e&&0<e?e:c+1];h&&
0<h.length&&(f.attachmentTypes=h);return this._queryAttachments(f).then(function(d){var m=[];if(d&&d[a]){var k=b._layer._url.path;d[a].forEach(function(n){var r=k+"/"+a.toString()+"/attachments/"+n.id.toString(),p=null;g&&n.exifInfo&&(p=R.convertJsonToArcade(n.exifInfo,!0));m.push(new M(n.id,n.name,n.contentType,n.size,r,p))})}return m})}return u.resolve([])};l.prototype.serviceUrl=function(){return E.extractServiceUrl(this._layer._url.path)};l.prototype.relationshipMetaData=function(){return this._layer.relationships};
l.prototype.queryRelatedFeatures=function(a){var c=this,e={f:"json",relationshipId:a.relationshipId.toString(),definitionExpression:a.definitionExpression,outFields:a.outFields.join(","),returnGeometry:a.returnGeometry.toString()};void 0!==a.resultOffset&&null!==a.resultOffset&&(e.resultOffset=a.resultOffset.toString());void 0!==a.resultRecordCount&&null!==a.resultRecordCount&&(e.resultRecordCount=a.resultRecordCount.toString());a.orderByFields&&(e.orderByFields=a.orderByFields.join(","));0<a.objectIds.length&&
(e.objectIds=a.objectIds.join(","));a.outSpatialReference&&(e.outSR=JSON.stringify(a.outSpatialReference.toJson()));return u.create(function(h,g){I({url:c._layer._url.path+"/queryRelatedRecords",content:e,callbackParamName:"callback",load:function(b){var f={};if(b&&b.relatedRecordGroups)for(var d=b.spatialReference,m=0,k=b.relatedRecordGroups;m<k.length;m++){var n=k[m],r=n.objectId,p=[],q=0;for(n=n.relatedRecords;q<n.length;q++){var t=n[q];t.geometry&&(t.geometry.spatialReference=d);t=new y({geometry:t.geometry?
P.fromJson(t.geometry):null,attributes:t.attributes});p.push(t)}f[r]={features:p,exceededTransferLimit:!0===b.exceededTransferLimit}}h(f)},error:function(b){g(b)}})})};l.prototype.getFeatureByObjectId=function(a,c){var e=new J(this._layerUrl()),h=new C;h.outFields=c;h.returnGeometry=!1;h.outSpatialReference=this.spatialReference;h.where=this.objectIdField+"\x3d"+a.toString();return e.execute(h).then(function(g){return 1===g.features.length?g.features[0]:null})};l.prototype.getIdentityUser=function(){var a=
this;return this.load().then(function(){return u.resolve(G.findCredential(a._layer.url))}).then(function(c){return c?c.userId:null})};l.prototype.getOwningSystemUrl=function(){var a=this;return this.load().then(function(){var c=G.findServerInfo(a._layer.url);if(c)return u.resolve(c.owningSystemUrl);var e=a._layer.url;c=e.toLowerCase().indexOf("/rest/services");return(e=-1<c?e.substring(0,c):e)?(e+="/rest/info",u.create(function(h){I({url:e,content:{f:"json"},callbackParamName:"callback",load:function(g){var b=
"";g&&g.owningSystemUrl&&(b=g.owningSystemUrl);h(b)},error:function(g){h("")}})})):u.resolve("")})};l.prototype.getDataSourceFeatureSet=function(){var a=new l({layer:this._layer,spatialReference:this.spatialReference,outFields:this._overrideFields,includeGeometry:!this._removeGeometry,lrucache:this.recentlyUsedQueries,interceptor:this.featureSetQueryInterceptor});a._useDefinitionExpression=!1;return a};return l}(N)});