// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/arcgis/utils","require dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/Deferred dojo/_base/json dojo/_base/url dojo/on dojo/DeferredList dojo/dom-construct dojo/sniff dojox/gfx/_base ../kernel ../config ../Color ../lang ../request ../SpatialReference ../map ../urlUtils ../geometry/Point ../geometry/ScreenPoint ../geometry/Extent ../geometry/webMercatorUtils ../symbols/jsonUtils ../renderers/jsonUtils ../dijit/PopupTemplate ../dijit/Popup ../tasks/query ../tasks/GeometryService ../layers/ArcGISTiledMapServiceLayer ../layers/FeatureLayer dojo/i18n!../nls/jsapi".split(" "),
function(Q,w,n,A,z,R,tb,ca,K,ub,Mb,ya,G,da,vb,u,H,I,wb,ea,xb,za,L,Aa,M,O,Ba,yb,zb,Ab,Bb,B,fa){function ha(a){return!(!a||"BingMapsAerial"!==a.layerType&&"BingMapsAerial"!==a.type)}function ia(a){return!(!a||"BingMapsRoad"!==a.layerType&&"BingMapsRoad"!==a.type)}function S(a){return ha(a)||ia(a)||!(!a||"BingMapsHybrid"!==a.layerType&&"BingMapsHybrid"!==a.type)}function Ca(a){return!(!a||"OpenStreetMap"!==a.layerType&&"OpenStreetMap"!==a.type)}function P(a){return!!(a&&a.url&&(-1<"ArcGISFeatureLayer ArcGISImageServiceLayer ArcGISImageServiceVectorLayer ArcGISMapServiceLayer ArcGISStreamLayer ArcGISTiledImageServiceLayer ArcGISTiledMapServiceLayer".split(" ").indexOf(a.layerType)||
!a.layerType&&!a.type))}function N(a){return H({url:y.arcgisUrl+"/"+a.itemId+"/data",content:{f:"json"},callbackParamName:"callback"},{disableIdentityLookup:!0,_preLookup:!0})}function ja(a,f){var e={f:"json"};f&&(e.token=f);return H({url:a,content:e,callbackParamName:"callback"},{disableIdentityLookup:!0})}function ka(a){!a.layerDefinition||a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.labelingInfo||(a.showLabels=!1);a.itemProperties.layerDefinition&&(a.layerDefinition?(a.layerDefinition.drawingInfo||
(a.layerDefinition.drawingInfo=a.itemProperties.layerDefinition.drawingInfo),u.isDefined(a.layerDefinition.definitionExpression)||(a.layerDefinition.definitionExpression=a.itemProperties.layerDefinition.definitionExpression),u.isDefined(a.layerDefinition.minScale)||(a.layerDefinition.minScale=a.itemProperties.layerDefinition.minScale),u.isDefined(a.layerDefinition.maxScale)||(a.layerDefinition.maxScale=a.itemProperties.layerDefinition.maxScale)):a.layerDefinition=a.itemProperties.layerDefinition);
!a.itemProperties.popupInfo||a.popupInfo||a.disablePopup||(a.popupInfo=a.itemProperties.popupInfo);u.isDefined(a.itemProperties.showLabels)&&!u.isDefined(a.showLabels)&&(a.showLabels=a.itemProperties.showLabels);u.isDefined(a.itemProperties.showLegend)&&!u.isDefined(a.showLegend)&&(a.showLegend=a.itemProperties.showLegend);u.isDefined(a.itemProperties.refreshInterval)&&!u.isDefined(a.refreshInterval)&&(a.refreshInterval=a.itemProperties.refreshInterval)}function Da(a){ka(a);a.itemProperties.layerDefinition&&
a.layerDefinition&&(!u.isDefined(a.layerDefinition.maximumTrackPoints)&&u.isDefined(a.itemProperties.layerDefinition.maximumTrackPoints)&&(a.layerDefinition.maximumTrackPoints=a.itemProperties.layerDefinition.maximumTrackPoints),!a.layerDefinition.definitionGeometry&&a.itemProperties.layerDefinition.definitionGeometry&&(a.layerDefinition.definitionGeometry=a.itemProperties.layerDefinition.definitionGeometry));a.itemProperties.purgeOptions&&!a.purgeOptions&&(a.purgeOptions=a.itemProperties.purgeOptions)}
function T(a,f){var e=new z;f=a.itemData;var b=[],c=[];n.forEach(f.operationalLayers,function(g){if(g.itemId&&P(g)){var d=g.url.toLowerCase();-1<d.indexOf("/featureserver")||-1<d.indexOf("/mapserver/")?(c.push(g),b.push(N(g))):-1<d.indexOf("/mapserver")&&-1===d.indexOf("/mapserver/")&&(!g.layers||!u.isDefined(g.minScale)&&!u.isDefined(g.maxScale))?(c.push(g),b.push(N(g))):-1<d.indexOf("/imageserver")?(c.push(g),b.push(N(g))):-1<d.indexOf("/streamserver")&&(c.push(g),b.push(N(g)))}});f.baseMap&&f.baseMap.baseMapLayers&&
n.forEach(f.baseMap.baseMapLayers,function(g){g.itemId&&"VectorTileLayer"!==g.layerType&&(c.push(g),b.push(N(g)))});if(0<b.length){var h={};(new K(b)).addCallback(function(g){n.forEach(c,function(d,k){if((k=g[k][1])&&!(k instanceof Error)&&(h[d.itemId]=k,P(d))){var l=d.url.toLowerCase();(-1<l.indexOf("/featureserver")||-1<l.indexOf("/mapserver/"))&&k.layers?n.forEach(k.layers,function(p){var t="/featureserver/"+p.id;(t=l.match(t+"$")==t)||(t="/mapserver/"+p.id,t=l.match(t+"$")==t);t&&(d.itemProperties=
p,ka(d))}):-1<l.indexOf("/streamserver")?(d.itemProperties=k,Da(d)):-1<l.indexOf("/mapserver")?(k.layers&&!d.layers&&(d.layers=k.layers),u.isDefined(k.minScale)&&!u.isDefined(d.minScale)&&(d.minScale=k.minScale),u.isDefined(k.maxScale)&&!u.isDefined(d.maxScale)&&(d.maxScale=k.maxScale),u.isDefined(k.refreshInterval)&&!u.isDefined(d.refreshInterval)&&(d.refreshInterval=k.refreshInterval),k.visibleLayers&&!d.visibleLayers&&(d.visibleLayers=k.visibleLayers)):-1<l.indexOf("/imageserver")&&(u.isDefined(k.minScale)&&
!u.isDefined(d.minScale)&&(d.minScale=k.minScale),u.isDefined(k.maxScale)&&!u.isDefined(d.maxScale)&&(d.maxScale=k.maxScale),u.isDefined(k.refreshInterval)&&!u.isDefined(d.refreshInterval)&&(d.refreshInterval=k.refreshInterval),!k.popupInfo||d.popupInfo||d.disablePopup||(d.popupInfo=k.popupInfo),k.renderingRule&&!d.renderingRule&&(d.renderingRule=k.renderingRule,k.renderingRule.functionName&&(d.renderingRule.rasterFunction=k.renderingRule.functionName)),k.bandIds&&!d.bandIds&&(d.bandIds=k.bandIds),
k.mosaicRule&&!d.mosaicRule&&(d.mosaicRule=k.mosaicRule),k.format&&!d.format&&(d.format=k.format),u.isDefined(k.compressionQuality)&&!u.isDefined(d.compressionQuality)&&(d.compressionQuality=k.compressionQuality),!k.layerDefinition||!k.layerDefinition.definitionExpression||u.isDefined(d.layerDefinition)&&u.isDefined(d.layerDefinition.definitionExpression)||(d.layerDefinition=d.layerDefinition||{},d.layerDefinition.definitionExpression=k.layerDefinition.definitionExpression),k=w.getObject("layerDefinition.drawingInfo.renderer",
!1,k),null==w.getObject("layerDefinition.drawingInfo.renderer",!1,d)&&null!=k&&(d.layerDefinition=d.layerDefinition||{},d.layerDefinition.drawingInfo=d.layerDefinition.drawingInfo||{},d.layerDefinition.drawingInfo.renderer=k))}});a.relatedItemsData=h;e.callback(a)})}else e.callback(a);return e}function Cb(a,f){var e=new z,b=a.itemData,c=b.baseMap.baseMapLayers[0];if(S(c))if(c.portalUrl&&G.id)delete f.bingMapsKey,G.id.checkSignInStatus(ea.urlToObject(y.arcgisUrl).path).then(w.hitch(null,function(g,
d,k,l,p){ja(c.portalUrl,p.token).then(w.hitch(null,la,g,d,k,l),w.hitch(null,U,g,d,k,l))},a,f,b,e),w.hitch(null,function(g,d,k,l,p){ja(c.portalUrl).then(w.hitch(null,la,g,d,k,l),w.hitch(null,U,g,d,k,l))},a,f,b,e));else if(f.bingMapsKey){var h=new E({bingMapsKey:f.bingMapsKey,mapStyle:E.MAP_STYLE_AERIAL});A.connect(h,"onLoad",w.hitch(this,function(){e.callback([a,f])}));A.connect(h,"onError",function(g){delete f.bingMapsKey;a.itemData=V(b);c=a.itemData.baseMap.baseMapLayers[0];c.errors=[];c.errors.push({message:"The owner of the application has not provided a valid Bing Key for the Bing Map it includes. Switching to Esri layers."});
e.callback([a,f])})}else a.itemData=V(b),c=a.itemData.baseMap.baseMapLayers[0],c.errors=[],c.errors.push({message:"The owner of the application has not provided a Bing Key for the Bing Map it includes. Switching to Esri layers."}),e.callback([a,f]);else e.callback([a,f]);return e}function Db(a){var f=new z;a=a.itemData;var e=a.baseMap&&a.baseMap.baseMapLayers;if(W&&!W.supported())for(a=0;a<e.length;a++){var b=e[a];if(!b.isReference){if("VectorTileLayer"===b.layerType){var c=b.itemId;var h=a}break}}c?
ma(c,!1).addBoth(function(g){var d=/^https?:\/\/basemaps(dev)?\.arcgis\.com\/arcgis\/rest\/services\/World_Basemap\/VectorTileServer/i;g&&g.item&&d.test(g.item.url)&&(e[h]={id:"FB_"+b.id,layerType:"ArcGISTiledMapServiceLayer",opacity:"opacity"in b?b.opacity:1,visibility:"visibility"in b?b.visibility:!0,url:"https://services.arcgisonline.com/arcgis/rest/services/World_Street_Map/MapServer"});f.resolve()}):f.resolve();return f}function la(a,f,e,b,c){c.bingKey?(f.bingMapsKey=c.bingKey,c=new E({bingMapsKey:f.bingMapsKey,
mapStyle:E.MAP_STYLE_AERIAL}),A.connect(c,"onLoad",w.hitch(this,function(){b.callback([a,f])})),A.connect(c,"onError",function(h){delete f.bingMapsKey;a.itemData=V(e);h=a.itemData.baseMap.baseMapLayers[0];h.errors=[];h.errors.push({message:"The owner of the map has not provided a valid Bing Key for the Bing Map it includes. Switching to Esri layers."});b.callback([a,f])})):U(a,f,e,b)}function U(a,f,e,b){delete f.bingMapsKey;a.itemData=V(e);e=a.itemData.baseMap.baseMapLayers[0];e.errors=[];e.errors.push({message:"The owner of the map has not provided a Bing Key for the Bing Map it includes. Switching to Esri layers."});
b.callback([a,f])}function V(a){ha(a.baseMap.baseMapLayers[0])?a.baseMap={title:"Imagery",baseMapLayers:[{id:"World_Imagery_2017",visibility:!0,opacity:1,url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"}]}:ia(a.baseMap.baseMapLayers[0])?a.baseMap={title:"Streets",baseMapLayers:[{id:"World_Street_Map_8421",opacity:1,visibility:!0,url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer"}]}:a.baseMap={title:"Imagery with Labels",baseMapLayers:[{id:"World_Imagery_6611",
opacity:1,visibility:!0,url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"},{id:"World_Boundaries_and_Places_1145",isReference:!0,opacity:1,visibility:!0,url:"https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer"}]};return a}function na(a,f,e,b){var c=a.dynamicLayerInfos||a.layerInfos,h=f.layers;if(h&&c)if(b.usePopupManager){var g;n.forEach(c,function(r){var q=r.id;if(!r.subLayerIds)for(r=0;r<h.length;r++){var v=h[r];
if(v.id===q&&v.popupInfo&&!v.disablePopup){g||(g={});g[q]={infoTemplate:new e(v.popupInfo),layerUrl:v.layerUrl};break}}});g&&a.setInfoTemplates(g)}else{var d=[],k=[],l=[],p=[],t=[],m=[];n.forEach(c,function(r){var q=r.id;if(!r.subLayerIds&&-1!==n.indexOf(a.visibleLayers,q))for(r=0;r<h.length;r++){var v=h[r];if(v.id===q){k.push(q);d.push(v.popupInfo);l.push(v.layerUrl||"");v.layerDefinition&&v.layerDefinition.definitionExpression?p.push(v.layerDefinition.definitionExpression):p.push("");t.push(u.isDefined(v.minScale)?
v.minScale:null);m.push(u.isDefined(v.maxScale)?v.maxScale:null);break}}});d.length&&(a.__popups=d,a.__popupIds=k,a.__popupUrls=l,a.__popupWhereClauses=p,a.__popupMinScales=t,a.__popupMaxScales=m,a.__resourceInfo=f.resourceInfo)}}function Ea(a){if(!a)return!1;var f=(new tb(y.arcgisUrl)).authority;return-1!==a.indexOf(".arcgis.com/")||-1!==a.indexOf(f)}function Fa(a){return a?-1!==a.indexOf("/services.arcgisonline.com/")||-1!==a.indexOf("/server.arcgisonline.com/"):!1}function D(a){"https:"===location.protocol&&
(Ea(a)||Fa(a))&&(a=a.replace("http:","https:"));return a}function oa(a,f,e){var b=[];a.displayLevels||(b=n.map(a.resourceInfo.tileInfo.lods,function(g){return g.level}));if(a.exclusionAreas){var c=w.clone(a.exclusionAreas);c=n.map(c,function(g){g.geometry=new L(g.geometry);return g})}var h=a.resourceInfo&&"Raster"===a.resourceInfo.cacheType;h?(b=a.layerDefinition&&a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer,b=new Ga(D(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,
visible:a.visibility,id:a.id,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval,multidimensionalDefinition:a.multidimensionalDefinition,bandIds:a.bandIds,renderer:b||null})):b=new Bb(D(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,displayLevels:a.displayLevels||b,id:a.id,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval,exclusionAreas:c});e.ignorePopups||(h&&a.popupInfo&&!a.disablePopup?b.setInfoTemplate(new f(a.popupInfo)):
na(b,a,f,e));return b}function pa(a,f){if(!a||!f||0===f.length)return[];f=","+f+",";var e=[],b,c=",";for(b=0;b<a.length;b++)if(null!==a[b].subLayerIds){if(-1===f.indexOf(","+a[b].id+",")||-1<c.indexOf(","+a[b].id+","))c+=a[b].subLayerIds.toString()+","}else-1<f.indexOf(","+a[b].id+",")&&-1===c.indexOf(","+a[b].id+",")&&e.push(a[b].id);return e}function Ha(a,f,e){var b=new Ia;b.format="png24";a.resourceInfo&&a.resourceInfo.supportedImageFormatTypes&&-1<a.resourceInfo.supportedImageFormatTypes.indexOf("PNG32")&&
(b.format="png32");b=new Ja(D(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,imageParameters:b,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval});var c=a.visibleLayers;if(!a.visibleLayers){var h="";n.forEach(b.layerInfos,function(m){m.defaultVisibility&&(h+=(0<h.length?",":"")+m.id)});c=h}if(a.layers&&0<a.layers.length){var g=[],d=[],k,l=[],p,t;n.forEach(a.layers,function(m){var r=m.layerDefinition;r&&r.definitionExpression&&(g[m.id]=r.definitionExpression);
if(r&&r.source){k=null;t=r.source;if("mapLayer"===t.type){var q=n.filter(a.resourceInfo.layers,function(v){return v.id===t.mapLayerId});q.length&&(k=w.mixin(q[0],m))}else k=w.mixin({},m);k&&(k.source=t,delete k.popupInfo,k=new Ka(k),a.visibleLayers&&(q="string"==typeof a.visibleLayers?a.visibleLayers.split(","):a.visibleLayers,-1<n.indexOf(q,m.id)?k.defaultVisibility=!0:k.defaultVisibility=!1),d.push(k))}r&&null!=r.transparency&&(q=r.drawingInfo||{},null==q.transparency&&(q.transparency=r.transparency,
r.drawingInfo=q));r&&r.source&&r.drawingInfo&&(p=new La(r.drawingInfo),l[m.id]=p)},this);0<g.length&&b.setLayerDefinitions(g);0<d.length?(b.setDynamicLayerInfos(d,!0),0<l.length&&b.setLayerDrawingOptions(l,!0)):(c=pa(b.layerInfos,c),b.setVisibleLayers(c))}else c=pa(b.layerInfos,c),b.setVisibleLayers(c);e.ignorePopups||na(b,a,f,e);return b}function Eb(a,f,e){var b=new Ma;b.bandIds=a.bandIds;null!=a.format&&(b.format=a.format,null!=a.compressionQuality&&(b.compressionQuality=a.compressionQuality));
if(a.renderingRule&&a.renderingRule.rasterFunction){var c=new Na(a.renderingRule);b.renderingRule=c}a.mosaicRule&&(c=new Oa(a.mosaicRule),b.mosaicRule=c);u.isDefined(a.noData)&&(b.noData=a.noData);u.isDefined(a.noDataInterpretation)&&(b.noDataInterpretation=a.noDataInterpretation);u.isDefined(a.interpolation)&&(b.interpolation=a.interpolation);c=a.layerType?"ArcGISImageServiceVectorLayer"===a.layerType:!1;u.isDefined(a.layerType)||(c=a.resourceInfo.hasMultidimensions&&("esriImageServiceDataTypeVector-UV"===
a.resourceInfo.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===a.resourceInfo.serviceDataType));b={resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,imageServiceParameters:b,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval};b=c?new Pa(D(a.url),b):new Qa(D(a.url),b);a.layerDefinition&&(a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer&&(c=O.fromJson(a.layerDefinition.drawingInfo.renderer),b.setRenderer(c)),a.layerDefinition.definitionExpression&&
b.setDefinitionExpression(a.layerDefinition.definitionExpression,!0));e.ignorePopups||!a.popupInfo||a.disablePopup||b.setInfoTemplate(new f(a.popupInfo));return b}function qa(a,f,e){var b=[102113,102100,3857],c=e||new I(f[0].layerObject.fullExtent.spatialReference),h=new I(a.resourceInfo.fullExtent.spatialReference);return c.wkt==h.wkt&&(c.wkid==h.wkid||u.isDefined(c.latestWkid)&&c.latestWkid==h.wkid||u.isDefined(h.latestWkid)&&c.wkid==h.latestWkid||u.isDefined(c.latestWkid)&&c.latestWkid==h.latestWkid)||
c.wkid&&h.wkid&&n.some(b,function(g){return g===h.wkid})&&n.some(b,function(g){return g===c.wkid})?!0:!1}function ra(a,f,e){if(!f[0].layerObject.tileInfo)return!1;a=a.resourceInfo.tileInfo;f=f[0].layerObject.tileInfo;e=e.width>e.height?e.width:e.height;for(var b=!1,c=!1,h=0;h<a.lods.length;h++){for(var g=a.lods[h].scale/a.dpi,d=0;d<f.lods.length;d++){var k=f.lods[d].scale/f.dpi;if(Math.abs(k-g)/k<1/e)if(b){c=!0;break}else b=!0}if(c)break}return c||b&&(1===a.lods.length||1===f.lods.length)?!0:!1}function Ra(a,
f,e,b,c,h){var g=e._clazz;if(Ca(a))var d=new Sa({id:a.id,opacity:a.opacity,visible:null!==a.visibility&&void 0!==a.visibility?a.visibility:!0});else if(a&&("WFS"===a.layerType||"WFS"===a.type)){var k={customParameters:a.wfsInfo.customParameters,geometryType:a.layerDefinition.geometryType,id:a.id,labelingInfo:a.layerDefinition.drawingInfo.labelingInfo,maxFeatures:a.wfsInfo.maxFeatures,mode:a.mode,name:a.wfsInfo.name,showLabels:!0,swapXY:a.wfsInfo.swapXY,title:a.title,url:a.url,version:a.wfsInfo.version,
visible:a.visibility,wkid:a.layerDefinition.spatialReference.wkid};d=new Ta;d.fromJson(k,function(){u.isDefined(a.opacity)&&d.setOpacity(a.opacity);u.isDefined(a.visibility)&&d.setVisibility(a.visibility);(a.minScale||a.maxScale)&&d.setScaleRange(a.minScale,a.maxScale);d.renderer=O.fromJson(a.layerDefinition.drawingInfo.renderer,{geometryType:k.geometryType});!e.ignorePopups&&a.popupInfo&&d.setInfoTemplate(new g(a.popupInfo));d.emit("fromJsonComplete")})}else if(a&&("WMS"===a.layerType||"WMS"===a.type)){var l=
[],p=[];n.forEach(a.layers,function(q){p.push(new Ua({name:q.name,title:q.title,legendURL:q.legendURL||q.legendUrl,queryable:q.queryable,showPopup:q.showPopup}));l.push(q.name)},this);a.visibleLayers&&(l=a.visibleLayers);b=new L(a.extent[0][0],a.extent[0][1],a.extent[1][0],a.extent[1][1],new I({wkid:4326}));b={customLayerParameters:a.customLayerParameters,customParameters:a.customParameters,extent:b,layerInfos:p,version:a.version,maxWidth:a.maxWidth,maxHeight:a.maxHeight,featureInfoFormat:a.featureInfoFormat,
getFeatureInfoURL:a.featureInfoUrl,getMapURL:a.mapUrl,spatialReferences:a.spatialReferences,title:a.title,copyright:a.copyright,minScale:a.minScale||0,maxScale:a.maxScale||0,format:a.format};d=new Va(a.url,{id:a.id,visibleLayers:l,format:"png",transparent:a.firstLayer?!1:!0,opacity:a.opacity,visible:null!==a.visibility?a.visibility:!0,resourceInfo:b,refreshInterval:a.refreshInterval});d.spatialReference.wkid=b.spatialReferences[0]}else if(a&&("KML"===a.layerType||"KML"===a.type)){var t=a.url;if(G.id){var m=
G.id.findCredential(ea.urlToObject(y.arcgisUrl).path);m&&(f=y.arcgisUrl.substring(y.arcgisUrl.indexOf("//")+2,y.arcgisUrl.indexOf("/",y.arcgisUrl.indexOf("//")+3)),c=f.split("."),c=c[c.length-2]+"."+c[c.length-1],h=t.indexOf(c),-1<h&&(t="https://"+f+t.substring(h+c.length),t+="?token\x3d"+m.token))}d=new Wa(t,{id:a.id,visible:null!==a.visibility?a.visibility:!0,outSR:b,refreshInterval:a.refreshInterval});A.connect(d,"onLoad",function(){(a.opacity||0===a.opacity)&&d.setOpacity(a.opacity);u.isDefined(a.minScale)&&
u.isDefined(a.maxScale)&&d.setScaleRange(a.minScale,a.maxScale);a.visibleFolders&&n.forEach(d.folders,function(q){-1<n.indexOf(a.visibleFolders,q.id)?d.setFolderVisibility(q,!0):d.setFolderVisibility(q,!1)},this)})}else if(!a||"WebTiledLayer"!==a.layerType&&"WebTiledLayer"!==a.type)if(!a||"GeoRSS"!==a.layerType&&"GeoRSS"!==a.type)if(a&&("CSV"===a.layerType||"CSV"===a.type)&&a.url)b={layerDefinition:a.layerDefinition,columnDelimiter:a.columnDelimiter,id:a.id?a.id:null,visible:null!==a.visibility?a.visibility:
!0,opacity:a.opacity,refreshInterval:a.refreshInterval},a.locationInfo&&(b.latitudeFieldName=a.locationInfo.latitudeFieldName,b.longitudeFieldName=a.locationInfo.longitudeFieldName),!e.ignorePopups&&a.popupInfo&&(b.infoTemplate=new g(a.popupInfo)),d=new $a(a.url,b);else if("VectorTileLayer"!==a.layerType||!a.styleUrl||a.resourceInfo&&a.resourceInfo instanceof Error)if(a.layerDefinition&&!a.url)b=R.fromJson(R.toJson(a)),delete b.id,delete b.opacity,delete b.visibility,d=new B(b,{id:a.id,opacity:a.opacity,
visible:a.visibility,outFields:["*"],autoGeneralize:!0}),e.ignorePopups||!b.popupInfo||b.disablePopup||d.setInfoTemplate(new g(b.popupInfo)),ab(d);else if(S(a))e.bingMapsKey?(b=E.MAP_STYLE_AERIAL_WITH_LABELS,ha(a)?b=E.MAP_STYLE_AERIAL:ia(a)&&(b=E.MAP_STYLE_ROAD),d=new E({bingMapsKey:e.bingMapsKey,mapStyle:b,opacity:a.opacity,id:a.id}),A.connect(d,"onError",w.hitch(this,function(q){q.errors=q.errors||[];q.errors.push({message:"This application does not have a valid Bing Key for the Bing layer that is included in this map. [type:"+
(q?q.layerType||q.type:"")+"]"})},a))):(a.errors=a.errors||[],a.errors.push({message:"This application does not provide a Bing Key for the Bing layer that is included in this map. [type:"+(a?a.layerType||a.type:"")+"]"}));else if(a.resourceInfo&&(a.resourceInfo.mapName||""===a.resourceInfo.mapName))d=!0===a.resourceInfo.singleFusedMapCache&&(a.baseMapLayer||qa(a,f,b)&&ra(a,c,h))?oa(a,g,e):Ha(a,g,e);else if(a.resourceInfo&&a.resourceInfo.pixelSizeX)d=!0===a.resourceInfo.singleFusedMapCache&&"ArcGISImageServiceLayer"!==
a.layerType&&(a.baseMapLayer||"Raster"===a.resourceInfo.cacheType||qa(a,f,b)&&ra(a,c,h))?oa(a,g,e):Eb(a,g,e);else if(a.resourceInfo&&"Feature Layer"===a.resourceInfo.type){a.capabilities&&(a.resourceInfo.capabilities=a.capabilities);var r;!1===e.editable?r=!1:e.privileges&&-1===n.indexOf(e.privileges,"features:user:edit")&&G.id&&G.id.findCredential(a.url)&&(r=!1);d=new B(D(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,mode:a.mode===B.MODE_SELECTION?B.MODE_SELECTION:
B.MODE_AUTO,editable:r,outFields:["*"],autoGeneralize:!0,refreshInterval:a.refreshInterval});e.ignorePopups||!a.popupInfo||a.disablePopup||d.setInfoTemplate(new g(a.popupInfo));a.layerDefinition&&(a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer&&(b=O.fromJson(a.layerDefinition.drawingInfo.renderer,{geometryType:d.geometryType}),b.isMaxInclusive=!0,d.setRenderer(b)),a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.labelingInfo&&(b=n.map(a.layerDefinition.drawingInfo.labelingInfo,
function(q){return new sa(q)}),d.setLabelingInfo(b)),a.layerDefinition.definitionExpression&&d.setDefinitionExpression(a.layerDefinition.definitionExpression),u.isDefined(a.layerDefinition.minScale)&&d.setMinScale(a.layerDefinition.minScale),u.isDefined(a.layerDefinition.maxScale)&&d.setMaxScale(a.layerDefinition.maxScale));ab(d)}else a.resourceInfo&&a.resourceInfo.streamUrls&&(b={resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id},a.layerDefinition&&(t=a.layerDefinition.drawingInfo,
a.layerDefinition.definitionGeometry&&(m=m||{},m.geometry=a.layerDefinition.definitionGeometry),u.isDefined(a.layerDefinition.definitionExpression)&&(m=m||{},m.where=a.layerDefinition.definitionExpression),u.isDefined(a.layerDefinition.maximumTrackPoints)&&(b.maximumTrackPoints=a.layerDefinition.maximumTrackPoints)),m&&(b.filter=m),a.purgeOptions&&(b.purgeOptions=a.purgeOptions),d=new bb(D(a.url),b),t&&t.renderer&&(b=t.renderer,d.setRenderer(O.fromJson(b,{geometryType:a.resourceInfo.geometryType}))),
t&&t.labelingInfo&&(b=n.map(t.labelingInfo,function(q){return new sa(q)}),d.setLabelingInfo(b)),e.ignorePopups||!a.popupInfo||a.disablePopup||d.setInfoTemplate(new g(a.popupInfo)),a.layerDefinition&&(u.isDefined(a.layerDefinition.minScale)&&d.setMinScale(a.layerDefinition.minScale),u.isDefined(a.layerDefinition.maxScale)&&d.setMaxScale(a.layerDefinition.maxScale)),ca.once(d,"error",function(q){a.errors.push({message:"Error loading stream layer. Check websocket url"})}));else d=new W(a.styleUrl,{id:a.id,
minScale:a.minScale,maxScale:a.maxScale,opacity:a.opacity,visible:a.visibility,resourceInfo:a.resourceInfo});else d=new Za(a.url,{id:a.id,opacity:a.opacity,outSpatialReference:b,refreshInterval:a.refreshInterval}),A.connect(d,"onLoad",function(){!1===a.visibility&&d.hide();u.isDefined(a.minScale)&&u.isDefined(a.maxScale)&&d.setScaleRange(a.minScale,a.maxScale);var q=d.getFeatureLayers();n.forEach(q,function(v){a.pointSymbol&&"esriGeometryPoint"===v.geometryType?(v.renderer.symbol=M.fromJson(a.pointSymbol),
1===q.length&&(d.pointSymbol=M.fromJson(a.pointSymbol))):a.lineSymbol&&"esriGeometryPolyline"===v.geometryType?(v.renderer.symbol=M.fromJson(a.lineSymbol),1===q.length&&(d.polylineSymbol=M.fromJson(a.lineSymbol))):a.polygonSymbol&&"esriGeometryPolygon"===v.geometryType&&(v.renderer.symbol=M.fromJson(a.polygonSymbol),1===q.length&&(d.polygonSymbol=M.fromJson(a.polygonSymbol)))})});else if(d=new Xa(a.templateUrl,{id:a.id,visible:null!==a.visibility?a.visibility:!0,opacity:a.opacity,copyright:a.copyright,
fullExtent:a.fullExtent&&new L(a.fullExtent),initialExtent:a.fullExtent&&new L(a.fullExtent),subDomains:a.subDomains,tileInfo:a.tileInfo?new Ya(a.tileInfo):null,refreshInterval:a.refreshInterval,wmtsInfo:a.wmtsInfo}),u.isDefined(a.minScale)||u.isDefined(a.maxScale))d.loaded?d.setScaleRange(a.minScale,a.maxScale):A.connect(d,"onLoad",function(){d.setScaleRange(a.minScale,a.maxScale)});d&&(d.arcgisProps={title:a.title},a.baseMapLayer&&(a.isReference?(d.attr("data-reference",!0),d._basemapGalleryLayerType=
"reference"):d._basemapGalleryLayerType="basemap"),d instanceof B&&a.layerDefinition&&a.layerDefinition.featureReduction&&"cluster"===a.layerDefinition.featureReduction.type&&(b=a.layerDefinition.featureReduction,b.clusterSize&&(b.clusterSize=ya.pt2px(b.clusterSize)),b.clusterRadius&&(b.clusterRadius=ya.pt2px(b.clusterRadius)),b.popupInfo&&(b.infoTemplate=new Ba(b.popupInfo),delete b.popupInfo),d.setFeatureReduction(b)));return d}function ta(a,f,e,b,c){n.forEach(a,function(d){d.layerObject=Ra(d,a,
f,e,b,c)});var h=n.filter(a,function(d){return!d.isReference}),g=n.filter(a,function(d){return!!d.isReference});return a=h.concat(g)}function ua(a){var f=null;a=a[0];a.url&&P(a)&&a.resourceInfo.spatialReference&&(f=new I,a.resourceInfo.spatialReference.wkid&&(f.wkid=a.resourceInfo.spatialReference.wkid),a.resourceInfo.spatialReference.wkt&&(f.wkt=a.resourceInfo.spatialReference.wkt));S(a)||Ca(a)?f=new I({wkid:102100}):a&&("WMS"===a.layerType||"WMS"===a.type)&&(f=new I({wkid:a.spatialReferences[0]}));
return f}function cb(a,f,e,b,c,h,g,d){n.forEach(f,function(k){if(P(k)||k&&"VectorTileLayer"===k.layerType)k.resourceInfo=a[k.deferredsPos][1],delete k.deferredsPos});h=h||ua(f);f=ta(f,e,h,g,d);c.callback(f);return c}function ab(a){!window.CanvasRenderingContext2D&&a.renderer&&"esri.renderer.HeatmapRenderer"===a.renderer.declaredClass&&a.setRenderer(O.fromJson({type:"simple",symbol:{color:[77,77,77,255],size:6,angle:0,xoffset:0,yoffset:0,type:"esriSMS",style:"esriSMSCircle",outline:{color:[255,255,
255,255],width:.75,type:"esriSLS",style:"esriSLSSolid"}}}))}function va(a,f,e){a.message=a.message?a.message+(" [url:"+f+"]"):"[url:"+f+"]";e.push(a);da.defaults.io.errorHandler(a)}function db(a,f){var e=D(a);return H({url:e,content:{f:"json"},callbackParamName:"callback",error:function(b,c){va(b,e,f)}})}function eb(a){var f=y.arcgisUrl+"/"+a.itemId+"/data";return H({url:f,content:{f:"json"},callbackParamName:"callback",error:function(e,b){a.errors=a.errors||[];va(e,f,a.errors)}})}function Fb(a,f){return fb.loadMetadata(a).otherwise(function(e){va(e,
a,f);return e})}function gb(a,f,e){var b=new z;if(!(e.featureCollection&&e.featureCollection.layers||e.layers))return console.log("Invalid Feature Collection item data [item id: "+a.itemId+"]: ",e),a.errors=a.errors||[],a.errors.push({message:"Invalid Feature Collection item data. [item id: "+a.itemId+"]"}),b.errback(),b;e.layers&&(e.featureCollection={layers:e.layers},delete e.layers,u.isDefined(e.showLegend)&&(e.featureCollection.showLegend=e.showLegend,delete e.showLegend));hb(a,e.featureCollection,
f).then(function(c){e.featureCollection=c;a.featureCollection&&a.featureCollection.layers?n.forEach(e.featureCollection.layers,function(h,g){g=a.featureCollection.layers[g];g.popupInfo||g.layerDefinition?g.layerDefinition?(u.isDefined(g.layerDefinition.minScale)&&u.isDefined(g.layerDefinition.maxScale)&&(g.layerDefinition.minScale!==h.layerDefinition.minScale||g.layerDefinition.maxScale!==h.layerDefinition.maxScale)&&(delete h.layerDefinition.minScale,delete h.layerDefinition.maxScale),g.layerDefinition.drawingInfo&&
R.toJson(g.layerDefinition.drawingInfo)!==R.toJson(h.layerDefinition.drawingInfo)&&delete h.layerDefinition.drawingInfo,g.layerDefinition.showLegend!==h.layerDefinition.showLegend&&delete h.layerDefinition.showLegend,g.layerDefinition=w.mixin(g.layerDefinition,h.layerDefinition)):g.layerDefinition=h.layerDefinition:(g.popupInfo=h.popupInfo,g.layerDefinition=h.layerDefinition);g.featureSet=h.featureSet;g.nextObjectId=h.nextObjectId}):(a.featureCollection=a.featureCollection||{},a.featureCollection=
w.mixin(a.featureCollection,e.featureCollection));b.callback(a)});return b}function hb(a,f,e){var b=new z;Q(["./csv"],function(c){var h=[];n.forEach(f.layers,function(g){g.featureSet&&g.featureSet.features&&g.featureSet.features.length&&g.featureSet.features[0].geometry&&g.featureSet.features[0].geometry.spatialReference&&(g.deferredsPos=h.length,h.push(c.projectFeatureCollection(g,e,g.featureSet.features[0].geometry.spatialReference)))});(new K(h)).addCallback(function(){n.forEach(f.layers,function(g){u.isDefined(g.deferredsPos)&&
(h[g.deferredsPos].results&&h[g.deferredsPos].results.length?g=h[g.deferredsPos].results[0]:(console.log("Errors projecting feature collection. ["+a.title+" - "+g.layerDefinition.name+"]"),g.errors=g.errors||[],g.errors.push({message:"Errors projecting feature collection. ["+a.title+" - "+g.layerDefinition.name+"]"})),delete g.deferredsPos)});b.callback(f)})});return b}function X(a,f,e,b,c){var h=new z,g=new z,d=[];n.forEach(a.operationalLayers,function(l){l.itemId&&"Feature Collection"==l.type&&
d.push(eb(l).then(w.hitch(null,gb,l,e)))});if(0===d.length)ib(a,f,e,b,g,c);else{var k=new K(d);k.addCallback(function(l){ib(a,f,e,b,g,c)})}g.then(function(l){d=[];n.forEach(l,function(t){t=t.layerObject;if(t instanceof B&&!t.loaded&&!t.loadError){var m=new z;ca.once(t,"load, error",function(){m.callback(t)});d.push(m)}else t&&"esri.layers.WFSLayer"===t.declaredClass&&!t.loadError&&(m=new z,ca.once(t,"fromJsonComplete, error",function(r){m.callback(t)}),d.push(m))});if(d.length){var p=new z;k=new K(d);
k.addCallback(function(){p.callback(l)});return p.promise}return l}).then(function(l){var p=[];n.forEach(l,function(t){var m=t.layerObject;m&&(m instanceof B||"esri.layers.StreamLayer"===m.declaredClass)?m.loaded&&m.labelingInfo&&(t.showLabels||m._collection?p.push(m):m.setShowLabels&&m.setShowLabels(!1)):m&&"esri.layers.WFSLayer"===m.declaredClass&&m.loaded&&m.labelingInfo&&p.push(m)});p.length?Q(["../layers/LabelLayer"],function(t){var m=new t;n.forEach(p,function(r){m.addFeatureLayer(r)});l.push({layerObject:m});
h.callback(l)}):h.callback(l)});return h}function ib(a,f,e,b,c,h){var g=[],d=[],k=[];n.forEach(a.operationalLayers,function(l,p){if(l.featureCollection&&l.featureCollection.layers){var t=l.featureCollection.layers.length;n.forEach(l.featureCollection.layers,function(m,r){var q=!0;l.visibleLayers&&-1==n.indexOf(l.visibleLayers,r)&&(q=!1);m.visibility=(null!=l.visibility?!!l.visibility:!0)&&q;m.opacity=l.opacity;m.id=(l.id||"operational"+p)+"_"+r;l.title&&(m.title=1!==t&&m.layerDefinition.name&&l.title!==
m.layerDefinition.name?l.title+" - "+m.layerDefinition.name:l.title);null==m.disablePopup&&(m.disablePopup=l.disablePopup);k.push(m)},this)}else k.push(l)});n.forEach(a.baseMap.baseMapLayers,function(l,p){l.baseMapLayer=!0;l.id=l.id||"base"+p;g.push(l)});n.forEach(k,function(l,p){l.id=l.id||"operational"+p;g.push(l)});n.forEach(g,function(l){if(P(l)||l&&"VectorTileLayer"===l.layerType)l.deferredsPos=d.length,l.errors=l.errors||[],l.url?d.push(db(l.url,l.errors)):d.push(Fb(l.styleUrl,l.errors))});
0===d.length?(e=e||ua(g),g=ta(g,f,e,b,h),c.callback(g)):(new K(d)).addCallback(function(l){cb(l,g,f,d,c,e,b,h)});return c}function Y(a,f,e,b){var c=a.minScale,h=a.maxScale;if(10.1>=e.version&&f)for(a=f.length-1;0<=a;a--){if(f[a].id==b)if(0==c&&0<f[a].minScale?c=f[a].minScale:0<c&&0==f[a].minScale?c=e.minScale:0<c&&0<f[a].minScale&&(c=Math.min(c,f[a].minScale)),h=Math.max(e.maxScale||0,f[a].maxScale||0),e.setScaleRange(c,h),-1<f[a].parentLayerId)b=f[a].parentLayerId;else break}else 10.1<e.version&&
(n.forEach(a.layerInfos,function(g){g.id==b&&(0==c&&0<g.minScale?c=g.minScale:0<c&&0==g.minScale||0<c&&0<g.minScale&&(c=Math.min(c,g.minScale)),h=Math.max(h||0,g.maxScale||0))}),e.setScaleRange(c,h))}function Z(a,f,e,b){var c=a.url,h=a.__popupIds,g=a.__popupUrls,d=a.__popupWhereClauses,k=a.__popupMinScales,l=a.__popupMaxScales,p=a.__resourceInfo,t=[];n.forEach(a.__popups,function(m,r){if(m){var q=[];n.forEach(m.fieldInfos,function(x){"shape"!==x.fieldName.toLowerCase()&&q.push(x.fieldName)});if(a.dynamicLayerInfos&&
0<a.dynamicLayerInfos.length){var v=n.filter(a.dynamicLayerInfos,function(x){return h[r]==x.id})[0].source;var C=new B(c+"/dynamicLayer",{parentLayer:a,id:a.id+"_"+h[r],source:v,outFields:q,mode:B.MODE_SELECTION,infoTemplate:m&&new e(m),drawMode:!1,visible:a.visible,autoGeneralize:!0});var jb=function(x,aa){0<d[x].length&&aa.setDefinitionExpression(d[x]);if(u.isDefined(k[x])||u.isDefined(l[x]))if(u.isDefined(a.minScale)||u.isDefined(a.maxScale)){var J=a.minScale,wa=a.maxScale;0==J&&0<k[x]?J=k[x]:
0<J&&0==k[x]||0<J&&0<k[x]&&(J=Math.min(J,k[x]));wa=Math.max(wa||0,l[x]||0);aa.setScaleRange(J,wa)}else aa.setScaleRange(k[x],l[x]);else Y(a,f||p.layers,aa,h[x])};C.loaded?jb(r,C):A.connect(C,"onLoad",function(x){jb(r,C)})}else{var kb=null,lb=c+"/"+h[r];if(g[r].length)lb=g[r];else if(f)for(v=0;v<f.length;v++)if(f[v].id===h[r]){kb=f[v];break}C=new B(D(lb),{parentLayer:a,id:a.id+"_"+h[r],outFields:q,mode:B.MODE_SELECTION,infoTemplate:m&&new e(m),drawMode:!1,visible:a.visible,resourceInfo:kb,autoGeneralize:!0});
C.loaded?(0<d[r].length&&C.setDefinitionExpression(d[r]),Y(a,f||p.layers,C,h[r])):A.connect(C,"onLoad",function(x){0<d[r].length&&C.setDefinitionExpression(d[r]);Y(a,f||p.layers,x,h[r])})}t.push(C)}});0<t.length&&(A.connect(a,"onVisibilityChange",w.hitch(this,function(m,r){n.forEach(m,function(q){r?q.show():q.hide()})},t)),A.connect(b,"onLayerRemove",w.hitch(this,function(m,r,q){m.id===q.id&&n.forEach(r,function(v){b.removeLayer(v)})},a,t)));delete a.__popups;delete a.__popupIds;delete a.__popupUrls;
delete a.__popupWhereClauses;delete a.__popupMinScales;delete a.__popupMaxScales;delete a.__resourceInfo;return t}function mb(a){return H({url:D(a.url+"/layers"),content:{f:"json"},callbackParamName:"callback",error:function(){}})}function nb(a,f,e){var b=[];n.forEach(a,function(h){var g=h.__popups;g&&1<g.length&&10<=h.version&&(h.__deferredsPos=b.length,b.push(mb(h)))});var c=[];0<b.length?(new K(b)).addCallback(function(h){n.forEach(a,function(g){g.__popups&&0<g.__popups.length&&(g.__deferredsPos||
0===g.__deferredsPos?(c=c.concat(Z(g,h[g.__deferredsPos][1].layers,e,f)),delete g.__deferredsPos):c=c.concat(Z(g,null,e,f)))});f.addLayers(c)}):(n.forEach(a,function(h){h.__popups&&0<h.__popups.length&&(c=c.concat(Z(h,null,e,f)))}),f.addLayers(c))}function ob(a){n.forEach(a,function(f){var e=f.layer;e.toJson&&(f=e.toJson(),f.featureSet&&e.name&&-1<e.name.indexOf("Text")&&n.forEach(f.featureSet.features,function(b,c){b.attributes.TEXT&&(c=e.graphics[c],c.symbol.setText(b.attributes.TEXT),b.symbol.horizontalAlignment&&
(c.symbol.align=b.symbol.horizontalAlignment),c.setSymbol(c.symbol),c.setAttributes(b.attributes))},this))})}function pb(a){var f=6;n.forEach(a,function(e){if(e=e.renderer)"esri.renderer.SimpleRenderer"===e.declaredClass?((e=e.symbol)&&e.xoffset&&(f=Math.max(f,Math.abs(e.xoffset))),e&&e.yoffset&&(f=Math.max(f,Math.abs(e.yoffset)))):"esri.renderer.UniqueValueRenderer"!==e.declaredClass&&"esri.renderer.ClassBreaksRenderer"!==e.declaredClass||n.forEach(e.infos,function(b){(b=b.symbol)&&b.xoffset&&(f=
Math.max(f,Math.abs(b.xoffset)));b&&b.yoffset&&(f=Math.max(f,Math.abs(b.yoffset)))})});return f}function xa(a){var f=this,e=f.infoWindow,b=a.graphic;if(f.loaded){e.hide();e.clearFeatures();var c=[];n.forEach(f.graphicsLayerIds,function(m){(m=f.getLayer(m))&&m instanceof B&&m.loaded&&m.visible&&(m.clearSelection(),m.infoTemplate&&!m.suspended&&c.push(m))});n.forEach(f.layerIds,function(m){(m=f.getLayer(m))&&(-1!==m.declaredClass.indexOf("ArcGISImageServiceLayer")||-1!==m.declaredClass.indexOf("RasterXLayer"))&&
m.loaded&&m.visible&&m.infoTemplate&&c.push(m)});b=b&&b.getInfoTemplate()?b:null;if(c.length||b){var h=pb(c),g=a.screenPoint,d=f.toMap(new za(g.x-h,g.y+h));h=f.toMap(new za(g.x+h,g.y-h));var k=new L(d.x,d.y,h.x,h.y,f.spatialReference),l=new zb;l.geometry=k;l.timeExtent=f.timeExtent;var p=!0;d=n.map(c,function(m){m=m&&m.isFeatureReductionActive&&m.isFeatureReductionActive()?m.getFeatureReductionLayer():m;if(-1!==m.declaredClass.indexOf("ArcGISImageServiceLayer")){l.geometry=a.mapPoint;p=!1;var r=m.queryVisibleRasters(l,
{rasterAttributeTableFieldPrefix:"Raster.",returnDomainValues:!0});r.addCallback(function(){return m.getVisibleRasters()})}else if(-1!==m.declaredClass.indexOf("RasterXLayer"))r=m.fetchPopupFromTiles({geometry:a.mapPoint});else if("function"===typeof m.selectFeatures)r=m.selectFeatures(l),r.addCallback(function(){return m.getSelectedFeatures()});else{r=new z;var q=n.filter(m.graphics,function(v){return v&&v.visible&&k.intersects(v.geometry)});r.resolve(q)}return r});b&&(h=new z,h.callback([b]),d.splice(0,
0,h));if(!n.some(d,function(m){return-1===m.fired})){var t=b?1:0;n.forEach(c,function(m){t=-1!==m.declaredClass.indexOf("ArcGISImageServiceLayer")?t+m.getVisibleRasters().length:-1!==m.declaredClass.indexOf("RasterXLayer")?t+m.getPopupFromTiles().length:t+m.getSelectedFeatures().length});if(!t)return}e.setFeatures(d);e.show(a.mapPoint,{closestFirst:p})}}}function Gb(a,f){var e=f.mapOptions||{};if(!e.infoWindow){var b=new yb({visibleWhenEmpty:!1},ub.create("div"));e.infoWindow=b}u.isDefined(e.showInfoWindowOnClick)||
f.usePopupManager||(e.showInfoWindowOnClick=!1);a=new wb(a,e);A.connect(a,"onLayersAddResult",ob);return a}function F(a,f,e,b,c,h){if(b.map){var g=b.map;var d=b.clickEventHandle;var k=b.clickEventListener;var l=b.errors}else{var p=e.itemData;!c.mapOptions.backgroundColor&&p.background&&p.background.color&&null!=p.background.color[0]&&(c.mapOptions.backgroundColor=vb.toDojoColor(p.background.color));g=Gb(b,c);c.ignorePopups||c.disableClickBehavior||c.usePopupManager||(d=A.connect(g,"onClick",xa),k=
xa)}g.addLayers(a);c.ignorePopups||c.usePopupManager||nb(a,g,c._clazz);var t=l||[];n.forEach(f,function(m){m.errors&&(t=t.concat(m.errors))},this);g.loaded?h.callback({map:g,itemInfo:e,errors:t,clickEventHandle:d,clickEventListener:k}):A.connect(g,"onLoad",function(){h.callback({map:g,itemInfo:e,errors:t,clickEventHandle:d,clickEventListener:k})})}function ba(a,f,e,b,c){var h=[];n.forEach(c,function(k){w.isArray(k.layerObject)?n.forEach(k.layerObject,function(l){h.push(l)}):h.push(k.layerObject)});
if(S(c[0]))var g=setInterval(function(){if(c[0].layerObject&&c[0].layerObject.loaded)clearInterval(g),qb(a,f,e,b,c,h);else if(c[0].errors){clearInterval(g);var k="";c[0].errors&&c[0].errors.length&&(k=" ("+c[0].errors[0].message+")");b.errback(Error(fa.arcgis.utils.baseLayerError+k))}},10);else if(!h[0]&&c[0].baseMapLayer){var d="";c[0].errors&&c[0].errors.length&&(d=" ("+c[0].errors[0].message+")");b.errback(Error(fa.arcgis.utils.baseLayerError+d))}else qb(a,f,e,b,c,h)}function qb(a,f,e,b,c,h){try{var g=
e.mapOptions||{};e.mapOptions=g;h=n.filter(h,u.isDefined);if(f.map||g.extent)F(h,c,a,f,e,b);else{var d=h[0].spatialReference;if(g.center&&(null!=g.zoom||g.scale)&&(w.isArray(g.center)&&(g.center=new xb(g.center)),Aa.canProject(g.center,d))){F(h,c,a,f,e,b);return}var k=a.item;if(k&&k.extent&&k.extent.length){var l=new L(k.extent[0][0],k.extent[0][1],k.extent[1][0],k.extent[1][1],new I({wkid:4326}));4326===d.wkid?(g.extent=l,F(h,c,a,f,e,b)):900913===d.wkid||102100===d.wkid||102113===d.wkid||3857===
d.wkid?(l.xmin=Math.max(l.xmin,-180),l.xmax=Math.min(l.xmax,180),l.ymin=Math.max(l.ymin,-89.99),l.ymax=Math.min(l.ymax,89.99),g.extent=Aa.geographicToWebMercator(l),F(h,c,a,f,e,b)):e.geometryServiceURL||da.defaults.geometryService?(e.geometryServiceURL?new Ab(e.geometryServiceURL):da.defaults.geometryService).project([l],d,function(p){p=p[0];g.extent=g.extent||p;F(h,c,a,f,e,b)},function(){F(h,c,a,f,e,b)}):b.errback(Error(fa.arcgis.utils.geometryServiceError))}else F(h,c,a,f,e,b)}}catch(p){b.errback(p)}}
function Hb(a){var f=[];n.forEach(a.operationalLayers,function(e){e.featureCollection?f.push({featureCollection:e.featureCollection,visibility:null!=e.visibility?!!e.visibility:!0,title:e.title}):e.layerObject&&f.push({layer:e.layerObject,visibility:null!=e.visibility?!!e.visibility:!0,title:e.title})});return f}function rb(a){var f=[],e=a.baseMap.baseMapLayers;a.operationalLayers&&(e=e.concat(a.operationalLayers));n.forEach(e,function(b){var c={};if(b.featureCollection&&(!b||"CSV"!==b.layerType&&
"CSV"!==b.type))!0===b.featureCollection.showLegend&&n.forEach(b.featureCollection.layers,function(d){if(!1!==d.showLegend){var k=d.layerObject.renderer;c={layer:d.layerObject,title:b.title,defaultSymbol:k&&k.defaultSymbol&&k.defaultLabel?!0:!1};1<b.featureCollection.layers.length&&(c.title+=" - "+d.layerDefinition.name);f.push(c)}});else if(b.baseMapLayer&&!0===b.showLegend&&b.layerObject||!b.baseMapLayer&&!1!==b.showLegend&&b.layerObject&&!(b.layerObject instanceof B&&b.layerObject.mode===B.MODE_SELECTION)){var h=
b.layerObject.renderer,g=b.layerObject.declaredClass;h=!h||h&&h.defaultSymbol&&h.defaultLabel?!0:!1;if(10.1>b.layerObject.version&&("esri.layers.ArcGISDynamicMapServiceLayer"===g||"esri.layers.ArcGISTiledMapServiceLayer"===g)||"esri.layers.ArcGISImageServiceLayer"===g)h=!0;c={layer:b.layerObject,title:b.title,defaultSymbol:h};b.layers&&(g=n.map(n.filter(b.layers,function(d){return!1===d.showLegend}),function(d){return d.id}),g.length&&(c.hideLayers=g));f.push(c)}});return f}function Ib(a,f){function e(d,
k){n.forEach(d,function(l,p){switch(l){case "../layers/ArcGISDynamicMapServiceLayer":Ja=k[p];break;case "../layers/ArcGISImageServiceLayer":Qa=k[p];break;case "../layers/ArcGISImageServiceVectorLayer":Pa=k[p];break;case "../layers/CSVLayer":$a=k[p];break;case "../layers/DynamicLayerInfo":Ka=k[p];break;case "../layers/GeoRSSLayer":Za=k[p];break;case "../layers/ImageParameters":Ia=k[p];break;case "../layers/ImageServiceParameters":Ma=k[p];break;case "../layers/KMLLayer":Wa=k[p];break;case "../layers/LabelClass":sa=
k[p];break;case "../layers/LayerDrawingOptions":La=k[p];break;case "../layers/MosaicRule":Oa=k[p];break;case "../layers/OpenStreetMapLayer":Sa=k[p];break;case "../layers/RasterFunction":Na=k[p];break;case "../layers/RasterXLayer":Ga=k[p];break;case "../layers/StreamLayer":bb=k[p];break;case "../layers/TileInfo":Ya=k[p];break;case "../layers/VectorTileLayer":W=k[p];break;case "../layers/vectorTiles/layers/support/vectorTileLayerLoader":fb=k[p];break;case "../virtualearth/VETiledLayer":E=k[p];break;
case "../layers/WebTiledLayer":Xa=k[p];break;case "../layers/WFSLayer":Ta=k[p];break;case "../layers/WMSLayer":Va=k[p];break;case "../layers/WMSLayerInfo":Ua=k[p]}})}var b=new z;a=a.itemData;f=[];a.baseMap&&a.baseMap.baseMapLayers&&(f=f.concat(a.baseMap.baseMapLayers));a.operationalLayers&&(f=f.concat(a.operationalLayers));a=n.map(f,function(d){return d&&d.layerType});var c=[],h=[];f=!1;for(var g=0;g<a.length;g++){switch(a[g]){case "ArcGISFeatureLayer":-1===n.indexOf(c,"../layers/LabelClass")&&c.push("../layers/LabelClass");
break;case "ArcGISImageServiceLayer":case "ArcGISTiledImageServiceLayer":-1===n.indexOf(c,"../layers/ArcGISImageServiceLayer")&&(c.push("../layers/ArcGISImageServiceLayer"),h.push("../layers/ImageServiceParameters"),h.push("../layers/MosaicRule"),h.push("../layers/RasterFunction"),c.push("../layers/RasterXLayer"));break;case "ArcGISImageServiceVectorLayer":-1===n.indexOf(c,"../layers/ArcGISImageServiceVectorLayer")&&(c.push("../layers/ArcGISImageServiceVectorLayer"),h.push("../layers/ImageServiceParameters"),
h.push("../layers/MosaicRule"),h.push("../layers/RasterFunction"));break;case "ArcGISMapServiceLayer":case "ArcGISTiledMapServiceLayer":-1===n.indexOf(c,"../layers/ArcGISDynamicMapServiceLayer")&&(c.push("../layers/ArcGISDynamicMapServiceLayer"),h.push("../layers/DynamicLayerInfo"),h.push("../layers/ImageParameters"),h.push("../layers/LayerDrawingOptions"));break;case "ArcGISStreamLayer":-1===n.indexOf(c,"../layers/StreamLayer")&&c.push("../layers/StreamLayer");-1===n.indexOf(c,"../layers/LabelClass")&&
c.push("../layers/LabelClass");break;case "BingMapsAerial":case "BingMapsHybrid":case "BingMapsRoad":-1===n.indexOf(c,"../virtualearth/VETiledLayer")&&c.push("../virtualearth/VETiledLayer");break;case "CSV":-1===n.indexOf(c,"../layers/CSVLayer")&&(c.push("../layers/CSVLayer"),h.push("./csv"));break;case "GeoRSS":-1===n.indexOf(c,"../layers/GeoRSSLayer")&&c.push("../layers/GeoRSSLayer");break;case "KML":-1===n.indexOf(c,"../layers/KMLLayer")&&c.push("../layers/KMLLayer");break;case "OpenStreetMap":-1===
n.indexOf(c,"../layers/OpenStreetMapLayer")&&c.push("../layers/OpenStreetMapLayer");break;case "VectorTileLayer":-1===n.indexOf(c,"../layers/VectorTileLayer")&&c.push("../layers/VectorTileLayer");-1===n.indexOf(h,"../layers/vectorTiles/layers/support/vectorTileLayerLoader")&&h.push("../layers/vectorTiles/layers/support/vectorTileLayerLoader");break;case "WebTiledLayer":-1===n.indexOf(c,"../layers/WebTiledLayer")&&(c.push("../layers/WebTiledLayer"),h.push("../layers/TileInfo"));break;case "WFS":-1===
n.indexOf(c,"../layers/WFSLayer")&&c.push("../layers/WFSLayer");break;case "WMS":-1===n.indexOf(c,"../layers/WMSLayer")&&(c.push("../layers/WMSLayer"),h.push("../layers/WMSLayerInfo"));break;default:f=!0}if(f)break}f&&(c=Jb,h=Kb);c.length?Q(c,function(){e(c,arguments);h.length?Q(h,function(){e(h,arguments);b.resolve()}):b.resolve()}):b.resolve();return b}function Lb(a){a=a.itemData;var f=function(b,c){"GroupLayer"===b.layerType?n.forEach(b.layers,function(h){h.visibility=!1===b.visibility?!1:h.visibility;
h.opacity=u.isDefined(b.opacity)?u.isDefined(h.opacity)?h.opacity*b.opacity:b.opacity:h.opacity;f(h,c)}):c.push(b)},e=[];n.forEach(a.operationalLayers,function(b){f(b,e)});a.operationalLayers=e}function sb(a,f,e,b){Lb(b);var c=b.itemData;c.baseMap&&c.baseMap.baseMapLayers&&c.baseMap.baseMapLayers.length&&(c.baseMap.baseMapLayers[0].firstLayer=!0);var h=f.layerMixins,g=h&&h.length;if(g){var d=function(k){for(var l=0;l<g;l++){var p=h[l];if(p.mixin)if(p.hasOwnProperty("id")){if(k.id===p.id){w.mixin(k,
p.mixin);break}}else if(k.url===p.url){w.mixin(k,p.mixin);break}}};n.forEach(c.baseMap&&c.baseMap.baseMapLayers,d);n.forEach(c.operationalLayers,d)}Ib(b,f).then(function(){return Db(b,f)}).then(function(){return Cb(b,f)}).then(function(k){var l=k[0],p=k[1];if(l.itemData.operationalLayers&&0!==l.itemData.operationalLayers.length){var t=new z,m=l.itemData.baseMap.baseMapLayers.slice(),r=n.filter(l.itemData.baseMap.baseMapLayers,function(q){return!q.isReference});k={item:l.item,itemData:{baseMap:{baseMapLayers:r},
background:w.clone(l.itemData.background)}};l.itemData.baseMap.baseMapLayers=n.filter(l.itemData.baseMap.baseMapLayers,function(q){return q.isReference});T(k,p).addCallback(function(q){X(q.itemData,p).addCallback(w.hitch(null,ba,q,a,p,t))});t.then(function(q){T(l,p).addCallback(function(v){X(v.itemData,p,q.map.spatialReference,r,q.map).addCallback(function(C){v.itemData.baseMap.baseMapLayers=m;ba(v,q,p,e,C)})})},w.hitch(e,e.errback))}else T(l,p).addCallback(function(q){X(q.itemData,p).addCallback(w.hitch(null,
ba,q,a,p,e))})})}function ma(a,f){"undefined"===typeof f&&(f=!0);y._arcgisUrl&&0<y._arcgisUrl.length&&(y.arcgisUrl=y._arcgisUrl);var e={},b=new z;H({url:y.arcgisUrl+"/"+a,content:{f:"json"},callbackParamName:"callback",load:function(c){e.item=c;f?H({url:y.arcgisUrl+"/"+a+"/data",content:{f:"json"},callbackParamName:"callback",load:function(h){e.itemData=h;b.callback(e)},error:function(h){b.errback(h)}}):b.callback(e)},error:function(c){b.errback(c)}});return b}var Ja,Qa,Pa,$a,Ka,Za,Ia,Ma,Wa,sa,La,
Oa,Sa,Na,Ga,bb,Ya,W,fb,E,Xa,Ta,Va,Ua,Jb="../layers/ArcGISDynamicMapServiceLayer ../layers/ArcGISImageServiceLayer ../layers/ArcGISImageServiceVectorLayer ../layers/CSVLayer ../layers/GeoRSSLayer ../layers/KMLLayer ../layers/LabelClass ../layers/OpenStreetMapLayer ../layers/RasterXLayer ../layers/StreamLayer ../layers/VectorTileLayer ../virtualearth/VETiledLayer ../layers/WebTiledLayer ../layers/WFSLayer ../layers/WMSLayer".split(" "),Kb="./csv ../layers/DynamicLayerInfo ../layers/ImageParameters ../layers/ImageServiceParameters ../layers/LayerDrawingOptions ../layers/MosaicRule ../layers/RasterFunction ../layers/TileInfo ../layers/vectorTiles/layers/support/vectorTileLayerLoader ../layers/WMSLayerInfo".split(" ");
var y={arcgisUrl:ea.getProtocolForWebResource()+"//www.arcgis.com/sharing/rest/content/items",getItem:ma,createMap:function(a,f,e){var b=new z;e=e||{};var c=e.infoTemplateClass;e._clazz=c&&(w.isObject(c)?c:w.getObject(c))||Ba;w.isString(a)?ma(a).addCallback(w.hitch(null,sb,f,e,b)).addErrback(w.hitch(b,b.errback)):sb(f,e,b,a);b.addCallback(function(h){var g=h.map;g&&(g.tables=w.getObject("itemInfo.itemData.tables",!1,h)||[])});return b},getLayerList:function(a){return a&&a.itemInfo&&a.itemInfo.itemData?
Hb(a.itemInfo.itemData):[]},getLegendLayers:function(a){return a&&a.itemInfo&&a.itemInfo.itemData?rb(a.itemInfo.itemData):[]},_arcgisUrl:null,_getItemProps:T,_getItemData:N,_getBingKey:ja,_portalUrlResponse:la,_portalUrlFailure:U,_processFSItemProperties:ka,_processSSItemProperties:Da,_getLayers:X,_preBuildLayerObjects:cb,_buildLayerObjects:ta,_preCreateMap:ba,_getMapSR:ua,_createMap:F,_addSelectionLayers:nb,_createSelectionFeatureLayers:Z,_getServiceInfo:db,_getFeatureCollectionItem:eb,_mergeFeatureCollectionItem:gb,
_projectFeatureCollection:hb,_getLayersInfo:mb,_initLayer:Ra,_loadAsCached:oa,_loadAsDynamic:Ha,_processPopups:na,_onLayersAddResult:ob,_sameSpatialReferenceAsBasemap:qa,_sameTilingSchemeAsBasemap:ra,_showPopup:xa,_calculateClickTolerance:pb,_getVisibleFeatureLayers:pa,_updateLayerScaleInfo:Y,_checkUrl:D,_isHostedService:Ea,_isAgolService:Fa,_getLegendLayers:rb};w.setObject("arcgis.utils",y,G);return y});