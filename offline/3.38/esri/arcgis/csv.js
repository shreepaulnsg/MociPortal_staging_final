// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/arcgis/csv","dojo/_base/lang dojo/_base/array dojo/_base/Deferred dojo/sniff dojo/number dojox/data/CsvStore ../kernel ../config ../request ../SpatialReference ../geometry/jsonUtils ../geometry/webMercatorUtils".split(" "),function(r,g,F,G,U,V,W,H,X,C,I,J){function K(a){var c=0,e="";g.forEach([","," ",";","|","\t"],function(k){var h=a.split(k).length;h>c&&(c=h,e=k)});return e}function L(a,c){if(!a||"[object Date]"!==Object.prototype.toString.call(a)||isNaN(a.getTime()))return!1;a=!0;
if(G("chrome")&&/\d+\W*$/.test(c)){if(c.match(/[^0-9a-zA-Z\s]/))return!1;if(c=c.match(/[a-zA-Z]{2,}/)){a=!1;for(var e=0,k=c.length,h=/^((jan(uary)?)|(feb(ruary)?)|(mar(ch)?)|(apr(il)?)|(may)|(jun(e)?)|(jul(y)?)|(aug(ust)?)|(sep(tember)?)|(oct(ober)?)|(nov(ember)?)|(dec(ember)?)|(am)|(pm)|(gmt)|(utc))$/i;!a&&e<=k&&!(a=!h.test(c[e]));)e++;a=!a}}return a}function M(a,c,e){var k=a.indexOf("\n");k=r.trim(a.substr(0,k));var h=c.columnDelimiter;h||(h=K(k));var l=new V({data:a,separator:h});l.fetch({onComplete:function(p,
m){m=0;var b={layerDefinition:c.layerDefinition,featureSet:{features:[],geometryType:"esriGeometryPoint"}},n=b.layerDefinition.objectIdField,d=b.layerDefinition.fields;n||g.some(d,function(f){return"esriFieldTypeOID"===f.type?(n=f.name,!0):!1})||(d.push({name:"__OBJECTID",alias:"__OBJECTID",type:"esriFieldTypeOID",editable:!1}),n="__OBJECTID");var v=l._attributes,N=[],y=[];g.forEach(d,function(f){"esriFieldTypeDate"===f.type?N.push(f.name):("esriFieldTypeDouble"===f.type||"esriFieldTypeInteger"===
f.type)&&y.push(f.name)});if(c.locationInfo&&"coordinates"===c.locationInfo.locationType){var t=c.locationInfo.latitudeFieldName;var u=c.locationInfo.longitudeFieldName}else g.forEach(v,function(f){var q=g.indexOf(O,f.toLowerCase());-1!==q&&(t=f);q=g.indexOf(P,f.toLowerCase());-1!==q&&(u=f)}),t&&u&&(c.locationInfo={locationType:"coordinates",latitudeFieldName:t,longitudeFieldName:u});if(t&&u){-1===g.indexOf(y,t)&&y.push(t);-1===g.indexOf(y,u)&&y.push(u);if(r.isArray(c.outFields)&&-1===g.indexOf(c.outFields,
"*"))var z=c.outFields;g.forEach(v,function(f){g.some(d,function(q){return f===q.name})||d.push({name:f,alias:f,type:f===t||f===u?"esriFieldTypeDouble":"esriFieldTypeString"})});v=0;var Y=p.length;for(v;v<Y;v++){var A=p[v],B=l.getAttributes(A),w={};g.forEach(B,function(f){if(f&&(f===t||f===u||!z||-1<g.indexOf(z,f))){var q=f;0===f.length&&g.forEach(d,function(Z,Q){Z.name==="attribute_"+(Q-1)&&(f="attribute_"+(Q-1))});if(-1<g.indexOf(N,f)){q=l.getValue(A,q);var x=new Date(q);w[f]=L(x,q)?x.getTime():
null}else-1<g.indexOf(y,f)?(x=U.parse(l.getValue(A,q)),f!==t&&f!==u||!(isNaN(x)||181<Math.abs(x))||(x=parseFloat(l.getValue(A,q))),isNaN(x)?w[f]=null:w[f]=x):w[f]=l.getValue(A,q)}});w[n]=m;m++;B=w[t];var D=w[u];null==D||null==B||isNaN(B)||isNaN(D)||(z&&-1===g.indexOf(z,t)&&delete w[t],z&&-1===g.indexOf(z,u)&&delete w[u],b.featureSet.features.push({geometry:{x:D,y:B,spatialReference:{wkid:4326}},attributes:w}))}b.layerDefinition.name="csv";e&&e(b)}else setTimeout(function(){console.error("File does not seem to contain fields with point coordinates.")},
1),e&&e(null,Error("File does not seem to contain fields with point coordinates."))},onError:function(p){console.error("Error fetching items from CSV store: ",p);e&&e(null,p)}});return!0}function E(a,c,e,k,h,l){0===a.length&&h(null);var p=I.getGeometryType(c),m=[];g.forEach(a,function(b){b=new p(b);b.spatialReference=e;m.push(b)},this);c=[102113,102100,3857];e.wkid&&4326===e.wkid&&k.wkid&&-1<g.indexOf(c,k.wkid)?(g.forEach(m,function(b){b.xmin?(b.xmin=Math.max(b.xmin,-180),b.xmax=Math.min(b.xmax,180),
b.ymin=Math.max(b.ymin,-89.99),b.ymax=Math.min(b.ymax,89.99)):b.rings?g.forEach(b.rings,function(n){g.forEach(n,function(d){d[0]=Math.min(Math.max(d[0],-180),180);d[1]=Math.min(Math.max(d[1],-89.99),89.99)},this)},this):b.paths?g.forEach(b.paths,function(n){g.forEach(n,function(d){d[0]=Math.min(Math.max(d[0],-180),180);d[1]=Math.min(Math.max(d[1],-89.99),89.99)},this)},this):b.x&&(b.x=Math.min(Math.max(b.x,-180),180),b.y=Math.min(Math.max(b.y,-89.99),89.99))},this),a=[],g.forEach(m,function(b){b=
J.geographicToWebMercator(b);102100!==k.wkid&&(b.spatialReference=k);a.push(b.toJson())},this),h(a)):null!==e.wkid&&-1<g.indexOf(c,e.wkid)&&null!==k.wkid&&4326===k.wkid?(a=[],g.forEach(m,function(b){a.push(J.webMercatorToGeographic(b).toJson())},this),h(a)):(c=function(b,n){b&&b.length===a.length?(a=[],g.forEach(b,function(d){d&&(d.rings&&0<d.rings.length&&0<d.rings[0].length&&0<d.rings[0][0].length&&!isNaN(d.rings[0][0][0])&&!isNaN(d.rings[0][0][1])||d.paths&&0<d.paths.length&&0<d.paths[0].length&&
0<d.paths[0][0].length&&!isNaN(d.paths[0][0][0])&&!isNaN(d.paths[0][0][1])||d.xmin&&!isNaN(d.xmin)&&d.ymin&&!isNaN(d.ymin)||d.x&&!isNaN(d.x)&&d.y&&!isNaN(d.y))?a.push(d.toJson()):a.push(null)},this),h(a)):l(b,n)},H.defaults.geometryService?H.defaults.geometryService.project(m,k,r.hitch(this,c),l):h(null))}function R(a,c){var e=[102113,102100,3857];return a&&c&&a.wkid===c.wkid&&a.wkt===c.wkt||a&&c&&a.wkid&&c.wkid&&-1<g.indexOf(e,a.wkid)&&-1<g.indexOf(e,c.wkid)?!0:!1}function S(a,c,e,k){if(a.featureSet&&
0!==a.featureSet.features.length)if(R(e,c))k(a);else{var h=function(b){var n=[];g.forEach(a.featureSet.features,function(d,v){b[v]&&(d.geometry=b[v],n.push(d))},this);k(a)},l=function(b,n){console.error("error projecting featureSet ("+a.layerDefinition.name+"). Final try.");k(a)},p=function(b,n){console.error("error projecting featureSet ("+a.layerDefinition.name+"). Try one more time.");E(m,a.featureSet.geometryType,c,e,r.hitch(this,h),r.hitch(this,l))};if(a.featureSet.features&&0<a.featureSet.features.length){var m=
[];g.forEach(a.featureSet.features,function(b){if(b.geometry.toJson)m.push(b.geometry);else{var n=I.getGeometryType(a.featureSet.geometryType);m.push(new n(b.geometry))}});c.toJson||(c=new C(c));e.toJson||(e=new C(e));E(m,a.featureSet.geometryType,c,e,r.hitch(this,h),r.hitch(this,p))}else k(a)}}var O="lat latitude y ycenter latitude83 latdecdeg point-y lat_dd".split(" "),P="lon lng long longitude x xcenter longitude83 longdecdeg point-x long_dd".split(" "),T={latFieldStrings:O,longFieldStrings:P,
buildCSVFeatureCollection:function(a){var c=new F,e=function(h,l){l?c.errback(l):c.callback(h)},k={url:a.url,handleAs:"text",load:function(h){M(h,a,r.hitch(this,e))},error:function(h){c.errback(h);console.error("error: "+h)}};-1<a.url.indexOf("arcgis.com")&&-1<a.url.indexOf("/content/items")&&-1<a.url.indexOf("/data")&&(k.headers={"Content-Type":""});X(k,{usePost:!1});return c},projectFeatureCollection:function(a,c,e){var k=new F;e||(e=new C({wkid:4326}));S(a,e,c,r.hitch(this,function(h){k.callback(h)}));
return k},generateDefaultPopupInfo:function(a){var c={esriFieldTypeDouble:1,esriFieldTypeSingle:1},e={esriFieldTypeInteger:1,esriFieldTypeSmallInteger:1},k={esriFieldTypeDate:1},h=null;a=g.map(a.layerDefinition.fields,r.hitch(this,function(l){"NAME"===l.name.toUpperCase()&&(h=l.name);var p="esriFieldTypeOID"!==l.type&&"esriFieldTypeGlobalID"!==l.type&&"esriFieldTypeGeometry"!==l.type,m=null;if(p){var b=l.name.toLowerCase();if(-1<",stretched value,fnode_,tnode_,lpoly_,rpoly_,poly_,subclass,subclass_,rings_ok,rings_nok,".indexOf(","+
b+",")||-1<b.indexOf("area")||-1<b.indexOf("length")||-1<b.indexOf("shape")||-1<b.indexOf("perimeter")||-1<b.indexOf("objectid")||b.indexOf("_")===b.length-1||b.indexOf("_i")===b.length-2&&1<b.length)p=!1;l.type in e?m={places:0,digitSeparator:!0}:l.type in c?m={places:2,digitSeparator:!0}:l.type in k&&(m={dateFormat:"shortDateShortTime"})}return r.mixin({},{fieldName:l.name,label:l.alias,isEditable:!0,tooltip:"",visible:p,format:m,stringFieldOption:"textbox"})}));return{title:h?"{"+h+"}":"",fieldInfos:a,
description:null,showAttachments:!1,mediaInfos:[]}},_getSeparator:K,_isValidDate:L,_processCsvData:M,_projectGeometries:E,_sameSpatialReference:R,_projectFeatureSet:S};G("extend-esri")&&r.setObject("arcgis.csv",T,W);return T});