// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
define("esri/arcgis/AppProxyManager","dojo/_base/declare dojo/_base/lang ../kernel dojo/uacss dojo/Deferred dojo/promise/all dojo/json dojo/Evented dojo/Stateful ../request ./utils".split(" "),function(l,k,v,w,m,A,n,x,y,p,z){l=l([x,y],{constructor:function(a){this.defaults={appid:"",referrers:[],proxies:[]};a=k.mixin({},this.defaults,a);this.set(a);this._init()},updateProxy:function(a){var b=new m;if(!a||!a.proxyId)return b.reject("A proxyId is required to update a proxy"),b.promise;var c={sourceUrl:a.sourceUrl};
a.intervalSeconds&&!isNaN(a.intervalSeconds)&&(c.intervalSeconds=a.intervalSeconds);a.hitsPerInterval&&!isNaN(a.hitsPerInterval)&&(c.hitsPerInterval=a.hitsPerInterval);var f=this._sharingBaseUrl+"content/users/"+this._owner+"/";this._folderId&&(f+=this._folderId+"/");f+="items/"+this.appid+"/proxies/"+a.proxyId+"/update";p({url:f,content:{proxy:n.stringify(c),f:"json"},callbackParamName:"callback"},{usePost:!0}).then(k.hitch(this,function(d){d=d&&d.appProxies||[];this.set("proxies",d);b.resolve(d)}),
b.reject);return b.promise},createProxies:function(a){var b=new m;this._registerApp(this._appItem).then(k.hitch(this,function(){for(var c={referrers:this.referrers},f=[],d=0;d<a.length;d++){var e=a[d],g={sourceUrl:e.sourceUrl};e.intervalSeconds&&!isNaN(e.intervalSeconds)&&(g.intervalSeconds=e.intervalSeconds);e.hitsPerInterval&&!isNaN(e.hitsPerInterval)&&(g.hitsPerInterval=e.hitsPerInterval);f.push(g)}d=this._sharingBaseUrl+"content/users/"+this._owner+"/";this._folderId&&(d+=this._folderId+"/");
d+="items/"+this.appid+"/createProxies";p({url:d,content:{proxies:n.stringify(f),serviceProxyParams:n.stringify(c),f:"json"},callbackParamName:"callback"},{usePost:!0}).then(k.hitch(this,function(h){h=h&&h.appProxies||[];this.set("proxies",h);b.resolve(h)}),b.reject)}),b.reject);return b.promise},deleteProxies:function(a){var b=new m,c={f:"json"},f=[];if(a&&a.length)for(var d=0;d<a.length;d++)f.push(a[d].proxyId);f&&f.length&&(c.proxies=f.toString());a=this._sharingBaseUrl+"content/users/"+this._owner+
"/";this._folderId&&(a+=this._folderId+"/");a+="items/"+this.appid+"/deleteProxies";p({url:a,content:c,callbackParamName:"callback"},{usePost:!0}).then(k.hitch(this,function(e){var g=this.proxies.slice();e=e&&e.results||[];if(g&&g.length&&e&&e.length)for(var h=0;h<g.length;h++)for(var r=g[h],t=r.proxyId,q=0;q<e.length;q++){var u=e[q].proxyId;u&&t&&u===t&&(r.proxied=!1)}this.set("proxies",g);b.resolve(g)}),b.reject);return b.promise},_parseUrl:function(a){var b=document.createElement("a");b.href=a;
return b},_init:function(){this.appid?z.getItem(this.appid).then(k.hitch(this,function(a){this._appItem=a;this._folderId=a.item.ownerFolder;var b=this._parseUrl(a.item.url);this._sharingBaseUrl="https://"+b.hostname+"/sharing/rest/";var c=b.pathname.substring(0,b.pathname.lastIndexOf("/"));c="/"===c.charAt(0)?c:"/"+c;var f=b.hostname+c;this.referrers.push("http://"+b.hostname,"https://"+b.hostname,"http://"+f,"https://"+f,"http://www.arcgis.com"+c,"https://www.arcgis.com"+c);-1!==b.hostname.indexOf("mapsdevext.arcgis.com")&&
this.referrers.push("http://devext.arcgis.com"+c,"https://devext.arcgis.com"+c);-1!==b.hostname.indexOf("mapsqa.arcgis.com")&&this.referrers.push("http://qaext.arcgis.com"+c,"https://qaext.arcgis.com"+c);this._owner=a.item.owner;-1!==a.item.typeKeywords.indexOf("App Proxy")&&a.item.appProxies&&this.set("proxies",a.item.appProxies);this.emit("load",{});this.set("loaded",!0)})):console.error("AppProxyManager: appid required.")},_registerApp:function(a){var b=new m,c=a.item.id,f=this._sharingBaseUrl+
"oauth2/",d=this.referrers;this._registered&&this._registered===this.appid?b.resolve(a):-1!==a.item.typeKeywords.indexOf("Registered App")?b.resolve(a):p({url:f+"/registerApp",content:{itemId:c,appType:"browser",redirect_uris:n.stringify(d),f:"json"},callbackParamName:"callback"},{usePost:!0}).then(k.hitch(this,function(e){this._registered=this.appid;b.resolve(e)}),b.reject);return b.promise}});w("extend-esri")&&k.setObject("arcgis.AppProxyManager",l,v);return l});