//>>built
define("dstore/db/SQL","dojo/_base/declare dojo/Deferred dojo/when dstore/QueryResults dstore/Store dstore/SimpleQuery dojo/_base/lang dojo/promise/all".split(" "),function(B,C,u,D,E,F,x,v){function y(a,b){b=b.split(".");for(var n=b.length,f=0;f<n;f++)a=a&&a[b[f]];return a}function t(a){return a.replace(/\./g,"_dot_")}function z(a){return a&&a.__extra?x.mixin(a,JSON.parse(a.__extra)):a}var A={and:" AND ",or:" OR ",eq:"\x3d",ne:"!\x3d",lte:"\x3c\x3d",gte:"\x3e\x3d",lt:"\x3c",gt:"\x3e"};return B([E,
F],{constructor:function(a){var b=a.dbConfig;this.database=openDatabase(a.dbName||"dojo-db","1.0","dojo-db",4194304);var n=this.indexPrefix=a.indexPrefix||"idx_",f=a.table||a.storeName;this.table=(a.table||a.storeName).replace(/[^\w]/g,"_");a=[];this.indices=b.stores[f];this.repeatingIndices={};for(var e in this.indices)this.indices[e].multiEntry&&(this.repeatingIndices[e]=!0);if(!b.available){for(f in b.stores){var g=b.stores[f],k=f.replace(/[^\w]/g,"_"),h=g[this.idProperty],c=["__extra",this.idProperty+
" "+(h&&h.autoIncrement?"INTEGER PRIMARY KEY AUTOINCREMENT":"PRIMARY KEY")];h=[this.idProperty];for(e in g)e!=this.idProperty&&c.push(t(e));a.push(this.executeSql("CREATE TABLE IF NOT EXISTS "+k+" ("+c.join(",")+")"));for(e in g)e!=this.idProperty&&(g[e].multiEntry?(h.push(e),c=k+"_repeating_"+t(e),a.push(this.executeSql("CREATE TABLE IF NOT EXISTS "+c+" (id,value)")),a.push(this.executeSql("CREATE INDEX IF NOT EXISTS idx_"+c+"_id ON "+c+"(id)")),a.push(this.executeSql("CREATE INDEX IF NOT EXISTS idx_"+
c+"_value ON "+c+"(value)"))):(a.push(this.executeSql("ALTER TABLE "+k+" ADD "+t(e)).then(null,function(){})),!1!==g[e].indexed&&a.push(this.executeSql("CREATE INDEX IF NOT EXISTS "+n+k+"_"+t(e)+" ON "+k+"("+t(e)+")"))))}b.available=v(a)}this.available=b.available},idProperty:"id",selectColumns:["*"],get:function(a){var b=this;return u(this.executeSql("SELECT "+this.selectColumns.join(",")+" FROM "+this.table+" WHERE "+this.idProperty+"\x3d?",[a]),function(n){return 0<n.rows.length?b._restore(z(n.rows.item(0))):
void 0})},getIdentity:function(a){return a[this.idProperty]},remove:function(a){return this.executeSql("DELETE FROM "+this.table+" WHERE "+this.idProperty+"\x3d?",[a])},identifyGeneratedKey:!0,add:function(a){function b(d,p,l){h.repeatingIndices[l||d]?k.push(function(q){return v(p.map(function(w){return h.executeSql("INSERT INTO "+h.table+"_repeating_"+d+" (value, id) VALUES (?, ?)",[w,q])}))}):(e.push(d),f.push("?"),n.push(p))}var n=[],f=[],e=[],g={},k=[],h=this,c;for(c in a)a.hasOwnProperty(c)&&
(c in this.indices||c==this.idProperty?b(c,a[c]):g[c]=a[c]);for(c in this.indices)-1<c.indexOf(".")&&b(t(c),y(a,c),c);e.push("__extra");f.push("?");n.push(JSON.stringify(g));var m=this.idProperty;this.identifyGeneratedKey&&(n.idColumn=m);g="INSERT INTO "+this.table+" ("+e.join(",")+") VALUES ("+f.join(",")+")";return u(this.executeSql(g,n),function(d){var p=h.indices[m];if(p&&p.autoIncrement){var l=d.insertId;a[m]=l}else l=a[m];return v(k.map(function(q){return q(l)})).then(function(){return l})})},
put:function(a,b){function n(d,p,l){if(g.repeatingIndices[l||d])for(g.executeSql("DELETE FROM "+g.table+"_repeating_"+d+" WHERE id\x3d?",[f]),l=0;l<p.length;l++)g.executeSql("INSERT INTO "+g.table+"_repeating_"+d+" (value, id) VALUES (?, ?)",[p[l],f]);else h.push(d+"\x3d?"),k.push(p)}b=b||{};var f=b.id||a[this.idProperty],e=b.overwrite;if(void 0===e){var g=this;return this.get(f).then(function(d){return(b.overwrite=!!d)?(b.overwrite=!0,g.put(a,b)):g.add(a,b)})}if(!e)return g.add(a,b);e="UPDATE "+
this.table+" SET ";var k=[],h=[],c={};g=this;for(var m in a)a.hasOwnProperty(m)&&(m in this.indices||m==this.idProperty?n(m,a[m]):c[m]=a[m]);for(m in this.indices)-1<m.indexOf(".")&&n(t(m),y(a,m),m);h.push("__extra\x3d?");k.push(JSON.stringify(c));e+=h.join(",")+" WHERE "+this.idProperty+"\x3d?";k.push(a[this.idProperty]);return u(this.executeSql(e,k),function(){return f})},fetchRange:function(a){return this.fetch(a)},generateSql:function(){function a(d){if(d.match(/[^\w_\.]/))throw new URIError("Illegal column name "+
d);return c+"."+t(d)}function b(d){var p=d.args,l=p[0],q=p[1];switch(d.type){case "eq":case "ne":case "lt":case "lte":case "gt":case "gte":return m.push(q),[a(l),A[d.type]+"?"];case "and":case "or":l=[];for(q=0;q<p.length;q++)l.push(b(p[q]).join(""));return["(",l.join(A[d.type]),")"];case "in":return 0===q.length?"0\x3d1":q.generateSql?(d=q.generateSql(),m.push.apply(m,d.params),[a(l)," IN ("+d.select+d.from+")"]):[a(l)," IN ("+p[1].map(function(r){m.push(r);return"?"}).join(",")+")"];case "contains":var w=
c+"_repeating_"+l;return["(",q.map(function(r){r&&r.type?r="value "+b(r).slice(1).join(""):(m.push(r),r="value\x3d?");return a(h.idProperty)+" IN (SELECT id FROM "+w+" WHERE "+r+")"}).join(" AND "),")"];case "match":q=q.source;if("^"!==q[0]||q.match(/[\{\}\(\)\[\]\.,\$\*]/))throw Error("The match filter only supports simple prefix matching like /^starts with/");return[c+"."+l," LIKE '"+q.slice(1).replace(/'/g,"''")+"%'"];default:throw new URIError("Invalid query syntax, "+d.type+" not implemented");
}}var n="FROM "+this.table,f="",e="",g="*",k,h=this,c=this.table,m=[];this.queryLog.forEach(function(d){if("filter"===d.type)f=(f?" AND ":"")+b(d.normalizedArguments[0]).join("");else if("sort"===d.type)e=" ORDER BY "+d.normalizedArguments[0].map(function(q){return a(q.property)+" "+(q.descending?"desc":"asc")}).join(",");else if("select"===d.type){var p=d.normalizedArguments[0];if(p instanceof Array){for(var l=0;l<p.length;l++)if(!(p[l]in h.indices)){k=d;return}g=p.map(a).join(", ")}else p in h.indices&&
(g=a(p)),k=d}});f&&(f=" WHERE "+f);return{select:"SELECT "+g+" ",from:n+f+e,params:m,querier:k&&k.querier}},fetch:function(a){a=a||{};var b=this.generateSql(),n=b.from,f=b.params,e=b.querier;b=b.select+" "+n;a.end&&(b+=" LIMIT "+(a.end-(a.start||0)));a.start&&(b+=" OFFSET "+a.start);var g=this;a=x.delegate(this.executeSql(b,f).then(function(k){for(var h=[],c=0;c<k.rows.length;c++)h.push(g._restore(z(k.rows.item(c))));e&&(h=e(h));return h}));g=this;return new D(a,{totalLength:{then:function(k,h){return g.executeSql("SELECT COUNT(*) "+
n,f).then(function(c){return c.rows.item(0)["COUNT(*)"]}).then(k,h)}}})},executeSql:function(a,b){var n=new C,f,e;this.database.transaction(function(g){g.executeSql(a,b,function(k,h){n.resolve(f=h)},function(k,h){n.reject(e=h)})});if(f)return f;if(e)throw e;return n.promise}})});