//>>built
define("dstore/db/IndexedDB","dojo/_base/declare dojo/_base/lang dojo/Deferred dojo/when dojo/promise/all dstore/Store dstore/SimpleQuery dstore/QueryResults".split(" "),function(T,W,Q,M,R,X,Y,U){function V(a){var d=new Q,b=!1,l=!1,c=!1,h=null;if(a.transaction){var m=a.transaction.oncomplete;b=!0;a.transaction.oncomplete=function(){l=!0;m&&m();c&&d.resolve(h)}}a.onsuccess=function(w){h=w.target.result;c=!0;b&&!l||d.resolve(h)};a.onerror=function(){a.error.message=a.webkitErrorMessage;d.reject(a.error)};
return d.promise}function N(a,d,b){if(G||O.length){a&&(O.push({cursor:a,priority:d,retry:b}),O.sort(function(c,h){return c.priority>h.priority?1:-1}));if(1<=G)return;var l=O.pop();a=l&&l.cursor}if(a)try{a["continue"](),G++}catch(c){if("TransactionInactiveError"!==c.name&&0!==c.name||!l)throw c;l.retry()}}function S(){return!0}var O=[],G=0,H=window.IDBKeyRange||window.webkitIDBKeyRange;return T([X,Y],{constructor:function(a){T.safeMixin(this,a);var d=this,b=this.dbConfig;this.indices=b.stores[this.storeName];
this.cachedCount={};for(var l in d.indices)a=d.indices[l],"number"===typeof a&&(d.indices[l]={preference:a});this.db=this.db||b.db;if(!this.db){var c=b.openRequest;c||(c=b.openRequest=window.indexedDB.open(b.name||"dojo-db",parseInt(b.version,10)),c.onupgradeneeded=function(){var h=d.db=c.result,m;for(m in b.stores){var w=b.stores[m];if(h.objectStoreNames.contains(m))u=c.transaction.objectStore(m);else{u=w.idProperty||"id";var u=h.createObjectStore(m,{keyPath:u,autoIncrement:w[u]&&w[u].autoIncrement||
!1})}for(var n in w)u.indexNames.contains(n)||"autoIncrement"===n||"idProperty"===n||!1===w[n].indexed||u.createIndex(n,n,w[n])}},b.db=V(c));this.db=b.db.then(function(h){return d.db=h})}},idProperty:"id",storeName:"",indices:{},transaction:function(){var a=this;this._currentTransaction=null;return{abort:function(){a._currentTransaction.abort()},commit:function(){a._currentTransaction=null}}},_getTransaction:function(){if(!this._currentTransaction){this.db||console.error("The database has not been initialized yet");
this._currentTransaction=this.db.transaction([this.storeName],"readwrite");var a=this;this._currentTransaction.oncomplete=function(){a._currentTransaction=null};this._currentTransaction.onerror=function(d){console.error(d)}}return this._currentTransaction},_callOnStore:function(a,d,b,l){var c=this;return M(this.db,function w(m){c.db.then&&(c.db=m);if(m=c._currentTransaction)var u=!0;else m=c._getTransaction();if(u)try{var n=m.objectStore(c.storeName);b&&(n=n.index(b));var q=n[a].apply(n,d)}catch(e){if("TransactionInactiveError"===
e.name||"InvalidStateError"===e.name)return c._currentTransaction=null,w();throw e;}else n=m.objectStore(c.storeName),b&&(n=n.index(b)),q=n[a].apply(n,d);return l?q:V(q)})},get:function(a){var d=this;return this._callOnStore("get",[a]).then(function(b){return d._restore(b)})},getIdentity:function(a){return a[this.idProperty]},put:function(a,d){d=d||{};this.cachedCount={};var b=this;return this._callOnStore(!1===d.overwrite?"add":"put",[a]).then(function(l){return b.get(l)})},add:function(a,d){d=d||
{};d.overwrite=!1;return this.put(a,d)},remove:function(a){this.cachedCount={};return this._callOnStore("delete",[a])},fetch:function(){return this._fetch(S)},fetchRange:function(a){return this._fetch(S,a)},forEach:function(a,d){return this._fetch(function(b,l){a.call(d,b,l)})},_union:function(a,d,b){b=b||{};var l=b.start||0,c=b.end||Infinity,h=a.sort,m=a.select;b=a.filter;if(h){var w={sort:h};var u=this._createSortQuerier(w)}else u=function(x){return x};var n=[],q=0,e=0,t=0,v=[],f,k={},r=[],g=this;
return new U(M(b).then(function(x){return R(x.map(function(C,I){function P(A){J.push(A);for(var p=[],D=[];v.every(function(E){if(0<E.length)return(E=E[0])&&D.push(E),p.push(E)});){if(t>=c||0===D.length){f=!0;return}A=u(D)[0];v[p.indexOf(A)].shift();if(t++>=l&&(r.push(A),!d(A))){f=!0;return}p=[];D=[]}return!0}var J=v[I]=[];C=g._query({filterFunction:a.filterFunction,filter:C,sort:h},function(A){if(!f){var p=g.getIdentity(A);e++;if(p in k)return!0;q++;k[p]=!0;return P(A)}});n[I]=C.totalLength;return C.then(function(A){P(null);
return A})}))}).then(function(){return m?m.querier(r):r}),{totalLength:{then:function(){return R(n).then(function(x){return x.reduce(function(C,I){return C+I})*q/(e||1)}).then.apply(this,arguments)}}})},_normalizeQuery:function(){function a(q){q.forEach(function v(t){if(l)throw Error("Can not process conditions after a union, rearrange the query with the union last");var f=t.type,k=[].slice.call(t.args,0),r=k[0],g=k[1];if(g&&g.fetch&&!g.data)u.push(g.fetch().then(function(x){g.data=x;v(t)},function(x){console.error("Failed to retrieved nested collection",
x)}));else if("or"===f)d(k);else if("and"===f)a(k);else if("eq"===f)b(r,g);else if("gt"===f||"gte"===f)k=c[r]||(c[r]={}),k.from=g,k.excludeFrom="gt"===f,b(r,k);else if("lt"===f||"lte"===f)k=c[r]||(c[r]={}),k.to=g,k.excludeTo="lt"===f,b(r,k);else if("in"===f)d((g.data||g).map(function(x){return{type:"eq",args:[r,x]}}));else if("contains"===f)k=c[r]||(c[r]={}),k.contains=g.data?g.data:g instanceof Array?g:[g],b(r,k);else if("match"===f){g=g.source;if("^"!==g[0]||g.match(/[\{\}\(\)\[\]\.,\$\*]/))throw Error("The match filter only supports simple prefix matching like /^starts with/");
k=c[r]||(c[r]={});g=g.slice(1);k.from=g;k.to=g+"~";b(r,k)}else throw Error('Unsupported filter type "'+f+'"');})}function d(q){l=q.map(function(e){c={};a([e]);return c})}function b(q,e){"boolean"!==typeof e&&(e&&(e.from||e.to?function(t,v){e.test=function(f){return!t||t<=f&&(!v||v>=f)};e.keyRange=t?v?H.bound(t,v,e.excludeFrom,e.excludeTo):H.lowerBound(t,e.excludeFrom):H.upperBound(v,e.excludeTo)}(e.from,e.to):"object"===typeof e&&e.contains&&function(t){var v=t[0];if("object"===typeof v&&"match"===
v.type){if("^"===v.args[1].source[0]){var f=v.args[1].source.slice(1);f=H.bound(f,f+"~")}}else f=H.only(v);e.test=function(k){return t.every(function(r){if("object"===typeof r&&"match"===r.type){var g=r.args[1];return k.some(function(x){return!!g.test(x)})}return k&&-1<k.indexOf(r)})};e.keyRange=f}(e.contains)),c[q]=e)}var l,c={},h,m,w,u=[];this.queryLog.forEach(function(q){var e=q.type,t=q.normalizedArguments;if("filter"===e){h=t;var v=n;n=v?function(f){return q.querier(v(f))}:q.querier;a(t,!0)}else"sort"===
e?(m=t[0],m.querier=q.querier):"select"===e&&(w=q)});var n=n||function(q){return q};return{filter:0<u.length?R(u).then(function(){return l}):l||c,filterFunction:n,filterOperator:h||null,sort:m,select:w}},_fetch:function(a,d){var b=this._normalizeQuery(),l=b.filter,c=this;return l instanceof Array||l.then?this._union(b,function(h){a(c._restore(h));return!0},d):this._query(b,function(h){a(c._restore(h));return!0},d)},_query:function(a,d,b){function l(z,y,F){q++;var B=h.indices[z];if(B&&!1!==B.indexed&&
(y=y||B.preference*(F||1)||.001,y>n))return n=y,u=z,!0;q++}function c(){function z(y){G--;e.reject(y);N()}M(h._callOnStore("openCursor",A,u,!0),function(y){G++;y.onsuccess=function(F){G--;var B=F.target.result;if(B){if(D){B.advance(D);G++;D=!1;return}p.preFilterOffset++;try{var K=B.value;b.join&&(K=b.join(K));return M(K,function(L){if(0<v([L]).length&&(p.offset++,p.offset>=m&&(E.push(L),!d(L,p.offset-m)||p.offset>=w-1))){y.lastCursor=B;e.resolve(E);N();return}return N(B,b.priority,function(){D=p.preFilterOffset+
1;c()})})}catch(L){e.reject(L)}}else{if(!m||p.offset>=m)p.finished=!0;e.resolve(E)}N()};y.onerror=z},z)}b=b||{};var h=this,m=b.start||0,w=b.end||Infinity,u,n=0,q=0,e=new Q,t=e.promise,v=a.filterFunction;var f=a.filter;var k=a.sort,r=a.select,g;for(g in f){var x=f[g];l(g,null,x&&(x.from||x.to)?.1:1)}var C=JSON.stringify(a.filterOperator)+"-"+JSON.stringify(k);if(k)if(a=k[0],a.property===u||l(a.property,1))var I=a.descending;else{var P=!0;m=0;w=Infinity}if(u){var J=u in f?(f=f[u])&&f.keyRange?f.keyRange:
H.only(f):null;var A=[J,I?"prev":"next"]}else A=[];var p=h.cachedPosition;if(p&&p.queryId===C&&p.offset<m&&1<q){var D=p.preFilterOffset+1;h.cachedPosition=p=W.mixin({},p)}else p=h.cachedPosition={offset:-1,preFilterOffset:-1,queryId:C},2>q&&(p.offset=p.preFilterOffset=(D=m)-1);var E=[];c();if(P){var Z=d;d=S;t=t.then(function(z){var y=b.start||0,F=b.end||Infinity;z=k.querier(z).slice(y,F);z.forEach(Z);return z})}r&&(t=t.then(function(z){return r.querier(z)}));return new U(t,{totalLength:{then:function(z,
y){function F(K){h.cachedCount[C]=K;return Math.round((p.offset+1.01)/(p.preFilterOffset+1.01)*K)}var B=h.cachedCount[C];return B?z(F(B)):p.finished?(y=new Q,y.resolve(p.offset+1),y.then(z)):(J?h._callOnStore("count",[J],u):h._callOnStore("count")).then(F).then(z,y)}}})}})});