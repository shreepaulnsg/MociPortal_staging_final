//>>built
define("dstore/Trackable","dojo/_base/lang dojo/_base/declare dojo/aspect dojo/when dojo/promise/all dojo/_base/array dojo/on".split(" "),function(F,B,M,E,G,I,N){function J(n,p,x){for(var q=n.length-1;0<=q;--q){var t=n[q],z=t.start;t=z+t.count;if(p>t){n.splice(q+1,0,{start:p,count:x-p});return}x>=z&&(p=Math.min(p,z),x=Math.max(x,t),n.splice(q,1))}n.unshift({start:p,count:x-p})}var O=0,L={track:function(){function n(){return function(){var c=this,b=this.inherited(arguments);E(b,function(d){d=c._results=
d.slice();c._partialResults&&(c._partialResults=null);c._ranges=[];J(c._ranges,0,d.length)});return b}}function p(){return function(c){var b=this,d=c.start,e=c.end,f=this.inherited(arguments);this._results||E(f,function(a){return E(a.totalLength,function(l){var g=b._partialResults||(b._partialResults=[]);e=Math.min(e,d+a.length);g.length=l;l=[d,e-d].concat(a);g.splice.apply(g,l);J(b._ranges,d,e);return a})});return f}}function x(c,b){O++;var d=b.target;b=F.delegate(b,P[c]);var e=b.beforeId;E(r._results||
r._partialResults,function(f){if(f){var a,l,g=r._ranges,C="id"in b?b.id:q.getIdentity(d),y=-1,u=-1,m=-1,v=-1;if("delete"===c||"update"===c)for(a=0;-1===y&&a<g.length;++a){var h=g[a];var k=h.start;for(l=k+h.count;k<l;++k)if(q.getIdentity(f[k])==C){y=b.previousIndex=k;u=a;var A=e==C;f.splice(y,1);h.count--;for(k=a+1;k<g.length;++k)g[k].start--;break}}if("add"===c||"update"===c){if(D){if(D([d]).length){var w=0;l=g.length-1;for(A=-1;w<=l&&-1===m;)a=w+Math.round((l-w)/2),h=g[a],u=f.slice(h.start,h.start+
h.count),void 0!==e&&(A=null===e?u.length:K(u,e)),-1===A&&(A=y>=Math.max(0,h.start-1)&&y<=h.start+h.count?y:q.defaultNewToStart?0:u.length),u.splice(A,0,d),k=I.indexOf(D(u),d),C=h.start+k,0===k&&0!==h.start?l=a-1:k>=u.length-1&&C<f.length?w=a+1:(m=C,v=a);if(-1===m&&0<w&&w<g.length)var Q=!0}}else{k=-1;if(void 0===e||A)"update"===c?(m=y,v=u):q.defaultNewToStart?k=m=0:(m=f.length,k=g.length-1);else if(null===e)m=f.length,k=g.length-1;else for(a=0,l=g.length;-1===v&&a<l;++a)h=g[a],m=K(f,e,h.start,h.start+
h.count),-1!==m&&(v=a);-1!==k&&-1===v&&(h=g[k])&&h.start<=m&&m<=h.start+h.count&&(v=k)}if(-1<m&&-1<v)for(b.index=m,f.splice(m,0,d),g[v].count++,a=v+1;a<g.length;++a)g[a].start++;else if(Q)for(b.beforeIndex=g[w].start,a=w;a<g.length;++a)g[a].start++}b.totalLength=f.length}(f=r["on_tracked"+c])&&f.call(r,b)})}var q=this.store||this,t=[],z={add:1,update:1,"delete":1},H;for(H in z)t.push(this.on(H,function(c){return function(b){x(c,b)}}(H)));var r=B.safeMixin(F.delegate(this),{_ranges:[],fetch:n(),fetchRange:p(),
releaseRange:function(c,b){if(this._partialResults){a:for(var d=this._ranges,e=0,f;f=d[e];++e){var a=f.start,l=a+f.count;if(c<=a)if(b>=l)d.splice(e,1);else{f.start=b;f.count=l-f.start;break a}else if(c<l)if(b>a){d.splice(e,1,{start:a,count:c-a},{start:b,count:l-b});break a}else f.count=c-f.start}for(;c<b;++c)delete this._partialResults[c]}},on:function(c,b){var d=this,e=this.getInherited(arguments);return N.parse(r,c,b,function(f,a){return a in z?M.after(r,"on_tracked"+a,b,!0):e.call(d,a,b)})},tracking:{remove:function(){for(;0<
t.length;)t.pop().remove();this.remove=function(){}}},track:null});this.fetchSync&&(B.safeMixin(r,{fetchSync:n(),fetchRangeSync:p()}),r.fetchSync());var D;I.forEach(this.queryLog,function(c){var b=D,d=c.querier;d&&(D=b?function(e){return d(b(e))}:d)});var P={add:{index:void 0},update:{previousIndex:void 0,index:void 0},"delete":{previousIndex:void 0}},K=function(c,b,d,e){e=void 0!==e?e:c.length;for(d=void 0!==d?d:0;d<e;++d)if(q.getIdentity(c[d])===b)return d;return-1};return r}};G=B(null,L);G.create=
function(n,p){n=B.safeMixin(F.delegate(n),L);B.safeMixin(n,p);return n};return G});