//>>built
define("dgrid1/Editor","dojo/_base/array dojo/_base/declare dojo/_base/lang dojo/Deferred dojo/dom-construct dojo/dom-class dojo/on dojo/query dojo/sniff ./Grid".split(" "),function(u,x,v,r,t,p,n,y,q,z){return x(null,{editorFocusWrapperClassName:"dgrid-editor-focus-wrapper",constructor:function(){this._editorInstances={};this._editorColumnListeners=[];this._editorCellListeners={};this._editorsPendingStartup=[]},postCreate:function(){var a=this;this.inherited(arguments);this.on(".dgrid-input:focusin",
function(){a._focusedEditorCell=a.cell(this)});this._editorFocusoutHandle=n.pausable(this.domNode,".dgrid-input:focusout",function(b){a._focusedEditorCell&&a._focusedEditorCell.element.contains(b.target)||(a._focusedEditorCell=null)});this._listeners.push(this._editorFocusoutHandle)},insertRow:function(){this._editorRowListeners={};var a=this.inherited(arguments),b=this.row(a),c=this._editorCellListeners[a.id]=this._editorCellListeners[a.id]||{},d;for(d in this._editorRowListeners)c[d]=this._editorRowListeners[d];
this._editorRowListeners=null;(c=this._previouslyFocusedEditorCell)&&c.row.id===b.id&&(this.edit(this.cell(b,c.column.id)),this._previouslyFocusedEditorCell=null);return a},refresh:function(){for(var a in this._editorInstances){var b=this._getEditorRootNode(this._editorInstances[a].domNode);b&&b.parentNode&&(this._removeEditorBlurHandles(),b.parentNode.removeChild(b))}return this.inherited(arguments)},removeRow:function(a){var b=this,c=this._focusedEditorCell,d=this.row(a);c&&d&&c.row.id===d.id&&
(this._previouslyFocusedEditorCell=c,this._editorFocusoutHandle.pause(),setTimeout(function(){b._editorFocusoutHandle.resume();b._previouslyFocusedEditorCell=null},0));if(this._editorCellListeners[a.id]){for(var g in this._editorCellListeners[a.id])this._editorCellListeners[a.id][g].remove();delete this._editorCellListeners[a.id]}for(c=this._alwaysOnWidgetColumns.length;c--;)if(d=(d=this.cell(a,this._alwaysOnWidgetColumns[c].id).element)&&(d.contents||d).widget)this._editorFocusoutHandle.pause(),
d.destroyRecursive(),this._editorFocusoutHandle.resume();return this.inherited(arguments)},renderArray:function(){var a=this.inherited(arguments);a.length?this._startupPendingEditors():this._editorsPendingStartup=[];return a},_onNotification:function(){this.inherited(arguments);this._startupPendingEditors()},_destroyColumns:function(){this._editorStructureCleanup();this.inherited(arguments)},_editorStructureCleanup:function(){var a=this._editorInstances,b=this._editorColumnListeners;this._editTimer&&
clearTimeout(this._editTimer);for(var c in a){var d=a[c];d.domNode&&d.destroyRecursive()}this._editorInstances={};for(a=b.length;a--;)b[a].remove();for(var g in this._editorCellListeners)for(c in this._editorCellListeners[g])this._editorCellListeners[g][c].remove();for(a=0;a<this._editorColumnListeners.length;a++)this._editorColumnListeners[a].remove();this._editorCellListeners={};this._editorColumnListeners=[];this._editorsPendingStartup=[]},configStructure:function(){this._alwaysOnWidgetColumns=
[];this.inherited(arguments)},_configColumns:function(){for(var a=this.inherited(arguments),b=0,c=a.length;b<c;b++)a[b].editor&&this._configureEditorColumn(a[b]);return a},_configureEditorColumn:function(a){var b=this,c=a.renderCell||this._defaultRenderCell,d=a.editOn,g="string"!==typeof a.editor;d?this._editorInstances[a.id]=this._createSharedEditor(a,c):g&&this._alwaysOnWidgetColumns.push(a);a.renderCell=d?function(f,l,h,e){if(!e||!e.alreadyHooked){var m=n(h,d,function(){b._activeOptions=e;b.edit(this)});
if(b._editorRowListeners)b._editorRowListeners[a.id]=m;else{var k=b.row(f);b._editorCellListeners[k.element.id][a.id]=m}}return c.call(a,f,l,h,e)}:function(f,l,h,e){if(!a.canEdit||a.canEdit(f,l))f=b._createEditor(a,f),b._showEditor(f,a,h,l),h[g?"widget":"input"]=f;else return c.call(a,f,l,h,e)}},edit:function(a){function b(A){c._activeCell=h;c._showEditor(g,f,h,m);c._editTimer=setTimeout(function(){var w=c._getEditorFocusNode(g);w.focus&&w.focus();f._editorBlurHandle&&f._editorBlurHandle.resume();
c._editTimer=null;A.resolve(g)},0)}var c=this,d,g;a.column||(a=this.cell(a));if(!a||!a.element)return null;this._previouslyFocusedEditorCell=a;var f=a.column;var l=f.field;var h=a.element.contents||a.element;if(g=this._editorInstances[f.id]){if(this._activeCell!==h){var e=a.row;var m=(d=this.dirty&&this.dirty[e.id])&&l in d?d[l]:f.get?f.get(e.data):e.data[l];if(!f.canEdit||f.canEdit(a.row.data,m)){var k=new r;a=this._getEditorFocusNode(g);a.offsetWidth?(a.blur(),setTimeout(function(){b(k)},0)):b(k);
return k.promise}}}else if(f.editor&&(g=h.widget||h.input))return k=new r,g.focus&&g.focus(),k.resolve(g),k.promise;return null},refreshCell:function(a){var b=a.column,c=b.get?b.get(a.row.data):a.row.data[b.field],d;b.editor&&(a.column.editOn&&this._activeCell===a.element?d=this._editorInstances[a.column.id]:a.column.editOn||(d=a.element.widget||a.element.input));if(d)return d.domNode?d.set("value",c):this._updateInputValue(d,c),(new r).resolve();b._editorBlurHandle&&b._editorBlurHandle.remove();
return this.inherited(arguments)},_showEditor:function(a,b,c,d){var g=a.domNode;g||this._updateInputValue(a,d);c.innerHTML="";p.add(c,"dgrid-cell-editing");g&&b.editOn&&a.validate&&a.reset&&a.reset();c.appendChild(this._getEditorRootNode(a));g&&!b.editOn?this._editorsPendingStartup.push([a,b,c,d]):this._startupEditor(a,b,c,d)},_startupEditor:function(a,b,c,d){a.domNode&&(a._started||a.startup(),a._dgridIgnoreChange=!0,a.set("value",d),setTimeout(function(){a._dgridIgnoreChange=!1},0));a._dgridLastValue=
d;this._activeCell&&(this._activeValue=d,n.emit(c,"dgrid-editor-show",{grid:this,cell:this.cell(c),column:b,editor:a,bubbles:!0,cancelable:!1}))},_startupPendingEditors:function(){for(var a=this._editorsPendingStartup,b=a.length;b--;)this._startupEditor.apply(this,a[b]);this._editorsPendingStartup=[]},_handleEditorChange:function(a,b){var c=a.target;"_dgridLastValue"in c&&-1<c.className.indexOf("dgrid-input")&&this._updatePropertyFromEditor(b||this.cell(c).column,c,a)},_getEditorFocusNode:function(a){var b=
a.parentNode||a.domNode&&a.domNode.parentNode;b&&p.contains(b,this.editorFocusWrapperClassName)||(b=a.focusNode||a.domNode||a);return b},_getEditorRootNode:function(a){if(a){var b=a.parentNode||a.domNode&&a.domNode.parentNode;b&&p.contains(b,this.editorFocusWrapperClassName)||(b=a.domNode||a);return b}},_createEditorFocusWrapper:function(a,b){isNaN(b)&&(b=isNaN(a.tabIndex)?-1:a.tabIndex);b=t.create("div",{className:this.editorFocusWrapperClassName,tabIndex:b});b.appendChild(a);return b},_createEditor:function(a,
b){var c=a.editor,d=a.editOn,g=this,f="string"!==typeof c&&c,l={};var h=a.editorArgs||{};"function"===typeof h&&(h=h.call(this,a,b));if(f){var e=new f(h);h=e.focusNode||e.domNode;h.className+=" dgrid-input";if(q("mac")&&a.editOn&&/checkbox|radio/i.test(h.type))h=this._createEditorFocusWrapper(e.domNode,a.tabIndex),this._listeners.push(n(h,"blur",function(){e._dgridIgnoreChange||g._updatePropertyFromEditor(a,e,{type:"widget"})}));else if(!d)e.on("change",function(){e._dgridIgnoreChange||g._updatePropertyFromEditor(a,
e,{type:"widget"})})}else this._hasInputListener||(this._hasInputListener=!0,this.on("change",function(k){g._handleEditorChange(k)})),"textarea"===c?f="textarea":(f="input",l.type=c),e=h=t.create(f,v.mixin(l,{className:"dgrid-input",name:a.field,tabIndex:isNaN(a.tabIndex)?-1:a.tabIndex},h)),q("mac")&&a.editOn&&/checkbox|radio/i.test(c)&&(h=this._createEditorFocusWrapper(e),e.tabIndex=0,e.removeAttribute("tabindex")),9>q("ie")&&(c="radio"===c||"checkbox"===c?n(e,"click",function(k){g._handleEditorChange(k,
a)}):n(e,"change",function(k){g._handleEditorChange(k,a)}),d?this._editorColumnListeners.push(c):this._editorRowListeners?this._editorRowListeners[a.id]=c:this._editorCellListeners[this.row(b).element.id][a.id]=c);if(a.autoSelect){var m=e.focusNode||e;m.select&&n(m,"focus",function(){setTimeout(function(){m.select()},0)})}return e},_createSharedEditor:function(a){function b(){var e=d._activeCell;l.blur();"function"===typeof d.focus&&setTimeout(function(){d.focus(e)},g&&9>q("ie")?15:0)}var c=this._createEditor(a),
d=this,g=c.domNode,f=this._getEditorRootNode(c),l=this._getEditorFocusNode(c),h=g?function(){c.set("value",c._dgridLastValue)}:function(){d._updateInputValue(c,c._dgridLastValue);d._updatePropertyFromEditor(a,c)};this._editorColumnListeners.push(n(l,"keydown",function(e){e=e.keyCode||e.which;27===e?(h(),d._activeValue=c._dgridLastValue,b()):13===e&&!1!==a.dismissOnEnter&&b()}));(a._editorBlurHandle=n.pausable(this._getEditorFocusNode(c),"blur",function(e){if(!c.dropDown||!c.dropDown.domNode.contains(e.relatedTarget||
document.activeElement)){if(e&&e.target){var m=e.target;if((m=p.contains(m,d.editorFocusWrapperClassName)&&m)&&e.relatedTarget===(c.focusNode||c)){m.focus();return}}d._updatePropertyFromEditor(a,c,{type:"widget"});e=f.parentNode;m={alreadyHooked:!0};var k=d.cell(f);n.emit(k.element,"dgrid-editor-hide",{grid:d,cell:k,column:a,editor:c,bubbles:!0,cancelable:!1});a._editorBlurHandle.pause();e.removeChild(f);k.row&&(p.remove(k.element,"dgrid-cell-editing"),t.empty(e),z.appendIfNode(e,a.renderCell(k.row.data,
d._activeValue,e,d._activeOptions?v.delegate(m,d._activeOptions):m)));d._focusedEditorCell=d._activeCell=d._activeValue=d._activeOptions=null}})).pause();this._editorColumnListeners.push(a._editorBlurHandle);return c},_updatePropertyFromEditor:function(a,b,c){var d;if(!b.isValid||b.isValid())if(c=this._updateProperty((b.domNode||b).parentNode,this._activeCell?this._activeValue:b._dgridLastValue,this._retrieveEditorValue(a,b),c),this._activeCell?this._activeValue=c:b._dgridLastValue=c,"radio"===b.type&&
b.name&&!a.editOn&&a.field)for(d in c=this.row(b),y("input[type\x3dradio][name\x3d"+b.name+"]",this.contentNode).forEach(function(g){var f=this.row(g);g!==b&&g._dgridLastValue&&(g._dgridLastValue=!1,this.updateDirty?this.updateDirty(f.id,a.field,!1):f.data[a.field]=!1)},this),this.dirty)c.id.toString()!==d&&this.dirty[d][a.field]&&this.updateDirty(d,a.field,!1)},_updateProperty:function(a,b,c,d){var g=this;if((b&&b.valueOf())!==(c&&c.valueOf())){var f=this.cell(a),l=f.row,h=f.column;a=f.element;if(h.field&&
l)if(f={grid:this,cell:f,oldValue:b,value:c,bubbles:!0,cancelable:!0},d&&d.type&&(f.parentType=d.type),n.emit(a,"dgrid-datachange",f))this.updateDirty?(this.updateDirty(l.id,h.field,c),h.autoSave&&setTimeout(function(){g._trackError("save")},0)):l.data[h.field]=c;else{var e;(e=a.widget)?(e._dgridIgnoreChange=!0,e.set("value",b),setTimeout(function(){e._dgridIgnoreChange=!1},0)):(e=a.input)&&this._updateInputValue(e,b);return b}}return c},_updateInputValue:function(a,b){a.value=b;if("radio"===a.type||
"checkbox"===a.type)a.checked=a.defaultChecked=!!b},_retrieveEditorValue:function(a,b){return"function"===typeof b.get?this._convertEditorValue(b.get("value")):this._convertEditorValue(b["checkbox"===b.type||"radio"===b.type?"checked":"value"])},_convertEditorValue:function(a,b){"number"===typeof b?a=isNaN(a)?a:parseFloat(a):"boolean"===typeof b?a="true"===a?!0:"false"===a?!1:a:b instanceof Date&&(b=new Date(a),a=isNaN(b.getTime())?a:b);return a},_removeEditorBlurHandles:function(){u.forEach(this.subRows,
function(a){a instanceof Array?u.forEach(a,function(b){b._editorBlurHandle&&b._editorBlurHandle.remove()}):a._editorBlurHandle&&a._editorBlurHandle.remove()})}})});