//>>built
define("xstyle/core/Definition",["xstyle/core/utils","xstyle/core/es6"],function(l,m){function n(a){(this.computeValue=a)&&a.reverse&&this.setReverseCompute(a.reverse)}function t(a,b,c){if(b&&b.forElement)return{forElement:function(d){d=b.selectElement?b.selectElement(d):d;var e=["_cache_"+a.id];if(e in d){var h=d[e+"observe"];h.addKey&&h.addKey(c);return d[e][c]}var f=d[e]=b.forElement(d),g=d[e+"observe"]=p(a,f,c,{elements:[d]});d.xcleanup=function(k){k&&m.unobserve(f,g)};return f[c]}}}function p(a,
b,c,d){var e=a._properties;if("object"==typeof b){var h=function(f){for(var g=0;g<f.length;g++){var k=e[f[g].name];k&&k.invalidate&&k.invalidate(d)}};m.observe(b,h);h.addKey&&h.addKey(c)}return h}var q={},u=1;n.prototype={id:"x-variable-"+u++,cache:q,valueOf:function(){if((this.dependents||this._properties)&&this.cache!==q)return this.cache;var a=this,b=this.computeValue;if(b.then)return this.cache=b.then(function(c){a.computeValue=c;(c=a.cache=c())&&c.then&&c.then(function(d){a.cache=d});return c});
(b=a.cache=b())&&b.then&&b.then(function(c){a.cache=c});return b},property:function(a){var b=this._properties||(this._properties={}),c=b[a];if(!c){var d=this;c=b[a]=new n(function(){return l.when(d.valueOf(),function(e){if(e&&e.forRule)return{forRule:function(f){f=e.selectRule?e.selectRule(f):f;var g=["_cache_"+d.id],k;if((k=g in f?f[g]:f[g]=e.forRule(f))&&k.forElement)return t(d,k,a);var r=f[g+"observe"];r&&(r.addKey?r.addKey(a):f[g+"observe"]=p(d,k,a,{rules:[f]}));return k[a]}};if(e&&e.forElement)return t(d,
e,a);var h=d.cacheObserve;h?h.addKey&&h.addKey(a):h=d.cacheObserve=p(d,e,a);return e[a]})});c.key=a;c.parent=this;c.put=function(e){return l.when(d.valueOf(),function(h){function f(g){if(g.forElement)return{forElement:function(k){g.forElement(k)[a]=e}};g[a]=e}if(h.forRule)return{forRule:function(g){return f(h.forRule(g))}};f(h)})};c.id=this.id+"-"+a}return c},invalidate:function(a){var b=this.cacheObserve;b&&(m.unobserve(this.cache,b),this.cacheObserve=null);this.cache=q;b=this._properties;for(d in b)b[d].invalidate(a);
var c=this.dependents||0;var d=0;for(b=c.length;d<b;d++)try{c[d].invalidate(a)}catch(e){console.error(e,"invalidating a definition")}},dependencyOf:function(a){(this.dependents||(this.dependents=[])).push(a)},notDependencyOf:function(a){for(var b=this.dependents||0,c=0;c<b.length;c++)b[c]===a&&b.splice(c--,1)},setReverseCompute:function(a){this.put=function(){var b=a.apply(this,arguments);this.invalidate();return b}},setCompute:function(a){(this.computeValue=a)&&a.reverse&&this.setReverseCompute(a.reverse);
this.invalidate()},setSource:function(a){this.computeValue=function(){return a};this.invalidate()},observe:function(a){this.computeValue&&a(this.valueOf());var b=this;return this.dependencyOf({invalidate:function(){a(b.valueOf())}})},newElement:function(){return l.when(this.valueOf(),function(a){return a&&a.newElement&&a.newElement()})}};return n});