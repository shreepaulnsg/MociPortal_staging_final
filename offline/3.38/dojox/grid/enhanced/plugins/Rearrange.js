//>>built
define("dojox/grid/enhanced/plugins/Rearrange","dojo/_base/kernel dojo/_base/lang dojo/_base/declare dojo/_base/array dojo/_base/connect ../../EnhancedGrid ../_Plugin ./_RowMapLayer".split(" "),function(A,B,E,p,t,F,G,H){A=E("dojox.grid.enhanced.plugins.Rearrange",G,{name:"rearrange",constructor:function(b,a){this.grid=b;this.setArgs(a);a=new H(b);dojox.grid.enhanced.plugins.wrap(b,"_storeLayerFetch",a)},setArgs:function(b){this.args=B.mixin(this.args||{},b||{});this.args.setIdentifierForNewItem=this.args.setIdentifierForNewItem||
function(a){return a}},destroy:function(){this.inherited(arguments);this.grid.unwrap("rowmap")},onSetStore:function(b){this.grid.layer("rowmap").clearMapping()},_hasIdentity:function(b){var a=this.grid,g=a.store,f=a.layout.cells;return g.getFeatures()["dojo.data.api.Identity"]&&p.some(b,function(d){return g.getIdentityAttributes(a._by_idx[d.r].item)==f[d.c].field})?!0:!1},moveColumns:function(b,a){var g=this.grid,f=g.layout,d=f.cells,e,h=0,c=!0;var k={};var l={};b.sort(function(x,C){return x-C});
for(e=0;e<b.length;++e)k[b[e]]=e,b[e]<a&&++h;var n=0,m=0,r=Math.max(b[b.length-1],a);r==d.length&&--r;var y=Math.min(b[0],a);for(e=y;e<=r;++e){var v=k[e];0<=v?l[e]=a-h+v:e<a?(l[e]=y+n,++n):e>=a&&(l[e]=a+b.length-h+m,++m)}h=0;a==d.length&&(--a,c=!1);g._notRefreshSelection=!0;for(e=0;e<b.length;++e)k=b[e],k<a&&(k-=h),++h,k!=a&&(f.moveColumn(d[k].view.idx,d[a].view.idx,k,a,c),d=f.cells),a<=k&&++a;delete g._notRefreshSelection;t.publish("dojox/grid/rearrange/move/"+g.id,["col",l,b])},moveRows:function(b,
a){var g=this.grid,f={},d=[],e=[],h=b.length,c,k;for(c=0;c<h;++c){e=b[c];if(e>=a)break;d.push(e)}e=b.slice(c);c=d;if(h=c.length){var l={};p.forEach(c,function(m){l[m]=!0});f[c[0]]=a-h;d=0;c=c[d]+1;for(k=c-1;c<a;++c)l[c]?(++d,f[c]=a-h+d):(f[c]=k,++k)}c=e;if(h=c.length)for(l={},p.forEach(c,function(m){l[m]=!0}),f[c[h-1]]=a+h-1,d=h-1,c=c[d]-1,k=c+1;c>=a;--c)l[c]?(--d,f[c]=a+d):(f[c]=k,--k);var n=B.clone(f);g.layer("rowmap").setMapping(f);g.forEachLayer(function(m){return"rowmap"!=m.name()?(m.invalidate(),
!0):!1},!1);g.selection.selected=[];g._noInternalMapping=!0;g._refresh();setTimeout(function(){t.publish("dojox/grid/rearrange/move/"+g.id,["row",n,b]);g._noInternalMapping=!1},0)},moveCells:function(b,a){var g=this.grid,f=g.store;if(f.getFeatures()["dojo.data.api.Write"]&&(b.min.row!=a.min.row||b.min.col!=a.min.col)){var d=g.layout.cells,e,h,c=[],k=[];var l=b.min.row;for(e=a.min.row;l<=b.max.row;++l,++e){var n=b.min.col;for(h=a.min.col;n<=b.max.col;++n,++h){for(;d[n]&&d[n].hidden;)++n;for(;d[h]&&
d[h].hidden;)++h;c.push({r:l,c:n});k.push({r:e,c:h,v:d[n].get(l,g._by_idx[l].item)})}}this._hasIdentity(c.concat(k))?console.warn("Can not write to identity!"):(p.forEach(c,function(m){f.setValue(g._by_idx[m.r].item,d[m.c].field,"")}),p.forEach(k,function(m){f.setValue(g._by_idx[m.r].item,d[m.c].field,m.v)}),f.save({onComplete:function(){t.publish("dojox/grid/rearrange/move/"+g.id,["cell",{from:b,to:a}])}}))}},copyCells:function(b,a){var g=this.grid,f=g.store;if(f.getFeatures()["dojo.data.api.Write"]&&
(b.min.row!=a.min.row||b.min.col!=a.min.col)){var d=g.layout.cells,e,h,c=[];var k=b.min.row;for(e=a.min.row;k<=b.max.row;++k,++e){var l=b.min.col;for(h=a.min.col;l<=b.max.col;++l,++h){for(;d[l]&&d[l].hidden;)++l;for(;d[h]&&d[h].hidden;)++h;c.push({r:e,c:h,v:d[l].get(k,g._by_idx[k].item)})}}this._hasIdentity(c)?console.warn("Can not write to identity!"):(p.forEach(c,function(n){f.setValue(g._by_idx[n.r].item,d[n.c].field,n.v)}),f.save({onComplete:function(){setTimeout(function(){t.publish("dojox/grid/rearrange/copy/"+
g.id,["cell",{from:b,to:a}])},0)}}))}},changeCells:function(b,a,g){var f=this.grid,d=f.store;if(d.getFeatures()["dojo.data.api.Write"]){var e=f.layout.cells,h=b.layout.cells,c,k,l=[];var n=a.min.row;for(c=g.min.row;n<=a.max.row;++n,++c){var m=a.min.col;for(k=g.min.col;m<=a.max.col;++m,++k){for(;h[m]&&h[m].hidden;)++m;for(;e[k]&&e[k].hidden;)++k;l.push({r:c,c:k,v:h[m].get(n,b._by_idx[n].item)})}}this._hasIdentity(l)?console.warn("Can not write to identity!"):(p.forEach(l,function(r){d.setValue(f._by_idx[r.r].item,
e[r.c].field,r.v)}),d.save({onComplete:function(){t.publish("dojox/grid/rearrange/change/"+f.id,["cell",g])}}))}},clearCells:function(b){var a=this.grid,g=a.store;if(g.getFeatures()["dojo.data.api.Write"]){var f=a.layout.cells,d,e,h=[];for(d=b.min.row;d<=b.max.row;++d)for(e=b.min.col;e<=b.max.col;++e){for(;f[e]&&f[e].hidden;)++e;h.push({r:d,c:e})}this._hasIdentity(h)?console.warn("Can not write to identity!"):(p.forEach(h,function(c){g.setValue(a._by_idx[c.r].item,f[c.c].field,"")}),g.save({onComplete:function(){t.publish("dojox/grid/rearrange/change/"+
a.id,["cell",b])}}))}},insertRows:function(b,a,g){try{var f=this.grid,d=f.store,e=f.rowCount,h={},c=0,k=[],l,n=0>g,m=this,r=a.length;if(n)g=0;else for(l=g;l<f.rowCount;++l)h[l]=l+r;if(d.getFeatures()["dojo.data.api.Write"]){if(b){var y=b.store;if(n)var v=p.filter(p.map(f.layout.cells,function(q){return q.field}),function(q){return q});else{for(l=0;!x;++l)var x=f._by_idx[l];v=d.getAttributes(x.item)}var C=[];p.forEach(a,function(q,w){var u={},D=b._by_idx[q];if(D){p.forEach(v,function(z){u[z]=y.getValue(D.item,
z)});u=m.args.setIdentifierForNewItem(u,d,e+c)||u;try{d.newItem(u),k.push(g+w),h[e+c]=g+w,++c}catch(z){console.log("insertRows newItem:",z,u)}}else C.push(q)})}else if(a.length&&B.isObject(a[0]))p.forEach(a,function(q,w){q=m.args.setIdentifierForNewItem(q,d,e+c)||q;try{d.newItem(q),k.push(g+w),h[e+c]=g+w,++c}catch(u){console.log("insertRows newItem:",u,q)}});else return;f.layer("rowmap").setMapping(h);d.save({onComplete:function(){f._refresh();setTimeout(function(){t.publish("dojox/grid/rearrange/insert/"+
f.id,["row",k])},0)}})}}catch(q){console.log("insertRows:",q)}},removeRows:function(b){var a=this.grid,g=a.store;try{p.forEach(p.map(b,function(f){return a._by_idx[f]}),function(f){f&&g.deleteItem(f.item)}),g.save({onComplete:function(){t.publish("dojox/grid/rearrange/remove/"+a.id,["row",b])}})}catch(f){console.log("removeRows:",f)}},_getPageInfo:function(){var b=this.grid.scroller,a=b.page,g=b.page,f=b.firstVisibleRow,d=b.lastVisibleRow,e=b.rowsPerPage,h,c,k,l=[];p.forEach(b.pageNodes[0],function(n,
m){n&&(k=!1,h=m*e,c=(m+1)*e-1,f>=h&&f<=c&&(a=m,k=!0),d>=h&&d<=c&&(g=m,k=!0),!k&&(h>d||c<f)&&l.push(m))});return{topPage:a,bottomPage:g,invalidPages:l}}});F.registerPlugin(A);return A});