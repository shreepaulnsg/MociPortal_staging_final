//>>built
define("dojox/geo/openlayers/Map","dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/json dojo/dom dojo/dom-style ./_base ./TouchInteractionSupport ./Layer ./Patch".split(" "),function(m,n,u,l,p,q,v,h,r,k,t){m.experimental("dojox.geo.openlayers.Map");t.patchGFX();return n("dojox.geo.openlayers.Map",null,{olMap:null,_tp:null,constructor:function(a,b){b||(b={});a=q.byId(a);this._tp={x:0,y:0};var e=b.openLayersMapOptions;e||(e={controls:[new OpenLayers.Control.ScaleLine({maxWidth:200}),
new OpenLayers.Control.Navigation]});if(b.accessible){var c=new OpenLayers.Control.KeyboardDefaults;e.controls||(e.controls=[]);e.controls.push(c)}c=b.baseLayerType;c||(c=h.BaseLayerType.OSM);this.olMap=a=new OpenLayers.Map(a,e);this._layerDictionary={olLayers:[],layers:[]};b.touchHandler&&(this._touchControl=new r(a));a=this._createBaseLayer(b);this.addLayer(a);this.initialFit(b)},initialFit:function(a){(a=a.initialLocation)||(a=[-160,70,160,-70]);this.fitTo(a)},setBaseLayerType:function(a){if(a==
this.baseLayerType)return null;var b=null;"string"==typeof a?(b={baseLayerName:a,baseLayerType:a},this.baseLayerType=a):"object"==typeof a&&(b=a,this.baseLayerType=b.baseLayerType);a=null;if(null!=b&&(a=this._createBaseLayer(b),null!=a)){b=this.olMap;var e=b.getZoom(),c=b.getCenter(),d=!!c&&!!b.baseLayer&&!!b.baseLayer.map;if(d){var f=b.getProjectionObject();null!=f&&(c=c.transform(f,h.EPSG4326))}f=b.baseLayer;null!=f&&(f=this._getLayer(f),this.removeLayer(f));null!=a&&this.addLayer(a);d&&(f=b.getProjectionObject(),
null!=f&&(c=c.transform(h.EPSG4326,f)),b.setCenter(c,e))}return a},getBaseLayerType:function(){return this.baseLayerType},getScale:function(a){var b=null;b=this.olMap;if(a){if(!b.getUnits())return null;a=OpenLayers.INCHES_PER_UNIT;b=(b.getGeodesicPixelSize().w||1E-6)*a.km*OpenLayers.DOTS_PER_INCH}else b=b.getScale();return b},getOLMap:function(){return this.olMap},_createBaseLayer:function(a){var b=null,e=a.baseLayerType,c=a.baseLayerUrl,d=a.baseLayerName;a=a.baseLayerOptions;d||(d=e);a||(a={});switch(e){case h.BaseLayerType.OSM:a.transitionEffect=
"resize";b=new k(d,{olLayer:new OpenLayers.Layer.OSM(d,c,a)});break;case h.BaseLayerType.Transport:a.transitionEffect="resize";b=new k(d,{olLayer:new OpenLayers.Layer.OSM.TransportMap(d,c,a)});break;case h.BaseLayerType.WMS:c||(c="http://labs.metacarta.com/wms/vmap0",a.layers||(a.layers="basic"));b=new k(d,{olLayer:new OpenLayers.Layer.WMS(d,c,a,{transitionEffect:"resize"})});break;case h.BaseLayerType.GOOGLE:b=new k(d,{olLayer:new OpenLayers.Layer.Google(d,a)});break;case h.BaseLayerType.VIRTUAL_EARTH:b=
new k(d,{olLayer:new OpenLayers.Layer.VirtualEarth(d,a)});break;case h.BaseLayerType.YAHOO:b=new k(d,{olLayer:new OpenLayers.Layer.Yahoo(d,a)});break;case h.BaseLayerType.ARCGIS:c||(c="http://server.arcgisonline.com/ArcGIS/rest/services/ESRI_StreetMap_World_2D/MapServer/export"),b=new k(d,{olLayer:new OpenLayers.Layer.ArcGIS93Rest(d,c,a,{})})}null==b&&(e instanceof OpenLayers.Layer?b=e:(a.transitionEffect="resize",b=new k(d,{olLayer:new OpenLayers.Layer.OSM(d,c,a)}),this.baseLayerType=h.BaseLayerType.OSM));
return b},removeLayer:function(a){var b=this.olMap,e=l.indexOf(this._layerDictionary.layers,a);0<e&&this._layerDictionary.layers.splice(e,1);a=a.olLayer;var c=l.indexOf(this._layerDictionary.olLayers,a);0<c&&this._layerDictionary.olLayers.splice(e,c);b.removeLayer(a,!1)},layerIndex:function(a,b){var e=this.olMap;if(!b)return e.getLayerIndex(a.olLayer);e.setLayerIndex(a.olLayer,b);this._layerDictionary.layers.sort(function(c,d){return e.getLayerIndex(c.olLayer)-e.getLayerIndex(d.olLayer)});this._layerDictionary.olLayers.sort(function(c,
d){return e.getLayerIndex(c)-e.getLayerIndex(d)});return b},addLayer:function(a){a.dojoMap=this;var b=this.olMap,e=a.olLayer;this._layerDictionary.olLayers.push(e);this._layerDictionary.layers.push(a);b.addLayer(e);a.added()},_getLayer:function(a){a=l.indexOf(this._layerDictionary.olLayers,a);return-1!=a?this._layerDictionary.layers[a]:null},getLayer:function(a,b){a=this.olMap.getBy("layers",a,b);var e=[];l.forEach(a,function(c){e.push(this._getLayer(c))},this);return e},getLayerCount:function(){var a=
this.olMap;return null==a.layers?0:a.layers.length},fitTo:function(a){var b=this.olMap,e=h.EPSG4326;if(null==a)a=this.transformXY(0,0,e),b.setCenter(new OpenLayers.LonLat(a.x,a.y));else{var c=null,d="string"==typeof a?p.fromJson(a):a;if(d.hasOwnProperty("bounds")){var f=d.bounds;c=new OpenLayers.Bounds;var g=this.transformXY(f[0],f[1],e);c.left=g.x;c.top=g.y;g=this.transformXY(f[2],f[3],e);c.right=g.x;c.bottom=g.y}null==c&&d.hasOwnProperty("position")&&(f=d.position,d=d.hasOwnProperty("extent")?d.extent:
1,"string"==typeof d&&(d=parseFloat(d)),c=new OpenLayers.Bounds,g=this.transformXY(f[0]-d,f[1]+d,e),c.left=g.x,c.top=g.y,g=this.transformXY(f[0]+d,f[1]-d,e),c.right=g.x,c.bottom=g.y);null==c&&4==a.length&&(c=new OpenLayers.Bounds,g=this.transformXY(a[0],a[1],e),c.left=g.x,c.top=g.y,g=this.transformXY(a[2],a[3],e),c.right=g.x,c.bottom=g.y);null!=c&&b.zoomToExtent(c,!0)}},transform:function(a,b,e){return this.transformXY(a.x,a.y,b,e)},transformXY:function(a,b,e,c){var d=this._tp;d.x=a;d.y=b;e||(e=h.EPSG4326);
c||(c=this.olMap.getProjectionObject());return d=OpenLayers.Projection.transform(d,e,c)}})});