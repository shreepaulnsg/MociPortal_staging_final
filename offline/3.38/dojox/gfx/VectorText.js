//>>built
define("dojox/gfx/VectorText","dojo/_base/lang dojo/_base/declare dojo/_base/array dojo/_base/loader dojo/_base/xhr ./_base dojox/xml/DomParser dojox/html/metrics ./matrix".split(" "),function(B,I,r,N,J,k,K,L,F){var M=function(a){var c;J.get({url:a,sync:!0,load:function(b){c=b}});return c};B.getObject("dojox.gfx.VectorText",!0);B.mixin(k,{vectorFontFitting:{NONE:0,FLOW:1,FIT:2},defaultVectorText:{type:"vectortext",x:0,y:0,width:null,height:null,text:"",align:"start",decoration:"none",fitting:0,leading:1.5},
defaultVectorFont:{type:"vectorfont",size:"10pt",family:null},_vectorFontCache:{},_svgFontCache:{},getVectorFont:function(a){return k._vectorFontCache[a]?k._vectorFontCache[a]:new k.VectorFont(a)}});return I("dojox.gfx.VectorFont",null,{_entityRe:/&(quot|apos|lt|gt|amp|#x[^;]+|#\d+);/g,_decodeEntitySequence:function(a){if(a.match(this._entityRe)){for(var c={amp:"\x26",apos:"'",quot:'"',lt:"\x3c",gt:"\x3e"},b,d="";null!==(b=this._entityRe.exec(a));)d="x"==b[1].charAt(1)?d+String.fromCharCode(parseInt(b[1].slice(2),
16)):isNaN(parseInt(b[1].slice(1),10))?d+(c[b[1]]||""):d+String.fromCharCode(parseInt(b[1].slice(1),10));return d}},_parse:function(a,c){a=k._svgFontCache[c]||K.parse(a);var b=a.documentElement.byName("font")[0],d=a.documentElement.byName("font-face")[0],f=parseFloat(d.getAttribute("units-per-em")||1E3,10),h={x:parseFloat(b.getAttribute("horiz-adv-x"),10),y:parseFloat(b.getAttribute("vert-adv-y")||0,10)};h.y||(h.y=f);b={horiz:{x:parseFloat(b.getAttribute("horiz-origin-x")||0,10),y:parseFloat(b.getAttribute("horiz-origin-y")||
0,10)},vert:{x:parseFloat(b.getAttribute("vert-origin-x")||0,10),y:parseFloat(b.getAttribute("vert-origin-y")||0,10)}};var e=d.getAttribute("font-family"),g=d.getAttribute("font-style")||"all",m=d.getAttribute("font-variant")||"normal",q=d.getAttribute("font-weight")||"all",G=d.getAttribute("font-stretch")||"normal",t=d.getAttribute("unicode-range")||"U+0-10FFFF";d.getAttribute("panose-1");d.getAttribute("cap-height");var w=parseFloat(d.getAttribute("ascent")||f-b.vert.y,10),D=parseFloat(d.getAttribute("descent")||
b.vert.y,10),C={},n=e;d.byName("font-face-name")[0]&&(n=d.byName("font-face-name")[0].getAttribute("name"));if(!k._vectorFontCache[n]){r.forEach(["alphabetic","ideographic","mathematical","hanging"],function(l){var p=d.getAttribute(l);null!==p&&(C[l]=parseFloat(p,10))});var u=parseFloat(a.documentElement.byName("missing-glyph")[0].getAttribute("horiz-adv-x")||h.x,10),y={},v={},H=a.documentElement.byName("glyph");r.forEach(H,function(l){var p=l.getAttribute("unicode"),x=l.getAttribute("glyph-name"),
z=parseFloat(l.getAttribute("horiz-adv-x")||h.x,10);l=l.getAttribute("d");p.match(this._entityRe)&&(p=this._decodeEntitySequence(p));z={code:p,name:x,xAdvance:z,path:l};y[p]=z;v[x]=z},this);H=a.documentElement.byName("hkern");r.forEach(H,function(l,p){p=-parseInt(l.getAttribute("k"),10);var x=l.getAttribute("u1"),z=l.getAttribute("g1"),E=l.getAttribute("u2");l=l.getAttribute("g2");var A;x?(x=this._decodeEntitySequence(x),y[x]&&(A=y[x])):v[z]&&(A=v[z]);A&&(A.kern||(A.kern={}),E?(E=this._decodeEntitySequence(E),
A.kern[E]={x:p}):v[l]&&(A.kern[v[l].code]={x:p}))},this);B.mixin(this,{family:e,name:n,style:g,variant:m,weight:q,stretch:G,range:t,viewbox:{width:f,height:f},origin:b,advance:B.mixin(h,{missing:{x:u,y:u}}),ascent:w,descent:D,baseline:C,glyphs:y});k._vectorFontCache[n]=this;k._vectorFontCache[c]=this;n==e||k._vectorFontCache[e]||(k._vectorFontCache[e]=this);k._svgFontCache[c]||(k._svgFontCache[c]=a)}},_clean:function(){var a=this.name,c=this.family;r.forEach("family name style variant weight stretch range viewbox origin advance ascent descent baseline glyphs".split(" "),
function(b){try{delete this[b]}catch(d){}},this);k._vectorFontCache[a]&&delete k._vectorFontCache[a];k._vectorFontCache[c]&&delete k._vectorFontCache[c];return this},constructor:function(a){this._defaultLeading=1.5;void 0!==a&&this.load(a)},load:function(a){this.onLoadBegin(a.toString());this._parse(k._svgFontCache[a.toString()]||M(a.toString()),a.toString());this.onLoad(this);return this},initialized:function(){return null!==this.glyphs},_round:function(a){return Math.round(1E3*a)/1E3},_leading:function(a){return this.viewbox.height*
(a||this._defaultLeading)},_normalize:function(a){return a.replace(/\s+/g,String.fromCharCode(32))},_getWidth:function(a){var c=0,b=0,d=null;r.forEach(a,function(f,h){b=f.xAdvance;a[h]&&f.kern&&f.kern[a[h].code]&&(b+=f.kern[a[h].code].x);c+=b;d=f});d&&" "==d.code&&(c-=d.xAdvance);return this._round(c)},_getLongestLine:function(a){var c=0,b=0;r.forEach(a,function(d,f){d=Math.max(c,this._getWidth(d));d>c&&(c=d,b=f)},this);return{width:c,index:b,line:a[b]}},_trim:function(a){var c=function(b){b.length&&
(" "==b[b.length-1].code&&b.splice(b.length-1,1),b.length&&" "==b[0].code&&b.splice(0,1))};B.isArray(a[0])?r.forEach(a,c):c(a);return a},_split:function(a,c){var b=this._getWidth(a);c=Math.floor(b/c);b=[];for(var d=0,f=[],h=!1,e=0,g=a.length;e<g;e++){" "==a[e].code&&(h=!0);d+=a[e].xAdvance;e+1<g&&a[e].kern&&a[e].kern[a[e+1].code]&&(d+=a[e].kern[a[e+1].code].x);if(d>=c){for(d=a[e];h&&" "!=d.code&&0<=e;)d=f.pop(),e--;b.push(f);f=[];d=0;h=!1}f.push(a[e])}f.length&&b.push(f);return this._trim(b)},_getSizeFactor:function(a){a+=
"";var c=L.getCachedFontMeasurements(),b=this.viewbox.height,d=c["1em"];d=parseFloat(a,10);if(-1<a.indexOf("em"))return this._round(c["1em"]*d/b);if(-1<a.indexOf("ex"))return this._round(c["1ex"]*d/b);if(-1<a.indexOf("pt"))return this._round(c["12pt"]/12*d/b);if(-1<a.indexOf("px"))return this._round(c["16px"]/16*d/b);if(-1<a.indexOf("%"))return this._round(d/100*c["1em"]/b);d=c[a]||c.medium;return this._round(d/b)},_getFitFactor:function(a,c,b,d){if(b){var f=this._getLongestLine(a).width;return this._round(Math.min(c/
f,b/(a.length*this.viewbox.height*d-(this.viewbox.height*d-this.viewbox.height))))}return this._round(c/this._getWidth(a))},_getBestFit:function(a,c,b,d){for(var f=32,h=0,e=f;0<f;){var g=this._getFitFactor(this._split(a,f),c,b,d);g>h&&(h=g,e=f);f--}return{scale:h,lines:this._split(a,e)}},_getBestFlow:function(a,c,b){for(var d=[],f=0,h=[],e=!1,g=0,m=a.length;g<m;g++){" "==a[g].code&&(e=!0);var q=a[g].xAdvance;g+1<m&&a[g].kern&&a[g].kern[a[g+1].code]&&(q+=a[g].kern[a[g+1].code].x);f+=b*q;if(f>=c){for(f=
a[g];e&&" "!=f.code&&0<=g;)f=h.pop(),g--;d.push(h);h=[];f=0;e=!1}h.push(a[g])}h.length&&d.push(h);return this._trim(d)},getWidth:function(a,c){return this._getWidth(r.map(this._normalize(a).split(""),function(b){return this.glyphs[b]||{xAdvance:this.advance.missing.x}},this))*(c||1)},getLineHeight:function(a){return this.viewbox.height*(a||1)},getCenterline:function(a){return this.viewbox.height/2*(a||1)},getBaseline:function(a){return(a||1)*(this.viewbox.height+this.descent)},draw:function(a,c,b,
d,f){if(!this.initialized())throw Error("dojox.gfx.VectorFont.draw(): we have not been initialized yet.");var h=a.createGroup();(c.x||c.y)&&a.applyTransform({dx:c.x||0,dy:c.y||0});var e=r.map(this._normalize(c.text).split(""),function(v){return this.glyphs[v]||{path:null,xAdvance:this.advance.missing.x}},this);a=b.size;var g=c.fitting,m=c.width,q=c.height;b=c.align;c=c.leading||this._defaultLeading;!g||(g!=k.vectorFontFitting.FLOW||m)&&(g!=k.vectorFontFitting.FIT||m&&q)||(g=k.vectorFontFitting.NONE);
switch(g){case k.vectorFontFitting.FIT:e=this._getBestFit(e,m,q,c);a=e.scale;e=e.lines;break;case k.vectorFontFitting.FLOW:a=this._getSizeFactor(a);e=this._getBestFlow(e,m,a);break;default:a=this._getSizeFactor(a),e=[e]}e=r.filter(e,function(v){return 0<v.length});m=0;g=this._getLongestLine(e).width;q=0;for(var G=e.length;q<G;q++){for(var t=0,w=e[q],D=this._getWidth(w),C=h.createGroup(),n=0;n<w.length;n++){var u=w[n];if(null!==u.path){var y=C.createPath(u.path).setFill(d);f&&y.setStroke(f);y.setTransform([F.flipY,
F.translate(t,-this.viewbox.height-this.descent)])}t+=u.xAdvance;n+1<w.length&&u.kern&&u.kern[w[n+1].code]&&(t+=u.kern[w[n+1].code].x)}t=0;"middle"==b?t=g/2-D/2:"end"==b&&(t=g-D);C.setTransform({dx:t,dy:m});m+=this.viewbox.height*c}h.setTransform(F.scale(a));return h},onLoadBegin:function(a){},onLoad:function(a){}})});