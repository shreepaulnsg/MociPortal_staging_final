//>>built
define("dojox/store/db/SQL","dojo/_base/declare dojo/Deferred dojo/when dojo/store/util/QueryResults dojo/_base/lang dojo/promise/all".split(" "),function(z,A,q,B,t,r){function u(a){return a&&t.mixin(a,JSON.parse(a.__extra))}var C=/(.*)\*$/;return z([],{constructor:function(a){var b=a.dbConfig;this.database=openDatabase(a.dbName||"dojo-db","1.0","dojo-db",4194304);var l=this.indexPrefix=a.indexPrefix||"idx_",g=a.table||a.storeName;this.table=(a.table||a.storeName).replace(/[^\w]/g,"_");a=[];this.indices=
b.stores[g];this.repeatingIndices={};for(var c in this.indices)this.indices[c].multiEntry&&(this.repeatingIndices[c]=!0);if(!b.available){for(g in b.stores){var k=b.stores[g],h=g.replace(/[^\w]/g,"_"),e=k[this.idProperty],d=["__extra",this.idProperty+" "+(e&&e.autoIncrement?"INTEGER PRIMARY KEY AUTOINCREMENT":"PRIMARY KEY")];e=[this.idProperty];for(c in k)c!=this.idProperty&&d.push(c);a.push(this.executeSql("CREATE TABLE IF NOT EXISTS "+h+" ("+d.join(",")+")"));for(c in k)c!=this.idProperty&&(k[c].multiEntry?
(e.push(c),d=h+"_repeating_"+c,a.push(this.executeSql("CREATE TABLE IF NOT EXISTS "+d+" (id,value)")),a.push(this.executeSql("CREATE INDEX IF NOT EXISTS idx_"+d+"_id ON "+d+"(id)")),a.push(this.executeSql("CREATE INDEX IF NOT EXISTS idx_"+d+"_value ON "+d+"(value)"))):(a.push(this.executeSql("ALTER TABLE "+h+" ADD "+c).then(null,function(){})),!1!==k[c].indexed&&a.push(this.executeSql("CREATE INDEX IF NOT EXISTS "+l+h+"_"+c+" ON "+h+"("+c+")"))))}b.available=r(a)}this.available=b.available},idProperty:"id",
selectColumns:["*"],get:function(a){return q(this.executeSql("SELECT "+this.selectColumns.join(",")+" FROM "+this.table+" WHERE "+this.idProperty+"\x3d?",[a]),function(b){return 0<b.rows.length?u(b.rows.item(0)):void 0})},getIdentity:function(a){return a[this.idProperty]},remove:function(a){return this.executeSql("DELETE FROM "+this.table+" WHERE "+this.idProperty+"\x3d?",[a])},identifyGeneratedKey:!0,add:function(a,b){b=[];var l=[],g=[],c={},k=[],h=this,e;for(e in a)a.hasOwnProperty(e)&&(e in this.indices||
e==this.idProperty?this.repeatingIndices[e]?k.push(function(n){return r(a[e].map(function(f){return h.executeSql("INSERT INTO "+h.table+"_repeating_"+e+" (value, id) VALUES (?, ?)",[f,n])}))}):(g.push(e),l.push("?"),b.push(a[e])):c[e]=a[e]);g.push("__extra");l.push("?");b.push(JSON.stringify(c));var d=this.idProperty;this.identifyGeneratedKey&&(b.idColumn=d);l="INSERT INTO "+this.table+" ("+g.join(",")+") VALUES ("+l.join(",")+")";return q(this.executeSql(l,b),function(n){var f=n.insertId;a[d]=f;
return r(k.map(function(m){return m(f)})).then(function(){return f})})},put:function(a,b){b=b||{};var l=b.id||a[this.idProperty],g=b.overwrite;if(void 0===g){var c=this;return this.get(l).then(function(m){return(b.overwrite=!!m)?(b.overwrite=!0,c.put(a,b)):c.add(a,b)})}if(!g)return c.add(a,b);g="UPDATE "+this.table+" SET ";var k=[],h=[],e={},d;for(d in a)if(a.hasOwnProperty(d))if(d in this.indices||d==this.idProperty)if(this.repeatingIndices[d]){this.executeSql("DELETE FROM "+this.table+"_repeating_"+
d+" WHERE id\x3d?",[l]);for(var n=a[d],f=0;f<n.length;f++)this.executeSql("INSERT INTO "+this.table+"_repeating_"+d+" (value, id) VALUES (?, ?)",[n[f],l])}else h.push(d+"\x3d?"),k.push(a[d]);else e[d]=a[d];h.push("__extra\x3d?");k.push(JSON.stringify(e));g+=h.join(",")+" WHERE "+this.idProperty+"\x3d?";k.push(a[this.idProperty]);return q(this.executeSql(g,k),function(m){return l})},query:function(a,b){function l(d){var n=[],f;for(f in d){var m=d[f],w=function(p){var v=p&&p.match&&p.match(C);if(v)return e.push(v[1]+
"%")," LIKE ?";e.push(p);return"\x3d?"};if(m)if(m.contains){var D=k.table+"_repeating_"+f;n.push(m.contains.map(function(p){return k.idProperty+" IN (SELECT id FROM "+D+" WHERE value"+w(p)+")"}).join(" AND "));continue}else if("object"==typeof m&&("from"in m||"to"in m)){var x=m.excludeFrom?"\x3e":"\x3e\x3d",y=m.excludeTo?"\x3c":"\x3c\x3d";"from"in m?(e.push(m.from),"to"in m?(e.push(m.to),n.push("("+h+"."+f+x+"? AND "+h+"."+f+y+"?)")):n.push(h+"."+f+x+"?")):(e.push(m.to),n.push(h+"."+f+y+"?"));continue}n.push(h+
"."+f+w(m))}return n.join(" AND ")}b=b||{};var g="FROM "+this.table,c,k=this,h=this.table,e=[];a.forEach?(c=a.map(l).join(") OR ("))&&(c="("+c+")"):c=l(a);c&&(c=" WHERE "+c);b.sort&&(c+=" ORDER BY "+b.sort.map(function(d){return h+"."+d.attribute+" "+(d.descending?"desc":"asc")}));a=c;b.count&&(a+=" LIMIT "+b.count);b.start&&(a+=" OFFSET "+b.start);b=t.delegate(this.executeSql("SELECT * "+g+a,e).then(function(d){for(var n=[],f=0;f<d.rows.length;f++)n.push(u(d.rows.item(f)));return n}));k=this;b.total=
{then:function(d,n){return k.executeSql("SELECT COUNT(*) "+g+c,e).then(function(f){return f.rows.item(0)["COUNT(*)"]}).then(d,n)}};return new B(b)},executeSql:function(a,b){var l=new A,g,c;this.database.transaction(function(k){k.executeSql(a,b,function(h,e){l.resolve(g=e)},function(h,e){l.reject(c=e)})});if(g)return g;if(c)throw c;return l.promise}})});