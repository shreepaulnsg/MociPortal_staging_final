/*
	Copyright (c) 2004-2016, The JS Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

//>>built
define("dojo/request/xhr",["../errors/RequestError","./watch","./handlers","./util","../has"],function(t,A,B,m,c){function C(a,b){var d=a.xhr;a.status=a.xhr.status;try{a.text=d.responseText}catch(e){}"xml"===a.options.handleAs&&(a.data=d.responseXML);if(b)this.reject(b);else{try{B(a)}catch(e){var k=e}m.checkStatus(d.status)?k?this.reject(k):this.resolve(a):(b=k?new t("Unable to load "+a.url+" status: "+d.status+" and an error in handleAs: transformation of response",a):new t("Unable to load "+a.url+
" status: "+d.status,a),this.reject(b))}}function D(a){return this.xhr.getResponseHeader(a)}function n(a,b,d){var k=c("native-formdata")&&b&&b.data&&b.data instanceof FormData,e=m.parseArgs(a,m.deepCreate(E,b),k);a=e.url;b=e.options;var u=!b.data&&"POST"!==b.method&&"PUT"!==b.method;10>=c("ie")&&(a=a.split("#")[0]);var q,g=m.deferred(e,v,w,F,C,function(){q&&q()}),f=e.xhr=n._create();if(!f)return g.cancel(new t("XHR was not created")),d?g:g.promise;e.getHeader=D;x&&(q=x(f,g,e,b.uploadProgress));var h=
"undefined"===typeof b.data?null:b.data,l=!b.sync,G=b.method;try{f.open(G,a,l,b.user||y,b.password||y);b.withCredentials&&(f.withCredentials=b.withCredentials);c("native-response-type")&&b.handleAs in z&&(f.responseType=z[b.handleAs]);var p=b.headers;a=k||u?!1:"application/x-www-form-urlencoded";if(p)for(var r in p)"content-type"===r.toLowerCase()?a=p[r]:p[r]&&f.setRequestHeader(r,p[r]);a&&!1!==a&&f.setRequestHeader("Content-Type",a);p&&"X-Requested-With"in p||f.setRequestHeader("X-Requested-With",
"XMLHttpRequest");m.notify&&m.notify.emit("send",e,g.promise.cancel);f.send(h)}catch(H){g.reject(H)}A(g);f=null;return d?g:g.promise}c.add("native-xhr",function(){return"undefined"!==typeof XMLHttpRequest});c.add("dojo-force-activex-xhr",function(){return c("activex")&&"file:"===window.location.protocol});c.add("native-xhr2",function(){if(c("native-xhr")&&!c("dojo-force-activex-xhr")){var a=new XMLHttpRequest;return"undefined"!==typeof a.addEventListener&&("undefined"===typeof opera||"undefined"!==
typeof a.upload)}});c.add("native-formdata",function(){return"undefined"!==typeof FormData});c.add("native-blob",function(){return"undefined"!==typeof Blob});c.add("native-arraybuffer",function(){return"undefined"!==typeof ArrayBuffer});c.add("native-response-type",function(){return c("native-xhr")&&"undefined"!==typeof(new XMLHttpRequest).responseType});c.add("native-xhr2-blob",function(){if(c("native-response-type")){var a=new XMLHttpRequest;a.open("GET","https://dojotoolkit.org/",!0);a.responseType=
"blob";var b=a.responseType;a.abort();return"blob"===b}});var z={blob:c("native-xhr2-blob")?"blob":"arraybuffer",document:"document",arraybuffer:"arraybuffer"};if(c("native-xhr2")){var w=function(a){return!this.isFulfilled()};var v=function(a,b){b.xhr.abort()};var x=function(a,b,d,k){function e(h){b.handleResponse(d)}function u(h){h=new t("Unable to load "+d.url+" status: "+h.target.status,d);b.handleResponse(d,h)}function q(h,l){d.transferType=h;l.lengthComputable?(d.loaded=l.loaded,d.total=l.total,
b.progress(d)):3===d.xhr.readyState&&(d.loaded="loaded"in l?l.loaded:l.position,b.progress(d))}function g(h){return q("download",h)}function f(h){return q("upload",h)}a.addEventListener("load",e,!1);a.addEventListener("error",u,!1);a.addEventListener("progress",g,!1);k&&a.upload&&a.upload.addEventListener("progress",f,!1);return function(){a.removeEventListener("load",e,!1);a.removeEventListener("error",u,!1);a.removeEventListener("progress",g,!1);a.upload.removeEventListener("progress",f,!1);a=null}}}else{w=
function(a){return a.xhr.readyState};var F=function(a){return 4===a.xhr.readyState};v=function(a,b){a=b.xhr;b=typeof a.abort;"function"!==b&&"object"!==b&&"unknown"!==b||a.abort()}}var y,E={data:null,query:null,sync:!1,method:"GET"};n._create=function(){throw Error("XMLHTTP not available");};if(c("native-xhr")&&!c("dojo-force-activex-xhr"))n._create=function(){return new XMLHttpRequest};else if(c("activex"))try{new ActiveXObject("Msxml2.XMLHTTP"),n._create=function(){return new ActiveXObject("Msxml2.XMLHTTP")}}catch(a){try{new ActiveXObject("Microsoft.XMLHTTP"),
n._create=function(){return new ActiveXObject("Microsoft.XMLHTTP")}}catch(b){}}m.addCommonMethods(n);return n});